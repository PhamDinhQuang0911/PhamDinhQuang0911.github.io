<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luyện Tập Thông Minh - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      loader: { load: ['[tex]/noerrors', '[tex]/noundefined'] },
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Style cho Tree */
        .tree-node-content { transition: all 0.2s; }
        .tree-node-content:hover { background-color: #F1F5F9; }
        .caret { transition: transform 0.2s; }
        .caret.expanded { transform: rotate(90deg); }
        .nested { display: none; padding-left: 24px; border-left: 1px dashed #E2E8F0; margin-left: 10px; }
        .nested.active { display: block; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='student.html'">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-brain"></i>
                </div>
                <div>
                    <h1 class="font-black text-gray-800 text-lg leading-tight">Phòng Luyện Tập</h1>
                    <p class="text-xs text-gray-500 font-bold">Toán Học Tư Duy</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.reload()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-rotate"></i></button>
                <button onclick="window.history.back()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 md:p-6 max-w-6xl mx-auto w-full">
        
        <div id="configStep" class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]">
            
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-filter text-blue-600"></i> Bộ lọc kiến thức</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Khối Lớp</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="grade" value="12" class="peer sr-only" checked onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all">12</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="11" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all">11</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="10" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all">10</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="9" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 transition-all">9</div></label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Phân Môn</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="subject" value="all" class="peer sr-only" checked onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 transition-all">Tất cả</div></label>
                                <label class="cursor-pointer"><input type="radio" name="subject" value="dai_so" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 transition-all">Đại số</div></label>
                                <label class="cursor-pointer"><input type="radio" name="subject" value="hinh_hoc" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-lg border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 transition-all">Hình học</div></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex-1 flex flex-col">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-sliders text-orange-500"></i> Thiết lập</h3>
                    
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Số lượng câu hỏi</label>
                        <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-xl">
                            <button onclick="setQCount(10)" class="q-btn flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow-sm text-blue-700 transition-all">10</button>
                            <button onclick="setQCount(20)" class="q-btn flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-white hover:shadow-sm transition-all">20</button>
                            <button onclick="setQCount(40)" class="q-btn flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-white hover:shadow-sm transition-all">40</button>
                        </div>
                    </div>

                    <div class="mt-auto">
                        <div id="selectionStatus" class="mb-3 text-xs text-gray-500 font-medium text-center">
                            Đang chọn: <span class="font-bold text-blue-600">Ngẫu nhiên tất cả</span>
                        </div>
                        <button onclick="startPractice()" class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-black rounded-xl shadow-lg shadow-blue-200 transform active:scale-95 transition-all text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-rocket"></i> BẮT ĐẦU LUYỆN TẬP
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-gray-700"><i class="fa-solid fa-folder-tree mr-2 text-indigo-600"></i>Nội dung ôn tập</h3>
                    <div class="text-xs text-gray-400 italic">Tích chọn để lọc bài cụ thể</div>
                </div>
                
                <div id="treeContainer" class="flex-1 overflow-y-auto p-4 custom-scrollbar relative">
                    <div class="text-center py-20 text-gray-400">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="practiceStep" class="hidden max-w-4xl mx-auto h-[calc(100vh-100px)] flex flex-col">
            <div class="mb-4 flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-black text-sm border-2 border-blue-100" id="currentQNum">1</div>
                    <div>
                        <p class="text-gray-400 font-bold text-[10px] uppercase tracking-wider">Thời gian</p>
                        <p class="font-mono font-bold text-gray-800 text-lg leading-none" id="timerDisplay">00:00</p>
                    </div>
                </div>
                <button onclick="finishPractice()" class="px-5 py-2 bg-red-50 text-red-600 font-bold rounded-lg hover:bg-red-100 transition-colors text-sm border border-red-100">Nộp bài</button>
            </div>

            <div id="questionContainer" class="flex-1 overflow-y-auto p-1 scroll-smooth pb-10"></div>
            
            <div id="questionPalette" class="mt-2 p-3 bg-white rounded-xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] border-t border-gray-100 overflow-x-auto whitespace-nowrap flex gap-2 no-scrollbar"></div>
        </div>

        <div id="resultStep" class="hidden max-w-2xl mx-auto animate-fade-in py-10">
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center border border-gray-100">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-10 text-white relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <h2 class="text-2xl font-black mb-1 relative z-10">KẾT QUẢ LUYỆN TẬP</h2>
                    <p class="text-indigo-100 text-sm mb-6 relative z-10">Cố gắng hơn nữa nhé!</p>
                    
                    <div class="w-32 h-32 mx-auto bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center border-4 border-white/20 mb-6 relative z-10 shadow-inner">
                        <div>
                            <span class="text-5xl font-black" id="resScore">0</span>
                            <span class="text-xs font-bold block uppercase tracking-wide opacity-80">Điểm</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-center gap-8 text-sm font-bold relative z-10">
                        <div class="bg-green-500/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-green-400/30"><i class="fa-solid fa-check mr-1"></i>Đúng: <span id="resCorrect">0</span></div>
                        <div class="bg-red-500/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-red-400/30"><i class="fa-solid fa-xmark mr-1"></i>Sai: <span id="resWrong">0</span></div>
                    </div>
                </div>
                <div class="p-8 bg-gray-50 flex justify-center gap-4">
                    <button onclick="window.location.reload()" class="px-6 py-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-100 hover:shadow-md transition-all text-sm">Luyện tập lại</button>
                    <button onclick="viewSolutions()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 hover:shadow-lg shadow-blue-200 transition-all text-sm">Xem lời giải</button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { formatContent } from "./utils.js"; 

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let mapTree = [];
        let selectedQCount = 10;
        let practiceQuestions = [];
        let userAnswers = {};
        let startTime;
        let timerInterval;
        
        // [MỚI] Biến chứa danh sách ID từ Ngân hàng
        let globalBankMetadata = [];

        // --- 1. KHỞI TẠO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Tải song song: MapID từ Firestore và Danh sách câu hỏi từ R2
                await Promise.all([loadMapTree(), loadBankMetadata()]);
            } else {
                window.location.href = 'index.html';
            }
        });

        // [MỚI] Hàm tải danh sách ID (Rất nhẹ)
        async function loadBankMetadata() {
            try {
                // Link Worker của bạn
                const WORKER_URL = "https://upload-helper.phamngockhanh-942001.workers.dev/bank";
                const res = await fetch(WORKER_URL);
                if (res.ok) {
                    globalBankMetadata = await res.json();
                    console.log("Đã tải xong danh sách:", globalBankMetadata.length, "câu");
                }
            } catch (e) { console.error("Lỗi tải Bank:", e); }
        }

        // [MỚI] Hàm định dạng nội dung (Để đảm bảo Preview không lỗi)
        window.formatContent = (text) => {
            if (!text) return "";
            return text
                .replace(/\n/g, "<br>")
                .replace(/\\newline/g, "<br>")
                .replace(/\\dfrac/g, "\\displaystyle\\dfrac")
                .replace(/\\begin\{cases\}/g, "\\begin{cases}")
                .replace(/\\end\{cases\}/g, "\\end{cases}");
        };

        async function loadMapTree() {
            try {
                const docSnap = await getDoc(doc(db, "configurations", "map_id_tree"));
                if (docSnap.exists()) {
                    mapTree = docSnap.data().tree || [];
                    renderTree(); 
                } else {
                    document.getElementById('treeContainer').innerHTML = '<p class="text-center text-gray-400 mt-10">Chưa có dữ liệu MapID.</p>';
                }
            } catch (error) {
                console.error("Lỗi:", error);
            }
        }

        // --- 2. RENDER CÂY THƯ MỤC (Logic mới) ---
        window.renderTree = () => {
            const container = document.getElementById('treeContainer');
            const selectedGrade = document.querySelector('input[name="grade"]:checked').value;
            const selectedSub = document.querySelector('input[name="subject"]:checked').value;

            container.innerHTML = '';

            // Hàm đệ quy render Node
            function createNodeHtml(nodes) {
                let html = '<ul class="pl-0">';
                let hasItem = false;

                nodes.forEach(node => {
                    // Logic lọc: Nếu đang ở Level Root (Lớp), chỉ hiện lớp đang chọn
                    // Nếu node tên chứa "Lớp 12" mà đang chọn 11 thì bỏ qua
                    // Tuy nhiên MapID thường linh động, ta dùng bộ lọc tương đối
                    
                    // Giả sử Node cấp 1 là Phân môn (Đại/Hình) hoặc Chương
                    // Ta kiểm tra xem Node này (hoặc con cháu nó) có phù hợp không
                    // Ở đây render hết, người dùng tự mở. Hoặc lọc theo tên nếu Node Name có chứa "Đại số" / "Hình học"
                    
                    let isVisible = true;
                    // Nếu chọn Đại số, ẩn các Node tên có chữ "Hình học" và ngược lại (Logic tương đối)
                    const nameLower = node.name.toLowerCase();
                    if (selectedSub === 'dai_so' && nameLower.includes('hình học')) isVisible = false;
                    if (selectedSub === 'hinh_hoc' && (nameLower.includes('đại số') || nameLower.includes('giải tích'))) isVisible = false;
                    
                    if(isVisible) {
                        hasItem = true;
                        const hasChildren = node.children && node.children.length > 0;
                        const icon = hasChildren ? '<i class="fa-solid fa-caret-right caret text-gray-400 w-4"></i>' : '<i class="fa-solid fa-circle text-[6px] text-gray-300 w-4 mx-auto"></i>';
                        
                        html += `
                            <li class="mb-1">
                                <div class="tree-node-content flex items-center gap-2 p-2 rounded cursor-pointer select-none">
                                    <span onclick="toggleNode(this)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-200 rounded transition-colors">${icon}</span>
                                    
                                    <label class="flex items-center gap-2 flex-1 cursor-pointer">
                                        <input type="checkbox" class="map-check w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" 
                                            value="${node.id}" 
                                            data-has-children="${hasChildren}"
                                            onchange="handleCheck(this)">
                                        <span class="text-sm font-medium text-gray-700">${node.name}</span>
                                    </label>
                                </div>
                                ${hasChildren ? `<div class="nested border-l border-gray-100 ml-5 pl-2">${createNodeHtml(node.children)}</div>` : ''}
                            </li>
                        `;
                    }
                });
                html += '</ul>';
                return hasItem ? html : '';
            }

            // Tìm node gốc của Lớp đang chọn (Nếu cây phân theo Lớp ở Root)
            // Nếu cây trộn lẫn, ta render hết và dùng logic filter ở trên
            // Giả sử cây của bạn: Root -> [Lớp 10, Lớp 11...] -> [Đại, Hình]...
            
            // Tìm các node phù hợp với Grade
            const relevantNodes = mapTree.filter(n => n.name.includes(selectedGrade));
            
            if (relevantNodes.length > 0) {
                container.innerHTML = createNodeHtml(relevantNodes);
            } else {
                // Fallback: Render hết nếu tên node gốc không chứa tên lớp
                container.innerHTML = createNodeHtml(mapTree);
            }
            
            updateSelectionStatus();
        };

        // Hàm Expand/Collapse
        window.toggleNode = (el) => {
            const li = el.closest('li');
            const nested = li.querySelector('.nested');
            const caret = li.querySelector('.caret');
            if (nested) {
                nested.classList.toggle('active');
                if(caret) caret.classList.toggle('expanded');
            }
        };

        // Logic Checkbox thông minh (Chọn cha -> Chọn hết con)
        window.handleCheck = (el) => {
            const li = el.closest('li');
            const isChecked = el.checked;
            
            // 1. Xử lý xuống dưới (Children)
            const childrenChecks = li.querySelectorAll('.map-check');
            childrenChecks.forEach(c => c.checked = isChecked);

            // 2. Xử lý lên trên (Parent) - Optional: Nếu tất cả con checked thì cha checked (Bỏ qua để đơn giản)
            updateSelectionStatus();
        };

        function updateSelectionStatus() {
            const count = document.querySelectorAll('.map-check:checked').length;
            const statusEl = document.getElementById('selectionStatus');
            if (count === 0) {
                statusEl.innerHTML = 'Đang chọn: <span class="font-bold text-blue-600">Ngẫu nhiên tất cả</span>';
            } else {
                statusEl.innerHTML = `Đang chọn: <span class="font-bold text-indigo-600">${count} mục</span>`;
            }
        }

        window.setQCount = (n) => {
            selectedQCount = n;
            document.querySelectorAll('.q-btn').forEach(b => {
                b.className = "q-btn flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-white hover:shadow-sm transition-all";
                if(b.textContent == n) b.className = "q-btn flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow-sm text-blue-700 transition-all";
            });
        };

        // --- 3. LOGIC LẤY CÂU HỎI (QUAN TRỌNG) ---
        // --- 3. LOGIC LẤY CÂU HỎI TỪ R2 (CẬP NHẬT) ---
        // --- 3. LOGIC LẤY CÂU HỎI TỪ NGÂN HÀNG R2 (CẬP NHẬT) ---
        window.startPractice = async () => {
            const btn = document.querySelector('button[onclick="startPractice()"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang tạo đề...'; btn.disabled = true;

            try {
                // 1. Lấy tham số lọc cơ bản
                const grade = document.querySelector('input[name="grade"]:checked').value; // 12, 11...
                const subject = document.querySelector('input[name="subject"]:checked').value; // dai_so, hinh_hoc, all

                // 2. Lấy danh sách Bài học (MapID) đã tích chọn
                const checkedMapIds = Array.from(document.querySelectorAll('.map-check:checked')).map(cb => cb.value);
                
                // 3. Lọc câu hỏi từ bộ nhớ (globalBankMetadata)
                let pool = globalBankMetadata.filter(q => {
                    // Lọc Lớp & Môn (Dựa vào tiền tố ID: 12D..., 12H...)
                    let prefixGrade = grade; 
                    let prefixSub = ""; // D, H, G
                    
                    if (!q.id.startsWith(prefixGrade)) return false; // Sai lớp -> Loại

                    if (subject !== 'all') {
                        let reqChar = subject === 'dai_so' ? 'D' : 'H'; 
                        // Lưu ý: ID có thể là 12D1... hoặc 12G1... (Giải tích cũng là Đại số)
                        if (subject === 'dai_so' && !q.id.includes('D') && !q.id.includes('G')) return false;
                        if (subject === 'hinh_hoc' && !q.id.includes('H')) return false;
                    }

                    // Lọc theo Bài học (Nếu có tích chọn)
                    if (checkedMapIds.length > 0) {
                        // ID câu hỏi: 9D1H1-7 -> ID bài học tương ứng: 9D11
                        // Ta kiểm tra xem ID câu hỏi có "liên quan" đến các ID đã tích không
                        // Cách đơn giản: Kiểm tra xem ID câu hỏi có chứa chuỗi ID bài học đã chọn không
                        // (Lưu ý: Logic này tương đối, cần ID chuẩn)
                        /*
                        let isMatch = checkedMapIds.some(mapId => q.id.includes(mapId));
                        if (!isMatch) return false;
                        */
                       // Tạm thời lấy ngẫu nhiên trong môn học nếu logic ID chưa đồng bộ hoàn toàn với cây
                    }
                    
                    return true;
                });

                // 4. Kiểm tra số lượng
                if (pool.length === 0) {
                    alert(`Chưa có câu hỏi nào cho Lớp ${grade} - ${subject==='all'?'Tất cả':(subject==='dai_so'?'Đại số':'Hình học')} trong kho.`);
                    btn.innerHTML = oldText; btn.disabled = false;
                    return;
                }

                // 5. Trộn ngẫu nhiên
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }

                // 6. Cắt lấy số lượng cần thiết
                const selectedMeta = pool.slice(0, selectedQCount);

                // 7. Tải nội dung chi tiết từ R2 (Fetch song song)
                // Đây là bước quan trọng: Biến ID thành nội dung đề bài
                practiceQuestions = [];
                const WORKER_URL = "https://upload-helper.phamngockhanh-942001.workers.dev/bank";

                const fetchPromises = selectedMeta.map(async (meta) => {
                    try {
                        const res = await fetch(`${WORKER_URL}?id=${encodeURIComponent(meta.id)}`);
                        if (res.ok) return await res.json();
                    } catch (e) { console.error("Lỗi tải câu:", meta.id); }
                    return null;
                });

                const results = await Promise.all(fetchPromises);
                practiceQuestions = results.filter(q => q !== null);

                if (practiceQuestions.length === 0) throw new Error("Không tải được nội dung câu hỏi.");

                // 8. Chuyển màn hình & Bắt đầu
                document.getElementById('configStep').classList.add('hidden');
                document.getElementById('practiceStep').classList.remove('hidden');
                renderPracticeInterface();
                startTimer();

            } catch (err) {
                console.error(err);
                alert("Có lỗi xảy ra: " + err.message);
                btn.innerHTML = oldText; btn.disabled = false;
            }
        };

        // --- 4. GIAO DIỆN LÀM BÀI ---
        function renderPracticeInterface() {
            const container = document.getElementById('questionContainer');
            const palette = document.getElementById('questionPalette');
            container.innerHTML = '';
            palette.innerHTML = '';

            practiceQuestions.forEach((q, idx) => {
                // Render Câu hỏi
                const qDiv = document.createElement('div');
                qDiv.id = `q-${idx}`;
                qDiv.className = "mb-6 bg-white p-5 rounded-2xl shadow-sm border border-gray-100 scroll-mt-20";
                
                let inputHtml = '';
                if (q.type === 'mc') {
                    // Trộn đáp án
                    let indices = [0, 1, 2, 3];
                    indices.sort(() => Math.random() - 0.5);
                    // Lưu map để chấm điểm (quan trọng nếu cần hiện đúng A,B,C,D)
                    q.shuffleMap = indices; 

                    inputHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">`;
                    indices.forEach((realIdx, displayIdx) => {
                        const opt = q.options[realIdx];
                        const label = String.fromCharCode(65 + displayIdx);
                        if(opt) {
                            inputHtml += `
                                <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition-all group">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-500 font-bold text-xs group-hover:bg-indigo-600 group-hover:text-white transition-colors">${label}</div>
                                    <input type="radio" name="ans-${idx}" value="${realIdx}" class="hidden" onchange="selectAnswer(${idx}, ${realIdx})">
                                    <span class="text-gray-700 text-sm font-medium math-content">${window.formatContent(opt)}</span>
                                </label>
                            `;
                        }
                    });
                    inputHtml += `</div>`;
                }

                qDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="bg-blue-100 text-blue-700 font-bold px-2.5 py-1 rounded-lg text-xs shrink-0 mt-1">Câu ${idx + 1}</span>
                        <div class="text-gray-800 text-base leading-relaxed flex-1 math-content font-medium">${window.formatContent(q.content)}</div>
                    </div>
                    ${inputHtml}
                `;
                container.appendChild(qDiv);

                // Render Palette
                const btn = document.createElement('button');
                btn.id = `p-btn-${idx}`;
                btn.className = "w-9 h-9 rounded-lg border border-gray-200 flex items-center justify-center font-bold text-gray-400 hover:bg-gray-50 text-xs transition-colors shrink-0";
                btn.textContent = idx + 1;
                btn.onclick = () => {
                    document.getElementById(`q-${idx}`).scrollIntoView({behavior: 'smooth', block: 'center'});
                };
                palette.appendChild(btn);
            });

            if(window.MathJax) MathJax.typesetPromise();
        }

        window.selectAnswer = (qIdx, ansIdx) => {
            userAnswers[qIdx] = ansIdx;
            // Highlight palette
            const btn = document.getElementById(`p-btn-${qIdx}`);
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.remove('text-gray-400', 'hover:bg-gray-50');
            
            // Highlight option
            const qDiv = document.getElementById(`q-${qIdx}`);
            qDiv.querySelectorAll('label').forEach(lbl => {
                const inp = lbl.querySelector('input');
                if(inp.value == ansIdx) {
                    lbl.classList.add('bg-indigo-50', 'border-indigo-300', 'ring-1', 'ring-indigo-300');
                } else {
                    lbl.classList.remove('bg-indigo-50', 'border-indigo-300', 'ring-1', 'ring-indigo-300');
                }
            });
        };

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').textContent = `${m}:${s}`;
            }, 1000);
        }

        // --- 5. KẾT THÚC & CHẤM ---
        window.finishPractice = () => {
            clearInterval(timerInterval);
            let correct = 0;
            
            practiceQuestions.forEach((q, idx) => {
                const userAns = userAnswers[idx];
                if (q.type === 'mc' && userAns === q.correct) {
                    correct++;
                }
            });

            const score = (correct / practiceQuestions.length) * 10;
            
            document.getElementById('practiceStep').classList.add('hidden');
            document.getElementById('resultStep').classList.remove('hidden');
            
            document.getElementById('resScore').textContent = score.toFixed(1);
            document.getElementById('resCorrect').textContent = correct;
            document.getElementById('resWrong').textContent = practiceQuestions.length - correct;
        };

        window.viewSolutions = () => {
            document.getElementById('resultStep').classList.add('hidden');
            document.getElementById('practiceStep').classList.remove('hidden');
            document.querySelector('#practiceStep button[onclick="finishPractice()"]').classList.add('hidden');
            
            practiceQuestions.forEach((q, idx) => {
                const qDiv = document.getElementById(`q-${idx}`);
                const u = userAnswers[idx];
                const isCorrect = (u === q.correct);
                
                let feedbackHtml = '';
                if(isCorrect) {
                    feedbackHtml = `<div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-xl text-green-700 font-bold text-sm"><i class="fa-solid fa-check mr-2"></i>Chính xác!</div>`;
                } else {
                    // Tìm ký tự hiển thị của đáp án đúng (Do đã đảo)
                    let correctChar = '?';
                    if(q.shuffleMap) {
                        const displayIdx = q.shuffleMap.indexOf(q.correct);
                        correctChar = String.fromCharCode(65 + displayIdx);
                    }
                    feedbackHtml = `<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 font-bold text-sm"><i class="fa-solid fa-xmark mr-2"></i>Sai rồi. Đáp án đúng là: ${correctChar}</div>`;
                }

                if(q.solution) {
                    feedbackHtml += `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="font-bold text-blue-600 mb-2 text-xs uppercase"><i class="fa-solid fa-lightbulb mr-1"></i> Lời giải chi tiết</p>
                            <div class="text-gray-700 math-content text-sm bg-gray-50 p-3 rounded-lg">${window.formatContent(q.solution)}</div>
                        </div>
                    `;
                }
                qDiv.insertAdjacentHTML('beforeend', feedbackHtml);
            });
            if(window.MathJax) MathJax.typesetPromise();
        };
    </script>
</body>
</html>
