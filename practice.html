<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luyện Tập Thông Minh - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      loader: { load: ['[tex]/noerrors', '[tex]/noundefined'] },
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors', 'noundefined']},
        macros: {
          heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
          hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ",
          R: "\\mathbb{R}",
          N: "\\mathbb{N}",
          Z: "\\mathbb{Z}",
          vectors: ["\\overrightarrow{#1}", 1],
          mtx: ["\\left[\\begin{matrix}#1\\end{matrix}\\right]", 1]
        }
      },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .mode-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15); border-color: #3B82F6; }
        
        /* Style Checkbox Mức độ (Chips) */
        .level-checkbox:checked + div { background-color: #EFF6FF; border-color: #3B82F6; color: #1D4ED8; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); }
        .level-checkbox:checked + div .check-icon { opacity: 1; transform: scale(1); }
        
        /* --- STYLE MỚI: CÂY THƯ MỤC CHUYÊN NGHIỆP --- */
        /* 1. Accordion Card */
        .topic-card { border: 1px solid #E2E8F0; transition: all 0.3s ease; background: white; }
        .topic-card:hover { border-color: #CBD5E1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .topic-card.active { border-color: #6366F1; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.1); }
        
        .topic-header { cursor: pointer; transition: background 0.2s; user-select: none; }
        .topic-header:hover { background-color: #F8FAFC; }
        .topic-header .arrow-icon { transition: transform 0.3s; }
        .topic-card.active .arrow-icon { transform: rotate(180deg); color: #6366F1; }
        
        /* 2. Nội dung bên trong (Slide animation) */
        .topic-body { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
            opacity: 0.5;
        }
        .topic-card.active .topic-body { 
            max-height: 2000px; /* Đủ lớn để hiện hết */
            opacity: 1;
            padding-bottom: 16px;
        }

        /* 3. Nested Tree (Cây phân cấp) */
        /* Sử dụng thẻ <details> và <summary> cho native accordion lồng nhau */
        details > summary { list-style: none; cursor: pointer; transition: color 0.2s; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        details > summary .folder-icon { transition: transform 0.2s; color: #F59E0B; }
        details[open] > summary .folder-icon { transform: rotate(90deg); }
        
        .tree-branch {
            position: relative;
            margin-left: 24px; /* Thụt lề */
            padding-left: 12px;
            border-left: 1px dashed #CBD5E1; /* Đường kẻ dọc đứt đoạn */
        }
        
        .tree-item {
            position: relative;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .tree-item:hover { background-color: #EFF6FF; }
        .tree-item:hover .map-text { color: #2563EB; font-weight: 600; }

        /* --- CSS CHO MODAL HƯỚNG DẪN (BẮT BUỘC PHẢI CÓ) --- */
        
        /* 1. Lớp nền đen mờ che phủ toàn màn hình */
        .tutorial-overlay {
            background-color: rgba(0, 0, 0, 0.7) !important; /* Màu đen mờ */
            backdrop-filter: blur(4px); /* Làm mờ nội dung phía sau */
            z-index: 9999 !important; /* Luôn nằm trên cùng */
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
        }

        /* 2. Hộp thoại nội dung chính */
        #tutorialModal > div {
            background-color: #ffffff !important;
            opacity: 1 !important;
            position: relative;
            z-index: 10000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* 3. Logic ẨN/HIỆN từng bước (QUAN TRỌNG NHẤT) */
        .step-content {
            display: none !important; /* Mặc định ẩn tất cả */
        }
        
        .step-content.active {
            display: block !important; /* Chỉ hiện bước đang kích hoạt */
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <div id="tutorialModal" class="hidden fixed inset-0 tutorial-overlay flex items-center justify-center p-4 z-[9999]">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden relative transform transition-all scale-100 opacity-100">
            <button onclick="closeTutorial()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 z-50 p-2 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>

            <div id="step1" class="step-content active p-8 text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 text-3xl animate-bounce">
                    <i class="fa-solid fa-graduation-cap"></i>
                </div>
                <h3 class="text-2xl font-black text-gray-800 mb-2">Chào mừng bạn!</h3>
                <p class="text-gray-500 mb-8 leading-relaxed">Hệ thống luyện tập thông minh giúp bạn ôn thi hiệu quả. Hãy để tôi hướng dẫn bạn cách sử dụng nhé.</p>
                <button onclick="nextStep(2)" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">Tiếp tục <i class="fa-solid fa-arrow-right ml-2"></i></button>
            </div>

            <div id="step2" class="step-content p-8 text-center hidden"> <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6 text-purple-600 text-3xl">
                    <i class="fa-solid fa-sliders"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Thiết lập bài luyện</h3>
                <p class="text-gray-500 mb-6 text-sm">Ở cột bên trái, bạn hãy chọn <b>Lớp</b>, <b>Môn</b> và <b>Mức độ câu hỏi</b> mong muốn. Bạn cũng có thể tùy chỉnh số lượng câu hỏi và thời gian.</p>
                <button onclick="nextStep(3)" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition-all shadow-lg shadow-purple-200">Hiểu rồi</button>
            </div>

            <div id="step3" class="step-content p-8 text-center hidden"> <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 text-3xl">
                    <i class="fa-solid fa-folder-tree"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Chọn nội dung chi tiết</h3>
                <p class="text-gray-500 mb-6 text-sm">Ở cột bên phải, hãy bấm vào các <b>Chuyên đề</b> để mở rộng, sau đó tích chọn vào các <b>Bài học</b> bạn muốn ôn tập.</p>
                
                <div class="flex items-center justify-center gap-2 mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <input type="checkbox" id="dontShowAgain" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 cursor-pointer">
                    <label for="dontShowAgain" class="text-sm text-gray-600 cursor-pointer select-none font-medium">Không hiển thị lại hướng dẫn này</label>
                </div>
                
                <button onclick="closeTutorial()" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-all shadow-lg shadow-green-200">Bắt đầu ngay <i class="fa-solid fa-rocket ml-2"></i></button>
            </div>
        </div>
    </div>
            <div id="step1" class="step-content active p-8 text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 text-3xl animate-bounce">
                    <i class="fa-solid fa-graduation-cap"></i>
                </div>
                <h3 class="text-2xl font-black text-gray-800 mb-2">Chào mừng bạn!</h3>
                <p class="text-gray-500 mb-8 leading-relaxed">Hệ thống luyện tập thông minh giúp bạn ôn thi hiệu quả. Hãy để tôi hướng dẫn bạn cách sử dụng nhé.</p>
                <button onclick="nextStep(2)" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-all">Tiếp tục <i class="fa-solid fa-arrow-right ml-2"></i></button>
            </div>

            <div id="step2" class="step-content p-8 text-center">
                <img src="https://ui-avatars.com/api/?name=Cau+Hinh&background=random&size=128" class="w-24 h-24 mx-auto mb-6 rounded-xl shadow-md object-cover hidden"> <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6 text-purple-600 text-3xl">
                    <i class="fa-solid fa-sliders"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Thiết lập bài luyện</h3>
                <p class="text-gray-500 mb-6 text-sm">Ở cột bên trái, bạn hãy chọn <b>Lớp</b>, <b>Môn</b> và <b>Mức độ câu hỏi</b> mong muốn. Bạn cũng có thể tùy chỉnh số lượng câu hỏi và thời gian.</p>
                <button onclick="nextStep(3)" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition-all">Hiểu rồi</button>
            </div>

            <div id="step3" class="step-content p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 text-3xl">
                    <i class="fa-solid fa-folder-tree"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Chọn nội dung chi tiết</h3>
                <p class="text-gray-500 mb-6 text-sm">Ở cột bên phải, hãy bấm vào các <b>Chuyên đề</b> để mở rộng, sau đó tích chọn vào các <b>Bài học</b> bạn muốn ôn tập.</p>
                
                <div class="flex items-center justify-center gap-2 mb-6">
                    <input type="checkbox" id="dontShowAgain" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 cursor-pointer">
                    <label for="dontShowAgain" class="text-sm text-gray-600 cursor-pointer select-none">Không hiển thị lại hướng dẫn này</label>
                </div>
                
                <button onclick="closeTutorial()" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-all">Bắt đầu ngay <i class="fa-solid fa-rocket ml-2"></i></button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='student.html'">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-brain"></i>
                </div>
                <div>
                    <h1 class="font-black text-gray-800 text-lg leading-tight">Phòng Luyện Tập</h1>
                    <p class="text-xs text-gray-500 font-bold">Toán Học Tư Duy</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openTutorial()" class="w-9 h-9 rounded-full bg-yellow-50 hover:bg-yellow-100 flex items-center justify-center text-yellow-600 border border-yellow-200" title="Xem hướng dẫn"><i class="fa-solid fa-question"></i></button>
                <button onclick="window.location.reload()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-rotate"></i></button>
                <button onclick="window.history.back()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full relative">
        
        <div id="landingStep" class="flex flex-col items-center justify-center min-h-[80vh] animate-fade-in">
            <div class="text-center mb-10">
                <h2 class="text-3xl md:text-5xl font-black text-gray-800 mb-4">Bạn muốn luyện tập gì hôm nay?</h2>
                <p class="text-gray-500 text-lg">Chọn một chế độ để bắt đầu hành trình chinh phục điểm 10.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl px-4">
                <div onclick="selectMode('topic')" class="mode-card bg-white p-8 rounded-3xl border-2 border-gray-100 cursor-pointer transition-all duration-300 relative group overflow-hidden">
                    <div class="absolute top-0 right-0 bg-blue-100 w-32 h-32 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fa-solid fa-layer-group"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ôn tập theo Chuyên đề</h3>
                        <p class="text-gray-500 text-sm">Chọn cụ thể Chương, Bài học hoặc Dạng toán.</p>
                    </div>
                </div>
                <div onclick="selectMode('random')" class="mode-card bg-white p-8 rounded-3xl border-2 border-gray-100 cursor-pointer transition-all duration-300 relative group overflow-hidden">
                    <div class="absolute top-0 right-0 bg-purple-100 w-32 h-32 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-purple-50 text-purple-600 rounded-2xl flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:bg-purple-600 group-hover:text-white transition-colors"><i class="fa-solid fa-shuffle"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Luyện ngẫu nhiên</h3>
                        <p class="text-gray-500 text-sm">Hệ thống tự động trích xuất câu hỏi ngẫu nhiên.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="configStep" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)] animate-slideIn">
            <div class="lg:col-span-4 flex flex-col gap-4 h-full overflow-y-auto custom-scrollbar pr-1">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-2 mb-4 cursor-pointer text-gray-400 hover:text-blue-600 transition-colors w-fit" onclick="backToLanding()">
                        <i class="fa-solid fa-arrow-left"></i> <span class="text-xs font-bold uppercase">Quay lại</span>
                    </div>

                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-sliders text-blue-600"></i> Thiết lập chung</h3>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Khối Lớp</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="grade" value="12" class="peer sr-only" checked onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">12</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="11" class="peer sr-only" onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">11</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="10" class="peer sr-only" onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">10</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="9" class="peer sr-only" onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">9</div></label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Phân Môn</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="subject" value="all" class="peer sr-only" checked onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50 transition-all">Tất cả</div></label>
                                <label class="cursor-pointer"><input type="radio" name="subject" value="dai_so" class="peer sr-only" onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50 transition-all">Đại số</div></label>
                                <label class="cursor-pointer"><input type="radio" name="subject" value="hinh_hoc" class="peer sr-only" onchange="renderTopicList()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50 transition-all">Hình học</div></label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Mức độ (Chọn nhiều)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer relative"><input type="checkbox" class="level-checkbox peer sr-only" value="NB"><div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center"><span>Nhận biết</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i></div></label>
                                <label class="cursor-pointer relative"><input type="checkbox" class="level-checkbox peer sr-only" value="TH" checked><div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center"><span>Thông hiểu</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i></div></label>
                                <label class="cursor-pointer relative"><input type="checkbox" class="level-checkbox peer sr-only" value="VD" checked><div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center"><span>Vận dụng</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i></div></label>
                                <label class="cursor-pointer relative"><input type="checkbox" class="level-checkbox peer sr-only" value="VDC"><div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center"><span>Vận dụng cao</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i></div></label>
                            </div>
                        </div>

                        <div class="w-full h-[1px] bg-gray-100"></div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Số lượng</label>
                                <input type="number" id="inputQCount" value="10" min="1" max="100" class="w-full px-3 py-2 border border-gray-200 rounded-xl font-bold text-center text-gray-700 outline-none focus:ring-2 focus:ring-blue-100">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Thời gian (p)</label>
                                <input type="number" id="inputTime" value="0" min="0" placeholder="Auto" class="w-full px-3 py-2 border border-gray-200 rounded-xl font-bold text-center text-gray-700 outline-none focus:ring-2 focus:ring-blue-100">
                            </div>
                        </div>
                         
                         <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-100">
                            <span class="text-xs font-bold text-gray-600">Sắp xếp dễ -> khó</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleSortDifficulty" class="sr-only peer" checked>
                                <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button onclick="startPractice()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-black rounded-2xl shadow-xl shadow-blue-200 transform active:scale-95 transition-all text-base flex items-center justify-center gap-2 mt-auto">
                    <i class="fa-solid fa-rocket"></i> BẮT ĐẦU LUYỆN TẬP
                </button>
            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-md border-2 border-indigo-50 flex flex-col overflow-hidden h-full relative">
                <div class="p-5 border-b border-gray-100 bg-indigo-50/50 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="font-black text-xl text-indigo-900 flex items-center gap-2">
                            <i class="fa-solid fa-folder-tree text-indigo-600"></i> CHỌN CHUYÊN ĐỀ
                        </h3>
                        <p class="text-xs text-indigo-500 font-bold mt-1 ml-7">Bấm vào tên Chương để xem các bài học</p>
                    </div>
                    <div id="selectionStatus" class="text-xs font-bold bg-white px-4 py-2 rounded-full border border-indigo-100 text-gray-500 shadow-sm">
                        <i class="fa-solid fa-shuffle mr-1"></i> Ngẫu nhiên tất cả
                    </div>
                </div>
                
                <div id="treeContainer" class="flex-1 overflow-y-auto p-4 custom-scrollbar relative space-y-3">
                    <div class="text-center py-20 text-gray-400">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3 text-indigo-300"></i>
                        <p class="text-sm font-bold text-gray-500">Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="practiceStep" class="hidden max-w-5xl mx-auto h-[calc(100vh-100px)] flex flex-col">
            <div class="mb-4 flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100 shrink-0">
                <div class="flex items-center gap-4">
                    <div onclick="window.history.back()" class="w-10 h-10 rounded-xl bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-500 cursor-pointer transition-colors"><i class="fa-solid fa-arrow-left"></i></div>
                    <div>
                        <p class="text-gray-400 font-bold text-[10px] uppercase tracking-wider">Thời gian còn lại</p>
                        <p class="font-mono font-black text-gray-800 text-xl leading-none tracking-tight text-blue-600" id="timerDisplay">00:00</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:block text-right mr-2">
                        <p class="text-xs font-bold text-gray-500" id="progressText">0/0</p>
                        <div class="w-32 h-1.5 bg-gray-100 rounded-full mt-1 overflow-hidden"><div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div></div>
                    </div>
                    <button onclick="finishPractice()" class="px-6 py-2.5 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-200 transition-all text-sm">Nộp bài</button>
                </div>
            </div>
            
            <div id="questionContainer" class="flex-1 overflow-y-auto p-1 scroll-smooth pb-20 pr-2 custom-scrollbar"></div>
            
            <div class="mt-2 bg-white rounded-t-2xl shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] border border-gray-100 z-10 flex flex-col shrink-0 transition-all duration-300">
                <div class="flex justify-between items-center p-3 px-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 select-none" onclick="window.togglePalette()">
                    <p class="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2"><i class="fa-solid fa-list-ol"></i> Danh sách câu hỏi</p>
                    <button class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-blue-100 hover:text-blue-600 transition-colors"><i id="paletteIcon" class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i></button>
                </div>
                <div id="questionPalette" class="grid grid-cols-5 md:grid-cols-10 lg:grid-cols-20 gap-2 max-h-40 overflow-y-auto custom-scrollbar p-4 bg-white"></div>
            </div>
        </div>

        <div id="resultStep" class="hidden max-w-2xl mx-auto animate-fade-in py-10">
             <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center border border-gray-100">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-10 text-white relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <h2 class="text-2xl font-black mb-1 relative z-10">KẾT QUẢ LUYỆN TẬP</h2>
                    <p class="text-indigo-100 text-sm mb-6 relative z-10">Cố gắng hơn nữa nhé!</p>
                    <div class="w-32 h-32 mx-auto bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center border-4 border-white/20 mb-6 relative z-10 shadow-inner">
                        <div>
                            <span class="text-5xl font-black" id="resScore">0</span>
                            <span class="text-xs font-bold block uppercase tracking-wide opacity-80">Điểm</span>
                        </div>
                    </div>
                    <div class="flex justify-center gap-8 text-sm font-bold relative z-10">
                        <div class="bg-green-500/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-green-400/30"><i class="fa-solid fa-check mr-1"></i>Đúng: <span id="resCorrect">0</span></div>
                        <div class="bg-red-500/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-red-400/30"><i class="fa-solid fa-xmark mr-1"></i>Sai: <span id="resWrong">0</span></div>
                    </div>
                </div>
                <div class="p-8 bg-gray-50 flex justify-center gap-4">
                    <button onclick="window.location.reload()" class="px-6 py-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-100 hover:shadow-md transition-all text-sm">Luyện tập lại</button>
                    <button onclick="viewSolutions()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 hover:shadow-lg shadow-blue-200 transition-all text-sm">Xem lời giải</button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { formatContent, renderTikz, autoScaleTables } from "./utils.js"; 

        // Gán vào window
        window.formatContent = formatContent;
        window.renderTikz = renderTikz;
        window.autoScaleTables = autoScaleTables;

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let mapTree = [];
        let globalBankMetadata = [];
        let practiceQuestions = [];
        let userAnswers = {};
        let startTime;
        let timerInterval;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                checkTutorial(); // Kiểm tra hiển thị hướng dẫn
                await Promise.all([loadMapTree(), loadBankMetadata()]);
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- TUTORIAL LOGIC ---
        window.checkTutorial = () => {
            if (!localStorage.getItem('seenPracticeTutorial')) {
                document.getElementById('tutorialModal').classList.remove('hidden');
            }
        };
        window.openTutorial = () => {
            document.getElementById('tutorialModal').classList.remove('hidden');
            showStep(1);
        };
        window.nextStep = (step) => showStep(step);
        
        function showStep(step) {
            // Ẩn tất cả các bước
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('active');
            });
            
            // Hiện bước được chọn
            const target = document.getElementById(`step${step}`);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('active', 'animate-fade-in'); // Thêm animation nếu có class này trong CSS
            }
        }
        window.closeTutorial = () => {
            const dontShow = document.getElementById('dontShowAgain').checked;
            if (dontShow) localStorage.setItem('seenPracticeTutorial', 'true');
            document.getElementById('tutorialModal').classList.add('hidden');
        };

        async function loadMapTree() {
            try {
                const docSnap = await getDoc(doc(db, "configurations", "map_id_tree"));
                if (docSnap.exists()) {
                    mapTree = docSnap.data().tree || [];
                    renderTopicList(); // Render ngay khi có data
                }
            } catch (error) { console.error("Lỗi tải MapID:", error); }
        }

        async function loadBankMetadata() {
            try {
                const WORKER_URL = "https://upload-helper.phamngockhanh-942001.workers.dev/bank";
                const res = await fetch(WORKER_URL);
                if (res.ok) globalBankMetadata = await res.json();
            } catch (e) { console.error("Lỗi tải Bank:", e); }
        }

        // --- 3. RENDER DANH SÁCH BÀI (GIAO DIỆN CÂY PRO) ---
        window.renderTopicList = () => {
            const container = document.getElementById('treeContainer');
            if (!container) return;

            const selectedGrade = document.querySelector('input[name="grade"]:checked').value;
            const selectedSub = document.querySelector('input[name="subject"]:checked').value;

            container.innerHTML = '';
            
            if (!mapTree || mapTree.length === 0) {
                container.innerHTML = '<div class="text-center py-10"><p class="text-gray-400 font-bold">Đang tải dữ liệu...</p></div>';
                return;
            }

            // 1. Tìm Node Lớp (Lọc theo tên, VD: "Lớp 12")
            const gradeNodes = mapTree.filter(node => node.name.includes(selectedGrade));
            
            if (gradeNodes.length === 0) {
                container.innerHTML = `<div class="text-center py-10"><p class="text-gray-400 font-bold">Chưa có dữ liệu cho Lớp ${selectedGrade}.</p></div>`;
                return;
            }

            // --- HÀM CON: ĐỆ QUY VẼ CÂY CON (SỬ DỤNG <DETAILS>) ---
            const renderRecursiveChildren = (nodes) => {
                if (!nodes || nodes.length === 0) return '';
                
                let html = '';
                
                nodes.forEach(child => {
                    const hasChildren = child.children && child.children.length > 0;
                    const cbId = `cb-${child.id}`;
                    const formattedName = window.formatContent(child.name);
                    
                    if (hasChildren) {
                        // NẾU LÀ THƯ MỤC (CHƯƠNG/DẠNG) -> DÙNG DETAILS ĐỂ ĐÓNG MỞ
                        html += `
                            <div class="tree-branch mt-1">
                                <details class="group">
                                    <summary class="flex items-center gap-2 py-1.5 hover:text-blue-600 select-none">
                                        <i class="fa-solid fa-caret-right folder-icon text-gray-400 text-xs"></i>
                                        <input type="checkbox" id="${cbId}" value="${child.id}" 
                                            class="map-check w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer" 
                                            onclick="event.stopPropagation()"
                                            onchange="handleCheckTree(this)">
                                        <span class="text-sm font-bold text-gray-700 math-content group-open:text-indigo-700">${formattedName}</span>
                                    </summary>
                                    <div class="pt-1">
                                        ${renderRecursiveChildren(child.children)}
                                    </div>
                                </details>
                            </div>
                        `;
                    } else {
                        // NẾU LÀ FILE (BÀI HỌC CUỐI CÙNG)
                        html += `
                            <div class="tree-branch mt-1 border-l-0 pl-6 relative">
                                <div class="absolute left-0 top-1/2 w-4 h-[1px] bg-gray-300 -translate-y-1/2"></div>
                                <div class="tree-item flex items-start gap-2">
                                    <input type="checkbox" id="${cbId}" value="${child.id}" 
                                        class="map-check w-4 h-4 mt-1 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer flex-shrink-0" 
                                        onchange="handleCheckTree(this)">
                                    <label for="${cbId}" class="map-text cursor-pointer block math-content text-sm text-gray-600 leading-snug">
                                        ${formattedName}
                                    </label>
                                </div>
                            </div>
                        `;
                    }
                });
                return html;
            };

            // 2. Render Card cho từng Phân môn / Chương Lớn
            let hasContent = false;
            
            gradeNodes.forEach(rootNode => { 
                if(rootNode.children) {
                    rootNode.children.forEach(sectionNode => { 
                        
                        // Logic lọc Môn
                        let isVisible = true;
                        const nameLower = sectionNode.name.toLowerCase();
                        if (selectedSub !== 'all') { 
                            if (selectedSub === 'dai_so' && (nameLower.includes('hình') || nameLower.includes('không gian'))) isVisible = false;
                            if (selectedSub === 'hinh_hoc' && (nameLower.includes('đại số') || nameLower.includes('giải tích'))) isVisible = false;
                        }

                        if(isVisible) {
                            hasContent = true;
                            
                            // Tạo Card Accordion
                            const card = document.createElement('div');
                            card.className = "topic-card bg-white rounded-xl mb-3 overflow-hidden";
                            
                            // Header
                            const header = document.createElement('div');
                            header.className = "topic-header p-4 flex justify-between items-center bg-gray-50 border-b border-gray-100";
                            
                            // [THAY ĐỔI]: Mặc định KHÔNG active (đóng)
                            // card.classList.add('active'); 
                            
                            header.onclick = (e) => {
                                if(e.target.type !== 'checkbox') card.classList.toggle('active');
                            };

                            const headerId = `cb-header-${sectionNode.id}`;
                            const formattedHeaderName = window.formatContent(sectionNode.name);

                            header.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-lg shrink-0 border border-blue-100 shadow-sm">
                                        <i class="fa-solid fa-book"></i>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="${headerId}" class="map-check-parent w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer" 
                                            onchange="toggleAllChildren(this)">
                                        <label for="${headerId}" class="font-bold text-gray-800 text-sm leading-tight cursor-pointer select-none">
                                            ${formattedHeaderName}
                                        </label>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-down arrow-icon text-gray-400"></i>
                            `;
                            
                            // Body
                            const body = document.createElement('div');
                            body.className = "topic-body";
                            
                            if(sectionNode.children) {
                                // Gọi hàm đệ quy mới
                                body.innerHTML = `<div class="pt-2 pr-2">${renderRecursiveChildren(sectionNode.children)}</div>`;
                            } else {
                                body.innerHTML = `<p class="text-xs text-gray-400 italic p-4 text-center">Chưa có bài học nào.</p>`;
                            }
                            
                            card.appendChild(header);
                            card.appendChild(body);
                            container.appendChild(card);
                        }
                    });
                }
            });

            if (!hasContent) {
                container.innerHTML = `<div class="text-center py-10"><p class="text-gray-400">Không tìm thấy chuyên đề phù hợp.</p></div>`;
            }
            
            if(window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).catch((err) => console.log(err));
            }
            
            updateSelectionStatus();
        };

        // --- CÁC HÀM HỖ TRỢ (THÊM MỚI) ---
        
        // 1. Chọn cha -> Chọn hết con
        window.toggleAllChildren = (headerCheckbox) => {
            const card = headerCheckbox.closest('.topic-card');
            const body = card.querySelector('.topic-body');
            const allChecks = body.querySelectorAll('input[type="checkbox"]');
            allChecks.forEach(cb => cb.checked = headerCheckbox.checked);
            updateSelectionStatus();
        };

        // 2. Xử lý logic chọn cây (Chọn Cha -> Chọn hết Con)
        window.handleCheckTree = (el) => {
            const isChecked = el.checked;

            // Tìm thẻ <details> bao quanh checkbox này
            const parentDetails = el.closest('details');

            // Nếu checkbox này nằm trong <details> (tức là nó có thể là mục cha hoặc con)
            if (parentDetails) {
                const summary = parentDetails.querySelector('summary');
                
                // Kiểm tra: Nếu checkbox được click nằm ngay trong thẻ <summary> 
                // => Nghĩa là người dùng đang click vào MỤC CHA
                if (summary && summary.contains(el)) {
                    // Tìm tất cả checkbox con nằm trong nội dung chi tiết của mục này
                    // (Lưu ý: querySelectorAll sẽ tìm sâu xuống tất cả các cấp con cháu)
                    const allChildCheckboxes = parentDetails.querySelectorAll('input[type="checkbox"]');
                    
                    allChildCheckboxes.forEach(cb => {
                        cb.checked = isChecked;
                    });
                }
            }

            // Cập nhật số lượng đã chọn trên UI
            updateSelectionStatus();
        };

        window.updateSelectionStatus = () => {
            const count = document.querySelectorAll('.map-check:checked').length;
            const statusEl = document.getElementById('selectionStatus');
            if (count === 0) statusEl.innerHTML = '<i class="fa-solid fa-shuffle mr-1"></i> Ngẫu nhiên tất cả';
            else statusEl.innerHTML = `Đã chọn: <span class="text-indigo-600">${count} mục</span>`;
        };

        // --- LOGIC LUYỆN TẬP ---
        window.selectMode = (mode) => {
            document.getElementById('landingStep').classList.add('hidden');
            document.getElementById('configStep').classList.remove('hidden');
            renderTopicList(); // Đảm bảo render khi chuyển tab
        };

        window.backToLanding = () => {
            document.getElementById('configStep').classList.add('hidden');
            document.getElementById('landingStep').classList.remove('hidden');
        };

        const getDifficultyLevel = (id) => {
            if (id.includes('NB') || id.includes('N')) return 1;
            if (id.includes('TH') || id.includes('H')) return 2;
            if (id.includes('VD') || id.includes('V')) return 3;
            if (id.includes('VDC') || id.includes('C')) return 4;
            return 2; 
        };

        window.startPractice = async () => {
            const btn = document.querySelector('button[onclick="startPractice()"]');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang khởi tạo...'; btn.disabled = true;

            try {
                const grade = document.querySelector('input[name="grade"]:checked').value;
                const subject = document.querySelector('input[name="subject"]:checked').value;
                const qCount = parseInt(document.getElementById('inputQCount').value) || 10;
                const customTime = parseInt(document.getElementById('inputTime').value) || 0;
                const sortDiff = document.getElementById('toggleSortDifficulty').checked;
                
                const checkedLevels = Array.from(document.querySelectorAll('.level-checkbox:checked')).map(cb => cb.value);
                const checkedMapIds = Array.from(document.querySelectorAll('.map-check:checked')).map(cb => cb.value);

                // Lọc câu hỏi
                let pool = globalBankMetadata.filter(q => {
                    if (!q.id.startsWith(grade)) return false; 
                    if (subject === 'dai_so' && !q.id.includes('D') && !q.id.includes('G')) return false;
                    if (subject === 'hinh_hoc' && !q.id.includes('H')) return false;

                    if (checkedLevels.length > 0) {
                        let isLevelMatch = false;
                        for (let code of checkedLevels) {
                            let charCode = code === 'NB' ? 'N' : (code === 'TH' ? 'H' : (code === 'VD' ? 'V' : 'C'));
                            if (q.id.includes(charCode) || q.id.includes(code)) {
                                isLevelMatch = true; break;
                            }
                        }
                        if (!isLevelMatch) return false;
                    }

                    if (checkedMapIds.length > 0) {
                        const isMatchTopic = checkedMapIds.some(mapId => q.id.includes(mapId));
                        if (!isMatchTopic) return false;
                    }
                    return true;
                });

                if (pool.length === 0) throw new Error("Không tìm thấy câu hỏi phù hợp.");

                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                
                let selectedMeta = pool.slice(0, qCount);
                if (sortDiff) selectedMeta.sort((a, b) => getDifficultyLevel(a.id) - getDifficultyLevel(b.id));

                practiceQuestions = [];
                const WORKER_URL = "https://upload-helper.phamngockhanh-942001.workers.dev/bank";
                const fetchPromises = selectedMeta.map(async (meta) => {
                    try {
                        const res = await fetch(`${WORKER_URL}?id=${encodeURIComponent(meta.id)}`);
                        if (res.ok) return await res.json();
                    } catch (e) {}
                    return null;
                });
                
                const results = await Promise.all(fetchPromises);
                practiceQuestions = results.filter(q => q !== null);

                if (practiceQuestions.length === 0) throw new Error("Lỗi tải nội dung câu hỏi.");

                let totalMinutes = customTime;
                if (totalMinutes === 0) {
                    let totalSeconds = 0;
                    practiceQuestions.forEach(q => {
                        if (q.type === 'tf') totalSeconds += 240; 
                        else totalSeconds += 108; 
                    });
                    totalMinutes = Math.ceil(totalSeconds / 60);
                }
                
                document.getElementById('configStep').classList.add('hidden');
                document.getElementById('practiceStep').classList.remove('hidden');
                renderPracticeInterface();
                startTimer(totalMinutes * 60);

            } catch (err) {
                alert(err.message);
            } finally {
                btn.innerHTML = oldHtml; btn.disabled = false;
            }
        };

        function renderPracticeInterface() {
            const container = document.getElementById('questionContainer');
            const palette = document.getElementById('questionPalette');
            container.innerHTML = ''; palette.innerHTML = '';
            userAnswers = {}; 

            document.getElementById('progressText').innerText = `0/${practiceQuestions.length}`;
            document.getElementById('progressBar').style.width = '0%';

            practiceQuestions.forEach((q, idx) => {
                const qDiv = document.createElement('div');
                qDiv.id = `q-${idx}`;
                qDiv.className = "mb-6 bg-white p-5 rounded-2xl shadow-sm border border-gray-100 scroll-mt-20";
                
                let inputHtml = '';
                if (q.type === 'mc') {
                    if (!q.shuffleMap) {
                        let indices = [0, 1, 2, 3];
                        indices.sort(() => Math.random() - 0.5);
                        q.shuffleMap = indices;
                    }
                    inputHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">`;
                    q.shuffleMap.forEach((realIdx, displayIdx) => {
                        const opt = q.options[realIdx];
                        const label = String.fromCharCode(65 + displayIdx);
                        if(opt) {
                            inputHtml += `<label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition-all group"><div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-500 font-bold text-xs group-hover:bg-indigo-600 group-hover:text-white transition-colors shrink-0">${label}</div><input type="radio" name="ans-${idx}" value="${realIdx}" class="hidden" onchange="window.saveAnswer(${idx}, ${realIdx}, 'mc')"><span class="text-gray-700 text-sm font-medium math-content">${window.formatContent(opt)}</span></label>`;
                        }
                    });
                    inputHtml += `</div>`;
                } else if (q.type === 'tf') {
                    inputHtml = `<div class="mt-4 border border-gray-200 rounded-xl overflow-hidden bg-white"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-500 font-bold border-b border-gray-200"><tr><th class="p-3 w-10 text-center">#</th><th class="p-3">Mệnh đề</th><th class="p-3 w-14 text-center">Đ</th><th class="p-3 w-14 text-center">S</th></tr></thead><tbody class="divide-y divide-gray-100">`;
                    if(q.statements) {
                        q.statements.forEach((stmt, sIdx) => {
                            inputHtml += `<tr class="hover:bg-gray-50"><td class="p-3 text-center font-bold text-gray-400">${String.fromCharCode(97 + sIdx)})</td><td class="p-3 text-gray-700 math-content">${window.formatContent(stmt.text)}</td><td class="p-3 text-center"><input type="radio" name="tf-${idx}-${sIdx}" value="true" class="w-4 h-4 cursor-pointer text-blue-600" onchange="window.saveAnswer(${idx}, {sub:${sIdx}, val:true}, 'tf')"></td><td class="p-3 text-center"><input type="radio" name="tf-${idx}-${sIdx}" value="false" class="w-4 h-4 cursor-pointer text-red-600" onchange="window.saveAnswer(${idx}, {sub:${sIdx}, val:false}, 'tf')"></td></tr>`;
                        });
                    }
                    inputHtml += `</tbody></table></div>`;
                } else if (q.type === 'short') {
                    inputHtml = `<div class="mt-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Nhập đáp án:</label><input type="text" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-xl outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 font-bold text-gray-700 placeholder-gray-300" placeholder="Ví dụ: 5.2" onchange="window.saveAnswer(${idx}, this.value, 'short')"></div>`;
                }

                qDiv.innerHTML = `<div class="flex items-start gap-3"><span class="bg-blue-100 text-blue-700 font-bold px-2.5 py-1 rounded-lg text-xs shrink-0 mt-1">Câu ${idx + 1}</span><div class="text-gray-800 text-base leading-relaxed flex-1 math-content font-medium overflow-x-auto">${window.formatContent(q.content)}</div></div>${inputHtml}`;
                container.appendChild(qDiv);

                const btn = document.createElement('button');
                btn.id = `p-btn-${idx}`;
                btn.className = "h-8 w-full rounded-lg border border-gray-200 flex items-center justify-center font-bold text-xs text-gray-400 hover:bg-gray-50 transition-colors";
                btn.textContent = idx + 1;
                btn.onclick = () => { document.getElementById(`q-${idx}`).scrollIntoView({behavior: 'smooth', block: 'center'}); };
                palette.appendChild(btn);
            });

            if(window.MathJax) MathJax.typesetPromise([container]).catch(()=>{});
            setTimeout(() => { if(window.renderTikz) window.renderTikz(); if(window.autoScaleTables) window.autoScaleTables(); }, 500);
        }

        window.saveAnswer = (qIdx, value, type) => {
            if (type === 'mc') {
                userAnswers[qIdx] = value;
                const qDiv = document.getElementById(`q-${qIdx}`);
                qDiv.querySelectorAll('label').forEach(lbl => {
                    const inp = lbl.querySelector('input');
                    if(inp.value == value) lbl.classList.add('bg-indigo-50', 'border-indigo-300', 'ring-1', 'ring-indigo-300');
                    else lbl.classList.remove('bg-indigo-50', 'border-indigo-300', 'ring-1', 'ring-indigo-300');
                });
            } else if (type === 'short') { userAnswers[qIdx] = value.toString().trim(); } 
            else if (type === 'tf') { if (!userAnswers[qIdx]) userAnswers[qIdx] = {}; userAnswers[qIdx][value.sub] = value.val; }

            const btn = document.getElementById(`p-btn-${qIdx}`);
            btn.className = "h-8 w-full rounded-lg bg-blue-600 text-white border-blue-600 flex items-center justify-center font-bold text-xs transition-colors shadow-sm";
            const total = practiceQuestions.length; const done = Object.keys(userAnswers).length; const pct = (done / total) * 100;
            document.getElementById('progressBar').style.width = `${pct}%`; document.getElementById('progressText').innerText = `${done}/${total}`;
        };

        function startTimer(durationSeconds) {
            let remaining = durationSeconds;
            if(timerInterval) clearInterval(timerInterval);
            const display = document.getElementById('timerDisplay');
            timerInterval = setInterval(() => {
                const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                const s = (remaining % 60).toString().padStart(2, '0');
                display.textContent = `${m}:${s}`;
                if (remaining < 60) display.classList.replace('text-blue-600', 'text-red-600');
                if (remaining <= 0) { clearInterval(timerInterval); alert("Hết giờ làm bài!"); finishPractice(); }
                remaining--;
            }, 1000);
        }

        window.finishPractice = () => {
            clearInterval(timerInterval);
            let correctCount = 0;
            practiceQuestions.forEach((q, idx) => {
                const u = userAnswers[idx];
                if (q.type === 'mc') { if (u == q.correct) correctCount++; } 
                else if (q.type === 'short') { if (u && q.answer && u.toLowerCase() === q.answer.toString().toLowerCase()) correctCount++; }
                else if (q.type === 'tf') {
                    let isAllCorrect = true; if (!u) isAllCorrect = false;
                    else { q.statements.forEach((stmt, sIdx) => { if (u[sIdx] !== stmt.isTrue) isAllCorrect = false; }); }
                    if (isAllCorrect) correctCount++;
                }
            });
            const score = practiceQuestions.length > 0 ? (correctCount / practiceQuestions.length) * 10 : 0;
            document.getElementById('practiceStep').classList.add('hidden');
            document.getElementById('resultStep').classList.remove('hidden');
            document.getElementById('resScore').textContent = score.toFixed(1);
            document.getElementById('resCorrect').textContent = correctCount;
            document.getElementById('resWrong').textContent = practiceQuestions.length - correctCount;
        };

        window.viewSolutions = () => {
            document.getElementById('resultStep').classList.add('hidden');
            document.getElementById('practiceStep').classList.remove('hidden');
            document.querySelector('#practiceStep button[onclick="finishPractice()"]').classList.add('hidden');
            practiceQuestions.forEach((q, idx) => {
                const qDiv = document.getElementById(`q-${idx}`);
                const u = userAnswers[idx];
                let feedbackHtml = '';
                if (q.type === 'mc') {
                    const isCorrect = (u == q.correct);
                    let correctChar = '?'; if(q.shuffleMap) { const displayIdx = q.shuffleMap.indexOf(q.correct); correctChar = String.fromCharCode(65 + displayIdx); }
                    if(isCorrect) feedbackHtml = `<div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-xl text-green-700 font-bold text-xs"><i class="fa-solid fa-check mr-2"></i>Chính xác!</div>`;
                    else feedbackHtml = `<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 font-bold text-xs"><i class="fa-solid fa-xmark mr-2"></i>Sai rồi. Đáp án đúng: ${correctChar}</div>`;
                } else if (q.type === 'short') {
                    const isCorrect = (u && q.answer && u.toLowerCase() === q.answer.toString().toLowerCase());
                    if(isCorrect) feedbackHtml = `<div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-xl text-green-700 font-bold text-xs"><i class="fa-solid fa-check mr-2"></i>Chính xác!</div>`;
                    else feedbackHtml = `<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 font-bold text-xs"><i class="fa-solid fa-xmark mr-2"></i>Sai. Đáp án đúng: ${q.answer}</div>`;
                } else if (q.type === 'tf') {
                    let tableHtml = `<div class="mt-3 border border-gray-200 rounded-lg overflow-hidden"><table class="w-full text-xs">`;
                    q.statements.forEach((stmt, sIdx) => {
                        const userChoice = u ? u[sIdx] : undefined; const isTrue = stmt.isTrue;
                        let statusIcon = (userChoice === isTrue) ? '<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i></span>' : '<span class="text-red-500 font-bold"><i class="fa-solid fa-xmark"></i></span>';
                        let rowClass = (userChoice === isTrue) ? 'bg-green-50' : 'bg-red-50';
                        tableHtml += `<tr class="${rowClass} border-b border-white"><td class="p-2">Ý ${String.fromCharCode(97 + sIdx)}</td><td class="p-2">Đáp án: <b>${isTrue?'Đúng':'Sai'}</b></td><td class="p-2">Bạn chọn: <b>${userChoice===true?'Đúng':(userChoice===false?'Sai':'--')}</b></td><td class="p-2 text-right">${statusIcon}</td></tr>`;
                    });
                    tableHtml += `</table></div>`; feedbackHtml = tableHtml;
                }
                if(q.solution) { feedbackHtml += `<div class="mt-3 pt-3 border-t border-gray-100"><p class="font-bold text-blue-600 mb-2 text-xs uppercase"><i class="fa-solid fa-lightbulb mr-1"></i> Lời giải chi tiết</p><div class="text-gray-700 math-content text-sm bg-gray-50 p-3 rounded-lg">${window.formatContent(q.solution)}</div></div>`; }
                qDiv.insertAdjacentHTML('beforeend', feedbackHtml);
            });
            if(window.MathJax) MathJax.typesetPromise();
        };

        window.togglePalette = () => {
            const el = document.getElementById('questionPalette'); const icon = document.getElementById('paletteIcon');
            if (el.classList.contains('hidden')) { el.classList.remove('hidden'); icon.style.transform = 'rotate(0deg)'; } 
            else { el.classList.add('hidden'); icon.style.transform = 'rotate(180deg)'; }
        };
    </script>
</body>
</html>
