<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luyện Tập Thông Minh - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      loader: { load: ['[tex]/noerrors', '[tex]/noundefined'] },
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors', 'noundefined']},
        macros: {
          heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
          hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ",
          R: "\\mathbb{R}",
          N: "\\mathbb{N}",
          Z: "\\mathbb{Z}",
          vectors: ["\\overrightarrow{#1}", 1],
          mtx: ["\\left[\\begin{matrix}#1\\end{matrix}\\right]", 1]
        }
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hiệu ứng rung nhẹ khi chọn chế độ */
        .mode-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15); border-color: #3B82F6; }
        
        /* Style cho Tree */
        .tree-node-content { transition: all 0.2s; border-radius: 6px; }
        .tree-node-content:hover { background-color: #EFF6FF; color: #2563EB; }
        .caret { transition: transform 0.2s; }
        .caret.expanded { transform: rotate(90deg); }
        .nested { display: none; padding-left: 20px; border-left: 1px dashed #CBD5E1; margin-left: 9px; }
        .nested.active { display: block; }
        .caret { transition: transform 0.2s; }
        .caret.expanded { transform: rotate(90deg); }
        .nested { display: none; padding-left: 24px; border-left: 1px dashed #E2E8F0; margin-left: 10px; }
        .nested.active { display: block; }

        /* Style Checkbox Mức độ (Chips) */
        .level-checkbox:checked + div {
            background-color: #EFF6FF; 
            border-color: #3B82F6; 
            color: #1D4ED8;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        .level-checkbox:checked + div .check-icon { opacity: 1; transform: scale(1); }

        /* Style Cây Kiến Thức (Tree) - Đẹp & Trực quan */
        .tree-line {
            position: absolute; left: 14px; top: 32px; bottom: 0; width: 1px; background-color: #E2E8F0;
        }
        .tree-item-connector {
            position: absolute; left: -18px; top: 16px; width: 18px; height: 1px; background-color: #E2E8F0;
        }
        .tree-node-content { position: relative; z-index: 10; }
        
        /* Hiệu ứng rung nhắc nhở */
        @keyframes attention-bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }
        .animate-attention { animation: attention-bounce 1s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='student.html'">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-brain"></i>
                </div>
                <div>
                    <h1 class="font-black text-gray-800 text-lg leading-tight">Phòng Luyện Tập</h1>
                    <p class="text-xs text-gray-500 font-bold">Toán Học Tư Duy</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.reload()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-rotate"></i></button>
                <button onclick="window.history.back()" class="w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
    </header>

    <main class="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full relative">
        
        <div id="landingStep" class="flex flex-col items-center justify-center min-h-[80vh] animate-fade-in">
            <div class="text-center mb-10">
                <h2 class="text-3xl md:text-5xl font-black text-gray-800 mb-4">Bạn muốn luyện tập gì hôm nay?</h2>
                <p class="text-gray-500 text-lg">Chọn một chế độ để bắt đầu hành trình chinh phục điểm 10.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl px-4">
                <div onclick="selectMode('topic')" class="mode-card bg-white p-8 rounded-3xl border-2 border-gray-100 cursor-pointer transition-all duration-300 relative group overflow-hidden">
                    <div class="absolute top-0 right-0 bg-blue-100 w-32 h-32 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ôn tập theo Chuyên đề</h3>
                        <p class="text-gray-500 text-sm">Chọn cụ thể Chương, Bài học hoặc Dạng toán bạn muốn củng cố kiến thức.</p>
                    </div>
                </div>

                <div onclick="selectMode('random')" class="mode-card bg-white p-8 rounded-3xl border-2 border-gray-100 cursor-pointer transition-all duration-300 relative group overflow-hidden">
                    <div class="absolute top-0 right-0 bg-purple-100 w-32 h-32 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="w-16 h-16 bg-purple-50 text-purple-600 rounded-2xl flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:bg-purple-600 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-shuffle"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Luyện ngẫu nhiên</h3>
                        <p class="text-gray-500 text-sm">Hệ thống tự động trích xuất câu hỏi ngẫu nhiên từ kho dữ liệu theo Lớp và Môn.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="configStep" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)] animate-slideIn">
            
            <div class="lg:col-span-4 flex flex-col gap-4 h-full overflow-y-auto custom-scrollbar pr-1">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-2 mb-4 cursor-pointer text-gray-400 hover:text-blue-600 transition-colors w-fit" onclick="backToLanding()">
                        <i class="fa-solid fa-arrow-left"></i> <span class="text-xs font-bold uppercase">Quay lại</span>
                    </div>

                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><i class="fa-solid fa-sliders text-blue-600"></i> Thiết lập chung</h3>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Khối Lớp</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="grade" value="12" class="peer sr-only" checked onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">12</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="11" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">11</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="10" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">10</div></label>
                                <label class="cursor-pointer"><input type="radio" name="grade" value="9" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 hover:bg-gray-50 transition-all">9</div></label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Phân Môn</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="cursor-pointer"><input type="radio" name="subject" value="all" class="peer sr-only" checked onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50 transition-all">Tất cả</div></label>
                                <label class="cursor-pointer"><input type="radio" name="subject" value="dai_so" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50 transition-all">Đại số</div></label>
                                <label class="cursor-pointer"><input type="radio" name="subject" value="hinh_hoc" class="peer sr-only" onchange="renderTree()"><div class="py-2 text-center rounded-xl border border-gray-200 text-gray-600 font-bold text-xs peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600 hover:bg-gray-50 transition-all">Hình học</div></label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Mức độ câu hỏi (Chọn nhiều)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer relative">
                                    <input type="checkbox" class="level-checkbox peer sr-only" value="NB">
                                    <div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center">
                                        <span>Nhận biết</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative">
                                    <input type="checkbox" class="level-checkbox peer sr-only" value="TH" checked>
                                    <div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center">
                                        <span>Thông hiểu</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative">
                                    <input type="checkbox" class="level-checkbox peer sr-only" value="VD" checked>
                                    <div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center">
                                        <span>Vận dụng</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative">
                                    <input type="checkbox" class="level-checkbox peer sr-only" value="VDC">
                                    <div class="py-2 px-3 rounded-xl border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50 transition-all flex justify-between items-center">
                                        <span>Vận dụng cao</span> <i class="fa-solid fa-check check-icon opacity-0 transition-opacity text-blue-600"></i>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="w-full h-[1px] bg-gray-100"></div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Số lượng</label>
                                <input type="number" id="inputQCount" value="10" min="1" max="50" class="w-full px-3 py-2 border border-gray-200 rounded-xl font-bold text-center text-gray-700 outline-none focus:ring-2 focus:ring-blue-100">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Thời gian (p)</label>
                                <input type="number" id="inputTime" value="0" min="0" placeholder="Auto" class="w-full px-3 py-2 border border-gray-200 rounded-xl font-bold text-center text-gray-700 outline-none focus:ring-2 focus:ring-blue-100">
                            </div>
                        </div>
                         
                         <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-100">
                            <span class="text-xs font-bold text-gray-600">Sắp xếp dễ -> khó</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleSortDifficulty" class="sr-only peer" checked>
                                <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button onclick="startPractice()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-black rounded-2xl shadow-xl shadow-blue-200 transform active:scale-95 transition-all text-base flex items-center justify-center gap-2 mt-auto">
                    <i class="fa-solid fa-rocket"></i> BẮT ĐẦU LUYỆN TẬP
                </button>
            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-md border-2 border-indigo-50 flex flex-col overflow-hidden h-full relative">
                <div class="p-5 border-b border-gray-100 bg-indigo-50/50 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="font-black text-xl text-indigo-900 flex items-center gap-2">
                            <i class="fa-solid fa-folder-tree text-indigo-600"></i> NỘI DUNG ÔN TẬP
                        </h3>
                        <p class="text-xs text-indigo-500 font-bold mt-1 ml-7">Chọn chương, bài học hoặc dạng toán cụ thể</p>
                    </div>
                    
                    <div id="selectionStatus" class="text-xs font-bold bg-white px-4 py-2 rounded-full border border-indigo-100 text-gray-500 shadow-sm">
                        <i class="fa-solid fa-shuffle mr-1"></i> Ngẫu nhiên tất cả
                    </div>
                </div>
                
                <div id="treeContainer" class="flex-1 overflow-y-auto p-6 custom-scrollbar relative">
                    <div class="text-center py-20 text-gray-400">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3 text-indigo-300"></i>
                        <p class="text-sm font-bold text-gray-500">Đang tải dữ liệu...</p>
                    </div>
                </div>

                <div id="treePromptOverlay" class="absolute bottom-6 right-6 pointer-events-none opacity-0 transition-opacity duration-500">
                    <div class="bg-indigo-600 text-white px-4 py-3 rounded-xl shadow-lg font-bold text-sm flex items-center gap-3 animate-attention">
                        <i class="fa-solid fa-hand-point-up text-xl"></i>
                        Hãy tích chọn bài học ở đây!
                    </div>
                </div>
            </div>
        </div>

                        <div class="w-full h-[1px] bg-gray-100"></div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Số lượng câu hỏi</label>
                            <div class="flex items-center gap-3">
                                <input type="number" id="inputQCount" value="10" min="1" max="100" class="w-24 px-3 py-2 border-2 border-gray-200 rounded-xl font-bold text-center text-gray-700 focus:border-blue-500 outline-none" onchange="updateTimeEstimate()">
                                <span class="text-sm text-gray-500">câu</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Thời gian (Phút)</label>
                            <div class="flex items-center gap-3">
                                <input type="number" id="inputTime" value="0" min="0" class="w-24 px-3 py-2 border-2 border-gray-200 rounded-xl font-bold text-center text-gray-700 focus:border-blue-500 outline-none">
                                <span class="text-xs text-gray-400 italic">(Để 0 để hệ thống tự tính)</span>
                            </div>
                            <p class="text-[10px] text-blue-500 mt-1"><i class="fa-solid fa-circle-info"></i> Tự động: TN/Điền (1.8p), Đ/S (4p)</p>
                        </div>

                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <span class="text-sm font-bold text-gray-700">Sắp xếp theo độ khó?</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleSortDifficulty" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <button onclick="startPractice()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-black rounded-2xl shadow-xl shadow-blue-200 transform active:scale-95 transition-all text-base flex items-center justify-center gap-2 mt-auto">
                    <i class="fa-solid fa-rocket"></i> BẮT ĐẦU LUYỆN TẬP
                </button>
            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden h-full">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-gray-700"><i class="fa-solid fa-folder-tree mr-2 text-indigo-600"></i>Nội dung kiến thức</h3>
                    <div id="selectionStatus" class="text-xs font-bold bg-white px-3 py-1 rounded-full border border-gray-200 text-gray-500">
                        Đang chọn: <span class="text-blue-600">Ngẫu nhiên tất cả</span>
                    </div>
                </div>
                
                <div id="treeContainer" class="flex-1 overflow-y-auto p-6 custom-scrollbar relative">
                    <div class="text-center py-20 text-gray-400">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="practiceStep" class="hidden max-w-5xl mx-auto h-[calc(100vh-100px)] flex flex-col">
            <div class="mb-4 flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-100 shrink-0">
                <div class="flex items-center gap-4">
                    <div onclick="window.history.back()" class="w-10 h-10 rounded-xl bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-500 cursor-pointer transition-colors"><i class="fa-solid fa-arrow-left"></i></div>
                    <div>
                        <p class="text-gray-400 font-bold text-[10px] uppercase tracking-wider">Thời gian còn lại</p>
                        <p class="font-mono font-black text-gray-800 text-xl leading-none tracking-tight text-blue-600" id="timerDisplay">00:00</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:block text-right mr-2">
                        <p class="text-xs font-bold text-gray-500" id="progressText">0/0</p>
                        <div class="w-32 h-1.5 bg-gray-100 rounded-full mt-1 overflow-hidden"><div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div></div>
                    </div>
                    <button onclick="finishPractice()" class="px-6 py-2.5 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-200 transition-all text-sm">Nộp bài</button>
                </div>
            </div>

            <div id="questionContainer" class="flex-1 overflow-y-auto p-1 scroll-smooth pb-20 pr-2 custom-scrollbar"></div>
            
            <div class="mt-2 bg-white rounded-t-2xl shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] border border-gray-100 z-10 flex flex-col shrink-0 transition-all duration-300">
                <div class="flex justify-between items-center p-3 px-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 select-none" onclick="window.togglePalette()">
                    <p class="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2">
                        <i class="fa-solid fa-list-ol"></i> Danh sách câu hỏi
                    </p>
                    <button class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-blue-100 hover:text-blue-600 transition-colors">
                        <i id="paletteIcon" class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i>
                    </button>
                </div>
                
                <div id="questionPalette" class="grid grid-cols-5 md:grid-cols-10 lg:grid-cols-20 gap-2 max-h-40 overflow-y-auto custom-scrollbar p-4 bg-white"></div>
            </div>
        </div>

        <div id="resultStep" class="hidden max-w-2xl mx-auto animate-fade-in py-10">
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden text-center border border-gray-100">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-10 text-white relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <h2 class="text-2xl font-black mb-1 relative z-10">KẾT QUẢ LUYỆN TẬP</h2>
                    <p class="text-indigo-100 text-sm mb-6 relative z-10">Cố gắng hơn nữa nhé!</p>
                    <div class="w-32 h-32 mx-auto bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center border-4 border-white/20 mb-6 relative z-10 shadow-inner">
                        <div>
                            <span class="text-5xl font-black" id="resScore">0</span>
                            <span class="text-xs font-bold block uppercase tracking-wide opacity-80">Điểm</span>
                        </div>
                    </div>
                    <div class="flex justify-center gap-8 text-sm font-bold relative z-10">
                        <div class="bg-green-500/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-green-400/30"><i class="fa-solid fa-check mr-1"></i>Đúng: <span id="resCorrect">0</span></div>
                        <div class="bg-red-500/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-red-400/30"><i class="fa-solid fa-xmark mr-1"></i>Sai: <span id="resWrong">0</span></div>
                    </div>
                </div>
                <div class="p-8 bg-gray-50 flex justify-center gap-4">
                    <button onclick="window.location.reload()" class="px-6 py-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-100 hover:shadow-md transition-all text-sm">Luyện tập lại</button>
                    <button onclick="viewSolutions()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 hover:shadow-lg shadow-blue-200 transition-all text-sm">Xem lời giải</button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        // Import thêm renderTikz và autoScaleTables từ utils
        import { formatContent, renderTikz, autoScaleTables } from "./utils.js"; 

        // [QUAN TRỌNG] Gán vào window để dùng được trong HTML template
        window.formatContent = formatContent;
        window.renderTikz = renderTikz;
        window.autoScaleTables = autoScaleTables;

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let mapTree = [];
        let selectedQCount = 10;
        let practiceQuestions = [];
        let userAnswers = {};
        let startTime;
        let timerInterval;
        
        // [MỚI] Biến chứa danh sách ID từ Ngân hàng
        let globalBankMetadata = [];

        // --- 1. KHỞI TẠO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Tải song song: MapID từ Firestore và Danh sách câu hỏi từ R2
                await Promise.all([loadMapTree(), loadBankMetadata()]);
            } else {
                window.location.href = 'index.html';
            }
        });

        // [MỚI] Hàm tải danh sách ID (Rất nhẹ)
        async function loadBankMetadata() {
            try {
                // Link Worker của bạn
                const WORKER_URL = "https://upload-helper.phamngockhanh-942001.workers.dev/bank";
                const res = await fetch(WORKER_URL);
                if (res.ok) {
                    globalBankMetadata = await res.json();
                    console.log("Đã tải xong danh sách:", globalBankMetadata.length, "câu");
                }
            } catch (e) { console.error("Lỗi tải Bank:", e); }
        }

        // [MỚI] Hàm định dạng nội dung (Để đảm bảo Preview không lỗi)
        // [FIX] Hàm định dạng nội dung: Bảo vệ công thức Toán
        // [FIX HOÀN TOÀN] Hàm định dạng: Toán + Văn bản + Ảnh
        window.formatContent = (text) => {
            if (!text) return "";
            
            // 1. Tách chuỗi thành các phần:
            // - Khối Toán: $...$, \begin...
            // - Khối HTML Ảnh (do hệ thống tự chèn): <div...>...</div>
            // - Văn bản thường
            
            // Regex phức tạp hơn để bắt cả thẻ DIV ảnh
            const regex = /(\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\]|\\\([\s\S]*?\\\)|\\begin\{[a-zA-Z*]+\}[\s\S]*?\\end\{[a-zA-Z*]+\}|\$[^\$]*?\$|<div[\s\S]*?<\/div>|<img[^>]*>)/g;
            
            const parts = text.split(regex);

            return parts.map(part => {
                if (!part) return "";

                // Kiểm tra loại nội dung
                const isMath = /^\$|\\\(|\\\[|\\begin/.test(part);
                const isImageHTML = part.trim().startsWith('<div') || part.trim().startsWith('<img');

                if (isMath) {
                    // LÀ TOÁN: Giữ nguyên
                    return part.replace(/</g, ' < '); 
                } 
                else if (isImageHTML) {
                    // LÀ HTML ẢNH: Giữ nguyên tuyệt đối để trình duyệt render ảnh
                    return part;
                } 
                else {
                    // LÀ VĂN BẢN THƯỜNG: Mã hóa < > để tránh lỗi, và xử lý xuống dòng
                    return part
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\\\\/g, '<br>') // Chuyển \\ thành xuống dòng
                        .replace(/\\newline/g, '<br>')
                        .replace(/\n/g, '<br>');
                }
            }).join('');
        };

        async function loadMapTree() {
            try {
                const docSnap = await getDoc(doc(db, "configurations", "map_id_tree"));
                if (docSnap.exists()) {
                    mapTree = docSnap.data().tree || [];
                    renderTree(); 
                } else {
                    document.getElementById('treeContainer').innerHTML = '<p class="text-center text-gray-400 mt-10">Chưa có dữ liệu MapID.</p>';
                }
            } catch (error) {
                console.error("Lỗi:", error);
            }
        }

       // --- 2. RENDER CÂY THƯ MỤC (GIAO DIỆN PRO) ---
        window.renderTree = () => {
            const container = document.getElementById('treeContainer');
            const selectedGrade = document.querySelector('input[name="grade"]:checked').value;
            const selectedSub = document.querySelector('input[name="subject"]:checked').value;

            container.innerHTML = '';
            
            if (mapTree.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 mt-10">Đang tải dữ liệu...</p>';
                return;
            }

            // Lọc Node theo Lớp
            const gradeNodes = mapTree.filter(node => node.name.includes(selectedGrade));
            
            if (gradeNodes.length === 0) {
                container.innerHTML = '<div class="text-center py-10"><p class="text-gray-400 font-bold">Chưa có dữ liệu cho khối lớp này.</p></div>';
                return;
            }

            // Hàm đệ quy tạo HTML
            function createNodeHtml(nodes, level = 0, parentPath = "") {
                let html = `<ul class="pl-0 relative ${level > 0 ? 'ml-6' : ''}">`;
                if(level > 0) html += `<div class="tree-line"></div>`; // Đường kẻ dọc nối các node con
                
                let hasItem = false;

                nodes.forEach(node => {
                    // Logic lọc môn (Đại/Hình)
                    let isVisible = true;
                    if (selectedSub !== 'all' && level < 2) { 
                        const nameLower = node.name.toLowerCase();
                        if (selectedSub === 'dai_so' && (nameLower.includes('hình') || nameLower.includes('không gian'))) isVisible = false;
                        if (selectedSub === 'hinh_hoc' && (nameLower.includes('đại số') || nameLower.includes('giải tích'))) isVisible = false;
                    }

                    if (isVisible) {
                        hasItem = true;
                        const hasChildren = node.children && node.children.length > 0;
                        const cbId = `cb-${node.id}`;
                        
                        // Icon khác nhau tùy level
                        let iconClass = 'fa-folder text-yellow-400'; // Mặc định là Folder
                        if (level >= 2) iconClass = 'fa-file-lines text-blue-400'; // Bài học
                        if (level >= 3) iconClass = 'fa-tag text-purple-400'; // Dạng toán
                        
                        // Màu nền khác nhau
                        let bgClass = "hover:bg-indigo-50";
                        if(level === 0) bgClass = "bg-gray-50 border border-gray-200 mb-2"; // Level 0 (Chương/Phần) đóng khung riêng

                        html += `
                            <li class="relative">
                                ${level > 0 ? '<div class="tree-item-connector"></div>' : ''}
                                <div class="tree-node-content flex items-center gap-3 p-2.5 rounded-lg cursor-pointer select-none ${bgClass} transition-all group">
                                    <span onclick="toggleNode(this)" class="w-6 h-6 flex items-center justify-center hover:bg-black/5 rounded transition-colors shrink-0 z-20">
                                        ${hasChildren ? '<i class="fa-solid fa-caret-right caret text-gray-400 transition-transform duration-200"></i>' : ''}
                                    </span>
                                    
                                    <div class="flex items-center gap-3 flex-1">
                                        <input type="checkbox" id="${cbId}" class="map-check w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer z-20" 
                                            value="${node.id}" 
                                            onchange="handleCheck(this)">
                                        
                                        <label for="${cbId}" class="flex items-center gap-2 cursor-pointer flex-1 group-hover:text-indigo-700">
                                            <i class="fa-solid ${iconClass} text-lg"></i>
                                            <span class="text-sm font-bold text-gray-700">${node.name}</span>
                                        </label>
                                    </div>
                                </div>
                                ${hasChildren ? `<div class="nested hidden">${createNodeHtml(node.children, level + 1)}</div>` : ''}
                            </li>
                        `;
                    }
                });
                html += '</ul>';
                return hasItem ? html : '';
            }
            
            container.innerHTML = createNodeHtml(gradeNodes);
            updateSelectionStatus();
            
            // Hiện nhắc nhở sau 1s
            setTimeout(() => {
                document.getElementById('treePromptOverlay').style.opacity = '1';
                setTimeout(() => document.getElementById('treePromptOverlay').style.opacity = '0', 5000);
            }, 1000);
        };

        // Hàm Expand/Collapse
        window.toggleNode = (el) => {
            const li = el.closest('li');
            const nested = li.querySelector('.nested');
            const caret = li.querySelector('.caret');
            if (nested) {
                nested.classList.toggle('active');
                if(caret) caret.classList.toggle('expanded');
            }
        };

        // Logic Checkbox thông minh (Chọn cha -> Chọn hết con)
        window.handleCheck = (el) => {
            const li = el.closest('li');
            const isChecked = el.checked;
            
            // 1. Xử lý xuống dưới (Children)
            const childrenChecks = li.querySelectorAll('.map-check');
            childrenChecks.forEach(c => c.checked = isChecked);

            // 2. Xử lý lên trên (Parent) - Optional: Nếu tất cả con checked thì cha checked (Bỏ qua để đơn giản)
            updateSelectionStatus();
        };

        function updateSelectionStatus() {
            const count = document.querySelectorAll('.map-check:checked').length;
            const statusEl = document.getElementById('selectionStatus');
            if (count === 0) {
                statusEl.innerHTML = 'Đang chọn: <span class="font-bold text-blue-600">Ngẫu nhiên tất cả</span>';
            } else {
                statusEl.innerHTML = `Đang chọn: <span class="font-bold text-indigo-600">${count} mục</span>`;
            }
        }

        window.setQCount = (n) => {
            selectedQCount = n;
            document.querySelectorAll('.q-btn').forEach(b => {
                b.className = "q-btn flex-1 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-white hover:shadow-sm transition-all";
                if(b.textContent == n) b.className = "q-btn flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow-sm text-blue-700 transition-all";
            });
        };

        // ============================================================
        // LOGIC MỚI: UI/UX & CẤU HÌNH LUYỆN TẬP
        // ============================================================

        // 1. Chuyển đổi màn hình
        window.selectMode = (mode) => {
            document.getElementById('landingStep').classList.add('hidden');
            document.getElementById('configStep').classList.remove('hidden');
            // Nếu chọn "Ngẫu nhiên" có thể auto-config thêm ở đây nếu muốn
        };

        window.backToLanding = () => {
            document.getElementById('configStep').classList.add('hidden');
            document.getElementById('landingStep').classList.remove('hidden');
        };

        // 2. Cập nhật ước lượng thời gian
        window.updateTimeEstimate = () => {
            const count = parseInt(document.getElementById('inputQCount').value) || 10;
            const timeInput = document.getElementById('inputTime');
            // Nếu người dùng chưa nhập tay, gợi ý = số câu * 2 phút
            if (timeInput.value == 0) {
                 // Logic chỉ là gợi ý, không set cứng giá trị để tránh phiền
            }
        };

        // 3. Hàm phân tích mức độ (Để sắp xếp)
        const getDifficultyLevel = (id) => {
            if (id.includes('NB') || id.includes('N')) return 1;
            if (id.includes('TH') || id.includes('H')) return 2;
            if (id.includes('VD') || id.includes('V')) return 3;
            if (id.includes('VDC') || id.includes('C')) return 4;
            return 2; 
        };

        // --- 3. BẮT ĐẦU LUYỆN TẬP (CẬP NHẬT LOGIC MỨC ĐỘ) ---
        window.startPractice = async () => {
            const btn = document.querySelector('button[onclick="startPractice()"]');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang khởi tạo...'; btn.disabled = true;

            try {
                const grade = document.querySelector('input[name="grade"]:checked').value;
                const subject = document.querySelector('input[name="subject"]:checked').value;
                const qCount = parseInt(document.getElementById('inputQCount').value) || 10;
                const customTime = parseInt(document.getElementById('inputTime').value) || 0;
                const sortDiff = document.getElementById('toggleSortDifficulty').checked;
                
                // [MỚI] Lấy danh sách Mức độ đã chọn
                const checkedLevels = Array.from(document.querySelectorAll('.level-checkbox:checked')).map(cb => cb.value);
                const checkedMapIds = Array.from(document.querySelectorAll('.map-check:checked')).map(cb => cb.value);

                // Lọc
                let pool = globalBankMetadata.filter(q => {
                    // 1. Lớp & Môn
                    if (!q.id.startsWith(grade)) return false; 
                    if (subject === 'dai_so' && !q.id.includes('D') && !q.id.includes('G')) return false;
                    if (subject === 'hinh_hoc' && !q.id.includes('H')) return false;

                    // 2. [MỚI] Lọc Mức độ (Multi-select)
                    // Nếu không chọn gì cả -> Coi như chọn tất cả (Default)
                    if (checkedLevels.length > 0) {
                        let isLevelMatch = false;
                        // Kiểm tra ID câu hỏi có chứa mã mức độ nào trong danh sách đã chọn không
                        // VD: Chọn ['NB', 'VD']. ID '9D1H1' (Thông hiểu - H) -> False
                        // ID '9D1V1' (Vận dụng - V) -> True
                        
                        // Mapping ký tự ID sang mã Mức độ
                        // N -> NB, H -> TH, V -> VD, C -> VDC
                        for (let code of checkedLevels) {
                            let charCode = '';
                            if (code === 'NB') charCode = 'N'; // Hoặc NB
                            if (code === 'TH') charCode = 'H';
                            if (code === 'VD') charCode = 'V';
                            if (code === 'VDC') charCode = 'C'; // Hoặc VDC
                            
                            // Check lỏng: ID chứa ký tự đại diện (VD: ...H...) hoặc chứa mã full (VD: ...TH...)
                            if (q.id.includes(charCode) || q.id.includes(code)) {
                                isLevelMatch = true;
                                break;
                            }
                        }
                        if (!isLevelMatch) return false;
                    }

                    // 3. Lọc theo Cây (MapID)
                    if (checkedMapIds.length > 0) {
                        const isMatchTopic = checkedMapIds.some(mapId => q.id.includes(mapId));
                        if (!isMatchTopic) return false;
                    }
                    
                    return true;
                });

                if (pool.length === 0) throw new Error("Không tìm thấy câu hỏi phù hợp với các tiêu chí đã chọn.");

                // ... (Các bước Trộn, Cắt, Tải nội dung giữ nguyên như cũ) ...
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                let selectedMeta = pool.slice(0, qCount);
                if (sortDiff) selectedMeta.sort((a, b) => getDifficultyLevel(a.id) - getDifficultyLevel(b.id));

                practiceQuestions = [];
                const WORKER_URL = "https://upload-helper.phamngockhanh-942001.workers.dev/bank";
                const fetchPromises = selectedMeta.map(async (meta) => {
                    try {
                        const res = await fetch(`${WORKER_URL}?id=${encodeURIComponent(meta.id)}`);
                        if (res.ok) return await res.json();
                    } catch (e) {}
                    return null;
                });
                
                const results = await Promise.all(fetchPromises);
                practiceQuestions = results.filter(q => q !== null);

                if (practiceQuestions.length === 0) throw new Error("Lỗi tải nội dung câu hỏi.");

                let totalMinutes = customTime;
                if (totalMinutes === 0) {
                    let totalSeconds = 0;
                    practiceQuestions.forEach(q => {
                        if (q.type === 'tf') totalSeconds += 240; 
                        else totalSeconds += 108; 
                    });
                    totalMinutes = Math.ceil(totalSeconds / 60);
                }
                
                document.getElementById('configStep').classList.add('hidden');
                document.getElementById('practiceStep').classList.remove('hidden');
                renderPracticeInterface();
                startTimer(totalMinutes * 60);

            } catch (err) {
                alert(err.message);
            } finally {
                btn.innerHTML = oldHtml; btn.disabled = false;
            }
        };

        // 5. RENDER GIAO DIỆN LÀM BÀI (Full)
        function renderPracticeInterface() {
            const container = document.getElementById('questionContainer');
            const palette = document.getElementById('questionPalette');
            container.innerHTML = '';
            palette.innerHTML = '';
            userAnswers = {}; 

            // Init Progress Bar
            document.getElementById('progressText').innerText = `0/${practiceQuestions.length}`;
            document.getElementById('progressBar').style.width = '0%';

            practiceQuestions.forEach((q, idx) => {
                const qDiv = document.createElement('div');
                qDiv.id = `q-${idx}`;
                qDiv.className = "mb-6 bg-white p-5 rounded-2xl shadow-sm border border-gray-100 scroll-mt-20";
                
                let inputHtml = '';
                // --- TRẮC NGHIỆM ---
                if (q.type === 'mc') {
                    if (!q.shuffleMap) {
                        let indices = [0, 1, 2, 3];
                        indices.sort(() => Math.random() - 0.5);
                        q.shuffleMap = indices;
                    }
                    inputHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">`;
                    q.shuffleMap.forEach((realIdx, displayIdx) => {
                        const opt = q.options[realIdx];
                        const label = String.fromCharCode(65 + displayIdx);
                        if(opt) {
                            inputHtml += `
                                <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition-all group">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-500 font-bold text-xs group-hover:bg-indigo-600 group-hover:text-white transition-colors shrink-0">${label}</div>
                                    <input type="radio" name="ans-${idx}" value="${realIdx}" class="hidden" onchange="window.saveAnswer(${idx}, ${realIdx}, 'mc')">
                                    <span class="text-gray-700 text-sm font-medium math-content">${window.formatContent(opt)}</span>
                                </label>`;
                        }
                    });
                    inputHtml += `</div>`;
                }
                // --- ĐÚNG / SAI ---
                else if (q.type === 'tf') {
                    inputHtml = `<div class="mt-4 border border-gray-200 rounded-xl overflow-hidden bg-white"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-500 font-bold border-b border-gray-200"><tr><th class="p-3 w-10 text-center">#</th><th class="p-3">Mệnh đề</th><th class="p-3 w-14 text-center">Đ</th><th class="p-3 w-14 text-center">S</th></tr></thead><tbody class="divide-y divide-gray-100">`;
                    if(q.statements) {
                        q.statements.forEach((stmt, sIdx) => {
                            inputHtml += `<tr class="hover:bg-gray-50"><td class="p-3 text-center font-bold text-gray-400">${String.fromCharCode(97 + sIdx)})</td><td class="p-3 text-gray-700 math-content">${window.formatContent(stmt.text)}</td><td class="p-3 text-center"><input type="radio" name="tf-${idx}-${sIdx}" value="true" class="w-4 h-4 cursor-pointer text-blue-600" onchange="window.saveAnswer(${idx}, {sub:${sIdx}, val:true}, 'tf')"></td><td class="p-3 text-center"><input type="radio" name="tf-${idx}-${sIdx}" value="false" class="w-4 h-4 cursor-pointer text-red-600" onchange="window.saveAnswer(${idx}, {sub:${sIdx}, val:false}, 'tf')"></td></tr>`;
                        });
                    }
                    inputHtml += `</tbody></table></div>`;
                }
                // --- ĐIỀN KHUYẾT ---
                else if (q.type === 'short') {
                    inputHtml = `<div class="mt-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Nhập đáp án:</label><input type="text" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-xl outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 font-bold text-gray-700 placeholder-gray-300" placeholder="Ví dụ: 5.2" onchange="window.saveAnswer(${idx}, this.value, 'short')"></div>`;
                }

                qDiv.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="bg-blue-100 text-blue-700 font-bold px-2.5 py-1 rounded-lg text-xs shrink-0 mt-1">Câu ${idx + 1}</span>
                        <div class="text-gray-800 text-base leading-relaxed flex-1 math-content font-medium">${window.formatContent(q.content)}</div>
                    </div>
                    ${inputHtml}
                `;
                container.appendChild(qDiv);

                // Palette (Nút vuông nhỏ trong Grid)
                const btn = document.createElement('button');
                btn.id = `p-btn-${idx}`;
                btn.className = "h-8 w-full rounded-lg border border-gray-200 flex items-center justify-center font-bold text-xs text-gray-400 hover:bg-gray-50 transition-colors";
                btn.textContent = idx + 1;
                btn.onclick = () => { document.getElementById(`q-${idx}`).scrollIntoView({behavior: 'smooth', block: 'center'}); };
                palette.appendChild(btn);
            });

            if(window.MathJax) MathJax.typesetPromise();
            setTimeout(() => {
                if(window.renderTikz) window.renderTikz();
                if(window.autoScaleTables) window.autoScaleTables();
            }, 500);
        }

        // 6. LƯU ĐÁP ÁN & CẬP NHẬT UI
        window.saveAnswer = (qIdx, value, type) => {
            if (type === 'mc') {
                userAnswers[qIdx] = value;
                const qDiv = document.getElementById(`q-${qIdx}`);
                qDiv.querySelectorAll('label').forEach(lbl => {
                    const inp = lbl.querySelector('input');
                    if(inp.value == value) lbl.classList.add('bg-indigo-50', 'border-indigo-300', 'ring-1', 'ring-indigo-300');
                    else lbl.classList.remove('bg-indigo-50', 'border-indigo-300', 'ring-1', 'ring-indigo-300');
                });
            } else if (type === 'short') {
                userAnswers[qIdx] = value.toString().trim();
            } else if (type === 'tf') {
                if (!userAnswers[qIdx]) userAnswers[qIdx] = {};
                userAnswers[qIdx][value.sub] = value.val;
            }

            // Update Palette Style
            const btn = document.getElementById(`p-btn-${qIdx}`);
            btn.className = "h-8 w-full rounded-lg bg-blue-600 text-white border-blue-600 flex items-center justify-center font-bold text-xs transition-colors shadow-sm";
            
            // Update Progress Bar
            const total = practiceQuestions.length;
            const done = Object.keys(userAnswers).length;
            const pct = (done / total) * 100;
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${done}/${total}`;
        };

        // 7. TIMER ĐẾM NGƯỢC
        function startTimer(durationSeconds) {
            let remaining = durationSeconds;
            if(timerInterval) clearInterval(timerInterval);
            
            const display = document.getElementById('timerDisplay');
            
            timerInterval = setInterval(() => {
                const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                const s = (remaining % 60).toString().padStart(2, '0');
                display.textContent = `${m}:${s}`;
                
                if (remaining < 60) display.classList.replace('text-blue-600', 'text-red-600');
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    alert("Hết giờ làm bài!");
                    finishPractice();
                }
                remaining--;
            }, 1000);
        }

        // 8. KẾT THÚC & CHẤM ĐIỂM
        window.finishPractice = () => {
            clearInterval(timerInterval);
            let correctCount = 0;
            
            practiceQuestions.forEach((q, idx) => {
                const u = userAnswers[idx];
                if (q.type === 'mc') {
                    if (u == q.correct) correctCount++;
                } 
                else if (q.type === 'short') {
                    if (u && q.answer && u.toLowerCase() === q.answer.toString().toLowerCase()) correctCount++;
                }
                else if (q.type === 'tf') {
                    let isAllCorrect = true;
                    if (!u) isAllCorrect = false;
                    else {
                        q.statements.forEach((stmt, sIdx) => {
                            if (u[sIdx] !== stmt.isTrue) isAllCorrect = false;
                        });
                    }
                    if (isAllCorrect) correctCount++;
                }
            });

            const score = practiceQuestions.length > 0 ? (correctCount / practiceQuestions.length) * 10 : 0;
            document.getElementById('practiceStep').classList.add('hidden');
            document.getElementById('resultStep').classList.remove('hidden');
            
            document.getElementById('resScore').textContent = score.toFixed(1);
            document.getElementById('resCorrect').textContent = correctCount;
            document.getElementById('resWrong').textContent = practiceQuestions.length - correctCount;
        };

        window.viewSolutions = () => {
            document.getElementById('resultStep').classList.add('hidden');
            document.getElementById('practiceStep').classList.remove('hidden');
            document.querySelector('#practiceStep button[onclick="finishPractice()"]').classList.add('hidden');
            
            practiceQuestions.forEach((q, idx) => {
                const qDiv = document.getElementById(`q-${idx}`);
                const u = userAnswers[idx];
                let feedbackHtml = '';

                // --- MC Feedback ---
                if (q.type === 'mc') {
                    const isCorrect = (u == q.correct);
                    let correctChar = '?';
                    if(q.shuffleMap) {
                        const displayIdx = q.shuffleMap.indexOf(q.correct);
                        correctChar = String.fromCharCode(65 + displayIdx);
                    }
                    if(isCorrect) feedbackHtml = `<div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-xl text-green-700 font-bold text-xs"><i class="fa-solid fa-check mr-2"></i>Chính xác!</div>`;
                    else feedbackHtml = `<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 font-bold text-xs"><i class="fa-solid fa-xmark mr-2"></i>Sai rồi. Đáp án đúng: ${correctChar}</div>`;
                }
                // --- Short Feedback ---
                else if (q.type === 'short') {
                    const isCorrect = (u && q.answer && u.toLowerCase() === q.answer.toLowerCase());
                    if(isCorrect) feedbackHtml = `<div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-xl text-green-700 font-bold text-xs"><i class="fa-solid fa-check mr-2"></i>Chính xác!</div>`;
                    else feedbackHtml = `<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 font-bold text-xs"><i class="fa-solid fa-xmark mr-2"></i>Sai. Đáp án đúng: ${q.answer}</div>`;
                }
                // --- TF Feedback ---
                else if (q.type === 'tf') {
                    let tableHtml = `<div class="mt-3 border border-gray-200 rounded-lg overflow-hidden"><table class="w-full text-xs">`;
                    q.statements.forEach((stmt, sIdx) => {
                        const userChoice = u ? u[sIdx] : undefined;
                        const isTrue = stmt.isTrue;
                        let statusIcon = (userChoice === isTrue) ? '<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i></span>' : '<span class="text-red-500 font-bold"><i class="fa-solid fa-xmark"></i></span>';
                        let rowClass = (userChoice === isTrue) ? 'bg-green-50' : 'bg-red-50';
                        tableHtml += `<tr class="${rowClass} border-b border-white"><td class="p-2">Ý ${String.fromCharCode(97 + sIdx)}</td><td class="p-2">Đáp án: <b>${isTrue?'Đúng':'Sai'}</b></td><td class="p-2">Bạn chọn: <b>${userChoice===true?'Đúng':(userChoice===false?'Sai':'--')}</b></td><td class="p-2 text-right">${statusIcon}</td></tr>`;
                    });
                    tableHtml += `</table></div>`;
                    feedbackHtml = tableHtml;
                }

                if(q.solution) {
                    feedbackHtml += `<div class="mt-3 pt-3 border-t border-gray-100"><p class="font-bold text-blue-600 mb-2 text-xs uppercase"><i class="fa-solid fa-lightbulb mr-1"></i> Lời giải chi tiết</p><div class="text-gray-700 math-content text-sm bg-gray-50 p-3 rounded-lg">${window.formatContent(q.solution)}</div></div>`;
                }
                qDiv.insertAdjacentHTML('beforeend', feedbackHtml);
            });
            if(window.MathJax) MathJax.typesetPromise();
        };
        // --- LOGIC ẨN/HIỆN PALETTE ---
        window.togglePalette = () => {
            const el = document.getElementById('questionPalette');
            const icon = document.getElementById('paletteIcon');
            
            if (el.classList.contains('hidden')) {
                // Hiện lại
                el.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)'; // Xoay mũi tên xuống
            } else {
                // Ẩn đi
                el.classList.add('hidden');
                icon.style.transform = 'rotate(180deg)'; // Xoay mũi tên lên
            }
        };
    </script>
</body>
</html>
