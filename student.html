<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√≥c H·ªçc T·∫≠p - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#0F766E', // Xanh Teal
                        primary: '#0F766E',
                        accent: '#F97316' // Cam
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F0FDFA; }
        
        /* Sidebar Styles */
        .sidebar-item.active { background-color: #E6FFFA; color: #0F766E; font-weight: 800; border-right: 4px solid #0F766E; }
        .sidebar-item:hover:not(.active) { background-color: #F0FDFA; color: #0F766E; }
        
        /* Sidebar Mobile Transition */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-open { transform: translateX(0) !important; }
        .sidebar-closed { transform: translateX(-100%); }
        
        /* Falling Effect */
        #sidebar-container { position: relative; overflow: hidden; }
        .falling-item {
            position: absolute; top: -20px; pointer-events: none; user-select: none;
            animation: falling linear infinite; opacity: 0.4; z-index: 1; color: #0F766E;
        }
        @keyframes falling { to { transform: translateY(110vh) rotate(360deg); } }

        /* Utilities */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { backdrop-filter: blur(4px); }
        
        /* Toast */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification-toast { animation: slideIn 0.5s ease forwards; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans">

    <div id="mobileOverlay" onclick="toggleMobileSidebar()" class="fixed inset-0 bg-gray-900/60 z-[45] hidden transition-opacity md:hidden backdrop-blur-sm"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-teal-100 flex flex-col shadow-2xl z-[50] sidebar-closed md:translate-x-0 md:relative md:w-64 md:shadow-sm md:z-20">
        
        <div class="h-20 flex items-center justify-between px-6 border-b border-teal-100 relative z-10 bg-white/90 backdrop-blur-sm shrink-0">
            <div class="flex items-center gap-3" id="sidebarHeaderContent">
                <div class="w-10 h-10 bg-teal-100 rounded-lg animate-pulse"></div>
                <span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>
            </div>
            <button onclick="toggleMobileSidebar()" class="md:hidden text-gray-400 hover:text-red-500 transition-colors p-1">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>

        <nav class="flex-1 py-6 space-y-2 overflow-y-auto relative z-10 px-4" id="sidebar-container">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-home w-5"></i> S·∫£nh ch√≠nh
            </button>
            
            <button onclick="switchTab('classes')" id="nav-classes" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-chalkboard-user w-5"></i> L·ªõp h·ªçc c·ªßa t√¥i
            </button>

            <div class="px-4 pt-4 pb-2 text-[10px] font-black text-gray-400 uppercase tracking-wider">H·ªçc li·ªáu</div>

            <button onclick="switchTab('my-courses')" id="nav-my-courses" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-book-bookmark w-5"></i> Kh√≥a h·ªçc ƒë√£ mua
            </button>

            <button onclick="switchTab('market')" id="nav-market" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-store w-5"></i> ƒêƒÉng k√Ω kh√≥a m·ªõi
            </button>
        </nav>

        <div class="p-4 border-t border-teal-100 bg-teal-50/30 relative z-10 space-y-3 shrink-0">
            <div class="flex items-center gap-3 cursor-pointer group bg-white p-3 rounded-xl border border-teal-50 shadow-sm hover:border-teal-200 transition-all" onclick="openProfileModal()">
                <img id="userAvatar" src="https://via.placeholder.com/150" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p class="text-[10px] text-teal-600 font-bold uppercase flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> H·ªçc sinh
                    </p>
                </div>
                <i class="fa-solid fa-gear text-gray-300 group-hover:text-teal-600 transition-colors"></i>
            </div>

            <button onclick="handleLogout()" class="w-full py-2.5 bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 font-bold text-sm flex items-center justify-center gap-2 transition-all rounded-xl shadow-sm">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#F0FDFA] relative w-full">
        <header class="md:hidden h-16 bg-white border-b border-teal-100 px-4 flex items-center justify-between z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileSidebar()" class="text-gray-500 hover:text-teal-600 focus:outline-none p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fa-solid fa-bars text-2xl"></i>
                </button>
                <span class="font-black text-brand text-lg">G√≥c H·ªçc T·∫≠p</span>
            </div>
            
            <div onclick="openProfileModal()" class="w-9 h-9 rounded-full bg-gray-200 border border-white shadow-sm overflow-hidden active:scale-95 transition-transform">
                <img id="mobileHeaderAvatar" src="https://via.placeholder.com/100" class="w-full h-full object-cover">
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="mainScrollArea">
            
            <div id="tab-dashboard" class="tab-content space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-teal-600 to-blue-600 rounded-3xl p-8 md:p-12 text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-2xl md:text-4xl font-black mb-3 tracking-tight">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">...</span>! üëã</h1>
                        <p class="text-teal-100 mb-8 text-sm md:text-lg max-w-2xl leading-relaxed">H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ h·ªçc t·∫≠p. Ki·ªÉm tra ngay c√°c b√†i t·∫≠p ƒëang ch·ªù b·∫°n ph√≠a d∆∞·ªõi nh√©!</p>
                        <button onclick="switchTab('classes')" class="bg-white text-teal-700 px-6 md:px-8 py-3 rounded-full font-black hover:bg-teal-50 transition shadow-md text-sm md:text-base flex items-center gap-2 inline-flex">
                            <i class="fa-solid fa-arrow-down"></i> V√†o l·ªõp h·ªçc ngay
                        </button>
                    </div>
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-white/10 to-transparent skew-x-12 transform origin-top-right"></div>
                    <div class="absolute bottom-0 left-10 w-40 h-40 bg-teal-500/30 rounded-full blur-2xl"></div>
                </div>

                <div>
                    <h3 class="font-bold text-gray-800 text-xl mb-6 flex items-center gap-3">
                        <span class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-bell"></i></span>
                        <span id="pendingTitle">ƒêang ki·ªÉm tra b√†i t·∫≠p...</span>
                    </h3>
                    <div id="pendingTasksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full py-12 text-center bg-white rounded-2xl border border-dashed border-teal-200">
                            <i class="fa-solid fa-circle-notch fa-spin text-teal-500 text-3xl mb-4"></i>
                            <p class="text-gray-500 font-medium">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-classes" class="tab-content hidden animate-fade-in">
                <div class="mb-8"><h2 class="text-3xl font-black text-gray-800 mb-2">L·ªõp h·ªçc c·ªßa t√¥i</h2><p class="text-gray-500">Danh s√°ch c√°c l·ªõp b·∫°n ƒëang tham gia</p></div>
                <div id="myClassesList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>

            <div id="tab-class-detail" class="tab-content hidden animate-fade-in flex flex-col h-full">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 bg-white p-4 rounded-2xl shadow-sm border border-teal-50">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('classes')" class="w-12 h-12 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                        <div><h2 class="text-xl md:text-2xl font-black text-gray-800 leading-none mb-1" id="detailClassName">...</h2><p class="text-sm text-gray-500 font-medium">Danh s√°ch b√†i t·∫≠p</p></div>
                    </div>
                    <div><select onchange="renderClassExams(this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm font-bold rounded-xl focus:ring-teal-500 focus:border-teal-500 block w-full md:w-auto p-3 outline-none cursor-pointer"><option value="newest">‚ú® M·ªõi nh·∫•t tr∆∞·ªõc</option><option value="oldest">üìÖ C≈© nh·∫•t tr∆∞·ªõc</option></select></div>
                </div>
                <div id="classExamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20"></div>
            </div>

            <div id="tab-my-courses" class="tab-content hidden animate-fade-in">
                 <div class="mb-8"><h2 class="text-3xl font-black text-gray-800 mb-2">Kh√≥a h·ªçc ƒë√£ s·ªü h·ªØu</h2><p class="text-gray-500">C√°c kh√≥a h·ªçc b·∫°n ƒë√£ mua</p></div>
                <div id="myPurchasedList" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </div>

            <div id="tab-market" class="tab-content hidden animate-fade-in">
                 <div class="mb-8"><h2 class="text-3xl font-black text-gray-800 mb-2">C·ª≠a h√†ng kh√≥a h·ªçc</h2><p class="text-gray-500">Kh√°m ph√° ki·∫øn th·ª©c m·ªõi</p></div>
                <div id="marketList" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </main>

    <div id="profileModal" class="hidden fixed inset-0 z-[100] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in scale-95 transform transition-all duration-300 border-4 border-teal-50">
            <div class="px-6 py-5 border-b border-gray-100 bg-teal-50/50 flex justify-between items-center">
                <h3 class="text-xl font-black text-gray-800 flex items-center gap-3">
                    <span class="w-8 h-8 bg-teal-100 text-teal-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-id-badge"></i></span> Th√¥ng tin c√° nh√¢n
                </h3>
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
                <div>
                    <h4 class="text-xs font-black text-gray-400 uppercase mb-3 tracking-wider flex items-center gap-2"><i class="fa-solid fa-user-tag"></i> C∆° b·∫£n</h4>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">H·ªç v√† t√™n</label><input type="text" id="profName" class="w-full px-4 py-3 border border-gray-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-teal-200 outline-none"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">Ng√†y sinh</label><input type="date" id="profDob" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400"></div>
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">Gi·ªõi t√≠nh</label><select id="profGender" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400 bg-white"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option><option value="Kh√°c">Kh√°c</option></select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">SƒêT C√° nh√¢n</label><input type="tel" id="profPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400"></div>
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">SƒêT Ph·ª• huynh</label><input type="tel" id="profParentPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-red-50/50 p-5 rounded-2xl border border-red-100">
                    <h4 class="text-xs font-black text-red-600 uppercase mb-3 tracking-wider flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> B·∫£o m·∫≠t</h4>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">T√™n ƒëƒÉng nh·∫≠p (C·ªë ƒë·ªãnh)</label><input type="text" id="profUsername" disabled class="w-full px-4 py-3 bg-red-50 border border-red-100 rounded-xl text-gray-500 font-mono text-sm font-bold cursor-not-allowed"></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">ƒê·ªïi m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="profPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (n·∫øu mu·ªën ƒë·ªïi)..." class="w-full px-4 py-3 border border-red-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-red-200 text-sm font-medium">
                            <p class="text-[10px] text-red-400 mt-2 flex items-center gap-1 font-medium"><i class="fa-solid fa-circle-info"></i> ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="px-6 py-3 bg-white border-2 border-gray-200 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-100">H·ªßy b·ªè</button>
                <button onclick="saveProfile()" class="px-8 py-3 bg-brand text-white rounded-xl font-bold text-sm shadow-lg hover:bg-teal-700 flex items-center gap-2"><i class="fa-solid fa-check"></i> L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="paymentModalContainer"></div>

    <div id="notificationContainer" class="fixed top-5 right-5 z-[120] flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        // T√åM D√íNG N√ÄY V√Ä THAY TH·∫æ (Th√™m orderBy)
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, addDoc, limit, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";;

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = ["phamngockhanh.942001@gmail.com", "phamngockhanh.942002@gmail.com", "admin@gmail.com", "phamdinhquang0911@gmail.com"];
        
        // --- DANH S√ÅCH M√É BIN NG√ÇN H√ÄNG (VIETQR) ---
        // D√πng ƒë·ªÉ t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi t√™n ng√¢n h√†ng th√†nh m√£ BIN
        const BANK_BIN_MAP = {
            'MB': '970422', 'MBBANK': '970422', 'QUAN DOI': '970422',
            'VCB': '970436', 'VIETCOMBANK': '970436',
            'ACB': '970416', 'A CHAU': '970416',
            'BIDV': '970418',
            'ICB': '970415', 'VIETINBANK': '970415',
            'TCB': '970407', 'TECHCOMBANK': '970407',
            'VPB': '970432', 'VPBANK': '970432',
            'TPB': '970423', 'TPBANK': '970423',
            'STB': '970403', 'SACOMBANK': '970403',
            'VIB': '970441',
            'MSB': '970426', 'MARITIME': '970426',
            'HDB': '970437', 'HDBANK': '970437',
            'OCB': '970448',
            'SHB': '970443',
            'TIMO': '963388',
            'LPB': '970449', 'LIENVIET': '970449',
            'SEAB': '970440', 'SEABANK': '970440',
            'VCCB': '970454', 'VIETCAPITAL': '970454',
            'EIB': '970431', 'EXIMBANK': '970431',
            'NAB': '970428', 'NAM A': '970428'
        };

        function getBankBin(bankCode) {
            if(!bankCode) return '970422'; // Default MB
            const code = bankCode.toUpperCase().trim();
            // N·∫øu ƒë√£ l√† s·ªë BIN th√¨ tr·∫£ v·ªÅ lu√¥n
            if (/^\d+$/.test(code) && code.length >= 6) return code;
            // T√¨m trong map
            return BANK_BIN_MAP[code] || '970422';
        }

        let currentClassExams = [];
        let studentResultsMap = {};

        // --- H·ªÜ TH·ªêNG TH√îNG B√ÅO TOAST ---
        window.showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            const color = type === 'success' ? 'green' : 'red';
            div.className = `notification-toast pointer-events-auto bg-white border-l-4 border-${color}-500 shadow-xl rounded-lg p-4 w-80 flex items-start gap-3 z-[200]`;
            div.innerHTML = `<i class="fa-solid fa-${type==='success'?'check':'circle-exclamation'} text-${color}-500 mt-1"></i><div><h4 class="font-bold text-gray-800 text-sm">${type==='success'?'Th√†nh c√¥ng':'L·ªói'}</h4><p class="text-sm text-gray-600 leading-tight">${msg}</p></div>`;
            container.appendChild(div);
            setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 500); }, 3000);
        }

        // --- 1. GIAO DI·ªÜN & AUTH ---
        (function applySidebarEffect() {
            const sidebar = document.getElementById('sidebar-container'); if(!sidebar) return;
            const today = new Date(); const m = today.getMonth() + 1;
            const items = m === 1 || m === 2 ? "üå∏" : (m === 11 ? "üíê" : (m === 12 ? "‚ùÑÔ∏è" : "üçÇ"));
            for(let i=0; i<8; i++){
                const el = document.createElement('div'); el.classList.add('falling-item'); el.innerHTML = items;
                el.style.left = Math.random() * 80 + '%'; el.style.fontSize = (Math.random() * 10 + 10) + 'px';
                el.style.animationDuration = (Math.random() * 5 + 5) + 's'; el.style.animationDelay = (Math.random() * 5) + 's';
                sidebar.appendChild(el);
            }
        })();

        async function loadSiteLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    const logoUrl = docSnap.data().logo;
                    const headerContent = document.getElementById('sidebarHeaderContent');
                    if(headerContent) headerContent.innerHTML = `<img src="${logoUrl}" class="w-10 h-10 object-contain drop-shadow-sm"><span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>`;
                }
            } catch (e) { console.warn("L·ªói t·∫£i Logo:", e); }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (ADMIN_EMAILS.includes(user.email)) { window.location.href = "dashboard.html"; return; }
                loadSiteLogo();
                loadUserProfile(user);
                loadStudentClasses(user);
                loadMarket();
                loadMyPurchased(user);
                loadPendingTasks(user); 
            } else { window.location.href = "index.html"; }
        });

        // --- 2. PROFILE LOGIC (ƒê√É S·ª¨A: KH√îNG ƒêƒÇNG XU·∫§T) ---
        async function loadUserProfile(user) {
            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                const data = snap.exists() ? snap.data() : {};
                const name = data.displayName || user.displayName || "B·∫°n";
                document.getElementById('userName').innerText = name;
                document.getElementById('welcomeName').innerText = name;
                document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=0F766E&color=fff`;
                if(document.getElementById('mobileHeaderAvatar')) document.getElementById('mobileHeaderAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=0F766E&color=fff`;

                document.getElementById('profName').value = name;
                let rawUsername = data.username || user.email.split('@')[0];
                if (rawUsername.includes('@')) rawUsername = rawUsername.split('@')[0];
                document.getElementById('profUsername').value = rawUsername;
                document.getElementById('profDob').value = data.birthDate || "";
                document.getElementById('profGender').value = data.gender || "Nam";
                document.getElementById('profPhone').value = data.phone || "";
                document.getElementById('profParentPhone').value = data.phoneParent || "";
            } catch(e) { console.error(e); }
        }

        window.saveProfile = async () => {
            const user = auth.currentUser;
            const name = document.getElementById('profName').value;
            const pass = document.getElementById('profPass').value;
            const btn = document.querySelector('#profileModal button[onclick="saveProfile()"]');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...'; btn.disabled = true;

            try {
                const updates = {
                    displayName: name,
                    birthDate: document.getElementById('profDob').value,
                    gender: document.getElementById('profGender').value,
                    phone: document.getElementById('profPhone').value,
                    phoneParent: document.getElementById('profParentPhone').value
                };
                await updateDoc(doc(db, "users", user.uid), updates);
                await updateProfile(user, { displayName: name });
                
                if(pass && pass.length > 0) {
                    await updatePassword(user, pass);
                    // KH√îNG ƒêƒÇNG XU·∫§T
                    window.showNotification("C·∫≠p nh·∫≠t m·∫≠t kh·∫©u th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng.", "success");
                    document.getElementById('profPass').value = ""; 
                } else {
                    window.showNotification("ƒê√£ l∆∞u th√¥ng tin c√° nh√¢n!", "success");
                }
                
                document.getElementById('userName').innerText = name;
                document.getElementById('profileModal').classList.add('hidden');
            } catch(e) { 
                window.showNotification("L·ªói: " + e.message, "error"); 
                if(e.code === 'auth/requires-recent-login') window.showNotification("Vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u!", "error");
            } finally { btn.innerHTML = '<i class="fa-solid fa-check"></i> L∆∞u thay ƒë·ªïi'; btn.disabled = false; }
        }

        // --- 3. B√ÄI T·∫¨P C·∫¶N L√ÄM ---
        async function loadPendingTasks(user) {
            const container = document.getElementById('pendingTasksList');
            const titleEl = document.getElementById('pendingTitle');
            if(!container) return;

            try {
                const qClasses = query(collection(db, "classes"));
                const snapClasses = await getDocs(qClasses);
                const myClassIds = [];
                snapClasses.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    if (students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid))) {
                        myClassIds.push(doc.id);
                    }
                });

                if (myClassIds.length === 0) { 
                    titleEl.innerText = "Em c√≥ 0 b√†i t·∫≠p c·∫ßn ho√†n th√†nh";
                    container.innerHTML = '<div class="col-span-full py-8 text-center bg-white rounded-2xl border border-dashed border-teal-200"><p class="text-gray-500 font-medium">B·∫°n ch∆∞a tham gia l·ªõp n√†o.</p></div>'; 
                    return; 
                }

                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                const submittedExamIds = new Set();
                snapResults.forEach(d => submittedExamIds.add(d.data().examId));

                let pendingExams = [];
                for (const cid of myClassIds) {
                    const qEx = query(collection(db, "exams"), 
                        where("allowedClassId", "==", cid), 
                        where("status", "==", "published"),
                        limit(10)
                    );
                    const snapEx = await getDocs(qEx);
                    snapEx.forEach(d => {
                        if (!submittedExamIds.has(d.id)) {
                            pendingExams.push({id:d.id, ...d.data()});
                        }
                    });
                }
                
                pendingExams.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                titleEl.innerHTML = `Em c√≥ <span class="text-red-500 font-black text-2xl mx-1">${pendingExams.length}</span> b√†i t·∫≠p c·∫ßn ho√†n th√†nh`;

                if (pendingExams.length === 0) { 
                    container.innerHTML = '<div class="col-span-full py-8 text-center bg-white rounded-2xl border border-dashed border-teal-200 shadow-sm"><i class="fa-solid fa-circle-check text-teal-500 text-4xl mb-3"></i><p class="text-gray-800 font-bold mb-1">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh h·∫øt b√†i t·∫≠p.</p></div>'; 
                    return; 
                }

                let html = '';
                pendingExams.forEach(ex => {
                    html += `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-teal-50 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all hover:border-teal-200 group" onclick="window.location.href='exam.html?id=${ex.id}'">
                            <div class="w-14 h-14 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center font-bold shrink-0 relative">
                                <i class="fa-solid fa-file-pen text-xl"></i>
                                <span class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full animate-pulse"></span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                     <span class="text-[10px] font-black text-gray-400 uppercase tracking-wider">B√†i t·∫≠p m·ªõi</span>
                                     <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full">Ch∆∞a l√†m</span>
                                </div>
                                <h4 class="font-bold text-gray-800 text-base line-clamp-1 group-hover:text-brand transition-colors">${ex.title}</h4>
                                <p class="text-xs text-gray-500 font-medium mt-1 flex items-center gap-3">
                                    <span><i class="fa-regular fa-clock text-teal-500"></i> ${ex.duration}p</span>
                                    <span><i class="fa-solid fa-list-ol text-teal-500"></i> ${ex.questionCount||0} c√¢u</span>
                                </p>
                            </div>
                            <button class="text-sm bg-brand text-white w-10 h-10 rounded-full font-bold flex items-center justify-center hover:bg-teal-700 transition-all hover:scale-110 shadow-sm">
                                <i class="fa-solid fa-play ml-0.5"></i>
                            </button>
                        </div>
                    `;
                });
                container.innerHTML = html;

            } catch(e) { console.error(e); container.innerHTML = '<p class="text-red-400 text-sm text-center col-span-full">L·ªói k·∫øt n·ªëi. Vui l√≤ng t·∫£i l·∫°i.</p>'; }
        }

        // --- C√ÅC H√ÄM H·ªñ TR·ª¢ KH√ÅC ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(`tab-${tabId}`); if(target) target.classList.remove('hidden');
            const nav = document.getElementById(`nav-${tabId}`); if(nav) nav.classList.add('active');
            document.getElementById('mainScrollArea').scrollTop = 0;
            // Mobile close
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.add('sidebar-closed'); sidebar.classList.remove('sidebar-open');
            overlay.classList.add('hidden');
        }
        window.toggleMobileSidebar = () => {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('mobileOverlay');
            if(sb.classList.contains('sidebar-closed')) { 
                sb.classList.remove('sidebar-closed'); sb.classList.add('sidebar-open'); ov.classList.remove('hidden'); 
            } else { 
                sb.classList.add('sidebar-closed'); sb.classList.remove('sidebar-open'); ov.classList.add('hidden'); 
            }
        }
        window.openProfileModal = () => document.getElementById('profileModal').classList.remove('hidden');
        window.handleLogout = () => signOut(auth).then(() => window.location.href = "index.html");

        async function loadStudentClasses(user) {
            const container = document.getElementById('myClassesList');
            try {
                const q = query(collection(db, "classes"));
                const snap = await getDocs(q);
                let html = '';
                snap.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    if (students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid))) {
                        html += `<div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50 hover:border-teal-300 hover:shadow-md transition-all cursor-pointer group" onclick="openClassDetail('${doc.id}', '${cl.name}')"><div class="flex justify-between mb-4"><div class="w-10 h-10 rounded-xl bg-teal-100 text-teal-600 flex items-center justify-center font-bold"><i class="fa-solid fa-chalkboard"></i></div><i class="fa-solid fa-arrow-right text-gray-300 group-hover:text-teal-500 transition-colors"></i></div><h3 class="font-bold text-xl text-gray-800 mb-1 group-hover:text-teal-700 transition-colors truncate">${cl.name}</h3><p class="text-sm text-gray-500 font-medium mb-4"><i class="fa-solid fa-user-tie mr-1 text-teal-500"></i> GV: ${cl.teacherName || "Th·∫ßy Choang"}</p><div class="w-full py-2.5 bg-teal-50 text-teal-700 font-bold text-sm rounded-xl text-center group-hover:bg-teal-600 group-hover:text-white transition-all">V√†o l·ªõp h·ªçc</div></div>`;
                    }
                });
                container.innerHTML = html || '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><p class="text-gray-500 font-bold">B·∫°n ch∆∞a tham gia l·ªõp n√†o.</p></div>';
            } catch(e) { console.error(e); }
        }

        window.openClassDetail = async (classId, className) => {
            window.switchTab('class-detail');
            document.getElementById('detailClassName').textContent = className;
            const container = document.getElementById('classExamList');
            container.innerHTML = '<div class="col-span-full text-center py-16"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-teal-500"></i></div>';
            try {
                const user = auth.currentUser;
                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                studentResultsMap = {};
                snapResults.forEach(d => { const r = d.data(); if (!studentResultsMap[r.examId] || r.score > studentResultsMap[r.examId].score) studentResultsMap[r.examId] = r; });
                const qExams = query(collection(db, "exams"), where("accessType", "==", "class"), where("allowedClassId", "==", classId), where("status", "==", "published"));
                const snapExams = await getDocs(qExams);
                currentClassExams = []; snapExams.forEach(d => currentClassExams.push({ id: d.id, ...d.data() }));
                renderClassExams('newest');
            } catch (e) { console.error(e); container.innerHTML = '<p class="col-span-full text-red-500 text-center">L·ªói t·∫£i d·ªØ li·ªáu.</p>'; }
        };

        window.renderClassExams = (sortType) => {
            const container = document.getElementById('classExamList');
            if(currentClassExams.length === 0) { container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</div>'; return; }
            currentClassExams.sort((a, b) => { const dA = new Date(a.createdAt||0); const dB = new Date(b.createdAt||0); return sortType === 'newest' ? dB - dA : dA - dB; });
            let html = '';
            currentClassExams.forEach(exam => {
                const result = studentResultsMap[exam.id]; const isDone = !!result;
                let statusBadge = `<span class="text-[10px] font-black bg-gray-100 text-gray-500 px-2.5 py-1 rounded-full uppercase tracking-wider">Ch∆∞a l√†m</span>`;
                let actionBtn = `<button onclick="window.location.href='exam.html?id=${exam.id}'" class="w-full py-3 bg-brand text-white font-bold rounded-xl shadow-sm hover:bg-teal-700 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>`;
                let scoreInfo = '';
                if (isDone) {
                    const score = result.score;
                    let badgeColor = score >= 9 ? 'bg-yellow-100 text-yellow-700' : (score >= 8 ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700');
                    statusBadge = `<span class="text-[10px] font-black ${badgeColor} px-2.5 py-1 rounded-full uppercase tracking-wider shadow-sm">${score} ƒëi·ªÉm</span>`;
                    actionBtn = `<div class="flex gap-3"><button onclick="window.location.href='exam.html?id=${exam.id}'" class="flex-1 py-3 bg-white border-2 border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 text-sm">L√†m l·∫°i</button><button onclick="window.location.href='exam.html?id=${exam.id}&mode=review'" class="flex-1 py-3 bg-teal-100 text-teal-700 font-bold rounded-xl hover:bg-teal-200 text-sm">Xem l·ªùi gi·∫£i</button></div>`;
                    scoreInfo = `<div class="mt-3 pt-3 border-t border-dashed border-gray-100 flex justify-between items-center text-xs text-gray-500 font-medium"><span>Cao nh·∫•t:</span> <span class="text-gray-800 font-black text-base">${score}ƒë</span></div>`;
                }
                html += `<div class="bg-white p-5 rounded-2xl shadow-sm border border-teal-50 hover:shadow-md transition-all flex flex-col justify-between h-full relative group hover:border-teal-200"><div><div class="flex justify-between items-center mb-3"><div class="flex items-center gap-2"><span class="w-8 h-8 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center"><i class="fa-regular fa-file-lines"></i></span><span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${exam.id.substring(0,6)}</span></div>${statusBadge}</div><h4 class="font-bold text-gray-800 text-lg mb-2 line-clamp-2 group-hover:text-brand transition-colors" title="${exam.title}">${exam.title}</h4><div class="flex items-center gap-4 text-xs text-gray-500 font-medium"><span class="flex items-center gap-1"><i class="fa-regular fa-clock text-teal-500"></i> ${exam.duration} ph√∫t</span><span class="flex items-center gap-1"><i class="fa-solid fa-list-ol text-teal-500"></i> ${exam.questionCount||0} c√¢u</span></div>${scoreInfo}</div><div class="mt-5">${actionBtn}</div></div>`;
            });
            container.innerHTML = html;
        };

        async function loadMarket() { const c = document.getElementById('marketList'); const s = await getDocs(collection(db, "public_courses")); let h = ''; s.forEach(d=>{const x=d.data(); h+=`<div class="bg-white rounded-2xl shadow-sm border border-teal-50 hover:shadow-lg transition-all group"><div class="h-36 bg-gray-100 relative overflow-hidden"><img src="${x.thumbnail||'https://via.placeholder.com/300'}" class="h-full w-full object-cover group-hover:scale-110 transition-transform"><span class="absolute top-3 left-3 bg-accent text-white text-xs font-black px-2 py-1 rounded shadow">${x.tag||'M·ªõi'}</span></div><div class="p-5"><h4 class="font-bold text-gray-800 mb-2 line-clamp-1">${x.title}</h4><div class="flex justify-between items-center pt-2 border-t border-dashed border-gray-100"><span class="text-accent font-black">${parseInt(x.price).toLocaleString()}ƒë</span><button onclick="openPaymentModal('${d.id}')" class="bg-brand text-white text-xs px-3 py-1.5 rounded-lg font-bold">Mua ngay</button></div></div></div>`}); c.innerHTML=h||'<p class="col-span-full text-center text-gray-400">Ch∆∞a c√≥ kh√≥a h·ªçc.</p>'; }
        async function loadMyPurchased(u) { const c=document.getElementById('myPurchasedList'); const q=query(collection(db,"orders"),where("userId","==",u.uid),where("status","==","approved")); const s=await getDocs(q); let h=''; s.forEach(d=>{const o=d.data(); h+=`<div class="bg-white p-5 rounded-2xl border border-teal-50 shadow-sm hover:border-teal-300 transition-all"><div class="flex gap-3 mb-3"><div class="w-10 h-10 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center font-bold"><i class="fa-solid fa-graduation-cap"></i></div><h4 class="font-bold text-gray-800 text-sm line-clamp-2 flex-1">${o.courseTitle}</h4></div><button class="w-full py-2 bg-brand text-white text-xs font-bold rounded-lg">V√†o h·ªçc ngay</button></div>`}); c.innerHTML=h||'<div class="col-span-full text-center py-8 bg-white rounded-2xl border border-dashed"><p class="text-gray-500 font-bold">Ch∆∞a mua kh√≥a h·ªçc n√†o.</p></div>'; }
        
        // --- 8. PAYMENT LOGIC (CHUY√äN NGHI·ªÜP & FIX L·ªñI QR) ---
        // Thi·∫øt k·∫ø m·ªõi: 2 c·ªôt, r·ªông r√£i
        const paymentModalHTML = `
            <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-300">
                <div class="bg-white w-full max-w-5xl rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh]">
                    <div class="w-full md:w-5/12 bg-gray-50 p-8 border-r border-gray-200 flex flex-col">
                        <h3 class="font-black text-gray-800 text-xl mb-6 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-receipt text-brand"></i> Chi ti·∫øt ƒë∆°n h√†ng</h3>
                        
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-6">
                            <div class="flex items-start gap-4 mb-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg shrink-0 overflow-hidden"><img id="payCourseImg" class="w-full h-full object-cover"></div>
                                <div>
                                    <span class="text-[10px] font-bold bg-teal-100 text-teal-700 px-2 py-0.5 rounded uppercase">Kh√≥a h·ªçc</span>
                                    <h4 id="payCourseTitle" class="font-bold text-gray-800 line-clamp-2 mt-1">...</h4>
                                </div>
                            </div>
                            <div class="border-t border-dashed border-gray-200 my-3"></div>
                            <div class="flex justify-between items-center text-lg font-black text-orange-600">
                                <span>T·ªïng thanh to√°n</span>
                                <span id="payFinalPrice">...</span>
                            </div>
                        </div>

                        <div class="space-y-3 text-sm text-gray-600">
                            <div class="flex justify-between p-3 bg-white rounded-lg border border-gray-200"><span>Kh√°ch h√†ng</span><span id="payUserName" class="font-bold">...</span></div>
                        </div>
                    </div>

                    <div class="w-full md:w-7/12 p-8 relative flex flex-col items-center bg-white justify-center">
                        <button onclick="document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none')" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-gray-100 hover:bg-red-50 text-gray-400 hover:text-red-500 flex items-center justify-center transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                        
                        <div class="text-center mb-6">
                            <h3 class="font-black text-2xl text-teal-700 mb-1">Qu√©t m√£ VietQR</h3>
                            <p class="text-gray-500 text-sm">T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin chuy·ªÉn kho·∫£n</p>
                        </div>

                        <div class="relative w-72 h-72 bg-white p-4 rounded-3xl shadow-xl border-4 border-teal-50 mb-6 group">
                            <img id="vietQrImage" class="w-full h-full object-contain rounded-xl">
                            <div id="qrLoading" class="absolute inset-0 bg-white flex flex-col items-center justify-center rounded-xl z-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-teal-500 mb-3"></i><span class="text-xs font-bold text-teal-600 animate-pulse">ƒêang t·∫°o m√£ QR...</span></div>
                        </div>

                        <div class="w-full max-w-sm bg-blue-50/50 p-4 rounded-xl border border-blue-100 text-sm space-y-2 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Ng√¢n h√†ng</span>
                                <b class="text-blue-700" id="bankNameDisplay">...</b>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">S·ªë t√†i kho·∫£n</span>
                                <b class="text-blue-700 font-mono text-lg" id="accountNoDisplay">...</b>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-blue-200/50">
                                <span class="text-gray-500">N·ªôi dung</span>
                                <b class="text-orange-600 font-mono" id="transferContentDisplay">...</b>
                            </div>
                        </div>

                        <button onclick="confirmPayment()" class="w-full max-w-sm py-4 bg-gradient-to-r from-teal-600 to-teal-500 text-white font-bold rounded-xl shadow-lg hover:shadow-teal-200 hover:-translate-y-0.5 transition-all text-base flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check-circle text-lg"></i> X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('paymentModalContainer').innerHTML = paymentModalHTML;

        let currentPayingCourse = null;
        let dynamicBankConfig = null;

        // --- [STUDENT] C·∫¨P NH·∫¨T LOGIC T·∫†O M√É QR THANH TO√ÅN ---

window.openPaymentModal = async (courseId) => {
    if (!auth.currentUser) {
         // Logic hi·ªÉn th·ªã th√¥ng b√°o ƒëƒÉng nh·∫≠p...
         alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); 
         return;
    }
    
    // T·∫£i c·∫•u h√¨nh ng√¢n h√†ng (C·∫≠p nh·∫≠t l·∫•y th√™m BANK_NAME)
    if (!dynamicBankConfig) {
        try {
            const s = await getDoc(doc(db, "site_settings", "payment_config"));
            // Fallback n·∫øu ch∆∞a c·∫•u h√¨nh
            dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "970454", BANK_NAME: "Timo", ACCOUNT_NO: "0337820847", ACCOUNT_NAME: "PHAM DINH QUANG", TEMPLATE: "compact2" };
        } catch (e) { dynamicBankConfig = { BANK_ID: "970422", BANK_NAME: "L·ªói T·∫£i", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ERR", TEMPLATE: "compact2" }; }
    }

    document.getElementById('paymentModal').classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('qrLoading').classList.remove('hidden');

    try {
        const snap = await getDoc(doc(db, "public_courses", courseId));
        if(snap.exists()){
            const c = snap.data();
            currentPayingCourse = { id: snap.id, ...c };
            const user = auth.currentUser;
            
            // 1. Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n
            document.getElementById('payCourseTitle').innerText = c.title;
            document.getElementById('payCourseImg').src = c.thumbnail || 'https://via.placeholder.com/150';
            
            // X·ª≠ l√Ω hi·ªÉn th·ªã gi√° (Format VND)
            let rawPrice = c.price;
            // Chuy·ªÉn ƒë·ªïi gi√° v·ªÅ s·ªë nguy√™n s·∫°ch (lo·∫°i b·ªè d·∫•u ch·∫•m, ph·∫©y, ch·ªØ ƒë)
            if (typeof rawPrice === 'string') {
                rawPrice = parseInt(rawPrice.replace(/\D/g, '')) || 0;
            }
            
            document.getElementById('payFinalPrice').innerText = rawPrice.toLocaleString('vi-VN') + 'ƒë';
            document.getElementById('payUserName').innerText = user.displayName;

            // 2. T·∫°o n·ªôi dung chuy·ªÉn kho·∫£n (Content)
            // C√∫ ph√°p: TTOAN <UID_NGAN> <COURSE_ID_NGAN>
            // Lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói URL
            const cleanUid = user.uid.substring(0,5).replace(/[^a-zA-Z0-9]/g, "");
            const cleanCourseId = c.id.substring(0,5).toUpperCase().replace(/[^a-zA-Z0-9]/g, "");
            const content = `TTOAN ${cleanUid} ${cleanCourseId}`;
            
            // 3. ƒêi·ªÅn th√¥ng tin ng√¢n h√†ng l√™n giao di·ªán
            // ∆Øu ti√™n hi·ªÉn th·ªã T√™n ng√¢n h√†ng (MB Bank) thay v√¨ m√£ BIN (970422)
            document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_NAME || dynamicBankConfig.BANK_ID;
            document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
            document.getElementById('transferContentDisplay').innerText = content;
            
            // 4. T·∫†O URL QR CODE VIETQR (FIX QUAN TR·ªåNG)
            // C·∫•u tr√∫c: https://img.vietqr.io/image/<BANK_ID>-<ACCOUNT_NO>-<TEMPLATE>.png?amount=<AMOUNT>&addInfo=<CONTENT>&accountName=<NAME>
            
            const bankId = dynamicBankConfig.BANK_ID;       // M√£ BIN (VD: 970422)
            const accNo = dynamicBankConfig.ACCOUNT_NO;     // S·ªë TK
            const template = dynamicBankConfig.TEMPLATE;    // Template (compact2)
            const amount = rawPrice;                        // S·ªë ti·ªÅn (Integer)
            const addInfo = encodeURIComponent(content);    // N·ªôi dung (URL Encoded)
            const accName = encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME); // T√™n ch·ªß TK (URL Encoded)

            const qrUrl = `https://img.vietqr.io/image/${bankId}-${accNo}-${template}.png?amount=${amount}&addInfo=${addInfo}&accountName=${accName}`;
            
            // Debug link ƒë·ªÉ ki·ªÉm tra
            console.log("Generated QR Link:", qrUrl);

            const qrImg = document.getElementById('vietQrImage');
            qrImg.onload = () => document.getElementById('qrLoading').classList.add('hidden');
            qrImg.onerror = () => {
                document.getElementById('qrLoading').innerHTML = '<span class="text-red-500 font-bold">L·ªói t·∫°o m√£ QR</span>';
            };
            qrImg.src = qrUrl;
        }
    } catch(e){ console.error(e); }
};

        window.confirmPayment = async () => {
             const btn = document.querySelector('button[onclick="confirmPayment()"]');
             btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...'; btn.disabled = true;
             try {
                await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid,
                    courseId: currentPayingCourse.id,
                    courseTitle: currentPayingCourse.title,
                    amount: parseInt(currentPayingCourse.price),
                    status: 'pending',
                    content: document.getElementById('transferContentDisplay').innerText,
                    createdAt: new Date().toISOString()
                });
                window.showNotification("ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng! Vui l√≤ng ch·ªù duy·ªát.", "success");
                document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none');
             } catch(e) { window.showNotification("L·ªói: " + e.message, "error"); }
             finally { btn.innerHTML = '<i class="fa-solid fa-check-circle text-lg"></i> X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N'; btn.disabled = false; }
        };
    </script>
</body>
</html>
