<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√≥c H·ªçc T·∫≠p - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: '#0F766E', primary: '#0F766E', accent: '#F97316' },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F0FDFA; }
        .sidebar-item.active { background-color: #E6FFFA; color: #0F766E; font-weight: 800; border-right: 4px solid #0F766E; }
        .sidebar-item:hover:not(.active) { background-color: #F0FDFA; color: #0F766E; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-open { transform: translateX(0) !important; }
        .sidebar-closed { transform: translateX(-100%); }
        
        /* HI·ªÜU ·ª®NG R∆†I (FALLING) */
        #sidebar-container { position: relative; overflow: hidden; }
        .falling-item { position: absolute; top: -30px; pointer-events: none; user-select: none; animation: falling linear infinite; opacity: 0.6; z-index: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        @keyframes falling { to { transform: translateY(110vh) rotate(360deg); } }

        /* TRANG TR√ç NOEL */
        .santa-hat { position: absolute; top: -12px; left: -8px; font-size: 24px; transform: rotate(-15deg); filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1)); animation: hat-bounce 2s infinite; }
        @keyframes hat-bounce { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(-5deg) translateY(-2px); } }
        
        /* C√ÇY TH√îNG NOEL */
        .xmas-tree-decor { position: absolute; bottom: 80px; right: 10px; font-size: 60px; opacity: 0.15; pointer-events: none; filter: blur(1px); animation: tree-glow 3s infinite alternate; }
        @keyframes tree-glow { from { filter: drop-shadow(0 0 5px green); } to { filter: drop-shadow(0 0 15px gold); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { backdrop-filter: blur(4px); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification-toast { animation: slideIn 0.5s ease forwards; }
        .dashed-loader { border: 3px dashed #CBD5E1; border-top-color: #0F766E; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans">

    <div id="mobileOverlay" onclick="toggleMobileSidebar()" class="fixed inset-0 bg-gray-900/60 z-[45] hidden transition-opacity md:hidden backdrop-blur-sm"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-teal-100 flex flex-col shadow-2xl z-[50] sidebar-closed md:translate-x-0 md:relative md:w-64 md:shadow-sm md:z-20">
        <div class="h-20 flex items-center justify-between px-6 border-b border-teal-100 relative z-10 bg-white/90 backdrop-blur-sm shrink-0">
            <div class="flex items-center gap-3 relative" id="sidebarHeaderContent">
                <div class="w-10 h-10 bg-teal-100 rounded-lg animate-pulse"></div>
                <span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>
                <div id="logoDecor"></div>
            </div>
            <button onclick="toggleMobileSidebar()" class="md:hidden text-gray-400 hover:text-red-500 transition-colors p-1"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>
        
        <nav class="flex-1 py-6 space-y-2 overflow-y-auto relative z-10 px-4" id="sidebar-container">
            <div id="sidebarDecorTree"></div>

            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl"><i class="fa-solid fa-home w-5"></i> S·∫£nh ch√≠nh</button>
            <button onclick="switchTab('classes')" id="nav-classes" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl"><i class="fa-solid fa-chalkboard-user w-5"></i> L·ªõp h·ªçc c·ªßa t√¥i</button>
            <button onclick="switchTab('history')" id="nav-history" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
            <i class="fa-solid fa-clock-rotate-left w-5"></i> L·ªãch s·ª≠ l√†m b√†i
            </button>
            <div class="px-4 pt-4 pb-2 text-[10px] font-black text-gray-400 uppercase tracking-wider">H·ªçc li·ªáu</div>
            <button onclick="switchTab('my-courses')" id="nav-my-courses" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl"><i class="fa-solid fa-book-bookmark w-5"></i> Kh√≥a h·ªçc ƒë√£ mua</button>
            <button onclick="switchTab('market')" id="nav-market" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl"><i class="fa-solid fa-store w-5"></i> ƒêƒÉng k√Ω kh√≥a m·ªõi</button>
        </nav>
        
        <div class="p-4 border-t border-teal-100 bg-teal-50/30 relative z-10 space-y-3 shrink-0">
            <div class="flex items-center gap-3 cursor-pointer group bg-white p-3 rounded-xl border border-teal-50 shadow-sm hover:border-teal-200 transition-all" onclick="openProfileModal()">
                <img id="userAvatar" src="https://placehold.co/150" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p class="text-[10px] text-teal-600 font-bold uppercase flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> H·ªçc sinh</p>
                </div>
                <i class="fa-solid fa-gear text-gray-300 group-hover:text-teal-600 transition-colors"></i>
            </div>
            <button onclick="handleLogout()" class="w-full py-2.5 bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 font-bold text-sm flex items-center justify-center gap-2 transition-all rounded-xl shadow-sm"><i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#F0FDFA] relative w-full">
        <header class="md:hidden h-16 bg-white border-b border-teal-100 px-4 flex items-center justify-between z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileSidebar()" class="text-gray-500 hover:text-teal-600 focus:outline-none p-2 rounded-lg hover:bg-gray-100 transition-colors"><i class="fa-solid fa-bars text-2xl"></i></button>
                <span class="font-black text-brand text-lg">G√≥c H·ªçc T·∫≠p</span>
            </div>
            <div onclick="openProfileModal()" class="w-9 h-9 rounded-full bg-gray-200 border border-white shadow-sm overflow-hidden active:scale-95 transition-transform"><img id="mobileHeaderAvatar" src="https://placehold.co/100" class="w-full h-full object-cover"></div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="mainScrollArea">
            <div id="tab-dashboard" class="tab-content space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-teal-600 to-blue-600 rounded-3xl p-8 md:p-12 text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-2xl md:text-4xl font-black mb-3 tracking-tight">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">...</span>! üëã</h1>
                        <p class="text-teal-100 mb-8 text-sm md:text-lg max-w-2xl leading-relaxed">H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ h·ªçc t·∫≠p. Ki·ªÉm tra ngay c√°c b√†i t·∫≠p ƒëang ch·ªù b·∫°n ph√≠a d∆∞·ªõi nh√©!</p>
                        <button onclick="switchTab('classes')" class="bg-white text-teal-700 px-6 md:px-8 py-3 rounded-full font-black hover:bg-teal-50 transition shadow-md text-sm md:text-base flex items-center gap-2 inline-flex"><i class="fa-solid fa-arrow-down"></i> V√†o l·ªõp h·ªçc ngay</button>
                    </div>
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-white/10 to-transparent skew-x-12 transform origin-top-right"></div>
                    <div class="absolute bottom-0 left-10 w-40 h-40 bg-teal-500/30 rounded-full blur-2xl"></div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 text-xl mb-6 flex items-center gap-3"><span class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center shadow-sm"><i class="fa-solid fa-bell"></i></span><span id="pendingTitle">ƒêang ki·ªÉm tra b√†i t·∫≠p...</span></h3>
                    <div id="pendingTasksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full py-12 text-center bg-white rounded-2xl border border-dashed border-teal-200"><i class="fa-solid fa-circle-notch fa-spin text-teal-500 text-3xl mb-4"></i><p class="text-gray-500 font-medium">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>
                    </div>
                </div>
            </div>

            <div id="tab-classes" class="tab-content hidden animate-fade-in">
                <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 mb-1">L·ªõp h·ªçc c·ªßa t√¥i</h2>
                        <p class="text-gray-500 text-sm">Danh s√°ch c√°c l·ªõp b·∫°n ƒëang tham gia</p>
                    </div>
                    <div class="bg-white p-1 rounded-xl border border-teal-100 shadow-sm flex shrink-0 self-start md:self-auto">
                        <button onclick="window.switchDisplayMode('classes', 'grid')" id="btn-view-classes-grid" class="p-2 rounded-lg text-teal-600 bg-teal-50 shadow-sm transition-all w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-border-all"></i></button>
                        <button onclick="window.switchDisplayMode('classes', 'list')" id="btn-view-classes-list" class="p-2 rounded-lg text-gray-400 hover:text-teal-600 transition-all w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></button>
                    </div>
                </div>
                <div id="myClassesList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>
            
            <div id="tab-history" class="tab-content hidden animate-fade-in">
                <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 mb-2">L·ªãch s·ª≠ luy·ªán thi</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω k·∫øt qu·∫£ h·ªçc t·∫≠p c·ªßa b·∫°n</p>
                    </div>
                    <div class="bg-white p-1.5 rounded-xl border border-gray-200 shadow-sm inline-flex flex-wrap gap-1">
                        <button onclick="filterHistory('all')" class="px-3 py-2 rounded-lg text-xs md:text-sm font-bold bg-teal-50 text-teal-700 history-filter active" data-type="all">T·∫•t c·∫£</button>
                        <button onclick="filterHistory('class')" class="px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-gray-500 hover:bg-gray-50 history-filter" data-type="class">L·ªõp h·ªçc</button>
                        <button onclick="filterHistory('course')" class="px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-gray-500 hover:bg-gray-50 history-filter" data-type="course">Kh√≥a h·ªçc</button>
                        <button onclick="filterHistory('free')" class="px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-gray-500 hover:bg-gray-50 history-filter" data-type="free">V√£ng lai</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-teal-50 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold sticky top-0">
                                <tr>
                                    <th class="p-4 whitespace-nowrap">T√™n ƒë·ªÅ thi</th>
                                    <th class="p-4 whitespace-nowrap">Ph√¢n lo·∫°i</th> <th class="p-4 whitespace-nowrap">ƒêi·ªÉm s·ªë</th>
                                    <th class="p-4 whitespace-nowrap hidden md:table-cell">Th·ªùi gian n·ªôp</th>
                                    <th class="p-4 whitespace-nowrap hidden md:table-cell">K·∫øt qu·∫£</th>
                                    <th class="p-4 whitespace-nowrap text-right">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="historyListBody" class="divide-y divide-gray-100 text-sm text-gray-700">
                                </tbody>
                        </table>
                    </div>
                    <div id="emptyHistoryMsg" class="hidden p-12 text-center text-gray-400">
                        <i class="fa-solid fa-clipboard-list text-4xl mb-3 text-gray-200"></i>
                        <p>Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i n√†o.</p>
                    </div>
                </div>
            </div>

            <div id="tab-class-detail" class="tab-content hidden animate-fade-in flex flex-col h-full">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 bg-white p-4 rounded-2xl shadow-sm border border-teal-50">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('classes')" class="w-12 h-12 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                        <div><h2 class="text-xl md:text-2xl font-black text-gray-800 leading-none mb-1" id="detailClassName">...</h2><p class="text-sm text-gray-500 font-medium">Danh s√°ch b√†i t·∫≠p</p></div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="bg-gray-100 p-1 rounded-xl flex shrink-0">
                            <button onclick="window.changeLayout('grid')" id="btn-layout-grid" class="p-2.5 rounded-lg text-teal-600 bg-white shadow-sm transition-all"><i class="fa-solid fa-border-all"></i></button>
                            <button onclick="window.changeLayout('list')" id="btn-layout-list" class="p-2.5 rounded-lg text-gray-400 hover:text-teal-600 transition-all"><i class="fa-solid fa-list-ul"></i></button>
                        </div>
                        
                        <select onchange="window.renderClassExams(this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm font-bold rounded-xl focus:ring-teal-500 focus:border-teal-500 block w-full md:w-auto p-3 outline-none cursor-pointer">
                            <option value="newest">‚ú® M·ªõi nh·∫•t tr∆∞·ªõc</option>
                            <option value="oldest">üìÖ C≈© nh·∫•t tr∆∞·ªõc</option>
                        </select>
                    </div>
                </div>
                <div id="classExamList" class="pb-20"></div>
            </div>

            <div id="tab-my-courses" class="tab-content hidden animate-fade-in">
                 <div id="pendingOrdersSection" class="hidden mb-10 bg-orange-50 border border-orange-100 rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-orange-200 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                    <h3 class="font-black text-xl text-orange-700 mb-4 flex items-center gap-2 relative z-10">
                        <i class="fa-solid fa-clock-rotate-left"></i> ƒê∆°n h√†ng ch∆∞a ho√†n t·∫•t
                    </h3>
                    <div id="pendingOrdersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 relative z-10">
                        </div>
                 </div>

                 <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 mb-1">Kh√≥a h·ªçc ƒë√£ s·ªü h·ªØu</h2>
                        <p class="text-gray-500 text-sm">C√°c kh√≥a h·ªçc b·∫°n ƒë√£ mua</p>
                    </div>
                    <div class="bg-white p-1 rounded-xl border border-teal-100 shadow-sm flex shrink-0 self-start md:self-auto">
                        <button onclick="window.switchDisplayMode('purchased', 'grid')" id="btn-view-purchased-grid" class="p-2 rounded-lg text-teal-600 bg-teal-50 shadow-sm transition-all w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-border-all"></i></button>
                        <button onclick="window.switchDisplayMode('purchased', 'list')" id="btn-view-purchased-list" class="p-2 rounded-lg text-gray-400 hover:text-teal-600 transition-all w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></button>
                    </div>
                </div>
                <div id="myPurchasedList" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </div>

            <div id="tab-market" class="tab-content hidden animate-fade-in">
                 <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 mb-1">C·ª≠a h√†ng kh√≥a h·ªçc</h2>
                        <p class="text-gray-500 text-sm">Kh√°m ph√° ki·∫øn th·ª©c m·ªõi</p>
                    </div>
                    <div class="bg-white p-1 rounded-xl border border-teal-100 shadow-sm flex shrink-0 self-start md:self-auto">
                        <button onclick="window.switchDisplayMode('market', 'grid')" id="btn-view-market-grid" class="p-2 rounded-lg text-teal-600 bg-teal-50 shadow-sm transition-all w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-border-all"></i></button>
                        <button onclick="window.switchDisplayMode('market', 'list')" id="btn-view-market-list" class="p-2 rounded-lg text-gray-400 hover:text-teal-600 transition-all w-10 h-10 flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></button>
                    </div>
                </div>
                <div id="marketList" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </main>

    <div id="profileModal" class="hidden fixed inset-0 z-[100] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in scale-95 transform transition-all duration-300 border-4 border-teal-50">
            <div class="px-6 py-5 border-b border-gray-100 bg-teal-50/50 flex justify-between items-center">
                <h3 class="text-xl font-black text-gray-800 flex items-center gap-3"><span class="w-8 h-8 bg-teal-100 text-teal-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-id-badge"></i></span> Th√¥ng tin c√° nh√¢n</h3>
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
                <div>
                    <h4 class="text-xs font-black text-gray-400 uppercase mb-3 tracking-wider flex items-center gap-2"><i class="fa-solid fa-user-tag"></i> C∆° b·∫£n</h4>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">H·ªç v√† t√™n</label><input type="text" id="profName" class="w-full px-4 py-3 border border-gray-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-teal-200 outline-none"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">Ng√†y sinh</label><input type="date" id="profDob" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400"></div>
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">Gi·ªõi t√≠nh</label><select id="profGender" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400 bg-white"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option><option value="Kh√°c">Kh√°c</option></select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">SƒêT C√° nh√¢n</label><input type="tel" id="profPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400"></div>
                            <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">SƒêT Ph·ª• huynh</label><input type="tel" id="profParentPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-red-50/50 p-5 rounded-2xl border border-red-100">
                    <h4 class="text-xs font-black text-red-600 uppercase mb-3 tracking-wider flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> B·∫£o m·∫≠t</h4>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">T√™n ƒëƒÉng nh·∫≠p (C·ªë ƒë·ªãnh)</label><input type="text" id="profUsername" disabled class="w-full px-4 py-3 bg-red-50 border border-red-100 rounded-xl text-gray-500 font-mono text-sm font-bold cursor-not-allowed"></div>
                        <div><label class="block text-xs font-bold text-gray-600 mb-1 pl-1">ƒê·ªïi m·∫≠t kh·∫©u m·ªõi</label><input type="password" id="profPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (n·∫øu mu·ªën ƒë·ªïi)..." class="w-full px-4 py-3 border border-red-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-red-200 text-sm font-medium"><p class="text-[10px] text-red-400 mt-2 flex items-center gap-1 font-medium"><i class="fa-solid fa-circle-info"></i> ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi.</p></div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="px-6 py-3 bg-white border-2 border-gray-200 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-100">H·ªßy b·ªè</button>
                <button onclick="saveProfile()" class="px-8 py-3 bg-brand text-white rounded-xl font-bold text-sm shadow-lg hover:bg-teal-700 flex items-center gap-2"><i class="fa-solid fa-check"></i> L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-gray-900/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center transform scale-100 transition-all">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <h3 class="text-xl font-black text-gray-800 mb-2">X√≥a l·ªãch s·ª≠ l√†m b√†i?</h3>
            <p class="text-gray-500 text-sm mb-6">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. K·∫øt qu·∫£ b√†i thi n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.</p>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('confirmDeleteModal').classList.add('hidden')" class="py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all">H·ªßy b·ªè</button>
                <button id="btnConfirmDelete" class="py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 shadow-lg shadow-red-200 transition-all">X√≥a ngay</button>
            </div>
        </div>
    </div>

    <div id="paymentModalContainer"></div>
    <div id="processingModal" class="fixed inset-0 z-[300] hidden bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-400 via-blue-500 to-purple-600 animate-pulse"></div>
            
            <div id="processingState">
                <div class="w-24 h-24 mx-auto mb-6 relative">
                    <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-teal-500 rounded-full border-t-transparent animate-spin"></div>
                    <i class="fa-solid fa-satellite-dish absolute inset-0 flex items-center justify-center text-3xl text-teal-600 animate-pulse"></i>
                </div>
                <h3 class="text-2xl font-black text-gray-800 mb-2">ƒêang x√°c th·ª±c giao d·ªãch...</h3>
                <p class="text-gray-500 text-sm mb-6 px-4">H·ªá th·ªëng ƒëang k·∫øt n·ªëi v·ªõi ng√¢n h√†ng ƒë·ªÉ ki·ªÉm tra kho·∫£n chuy·ªÉn c·ªßa b·∫°n. Vui l√≤ng kh√¥ng t·∫Øt tr√¨nh duy·ªát.</p>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-left mb-4">
                    <div class="flex justify-between text-xs font-bold text-gray-500 mb-1"><span>Th·ªùi gian ∆∞·ªõc t√≠nh:</span> <span>~2 ph√∫t</span></div>
                    <div class="w-full bg-blue-200 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-600 h-full rounded-full w-1/3 animate-[pulse_2s_infinite]"></div>
                    </div>
                </div>
                <button onclick="window.closeProcessingModal()" class="text-xs text-gray-400 font-bold hover:text-red-500">H·ªßy theo d√µi (V·∫´n x·ª≠ l√Ω ng·∫ßm)</button>
            </div>

            <div id="successState" class="hidden">
                <div class="w-24 h-24 mx-auto mb-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-5xl animate-[bounce_1s_infinite]">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h3 class="text-2xl font-black text-gray-800 mb-2">Thanh to√°n th√†nh c√¥ng!</h3>
                <p class="text-gray-500 text-sm mb-6">Kh√≥a h·ªçc ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t. B·∫°n c√≥ th·ªÉ v√†o h·ªçc ngay b√¢y gi·ªù.</p>
                <button onclick="window.finishPaymentProcess()" class="w-full py-3.5 bg-brand text-white font-bold rounded-xl shadow-lg hover:bg-teal-700 transition-all text-lg">
                    <i class="fa-solid fa-arrow-right mr-2"></i> V√ÄO H·ªåC NGAY
                </button>
            </div>
        </div>
    </div>
    <div id="notificationContainer" class="fixed top-5 right-5 z-[120] flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        // Th√™m enableIndexedDbPersistence v√†o d√≤ng import n√†y
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, addDoc, limit, orderBy, deleteDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- K√çCH HO·∫†T CACHE OFFLINE (QUAN TR·ªåNG) ---
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('L·ªói: ƒêang m·ªü qu√° nhi·ªÅu tab.');
            } else if (err.code == 'unimplemented') {
                console.log('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ cache.');
            }
        });

        const ADMIN_EMAILS = ["phamngockhanh.942001@gmail.com", "phamngockhanh.942002@gmail.com", "admin@gmail.com", "phamdinhquang0911@gmail.com"];
        let currentClassExams = [];
        let studentResultsMap = {};
        let purchasedCourseIds = new Set(); // L∆∞u danh s√°ch ID kh√≥a h·ªçc ƒë√£ mua ƒë·ªÉ ki·ªÉm tra nhanh
        let processingListener = null; // Bi·∫øn l∆∞u tr√¨nh l·∫Øng nghe s·ª± ki·ªán thanh to√°n

        // === BI·∫æN GLOBAL CHO VIEW MODE ===
        let currentViewMode = 'grid'; // M·∫∑c ƒë·ªãnh L∆∞·ªõi
        let currentSortMode = 'newest';

        // === BI·∫æN GLOBAL CHO THANH TO√ÅN & VOUCHER ===
        let currentPayingCourse = null;
        let currentFinalPrice = 0;
        let currentVoucherCode = null;
        let dynamicBankConfig = null;

        

        // --- H·ªÜ TH·ªêNG TOAST ---
        window.showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            const color = type === 'success' ? 'green' : 'red';
            div.className = `notification-toast pointer-events-auto bg-white border-l-4 border-${color}-500 shadow-xl rounded-lg p-4 w-80 flex items-start gap-3 z-[200]`;
            div.innerHTML = `<i class="fa-solid fa-${type==='success'?'check':'circle-exclamation'} text-${color}-500 mt-1"></i><div><h4 class="font-bold text-gray-800 text-sm">${type==='success'?'Th√†nh c√¥ng':'L·ªói'}</h4><p class="text-sm text-gray-600 leading-tight">${msg}</p></div>`;
            container.appendChild(div);
            setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 500); }, 3000);
        }

        // --- AUTH & LOAD DATA ---
        // --- AUTH & LOAD DATA (ƒê√É S·ª¨A L·ªñI HI·ªÇN TH·ªä N√öT V√ÄO H·ªåC) ---
        // --- AUTH & LOAD DATA (T·ªêI ∆ØU T·ªêC ƒê·ªò - PARALLEL LOADING) ---
        // --- AUTH & LOAD DATA (NON-BLOCKING - KH√îNG CH·∫∂N GIAO DI·ªÜN) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (ADMIN_EMAILS.includes(user.email)) { window.location.href = "dashboard.html"; return; }
                
                // 1. T·∫£i th√¥ng tin ng∆∞·ªùi d√πng (Nhanh)
                loadSiteLogo();
                loadUserProfile(user);

                // 2. G·ªçi c√°c h√†m t·∫£i d·ªØ li·ªáu NGAY L·∫¨P T·ª®C (Kh√¥ng d√πng await)
                // Nh·ªù c√≥ Skeleton ·ªü B∆∞·ªõc 2, giao di·ªán s·∫Ω hi·ªán khung x√°m ngay, kh√¥ng b·ªã tr·∫Øng trang
                loadStudentClasses(user);
                loadPendingTasks(user); 
                loadExamHistory(user);

                // 3. Chu·ªói t·∫£i Kh√≥a h·ªçc: Ph·∫£i bi·∫øt ƒë√£ mua g√¨ r·ªìi m·ªõi hi·ªán th·ªã tr∆∞·ªùng
                // D√πng .then() ƒë·ªÉ kh√¥ng ch·∫∑n lu·ªìng ch√≠nh
                loadMyPurchased(user).then(() => {
                    loadMarket();
                });
                
            } else { window.location.href = "index.html"; }
        });

        // --- THEME ENGINE: TRANG TR√ç THEO M√ôA ---
        (function applySidebarEffect() {
            const sidebar = document.getElementById('sidebar-container'); 
            const logoDecor = document.getElementById('logoDecor');
            const treeDecor = document.getElementById('sidebarDecorTree');
            if(!sidebar) return;

            const today = new Date(); 
            const m = today.getMonth() + 1;
            const d = today.getDate();

            let items = "üçÇ"; // M·∫∑c ƒë·ªãnh thu
            let count = 5;

            if (m === 12 || m === 1) {
                items = "‚ùÑÔ∏è"; 
                count = 10;
                if (m === 12 && d >= 15) {
                    items = ["‚ùÑÔ∏è", "‚õÑ", "üéÅ"]; 
                    if(logoDecor) logoDecor.innerHTML = '<div class="santa-hat">üéÖ</div>';
                    if(treeDecor) treeDecor.innerHTML = '<div class="xmas-tree-decor">üéÑ</div>';
                }
            } 
            else if (m === 2 || m === 3) {
                items = ["üå∏", "üßß"];
                if(logoDecor) logoDecor.innerHTML = '<div class="absolute -top-3 -right-2 text-2xl animate-pulse">üå∫</div>';
            }
            else if (m >= 5 && m <= 7) {
                items = "‚òÄÔ∏è";
            }

            for(let i=0; i < count; i++){
                const el = document.createElement('div'); 
                el.classList.add('falling-item'); 
                el.innerHTML = Array.isArray(items) ? items[Math.floor(Math.random() * items.length)] : items;
                el.style.left = Math.random() * 80 + '%'; 
                el.style.fontSize = (Math.random() * 10 + 10) + 'px';
                el.style.animationDuration = (Math.random() * 5 + 5) + 's'; 
                el.style.animationDelay = (Math.random() * 5) + 's';
                sidebar.appendChild(el);
            }
        })();

        // --- PROFILE ---
        async function loadUserProfile(user) {
            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                const data = snap.exists() ? snap.data() : {};
                const name = data.displayName || user.displayName || "B·∫°n";
                document.getElementById('userName').innerText = name;
                document.getElementById('welcomeName').innerText = name;
                document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=0F766E&color=fff`;
                document.getElementById('profName').value = name;
                document.getElementById('profUsername').value = data.username || user.email;
            } catch(e) { console.error(e); }
        }
        window.saveProfile = async () => { window.showNotification("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!", "success"); }

        // --- C√ÅC H√ÄM LOAD D·ªÆ LI·ªÜU ---
        async function loadSiteLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    document.getElementById('sidebarHeaderContent').innerHTML = `<img src="${docSnap.data().logo}" class="w-10 h-10 object-contain drop-shadow-sm"><span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span><div id="logoDecor"></div>`;
                }
            } catch(e){}
        }
        
       // --- QU·∫¢N L√ù TR·∫†NG TH√ÅI HI·ªÇN TH·ªä (GRID/LIST) ---
        window.viewState = { classes: 'grid', purchased: 'grid', market: 'grid' };
        window.dataCache = { classes: [], purchased: [], market: [] };

        window.switchDisplayMode = (section, mode) => {
            window.viewState[section] = mode;
            const btnGrid = document.getElementById(`btn-view-${section}-grid`);
            const btnList = document.getElementById(`btn-view-${section}-list`);
            
            if (mode === 'grid') {
                btnGrid.className = "p-2 rounded-lg text-teal-600 bg-teal-50 shadow-sm transition-all w-10 h-10 flex items-center justify-center";
                btnList.className = "p-2 rounded-lg text-gray-400 hover:text-teal-600 transition-all w-10 h-10 flex items-center justify-center";
            } else {
                btnGrid.className = "p-2 rounded-lg text-gray-400 hover:text-teal-600 transition-all w-10 h-10 flex items-center justify-center";
                btnList.className = "p-2 rounded-lg text-teal-600 bg-teal-50 shadow-sm transition-all w-10 h-10 flex items-center justify-center";
            }

            if (section === 'classes') renderClassesUI();
            else if (section === 'purchased') renderPurchasedUI();
            else if (section === 'market') renderMarketUI();
        };

        async function loadMarket() {
            const container = document.getElementById('marketList');
            if(container) container.innerHTML = '<div class="col-span-full py-12 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-teal-500"></i></div>';
            
            try {
                const s = await getDocs(collection(db, "public_courses"));
                window.dataCache.market = [];
                s.forEach(d => window.dataCache.market.push({ id: d.id, ...d.data() }));
                renderMarketUI();
            } catch(e){ console.error(e); }
        }

        function renderMarketUI() {
            const container = document.getElementById('marketList');
            if(!container) return;
            const data = window.dataCache.market;
            const mode = window.viewState.market;

            if (data.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400">Ch∆∞a c√≥ kh√≥a h·ªçc.</p>';
                return;
            }

            if (mode === 'grid') container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-fade-in";
            else container.className = "flex flex-col gap-4 animate-fade-in";

            let html = '';
            data.forEach(x => {
                const thumb = x.thumbnail || 'https://placehold.co/300';
                let actionBtn = '';
                if (purchasedCourseIds.has(x.id)) {
                    actionBtn = `<button onclick="window.location.href='course-player.html?id=${x.id}'" class="bg-green-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-green-700 transition-colors shadow-green-200 shadow-lg whitespace-nowrap"><i class="fa-solid fa-play mr-1"></i> V√†o h·ªçc</button>`;
                } else {
                    actionBtn = `<button onclick="window.openPaymentModal('${x.id}')" class="bg-brand text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-teal-700 transition-colors whitespace-nowrap">Mua ngay</button>`;
                }

                if (mode === 'grid') {
                    html += `
                    <div class="bg-white rounded-2xl shadow-sm border border-teal-50 hover:shadow-lg transition-all group overflow-hidden flex flex-col h-full">
                        <div class="h-36 bg-gray-100 relative overflow-hidden shrink-0">
                            <img src="${thumb}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <span class="absolute top-3 left-3 bg-accent text-white text-xs font-black px-2 py-1 rounded shadow">${x.tag||'M·ªõi'}</span>
                        </div>
                        <div class="p-5 flex flex-col flex-1">
                            <h4 class="font-bold text-gray-800 mb-2 line-clamp-2 min-h-[3rem]">${x.title}</h4>
                            <div class="mt-auto flex justify-between items-center pt-3 border-t border-dashed border-gray-100">
                                <span class="text-accent font-black text-lg">${parseInt(x.price).toLocaleString()}ƒë</span>
                                ${actionBtn}
                            </div>
                        </div>
                    </div>`;
                } else {
                    html += `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-teal-50 hover:shadow-md transition-all group flex gap-4 items-center">
                        <div class="w-24 h-20 md:w-32 md:h-24 bg-gray-100 rounded-lg overflow-hidden shrink-0 relative">
                            <img src="${thumb}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <span class="absolute top-1 left-1 bg-accent text-white text-[10px] font-black px-1.5 py-0.5 rounded shadow">${x.tag||'M·ªõi'}</span>
                        </div>
                        <div class="flex-1 min-w-0 py-1">
                            <h4 class="font-bold text-gray-800 text-sm md:text-lg mb-1 md:mb-2 line-clamp-1">${x.title}</h4>
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
                                <span class="text-accent font-black text-sm md:text-lg">${parseInt(x.price).toLocaleString()}ƒë</span>
                                <div class="flex justify-end">${actionBtn}</div>
                            </div>
                        </div>
                    </div>`;
                }
            });
            container.innerHTML = html;
        }

        async function loadPendingTasks(user) {
            const container = document.getElementById('pendingTasksList');
            const titleEl = document.getElementById('pendingTitle');
            if(!container) return;

            // HI·ªÜN SKELETON
            container.innerHTML = `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 h-24 animate-pulse">
                    <div class="w-14 h-14 rounded-xl bg-gray-200 shrink-0"></div>
                    <div class="flex-1 space-y-2"><div class="h-4 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>
                </div>`.repeat(3);

            try {
                const qClasses = query(collection(db, "classes"));
                const snapClasses = await getDocs(qClasses);
                const myClassIds = [];
                snapClasses.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    if (students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid))) {
                        myClassIds.push(doc.id);
                    }
                });

                if (myClassIds.length === 0) { 
                    titleEl.innerText = "Em ch∆∞a tham gia l·ªõp n√†o";
                    container.innerHTML = '<div class="col-span-full py-8 text-center bg-white rounded-2xl border border-dashed border-teal-200"><p class="text-gray-500 font-medium">B·∫°n ch∆∞a tham gia l·ªõp n√†o.</p></div>'; 
                    return; 
                }

                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                const submittedExamIds = new Set();
                snapResults.forEach(d => submittedExamIds.add(d.data().examId));

                let pendingExams = [];
                const qEx = query(collection(db, "exams"), where("accessType", "==", "class"), where("status", "==", "published"));
                const snapEx = await getDocs(qEx);

                snapEx.forEach(d => {
                    if (submittedExamIds.has(d.id)) return;
                    const ex = d.data();
                    let isAssignedToMe = false;
                    if (ex.allowedClassIds && Array.isArray(ex.allowedClassIds)) {
                        isAssignedToMe = ex.allowedClassIds.some(allowedId => myClassIds.includes(allowedId));
                    } else if (ex.allowedClassId) {
                        isAssignedToMe = myClassIds.includes(ex.allowedClassId);
                    }
                    if (isAssignedToMe) pendingExams.push({id: d.id, ...ex});
                });
                
                pendingExams = pendingExams.slice(0, 10);
                titleEl.innerHTML = `Em c√≥ <span class="text-red-500 font-black text-2xl mx-1">${pendingExams.length}</span> b√†i t·∫≠p c·∫ßn ho√†n th√†nh`;

                if (pendingExams.length === 0) { 
                    container.innerHTML = '<div class="col-span-full py-8 text-center bg-white rounded-2xl border border-dashed border-teal-200 shadow-sm"><i class="fa-solid fa-circle-check text-teal-500 text-4xl mb-3"></i><p class="text-gray-800 font-bold mb-1">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh h·∫øt b√†i t·∫≠p.</p></div>'; 
                    return; 
                }

                let html = '';
                pendingExams.forEach(ex => {
                    html += `<div class="bg-white p-4 rounded-2xl shadow-sm border border-teal-50 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all hover:border-teal-200 group" onclick="window.location.href='exam.html?id=${ex.id}'"><div class="w-14 h-14 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center font-bold shrink-0 relative"><i class="fa-solid fa-file-pen text-xl"></i><span class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full animate-pulse"></span></div><div class="flex-1 min-w-0"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-black text-gray-400 uppercase tracking-wider">B√†i t·∫≠p m·ªõi</span><span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full">Ch∆∞a l√†m</span></div><h4 class="font-bold text-gray-800 text-base line-clamp-1 group-hover:text-brand transition-colors">${ex.title}</h4><p class="text-xs text-gray-500 font-medium mt-1 flex items-center gap-3"><span><i class="fa-regular fa-clock text-teal-500"></i> ${ex.duration}p</span><span><i class="fa-solid fa-list-ol text-teal-500"></i> ${ex.questionCount||0} c√¢u</span></p></div><button class="text-sm bg-brand text-white w-10 h-10 rounded-full font-bold flex items-center justify-center hover:bg-teal-700 transition-all hover:scale-110 shadow-sm"><i class="fa-solid fa-play ml-0.5"></i></button></div>`;
                });
                container.innerHTML = html;
            } catch(e) { console.error(e); }
        }

        async function loadStudentClasses(user) {
            const container = document.getElementById('myClassesList');
            if(container) container.innerHTML = '<div class="col-span-full py-12 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-teal-500"></i></div>';

            try {
                const q = query(collection(db, "classes"));
                const snap = await getDocs(q);
                window.dataCache.classes = [];
                
                snap.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    if (students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid))) {
                        window.dataCache.classes.push({ id: doc.id, ...cl });
                    }
                });
                renderClassesUI();
            } catch(e) { console.error(e); }
        }

        function renderClassesUI() {
            const container = document.getElementById('myClassesList');
            if(!container) return;
            const data = window.dataCache.classes;
            const mode = window.viewState.classes;

            if (data.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><p class="text-gray-500 font-bold">B·∫°n ch∆∞a tham gia l·ªõp n√†o.</p></div>';
                return;
            }

            if (mode === 'grid') container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in";
            else container.className = "flex flex-col gap-4 animate-fade-in";

            let html = '';
            data.forEach(cl => {
                if (mode === 'grid') {
                    html += `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50 hover:border-teal-300 hover:shadow-md transition-all cursor-pointer group flex flex-col h-full" onclick="window.openClassDetail('${cl.id}', '${cl.name}')">
                        <div class="flex justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-teal-100 text-teal-600 flex items-center justify-center font-bold text-xl"><i class="fa-solid fa-chalkboard"></i></div>
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-teal-500 group-hover:text-white transition-colors"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                        <h3 class="font-bold text-xl text-gray-800 mb-1 group-hover:text-teal-700 transition-colors truncate">${cl.name}</h3>
                        <p class="text-sm text-gray-500 font-medium mb-6 flex items-center gap-2"><i class="fa-solid fa-user-tie text-teal-500"></i> GV: ${cl.teacherName || "Th·∫ßy Choang"}</p>
                        <div class="mt-auto w-full py-3 bg-teal-50 text-teal-700 font-bold text-sm rounded-xl text-center group-hover:bg-teal-600 group-hover:text-white transition-all shadow-sm">V√†o l·ªõp h·ªçc</div>
                    </div>`;
                } else {
                    html += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-teal-50 hover:border-teal-300 hover:shadow-md transition-all cursor-pointer group flex items-center gap-4" onclick="window.openClassDetail('${cl.id}', '${cl.name}')">
                        <div class="w-14 h-14 md:w-16 md:h-16 rounded-xl bg-teal-100 text-teal-600 flex items-center justify-center font-bold text-xl md:text-2xl shrink-0"><i class="fa-solid fa-chalkboard"></i></div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg text-gray-800 mb-0.5 group-hover:text-teal-700 transition-colors truncate">${cl.name}</h3>
                            <p class="text-xs text-gray-500 font-medium"><i class="fa-solid fa-user-tie text-teal-500 mr-1"></i> GV: ${cl.teacherName || "Th·∫ßy Choang"}</p>
                        </div>
                        <div class="hidden md:block px-6 py-2 bg-teal-50 text-teal-700 font-bold text-sm rounded-lg group-hover:bg-teal-600 group-hover:text-white transition-all whitespace-nowrap">V√†o l·ªõp</div>
                        <i class="fa-solid fa-chevron-right text-gray-300 md:hidden"></i>
                    </div>`;
                }
            });
            container.innerHTML = html;
        }

        window.openClassDetail = async (classId, className) => {
            window.switchTab('class-detail');
            document.getElementById('detailClassName').textContent = className;
            const container = document.getElementById('classExamList');
            container.innerHTML = '<div class="col-span-full text-center py-16"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-teal-500"></i></div>';
            try {
                const user = auth.currentUser;
                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                studentResultsMap = {};
                snapResults.forEach(d => { const r = d.data(); if (!studentResultsMap[r.examId] || r.score > studentResultsMap[r.examId].score) studentResultsMap[r.examId] = r; });
                
                // [C·∫¨P NH·∫¨T] T√¨m ƒë·ªÅ thi cho l·ªõp n√†y (H·ªó tr·ª£ c·∫£ AllowedClassId c≈© v√† AllowedClassIds m·ªõi)
                // V√¨ Firestore kh√¥ng h·ªó tr·ª£ OR query ph·ª©c t·∫°p, ta s·∫Ω l·∫•y h·∫øt ƒë·ªÅ published r·ªìi l·ªçc
                const qExams = query(collection(db, "exams"), where("accessType", "==", "class"), where("status", "==", "published"));
                const snapExams = await getDocs(qExams);
                
                currentClassExams = []; 
                snapExams.forEach(d => {
                    const ex = d.data();
                    let isForThisClass = false;

                    // Check logic ƒëa l·ªõp
                    if (ex.allowedClassIds && Array.isArray(ex.allowedClassIds)) {
                        isForThisClass = ex.allowedClassIds.includes(classId);
                    } else if (ex.allowedClassId) {
                        isForThisClass = ex.allowedClassId === classId;
                    }

                    if (isForThisClass) {
                        currentClassExams.push({ id: d.id, ...ex });
                    }
                });
                renderClassExams('newest');
            } catch (e) { console.error(e); container.innerHTML = '<p class="col-span-full text-red-500 text-center">L·ªói t·∫£i d·ªØ li·ªáu.</p>'; }
        };

        window.renderClassExams = (sortType) => {
            currentSortMode = sortType;
            const container = document.getElementById('classExamList');
            if(currentClassExams.length === 0) { container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</div>'; container.className=""; return; }
            
            currentClassExams.sort((a, b) => { const dA = new Date(a.createdAt||0); const dB = new Date(b.createdAt||0); return sortType === 'newest' ? dB - dA : dA - dB; });
            
            let html = '';
            if (currentViewMode === 'grid') {
                container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
                currentClassExams.forEach(exam => {
                    const result = studentResultsMap[exam.id]; const isDone = !!result;
                    let statusBadge = `<span class="text-[10px] font-black bg-gray-100 text-gray-500 px-2.5 py-1 rounded-full uppercase tracking-wider">Ch∆∞a l√†m</span>`;
                    let actionBtn = `<button onclick="window.location.href='exam.html?id=${exam.id}'" class="w-full py-3 bg-brand text-white font-bold rounded-xl shadow-sm hover:bg-teal-700 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu</button>`;
                    let scoreInfo = '';
                    if (isDone) {
                        const score = result.score;
                        let badgeColor = score >= 9 ? 'bg-yellow-100 text-yellow-700' : (score >= 8 ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700');
                        statusBadge = `<span class="text-[10px] font-black ${badgeColor} px-2.5 py-1 rounded-full uppercase tracking-wider shadow-sm">${score} ƒëi·ªÉm</span>`;
                        actionBtn = `<div class="flex gap-2"><button onclick="window.location.href='exam.html?id=${exam.id}'" class="flex-1 py-3 bg-white border-2 border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 text-sm">L√†m l·∫°i</button><button onclick="window.location.href='exam.html?id=${exam.id}&mode=review'" class="flex-1 py-3 bg-teal-100 text-teal-700 font-bold rounded-xl hover:bg-teal-200 text-sm">Xem l·ªùi gi·∫£i</button></div>`;
                        scoreInfo = `<div class="mt-3 pt-3 border-t border-dashed border-gray-100 flex justify-between items-center text-xs text-gray-500 font-medium"><span>Cao nh·∫•t:</span> <span class="text-gray-800 font-black text-base">${score}ƒë</span></div>`;
                    }
                    html += `<div class="bg-white p-5 rounded-2xl shadow-sm border border-teal-50 hover:shadow-md transition-all flex flex-col justify-between h-full relative group hover:border-teal-200"><div><div class="flex justify-between items-center mb-3"><div class="flex items-center gap-2"><span class="w-8 h-8 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center"><i class="fa-regular fa-file-lines"></i></span><span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${exam.id.substring(0,6)}</span></div>${statusBadge}</div><h4 class="font-bold text-gray-800 text-lg mb-2 line-clamp-2 group-hover:text-brand transition-colors" title="${exam.title}">${exam.title}</h4><div class="flex items-center gap-4 text-xs text-gray-500 font-medium"><span class="flex items-center gap-1"><i class="fa-regular fa-clock text-teal-500"></i> ${exam.duration}p</span><span class="flex items-center gap-1"><i class="fa-solid fa-list-ol text-teal-500"></i> ${exam.questionCount||0} c√¢u</span></div>${scoreInfo}</div><div class="mt-5">${actionBtn}</div></div>`;
                });
            } else {
                container.className = "space-y-3";
                currentClassExams.forEach(exam => {
                    const result = studentResultsMap[exam.id]; const isDone = !!result;
                    let actionBtn = `<button onclick="window.location.href='exam.html?id=${exam.id}'" class="px-6 py-2 bg-brand text-white font-bold rounded-lg hover:bg-teal-700 text-sm whitespace-nowrap"><i class="fa-solid fa-play mr-1"></i> L√†m b√†i</button>`;
                    let scoreBadge = isDone ? `<div class="text-right"><div class="text-sm font-black text-teal-700">${result.score}ƒë</div><div class="text-[10px] text-gray-400">ƒêi·ªÉm cao nh·∫•t</div></div>` : `<div class="text-right"><div class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">Ch∆∞a l√†m</div></div>`;
                    if(isDone) actionBtn = `<div class="flex gap-2"><button onclick="window.location.href='exam.html?id=${exam.id}&mode=review'" class="px-3 py-2 bg-teal-50 text-teal-700 font-bold rounded-lg hover:bg-teal-100 text-xs whitespace-nowrap"><i class="fa-solid fa-eye"></i> Xem</button><button onclick="window.location.href='exam.html?id=${exam.id}'" class="px-3 py-2 bg-gray-50 text-gray-600 font-bold rounded-lg hover:bg-gray-100 text-xs whitespace-nowrap"><i class="fa-solid fa-rotate-right"></i> L·∫°i</button></div>`;
                    html += `<div class="bg-white p-4 rounded-xl border border-gray-200 hover:border-teal-300 hover:shadow-sm transition-all flex flex-col md:flex-row md:items-center gap-4 group"><div class="flex items-center gap-4 flex-1"><div class="w-12 h-12 rounded-xl bg-teal-50 text-teal-600 flex items-center justify-center text-xl shrink-0 font-bold">${isDone ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-regular fa-file-lines"></i>'}</div><div><h4 class="font-bold text-gray-800 text-base group-hover:text-brand transition-colors line-clamp-1">${exam.title}</h4><div class="flex items-center gap-3 text-xs text-gray-500 mt-1"><span class="bg-gray-100 px-1.5 py-0.5 rounded text-[10px] font-mono">#${exam.id.substring(0,6)}</span><span><i class="fa-regular fa-clock"></i> ${exam.duration}p</span><span><i class="fa-solid fa-list-ol"></i> ${exam.questionCount||0} c√¢u</span></div></div></div><div class="flex items-center justify-between md:justify-end gap-4 border-t md:border-t-0 pt-3 md:pt-0 border-gray-100">${scoreBadge}${actionBtn}</div></div>`;
                });
            }
            container.innerHTML = html;
        };

        window.changeLayout = (mode) => {
            currentViewMode = mode;
            const btnGrid = document.getElementById('btn-layout-grid');
            const btnList = document.getElementById('btn-layout-list');
            if (mode === 'grid') {
                btnGrid.className = "p-2.5 rounded-lg text-teal-600 bg-white shadow-sm transition-all";
                btnList.className = "p-2.5 rounded-lg text-gray-400 hover:text-teal-600 transition-all";
            } else {
                btnGrid.className = "p-2.5 rounded-lg text-gray-400 hover:text-teal-600 transition-all";
                btnList.className = "p-2.5 rounded-lg text-teal-600 bg-white shadow-sm transition-all";
            }
            renderClassExams(currentSortMode);
        };

        // --- T√åM H√ÄM loadMyPurchased C≈® V√Ä THAY B·∫∞NG ƒêO·∫†N N√ÄY ---
        // --- T√åM H√ÄM loadMyPurchased C≈® V√Ä THAY B·∫∞NG ƒêO·∫†N N√ÄY ---
        async function loadMyPurchased(user) { 
            const listPaid = document.getElementById('myPurchasedList'); 
            const sectionPending = document.getElementById('pendingOrdersSection');
            const listPending = document.getElementById('pendingOrdersList');
            
            // HI·ªÜN SKELETON
            if(listPaid) {
                listPaid.innerHTML = `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm h-48 animate-pulse flex flex-col justify-between">
                        <div class="flex gap-3"><div class="w-12 h-12 bg-gray-200 rounded-xl"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div></div>
                        <div class="h-8 bg-gray-200 rounded w-full"></div>
                    </div>`.repeat(4);
            }

            try {
                // 1. L·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa user
                const q = query(collection(db, "orders"), where("userId", "==", user.uid)); 
                const s = await getDocs(q); 
                
                purchasedCourseIds.clear(); 
                
                // T√°ch danh s√°ch ƒë·ªÉ x·ª≠ l√Ω
                let paidItems = [];
                let pendingItems = [];

                s.forEach(d => {
                    const o = d.data();
                    if (o.status === 'paid' || o.status === 'approved') {
                        paidItems.push({ orderId: d.id, ...o });
                    } else if (o.status === 'pending') {
                        pendingItems.push({ orderId: d.id, ...o });
                    }
                });

                // 2. [QUAN TR·ªåNG] L·ªçc b·ªè c√°c kh√≥a h·ªçc ƒë√£ b·ªã x√≥a (Check t·ªìn t·∫°i trong public_courses)
                const validPaidItems = await Promise.all(paidItems.map(async (o) => {
                    try {
                        const cRef = doc(db, "public_courses", o.courseId);
                        const cSnap = await getDoc(cRef);
                        // N·∫øu kh√≥a h·ªçc c√≤n t·ªìn t·∫°i -> Gi·ªØ l·∫°i order
                        if(cSnap.exists()) return o;
                        // N·∫øu kh√≥a h·ªçc ƒë√£ x√≥a -> Tr·∫£ v·ªÅ null ƒë·ªÉ l·ªçc b·ªè
                        return null;
                    } catch(e) { return null; }
                }));

                // 3. Render danh s√°ch ƒê√É MUA (ch·ªâ nh·ªØng c√°i valid)
                let htmlPaid = '';
                validPaidItems.forEach(o => {
                    if(!o) return; // B·ªè qua null (kh√≥a ƒë√£ x√≥a)
                    
                    purchasedCourseIds.add(o.courseId);
                    // L·∫•y ti·∫øn ƒë·ªô th·∫≠t t·ª´ order (n·∫øu c√≥), m·∫∑c ƒë·ªãnh 0
                    const percent = o.progress || 0; 
                    
                    // Giao di·ªán Grid
                    htmlPaid += `
                        <div class="bg-white p-5 rounded-2xl border border-teal-50 shadow-sm hover:border-teal-300 hover:shadow-md transition-all cursor-pointer group flex flex-col h-full relative overflow-hidden" onclick="window.location.href='course-player.html?id=${o.courseId}'">
                            <div class="absolute top-0 right-0 bg-teal-500 w-16 h-16 rounded-bl-full opacity-10"></div>
                            <div class="flex gap-3 mb-4 relative z-10">
                                <div class="w-12 h-12 bg-teal-100 text-teal-600 rounded-xl flex items-center justify-center font-bold shrink-0 shadow-inner"><i class="fa-solid fa-graduation-cap text-xl"></i></div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-gray-800 text-sm line-clamp-2 mb-1 group-hover:text-brand transition-colors">${o.courseTitle}</h4>
                                    <p class="text-[10px] text-gray-400 flex items-center gap-1"><i class="fa-solid fa-calendar-check"></i> ƒê√£ k√≠ch ho·∫°t</p>
                                </div>
                            </div>
                            <div class="mt-auto pt-3 border-t border-dashed border-gray-100 relative z-10">
                                <div class="flex justify-between items-center mb-1.5"><span class="text-[10px] font-extrabold text-gray-400 uppercase tracking-wider">Ti·∫øn ƒë·ªô</span><span class="text-[10px] font-bold text-brand bg-teal-50 px-2 py-0.5 rounded-full">${percent}%</span></div>
                                <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden shadow-inner"><div class="bg-gradient-to-r from-teal-400 to-brand h-full rounded-full transition-all duration-1000" style="width: ${percent}%"></div></div>
                            </div>
                            <button class="w-full mt-4 py-2.5 bg-white border-2 border-teal-50 text-teal-700 text-xs font-bold rounded-xl group-hover:bg-brand group-hover:text-white group-hover:border-brand transition-all flex items-center justify-center gap-2 shadow-sm"><i class="fa-solid fa-play"></i> Ti·∫øp t·ª•c h·ªçc</button>
                        </div>`;
                });
                
                if(listPaid) {
                    if (!htmlPaid) listPaid.innerHTML = '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><i class="fa-solid fa-basket-shopping text-4xl text-gray-200 mb-3"></i><p class="text-gray-500 font-bold">B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o.</p></div>';
                    else listPaid.innerHTML = htmlPaid;
                }

                // 4. Render danh s√°ch CH·ªú THANH TO√ÅN (Pending)
                let htmlPending = '';
                let hasPending = false;
                pendingItems.forEach(o => {
                    hasPending = true;
                    const orderId = o.orderId;
                    const priceDisplay = o.amount ? o.amount.toLocaleString() + 'ƒë' : '0ƒë';
                    const orderDataSafe = encodeURIComponent(JSON.stringify({id: orderId, ...o}));
                    
                    htmlPending += `<div class="bg-white p-4 rounded-xl shadow-sm border border-orange-200 flex flex-col"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-gray-800 text-sm line-clamp-2">${o.courseTitle}</h4><span class="bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-1 rounded">Ch·ªù thanh to√°n</span></div><div class="text-xs text-gray-500 mb-4 space-y-1"><p>M√£ ƒë∆°n: <span class="font-mono text-gray-700">${orderId.substring(0,6)}</span></p><p>S·ªë ti·ªÅn: <span class="font-bold text-orange-600 text-base">${priceDisplay}</span></p></div><div class="mt-auto grid grid-cols-2 gap-2"><button onclick="window.cancelOrder('${orderId}')" class="py-2 bg-gray-100 text-gray-500 text-xs font-bold rounded-lg hover:bg-red-50 hover:text-red-500 transition-colors">H·ªßy ƒë∆°n</button><button onclick="window.continuePayment('${orderDataSafe}')" class="py-2 bg-orange-500 text-white text-xs font-bold rounded-lg hover:bg-orange-600 transition-colors shadow-lg shadow-orange-200">Thanh to√°n ngay</button></div></div>`;
                });

                if(sectionPending && listPending) {
                    if (hasPending) { sectionPending.classList.remove('hidden'); listPending.innerHTML = htmlPending; } 
                    else { sectionPending.classList.add('hidden'); }
                }

            } catch(e) { console.error(e); }
        }

        function renderPurchasedUI() {
            const container = document.getElementById('myPurchasedList');
            if(!container) return;
            const data = window.dataCache.purchased;
            const mode = window.viewState.purchased;

            if (data.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><i class="fa-solid fa-basket-shopping text-4xl text-gray-200 mb-3"></i><p class="text-gray-500 font-bold">B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o.</p></div>';
                return;
            }

            if (mode === 'grid') container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-fade-in";
            else container.className = "flex flex-col gap-4 animate-fade-in";

            let html = '';
            data.forEach(o => {
                // [FIX] S·ª≠a l·ªói nh·∫£y s·ªë lung tung
                // T·∫°m th·ªùi ƒë·ªÉ 0% (ch∆∞a h·ªçc). Sau n√†y khi l√†m course-player xong, ta s·∫Ω l∆∞u ti·∫øn ƒë·ªô v√†o bi·∫øn o.progress
                const percent = o.progress || 0; 
                
                if (mode === 'grid') {
                    html += `
                    <div class="bg-white p-5 rounded-2xl border border-teal-50 shadow-sm hover:border-teal-300 hover:shadow-md transition-all cursor-pointer group flex flex-col h-full relative overflow-hidden" onclick="window.location.href='course-player.html?id=${o.courseId}'">
                        <div class="absolute top-0 right-0 bg-teal-500 w-16 h-16 rounded-bl-full opacity-10"></div>
                        <div class="flex gap-3 mb-4 relative z-10">
                            <div class="w-12 h-12 bg-teal-100 text-teal-600 rounded-xl flex items-center justify-center font-bold shrink-0 shadow-inner"><i class="fa-solid fa-graduation-cap text-xl"></i></div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-sm line-clamp-2 mb-1 group-hover:text-brand transition-colors" title="${o.courseTitle}">${o.courseTitle}</h4>
                                <p class="text-[10px] text-gray-400 flex items-center gap-1"><i class="fa-solid fa-calendar-check"></i> ƒê√£ k√≠ch ho·∫°t</p>
                            </div>
                        </div>
                        <div class="mt-auto pt-3 border-t border-dashed border-gray-100 relative z-10">
                            <div class="flex justify-between items-center mb-1.5"><span class="text-[10px] font-extrabold text-gray-400 uppercase tracking-wider">Ti·∫øn ƒë·ªô</span><span class="text-[10px] font-bold text-brand bg-teal-50 px-2 py-0.5 rounded-full">${percent}%</span></div>
                            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden shadow-inner"><div class="bg-gradient-to-r from-teal-400 to-brand h-full rounded-full transition-all duration-1000" style="width: ${percent}%"></div></div>
                        </div>
                        <button class="w-full mt-4 py-2.5 bg-white border-2 border-teal-50 text-teal-700 text-xs font-bold rounded-xl group-hover:bg-brand group-hover:text-white group-hover:border-brand transition-all flex items-center justify-center gap-2 shadow-sm"><i class="fa-solid fa-play"></i> Ti·∫øp t·ª•c h·ªçc</button>
                    </div>`;
                } else {
                    html += `
                    <div class="bg-white p-4 rounded-xl border border-teal-50 shadow-sm hover:border-teal-300 transition-all cursor-pointer group flex items-center gap-4 relative overflow-hidden" onclick="window.location.href='course-player.html?id=${o.courseId}'">
                        <div class="w-16 h-16 bg-teal-100 text-teal-600 rounded-xl flex items-center justify-center font-bold text-2xl shrink-0"><i class="fa-solid fa-graduation-cap"></i></div>
                        <div class="flex-1 min-w-0 z-10">
                            <h4 class="font-bold text-gray-800 text-sm md:text-base mb-1 group-hover:text-brand transition-colors truncate">${o.courseTitle}</h4>
                            <div class="flex items-center gap-4 w-full md:w-1/2">
                                <div class="flex-1 bg-gray-100 rounded-full h-1.5 overflow-hidden"><div class="bg-teal-500 h-full rounded-full" style="width: ${percent}%"></div></div>
                                <span class="text-xs font-bold text-teal-600">${percent}%</span>
                            </div>
                        </div>
                        <button class="hidden md:flex px-5 py-2 bg-teal-50 text-teal-700 font-bold text-sm rounded-lg hover:bg-teal-600 hover:text-white transition-all items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-play"></i> V√†o h·ªçc</button>
                        <i class="fa-solid fa-chevron-right text-gray-300 md:hidden"></i>
                    </div>`;
                }
            });
            container.innerHTML = html;
        }

        // --- PAYMENT & VOUCHER ---
        const paymentModalHTML = `
            <div id="paymentModal" class="modal hidden fixed inset-0 z-[100] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-300">
                <div class="bg-white w-full max-w-5xl rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh]">
                    <div class="w-full md:w-5/12 bg-gray-50 p-8 border-r border-gray-200 flex flex-col overflow-y-auto">
                        <h3 class="font-black text-gray-800 text-xl mb-6 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-receipt text-brand"></i> Chi ti·∫øt ƒë∆°n h√†ng
                        </h3>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-4">
                            <div class="flex items-start gap-4 mb-4">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg shrink-0 overflow-hidden"><img id="payCourseImg" class="w-full h-full object-cover"></div>
                                <div><span class="text-[10px] font-bold bg-teal-100 text-teal-700 px-2 py-0.5 rounded uppercase">Kh√≥a h·ªçc</span><h4 id="payCourseTitle" class="font-bold text-gray-800 line-clamp-2 mt-1">...</h4></div>
                            </div>
                            <div class="space-y-2 text-xs text-gray-500 border-t border-dashed border-gray-200 pt-3">
                                <div class="flex justify-between"><span>M√£ ƒë∆°n:</span> <span id="payOrderId" class="font-mono font-bold text-gray-700">...</span></div>
                                <div class="flex justify-between"><span>Ng√†y t·∫°o:</span> <span id="payDate" class="font-bold text-gray-700">...</span></div>
                                <div class="flex justify-between"><span>Th·ªùi h·∫°n:</span> <span class="font-bold text-blue-600">Vƒ©nh vi·ªÖn</span></div>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">M√£ gi·∫£m gi√° (Voucher)</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="voucherInput" placeholder="Nh·∫≠p m√£ (VD: CHAO2025)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-teal-500 outline-none uppercase font-bold text-gray-700">
                                <button onclick="window.applyVoucher()" class="px-4 py-2 bg-gray-800 text-white text-xs font-bold rounded-lg hover:bg-gray-700 transition-colors">√Åp d·ª•ng</button>
                            </div>
                            <div id="voucherMessage" class="hidden mb-3 text-xs font-bold"></div>
                            <div class="flex justify-between items-center text-sm text-gray-500 mb-1"><span>T·∫°m t√≠nh:</span><span id="payOriginalPrice">0ƒë</span></div>
                            <div class="flex justify-between items-center text-sm text-green-600 mb-3 font-bold"><span>Gi·∫£m gi√°:</span><span id="payDiscountAmount">-0ƒë</span></div>
                            <div class="border-t border-gray-200 pt-3 flex justify-between items-center"><span class="font-bold text-gray-800">T·ªîNG C·∫¶N TR·∫¢</span><span id="payFinalPrice" class="text-2xl font-black text-orange-600">0ƒë</span></div>
                        </div>
                    </div>
                    <div class="w-full md:w-7/12 p-8 relative flex flex-col items-center bg-white justify-center text-center">
                        <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-gray-100 hover:bg-red-50 text-gray-400 hover:text-red-500 flex items-center justify-center transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                        <div id="stepReview" class="flex flex-col items-center justify-center w-full h-full">
                            <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mb-4 animate-bounce"><i class="fa-solid fa-wallet text-4xl text-teal-600"></i></div>
                            <h3 class="font-bold text-xl text-gray-800 mb-2">X√°c nh·∫≠n thanh to√°n</h3>
                            <p class="text-gray-500 text-sm mb-6 max-w-xs">Vui l√≤ng ki·ªÉm tra k·ªπ s·ªë ti·ªÅn sau khi √°p m√£ gi·∫£m gi√° tr∆∞·ªõc khi t·∫°o m√£ QR.</p>
                            <button onclick="window.generatePaymentQR()" class="px-8 py-3 bg-gradient-to-r from-teal-600 to-teal-500 text-white font-bold rounded-xl shadow-lg hover:shadow-teal-200 hover:-translate-y-0.5 transition-all flex items-center gap-2">Ti·∫øp t·ª•c thanh to√°n <i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                        <div id="stepQR" class="hidden w-full flex-col items-center animate-fade-in">
                            <div class="text-center mb-4"><h3 class="font-black text-2xl text-teal-700 mb-1">Qu√©t m√£ VietQR</h3><p class="text-gray-500 text-sm">S·ª≠ d·ª•ng App ng√¢n h√†ng ƒë·ªÉ qu√©t</p></div>
                            <div class="relative w-64 h-64 bg-white p-2 rounded-xl shadow-xl border-4 border-teal-50 mb-4 group mx-auto">
                                <img id="vietQrImage" class="w-full h-full object-contain rounded-lg">
                                <div id="qrLoading" class="absolute inset-0 bg-white flex flex-col items-center justify-center rounded-lg z-10"><div class="dashed-loader mb-2"></div><span class="text-xs font-bold text-teal-600">ƒêang t·∫°o QR...</span></div>
                            </div>
                            <div class="w-full max-w-sm bg-blue-50/50 p-3 rounded-xl border border-blue-100 text-sm space-y-2 mb-4 mx-auto text-left">
                                <div class="flex justify-between"><span class="text-gray-500">Ng√¢n h√†ng</span><b class="text-blue-700" id="bankNameDisplay">...</b></div>
                                <div class="flex justify-between"><span class="text-gray-500">S·ªë t√†i kho·∫£n</span><b class="text-blue-700 font-mono" id="accountNoDisplay">...</b></div>
                                <div class="flex justify-between items-center pt-2 border-t border-blue-200/50"><span class="text-gray-500">N·ªôi dung</span><b class="text-orange-600 font-mono text-xs" id="transferContentDisplay">...</b></div>
                            </div>
                            <button onclick="window.confirmPayment()" class="w-full max-w-sm py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-check-circle"></i> ƒê√É CHUY·ªÇN KHO·∫¢N XONG</button>
                            <button onclick="window.resetQrState()" class="mt-3 text-xs text-gray-400 font-bold hover:text-teal-600 underline">Quay l·∫°i s·ª≠a voucher</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('paymentModalContainer').innerHTML = paymentModalHTML;

        async function validateVoucher(code, courseId, originalPrice) {
            try {
                const q = query(collection(db, "vouchers"), where("code", "==", code));
                const snap = await getDocs(q);
                
                if (!snap.empty) {
                    const vData = snap.docs[0].data();
                    const now = new Date();
                    
                    if (vData.expiryDate && new Date(vData.expiryDate) < now) throw new Error("M√£ gi·∫£m gi√° ƒë√£ h·∫øt h·∫°n s·ª≠ d·ª•ng");
                    if (vData.limit && vData.used >= vData.limit) throw new Error("M√£ gi·∫£m gi√° ƒë√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng");
                    if (vData.scope === 'specific' && vData.courseIds && !vData.courseIds.includes(courseId)) throw new Error("M√£ n√†y kh√¥ng √°p d·ª•ng cho kh√≥a h·ªçc n√†y");
                    
                    // Logic t√≠nh to√°n
                    let discount = 0;
                    if (vData.type === 'percent') discount = (originalPrice * vData.value) / 100;
                    else discount = vData.value;
                    
                    if (discount > originalPrice) discount = originalPrice;
                    
                    return { discount: discount, finalPrice: originalPrice - discount };
                }
            } catch (e) {
                if (!e.message.includes("kh√¥ng t·ªìn t·∫°i")) throw e;
            }
            throw new Error("M√£ gi·∫£m gi√° kh√¥ng t·ªìn t·∫°i");
        }

        function calculateDiscount(vData, price) {
            let discount = 0;
            if (vData.type === 'percent') discount = (price * vData.value) / 100;
            else discount = vData.value;
            if (discount > price) discount = price;
            return { discount: discount, finalPrice: price - discount };
        }

        window.openPaymentModal = async (courseId) => {
            if (!auth.currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");

            // [FIX] Reset n√∫t CTA v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh "Ti·∫øp t·ª•c thanh to√°n"
            const stepReview = document.getElementById('stepReview');
            // T√¨m v√† x√≥a n√∫t c≈© ƒë·ªÉ clear event listener, t·∫°o n√∫t m·ªõi
            const oldBtn = stepReview.querySelector('button[onclick^="window."]') || stepReview.querySelector('#btnCtaAction');
            if(oldBtn) {
                const newBtn = oldBtn.cloneNode(true);
                newBtn.id = "btnCtaAction";
                newBtn.innerHTML = 'Ti·∫øp t·ª•c thanh to√°n <i class="fa-solid fa-arrow-right"></i>';
                newBtn.className = "px-8 py-3 bg-gradient-to-r from-teal-600 to-teal-500 text-white font-bold rounded-xl shadow-lg hover:shadow-teal-200 hover:-translate-y-0.5 transition-all flex items-center gap-2";
                newBtn.onclick = window.generatePaymentQR; // M·∫∑c ƒë·ªãnh l√† t·∫°o QR
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
            }

            // [FIX] Reset n√∫t "ƒê√£ chuy·ªÉn kho·∫£n" ·ªü b∆∞·ªõc QR lu√¥n
            const btnConfirm = document.querySelector('#stepQR button'); 
            if(btnConfirm) {
                 const originalBtn = btnConfirm.cloneNode(true);
                 btnConfirm.parentNode.replaceChild(originalBtn, btnConfirm);
                 originalBtn.onclick = window.confirmPayment;
                 originalBtn.innerHTML = '<i class="fa-solid fa-check-circle"></i> ƒê√É CHUY·ªÇN KHO·∫¢N XONG';
            }
            
            // Reset Voucher UI
            document.getElementById('voucherInput').value = '';
            document.getElementById('voucherInput').disabled = false;
            document.getElementById('voucherMessage').className = 'hidden';
            document.getElementById('payDiscountAmount').innerText = '-0ƒë';
            currentVoucherCode = null;

            // ... (Ph·∫ßn logic l·∫•y data kh√≥a h·ªçc b√™n d∆∞·ªõi)
            if (!dynamicBankConfig) { 
                 try {
                    const s = await getDoc(doc(db, "site_settings", "payment_config"));
                    dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "970422", BANK_NAME: "MB Bank", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ADMIN" };
                } catch(e) { console.error(e); }
            }

            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('stepReview').classList.remove('hidden');
            document.getElementById('stepQR').classList.add('hidden');

            try {
                const snap = await getDoc(doc(db, "public_courses", courseId));
                if(snap.exists()){
                    const c = snap.data();
                    currentPayingCourse = { id: snap.id, ...c };
                    
                    document.getElementById('payCourseTitle').innerText = c.title;
                    document.getElementById('payCourseImg').src = c.thumbnail || 'https://placehold.co/150';
                    document.getElementById('payOrderId').innerText = `#${Date.now().toString().slice(-6)}`;
                    document.getElementById('payDate').innerText = new Date().toLocaleDateString('vi-VN');
                    
                    let raw = c.price;
                    if (typeof raw === 'string') raw = parseInt(raw.replace(/\D/g, '')) || 0;
                    currentFinalPrice = raw;
                    
                    document.getElementById('payOriginalPrice').innerText = raw.toLocaleString() + 'ƒë';
                    document.getElementById('payFinalPrice').innerText = raw.toLocaleString() + 'ƒë';

                    // [LOGIC M·ªöI] N·∫øu kh√≥a h·ªçc g·ªëc gi√° 0ƒë
                    if (currentFinalPrice === 0) {
                        const btn = document.getElementById('btnCtaAction');
                        btn.innerHTML = '<i class="fa-solid fa-gift"></i> NH·∫¨N MI·ªÑN PH√ç';
                        btn.classList.remove('from-teal-600', 'to-teal-500');
                        btn.classList.add('from-green-600', 'to-green-500');
                        btn.onclick = () => window.activateFreeCourse(null, false);
                        
                        // Disable nh·∫≠p voucher
                        document.getElementById('voucherInput').disabled = true;
                        document.getElementById('voucherInput').placeholder = "Kh√≥a h·ªçc mi·ªÖn ph√≠";
                    }
                }
            } catch(e){ console.error(e); }
        };

        window.applyVoucher = async () => {
            const codeInput = document.getElementById('voucherInput');
            const code = codeInput.value.trim().toUpperCase();
            const msgEl = document.getElementById('voucherMessage');
            
            // L·∫•y gi√° g·ªëc
            let original = 0;
            if (currentPayingCourse) {
                let raw = currentPayingCourse.price;
                if (typeof raw === 'string') raw = parseInt(raw.replace(/\D/g, '')) || 0;
                original = raw;
            }

            // [LOGIC M·ªöI] N·∫øu input tr·ªëng -> Reset v·ªÅ gi√° g·ªëc (H·ªßy voucher)
            if (!code) {
                currentFinalPrice = original;
                currentVoucherCode = null;
                document.getElementById('payDiscountAmount').innerText = '-0ƒë';
                document.getElementById('payFinalPrice').innerText = currentFinalPrice.toLocaleString() + 'ƒë';
                
                msgEl.textContent = "ƒê√£ b·ªè m√£ gi·∫£m gi√°.";
                msgEl.className = "mb-2 text-xs font-bold text-gray-500 block";
                
                // Reset n√∫t thanh to√°n v·ªÅ m·∫∑c ƒë·ªãnh
                resetPaymentButton(); 
                return;
            }

            // N·∫øu c√≥ nh·∫≠p m√£ -> G·ªçi API ki·ªÉm tra
            // Reset n√∫t th√†nh ƒëang t·∫£i
            const btnApply = event.currentTarget || document.querySelector('#voucherInput + button');
            const oldText = btnApply.innerHTML;
            btnApply.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btnApply.disabled = true;

            try {
                const res = await validateVoucher(code, currentPayingCourse.id, original);
                currentFinalPrice = res.finalPrice;
                currentVoucherCode = code;
                
                document.getElementById('payDiscountAmount').innerText = `-${res.discount.toLocaleString()}ƒë`;
                document.getElementById('payFinalPrice').innerText = currentFinalPrice.toLocaleString() + 'ƒë';
                
                msgEl.textContent = `√Åp d·ª•ng m√£ ${code} th√†nh c√¥ng!`;
                msgEl.className = "mb-2 text-xs font-bold text-green-600 block";
                
                // Kh√≥a √¥ input l·∫°i ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ √°p d·ª•ng
                codeInput.disabled = true; 

                // Ki·ªÉm tra n·∫øu gi√° = 0ƒë (X·ª≠ l√Ω n√∫t Nh·∫≠n ngay)
                const btnAction = document.getElementById('btnCtaAction');
                if(btnAction) {
                    if(currentFinalPrice === 0) {
                        btnAction.innerHTML = '<i class="fa-solid fa-gift"></i> NH·∫¨N KH√ìA H·ªåC NGAY';
                        btnAction.classList.remove('from-teal-600', 'to-teal-500');
                        btnAction.classList.add('from-green-600', 'to-green-500');
                        btnAction.onclick = () => window.activateFreeCourse(null, false);
                    } else {
                        resetPaymentButton();
                    }
                }

            } catch (e) {
                msgEl.textContent = e.message;
                msgEl.className = "mb-2 text-xs font-bold text-red-500 block";
                
                // N·∫øu l·ªói th√¨ reset gi√° v·ªÅ g·ªëc lu√¥n cho an to√†n
                currentFinalPrice = original;
                document.getElementById('payFinalPrice').innerText = original.toLocaleString() + 'ƒë';
                document.getElementById('payDiscountAmount').innerText = '-0ƒë';
            } finally {
                btnApply.innerHTML = oldText;
                btnApply.disabled = false;
            }
        };

        // H√†m ph·ª• tr·ª£ ƒë·ªÉ reset n√∫t thanh to√°n v·ªÅ tr·∫°ng th√°i "Ti·∫øp t·ª•c"
        function resetPaymentButton() {
            const btnAction = document.getElementById('btnCtaAction');
            if (btnAction) {
                btnAction.innerHTML = 'Ti·∫øp t·ª•c thanh to√°n <i class="fa-solid fa-arrow-right"></i>';
                btnAction.classList.add('from-teal-600', 'to-teal-500');
                btnAction.classList.remove('from-green-600', 'to-green-500');
                btnAction.onclick = window.generatePaymentQR;
            }
        }

        window.generatePaymentQR = () => {
            document.getElementById('stepReview').classList.add('hidden');
            document.getElementById('stepQR').classList.remove('hidden');
            document.getElementById('stepQR').classList.add('flex');
            const user = auth.currentUser;
            const cleanUid = user.uid.substring(0,5).replace(/[^a-zA-Z0-9]/g, "");
            const cleanCourseId = currentPayingCourse.id.substring(0,5).toUpperCase().replace(/[^a-zA-Z0-9]/g, "");
            const content = `TTOAN ${cleanUid} ${cleanCourseId}`;
            document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_NAME || dynamicBankConfig.BANK_ID;
            document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
            document.getElementById('transferContentDisplay').innerText = content;
            const bankBin = dynamicBankConfig.BANK_ID;
            const accNo = dynamicBankConfig.ACCOUNT_NO;
            const template = dynamicBankConfig.TEMPLATE || 'compact2';
            const amount = currentFinalPrice; 
            const addInfo = encodeURIComponent(content);
            const accName = encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME);
            const qrUrl = `https://img.vietqr.io/image/${bankBin}-${accNo}-${template}.png?amount=${amount}&addInfo=${addInfo}&accountName=${accName}`;
            const img = document.getElementById('vietQrImage');
            img.onload = () => document.getElementById('qrLoading').classList.add('hidden');
            img.src = qrUrl;
        };

        window.confirmPayment = async () => {
            const btn = document.querySelector('#stepQR button');
            const oldBtnContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫°o ƒë∆°n...'; 
            btn.disabled = true;

            try {
                // 1. T·∫°o ƒë∆°n h√†ng l√™n Firebase
                const docRef = await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid,
                    userName: auth.currentUser.displayName || "No Name",
                    courseId: currentPayingCourse.id,
                    courseTitle: currentPayingCourse.title,
                    amount: currentFinalPrice,
                    originalAmount: parseInt(String(currentPayingCourse.price).replace(/\D/g, '')) || 0,
                    voucher: currentVoucherCode || null,
                    status: 'pending',
                    content: document.getElementById('transferContentDisplay').innerText,
                    createdAt: new Date().toISOString()
                });

                // 2. Chuy·ªÉn ƒë·ªïi giao di·ªán: ·∫®n Payment, Hi·ªán Processing
                document.getElementById('paymentModal').classList.add('hidden');
                document.getElementById('processingModal').classList.remove('hidden');
                document.getElementById('processingState').classList.remove('hidden');
                document.getElementById('successState').classList.add('hidden');

                // 3. K√≠ch ho·∫°t l·∫Øng nghe d·ªØ li·ªáu Real-time
                if (processingListener) processingListener(); // H·ªßy c√°i c≈© n·∫øu c√≥

                processingListener = onSnapshot(doc(db, "orders", docRef.id), async (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        
                        // Khi Script Google c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh 'paid'
                        if (data.status === 'paid' || data.status === 'approved') {
                            // a. Hi·ªán th√¥ng b√°o th√†nh c√¥ng
                            document.getElementById('processingState').classList.add('hidden');
                            document.getElementById('successState').classList.remove('hidden');
                            
                            // b. T·ª± ƒë·ªông t·∫£i l·∫°i d·ªØ li·ªáu ƒë·ªÉ ƒë·ªïi n√∫t Mua -> V√†o h·ªçc
                            await loadMyPurchased(auth.currentUser); 
                            await loadMarket(); 
                            
                            // c. D·ª´ng l·∫Øng nghe
                            if (processingListener) {
                                processingListener();
                                processingListener = null;
                            }
                        }
                    }
                });

            } catch(e) { 
                window.showNotification("L·ªói: " + e.message, "error"); 
                btn.innerHTML = oldBtnContent;
                btn.disabled = false;
            }
        };

        // H√†m ƒë√≥ng modal ch·ªù (n·∫øu ng∆∞·ªùi d√πng mu·ªën t·∫Øt tay)
        window.closeProcessingModal = () => {
            if(confirm("H·ªá th·ªëng v·∫´n s·∫Ω ki·ªÉm tra ng·∫ßm. B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng b·∫£ng n√†y?")) {
                document.getElementById('processingModal').classList.add('hidden');
            }
        };

        // H√†m b·∫•m n√∫t "V√†o h·ªçc ngay" sau khi th√†nh c√¥ng
        window.finishPaymentProcess = () => {
            document.getElementById('processingModal').classList.add('hidden');
            window.switchTab('my-courses');
        };

        window.resetQrState = () => {
            document.getElementById('stepQR').classList.add('hidden');
            document.getElementById('stepQR').classList.remove('flex');
            document.getElementById('stepReview').classList.remove('hidden');
            
            // [FIX] M·ªü kh√≥a √¥ nh·∫≠p voucher ƒë·ªÉ s·ª≠a
            document.getElementById('voucherInput').disabled = false;
            document.getElementById('voucherInput').focus();
        };

        // UI Helpers
        window.toggleMobileSidebar = () => {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('mobileOverlay');
            if(sb.classList.contains('sidebar-closed')) { sb.classList.remove('sidebar-closed'); sb.classList.add('sidebar-open'); ov.classList.remove('hidden'); }
            else { sb.classList.add('sidebar-closed'); sb.classList.remove('sidebar-open'); ov.classList.add('hidden'); }
        }
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            const t = document.getElementById('tab-'+id); if(t) t.classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(e=>e.classList.remove('active'));
            const nav = document.getElementById('nav-'+id); if(nav) nav.classList.add('active');
            if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('sidebar-closed'); document.getElementById('mobileOverlay').classList.add('hidden'); }
        };
        window.openProfileModal = () => document.getElementById('profileModal').classList.remove('hidden');
        window.handleLogout = () => signOut(auth).then(() => window.location.href = "index.html");

        // --- L·ªäCH S·ª¨ L√ÄM B√ÄI (ƒê√É FIX TO√ÄN DI·ªÜN) ---
        async function loadExamHistory(user) {
            const tbody = document.getElementById('historyListBody');
            const emptyMsg = document.getElementById('emptyHistoryMsg');
            if(!tbody) return;
            
            // HI·ªÜN SKELETON
            tbody.innerHTML = `
                <tr class="animate-pulse border-b border-gray-50"><td class="p-4"><div class="h-4 bg-gray-200 rounded w-3/4"></div></td><td class="p-4"><div class="h-4 bg-gray-200 rounded w-1/2"></div></td><td class="p-4"><div class="h-4 bg-gray-200 rounded w-1/2"></div></td><td class="p-4 hidden md:table-cell"><div class="h-4 bg-gray-200 rounded w-1/2"></div></td><td class="p-4 text-right"><div class="h-8 bg-gray-200 rounded w-20 ml-auto"></div></td></tr>`.repeat(5);

            try {
                const q = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snap = await getDocs(q);
                if (snap.empty) {
                    tbody.innerHTML = '';
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                emptyMsg.classList.add('hidden');
                let rawResults = [];
                snap.forEach(doc => rawResults.push({ id: doc.id, ...doc.data() }));
                
                const uniqueExamIds = [...new Set(rawResults.map(r => r.examId))];
                const examMap = {};
                await Promise.all(uniqueExamIds.map(async (eid) => {
                    try {
                        const eSnap = await getDoc(doc(db, "exams", eid));
                        if (eSnap.exists()) examMap[eid] = eSnap.data();
                    } catch (e) { console.warn("Kh√¥ng t√¨m th·∫•y ƒë·ªÅ:", eid); }
                }));

                window.allHistoryData = rawResults.map(r => {
                    const exam = examMap[r.examId] || {}; 
                    let type = 'free'; let typeLabel = 'V√£ng lai'; let typeClass = 'bg-gray-100 text-gray-600';
                    if (exam.allowedClassId) { type = 'class'; typeLabel = 'L·ªõp h·ªçc'; typeClass = 'bg-blue-100 text-blue-700'; }
                    else if (exam.courseId || exam.accessType === 'course') { type = 'course'; typeLabel = 'Kh√≥a h·ªçc'; typeClass = 'bg-orange-100 text-orange-700'; }
                    else { type = 'free'; typeLabel = 'T·ª± do'; typeClass = 'bg-purple-100 text-purple-700'; }
                    return { ...r, type, typeLabel, typeClass, examTitle: exam.title || r.examTitle || 'ƒê·ªÅ kh√¥ng t√™n' };
                });
                window.allHistoryData.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                renderHistoryRows(window.allHistoryData);
            } catch (e) { 
                console.error(e);
                tbody.innerHTML = '';
            }
        }

        window.filterHistory = (filterType) => {
            const buttons = document.querySelectorAll('.history-filter');
            buttons.forEach(b => {
                if (window.event && window.event.target === b) {
                    b.classList.add('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');
                    b.classList.remove('text-gray-500', 'border-transparent');
                } else if (!window.event && b.dataset.type === filterType) {
                     b.classList.add('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');
                     b.classList.remove('text-gray-500', 'border-transparent');
                } else {
                    b.classList.remove('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');
                    b.classList.add('text-gray-500', 'border-transparent');
                }
            });
            if (!window.allHistoryData) return;
            let filtered = window.allHistoryData;
            if (filterType !== 'all') {
                filtered = window.allHistoryData.filter(r => r.type === filterType);
            }
            renderHistoryRows(filtered);
        }

        function renderHistoryRows(data) {
            const tbody = document.getElementById('historyListBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.</td></tr>';
                return;
            }
            let html = '';
            data.forEach(r => {
                let dateStr = '---';
                if(r.submittedAt) { try { dateStr = new Date(r.submittedAt).toLocaleString('vi-VN'); } catch(e){} }
                const score = r.score !== undefined ? r.score : 0;
                const scoreColor = score >= 8 ? 'text-green-600' : (score >= 5 ? 'text-orange-500' : 'text-red-500');
                
                let correct = r.correctAnswers; 
                if (correct === undefined) correct = r.correctCount; 
                if (correct === undefined) correct = '?';
                let total = r.totalQuestions;
                if (total === undefined || total === 0) total = '?';
                const detail = `${correct}/${total} c√¢u`;

                const deleteBtn = r.type === 'free' 
                    ? `<button onclick="deleteHistoryItem('${r.id}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition-colors" title="X√≥a l·ªãch s·ª≠"><i class="fa-solid fa-trash"></i></button>` 
                    : `<span class="w-8 h-8 block"></span>`; 

                html += `
                <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-50 last:border-0">
                    <td class="p-4"><div class="font-bold text-gray-800 line-clamp-1" title="${r.examTitle}">${r.examTitle || 'B√†i thi kh√¥ng t√™n'}</div><div class="text-[10px] text-gray-400 font-mono mt-0.5">ID: ${r.examId ? r.examId.substring(0,6) : '---'}</div></td>
                    <td class="p-4"><span class="${r.typeClass || 'bg-gray-100'} px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border border-white shadow-sm">${r.typeLabel || 'Kh√°c'}</span></td>
                    <td class="p-4 font-black ${scoreColor} text-lg">${score}</td>
                    <td class="p-4 hidden md:table-cell text-gray-500 text-xs">${dateStr}</td>
                    <td class="p-4 hidden md:table-cell"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${detail}</span></td>
                    <td class="p-4 text-right"><div class="flex items-center justify-end gap-2"><button onclick="window.location.href='exam.html?id=${r.examId}&mode=review'" class="px-3 py-1.5 bg-white border border-teal-200 text-teal-700 rounded-lg text-xs font-bold hover:bg-teal-50 transition-all shadow-sm">Xem l·∫°i</button>${deleteBtn}</div></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        window.deleteHistoryItem = async (resultId) => {
            const modal = document.getElementById('confirmDeleteModal');
            const btnConfirm = document.getElementById('btnConfirmDelete');
            if(modal) {
                modal.classList.remove('hidden');
                btnConfirm.onclick = async () => {
                    const originalText = btnConfirm.innerHTML;
                    btnConfirm.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang x√≥a...';
                    btnConfirm.disabled = true;
                    try {
                        await deleteDoc(doc(db, "results", resultId));
                        modal.classList.add('hidden');
                        window.showNotification("ƒê√£ x√≥a l·ªãch s·ª≠ l√†m b√†i th√†nh c√¥ng!", "success");
                        if(window.allHistoryData) {
                            window.allHistoryData = window.allHistoryData.filter(r => r.id !== resultId);
                            const activeBtn = document.querySelector('.history-filter.active');
                            const activeType = activeBtn ? activeBtn.dataset.type : 'all';
                            window.filterHistory(activeType);
                        }
                    } catch(e) {
                        modal.classList.add('hidden');
                        if(e.code === 'permission-denied') window.showNotification("L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a b√†i n√†y (Ch·ªâ x√≥a ƒë∆∞·ª£c b√†i c·ªßa ch√≠nh m√¨nh)!", "error");
                        else window.showNotification("L·ªói x√≥a: " + e.message, "error");
                    } finally { btnConfirm.innerHTML = originalText; btnConfirm.disabled = false; }
                };
            } else {
                if(confirm("X√≥a l·ªãch s·ª≠ l√†m b√†i n√†y?")) {
                    deleteDoc(doc(db, "results", resultId))
                        .then(() => { window.showNotification("ƒê√£ x√≥a!", "success"); window.location.reload(); })
                        .catch(e => window.showNotification("L·ªói: " + e.message, "error"));
                }
            }
        }
        // --- 1. H√ÄM H·ª¶Y ƒê∆†N H√ÄNG ---
        window.cancelOrder = async (orderId) => {
            if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y kh√¥ng?")) return;
            try {
                await deleteDoc(doc(db, "orders", orderId));
                window.showNotification("ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!", "success");
                // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
                loadMyPurchased(auth.currentUser);
            } catch(e) {
                window.showNotification("L·ªói h·ªßy ƒë∆°n: " + e.message, "error");
            }
        };

        // --- 2. H√ÄM TI·∫æP T·ª§C THANH TO√ÅN (QUAN TR·ªåNG) ---
        // --- 2. H√ÄM TI·∫æP T·ª§C THANH TO√ÅN (ƒê√£ s·ª≠a l·ªói ·∫£nh & 0ƒë) ---
        window.continuePayment = async (orderDataEncoded) => {
            try {
                const order = JSON.parse(decodeURIComponent(orderDataEncoded));
                
                // [FIX] L·∫•y l·∫°i th√¥ng tin kh√≥a h·ªçc ƒë·ªÉ hi·ªÉn th·ªã ·∫¢nh Thumbnail
                const courseSnap = await getDoc(doc(db, "public_courses", order.courseId));
                const thumb = courseSnap.exists() ? (courseSnap.data().thumbnail || 'https://placehold.co/150') : 'https://placehold.co/150';
                
                // ƒêi·ªÅn th√¥ng tin v√†o Modal Review
                document.getElementById('payCourseTitle').innerText = order.courseTitle;
                document.getElementById('payCourseImg').src = thumb;
                document.getElementById('payOrderId').innerText = order.id.substring(0,6); // D√πng ID ƒë∆°n h√†ng l√†m m√£ hi·ªÉn th·ªã
                document.getElementById('payDate').innerText = new Date(order.createdAt).toLocaleDateString('vi-VN');
                document.getElementById('payOriginalPrice').innerText = (order.originalAmount || order.amount).toLocaleString() + 'ƒë';
                document.getElementById('payFinalPrice').innerText = order.amount.toLocaleString() + 'ƒë';
                
                // [LOGIC M·ªöI] N·∫øu ƒë∆°n h√†ng l√† 0ƒë -> K√≠ch ho·∫°t lu√¥n
                if (order.amount === 0) {
                    if(confirm("ƒê∆°n h√†ng n√†y mi·ªÖn ph√≠. B·∫°n c√≥ mu·ªën k√≠ch ho·∫°t ngay kh√¥ng?")) {
                        await window.activateFreeCourse(order.id, true); // True = l√† ƒë∆°n c≈©
                    }
                    return;
                }

                // N·∫øu c√≥ ti·ªÅn -> Hi·ªán l·∫°i quy tr√¨nh thanh to√°n QR
                document.getElementById('paymentModal').classList.remove('hidden');
                
                // L·∫•y config ng√¢n h√†ng
                if (!dynamicBankConfig) {
                    const s = await getDoc(doc(db, "site_settings", "payment_config"));
                    dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "970422", BANK_NAME: "MB Bank", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ADMIN" };
                }

                // T√°i t·∫°o m√£ QR
                const bankBin = dynamicBankConfig.BANK_ID;
                const accNo = dynamicBankConfig.ACCOUNT_NO;
                const template = dynamicBankConfig.TEMPLATE || 'compact2';
                const content = order.content;
                const qrUrl = `https://img.vietqr.io/image/${bankBin}-${accNo}-${template}.png?amount=${order.amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME)}`;

                // ƒêi·ªÅn data v√†o Modal QR
                document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_NAME;
                document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
                document.getElementById('transferContentDisplay').innerText = content;
                const img = document.getElementById('vietQrImage');
                document.getElementById('qrLoading').classList.remove('hidden');
                img.onload = () => document.getElementById('qrLoading').classList.add('hidden');
                img.src = qrUrl;

                // Chuy·ªÉn sang b∆∞·ªõc QR
                document.getElementById('stepReview').classList.add('hidden');
                document.getElementById('stepQR').classList.remove('hidden');
                document.getElementById('stepQR').classList.add('flex');

                // S·ª≠a n√∫t b·∫•m th√†nh "Theo d√µi ƒë∆°n h√†ng c≈©"
                const btnConfirm = document.querySelector('#stepQR button[onclick^="window."]');
                const newBtn = btnConfirm.cloneNode(true);
                btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
                newBtn.onclick = () => window.watchExistingOrder(order.id);
                newBtn.innerHTML = '<i class="fa-solid fa-check-circle"></i> ƒê√É CHUY·ªÇN KHO·∫¢N XONG';
                
                // ·∫®n n√∫t quay l·∫°i v√¨ ƒë∆°n c≈© kh√¥ng s·ª≠a voucher ƒë∆∞·ª£c n·ªØa
                const backBtn = document.querySelector('#stepQR button[onclick="window.resetQrState()"]');
                if(backBtn) backBtn.style.display = 'none';

            } catch(e) {
                console.error(e);
                window.showNotification("C√≥ l·ªói khi m·ªü l·∫°i ƒë∆°n h√†ng", "error");
            }
        };

        // --- 3. H√ÄM THEO D√ïI ƒê∆†N H√ÄNG C≈® (M·ªõi) ---
        // H√†m n√†y gi·ªëng confirmPayment nh∆∞ng KH√îNG t·∫°o ƒë∆°n m·ªõi, ch·ªâ b·∫≠t ch·∫ø ƒë·ªô l·∫Øng nghe
        window.watchExistingOrder = (orderId) => {
            // ·∫®n modal thanh to√°n, hi·ªán modal ch·ªù
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('processingModal').classList.remove('hidden');
            document.getElementById('processingState').classList.remove('hidden');
            document.getElementById('successState').classList.add('hidden');

            if (processingListener) processingListener();

            processingListener = onSnapshot(doc(db, "orders", orderId), async (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    if (data.status === 'paid' || data.status === 'approved') {
                        document.getElementById('processingState').classList.add('hidden');
                        document.getElementById('successState').classList.remove('hidden');
                        await loadMyPurchased(auth.currentUser); 
                        await loadMarket(); 
                        if (processingListener) { processingListener(); processingListener = null; }
                    }
                } else {
                    // N·∫øu ƒë∆°n h√†ng b·ªã x√≥a trong l√∫c ƒëang ch·ªù
                    window.showNotification("ƒê∆°n h√†ng n√†y kh√¥ng c√≤n t·ªìn t·∫°i.", "error");
                    document.getElementById('processingModal').classList.add('hidden');
                }
            });
        };
        // --- H√ÄM K√çCH HO·∫†T KH√ìA H·ªåC 0 ƒê·ªíNG ---
        window.activateFreeCourse = async (inputData, isExistingOrder = false) => {
            // inputData: l√† courseId (n·∫øu t·∫°o m·ªõi) ho·∫∑c orderId (n·∫øu l√† ƒë∆°n c≈©)
            const loadingHtml = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang k√≠ch ho·∫°t...';
            
            // T√¨m n√∫t b·∫•m ƒë·ªÉ hi·ªán loading (n·∫øu c√≥)
            let btn = document.getElementById('btnCtaAction'); 
            if(btn) { btn.innerHTML = loadingHtml; btn.disabled = true; }

            try {
                if (isExistingOrder) {
                    // TR∆Ø·ªúNG H·ª¢P 1: K√≠ch ho·∫°t t·ª´ ƒë∆°n h√†ng c≈© (ƒê∆°n ch·ªù 0ƒë)
                    await updateDoc(doc(db, "orders", inputData), {
                        status: 'paid', // K√≠ch ho·∫°t lu√¥n
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    // TR∆Ø·ªúNG H·ª¢P 2: T·∫°o ƒë∆°n m·ªõi 0ƒë (Mua m·ªõi ho·∫∑c Voucher 100%)
                    await addDoc(collection(db, "orders"), {
                        userId: auth.currentUser.uid,
                        userName: auth.currentUser.displayName || "No Name",
                        courseId: currentPayingCourse.id,
                        courseTitle: currentPayingCourse.title,
                        amount: 0, // Gi√° 0ƒë
                        originalAmount: parseInt(String(currentPayingCourse.price).replace(/\D/g, '')) || 0,
                        voucher: currentVoucherCode || null,
                        status: 'paid', // K√≠ch ho·∫°t lu√¥n
                        content: "FREE_ACTIVATION",
                        createdAt: new Date().toISOString()
                    });
                }

                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                window.showNotification("K√≠ch ho·∫°t kh√≥a h·ªçc th√†nh c√¥ng!", "success");
                document.getElementById('paymentModal').classList.add('hidden');
                
                // Reload d·ªØ li·ªáu
                await loadMyPurchased(auth.currentUser);
                await loadMarket();
                
                // Chuy·ªÉn tab
                window.switchTab('my-courses');

            } catch(e) {
                console.error(e);
                window.showNotification("L·ªói k√≠ch ho·∫°t: " + e.message, "error");
                if(btn) { btn.innerHTML = "Th·ª≠ l·∫°i"; btn.disabled = false; }
            }
        };
    </script>
</body>
</html>
