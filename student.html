<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√≥c H·ªçc T·∫≠p - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#0F766E', // Quay v·ªÅ m√†u Teal ch·ªß ƒë·∫°o
                        primary: '#0F766E',
                        accent: '#F97316' // M√†u cam l√†m ƒëi·ªÉm nh·∫•n ph·ª•
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F0FDFA; } /* N·ªÅn xanh nh·∫°t */
        /* Sidebar active m√†u Teal */
        .sidebar-item.active { background-color: #E6FFFA; color: #0F766E; font-weight: 800; border-right: 4px solid #0F766E; }
        .sidebar-item:hover:not(.active) { background-color: #F0FDFA; color: #0F766E; }
        
        /* Hi·ªáu ·ª©ng r∆°i trong Sidebar */
        #sidebar { position: relative; overflow: hidden; }
        .falling-item {
            position: absolute; top: -20px; pointer-events: none; user-select: none;
            animation: falling linear infinite; opacity: 0.4; z-index: 1; color: #0F766E;
        }
        @keyframes falling { to { transform: translateY(110vh) rotate(360deg); } }

        /* Scrollbar & Animation */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans">

    <aside id="sidebar" class="w-64 bg-white border-r border-teal-100 flex flex-col shadow-sm z-20 hidden md:flex">
        <div class="h-20 flex items-center px-6 border-b border-teal-100 relative z-10 bg-white/90 backdrop-blur-sm gap-3" id="sidebarHeaderContent">
            <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-blue-500 rounded-xl flex items-center justify-center text-white shadow-sm">
                <i class="fa-solid fa-graduation-cap text-xl"></i>
            </div>
            <span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>
        </div>

        <div class="p-5 border-b border-teal-50 bg-teal-50/50 relative z-10">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="openProfileModal()">
                <img id="userAvatar" src="https://via.placeholder.com/150" class="w-12 h-12 rounded-full border-2 border-white shadow-sm group-hover:border-brand transition-all object-cover">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-base font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <div class="flex items-center gap-1 text-xs text-teal-600 font-bold">
                        <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span> H·ªçc sinh
                    </div>
                </div>
                <i class="fa-solid fa-gear text-gray-300 group-hover:text-brand transition-colors"></i>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-2 overflow-y-auto relative z-10 px-3">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-home w-5"></i> S·∫£nh ch√≠nh
            </button>
            
            <button onclick="switchTab('classes')" id="nav-classes" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-chalkboard-user w-5"></i> L·ªõp h·ªçc c·ªßa t√¥i
            </button>

            <div class="px-4 pt-4 pb-2 text-[10px] font-black text-gray-400 uppercase tracking-wider">H·ªçc li·ªáu & C·ª≠a h√†ng</div>

            <button onclick="switchTab('my-courses')" id="nav-my-courses" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-book-bookmark w-5"></i> Kh√≥a h·ªçc ƒë√£ mua
            </button>

            <button onclick="switchTab('market')" id="nav-market" class="sidebar-item w-full text-left px-4 py-3 text-gray-600 flex items-center gap-3 transition-all rounded-xl">
                <i class="fa-solid fa-store w-5"></i> ƒêƒÉng k√Ω kh√≥a m·ªõi
            </button>
        </nav>

        <div class="p-4 relative z-10 bg-white border-t border-teal-100">
            <button onclick="handleLogout()" class="w-full py-2.5 text-gray-500 hover:text-red-600 hover:bg-red-50 font-bold text-sm flex items-center justify-center gap-2 transition-all rounded-xl">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#F0FDFA] relative">
        <header class="md:hidden h-16 bg-white border-b border-teal-100 px-4 flex items-center justify-between z-20 shrink-0 shadow-sm">
            <span class="font-black text-brand text-lg flex items-center gap-2"><i class="fa-solid fa-graduation-cap"></i> G√≥c H·ªçc T·∫≠p</span>
            <button onclick="handleLogout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-sign-out-alt text-xl"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="mainScrollArea">
            
            <div id="tab-dashboard" class="tab-content space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-teal-600 to-blue-600 rounded-3xl p-8 md:p-12 text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-3xl md:text-4xl font-black mb-3 tracking-tight">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">...</span>! üëã</h1>
                        <p class="text-teal-100 mb-8 text-sm md:text-lg max-w-2xl leading-relaxed">S·∫µn s√†ng cho bu·ªïi h·ªçc h√¥m nay ch∆∞a? Ki·ªÉm tra ngay c√°c b√†i t·∫≠p ƒëang ch·ªù b·∫°n ph√≠a d∆∞·ªõi nh√©!</p>
                        <button onclick="switchTab('classes')" class="bg-white text-teal-700 px-8 py-3 rounded-full font-black hover:bg-teal-50 transition shadow-md text-sm md:text-base flex items-center gap-2">
                            <i class="fa-solid fa-arrow-down"></i> Xem b√†i t·∫≠p ngay
                        </button>
                    </div>
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-white/10 to-transparent skew-x-12 transform origin-top-right"></div>
                    <div class="absolute bottom-0 left-10 w-40 h-40 bg-teal-500/30 rounded-full blur-2xl"></div>
                </div>

                <div>
                    <h3 class="font-bold text-gray-800 text-xl mb-6 flex items-center gap-3">
                        <span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fa-solid fa-clock"></i></span>
                        B√†i t·∫≠p c·∫ßn ho√†n th√†nh (Ch∆∞a l√†m)
                    </h3>
                    <div id="pendingTasksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full py-12 text-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-teal-500 text-3xl mb-4"></i>
                            <p class="text-gray-500 font-medium">ƒêang ki·ªÉm tra b√†i t·∫≠p...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-classes" class="tab-content hidden animate-fade-in">
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-gray-800 mb-2">L·ªõp h·ªçc c·ªßa t√¥i</h2>
                    <p class="text-gray-500">Danh s√°ch c√°c l·ªõp b·∫°n ƒëang tham gia</p>
                </div>
                <div id="myClassesList" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     </div>
            </div>

            <div id="tab-class-detail" class="tab-content hidden animate-fade-in flex flex-col h-full">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 bg-white p-4 rounded-2xl shadow-sm border border-teal-50">
                    <div class="flex items-center gap-4">
                        <button onclick="switchTab('classes')" class="w-12 h-12 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors">
                            <i class="fa-solid fa-arrow-left text-lg"></i>
                        </button>
                        <div>
                            <h2 class="text-2xl font-black text-gray-800 leading-none mb-1" id="detailClassName">T√™n l·ªõp...</h2>
                            <p class="text-sm text-gray-500 font-medium">Danh s√°ch ƒë·ªÅ thi & b√†i t·∫≠p</p>
                        </div>
                    </div>
                    <div>
                        <select onchange="renderClassExams(this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm font-bold rounded-xl focus:ring-teal-500 focus:border-teal-500 block w-full md:w-auto p-3 outline-none transition-all cursor-pointer">
                            <option value="newest">‚ú® M·ªõi nh·∫•t tr∆∞·ªõc</option>
                            <option value="oldest">üìÖ C≈© nh·∫•t tr∆∞·ªõc</option>
                        </select>
                    </div>
                </div>
                
                <div id="classExamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                    </div>
            </div>

            <div id="tab-my-courses" class="tab-content hidden animate-fade-in">
                 <div class="mb-8">
                    <h2 class="text-3xl font-black text-gray-800 mb-2">Kh√≥a h·ªçc ƒë√£ s·ªü h·ªØu</h2>
                    <p class="text-gray-500">C√°c kh√≥a h·ªçc b·∫°n ƒë√£ mua v√† c√≥ th·ªÉ h·ªçc ngay</p>
                </div>
                <div id="myPurchasedList" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    </div>
            </div>

            <div id="tab-market" class="tab-content hidden animate-fade-in">
                 <div class="mb-8">
                    <h2 class="text-3xl font-black text-gray-800 mb-2">C·ª≠a h√†ng kh√≥a h·ªçc</h2>
                    <p class="text-gray-500">Kh√°m ph√° v√† ƒëƒÉng k√Ω th√™m c√°c kh√≥a h·ªçc m·ªõi</p>
                </div>
                <div id="marketList" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    </div>
            </div>

        </div>
    </main>

    <div id="profileModal" class="hidden fixed inset-0 z-[100] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in scale-95 transform transition-all duration-300 border-4 border-teal-50">
            <div class="px-6 py-5 border-b border-gray-100 bg-teal-50/50 flex justify-between items-center">
                <h3 class="text-xl font-black text-gray-800 flex items-center gap-3">
                    <span class="w-8 h-8 bg-teal-100 text-teal-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-id-badge"></i></span>
                    Th√¥ng tin c√° nh√¢n
                </h3>
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
                <div>
                    <h4 class="text-xs font-black text-gray-400 uppercase mb-3 tracking-wider flex items-center gap-2"><i class="fa-solid fa-user-tag"></i> C∆° b·∫£n</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">H·ªç v√† t√™n</label>
                            <input type="text" id="profName" class="w-full px-4 py-3 border border-gray-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-teal-200 focus:border-teal-400 outline-none transition-all bg-gray-50 focus:bg-white">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">Ng√†y sinh</label>
                                <input type="date" id="profDob" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400 bg-gray-50 focus:bg-white font-medium">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">Gi·ªõi t√≠nh</label>
                                <select id="profGender" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400 bg-gray-50 focus:bg-white font-medium cursor-pointer">
                                    <option value="Nam">Nam</option>
                                    <option value="N·ªØ">N·ªØ</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">SƒêT C√° nh√¢n</label>
                                <input type="tel" id="profPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400 bg-gray-50 focus:bg-white font-medium">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">SƒêT Ph·ª• huynh</label>
                                <input type="tel" id="profParentPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-teal-400 bg-gray-50 focus:bg-white font-medium">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-red-50/50 p-5 rounded-2xl border border-red-100">
                    <h4 class="text-xs font-black text-red-600 uppercase mb-3 tracking-wider flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> B·∫£o m·∫≠t</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">T√™n ƒëƒÉng nh·∫≠p (C·ªë ƒë·ªãnh)</label>
                            <input type="text" id="profUsername" disabled class="w-full px-4 py-3 bg-red-50 border border-red-100 rounded-xl text-gray-500 font-mono text-sm font-bold cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1 pl-1">ƒê·ªïi m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="profPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (n·∫øu mu·ªën ƒë·ªïi)..." class="w-full px-4 py-3 border border-red-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-red-200 text-sm font-medium transition-all">
                            <p class="text-[10px] text-red-400 mt-2 flex items-center gap-1 font-medium"><i class="fa-solid fa-circle-info"></i> ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u hi·ªán t·∫°i.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="px-6 py-3 bg-white border-2 border-gray-200 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-100 transition-colors">H·ªßy b·ªè</button>
                <button onclick="saveProfile()" class="px-8 py-3 bg-brand text-white rounded-xl font-bold text-sm shadow-lg hover:bg-teal-700 transition-all flex items-center gap-2 hover:shadow-teal-200 hover:-translate-y-0.5">
                    <i class="fa-solid fa-check"></i> L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>

    <div id="paymentModalContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = ["phamngockhanh.942001@gmail.com", "phamngockhanh.942002@gmail.com", "admin@gmail.com", "phamdinhquang0911@gmail.com"];
        
        let currentClassExams = [];
        let studentResultsMap = {};

        // --- 1. LOAD SITE LOGO & SIDEBAR EFFECT ---
        async function loadSiteLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    const logoUrl = docSnap.data().logo;
                    const headerContent = document.getElementById('sidebarHeaderContent');
                    if(headerContent) {
                        headerContent.innerHTML = `
                            <img src="${logoUrl}" class="w-10 h-10 object-contain drop-shadow-sm">
                            <span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>
                        `;
                    }
                }
            } catch (e) { console.warn("L·ªói t·∫£i Logo:", e); }
        }

        (function applySidebarEffect() {
            const sidebar = document.getElementById('sidebar');
            if(!sidebar) return;
            const today = new Date(); const m = today.getMonth() + 1;
            const items = m === 1 || m === 2 ? "üå∏" : (m === 11 ? "üíê" : (m === 12 ? "‚ùÑÔ∏è" : "üçÇ"));
            for(let i=0; i<8; i++){
                const el = document.createElement('div'); el.classList.add('falling-item'); el.innerHTML = items;
                el.style.left = Math.random() * 80 + '%'; el.style.fontSize = (Math.random() * 10 + 10) + 'px';
                el.style.animationDuration = (Math.random() * 5 + 5) + 's'; el.style.animationDelay = (Math.random() * 5) + 's';
                sidebar.appendChild(el);
            }
        })();

        // --- 2. AUTH & LOAD DATA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (ADMIN_EMAILS.includes(user.email)) {
                    window.location.href = "dashboard.html";
                    return;
                }
                loadSiteLogo(); // T·∫£i logo ƒë·ªông
                loadUserProfile(user);
                loadStudentClasses(user);
                loadMarket();
                loadMyPurchased(user);
                loadPendingTasks(user); // T·∫£i b√†i t·∫≠p ch∆∞a l√†m
            } else {
                window.location.href = "index.html";
            }
        });

        // 3. PROFILE LOGIC
        async function loadUserProfile(user) {
            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                const data = snap.exists() ? snap.data() : {};
                const name = data.displayName || user.displayName || "B·∫°n";
                
                document.getElementById('userName').innerText = name;
                document.getElementById('welcomeName').innerText = name;
                document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=0F766E&color=fff`;

                document.getElementById('profName').value = name;
                let rawUsername = data.username || user.email.split('@')[0];
                if (rawUsername.includes('@')) rawUsername = rawUsername.split('@')[0];
                document.getElementById('profUsername').value = rawUsername;
                document.getElementById('profDob').value = data.birthDate || "";
                document.getElementById('profGender').value = data.gender || "Nam";
                document.getElementById('profPhone').value = data.phone || "";
                document.getElementById('profParentPhone').value = data.phoneParent || "";
            } catch(e) { console.error(e); }
        }

        window.saveProfile = async () => {
            const user = auth.currentUser;
            const name = document.getElementById('profName').value;
            const pass = document.getElementById('profPass').value;
            const btn = document.querySelector('#profileModal button[onclick="saveProfile()"]');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...'; btn.disabled = true;

            try {
                const updates = {
                    displayName: name,
                    birthDate: document.getElementById('profDob').value,
                    gender: document.getElementById('profGender').value,
                    phone: document.getElementById('profPhone').value,
                    phoneParent: document.getElementById('profParentPhone').value
                };
                await updateDoc(doc(db, "users", user.uid), updates);
                await updateProfile(user, { displayName: name });
                if(pass && pass.length > 0) {
                    await updatePassword(user, pass);
                    alert("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin & M·∫≠t kh·∫©u. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                    await signOut(auth); window.location.href = "index.html"; return;
                }
                alert("ƒê√£ l∆∞u th√¥ng tin!");
                document.getElementById('userName').innerText = name;
                document.getElementById('profileModal').classList.add('hidden');
            } catch(e) { 
                alert("L·ªói: " + e.message); 
                if(e.code === 'auth/requires-recent-login') alert("ƒê·ªÉ ƒë·ªïi m·∫≠t kh·∫©u, b·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i!");
            } finally { btn.innerHTML = '<i class="fa-solid fa-check"></i> L∆∞u thay ƒë·ªïi'; btn.disabled = false; }
        }

        // 4. L·ªöP H·ªåC & CHI TI·∫æT L·ªöP
        async function loadStudentClasses(user) {
            const container = document.getElementById('myClassesList');
            try {
                const q = query(collection(db, "classes"));
                const snap = await getDocs(q);
                let html = '';
                snap.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    const isMember = students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid));
                    if (isMember) {
                        html += `
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-teal-50 hover:border-teal-300 hover:shadow-md transition-all cursor-pointer group" onclick="openClassDetail('${doc.id}', '${cl.name}')">
                                <div class="flex justify-between mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-teal-100 text-teal-600 flex items-center justify-center font-bold"><i class="fa-solid fa-chalkboard"></i></div>
                                    <i class="fa-solid fa-arrow-right text-gray-300 group-hover:text-teal-500 transition-colors"></i>
                                </div>
                                <h3 class="font-bold text-xl text-gray-800 mb-1 group-hover:text-teal-700 transition-colors truncate">${cl.name}</h3>
                                <p class="text-sm text-gray-500 font-medium mb-4"><i class="fa-solid fa-user-tie mr-1 text-teal-500"></i> GV: ${cl.teacherName || "Th·∫ßy Choang"}</p>
                                <div class="w-full py-2.5 bg-teal-50 text-teal-700 font-bold text-sm rounded-xl text-center group-hover:bg-teal-600 group-hover:text-white transition-all">V√†o l·ªõp h·ªçc</div>
                            </div>`;
                    }
                });
                container.innerHTML = html || '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><i class="fa-solid fa-school-circle-xmark text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 font-bold">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o.</p></div>';
            } catch(e) { console.error(e); }
        }

        window.openClassDetail = async (classId, className) => {
            window.switchTab('class-detail');
            document.getElementById('detailClassName').textContent = className;
            const container = document.getElementById('classExamList');
            container.innerHTML = '<div class="col-span-full text-center py-16"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-teal-500"></i><p class="mt-2 text-gray-500 font-bold">ƒêang t·∫£i d·ªØ li·ªáu l·ªõp h·ªçc...</p></div>';

            try {
                const user = auth.currentUser;
                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                studentResultsMap = {};
                snapResults.forEach(d => {
                    const r = d.data();
                    if (!studentResultsMap[r.examId] || r.score > studentResultsMap[r.examId].score) {
                        studentResultsMap[r.examId] = r;
                    }
                });

                const qExams = query(collection(db, "exams"), where("accessType", "==", "class"), where("allowedClassId", "==", classId), where("status", "==", "published"));
                const snapExams = await getDocs(qExams);
                currentClassExams = [];
                snapExams.forEach(d => currentClassExams.push({ id: d.id, ...d.data() }));
                renderClassExams('newest');
            } catch (e) { console.error(e); container.innerHTML = '<p class="col-span-full text-red-500 text-center font-bold">L·ªói t·∫£i d·ªØ li·ªáu! Vui l√≤ng th·ª≠ l·∫°i.</p>'; }
        };

        window.renderClassExams = (sortType) => {
            const container = document.getElementById('classExamList');
            if(currentClassExams.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 font-bold">L·ªõp n√†y ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p></div>';
                return;
            }
            currentClassExams.sort((a, b) => {
                const dA = new Date(a.createdAt || 0); const dB = new Date(b.createdAt || 0);
                return sortType === 'newest' ? dB - dA : dA - dB;
            });
            let html = '';
            currentClassExams.forEach(exam => {
                const result = studentResultsMap[exam.id];
                const isDone = !!result;
                let statusBadge = `<span class="text-[10px] font-black bg-gray-100 text-gray-500 px-2.5 py-1 rounded-full uppercase tracking-wider">Ch∆∞a l√†m</span>`;
                let actionBtn = `<button onclick="window.location.href='exam.html?id=${exam.id}'" class="w-full py-3 bg-brand text-white font-bold rounded-xl shadow-sm hover:bg-teal-700 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>`;
                let scoreInfo = '';

                if (isDone) {
                    const score = result.score;
                    let badgeColor = 'bg-blue-100 text-blue-700'; let badgeIcon = '';
                    if (score >= 9) { badgeColor = 'bg-yellow-100 text-yellow-700 animate-pulse'; badgeIcon = '<i class="fa-solid fa-medal mr-1"></i>'; }
                    else if (score >= 8) { badgeColor = 'bg-green-100 text-green-700'; badgeIcon = '<i class="fa-solid fa-award mr-1"></i>'; }
                    statusBadge = `<span class="text-[10px] font-black ${badgeColor} px-2.5 py-1 rounded-full uppercase tracking-wider flex items-center shadow-sm">${badgeIcon} ${score} ƒëi·ªÉm</span>`;
                    actionBtn = `<div class="flex gap-3"><button onclick="window.location.href='exam.html?id=${exam.id}'" class="flex-1 py-3 bg-white border-2 border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 text-sm transition-all">L√†m l·∫°i</button><button onclick="window.location.href='exam.html?id=${exam.id}&mode=review'" class="flex-1 py-3 bg-teal-100 text-teal-700 font-bold rounded-xl hover:bg-teal-200 text-sm transition-all flex items-center justify-center gap-1"><i class="fa-solid fa-eye"></i> Xem l·ªùi gi·∫£i</button></div>`;
                    scoreInfo = `<div class="mt-3 pt-3 border-t border-dashed border-gray-100 flex justify-between items-center text-xs text-gray-500 font-medium"><span>Cao nh·∫•t:</span> <span class="text-gray-800 font-black text-base">${score}ƒë</span></div>`;
                }

                html += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-teal-50 hover:shadow-md transition-all flex flex-col justify-between h-full relative group hover:border-teal-200">
                        ${isDone && result.score >= 9 ? '<div class="absolute -top-3 -right-3 text-3xl filter drop-shadow-md animate-bounce">üèÜ</div>' : ''}
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="w-8 h-8 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center"><i class="fa-regular fa-file-lines"></i></span>
                                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${exam.id.substring(0,6)}</span>
                                </div>
                                ${statusBadge}
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg mb-2 line-clamp-2 group-hover:text-brand transition-colors" title="${exam.title}">${exam.title}</h4>
                            <div class="flex items-center gap-4 text-xs text-gray-500 font-medium">
                                <span class="flex items-center gap-1"><i class="fa-regular fa-clock text-teal-500"></i> ${exam.duration} ph√∫t</span>
                                <span class="flex items-center gap-1"><i class="fa-solid fa-list-ol text-teal-500"></i> ${exam.questionCount||0} c√¢u</span>
                            </div>
                            ${scoreInfo}
                        </div>
                        <div class="mt-5">
                            ${actionBtn}
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        };

        // 5. HELPER FUNCTIONS
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(`tab-${tabId}`);
            if(target) target.classList.remove('hidden');
            const nav = document.getElementById(`nav-${tabId}`);
            if(nav) nav.classList.add('active');
            document.getElementById('mainScrollArea').scrollTop = 0;
        }
        window.openProfileModal = () => document.getElementById('profileModal').classList.remove('hidden');
        window.handleLogout = () => signOut(auth).then(() => window.location.href = "index.html");

        // 6. LOAD PENDING TASKS (CH·ªà HI·ªÜN B√ÄI CH∆ØA L√ÄM)
        async function loadPendingTasks(user) {
            const container = document.getElementById('pendingTasksList');
            if(!container) return;
            try {
                // 1. L·∫•y c√°c l·ªõp h·ªçc sinh tham gia
                const qClasses = query(collection(db, "classes"));
                const snapClasses = await getDocs(qClasses);
                const myClassIds = [];
                snapClasses.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    if (students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid))) {
                        myClassIds.push(doc.id);
                    }
                });

                if (myClassIds.length === 0) { 
                    container.innerHTML = '<div class="col-span-full py-8 text-center bg-white rounded-2xl border border-dashed border-gray-200"><i class="fa-solid fa-mug-hot text-gray-300 text-3xl mb-2"></i><p class="text-gray-500 font-medium">B·∫°n ch∆∞a tham gia l·ªõp n√†o.</p></div>'; 
                    return; 
                }

                // 2. L·∫•y danh s√°ch c√°c b√†i ƒë√£ l√†m
                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                const submittedExamIds = new Set(snapResults.docs.map(d => d.data().examId));

                // 3. L·∫•y b√†i t·∫≠p t·ª´ c√°c l·ªõp v√† L·ªåC b√†i ch∆∞a l√†m
                let pendingExams = [];
                for (const cid of myClassIds) {
                    // L·∫•y t·ªëi ƒëa 5 b√†i m·ªõi nh·∫•t m·ªói l·ªõp ƒë·ªÉ ki·ªÉm tra
                    const qEx = query(collection(db, "exams"), where("allowedClassId", "==", cid), where("status", "==", "published"), orderBy("createdAt", "desc"), limit(5));
                    const snapEx = await getDocs(qEx);
                    snapEx.forEach(d => {
                        if (!submittedExamIds.has(d.id)) { // Ch·ªâ l·∫•y n·∫øu CH∆ØA c√≥ trong danh s√°ch ƒë√£ n·ªôp
                            pendingExams.push({id:d.id, ...d.data()});
                        }
                    });
                }
                
                // S·∫Øp x·∫øp l·∫°i theo th·ªùi gian v√† l·∫•y t·ªëi ƒëa 6 b√†i
                pendingExams.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                pendingExams = pendingExams.slice(0, 6);

                if (pendingExams.length === 0) { 
                    container.innerHTML = '<div class="col-span-full py-8 text-center bg-white rounded-2xl border border-dashed border-gray-200 shadow-sm"><i class="fa-solid fa-circle-check text-teal-500 text-4xl mb-3"></i><p class="text-gray-800 font-bold mb-1">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh h·∫øt b√†i t·∫≠p.</p><p class="text-gray-500 text-sm">H√£y th∆∞ gi√£n ho·∫∑c √¥n t·∫≠p l·∫°i ki·∫øn th·ª©c nh√©.</p></div>'; 
                    return; 
                }

                let html = '';
                pendingExams.forEach(ex => {
                    html += `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-teal-50 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all hover:border-teal-200 group" onclick="window.location.href='exam.html?id=${ex.id}'">
                            <div class="w-14 h-14 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center font-bold shrink-0 relative">
                                <i class="fa-solid fa-file-pen text-xl"></i>
                                <span class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full animate-pulse"></span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                     <span class="text-[10px] font-black text-gray-400 uppercase tracking-wider">B√†i t·∫≠p m·ªõi</span>
                                     <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-0.5 rounded-full">Ch∆∞a l√†m</span>
                                </div>
                                <h4 class="font-bold text-gray-800 text-base line-clamp-1 group-hover:text-brand transition-colors">${ex.title}</h4>
                                <p class="text-xs text-gray-500 font-medium mt-1 flex items-center gap-3">
                                    <span><i class="fa-regular fa-clock text-teal-500"></i> ${ex.duration}p</span>
                                    <span><i class="fa-solid fa-list-ol text-teal-500"></i> ${ex.questionCount||0} c√¢u</span>
                                </p>
                            </div>
                            <button class="text-sm bg-brand text-white w-10 h-10 rounded-full font-bold flex items-center justify-center hover:bg-teal-700 transition-all hover:scale-110 shadow-sm">
                                <i class="fa-solid fa-play ml-0.5"></i>
                            </button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch(e) { console.error(e); }
        }

        // 7. LOAD MARKET & PURCHASED (FULL LOGIC)
        async function loadMarket() {
             const container = document.getElementById('marketList');
             const snap = await getDocs(collection(db, "public_courses"));
             let html = '';
             snap.forEach(d => {
                 const c = d.data();
                 html += `
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-teal-50 hover:shadow-lg transition-all group hover:border-teal-200">
                        <div class="h-36 bg-gray-100 relative overflow-hidden">
                            <img src="${c.thumbnail || 'https://via.placeholder.com/300x200'}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <span class="absolute top-3 left-3 bg-accent text-white text-xs font-black px-2.5 py-1 rounded-full shadow-md uppercase tracking-wider">${c.tag || 'M·ªõi'}</span>
                        </div>
                        <div class="p-5">
                            <h4 class="font-bold text-gray-800 text-base line-clamp-2 mb-2 min-h-[48px] group-hover:text-brand transition-colors">${c.title}</h4>
                            <div class="flex justify-between items-center pt-3 border-t border-dashed border-gray-100">
                                <div class="flex flex-col">
                                     <span class="text-xs text-gray-400 line-through font-medium">${c.originalPrice ? parseInt(c.originalPrice).toLocaleString()+'ƒë' : ''}</span>
                                     <span class="text-accent font-black text-lg">${parseInt(c.price).toLocaleString()}ƒë</span>
                                </div>
                                <button onclick="openPaymentModal('${d.id}')" class="bg-brand text-white text-sm px-4 py-2 rounded-xl font-bold hover:bg-teal-700 transition-all shadow-sm hover:shadow-teal-200 hover:-translate-y-0.5">Mua ngay</button>
                            </div>
                        </div>
                    </div>`;
             });
             container.innerHTML = html || '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><i class="fa-solid fa-store-slash text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 font-bold">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p></div>';
        }

        async function loadMyPurchased(user) {
             const container = document.getElementById('myPurchasedList');
             const q = query(collection(db, "orders"), where("userId", "==", user.uid), where("status", "==", "approved"));
             const snap = await getDocs(q);
             let html = '';
             snap.forEach(d => {
                 const o = d.data();
                 html += `
                    <div class="bg-white p-5 rounded-2xl border border-teal-50 shadow-sm hover:border-teal-300 transition-all group hover:shadow-md">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 rounded-xl bg-teal-100 text-teal-600 flex items-center justify-center font-bold"><i class="fa-solid fa-graduation-cap text-xl"></i></div>
                            <h4 class="font-bold text-gray-800 text-base line-clamp-2 flex-1 group-hover:text-brand transition-colors">${o.courseTitle}</h4>
                        </div>
                        <button class="w-full py-2.5 bg-brand text-white text-sm font-bold rounded-xl group-hover:bg-teal-700 transition-all shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-play"></i> V√†o h·ªçc ngay
                        </button>
                    </div>`;
             });
             container.innerHTML = html || '<div class="col-span-full text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300"><i class="fa-solid fa-box-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 font-bold mb-2">B·∫°n ch∆∞a s·ªü h·ªØu kh√≥a h·ªçc n√†o.</p><button onclick="switchTab(\'market\')" class="text-brand text-sm font-bold hover:underline bg-teal-50 px-4 py-2 rounded-lg">Kh√°m ph√° c·ª≠a h√†ng ngay</button></div>';
        }

        // 8. PAYMENT LOGIC (INJECTED HTML)
        const paymentModalHTML = `
            <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-300">
                <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] border-4 border-teal-50">
                    <div class="w-full md:w-5/12 bg-teal-50/50 p-6 border-r border-teal-100">
                        <h3 class="font-black text-gray-800 mb-4 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-receipt text-brand"></i> Th√¥ng tin ƒë∆°n h√†ng</h3>
                        <div class="space-y-4 text-sm font-medium bg-white p-4 rounded-xl shadow-sm border border-teal-50">
                            <div class="flex justify-between items-start gap-2"><span class="text-gray-500 shrink-0">Kh√≥a h·ªçc:</span> <b id="payCourseTitle" class="text-right text-gray-800 line-clamp-2">...</b></div>
                            <div class="flex justify-between items-center"><span class="text-gray-500">Gi√° ti·ªÅn:</span> <b id="payFinalPrice" class="text-accent text-lg">...</b></div>
                            <div class="h-px bg-gray-100 my-2 border-dashed"></div>
                            <div class="text-xs flex items-center gap-2 text-gray-500"><i class="fa-solid fa-user-circle text-teal-500"></i> <span id="payUserName" class="font-bold text-gray-700">...</span></div>
                        </div>
                    </div>
                    <div class="w-full md:w-7/12 p-6 relative flex flex-col items-center justify-center">
                        <button onclick="document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50"><i class="fa-solid fa-times text-xl"></i></button>
                        <h3 class="font-black text-brand mb-3 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-qrcode"></i> Qu√©t m√£ ƒë·ªÉ thanh to√°n</h3>
                        <div class="relative w-64 h-64 bg-white p-3 rounded-2xl shadow-md border-2 border-teal-100 mb-5">
                            <img id="vietQrImage" class="w-full h-full object-contain rounded-xl">
                            <div id="qrLoading" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center rounded-xl"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-brand mb-2"></i><span class="text-xs font-bold text-brand animate-pulse">ƒêang t·∫°o m√£ QR...</span></div>
                        </div>
                        <div class="text-sm text-center mb-5 w-full bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                            <div class="flex justify-between mb-2"><span>Ng√¢n h√†ng:</span> <b id="bankNameDisplay" class="text-blue-700">...</b></div>
                            <div class="flex justify-between mb-2"><span>S·ªë t√†i kho·∫£n:</span> <b id="accountNoDisplay" class="text-blue-700 font-mono text-base">...</b></div>
                            <div class="flex flex-col items-start bg-white p-3 rounded-lg border border-blue-200 mt-2">
                                <span class="text-xs text-gray-400 font-bold mb-1 uppercase">N·ªôi dung chuy·ªÉn kho·∫£n (B·∫Øt bu·ªôc):</span>
                                <b id="transferContentDisplay" class="text-accent font-mono text-base tracking-wider break-all">...</b>
                            </div>
                        </div>
                        <button onclick="confirmPayment()" class="w-full py-4 bg-brand text-white font-bold rounded-xl shadow-lg hover:bg-teal-700 transition-all flex items-center justify-center gap-2 text-base hover:shadow-teal-200 hover:-translate-y-0.5"><i class="fa-solid fa-check-circle"></i> X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('paymentModalContainer').innerHTML = paymentModalHTML;

        let currentPayingCourse = null;
        let dynamicBankConfig = null;

        window.openPaymentModal = async (courseId) => {
            if (!dynamicBankConfig) {
                try {
                    const s = await getDoc(doc(db, "site_settings", "payment_config"));
                    dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ADMIN", TEMPLATE: "compact2" };
                } catch (e) { dynamicBankConfig = { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ERROR", TEMPLATE: "compact2" }; }
            }
            document.getElementById('paymentModal').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('qrLoading').classList.remove('hidden');

            try {
                const snap = await getDoc(doc(db, "public_courses", courseId));
                if(snap.exists()){
                    const c = snap.data();
                    currentPayingCourse = { id: snap.id, ...c };
                    const user = auth.currentUser;
                    
                    document.getElementById('payCourseTitle').innerText = c.title;
                    document.getElementById('payFinalPrice').innerText = parseInt(c.price).toLocaleString('vi-VN') + 'ƒë';
                    document.getElementById('payUserName').innerText = user.displayName || user.email;

                    const content = `TTOAN ${user.uid.substring(0,5)} ${c.id.substring(0,5).toUpperCase()}`.replace(/[^a-zA-Z0-9 ]/g, "");
                    document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_ID;
                    document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
                    document.getElementById('transferContentDisplay').innerText = content;
                    
                    const qrUrl = `https://img.vietqr.io/image/${dynamicBankConfig.BANK_ID}-${dynamicBankConfig.ACCOUNT_NO}-${dynamicBankConfig.TEMPLATE}.png?amount=${c.price}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME)}`;
                    
                    const qrImg = document.getElementById('vietQrImage');
                    qrImg.onload = () => document.getElementById('qrLoading').classList.add('hidden');
                    qrImg.src = qrUrl;
                }
            } catch(e){ console.error(e); }
        };

        window.confirmPayment = async () => {
             const btn = document.querySelector('button[onclick="confirmPayment()"]');
             btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang g·ª≠i y√™u c·∫ßu...'; btn.disabled = true;
             try {
                await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid,
                    courseId: currentPayingCourse.id,
                    courseTitle: currentPayingCourse.title,
                    amount: parseInt(currentPayingCourse.price),
                    status: 'pending',
                    content: document.getElementById('transferContentDisplay').innerText,
                    createdAt: new Date().toISOString()
                });
                alert("ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng! Vui l√≤ng ch·ªù duy·ªát.");
                document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none');
             } catch(e) { alert("L·ªói: " + e.message); }
             finally { btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N'; btn.disabled = false; }
        };
    </script>
</body>
</html>
