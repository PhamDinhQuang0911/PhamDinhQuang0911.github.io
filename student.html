<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√≥c h·ªçc t·∫≠p - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#0F766E', // Teal 700
                        accent: '#F97316', // Orange 500
                    },
                    fontFamily: { sans: ['Be Vietnam Pro', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #F3F4F6; }
        .sidebar-item { transition: all 0.2s; border-right: 3px solid transparent; }
        .sidebar-item.active { background-color: #ECFDF5; color: #0F766E; border-right-color: #0F766E; font-weight: 700; }
        .sidebar-item:hover:not(.active) { background-color: #F9FAFB; color: #0F766E; }
        /* Scrollbar ·∫©n cho ƒë·∫πp */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-sm z-20 hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <i class="fa-solid fa-graduation-cap text-2xl text-accent mr-2"></i>
            <span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>
        </div>

        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-home w-5"></i> S·∫£nh ch√≠nh
            </button>
            
            <button onclick="switchTab('my-classes')" id="nav-my-classes" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-chalkboard-user w-5"></i> L·ªõp h·ªçc c·ªßa t√¥i
            </button>

            <div class="px-6 pt-4 pb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">H·ªçc t·∫≠p</div>

            <button onclick="switchTab('my-courses')" id="nav-my-courses" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-book-open w-5"></i> Kh√≥a h·ªçc c·ªßa t√¥i
            </button>

            <button onclick="switchTab('all-courses')" id="nav-all-courses" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-cart-shopping w-5"></i> ƒêƒÉng k√Ω kh√≥a m·ªõi
            </button>

            <button onclick="switchTab('chatbot')" id="nav-chatbot" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-robot w-5"></i> Tr·ª£ l√Ω AI (Beta)
            </button>
            <div id="tab-settings" class="tab-content hidden animate-fade-in max-w-4xl">
                <h2 class="text-2xl font-black text-gray-800 mb-6">Th√¥ng tin t√†i kho·∫£n</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Th√¥ng tin c√° nh√¢n</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">H·ªç v√† t√™n</label>
                                <input type="text" id="profileName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="text" id="profilePhone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Email (Kh√¥ng th·ªÉ ƒë·ªïi)</label>
                                <input type="text" id="profileEmail" disabled class="w-full px-4 py-2 bg-gray-100 border rounded-lg text-gray-500 cursor-not-allowed">
                            </div>
                            <button onclick="updateProfileInfo()" class="w-full py-2 bg-brand text-white font-bold rounded-lg hover:bg-teal-800 transition">C·∫≠p nh·∫≠t th√¥ng tin</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">ƒê·ªïi m·∫≠t kh·∫©u</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">M·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" id="newPassword" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand outline-none" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
                            </div>
                            <button onclick="changeUserPassword()" class="w-full py-2 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition">ƒê·ªïi m·∫≠t kh·∫©u</button>
                            <p class="text-xs text-gray-400 italic mt-2">* N·∫øu ƒëƒÉng nh·∫≠p b·∫±ng Google, b·∫°n kh√¥ng c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u t·∫°i ƒë√¢y.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 pt-4 pb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">C√° nh√¢n</div>
            
            <button onclick="switchTab('settings')" id="nav-settings" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-user-gear w-5"></i> T√†i kho·∫£n & B·∫£o m·∫≠t
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3 mb-3">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full border border-gray-200">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p class="text-xs text-green-600 font-medium">‚óè ƒêang ho·∫°t ƒë·ªông</p>
                </div>
            </div>
            <button onclick="handleLogout()" class="w-full py-2 bg-white border border-gray-300 text-gray-600 rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-colors">
                <i class="fa-solid fa-sign-out-alt mr-1"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="md:hidden h-16 bg-white border-b flex items-center justify-between px-4 z-20">
            <div class="font-black text-lg text-brand">Th·∫ßy Choang</div>
            <button class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-[#F3F4F6]">
            
            <div id="tab-dashboard" class="tab-content space-y-8 animate-fade-in">
                <div class="bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl p-6 md:p-10 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform translate-x-20"></div>
                    <div class="relative z-10 max-w-2xl">
                        <span class="bg-white/20 text-white text-xs font-bold px-2 py-1 rounded mb-2 inline-block">Th√¥ng b√°o m·ªõi</span>
                        <h1 class="text-2xl md:text-4xl font-black mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">b·∫°n hi·ªÅn</span>! üëã</h1>
                        <p class="text-blue-100 mb-6 text-sm md:text-base">H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ chinh ph·ª•c c√°c con s·ªë. H√£y xem c√°c b√†i t·∫≠p c·∫ßn ho√†n th√†nh b√™n d∆∞·ªõi nh√©.</p>
                        <button onclick="switchTab('all-courses')" class="bg-white text-blue-700 px-6 py-2 rounded-lg font-bold hover:bg-blue-50 transition shadow-lg text-sm">Kh√°m ph√° kh√≥a h·ªçc</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-list-check text-orange-500"></i> B√†i t·∫≠p c·∫ßn l√†m ngay</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="pendingTasksList">
                        <div class="col-span-full text-center py-10 bg-white rounded-xl border border-dashed border-gray-300">
                            <i class="fa-solid fa-mug-hot text-4xl text-gray-200 mb-3"></i>
                            <p class="text-gray-400 text-sm">Tuy·ªát v·ªùi! B·∫°n kh√¥ng c√≥ b√†i t·∫≠p n√†o qu√° h·∫°n.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-my-classes" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-gray-800">L·ªõp h·ªçc c·ªßa t√¥i</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
                        <i class="fa-solid fa-school text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500 font-bold">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o</p>
                    </div>
                </div>
            </div>

            <div id="tab-my-courses" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-black text-gray-800 mb-6">Kh√≥a h·ªçc ƒë√£ s·ªü h·ªØu</h2>
                <div id="myCoursesList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                     <div class="col-span-full text-center py-16">
                        <i class="fa-solid fa-box-open text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">B·∫°n ch∆∞a mua kh√≥a h·ªçc n√†o.</p>
                        <button onclick="switchTab('all-courses')" class="mt-4 text-brand font-bold hover:underline">ƒê·∫øn c·ª≠a h√†ng ngay</button>
                    </div>
                </div>
            </div>

            <div id="tab-all-courses" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-gray-800">C·ª≠a h√†ng kh√≥a h·ªçc</h2>
                    <div class="flex gap-2">
                        <input type="text" placeholder="T√¨m ki·∫øm..." class="px-4 py-2 rounded-lg border border-gray-200 text-sm">
                    </div>
                </div>
                <div id="allCoursesList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="col-span-full text-center py-10"><i class="fa-solid fa-spinner fa-spin text-2xl text-brand"></i> ƒêang t·∫£i kh√≥a h·ªçc...</div>
                </div>
            </div>

            <div id="tab-chatbot" class="tab-content hidden animate-fade-in h-full flex flex-col">
                <div class="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col items-center justify-center p-10 text-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" class="w-24 h-24 mb-4 opacity-50">
                    <h3 class="text-xl font-bold text-gray-800">Tr·ª£ l√Ω AI ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng</h3>
                    <p class="text-gray-500 max-w-md mt-2">T√≠nh nƒÉng n√†y s·∫Ω s·ªõm ra m·∫Øt ƒë·ªÉ h·ªó tr·ª£ b·∫°n gi·∫£i b√†i t·∫≠p v√† √¥n luy·ªán 24/7.</p>
                </div>
            </div>

        </div>
    </main>

    <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] bg-gray-50 flex flex-col transition-all duration-300">
        </div>

    <script type="module">
        // 1. IMPORT TH∆Ø VI·ªÜN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 2. C·∫§U H√åNH FIREBASE (C·ªßa anh)
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUserData = null;

        // 3. KH·ªûI T·∫†O & PH√ÇN QUY·ªÄN
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Ph√¢n lu·ªìng: N·∫øu l√† Admin/GV th√¨ ƒë√° v·ªÅ Dashboard
                const adminEmails = ["phamngockhanh.942001@gmail.com", "admin@gmail.com"];
                if (adminEmails.includes(user.email)) {
                    window.location.href = "dashboard.html";
                    return;
                }

                // Load th√¥ng tin User t·ª´ Firestore
                try {
                    const uSnap = await getDoc(doc(db, "users", user.uid));
                    currentUserData = uSnap.exists() ? uSnap.data() : {};
                    
                    // ƒêi·ªÅn th√¥ng tin v√†o Sidebar & Header
                    const displayName = currentUserData.displayName || user.displayName || user.email.split('@')[0];
                    document.getElementById('userName').innerText = displayName;
                    document.getElementById('welcomeName').innerText = displayName;
                    
                    // Avatar (∆Øu ti√™n ·∫£nh th·∫≠t -> ·∫£nh UI Avatars)
                    const photoURL = currentUserData.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${displayName}&background=0F766E&color=fff`;
                    document.getElementById('userAvatar').src = photoURL;
                    
                    // ƒêi·ªÅn v√†o Form C√†i ƒë·∫∑t (Tab Settings)
                    if(document.getElementById('profileName')) document.getElementById('profileName').value = displayName;
                    if(document.getElementById('profilePhone')) document.getElementById('profilePhone').value = currentUserData.phone || "";
                    if(document.getElementById('profileEmail')) document.getElementById('profileEmail').value = user.email;

                    // T·∫¢I D·ªÆ LI·ªÜU TH·∫¨T
                    loadMyClasses(user.uid);
                    loadPendingTasks(); 
                    loadMyPurchasedCourses(user.uid);
                    loadAllCourses(); // Marketplace
                    
                } catch (e) { console.error("L·ªói t·∫£i User:", e); }

            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p -> ƒê√° v·ªÅ trang ch·ªß
                window.location.href = "index.html";
            }
        });

        // 4. LOGIC T·∫¢I L·ªöP H·ªåC (MY CLASSES)
        async function loadMyClasses(uid) {
            const container = document.querySelector('#tab-my-classes .grid');
            if(!container) return;
            
            try {
                // T√¨m c√°c l·ªõp m√† h·ªçc sinh c√≥ t√™n trong m·∫£ng 'students'
                const q = query(collection(db, "classes"), where("students", "array-contains", uid));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = `<div class="col-span-full bg-white p-10 rounded-xl text-center"><i class="fa-solid fa-school text-4xl text-gray-300 mb-3"></i><p class="text-gray-500">B·∫°n ch∆∞a ƒë∆∞·ª£c th√™m v√†o l·ªõp h·ªçc n√†o.</p></div>`;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    html += `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-brand transition group relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full bg-brand"></div>
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${c.name}</h3>
                            <p class="text-xs text-gray-500 mb-4"><i class="fa-solid fa-chalkboard-user mr-1"></i> GV: ${c.teacherName || "Th·∫ßy Choang"}</p>
                            <div class="flex justify-between items-center mt-4">
                                <span class="text-xs bg-teal-50 text-teal-700 px-2 py-1 rounded font-bold">${c.schedule || "L·ªãch h·ªçc: C·∫≠p nh·∫≠t sau"}</span>
                                <button class="text-brand font-bold text-sm hover:underline">V√†o l·ªõp <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) { 
                console.error("L·ªói t·∫£i l·ªõp:", e); 
                container.innerHTML = `<p class="text-red-500 text-sm">L·ªói t·∫£i d·ªØ li·ªáu l·ªõp h·ªçc.</p>`;
            }
        }

        // 5. LOGIC T·∫¢I B√ÄI T·∫¨P/ƒê·ªÄ THI (PENDING TASKS)
        async function loadPendingTasks() {
            const container = document.getElementById('pendingTasksList');
            if(!container) return;

            try {
                // L·∫•y danh s√°ch ƒë·ªÅ thi (exams) m·ªõi nh·∫•t
                const q = query(collection(db, "exams"), orderBy("createdAt", "desc")); 
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = `<div class="col-span-full text-center py-10 bg-white rounded-xl border border-dashed border-gray-300"><p class="text-gray-400">Hi·ªán ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p></div>`;
                    return;
                }

                let html = '';
                let count = 0;
                snapshot.forEach(doc => {
                    if(count >= 6) return; // Ch·ªâ hi·ªán 6 b√†i
                    const exam = doc.data();
                    html += `
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-1 rounded uppercase">ƒê·ªÅ thi</span>
                                <span class="text-xs text-gray-400">${exam.createdAt ? new Date(exam.createdAt).toLocaleDateString('vi-VN') : 'M·ªõi'}</span>
                            </div>
                            <h4 class="font-bold text-gray-800 text-sm mb-3 line-clamp-2">${exam.title}</h4>
                            <div class="mt-auto pt-3 border-t border-gray-100 flex justify-between items-center">
                                <span class="text-xs text-gray-500"><i class="fa-regular fa-clock"></i> ${exam.duration || 45}p</span>
                                <button onclick="window.location.href='exam_view.html?id=${doc.id}'" class="text-xs bg-brand text-white font-bold px-3 py-1.5 rounded hover:bg-teal-800">L√†m b√†i</button>
                            </div>
                        </div>
                    `;
                    count++;
                });
                container.innerHTML = html;
            } catch (e) { console.error("L·ªói t·∫£i b√†i t·∫≠p:", e); }
        }

        // 6. LOGIC T·∫¢I KH√ìA H·ªåC C·ª¶A T√îI
        async function loadMyPurchasedCourses(uid) {
            const container = document.getElementById('myCoursesList');
            if(!container) return;

            try {
                const q = query(collection(db, "orders"), where("userId", "==", uid), where("status", "==", "approved"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    return; // Gi·ªØ nguy√™n placeholder "Ch∆∞a mua kh√≥a n√†o"
                }

                let html = '';
                snapshot.forEach(doc => {
                    const order = doc.data();
                    html += `
                         <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col group">
                            <div class="h-32 bg-gray-100 relative overflow-hidden">
                                <img src="https://via.placeholder.com/300?text=Course" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                <div class="absolute inset-0 bg-black/10"></div>
                                <span class="absolute bottom-2 right-2 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded"><i class="fa-solid fa-check-circle"></i> ƒê√£ s·ªü h·ªØu</span>
                            </div>
                            <div class="p-4 flex-1 flex flex-col">
                                <h4 class="font-bold text-gray-800 text-sm mb-2 line-clamp-2">${order.courseTitle}</h4>
                                <button class="w-full mt-auto bg-orange-500 text-white text-xs font-bold py-2 rounded hover:bg-orange-600 transition">V√†o h·ªçc ngay</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        // 7. C·∫¨P NH·∫¨T TH√îNG TIN & ƒê·ªîI PASS
        window.updateProfileInfo = async () => {
            const name = document.getElementById('profileName').value;
            const phone = document.getElementById('profilePhone').value;
            const btn = document.querySelector('button[onclick="updateProfileInfo()"]');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';
            try {
                const user = auth.currentUser;
                // C·∫≠p nh·∫≠t Auth Profile
                await updateProfile(user, { displayName: name });
                // C·∫≠p nh·∫≠t Firestore
                await updateDoc(doc(db, "users", user.uid), {
                    displayName: name,
                    phone: phone
                });
                alert("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!");
                document.getElementById('userName').innerText = name;
                document.getElementById('welcomeName').innerText = name;
            } catch (e) { alert("L·ªói: " + e.message); }
            finally { btn.innerText = 'C·∫≠p nh·∫≠t th√¥ng tin'; }
        };

        window.changeUserPassword = async () => {
            const newPass = document.getElementById('newPassword').value;
            if (newPass.length < 6) return alert("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª±!");
            
            try {
                await updatePassword(auth.currentUser, newPass);
                alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                await signOut(auth);
                window.location.href = "index.html";
            } catch (e) { alert("L·ªói: " + e.message + "\n(L∆∞u √Ω: B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i g·∫ßn ƒë√¢y ƒë·ªÉ ƒë·ªïi pass)"); }
        };

        // 8. UI HANDLERS (Switch Tab & Logout)
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
        };
        window.handleLogout = () => signOut(auth).then(() => window.location.href = "index.html");

        // 9. LOGIC MARKETPLACE (C·ª≠a h√†ng kh√≥a h·ªçc)
        async function loadAllCourses() {
            const container = document.getElementById('allCoursesList');
            if(!container) return;
            try {
                const snapshot = await getDocs(collection(db, "public_courses"));
                if (snapshot.empty) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o ƒë∆∞·ª£c m·ªü b√°n.</p>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const priceDisplay = parseInt(c.price) > 0 ? parseInt(c.price).toLocaleString('vi-VN') + 'ƒë' : 'Mi·ªÖn ph√≠';
                    html += `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow flex flex-col">
                            <div class="h-40 bg-gray-100 relative group">
                                <img src="${c.image || c.thumbnail || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                <span class="absolute top-2 right-2 bg-black/60 text-white text-[10px] font-bold px-2 py-1 rounded backdrop-blur-sm">${c.tag || 'Kh√≥a h·ªçc'}</span>
                            </div>
                            <div class="p-4 flex-1 flex flex-col">
                                <h4 class="font-bold text-gray-800 line-clamp-2 mb-2 min-h-[40px]">${c.title}</h4>
                                <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-100">
                                    <span class="text-orange-600 font-black">${priceDisplay}</span>
                                    <button onclick="openPaymentModal('${doc.id}')" class="bg-brand text-white text-xs font-bold px-3 py-2 rounded hover:bg-teal-800 transition flex items-center gap-1"><i class="fa-solid fa-cart-plus"></i> ƒêƒÉng k√Ω</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        // 10. LOGIC THANH TO√ÅN (VIETQR - INJECTED)
        // Inject Modal HTML v√†o cu·ªëi body (V√¨ student.html ch∆∞a c√≥ s·∫µn Modal nh∆∞ index)
        const paymentModalHTML = `
            <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-300">
                <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh]">
                     <div class="w-full md:w-5/12 bg-gray-50 p-6 border-r border-gray-100">
                        <h3 class="font-black text-gray-800 mb-4 uppercase">Th√¥ng tin ƒë∆°n h√†ng</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">Kh√≥a h·ªçc:</span> <b id="payCourseTitle" class="text-right">...</b></div>
                            <div class="flex justify-between"><span class="text-gray-500">Gi√° ti·ªÅn:</span> <b id="payFinalPrice" class="text-orange-600">...</b></div>
                            <div class="h-px bg-gray-200 my-2"></div>
                            <div class="text-xs bg-white p-2 rounded border"><i class="fa-solid fa-user"></i> <span id="payUserName">...</span></div>
                        </div>
                    </div>
                    <div class="w-full md:w-7/12 p-6 relative flex flex-col">
                        <button onclick="closePaymentModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-2xl"></i></button>
                        <div class="text-center flex-1 flex flex-col items-center justify-center">
                            <h3 class="font-black text-brand mb-2">QU√âT M√É ƒê·ªÇ THANH TO√ÅN</h3>
                            <div class="relative w-56 h-56 bg-white p-2 rounded shadow-lg border border-gray-200 mb-4">
                                <img id="vietQrImage" class="w-full h-full object-contain">
                                <div id="qrLoading" class="absolute inset-0 bg-white flex flex-col items-center justify-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-brand"></i><span class="text-xs mt-2">ƒêang t·∫°o m√£...</span></div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded w-full text-left text-sm border border-orange-100 mb-4">
                                <div class="flex justify-between"><span>NH:</span> <b id="bankNameDisplay">...</b></div>
                                <div class="flex justify-between"><span>S·ªë TK:</span> <b id="accountNoDisplay">...</b></div>
                                <div class="flex justify-between"><span>N·ªôi dung:</span> <b id="transferContentDisplay" class="text-brand">...</b></div>
                            </div>
                            <button onclick="confirmPayment()" class="w-full py-3 bg-brand text-white font-bold rounded-lg shadow hover:bg-teal-800">X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', paymentModalHTML);

        let currentPayingCourse = null;
        let dynamicBankConfig = null;

        window.openPaymentModal = async (courseId) => {
            // T·∫£i c·∫•u h√¨nh Bank
            if (!dynamicBankConfig) {
                try {
                    const s = await getDoc(doc(db, "site_settings", "payment_config"));
                    dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ADMIN", TEMPLATE: "compact2" };
                } catch (e) { dynamicBankConfig = { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ERROR", TEMPLATE: "compact2" }; }
            }

            document.getElementById('paymentModal').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('qrLoading').classList.remove('hidden');

            try {
                const snap = await getDoc(doc(db, "public_courses", courseId));
                if(snap.exists()){
                    const c = snap.data();
                    currentPayingCourse = { id: snap.id, ...c };
                    const user = auth.currentUser;
                    
                    // ƒêi·ªÅn th√¥ng tin
                    document.getElementById('payCourseTitle').innerText = c.title;
                    document.getElementById('payFinalPrice').innerText = parseInt(c.price).toLocaleString('vi-VN') + 'ƒë';
                    document.getElementById('payUserName').innerText = user.displayName || user.email;

                    // T·∫°o QR
                    const content = `TTOAN ${user.uid.substring(0,5)} ${c.id.substring(0,5).toUpperCase()}`.replace(/[^a-zA-Z0-9 ]/g, "");
                    document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_ID;
                    document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
                    document.getElementById('transferContentDisplay').innerText = content;
                    
                    const qrUrl = `https://img.vietqr.io/image/${dynamicBankConfig.BANK_ID}-${dynamicBankConfig.ACCOUNT_NO}-${dynamicBankConfig.TEMPLATE}.png?amount=${c.price}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME)}`;
                    
                    const qrImg = document.getElementById('vietQrImage');
                    qrImg.onload = () => document.getElementById('qrLoading').classList.add('hidden');
                    qrImg.src = qrUrl;
                }
            } catch(e){ console.error(e); }
        };

        window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none');
        
        window.confirmPayment = async () => {
             const btn = document.querySelector('button[onclick="confirmPayment()"]');
             btn.innerText = "ƒêang g·ª≠i..."; btn.disabled = true;
             try {
                await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid,
                    courseId: currentPayingCourse.id,
                    courseTitle: currentPayingCourse.title,
                    amount: parseInt(currentPayingCourse.price),
                    status: 'pending',
                    content: document.getElementById('transferContentDisplay').innerText,
                    createdAt: new Date().toISOString()
                });
                alert("G·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
                window.closePaymentModal();
             } catch(e) { alert("L·ªói: " + e.message); }
             finally { btn.innerText = "X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN"; btn.disabled = false; }
        };

    </script>
</body>
</html>
