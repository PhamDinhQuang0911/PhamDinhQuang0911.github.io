<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√≥c H·ªçc T·∫≠p - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#F97316', // Cam ch·ªß ƒë·∫°o
                        primary: '#F97316',
                        secondary: '#8B5CF6' // T√≠m
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .sidebar-item.active { background-color: #FFF7ED; color: #C2410C; font-weight: 800; border-right: 3px solid #F97316; }
        .sidebar-item:hover:not(.active) { background-color: #F9FAFB; color: #F97316; }
        
        /* Hi·ªáu ·ª©ng r∆°i trong Sidebar */
        #sidebar { position: relative; overflow: hidden; }
        .falling-item {
            position: absolute; top: -20px; pointer-events: none; user-select: none;
            animation: falling linear infinite; opacity: 0.6; z-index: 1;
        }
        @keyframes falling { to { transform: translateY(110vh) rotate(360deg); } }

        /* Scrollbar & Animation */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-sm z-20 hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-gray-100 relative z-10 bg-white/90 backdrop-blur-sm">
            <i class="fa-solid fa-graduation-cap text-2xl text-orange-500 mr-2"></i>
            <span class="font-black text-xl text-gray-800">Th·∫ßy Choang</span>
        </div>

        <div class="p-4 border-b border-gray-100 bg-orange-50 relative z-10">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="openProfileModal()">
                <img id="userAvatar" src="https://via.placeholder.com/150" class="w-10 h-10 rounded-full border-2 border-white shadow-sm group-hover:border-orange-300 transition-all object-cover">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p class="text-xs text-orange-600 font-bold">H·ªçc sinh</p>
                </div>
                <i class="fa-solid fa-gear text-gray-400 group-hover:text-orange-500 transition-colors"></i>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-1 overflow-y-auto relative z-10">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3 transition-colors">
                <i class="fa-solid fa-home w-5"></i> S·∫£nh ch√≠nh
            </button>
            
            <button onclick="switchTab('classes')" id="nav-classes" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3 transition-colors">
                <i class="fa-solid fa-users-rectangle w-5"></i> L·ªõp h·ªçc c·ªßa t√¥i
            </button>

            <div class="px-6 pt-4 pb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">H·ªçc li·ªáu</div>

            <button onclick="switchTab('my-courses')" id="nav-my-courses" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3 transition-colors">
                <i class="fa-solid fa-book-open w-5"></i> Kh√≥a h·ªçc ƒë√£ mua
            </button>

            <button onclick="switchTab('market')" id="nav-market" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3 transition-colors">
                <i class="fa-solid fa-cart-plus w-5"></i> ƒêƒÉng k√Ω kh√≥a m·ªõi
            </button>
        </nav>

        <div class="p-4 border-t border-gray-200 relative z-10 bg-white">
            <button onclick="handleLogout()" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#F3F4F6] relative">
        <header class="md:hidden h-16 bg-white border-b px-4 flex items-center justify-between z-20 shrink-0 shadow-sm">
            <span class="font-black text-orange-600 text-lg">G√≥c H·ªçc T·∫≠p</span>
            <button onclick="handleLogout()" class="text-gray-500"><i class="fa-solid fa-sign-out-alt"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="mainScrollArea">
            
            <div id="tab-dashboard" class="tab-content space-y-8 animate-fade-in">
                <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-2xl p-6 md:p-10 text-white shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <span class="bg-white/20 text-white text-xs font-bold px-2 py-1 rounded mb-2 inline-block">Th√¥ng b√°o m·ªõi</span>
                        <h1 class="text-2xl md:text-3xl font-black mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">...</span>! üëã</h1>
                        <p class="text-orange-100 mb-6 text-sm md:text-base max-w-xl">H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ chinh ph·ª•c c√°c con s·ªë. H√£y xem c√°c b√†i t·∫≠p c·∫ßn ho√†n th√†nh b√™n d∆∞·ªõi nh√©.</p>
                        <button onclick="switchTab('market')" class="bg-white text-orange-600 px-6 py-2 rounded-lg font-bold hover:bg-orange-50 transition shadow-lg text-sm">Kh√°m ph√° kh√≥a h·ªçc</button>
                    </div>
                    <div class="absolute right-0 top-0 h-full w-1/3 bg-white/10 skew-x-12 transform translate-x-10"></div>
                    <div class="absolute -bottom-10 right-20 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>
                </div>

                <div>
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-clock text-orange-500"></i> B√†i t·∫≠p c·∫ßn l√†m ngay</h3>
                    <div id="pendingTasksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full bg-white p-8 rounded-xl text-center border border-dashed border-gray-300">
                            <i class="fa-solid fa-spinner fa-spin text-orange-500 text-3xl mb-2"></i>
                            <p class="text-gray-400 text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-classes" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-black text-gray-800 mb-6 border-l-4 border-orange-500 pl-3">L·ªõp h·ªçc c·ªßa t√¥i</h2>
                <div id="myClassesList" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     </div>
            </div>

            <div id="tab-class-detail" class="tab-content hidden animate-fade-in flex flex-col h-full">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="switchTab('classes')" class="w-10 h-10 rounded-full bg-white border border-gray-200 hover:bg-gray-100 flex items-center justify-center text-gray-600 transition-colors shadow-sm">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-black text-gray-800" id="detailClassName">T√™n l·ªõp...</h2>
                        <p class="text-sm text-gray-500">Danh s√°ch b√†i t·∫≠p & ƒë·ªÅ thi</p>
                    </div>
                    <div class="ml-auto">
                        <select onchange="renderClassExams(this.value)" class="bg-white border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-2 outline-none shadow-sm">
                            <option value="newest">M·ªõi nh·∫•t tr∆∞·ªõc</option>
                            <option value="oldest">C≈© nh·∫•t tr∆∞·ªõc</option>
                        </select>
                    </div>
                </div>
                
                <div id="classExamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                    </div>
            </div>

            <div id="tab-my-courses" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-black text-gray-800 mb-6 border-l-4 border-purple-500 pl-3">Kh√≥a h·ªçc ƒë√£ s·ªü h·ªØu</h2>
                <div id="myPurchasedList" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    </div>
            </div>

            <div id="tab-market" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-black text-gray-800 mb-6 border-l-4 border-blue-500 pl-3">C·ª≠a h√†ng kh√≥a h·ªçc</h2>
                <div id="marketList" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    </div>
            </div>

        </div>
    </main>

    <div id="profileModal" class="hidden fixed inset-0 z-[100] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in scale-95 transform transition-all duration-300">
            <div class="px-6 py-4 border-b border-gray-100 bg-orange-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-id-card text-orange-600"></i> Th√¥ng tin c√° nh√¢n
                </h3>
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-5 max-h-[80vh] overflow-y-auto custom-scrollbar">
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">Th√¥ng tin c∆° b·∫£n</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">H·ªç v√† t√™n</label>
                            <input type="text" id="profName" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl font-bold text-gray-800 focus:ring-2 focus:ring-orange-200 outline-none transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Ng√†y sinh</label>
                                <input type="date" id="profDob" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-orange-400">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Gi·ªõi t√≠nh</label>
                                <select id="profGender" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-gray-700 bg-white outline-none focus:border-orange-400">
                                    <option value="Nam">Nam</option>
                                    <option value="N·ªØ">N·ªØ</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">SƒêT C√° nh√¢n</label>
                                <input type="tel" id="profPhone" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-orange-400">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">SƒêT Ph·ª• huynh</label>
                                <input type="tel" id="profParentPhone" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-gray-700 outline-none focus:border-orange-400 bg-gray-50">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-600 uppercase mb-3 tracking-wider">T√†i kho·∫£n & B·∫£o m·∫≠t</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">T√™n ƒëƒÉng nh·∫≠p (Kh√¥ng th·ªÉ s·ª≠a)</label>
                            <input type="text" id="profUsername" disabled class="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-xl text-gray-500 font-mono text-sm cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ƒê·ªïi m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="profPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (n·∫øu mu·ªën ƒë·ªïi)..." class="w-full px-4 py-2.5 border border-blue-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-blue-200 text-sm">
                            <p class="text-[10px] text-gray-400 mt-1 italic">* ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="px-5 py-2.5 bg-white border border-gray-300 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-100 transition-colors">H·ªßy b·ªè</button>
                <button onclick="saveProfile()" class="px-6 py-2.5 bg-orange-600 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-orange-700 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>

    <div id="paymentModalContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = ["phamngockhanh.942001@gmail.com", "phamngockhanh.942002@gmail.com", "admin@gmail.com", "phamdinhquang0911@gmail.com"];
        
        let currentClassExams = [];
        let studentResultsMap = {};

        // --- 1. SIDEBAR EFFECT (HI·ªÜU ·ª®NG R∆†I) ---
        (function applySidebarEffect() {
            const sidebar = document.getElementById('sidebar');
            if(!sidebar) return;
            
            const today = new Date(); const m = today.getMonth() + 1;
            // Config gi·ªëng index: T·∫øt (Hoa), 20/11 (Hoa), M√πa ƒê√¥ng (Tuy·∫øt), M√πa Thu (L√°)
            const items = m === 1 || m === 2 ? "üå∏" : (m === 11 ? "üíê" : (m === 12 ? "‚ùÑÔ∏è" : "üçÇ"));
            
            // T·∫°o 10 h·∫°t r∆°i ng·∫´u nhi√™n trong sidebar
            for(let i=0; i<8; i++){
                const el = document.createElement('div');
                el.classList.add('falling-item');
                el.innerHTML = items;
                el.style.left = Math.random() * 80 + '%'; // R∆°i trong ph·∫°m vi width sidebar
                el.style.fontSize = (Math.random() * 10 + 10) + 'px';
                el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                el.style.animationDelay = (Math.random() * 5) + 's';
                sidebar.appendChild(el);
            }
        })();

        // --- 2. AUTH & LOAD DATA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (ADMIN_EMAILS.includes(user.email)) {
                    window.location.href = "dashboard.html";
                    return;
                }
                loadUserProfile(user);
                loadStudentClasses(user);
                loadMarket();
                loadMyPurchased(user);
                loadPendingTasks(user);
            } else {
                window.location.href = "index.html";
            }
        });

        // 3. PROFILE LOGIC (C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 1)
        async function loadUserProfile(user) {
            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                const data = snap.exists() ? snap.data() : {};
                const name = data.displayName || user.displayName || "B·∫°n";
                
                document.getElementById('userName').innerText = name;
                document.getElementById('welcomeName').innerText = name;
                document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=F97316&color=fff`;

                // Fill Modal
                document.getElementById('profName').value = name;
                
                // X·ª≠ l√Ω username: B·ªè @hocsinh.com
                let rawUsername = data.username || user.email.split('@')[0];
                if (rawUsername.includes('@')) rawUsername = rawUsername.split('@')[0];
                document.getElementById('profUsername').value = rawUsername;
                
                document.getElementById('profDob').value = data.birthDate || "";
                document.getElementById('profGender').value = data.gender || "Nam";
                document.getElementById('profPhone').value = data.phone || "";
                document.getElementById('profParentPhone').value = data.phoneParent || "";

            } catch(e) { console.error(e); }
        }

        window.saveProfile = async () => {
            const user = auth.currentUser;
            const name = document.getElementById('profName').value;
            const pass = document.getElementById('profPass').value;
            const btn = document.querySelector('#profileModal button[onclick="saveProfile()"]');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...'; btn.disabled = true;

            try {
                const updates = {
                    displayName: name,
                    birthDate: document.getElementById('profDob').value,
                    gender: document.getElementById('profGender').value,
                    phone: document.getElementById('profPhone').value,
                    phoneParent: document.getElementById('profParentPhone').value
                };

                await updateDoc(doc(db, "users", user.uid), updates);
                await updateProfile(user, { displayName: name });
                
                if(pass && pass.length > 0) {
                    await updatePassword(user, pass);
                    alert("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin & M·∫≠t kh·∫©u. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
                    await signOut(auth);
                    window.location.href = "index.html";
                    return;
                }
                
                alert("ƒê√£ l∆∞u th√¥ng tin!");
                document.getElementById('userName').innerText = name;
                document.getElementById('profileModal').classList.add('hidden');
            } catch(e) { 
                alert("L·ªói: " + e.message); 
                if(e.code === 'auth/requires-recent-login') alert("ƒê·ªÉ ƒë·ªïi m·∫≠t kh·∫©u, b·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i!");
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-save"></i> L∆∞u thay ƒë·ªïi'; btn.disabled = false;
            }
        }

        // 4. L·ªöP H·ªåC & CHI TI·∫æT L·ªöP (Y√äU C·∫¶U 2)
        async function loadStudentClasses(user) {
            const container = document.getElementById('myClassesList');
            try {
                const q = query(collection(db, "classes"));
                const snap = await getDocs(q);
                let html = '';
                
                snap.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    const isMember = students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid));

                    if (isMember) {
                        html += `
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:border-orange-300 transition-all cursor-pointer group" onclick="openClassDetail('${doc.id}', '${cl.name}')">
                                <div class="flex justify-between mb-4">
                                    <span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded uppercase">L·ªõp h·ªçc</span>
                                    <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-orange-500 transition-colors"></i>
                                </div>
                                <h3 class="font-bold text-xl text-gray-800 mb-1 group-hover:text-orange-600 transition-colors">${cl.name}</h3>
                                <p class="text-xs text-gray-500 mb-4"><i class="fa-solid fa-chalkboard-user mr-1"></i> GV: ${cl.teacherName || "Th·∫ßy Choang"}</p>
                                <div class="w-full py-2 bg-orange-50 text-orange-600 font-bold text-sm rounded-lg text-center group-hover:bg-orange-500 group-hover:text-white transition-all">V√†o l·ªõp</div>
                            </div>`;
                    }
                });
                container.innerHTML = html || '<p class="col-span-full text-center text-gray-400 py-10">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o.</p>';
            } catch(e) { console.error(e); }
        }

        window.openClassDetail = async (classId, className) => {
            window.switchTab('class-detail');
            document.getElementById('detailClassName').textContent = className;
            const container = document.getElementById('classExamList');
            container.innerHTML = '<div class="col-span-full text-center py-10"><i class="fa-solid fa-spinner fa-spin text-2xl text-orange-500"></i></div>';

            try {
                // 1. L·∫•y k·∫øt qu·∫£ thi c·ªßa h·ªçc sinh tr∆∞·ªõc
                const user = auth.currentUser;
                const qResults = query(collection(db, "results"), where("studentId", "==", user.uid));
                const snapResults = await getDocs(qResults);
                studentResultsMap = {};
                snapResults.forEach(d => {
                    const r = d.data();
                    if (!studentResultsMap[r.examId] || r.score > studentResultsMap[r.examId].score) {
                        studentResultsMap[r.examId] = r; // L∆∞u k·∫øt qu·∫£ cao nh·∫•t
                    }
                });

                // 2. L·∫•y danh s√°ch ƒë·ªÅ thi c·ªßa l·ªõp
                const qExams = query(collection(db, "exams"), where("accessType", "==", "class"), where("allowedClassId", "==", classId), where("status", "==", "published"));
                const snapExams = await getDocs(qExams);
                
                currentClassExams = [];
                snapExams.forEach(d => currentClassExams.push({ id: d.id, ...d.data() }));
                
                renderClassExams('newest');

            } catch (e) { console.error(e); container.innerHTML = '<p class="col-span-full text-red-500 text-center">L·ªói t·∫£i d·ªØ li·ªáu!</p>'; }
        };

        window.renderClassExams = (sortType) => {
            const container = document.getElementById('classExamList');
            if(currentClassExams.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</div>';
                return;
            }

            // S·∫Øp x·∫øp
            currentClassExams.sort((a, b) => {
                const dA = new Date(a.createdAt || 0);
                const dB = new Date(b.createdAt || 0);
                return sortType === 'newest' ? dB - dA : dA - dB;
            });

            let html = '';
            currentClassExams.forEach(exam => {
                const result = studentResultsMap[exam.id];
                const isDone = !!result;
                
                // Logic Badge & N√∫t b·∫•m
                let statusBadge = `<span class="text-[10px] font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded">Ch∆∞a l√†m</span>`;
                let actionBtn = `<button onclick="window.location.href='exam.html?id=${exam.id}'" class="w-full py-2.5 bg-purple-600 text-white font-bold rounded-xl shadow-md hover:bg-purple-700 transition-all">B·∫Øt ƒë·∫ßu l√†m b√†i</button>`;
                let scoreInfo = '';

                if (isDone) {
                    const score = result.score;
                    let badgeColor = 'bg-blue-100 text-blue-700';
                    let badgeIcon = '';
                    
                    if (score >= 9) { badgeColor = 'bg-yellow-100 text-yellow-700'; badgeIcon = '<i class="fa-solid fa-medal mr-1"></i>'; }
                    else if (score >= 8) { badgeColor = 'bg-green-100 text-green-700'; badgeIcon = '<i class="fa-solid fa-award mr-1"></i>'; }
                    
                    statusBadge = `<span class="text-[10px] font-bold ${badgeColor} px-2 py-1 rounded flex items-center">${badgeIcon} ${score} ƒëi·ªÉm</span>`;
                    
                    actionBtn = `
                        <div class="flex gap-2">
                            <button onclick="window.location.href='exam.html?id=${exam.id}'" class="flex-1 py-2 bg-white border border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 text-xs">L√†m l·∫°i</button>
                            <button onclick="window.location.href='exam.html?id=${exam.id}&mode=review'" class="flex-1 py-2 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 text-xs shadow-sm">Xem l·ªùi gi·∫£i</button>
                        </div>
                    `;
                    scoreInfo = `<div class="mt-2 text-xs text-gray-500 font-medium">Cao nh·∫•t: <span class="text-gray-800 font-bold">${score}</span></div>`;
                }

                html += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all flex flex-col justify-between h-full relative group">
                        ${isDone && result.score >= 9 ? '<div class="absolute -top-2 -right-2 text-2xl animate-bounce">üèÜ</div>' : ''}
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">ƒê·ªÅ thi</span>
                                ${statusBadge}
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg mb-1 line-clamp-2" title="${exam.title}">${exam.title}</h4>
                            <div class="flex items-center gap-3 text-xs text-gray-500 mt-2">
                                <span><i class="fa-regular fa-clock"></i> ${exam.duration} ph√∫t</span>
                                <span><i class="fa-solid fa-list-ol"></i> ${exam.questionCount||0} c√¢u</span>
                            </div>
                            ${scoreInfo}
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-50">
                            ${actionBtn}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        };

        // 5. HELPER FUNCTIONS
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(`tab-${tabId}`);
            if(target) target.classList.remove('hidden');
            
            const nav = document.getElementById(`nav-${tabId}`);
            if(nav) nav.classList.add('active');
            
            document.getElementById('mainScrollArea').scrollTop = 0;
        }

        window.openProfileModal = () => document.getElementById('profileModal').classList.remove('hidden');
        window.handleLogout = () => signOut(auth).then(() => window.location.href = "index.html");

        // 6. LOAD PENDING TASKS (DASHBOARD)
        async function loadPendingTasks(user) {
            const container = document.getElementById('pendingTasksList');
            if(!container) return;
            try {
                // L·∫•y t·∫•t c·∫£ l·ªõp
                const qClasses = query(collection(db, "classes"));
                const snapClasses = await getDocs(qClasses);
                const myClassIds = [];
                snapClasses.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    if (students.some(s => (s.email && s.email.toLowerCase() === user.email.toLowerCase()) || (s.uid === user.uid))) {
                        myClassIds.push(doc.id);
                    }
                });

                if (myClassIds.length === 0) { container.innerHTML = '<div class="col-span-full bg-white p-8 rounded-xl text-center border border-dashed border-gray-300"><p class="text-gray-400 text-sm">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p></div>'; return; }

                // L·∫•y 6 b√†i t·∫≠p m·ªõi nh·∫•t t·ª´ c√°c l·ªõp n√†y
                let allExams = [];
                for (const cid of myClassIds) {
                    const qEx = query(collection(db, "exams"), where("allowedClassId", "==", cid), where("status", "==", "published"), limit(3));
                    const snapEx = await getDocs(qEx);
                    snapEx.forEach(d => allExams.push({id:d.id, ...d.data()}));
                }
                
                // Sort by date desc
                allExams.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                allExams = allExams.slice(0, 6);

                if (allExams.length === 0) { container.innerHTML = '<div class="col-span-full bg-white p-8 rounded-xl text-center border border-dashed border-gray-300"><p class="text-gray-400 text-sm">Tuy·ªát v·ªùi! B·∫°n kh√¥ng c√≥ b√†i t·∫≠p n√†o qu√° h·∫°n.</p></div>'; return; }

                let html = '';
                allExams.forEach(ex => {
                    html += `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all" onclick="window.location.href='exam.html?id=${ex.id}'">
                            <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold shrink-0"><i class="fa-solid fa-file-pen"></i></div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 text-sm line-clamp-1">${ex.title}</h4>
                                <p class="text-xs text-gray-500">${ex.duration} ph√∫t ‚Ä¢ ${ex.questionCount||0} c√¢u</p>
                            </div>
                            <button class="text-xs bg-purple-600 text-white px-3 py-1.5 rounded-lg font-bold">L√†m ngay</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch(e) { console.error(e); }
        }

        // 7. LOAD MARKET & PURCHASED (FULL LOGIC)
        async function loadMarket() {
             const container = document.getElementById('marketList');
             const snap = await getDocs(collection(db, "public_courses"));
             let html = '';
             snap.forEach(d => {
                 const c = d.data();
                 html += `
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100 hover:shadow-lg transition-all group">
                        <div class="h-32 bg-gray-200 relative overflow-hidden">
                            <img src="${c.thumbnail || 'https://via.placeholder.com/150'}" class="h-full w-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="absolute inset-0 bg-black/10"></div>
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-gray-800 text-sm line-clamp-2 mb-2 min-h-[40px]">${c.title}</h4>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-50">
                                <span class="text-orange-600 font-black text-sm">${parseInt(c.price).toLocaleString()}ƒë</span>
                                <button onclick="openPaymentModal('${d.id}')" class="bg-purple-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold hover:bg-purple-700 transition-colors">Mua ngay</button>
                            </div>
                        </div>
                    </div>`;
             });
             container.innerHTML = html || '<p class="text-gray-400 col-span-full text-center">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>';
        }

        async function loadMyPurchased(user) {
             const container = document.getElementById('myPurchasedList');
             const q = query(collection(db, "orders"), where("userId", "==", user.uid), where("status", "==", "approved"));
             const snap = await getDocs(q);
             let html = '';
             snap.forEach(d => {
                 const o = d.data();
                 html += `
                    <div class="bg-white p-4 rounded-xl border border-purple-100 shadow-sm hover:border-purple-300 transition-all group">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center font-bold"><i class="fa-solid fa-graduation-cap"></i></div>
                            <h4 class="font-bold text-gray-800 text-sm line-clamp-1 flex-1">${o.courseTitle}</h4>
                        </div>
                        <button class="w-full py-2 bg-purple-600 text-white text-xs font-bold rounded-lg group-hover:bg-purple-700 transition-colors">V√†o h·ªçc ngay</button>
                    </div>`;
             });
             container.innerHTML = html || '<div class="col-span-full text-center py-10 bg-white rounded-xl border border-dashed border-gray-200"><p class="text-gray-400 text-sm">B·∫°n ch∆∞a mua kh√≥a h·ªçc n√†o.</p><button onclick="switchTab(\'market\')" class="mt-2 text-orange-500 text-sm font-bold hover:underline">Xem c·ª≠a h√†ng</button></div>';
        }

        // 8. PAYMENT LOGIC (INJECTED HTML)
        const paymentModalHTML = `
            <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-300">
                <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh]">
                    <div class="w-full md:w-5/12 bg-gray-50 p-6 border-r border-gray-100">
                        <h3 class="font-black text-gray-800 mb-4 uppercase">Th√¥ng tin ƒë∆°n h√†ng</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">Kh√≥a h·ªçc:</span> <b id="payCourseTitle" class="text-right">...</b></div>
                            <div class="flex justify-between"><span class="text-gray-500">Gi√° ti·ªÅn:</span> <b id="payFinalPrice" class="text-orange-600">...</b></div>
                            <div class="h-px bg-gray-200 my-2"></div>
                            <div class="text-xs bg-white p-2 rounded border"><i class="fa-solid fa-user"></i> <span id="payUserName">...</span></div>
                        </div>
                    </div>
                    <div class="w-full md:w-7/12 p-6 relative flex flex-col items-center justify-center">
                        <button onclick="document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times text-2xl"></i></button>
                        <h3 class="font-black text-brand mb-2">QU√âT M√É ƒê·ªÇ THANH TO√ÅN</h3>
                        <div class="relative w-56 h-56 bg-white p-2 rounded shadow mb-4">
                            <img id="vietQrImage" class="w-full h-full object-contain">
                            <div id="qrLoading" class="absolute inset-0 bg-white flex flex-col items-center justify-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-orange-500"></i></div>
                        </div>
                        <div class="text-sm text-center mb-4 w-full bg-orange-50 p-3 rounded-lg border border-orange-100">
                            <div class="flex justify-between mb-1"><span>NH:</span> <b id="bankNameDisplay">...</b></div>
                            <div class="flex justify-between mb-1"><span>STK:</span> <b id="accountNoDisplay">...</b></div>
                            <div class="flex justify-between"><span>ND:</span> <b id="transferContentDisplay" class="text-brand">...</b></div>
                        </div>
                        <button onclick="confirmPayment()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700">X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('paymentModalContainer').innerHTML = paymentModalHTML;

        let currentPayingCourse = null;
        let dynamicBankConfig = null;

        window.openPaymentModal = async (courseId) => {
            if (!dynamicBankConfig) {
                try {
                    const s = await getDoc(doc(db, "site_settings", "payment_config"));
                    dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ADMIN", TEMPLATE: "compact2" };
                } catch (e) { dynamicBankConfig = { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ERROR", TEMPLATE: "compact2" }; }
            }

            document.getElementById('paymentModal').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('qrLoading').classList.remove('hidden');

            try {
                const snap = await getDoc(doc(db, "public_courses", courseId));
                if(snap.exists()){
                    const c = snap.data();
                    currentPayingCourse = { id: snap.id, ...c };
                    const user = auth.currentUser;
                    
                    document.getElementById('payCourseTitle').innerText = c.title;
                    document.getElementById('payFinalPrice').innerText = parseInt(c.price).toLocaleString('vi-VN') + 'ƒë';
                    document.getElementById('payUserName').innerText = user.displayName || user.email;

                    const content = `TTOAN ${user.uid.substring(0,5)} ${c.id.substring(0,5).toUpperCase()}`.replace(/[^a-zA-Z0-9 ]/g, "");
                    document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_ID;
                    document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
                    document.getElementById('transferContentDisplay').innerText = content;
                    
                    const qrUrl = `https://img.vietqr.io/image/${dynamicBankConfig.BANK_ID}-${dynamicBankConfig.ACCOUNT_NO}-${dynamicBankConfig.TEMPLATE}.png?amount=${c.price}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME)}`;
                    
                    const qrImg = document.getElementById('vietQrImage');
                    qrImg.onload = () => document.getElementById('qrLoading').classList.add('hidden');
                    qrImg.src = qrUrl;
                }
            } catch(e){ console.error(e); }
        };

        window.confirmPayment = async () => {
             const btn = document.querySelector('button[onclick="confirmPayment()"]');
             btn.innerText = "ƒêang g·ª≠i..."; btn.disabled = true;
             try {
                await addDoc(collection(db, "orders"), {
                    userId: auth.currentUser.uid,
                    courseId: currentPayingCourse.id,
                    courseTitle: currentPayingCourse.title,
                    amount: parseInt(currentPayingCourse.price),
                    status: 'pending',
                    content: document.getElementById('transferContentDisplay').innerText,
                    createdAt: new Date().toISOString()
                });
                alert("G·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
                document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none');
             } catch(e) { alert("L·ªói: " + e.message); }
             finally { btn.innerText = "X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN"; btn.disabled = false; }
        };

    </script>
</body>
</html>
