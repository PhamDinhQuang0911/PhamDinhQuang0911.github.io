<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√≥c h·ªçc t·∫≠p - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#0F766E', // Teal 700
                        accent: '#F97316', // Orange 500
                    },
                    fontFamily: { sans: ['Be Vietnam Pro', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #F3F4F6; }
        .sidebar-item { transition: all 0.2s; border-right: 3px solid transparent; }
        .sidebar-item.active { background-color: #ECFDF5; color: #0F766E; border-right-color: #0F766E; font-weight: 700; }
        .sidebar-item:hover:not(.active) { background-color: #F9FAFB; color: #0F766E; }
        /* Scrollbar ·∫©n cho ƒë·∫πp */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-sm z-20 hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <i class="fa-solid fa-graduation-cap text-2xl text-accent mr-2"></i>
            <span class="font-black text-xl text-brand tracking-tight">Th·∫ßy Choang</span>
        </div>

        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-home w-5"></i> S·∫£nh ch√≠nh
            </button>
            
            <button onclick="switchTab('my-classes')" id="nav-my-classes" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-chalkboard-user w-5"></i> L·ªõp h·ªçc c·ªßa t√¥i
            </button>

            <div class="px-6 pt-4 pb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">H·ªçc t·∫≠p</div>

            <button onclick="switchTab('my-courses')" id="nav-my-courses" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-book-open w-5"></i> Kh√≥a h·ªçc c·ªßa t√¥i
            </button>

            <button onclick="switchTab('all-courses')" id="nav-all-courses" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-cart-shopping w-5"></i> ƒêƒÉng k√Ω kh√≥a m·ªõi
            </button>

            <button onclick="switchTab('chatbot')" id="nav-chatbot" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 flex items-center gap-3">
                <i class="fa-solid fa-robot w-5"></i> Tr·ª£ l√Ω AI (Beta)
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3 mb-3">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full border border-gray-200">
                <div class="flex-1 min-w-0">
                    <p id="userName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p class="text-xs text-green-600 font-medium">‚óè ƒêang ho·∫°t ƒë·ªông</p>
                </div>
            </div>
            <button onclick="handleLogout()" class="w-full py-2 bg-white border border-gray-300 text-gray-600 rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-colors">
                <i class="fa-solid fa-sign-out-alt mr-1"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="md:hidden h-16 bg-white border-b flex items-center justify-between px-4 z-20">
            <div class="font-black text-lg text-brand">Th·∫ßy Choang</div>
            <button class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-[#F3F4F6]">
            
            <div id="tab-dashboard" class="tab-content space-y-8 animate-fade-in">
                <div class="bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl p-6 md:p-10 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform translate-x-20"></div>
                    <div class="relative z-10 max-w-2xl">
                        <span class="bg-white/20 text-white text-xs font-bold px-2 py-1 rounded mb-2 inline-block">Th√¥ng b√°o m·ªõi</span>
                        <h1 class="text-2xl md:text-4xl font-black mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcomeName">b·∫°n hi·ªÅn</span>! üëã</h1>
                        <p class="text-blue-100 mb-6 text-sm md:text-base">H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ chinh ph·ª•c c√°c con s·ªë. H√£y xem c√°c b√†i t·∫≠p c·∫ßn ho√†n th√†nh b√™n d∆∞·ªõi nh√©.</p>
                        <button onclick="switchTab('all-courses')" class="bg-white text-blue-700 px-6 py-2 rounded-lg font-bold hover:bg-blue-50 transition shadow-lg text-sm">Kh√°m ph√° kh√≥a h·ªçc</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-list-check text-orange-500"></i> B√†i t·∫≠p c·∫ßn l√†m ngay</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="pendingTasksList">
                        <div class="col-span-full text-center py-10 bg-white rounded-xl border border-dashed border-gray-300">
                            <i class="fa-solid fa-mug-hot text-4xl text-gray-200 mb-3"></i>
                            <p class="text-gray-400 text-sm">Tuy·ªát v·ªùi! B·∫°n kh√¥ng c√≥ b√†i t·∫≠p n√†o qu√° h·∫°n.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-my-classes" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-gray-800">L·ªõp h·ªçc c·ªßa t√¥i</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
                        <i class="fa-solid fa-school text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500 font-bold">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o</p>
                    </div>
                </div>
            </div>

            <div id="tab-my-courses" class="tab-content hidden animate-fade-in">
                <h2 class="text-2xl font-black text-gray-800 mb-6">Kh√≥a h·ªçc ƒë√£ s·ªü h·ªØu</h2>
                <div id="myCoursesList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                     <div class="col-span-full text-center py-16">
                        <i class="fa-solid fa-box-open text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">B·∫°n ch∆∞a mua kh√≥a h·ªçc n√†o.</p>
                        <button onclick="switchTab('all-courses')" class="mt-4 text-brand font-bold hover:underline">ƒê·∫øn c·ª≠a h√†ng ngay</button>
                    </div>
                </div>
            </div>

            <div id="tab-all-courses" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-gray-800">C·ª≠a h√†ng kh√≥a h·ªçc</h2>
                    <div class="flex gap-2">
                        <input type="text" placeholder="T√¨m ki·∫øm..." class="px-4 py-2 rounded-lg border border-gray-200 text-sm">
                    </div>
                </div>
                <div id="allCoursesList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="col-span-full text-center py-10"><i class="fa-solid fa-spinner fa-spin text-2xl text-brand"></i> ƒêang t·∫£i kh√≥a h·ªçc...</div>
                </div>
            </div>

            <div id="tab-chatbot" class="tab-content hidden animate-fade-in h-full flex flex-col">
                <div class="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col items-center justify-center p-10 text-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" class="w-24 h-24 mb-4 opacity-50">
                    <h3 class="text-xl font-bold text-gray-800">Tr·ª£ l√Ω AI ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng</h3>
                    <p class="text-gray-500 max-w-md mt-2">T√≠nh nƒÉng n√†y s·∫Ω s·ªõm ra m·∫Øt ƒë·ªÉ h·ªó tr·ª£ b·∫°n gi·∫£i b√†i t·∫≠p v√† √¥n luy·ªán 24/7.</p>
                </div>
            </div>

        </div>
    </main>

    <div id="paymentModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] bg-gray-50 flex flex-col transition-all duration-300">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // C·∫•u h√¨nh Firebase (Anh thay config c·ªßa anh v√†o ƒë√¢y)
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // L·∫•y th√¥ng tin User
                const uSnap = await getDoc(doc(db, "users", user.uid));
                const uData = uSnap.exists() ? uSnap.data() : {};
                
                document.getElementById('userName').innerText = uData.displayName || user.email;
                document.getElementById('welcomeName').innerText = uData.displayName || "b·∫°n";
                document.getElementById('userAvatar').src = uData.photoURL || `https://ui-avatars.com/api/?name=${uData.displayName || 'User'}&background=0F766E&color=fff`;
                
                // Load d·ªØ li·ªáu
                loadAllCourses();
            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p -> V·ªÅ trang ch·ªß
                window.location.href = "index.html";
            }
        });

        // --- 2. LOGIC TAB & UI ---
        window.switchTab = (tabId) => {
            // ·∫®n t·∫•t c·∫£ tab
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            
            // Hi·ªán tab ch·ªçn
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
        };

        window.handleLogout = () => {
            signOut(auth).then(() => window.location.href = "index.html");
        };

        // --- 3. LOAD KH√ìA H·ªåC (MARKETPLACE) ---
        async function loadAllCourses() {
            const container = document.getElementById('allCoursesList');
            try {
                const snapshot = await getDocs(collection(db, "public_courses"));
                if (snapshot.empty) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const priceDisplay = parseInt(c.price) > 0 ? parseInt(c.price).toLocaleString('vi-VN') + 'ƒë' : 'Mi·ªÖn ph√≠';
                    html += `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow flex flex-col">
                            <div class="h-40 bg-gray-100 relative">
                                <img src="${c.image || c.thumbnail || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover">
                                <span class="absolute top-2 right-2 bg-black/60 text-white text-[10px] font-bold px-2 py-1 rounded">${c.tag || 'Kh√≥a h·ªçc'}</span>
                            </div>
                            <div class="p-4 flex-1 flex flex-col">
                                <h4 class="font-bold text-gray-800 line-clamp-2 mb-2 min-h-[40px]">${c.title}</h4>
                                <div class="mt-auto flex justify-between items-center">
                                    <span class="text-orange-600 font-black">${priceDisplay}</span>
                                    <button onclick="openPaymentModal('${doc.id}')" class="bg-brand text-white text-xs font-bold px-3 py-2 rounded hover:bg-teal-800 transition">ƒêƒÉng k√Ω</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        // --- 4. LOGIC THANH TO√ÅN (COPY T·ª™ INDEX SANG ƒê·ªÇ CH·∫†Y ƒê∆Ø·ª¢C QR) ---
        // (T√¥i ƒë√£ r√∫t g·ªçn code modal HTML ·ªü tr√™n, gi·ªù inject v√†o v√† ch·∫°y logic)
        
        // Inject Modal HTML
        document.getElementById('paymentModal').innerHTML = `
             <div class="bg-white w-full h-full md:h-auto md:max-h-[90vh] md:max-w-5xl md:rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                <div class="bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="font-bold text-gray-800 uppercase"><i class="fa-solid fa-lock text-brand mr-2"></i>Thanh to√°n</h2>
                    <button onclick="closePaymentModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                             <h3 class="font-bold text-orange-800 mb-2">Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
                             <div class="text-sm space-y-2">
                                <div class="flex justify-between"><span>Ng√¢n h√†ng:</span> <span id="bankNameDisplay" class="font-bold">...</span></div>
                                <div class="flex justify-between"><span>Ch·ªß TK:</span> <span id="accountNameDisplay" class="font-bold">...</span></div>
                                <div class="flex justify-between items-center"><span>S·ªë TK:</span> <span class="font-black text-lg text-brand" id="accountNoDisplay">...</span> <button onclick="copyText('accountNoDisplay')" class="text-xs border px-2 rounded">Copy</button></div>
                                <div class="bg-white p-2 rounded border border-orange-200 mt-2">
                                    <span class="text-[10px] text-gray-500 block">N·ªôi dung (B·∫Øt bu·ªôc):</span>
                                    <div class="flex justify-between"><span id="transferContentDisplay" class="font-bold text-brand">...</span> <button onclick="copyText('transferContentDisplay')" class="text-xs border px-2 rounded">Copy</button></div>
                                </div>
                             </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="bg-white p-2 rounded-xl shadow border border-gray-200 mb-4 relative w-64 h-64">
                            <img id="vietQrImage" class="w-full h-full object-contain">
                            <div id="qrLoading" class="absolute inset-0 flex items-center justify-center bg-white"><i class="fa-solid fa-spinner fa-spin"></i></div>
                        </div>
                        <button onclick="confirmPayment()" class="w-full py-3 bg-brand text-white font-bold rounded-xl shadow-lg">X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN</button>
                    </div>
                </div>
             </div>
        `;

        let currentPayingCourse = null;
        let dynamicBankConfig = null;

        window.openPaymentModal = async (courseId) => {
            // T·∫£i c·∫•u h√¨nh Bank
            if (!dynamicBankConfig) {
                try {
                    const s = await getDoc(doc(db, "site_settings", "payment_config"));
                    dynamicBankConfig = s.exists() ? s.data() : { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ADMIN", TEMPLATE: "compact2" };
                } catch (e) { dynamicBankConfig = { BANK_ID: "MB", ACCOUNT_NO: "0000", ACCOUNT_NAME: "ERROR", TEMPLATE: "compact2" }; }
            }

            document.getElementById('paymentModal').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('qrLoading').classList.remove('hidden');

            try {
                const snap = await getDoc(doc(db, "public_courses", courseId));
                if(snap.exists()){
                    const c = snap.data();
                    currentPayingCourse = { id: snap.id, ...c };
                    const user = auth.currentUser;
                    
                    // T·∫°o n·ªôi dung CK & Link QR
                    const content = `TTOAN ${user.uid.substring(0,5)} ${c.id.substring(0,5).toUpperCase()}`.replace(/[^a-zA-Z0-9 ]/g, ""); // R√∫t g·ªçn ID cho demo
                    
                    document.getElementById('bankNameDisplay').innerText = dynamicBankConfig.BANK_ID;
                    document.getElementById('accountNameDisplay').innerText = dynamicBankConfig.ACCOUNT_NAME;
                    document.getElementById('accountNoDisplay').innerText = dynamicBankConfig.ACCOUNT_NO;
                    document.getElementById('transferContentDisplay').innerText = content;
                    
                    const qrUrl = `https://img.vietqr.io/image/${dynamicBankConfig.BANK_ID}-${dynamicBankConfig.ACCOUNT_NO}-${dynamicBankConfig.TEMPLATE}.png?amount=${c.price}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(dynamicBankConfig.ACCOUNT_NAME)}`;
                    
                    const qrImg = document.getElementById('vietQrImage');
                    qrImg.onload = () => document.getElementById('qrLoading').classList.add('hidden');
                    qrImg.src = qrUrl;
                }
            } catch(e){ console.error(e); }
        };

        window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('opacity-0', 'pointer-events-none');
        window.copyText = (id) => navigator.clipboard.writeText(document.getElementById(id).innerText);
        
        window.confirmPayment = async () => {
             // Logic l∆∞u ƒë∆°n h√†ng t∆∞∆°ng t·ª± trang ch·ªß
             alert("ƒê√£ g·ª≠i y√™u c·∫ßu! Admin s·∫Ω duy·ªát s·ªõm.");
             window.closePaymentModal();
        };

    </script>
</body>
</html>
