<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khóa học - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#0F766E', accent: '#F97316' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeIn 0.4s ease-out forwards; }
        .content-panel { transition: all 0.3s ease; }
    </style>
</head>
<body class="text-gray-700">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800">Quản lý Khóa học</h1>
                <p class="text-gray-500 text-sm mt-1">Quản lý danh sách, nội dung và học viên</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.toggleModal('courseModal')" class="bg-brand text-white px-5 py-2.5 rounded-xl hover:bg-teal-800 shadow-lg shadow-teal-700/20 font-bold transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-plus"></i> Thêm khóa học
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-layer-group"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Tổng số khóa học</div>
                    <div class="text-2xl font-black text-gray-800" id="statTotalCourses">...</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-users"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Tổng học viên</div>
                    <div class="text-2xl font-black text-gray-800" id="statTotalStudents">...</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Doanh thu tạm tính</div>
                    <div class="text-2xl font-black text-gray-800">Liên hệ Admin</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                            <th class="p-4 w-20">Ảnh</th>
                            <th class="p-4">Tên khóa học</th>
                            <th class="p-4">Giá bán</th>
                            <th class="p-4 text-center">Học viên</th>
                            <th class="p-4 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="courseListTable" class="text-sm">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="courseModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 text-lg" id="modalTitle">Thêm Khóa Học Mới</h3>
                <button onclick="window.toggleModal('courseModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="courseId">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên khóa học</label>
                    <input type="text" id="cTitle" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand focus:ring-1 focus:ring-brand outline-none transition-all" placeholder="VD: Luyện thi Toán 12...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giá bán (VNĐ)</label>
                        <input type="number" id="cPrice" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Học viên ảo</label>
                        <input type="number" id="cStudents" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả ngắn</label>
                    <textarea id="cDesc" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="Giới thiệu khóa học..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ảnh bìa (URL hoặc Upload)</label>
                    <div class="flex gap-2">
                        <input type="text" id="cThumb" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl outline-none" placeholder="https://...">
                        <label class="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl cursor-pointer hover:bg-gray-200"><i class="fa-solid fa-upload"></i> <input type="file" hidden onchange="window.handleUpload(this)"></label>
                    </div>
                    <img id="previewThumb" class="w-full h-32 object-cover rounded-xl mt-2 hidden">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-2">
                <button onclick="window.toggleModal('courseModal')" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">Hủy</button>
                <button onclick="window.saveCourseBasic()" class="px-6 py-2 bg-brand text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all">Lưu thông tin</button>
            </div>
        </div>
    </div>

    <div id="curriculumModal" class="hidden fixed inset-0 z-[60] bg-gray-900/95 backdrop-blur-sm transition-opacity duration-300">
        <div class="flex h-screen w-full p-4 gap-4">
            
            <div class="w-1/3 max-w-sm bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden animate-fade-in-up">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div>
                        <h3 class="font-extrabold text-gray-800 text-lg">Cấu trúc khóa học</h3>
                        <p id="editorCourseTitle" class="text-xs text-gray-500 truncate w-40">Đang tải...</p>
                    </div>
                    <button onclick="addChapter()" class="px-3 py-1.5 bg-brand/10 text-brand rounded-lg text-sm font-bold hover:bg-brand hover:text-white transition-all">
                        <i class="fa-solid fa-folder-plus mr-1"></i> Thêm Chương
                    </button>
                </div>

                <div id="curriculumTree" class="flex-1 overflow-y-auto p-3 space-y-4 bg-white scrollbar-hide">
                    <div class="text-center mt-10 text-gray-400">
                        <i class="fa-solid fa-layer-group text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">Chưa có nội dung nào.</p>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50 text-center">
                    <button onclick="saveCurriculum()" class="w-full py-3 bg-gradient-to-r from-brand to-teal-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                        <i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN
                    </button>
                    <button onclick="closeCurriculumModal()" class="mt-2 text-xs text-gray-500 hover:text-red-500 font-semibold">
                        Đóng không lưu
                    </button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden relative animate-fade-in-up" style="animation-delay: 0.1s;">
                
                <div id="editorWelcome" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-10">
                    <img src="https://cdn-icons-png.flaticon.com/512/3079/3079296.png" class="w-24 h-24 mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-bold text-gray-400">Chọn một bài học để chỉnh sửa</h3>
                    <p class="text-gray-400 text-sm">Hoặc tạo mới từ cột bên trái</p>
                </div>

                <div id="editorForm" class="hidden flex flex-col h-full">
                    <div class="h-16 border-b border-gray-100 flex items-center px-6 justify-between bg-white">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm" id="editLessonIndex">1</span>
                            <input type="text" id="editLessonTitle" class="text-lg font-bold text-gray-800 outline-none border-b border-transparent focus:border-brand placeholder-gray-300 w-96 transition-all" placeholder="Nhập tên bài học tại đây...">
                        </div>
                        
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="setLessonType('video')" id="btnTypeVideo" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all"><i class="fa-brands fa-youtube mr-1"></i> Video</button>
                            <button onclick="setLessonType('pdf')" id="btnTypePdf" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all"><i class="fa-solid fa-file-pdf mr-1"></i> Tài liệu</button>
                            <button onclick="setLessonType('quiz')" id="btnTypeQuiz" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all"><i class="fa-solid fa-clipboard-question mr-1"></i> Bài tập</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-gray-50/50 p-8">
                        
                        <div id="panelVideo" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Đường dẫn Video (YouTube)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="videoUrlInput" oninput="previewVideo(this.value)" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-all" placeholder="Ví dụ: https://www.youtube.com/watch?v=...">
                                </div>
                                <p class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-circle-info"></i> Hệ thống sẽ tự động lấy ID và hiển thị khung xem trước.</p>
                            </div>
                            
                            <div id="videoPreviewArea" class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg hidden relative group">
                                <iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        </div>

                        <div id="panelPdf" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="flex gap-4 mb-4">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfSource" value="upload" class="peer sr-only" checked onchange="togglePdfSource()">
                                    <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand peer-checked:bg-teal-50 hover:bg-white transition-all text-center">
                                        <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2 text-gray-400 peer-checked:text-brand"></i>
                                        <div class="font-bold text-sm text-gray-700">Tải file lên (Cloudflare)</div>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfSource" value="drive" class="peer sr-only" onchange="togglePdfSource()">
                                    <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-white transition-all text-center">
                                        <i class="fa-brands fa-google-drive text-2xl mb-2 text-gray-400 peer-checked:text-blue-500"></i>
                                        <div class="font-bold text-sm text-gray-700">Link Google Drive</div>
                                    </div>
                                </label>
                            </div>

                            <div id="pdfUploadArea" class="bg-white p-8 rounded-xl border-2 border-dashed border-gray-300 text-center hover:border-brand transition-colors cursor-pointer group">
                                <input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-teal-50 transition-colors">
                                    <i class="fa-solid fa-file-pdf text-3xl text-gray-400 group-hover:text-brand"></i>
                                </div>
                                <p class="font-bold text-gray-700">Nhấn để chọn file PDF</p>
                                <p class="text-xs text-gray-400 mt-1">Hỗ trợ file tối đa 50MB</p>
                                <div id="uploadProgress" class="hidden mt-4">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-brand h-2 rounded-full" style="width: 45%"></div>
                                    </div>
                                    <p class="text-xs text-brand font-bold mt-1">Đang tải lên... 45%</p>
                                </div>
                            </div>

                            <div id="pdfDriveArea" class="hidden bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Dán link Google Drive (Chế độ công khai)</label>
                                <input type="text" id="driveUrlInput" oninput="previewDrive(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://drive.google.com/file/d/...">
                            </div>

                            <div id="pdfPreviewArea" class="h-[500px] bg-gray-800 rounded-xl overflow-hidden shadow-lg hidden">
                                <iframe id="pdfFrame" class="w-full h-full" src=""></iframe>
                            </div>
                        </div>

                        <div id="panelQuiz" class="content-panel hidden max-w-4xl mx-auto text-center py-10">
                            <div class="w-24 h-24 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                                <i class="fa-solid fa-star text-4xl text-orange-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Chọn đề thi kiểm tra</h3>
                            <p class="text-gray-500 mb-6 max-w-md mx-auto">Học sinh cần làm đạt điểm yêu cầu của bài tập này mới được học bài tiếp theo.</p>
                            
                            <div class="flex justify-center gap-4">
                                <button class="px-6 py-3 bg-white border-2 border-orange-500 text-orange-600 rounded-xl font-bold hover:bg-orange-50 transition-all flex items-center gap-2">
                                    <i class="fa-solid fa-list-check"></i> Chọn từ Ngân hàng đề
                                </button>
                                <div class="relative">
                                    <select id="examSelect" class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl outline-none focus:border-orange-500 font-semibold w-64">
                                        <option value="">-- Đề thi đã chọn --</option>
                                        </select>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="bg-white border-t border-gray-100 p-4 flex gap-6 text-sm font-bold text-gray-600">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand">
                            <input type="checkbox" id="isPreview" class="accent-brand w-4 h-4">
                            <span>Cho phép học thử (Preview)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand">
                            <input type="checkbox" id="isPublished" checked class="accent-brand w-4 h-4">
                            <span>Đã xuất bản (Hiện cho HS)</span>
                        </label>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // CẤU HÌNH FIREBASE (Giữ nguyên của bạn hoặc điền lại nếu cần)
        // Nếu file này chạy chung domain với dashboard.html thì thường trình duyệt đã cache config, nhưng tốt nhất nên khai báo lại.
        // Bạn hãy thay thế đoạn config này bằng config thực của bạn nếu nó chưa chạy.
        const firebaseConfig = {
            // ... (Điền config Firebase của bạn vào đây nếu chưa có) ...
            // Hiện tại tôi giả định bạn đã có file config hoặc file này import từ file js chung.
            // Nếu chưa, hãy copy từ dashboard.html sang.
        };
        
        // Vì tôi không biết chính xác config của bạn, tôi sẽ khởi tạo app. 
        // LƯU Ý: Nếu bạn đã có file js config riêng, hãy import nó.
        // Dưới đây tôi dùng window.firebase để tương thích code cũ nếu có.
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html'; // Redirect nếu chưa đăng nhập
            } else {
                loadCourses();
            }
        });

        // --- LOGIC QUẢN LÝ KHÓA HỌC (CRUD) ---

        window.loadCourses = async () => {
            try {
                const q = query(collection(db, "public_courses"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                const list = document.getElementById('courseListTable');
                list.innerHTML = '';
                
                let totalStudents = 0;

                if (querySnapshot.empty) {
                    list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có khóa học nào.</td></tr>`;
                    document.getElementById('statTotalCourses').innerText = "0";
                    document.getElementById('statTotalStudents').innerText = "0";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const c = doc.data();
                    const priceText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(c.price || 0);
                    totalStudents += (parseInt(c.students) || 0);

                    const html = `
                    <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-100 last:border-0">
                        <td class="p-4">
                            <div class="relative w-12 h-12 rounded-lg overflow-hidden border border-gray-200 shadow-sm group-hover:shadow-md transition-all">
                                <img src="${c.thumbnail || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-gray-800 text-base mb-0.5">${c.title}</div>
                            <div class="text-xs text-gray-400 line-clamp-1 max-w-xs">${c.desc || c.shortDesc || '...'}</div>
                        </td>
                        <td class="p-4 font-mono font-bold text-gray-700">${priceText}</td>
                        <td class="p-4 text-center">
                            <span class="bg-blue-50 text-blue-700 px-2.5 py-1 rounded-md text-xs font-bold border border-blue-100 shadow-sm">${c.students || 0} HV</span>
                        </td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2 opacity-100">
                                <button onclick="window.openCurriculumEditor('${doc.id}')" class="p-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition-all shadow-sm" title="Soạn giáo án">
                                    <i class="fa-solid fa-book-open"></i>
                                </button>
                                <button onclick="window.editCourse('${doc.id}')" class="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-blue-500 hover:text-white transition-all shadow-sm" title="Sửa thông tin">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="window.deleteCourse('${doc.id}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-500 hover:text-white transition-all shadow-sm" title="Xóa">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                    list.innerHTML += html;
                });

                document.getElementById('statTotalCourses').innerText = querySnapshot.size;
                document.getElementById('statTotalStudents').innerText = totalStudents;

            } catch (error) {
                console.error("Error loading courses:", error);
                alert("Lỗi tải danh sách: " + error.message);
            }
        };

        // Modal Controls
        window.toggleModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            if (show === undefined) show = modal.classList.contains('hidden');
            
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
            } else {
                modal.querySelector('div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }
            
            // Reset form khi mở modal "Thêm mới"
            if (modalId === 'courseModal' && show && !document.getElementById('courseId').value) {
                document.getElementById('modalTitle').innerText = "Thêm Khóa Học Mới";
                document.getElementById('cTitle').value = '';
                document.getElementById('cPrice').value = '';
                document.getElementById('cStudents').value = '';
                document.getElementById('cDesc').value = '';
                document.getElementById('cThumb').value = '';
                document.getElementById('previewThumb').classList.add('hidden');
                document.getElementById('courseId').value = '';
            }
        };

        // Edit Basic Info
        window.editCourse = async (id) => {
            try {
                const docRef = doc(db, "public_courses", id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('courseId').value = id;
                    document.getElementById('cTitle').value = data.title;
                    document.getElementById('cPrice').value = data.price;
                    document.getElementById('cStudents').value = data.students;
                    document.getElementById('cDesc').value = data.desc || "";
                    document.getElementById('cThumb').value = data.thumbnail || "";
                    if (data.thumbnail) {
                        document.getElementById('previewThumb').src = data.thumbnail;
                        document.getElementById('previewThumb').classList.remove('hidden');
                    }
                    document.getElementById('modalTitle').innerText = "Cập nhật Khóa học";
                    window.toggleModal('courseModal', true);
                }
            } catch (e) { alert("Lỗi: " + e.message); }
        };

        // Save Basic Info
        window.saveCourseBasic = async () => {
            const id = document.getElementById('courseId').value;
            const data = {
                title: document.getElementById('cTitle').value,
                price: parseInt(document.getElementById('cPrice').value) || 0,
                students: parseInt(document.getElementById('cStudents').value) || 0,
                desc: document.getElementById('cDesc').value,
                thumbnail: document.getElementById('cThumb').value,
                updatedAt: new Date().toISOString()
            };

            if (!data.title) return alert("Vui lòng nhập tên khóa học");

            try {
                if (id) {
                    await updateDoc(doc(db, "public_courses", id), data);
                    alert("Đã cập nhật!");
                } else {
                    data.createdAt = new Date().toISOString();
                    await setDoc(doc(collection(db, "public_courses")), data); // Auto ID
                    alert("Đã thêm khóa học mới!");
                }
                window.toggleModal('courseModal', false);
                loadCourses();
            } catch (e) { alert("Lỗi lưu: " + e.message); }
        };

        // Delete Course
        window.deleteCourse = async (id) => {
            if (confirm("Bạn có chắc chắn muốn xóa khóa học này không? Hành động này không thể hoàn tác.")) {
                try {
                    await deleteDoc(doc(db, "public_courses", id));
                    // TODO: Xóa thêm các file ảnh/video liên quan nếu cần
                    loadCourses();
                    alert("Đã xóa thành công!");
                } catch (e) { alert("Lỗi xóa: " + e.message); }
            }
        };

        // Upload Helper (Giả lập hoặc dùng Cloudflare Worker như cũ)
        window.handleUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;
            
            // Ở đây bạn có thể dùng lại hàm upload lên Cloudflare R2 qua Worker
            // Để đơn giản, tôi dùng tạm Firebase Storage hoặc alert placeholder
            // Nếu bạn có API upload ảnh, hãy gọi nó ở đây.
            alert("Vui lòng tích hợp API upload ảnh của bạn vào hàm handleUpload trong mã nguồn.");
            
            // Mockup:
            // const url = await uploadToMyServer(file);
            // document.getElementById('cThumb').value = url;
            // document.getElementById('previewThumb').src = url;
            // document.getElementById('previewThumb').classList.remove('hidden');
        };

        // ==========================================
        // JS XỬ LÝ GIAO DIỆN EDITOR (PHẦN 2 +)
        // ==========================================

        let currentActiveLessonId = null; 
        let currentLessonType = 'video';

        // 1. Mở/Đóng Modal Editor
        window.openCurriculumEditor = async (courseId) => {
            const modal = document.getElementById('curriculumModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Lấy tên khóa học hiển thị
            try {
                const d = await getDoc(doc(db, "public_courses", courseId));
                if(d.exists()) document.getElementById('editorCourseTitle').innerText = d.data().title;
            } catch(e) {}
            
            // Reset UI
            document.getElementById('editorWelcome').classList.remove('hidden');
            document.getElementById('editorForm').classList.add('hidden');
        };

        window.closeCurriculumModal = () => {
            if(confirm("Các thay đổi chưa lưu sẽ bị mất. Bạn chắc chắn muốn đóng?")) {
                document.getElementById('curriculumModal').classList.add('hidden');
                document.body.style.overflow = '';
            }
        };

        // 2. Chuyển đổi Loại bài học (Tabs)
        window.setLessonType = (type) => {
            currentLessonType = type;
            
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all";
            });
            const activeBtn = document.getElementById(
                type === 'video' ? 'btnTypeVideo' : 
                type === 'pdf' ? 'btnTypePdf' : 'btnTypeQuiz'
            );
            activeBtn.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold shadow-sm transition-all " + 
                (type === 'video' ? "bg-red-50 text-red-600" : 
                 type === 'pdf' ? "bg-blue-50 text-blue-600" : "bg-orange-50 text-orange-600");

            document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
            const panelId = type === 'video' ? 'panelVideo' : type === 'pdf' ? 'panelPdf' : 'panelQuiz';
            document.getElementById(panelId).classList.remove('hidden');
        };

        // 3. Preview Video YouTube
        window.previewVideo = (url) => {
            const previewArea = document.getElementById('videoPreviewArea');
            const iframe = document.getElementById('videoFrame');
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);

            if (match && match[2].length === 11) {
                iframe.src = `https://www.youtube.com/embed/${match[2]}`;
                previewArea.classList.remove('hidden');
            } else {
                previewArea.classList.add('hidden');
                iframe.src = "";
            }
        };

        // 4. Toggle PDF Source
        window.togglePdfSource = () => {
            const source = document.querySelector('input[name="pdfSource"]:checked').value;
            if(source === 'upload') {
                document.getElementById('pdfUploadArea').classList.remove('hidden');
                document.getElementById('pdfDriveArea').classList.add('hidden');
                document.getElementById('pdfPreviewArea').classList.add('hidden');
            } else {
                document.getElementById('pdfUploadArea').classList.add('hidden');
                document.getElementById('pdfDriveArea').classList.remove('hidden');
            }
        };

        // 5. Preview Google Drive
        window.previewDrive = (url) => {
            const previewArea = document.getElementById('pdfPreviewArea');
            const iframe = document.getElementById('pdfFrame');
            if(url.includes('drive.google.com')) {
                let embedUrl = url.replace('/view', '/preview').replace('/edit', '/preview');
                iframe.src = embedUrl;
                previewArea.classList.remove('hidden');
            } else {
                previewArea.classList.add('hidden');
            }
        };

        // --- CÁC HÀM PLACEHOLDER (CHỜ PHẦN 3 LOGIC) ---
        window.addChapter = () => { alert("Tính năng thêm chương sẽ hoạt động ở Phần 3 (Logic)"); };
        window.saveCurriculum = () => { alert("Lưu giáo án và xóa file rác Cloudflare sẽ hoạt động ở Phần 3 (Logic)"); };

    </script>
</body>
</html>
