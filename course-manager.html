<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khóa học - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#0F766E', accent: '#F97316' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        /* Toast Animation */
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideInRight 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-700">

    <div id="toastContainer" class="fixed top-5 right-5 z-[200] space-y-3"></div>

    <div id="confirmModal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Xác nhận hành động</h3>
                <p id="confirmMessage" class="text-gray-500 text-sm mb-6">Bạn có chắc chắn muốn thực hiện?</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="window.closeConfirm(false)" class="px-4 py-2 border border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-gray-50">Hủy bỏ</button>
                    <button id="confirmBtnYes" class="px-6 py-2 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-700">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800">Quản lý Khóa học</h1>
                <p class="text-gray-500 text-sm mt-1">Quản lý danh sách, nội dung và học viên</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.toggleModal('courseModal')" class="bg-brand text-white px-5 py-2.5 rounded-xl hover:bg-teal-800 shadow-lg shadow-teal-700/20 font-bold transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-plus"></i> Thêm khóa học
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-layer-group"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Tổng số khóa học</div>
                    <div class="text-2xl font-black text-gray-800" id="statTotalCourses">...</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-users"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Tổng học viên</div>
                    <div class="text-2xl font-black text-gray-800" id="statTotalStudents">...</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Doanh thu tạm tính</div>
                    <div class="text-2xl font-black text-gray-800">...</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                            <th class="p-4 w-20">Ảnh</th>
                            <th class="p-4">Tên khóa học</th>
                            <th class="p-4">Giá bán</th>
                            <th class="p-4 text-center">Học viên</th>
                            <th class="p-4 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="courseListTable" class="text-sm">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="courseModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 text-lg" id="modalTitle">Thêm Khóa Học Mới</h3>
                <button onclick="window.toggleModal('courseModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="courseId">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên khóa học</label>
                    <input type="text" id="cTitle" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand focus:ring-1 focus:ring-brand outline-none transition-all" placeholder="VD: Luyện thi Toán 12...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giá bán (VNĐ)</label>
                        <input type="number" id="cPrice" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Học viên ảo</label>
                        <input type="number" id="cStudents" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả ngắn</label>
                    <textarea id="cDesc" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="Giới thiệu khóa học..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ảnh bìa (URL hoặc Upload)</label>
                    <div class="flex gap-2">
                        <input type="text" id="cThumb" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl outline-none" placeholder="https://...">
                        <label class="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl cursor-pointer hover:bg-gray-200"><i class="fa-solid fa-upload"></i> <input type="file" hidden onchange="window.handleUpload(this)"></label>
                    </div>
                    <img id="previewThumb" class="w-full h-32 object-cover rounded-xl mt-2 hidden">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-2">
                <button onclick="window.toggleModal('courseModal')" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">Hủy</button>
                <button onclick="window.saveCourseBasic()" class="px-6 py-2 bg-brand text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all">Lưu thông tin</button>
            </div>
        </div>
    </div>

    <div id="curriculumModal" class="hidden fixed inset-0 z-[60] bg-gray-900/95 backdrop-blur-sm transition-opacity duration-300">
        <div class="flex h-screen w-full p-4 gap-4">
            
            <div class="w-1/3 max-w-sm bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden animate-fade-in-up">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div>
                        <h3 class="font-extrabold text-gray-800 text-lg">Cấu trúc khóa học</h3>
                        <p id="editorCourseTitle" class="text-xs text-gray-500 truncate w-40">Đang tải...</p>
                    </div>
                    <button onclick="addChapter()" class="px-3 py-1.5 bg-brand/10 text-brand rounded-lg text-sm font-bold hover:bg-brand hover:text-white transition-all">
                        <i class="fa-solid fa-folder-plus mr-1"></i> Thêm Chương
                    </button>
                </div>
                <div id="curriculumTree" class="flex-1 overflow-y-auto p-3 space-y-4 bg-white scrollbar-hide"></div>
                <div class="p-4 border-t border-gray-100 bg-gray-50 text-center">
                    <button onclick="saveCurriculum()" class="w-full py-3 bg-gradient-to-r from-brand to-teal-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                        <i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN
                    </button>
                    <button onclick="closeCurriculumModal()" class="mt-2 text-xs text-gray-500 hover:text-red-500 font-semibold">
                        Đóng không lưu
                    </button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden relative animate-fade-in-up" style="animation-delay: 0.1s;">
                <div id="editorWelcome" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-10">
                    <img src="https://cdn-icons-png.flaticon.com/512/3079/3079296.png" class="w-24 h-24 mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-bold text-gray-400">Chọn một bài học để chỉnh sửa</h3>
                    <p class="text-gray-400 text-sm">Hoặc tạo mới từ cột bên trái</p>
                </div>

                <div id="editorForm" class="hidden flex flex-col h-full">
                    <div class="h-16 border-b border-gray-100 flex items-center px-6 justify-between bg-white">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm" id="editLessonIndex">1</span>
                            <input type="text" id="editLessonTitle" class="text-lg font-bold text-gray-800 outline-none border-b border-transparent focus:border-brand placeholder-gray-300 w-96 transition-all" placeholder="Nhập tên bài học tại đây...">
                        </div>
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="setLessonType('video')" id="btnTypeVideo" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-brands fa-youtube mr-1"></i> Video</button>
                            <button onclick="setLessonType('pdf')" id="btnTypePdf" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-solid fa-file-pdf mr-1"></i> Tài liệu</button>
                            <button onclick="setLessonType('quiz')" id="btnTypeQuiz" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-solid fa-clipboard-question mr-1"></i> Bài tập</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-gray-50/50 p-8">
                        <div id="panelVideo" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Đường dẫn Video (YouTube)</label>
                                <input type="text" id="videoUrlInput" oninput="previewVideo(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand outline-none" placeholder="Ví dụ: https://www.youtube.com/watch?v=...">
                            </div>
                            <div id="videoPreviewArea" class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg hidden relative"><iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div>
                        </div>

                        <div id="panelPdf" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="flex gap-4 mb-4">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="pdfSource" value="upload" class="peer sr-only" checked onchange="togglePdfSource()"><div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand peer-checked:bg-teal-50 hover:bg-white text-center"><i class="fa-solid fa-cloud-arrow-up text-xl mb-1 block"></i>Tải file lên</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="pdfSource" value="drive" class="peer sr-only" onchange="togglePdfSource()"><div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-white text-center"><i class="fa-brands fa-google-drive text-xl mb-1 block"></i>Link Google Drive</div></label>
                            </div>
                            <div id="pdfUploadArea" class="bg-white p-8 rounded-xl border-2 border-dashed border-gray-300 text-center hover:border-brand cursor-pointer group">
                                <input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
                                <i class="fa-solid fa-file-pdf text-3xl text-gray-400 group-hover:text-brand mb-2"></i>
                                <p class="font-bold text-gray-700">Chọn file PDF để tải lên</p>
                                <div id="uploadProgress" class="hidden mt-4 text-xs font-bold text-brand">Đang tải lên...</div>
                            </div>
                            <div id="pdfDriveArea" class="hidden bg-white p-6 rounded-xl border border-gray-200"><input type="text" id="driveUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none" placeholder="Link Drive công khai..."></div>
                            <div id="pdfPreviewArea" class="h-[500px] bg-gray-800 rounded-xl overflow-hidden shadow-lg hidden"><iframe id="pdfFrame" class="w-full h-full" src=""></iframe></div>
                        </div>

                        <div id="panelQuiz" class="content-panel hidden max-w-4xl mx-auto text-center py-10">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-orange-100">
                                <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fa-solid fa-file-signature text-3xl text-orange-500"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Bài tập trắc nghiệm</h3>
                                
                                <div id="selectedExamInfo" class="hidden mb-6 bg-orange-50 p-4 rounded-xl border border-orange-200 text-left">
                                    <div class="text-xs font-bold text-orange-600 uppercase mb-1">Đề thi đang chọn:</div>
                                    <div id="selectedExamTitle" class="font-bold text-gray-800 text-lg">...</div>
                                    <div id="selectedExamId" class="text-xs text-gray-500 font-mono">ID: ...</div>
                                </div>

                                <p class="text-gray-500 mb-6 text-sm">Học sinh cần làm bài kiểm tra này để hoàn thành bài học.</p>
                                
                                <div class="flex justify-center gap-3">
                                    <button onclick="window.openExamSelector()" class="px-6 py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 shadow-lg transition-all flex items-center gap-2">
                                        <i class="fa-solid fa-folder-open"></i> Chọn từ Ngân hàng đề
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border-t border-gray-100 p-4 flex gap-6 text-sm font-bold text-gray-600">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand"><input type="checkbox" id="isPreview" class="accent-brand w-4 h-4"><span>Cho phép học thử</span></label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand"><input type="checkbox" id="isPublished" checked class="accent-brand w-4 h-4"><span>Đã xuất bản</span></label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="examSelectorModal" class="hidden fixed inset-0 z-[70] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 text-lg"><i class="fa-solid fa-folder-tree text-brand mr-2"></i> Chọn Đề Thi</h3>
                <div class="flex gap-2">
                    <a href="exam-editor.html" target="_blank" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700 flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> Tạo đề mới
                    </a>
                    <button onclick="document.getElementById('examSelectorModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold text-sm hover:bg-gray-300">Đóng</button>
                </div>
            </div>
            
            <div class="px-6 py-2 bg-white border-b border-gray-100 flex items-center gap-2 text-sm overflow-x-auto" id="selectorBreadcrumb">
                <span class="text-gray-400 cursor-pointer hover:text-brand" onclick="loadExamManager(null)"><i class="fa-solid fa-home"></i> Gốc</span>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div id="selectorContent" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <div class="col-span-full text-center py-10 text-gray-400">Đang tải dữ liệu...</div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, getDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Global
        let currentCourseId = null;
        let currentCurriculum = [];
        let activeChapIdx = -1;
        let activeLesIdx = -1;
        let currentSelectorFolderId = null; // Folder hiện tại trong Exam Selector

        // --- UTILS: TOAST & CUSTOM CONFIRM ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-white border-l-4 border-green-500 text-gray-800' : 'bg-white border-l-4 border-red-500 text-gray-800';
            const icon = type === 'success' ? '<i class="fa-solid fa-circle-check text-green-500 text-xl"></i>' : '<i class="fa-solid fa-circle-exclamation text-red-500 text-xl"></i>';
            
            toast.className = `toast-enter p-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] ${colors}`;
            toast.innerHTML = `${icon}<div class="font-bold text-sm">${message}</div>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        window.customConfirm = (message, onYes) => {
            const modal = document.getElementById('confirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnYes = document.getElementById('confirmBtnYes');
            
            msgEl.innerText = message;
            modal.classList.remove('hidden');
            
            // Xóa event listener cũ để tránh duplicate
            const newBtnYes = btnYes.cloneNode(true);
            btnYes.parentNode.replaceChild(newBtnYes, btnYes);
            
            newBtnYes.onclick = () => {
                modal.classList.add('hidden');
                onYes();
            };
        };
        window.closeConfirm = () => document.getElementById('confirmModal').classList.add('hidden');


        // --- MAIN LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'index.html';
            else loadCourses();
        });

        // 1. Load danh sách khóa học
        window.loadCourses = async () => {
            try {
                const q = query(collection(db, "public_courses"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const list = document.getElementById('courseListTable');
                list.innerHTML = '';
                
                if (querySnapshot.empty) {
                    list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có khóa học nào.</td></tr>`;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const c = doc.data();
                    const priceText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(c.price || 0);
                    let lessonCount = 0;
                    if(c.curriculum) c.curriculum.forEach(ch => lessonCount += ch.lessons.length);

                    const html = `
                    <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-100 last:border-0">
                        <td class="p-4"><img src="${c.thumbnail || 'https://via.placeholder.com/100'}" class="w-12 h-12 rounded-lg object-cover border border-gray-200"></td>
                        <td class="p-4">
                            <div class="font-bold text-gray-800">${c.title}</div>
                            <div class="text-xs text-gray-400">${lessonCount} bài học • ${c.curriculum ? c.curriculum.length : 0} chương</div>
                        </td>
                        <td class="p-4 font-mono font-bold text-gray-700">${priceText}</td>
                        <td class="p-4 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">${c.students || 0} HV</span></td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="window.openCurriculumEditor('${doc.id}')" class="p-2 bg-purple-50 text-purple-600 rounded hover:bg-purple-600 hover:text-white transition-all"><i class="fa-solid fa-book-open"></i></button>
                                <button onclick="window.editCourse('${doc.id}')" class="p-2 bg-gray-100 text-gray-600 rounded hover:bg-brand hover:text-white transition-all"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="window.deleteCourse('${doc.id}')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                    list.innerHTML += html;
                });
                document.getElementById('statTotalCourses').innerText = querySnapshot.size;
            } catch (error) { window.showToast("Lỗi tải danh sách: " + error.message, 'error'); }
        };

        // 2. Logic Editor (Thêm/Sửa/Xóa Chương & Bài)
        window.openCurriculumEditor = async (courseId) => {
            currentCourseId = courseId;
            activeChapIdx = -1;
            activeLesIdx = -1;
            document.getElementById('curriculumModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Reset UI
            document.getElementById('editorWelcome').classList.remove('hidden');
            document.getElementById('editorForm').classList.add('hidden');
            document.getElementById('editorCourseTitle').innerText = "Đang tải...";

            try {
                const docSnap = await getDoc(doc(db, "public_courses", courseId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('editorCourseTitle').innerText = data.title;
                    currentCurriculum = data.curriculum || [];
                    renderCurriculumTree();
                }
            } catch (e) { window.showToast("Lỗi tải: " + e.message, 'error'); }
        };

        function renderCurriculumTree() {
            const tree = document.getElementById('curriculumTree');
            tree.innerHTML = '';
            if (currentCurriculum.length === 0) {
                tree.innerHTML = `<div class="text-center mt-10 text-gray-400 text-sm">Chưa có nội dung.<br>Bấm "Thêm Chương" để bắt đầu.</div>`;
                return;
            }

            currentCurriculum.forEach((chap, cIdx) => {
                const chapDiv = document.createElement('div');
                chapDiv.className = "mb-4 border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm";
                chapDiv.innerHTML = `
                    <div class="bg-gray-50 p-3 flex justify-between items-center group hover:bg-gray-100 cursor-pointer">
                        <div class="flex-1 font-bold text-gray-800 text-sm" onclick="renameChapter(${cIdx})"><i class="fa-solid fa-folder-open text-brand mr-2"></i> ${chap.title}</div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="addLesson(${cIdx})" class="p-1 text-blue-600 hover:bg-blue-100 rounded"><i class="fa-solid fa-plus"></i></button>
                            <button onclick="deleteChapter(${cIdx})" class="p-1 text-red-600 hover:bg-red-100 rounded"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                
                const lessonsDiv = document.createElement('div');
                lessonsDiv.className = "divide-y divide-gray-100";
                
                (chap.lessons || []).forEach((les, lIdx) => {
                    const isActive = (cIdx === activeChapIdx && lIdx === activeLesIdx);
                    const lesItem = document.createElement('div');
                    lesItem.className = `p-3 pl-8 text-sm flex justify-between items-center cursor-pointer ${isActive ? 'bg-teal-50 text-brand font-bold border-l-4 border-brand' : 'hover:bg-gray-50 text-gray-600'}`;
                    lesItem.onclick = () => selectLesson(cIdx, lIdx);
                    let icon = les.type === 'pdf' ? 'fa-file-pdf' : (les.type === 'quiz' ? 'fa-clipboard-question' : 'fa-circle-play');
                    lesItem.innerHTML = `<div class="truncate"><i class="fa-regular ${icon} text-xs mr-2"></i>${les.title}</div><button onclick="event.stopPropagation(); deleteLesson(${cIdx}, ${lIdx})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>`;
                    lessonsDiv.appendChild(lesItem);
                });
                chapDiv.appendChild(lessonsDiv);
                tree.appendChild(chapDiv);
            });
        }

        window.addChapter = () => {
            const title = prompt("Tên chương mới:", `Chương ${currentCurriculum.length + 1}`);
            if (title) { currentCurriculum.push({ id: 'ch_'+Date.now(), title, lessons: [] }); renderCurriculumTree(); }
        };
        window.renameChapter = (cIdx) => {
            const t = prompt("Đổi tên chương:", currentCurriculum[cIdx].title);
            if(t) { currentCurriculum[cIdx].title = t; renderCurriculumTree(); }
        };
        window.deleteChapter = (cIdx) => {
            window.customConfirm(`Xóa chương "${currentCurriculum[cIdx].title}"?`, () => {
                currentCurriculum.splice(cIdx, 1);
                activeChapIdx = -1; activeLesIdx = -1;
                document.getElementById('editorWelcome').classList.remove('hidden');
                document.getElementById('editorForm').classList.add('hidden');
                renderCurriculumTree();
            });
        };
        window.addLesson = (cIdx) => {
            currentCurriculum[cIdx].lessons.push({ id: 'ls_'+Date.now(), title: "Bài học mới", type: 'video', content: '', isPublished: true });
            renderCurriculumTree();
            selectLesson(cIdx, currentCurriculum[cIdx].lessons.length - 1);
        };
        window.deleteLesson = (cIdx, lIdx) => {
            window.customConfirm("Xóa bài học này?", () => {
                currentCurriculum[cIdx].lessons.splice(lIdx, 1);
                if(cIdx === activeChapIdx && lIdx === activeLesIdx) {
                    document.getElementById('editorWelcome').classList.remove('hidden');
                    document.getElementById('editorForm').classList.add('hidden');
                }
                renderCurriculumTree();
            });
        };

        window.selectLesson = (cIdx, lIdx) => {
            activeChapIdx = cIdx; activeLesIdx = lIdx;
            const data = currentCurriculum[cIdx].lessons[lIdx];
            renderCurriculumTree();
            document.getElementById('editorWelcome').classList.add('hidden');
            document.getElementById('editorForm').classList.remove('hidden');
            
            document.getElementById('editLessonIndex').innerText = lIdx + 1;
            document.getElementById('editLessonTitle').value = data.title;
            window.setLessonType(data.type);

            // Bind Data
            if(data.type === 'video') {
                document.getElementById('videoUrlInput').value = data.content || '';
                window.previewVideo(data.content || '');
            } else if (data.type === 'pdf') {
                if(data.content && data.content.includes('drive.google.com')) {
                    document.querySelector('input[name="pdfSource"][value="drive"]').checked = true;
                    document.getElementById('driveUrlInput').value = data.content;
                } else {
                    document.querySelector('input[name="pdfSource"][value="upload"]').checked = true;
                    if(data.content) document.getElementById('pdfFrame').src = data.content;
                }
                window.togglePdfSource();
            } else if (data.type === 'quiz') {
                // Hiển thị thông tin đề thi đã chọn
                const infoBox = document.getElementById('selectedExamInfo');
                if (data.examId) {
                    infoBox.classList.remove('hidden');
                    document.getElementById('selectedExamTitle').innerText = data.examTitle || "Đề thi đã chọn";
                    document.getElementById('selectedExamId').innerText = "ID: " + data.examId;
                } else {
                    infoBox.classList.add('hidden');
                }
            }
            document.getElementById('isPreview').checked = data.isPreview || false;
            document.getElementById('isPublished').checked = data.isPublished !== false;
        };

        // UI Event Listeners for Editor
        document.getElementById('editLessonTitle').oninput = (e) => { if(activeChapIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].title = e.target.value; };
        document.getElementById('editLessonTitle').onblur = renderCurriculumTree;
        document.getElementById('videoUrlInput').oninput = (e) => { if(activeChapIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].content = e.target.value; };
        document.getElementById('driveUrlInput').oninput = (e) => { if(activeChapIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].content = e.target.value; };
        document.getElementById('isPreview').onchange = (e) => { if(activeChapIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].isPreview = e.target.checked; };
        document.getElementById('isPublished').onchange = (e) => { if(activeChapIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].isPublished = e.target.checked; };

        window.saveCurriculum = async () => {
            const btn = document.querySelector('button[onclick="saveCurriculum()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
            try {
                await updateDoc(doc(db, "public_courses", currentCourseId), { curriculum: currentCurriculum });
                window.showToast("Lưu giáo án thành công!");
            } catch(e) { window.showToast("Lỗi lưu: "+e.message, 'error'); }
            finally { btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN'; }
        };

        // ===============================================
        // 3. EXAM SELECTOR (FILE MANAGER MODAL) - NEW !!!
        // ===============================================

        window.openExamSelector = () => {
            document.getElementById('examSelectorModal').classList.remove('hidden');
            loadExamManager(null); // Load root
        };

        window.loadExamManager = async (folderId) => {
            currentSelectorFolderId = folderId;
            const container = document.getElementById('selectorContent');
            const breadcrumb = document.getElementById('selectorBreadcrumb');
            container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>';

            try {
                // Update Breadcrumb
                if(!folderId) breadcrumb.innerHTML = `<span class="text-brand font-bold"><i class="fa-solid fa-home"></i> Gốc</span>`;
                else {
                    // Cần query để lấy tên folder hiện tại (Để đơn giản ta chỉ hiện nút Back)
                    breadcrumb.innerHTML = `<span class="text-gray-400 cursor-pointer hover:text-brand" onclick="loadExamManager(null)"><i class="fa-solid fa-home"></i> Gốc</span> <span class="text-gray-400">/</span> <span class="text-gray-600 font-bold">Thư mục hiện tại</span>`;
                }

                // Query Folders
                let qFolders = query(collection(db, "folders"), where("parentId", "==", folderId || null));
                // Nếu folderId null, firestore query cần check null. (Lưu ý: folder root trong DB của bạn có thể là string rỗng "" hoặc null, cần check lại DB). 
                // Ở đây tôi giả định root là null. Nếu code dashboard dùng logic khác, bạn báo để tôi sửa.

                // Query Exams
                let qExams = query(collection(db, "exams"), where("folderId", "==", folderId || null));

                const [foldSnap, examSnap] = await Promise.all([getDocs(qFolders), getDocs(qExams)]);

                container.innerHTML = '';

                // Render Folders
                foldSnap.forEach(doc => {
                    const f = doc.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-brand cursor-pointer flex flex-col items-center justify-center gap-2 aspect-square transition-all";
                    el.onclick = () => loadExamManager(doc.id);
                    el.innerHTML = `<i class="fa-solid fa-folder text-4xl text-yellow-400"></i><div class="text-xs font-bold text-gray-700 text-center line-clamp-2">${f.name}</div>`;
                    container.appendChild(el);
                });

                // Render Exams
                examSnap.forEach(doc => {
                    const e = doc.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-orange-500 cursor-pointer flex flex-col items-center justify-center gap-2 aspect-square transition-all group relative";
                    el.onclick = () => selectExamFromManager(doc.id, e.title);
                    el.innerHTML = `
                        <div class="absolute top-2 right-2 text-green-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-circle-check"></i></div>
                        <i class="fa-solid fa-file-lines text-3xl text-gray-400 group-hover:text-orange-500"></i>
                        <div class="text-xs font-bold text-gray-700 text-center line-clamp-2">${e.title}</div>
                        <div class="text-[10px] text-gray-400">${e.questions ? e.questions.length : 0} câu</div>
                    `;
                    container.appendChild(el);
                });

                if (foldSnap.empty && examSnap.empty) {
                    container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">Thư mục trống</div>`;
                }

            } catch (err) {
                console.error(err);
                // Nếu lỗi query (do index), fallback về client filter (nếu DB nhỏ) hoặc báo lỗi
                container.innerHTML = `<div class="col-span-full text-center text-red-500">Lỗi tải dữ liệu. (Có thể do thiếu Index Firestore)</div>`;
            }
        };

        window.selectExamFromManager = (examId, examTitle) => {
            if(activeChapIdx === -1) return;
            // Update Data
            currentCurriculum[activeChapIdx].lessons[activeLesIdx].type = 'quiz';
            currentCurriculum[activeChapIdx].lessons[activeLesIdx].examId = examId;
            currentCurriculum[activeChapIdx].lessons[activeLesIdx].examTitle = examTitle;
            
            // Update UI
            document.getElementById('selectedExamInfo').classList.remove('hidden');
            document.getElementById('selectedExamTitle').innerText = examTitle;
            document.getElementById('selectedExamId').innerText = "ID: " + examId;
            
            // Close Modal & Toast
            document.getElementById('examSelectorModal').classList.add('hidden');
            window.showToast("Đã chọn đề thi: " + examTitle);
        };

        // --- Utils UI ---
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if(show===undefined) show = el.classList.contains('hidden');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }
        window.closeCurriculumModal = () => window.customConfirm("Đóng mà không lưu?", () => document.getElementById('curriculumModal').classList.add('hidden'));

        window.setLessonType = (type) => {
             if(activeChapIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].type = type;
             document.querySelectorAll('.type-btn').forEach(b => b.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all");
             const active = type==='video'?'btnTypeVideo':(type==='pdf'?'btnTypePdf':'btnTypeQuiz');
             document.getElementById(active).className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold shadow-sm transition-all " + (type==='video'?"bg-red-50 text-red-600":(type==='pdf'?"bg-blue-50 text-blue-600":"bg-orange-50 text-orange-600"));
             document.querySelectorAll('.content-panel').forEach(p=>p.classList.add('hidden'));
             document.getElementById(type==='video'?'panelVideo':(type==='pdf'?'panelPdf':'panelQuiz')).classList.remove('hidden');
        };

        window.previewVideo = (url) => {
             const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
             if(m&&m[2].length===11) { document.getElementById('videoFrame').src=`https://www.youtube.com/embed/${m[2]}`; document.getElementById('videoPreviewArea').classList.remove('hidden'); }
             else document.getElementById('videoPreviewArea').classList.add('hidden');
        };
        window.togglePdfSource = () => {
             const s = document.querySelector('input[name="pdfSource"]:checked').value;
             document.getElementById('pdfUploadArea').classList.toggle('hidden', s!=='upload');
             document.getElementById('pdfDriveArea').classList.toggle('hidden', s!=='drive');
        };
        window.editCourse = async (id) => {
             const d = await getDoc(doc(db,"public_courses",id));
             if(d.exists()) {
                 const dt=d.data();
                 document.getElementById('courseId').value=id; document.getElementById('cTitle').value=dt.title;
                 document.getElementById('cPrice').value=dt.price; document.getElementById('cStudents').value=dt.students;
                 document.getElementById('cDesc').value=dt.desc||''; document.getElementById('cThumb').value=dt.thumbnail||'';
                 window.toggleModal('courseModal',true);
             }
        };
        window.saveCourseBasic = async () => {
             const id = document.getElementById('courseId').value;
             const d = {
                 title:document.getElementById('cTitle').value, price: +document.getElementById('cPrice').value,
                 students: +document.getElementById('cStudents').value, desc:document.getElementById('cDesc').value, thumbnail:document.getElementById('cThumb').value,
                 updatedAt: new Date().toISOString()
             };
             try { if(id) await updateDoc(doc(db,"public_courses",id),d); else { d.createdAt=new Date().toISOString(); await setDoc(doc(collection(db,"public_courses")),d); } window.showToast("Đã lưu!"); window.toggleModal('courseModal',false); loadCourses(); } catch(e){window.showToast(e.message,'error');}
        };
        window.deleteCourse = (id) => window.customConfirm("Xóa khóa học này?", async()=>{ await deleteDoc(doc(db,"public_courses",id)); window.showToast("Đã xóa"); loadCourses(); });

        // Placeholder Upload
        window.handleUpload = (input) => {
             if(input.files[0]) {
                 alert("Bạn cần tích hợp code Upload Cloudflare vào hàm handleUpload dòng 480."); 
             }
        }
    </script>
</body>
</html>
