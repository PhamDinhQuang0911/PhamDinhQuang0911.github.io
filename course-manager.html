<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khóa học - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#0F766E', accent: '#F97316' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeIn 0.4s ease-out forwards; }
        .content-panel { transition: all 0.3s ease; }
    </style>
</head>
<body class="text-gray-700">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800">Quản lý Khóa học</h1>
                <p class="text-gray-500 text-sm mt-1">Quản lý danh sách, nội dung và học viên</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.toggleModal('courseModal')" class="bg-brand text-white px-5 py-2.5 rounded-xl hover:bg-teal-800 shadow-lg shadow-teal-700/20 font-bold transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-plus"></i> Thêm khóa học
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-layer-group"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Tổng số khóa học</div>
                    <div class="text-2xl font-black text-gray-800" id="statTotalCourses">...</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-users"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Tổng học viên</div>
                    <div class="text-2xl font-black text-gray-800" id="statTotalStudents">...</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-bold uppercase">Doanh thu tạm tính</div>
                    <div class="text-2xl font-black text-gray-800">Liên hệ Admin</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                            <th class="p-4 w-20">Ảnh</th>
                            <th class="p-4">Tên khóa học</th>
                            <th class="p-4">Giá bán</th>
                            <th class="p-4 text-center">Học viên</th>
                            <th class="p-4 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="courseListTable" class="text-sm">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="courseModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 text-lg" id="modalTitle">Thêm Khóa Học Mới</h3>
                <button onclick="window.toggleModal('courseModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="courseId">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên khóa học</label>
                    <input type="text" id="cTitle" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand focus:ring-1 focus:ring-brand outline-none transition-all" placeholder="VD: Luyện thi Toán 12...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giá bán (VNĐ)</label>
                        <input type="number" id="cPrice" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Học viên ảo</label>
                        <input type="number" id="cStudents" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả ngắn</label>
                    <textarea id="cDesc" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:border-brand outline-none" placeholder="Giới thiệu khóa học..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ảnh bìa (URL hoặc Upload)</label>
                    <div class="flex gap-2">
                        <input type="text" id="cThumb" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl outline-none" placeholder="https://...">
                        <label class="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl cursor-pointer hover:bg-gray-200"><i class="fa-solid fa-upload"></i> <input type="file" hidden onchange="window.handleUpload(this)"></label>
                    </div>
                    <img id="previewThumb" class="w-full h-32 object-cover rounded-xl mt-2 hidden">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-2">
                <button onclick="window.toggleModal('courseModal')" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">Hủy</button>
                <button onclick="window.saveCourseBasic()" class="px-6 py-2 bg-brand text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all">Lưu thông tin</button>
            </div>
        </div>
    </div>

    <div id="curriculumModal" class="hidden fixed inset-0 z-[60] bg-gray-900/95 backdrop-blur-sm transition-opacity duration-300">
        <div class="flex h-screen w-full p-4 gap-4">
            
            <div class="w-1/3 max-w-sm bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden animate-fade-in-up">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div>
                        <h3 class="font-extrabold text-gray-800 text-lg">Cấu trúc khóa học</h3>
                        <p id="editorCourseTitle" class="text-xs text-gray-500 truncate w-40">Đang tải...</p>
                    </div>
                    <button onclick="addChapter()" class="px-3 py-1.5 bg-brand/10 text-brand rounded-lg text-sm font-bold hover:bg-brand hover:text-white transition-all">
                        <i class="fa-solid fa-folder-plus mr-1"></i> Thêm Chương
                    </button>
                </div>

                <div id="curriculumTree" class="flex-1 overflow-y-auto p-3 space-y-4 bg-white scrollbar-hide">
                    <div class="text-center mt-10 text-gray-400">
                        <i class="fa-solid fa-layer-group text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">Chưa có nội dung nào.</p>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50 text-center">
                    <button onclick="saveCurriculum()" class="w-full py-3 bg-gradient-to-r from-brand to-teal-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                        <i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN
                    </button>
                    <button onclick="closeCurriculumModal()" class="mt-2 text-xs text-gray-500 hover:text-red-500 font-semibold">
                        Đóng không lưu
                    </button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden relative animate-fade-in-up" style="animation-delay: 0.1s;">
                
                <div id="editorWelcome" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-10">
                    <img src="https://cdn-icons-png.flaticon.com/512/3079/3079296.png" class="w-24 h-24 mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-bold text-gray-400">Chọn một bài học để chỉnh sửa</h3>
                    <p class="text-gray-400 text-sm">Hoặc tạo mới từ cột bên trái</p>
                </div>

                <div id="editorForm" class="hidden flex flex-col h-full">
                    <div class="h-16 border-b border-gray-100 flex items-center px-6 justify-between bg-white">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm" id="editLessonIndex">1</span>
                            <input type="text" id="editLessonTitle" class="text-lg font-bold text-gray-800 outline-none border-b border-transparent focus:border-brand placeholder-gray-300 w-96 transition-all" placeholder="Nhập tên bài học tại đây...">
                        </div>
                        
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="setLessonType('video')" id="btnTypeVideo" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all"><i class="fa-brands fa-youtube mr-1"></i> Video</button>
                            <button onclick="setLessonType('pdf')" id="btnTypePdf" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all"><i class="fa-solid fa-file-pdf mr-1"></i> Tài liệu</button>
                            <button onclick="setLessonType('quiz')" id="btnTypeQuiz" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all"><i class="fa-solid fa-clipboard-question mr-1"></i> Bài tập</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-gray-50/50 p-8">
                        
                        <div id="panelVideo" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Đường dẫn Video (YouTube)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="videoUrlInput" oninput="previewVideo(this.value)" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-all" placeholder="Ví dụ: https://www.youtube.com/watch?v=...">
                                </div>
                                <p class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-circle-info"></i> Hệ thống sẽ tự động lấy ID và hiển thị khung xem trước.</p>
                            </div>
                            
                            <div id="videoPreviewArea" class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg hidden relative group">
                                <iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        </div>

                        <div id="panelPdf" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="flex gap-4 mb-4">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfSource" value="upload" class="peer sr-only" checked onchange="togglePdfSource()">
                                    <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand peer-checked:bg-teal-50 hover:bg-white transition-all text-center">
                                        <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2 text-gray-400 peer-checked:text-brand"></i>
                                        <div class="font-bold text-sm text-gray-700">Tải file lên (Cloudflare)</div>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfSource" value="drive" class="peer sr-only" onchange="togglePdfSource()">
                                    <div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-white transition-all text-center">
                                        <i class="fa-brands fa-google-drive text-2xl mb-2 text-gray-400 peer-checked:text-blue-500"></i>
                                        <div class="font-bold text-sm text-gray-700">Link Google Drive</div>
                                    </div>
                                </label>
                            </div>

                            <div id="pdfUploadArea" class="bg-white p-8 rounded-xl border-2 border-dashed border-gray-300 text-center hover:border-brand transition-colors cursor-pointer group">
                                <input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-teal-50 transition-colors">
                                    <i class="fa-solid fa-file-pdf text-3xl text-gray-400 group-hover:text-brand"></i>
                                </div>
                                <p class="font-bold text-gray-700">Nhấn để chọn file PDF</p>
                                <p class="text-xs text-gray-400 mt-1">Hỗ trợ file tối đa 50MB</p>
                                <div id="uploadProgress" class="hidden mt-4">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-brand h-2 rounded-full" style="width: 45%"></div>
                                    </div>
                                    <p class="text-xs text-brand font-bold mt-1">Đang tải lên... 45%</p>
                                </div>
                            </div>

                            <div id="pdfDriveArea" class="hidden bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Dán link Google Drive (Chế độ công khai)</label>
                                <input type="text" id="driveUrlInput" oninput="previewDrive(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://drive.google.com/file/d/...">
                            </div>

                            <div id="pdfPreviewArea" class="h-[500px] bg-gray-800 rounded-xl overflow-hidden shadow-lg hidden">
                                <iframe id="pdfFrame" class="w-full h-full" src=""></iframe>
                            </div>
                        </div>

                        <div id="panelQuiz" class="content-panel hidden max-w-4xl mx-auto text-center py-10">
                            <div class="w-24 h-24 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                                <i class="fa-solid fa-star text-4xl text-orange-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Chọn đề thi kiểm tra</h3>
                            <p class="text-gray-500 mb-6 max-w-md mx-auto">Học sinh cần làm đạt điểm yêu cầu của bài tập này mới được học bài tiếp theo.</p>
                            
                            <div class="flex justify-center gap-4">
                                <button class="px-6 py-3 bg-white border-2 border-orange-500 text-orange-600 rounded-xl font-bold hover:bg-orange-50 transition-all flex items-center gap-2">
                                    <i class="fa-solid fa-list-check"></i> Chọn từ Ngân hàng đề
                                </button>
                                <div class="relative">
                                    <select id="examSelect" class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl outline-none focus:border-orange-500 font-semibold w-64">
                                        <option value="">-- Đề thi đã chọn --</option>
                                        </select>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="bg-white border-t border-gray-100 p-4 flex gap-6 text-sm font-bold text-gray-600">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand">
                            <input type="checkbox" id="isPreview" class="accent-brand w-4 h-4">
                            <span>Cho phép học thử (Preview)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand">
                            <input type="checkbox" id="isPublished" checked class="accent-brand w-4 h-4">
                            <span>Đã xuất bản (Hiện cho HS)</span>
                        </label>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // --- CẤU HÌNH FIREBASE CỦA BẠN (Đừng quên điền vào đây nhé!) ---
         const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Biến toàn cục quản lý trạng thái
        let currentCourseId = null;
        let currentCurriculum = []; // Mảng chứa dữ liệu giáo án
        let activeChapIdx = -1; // Chỉ số chương đang chọn
        let activeLesIdx = -1;  // Chỉ số bài học đang chọn
        let pendingDeletions = []; // Danh sách file cần xóa trên Cloud (rác)

        // URL Worker Cloudflare để xóa file (Bạn cần điền URL worker của bạn vào đây)
        // Nếu chưa có, bạn có thể để trống, tính năng xóa file trên cloud sẽ tạm bỏ qua.
        const CLOUDFLARE_WORKER_URL = "https://your-worker.your-subdomain.workers.dev/delete"; 

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'index.html';
            else {
                loadCourses();
                loadExamsForSelect(); // Tải sẵn danh sách đề thi
            }
        });

        // ============================================================
        // 1. LOGIC QUẢN LÝ KHÓA HỌC (CRUD CƠ BẢN - GIỮ NGUYÊN TỪ PHẦN TRƯỚC)
        // ============================================================
        
        window.loadCourses = async () => {
            try {
                const q = query(collection(db, "public_courses"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const list = document.getElementById('courseListTable');
                list.innerHTML = '';
                let totalStudents = 0;

                if (querySnapshot.empty) {
                    list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có khóa học nào.</td></tr>`;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const c = doc.data();
                    const priceText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(c.price || 0);
                    totalStudents += (parseInt(c.students) || 0);

                    // Đếm số bài học
                    let lessonCount = 0;
                    if(c.curriculum) c.curriculum.forEach(ch => lessonCount += ch.lessons.length);

                    const html = `
                    <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-100 last:border-0">
                        <td class="p-4"><img src="${c.thumbnail || 'https://via.placeholder.com/100'}" class="w-12 h-12 rounded-lg object-cover border border-gray-200"></td>
                        <td class="p-4">
                            <div class="font-bold text-gray-800">${c.title}</div>
                            <div class="text-xs text-gray-400">${lessonCount} bài học • ${c.curriculum ? c.curriculum.length : 0} chương</div>
                        </td>
                        <td class="p-4 font-mono font-bold text-gray-700">${priceText}</td>
                        <td class="p-4 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">${c.students || 0} HV</span></td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="window.openCurriculumEditor('${doc.id}')" class="p-2 bg-purple-50 text-purple-600 rounded hover:bg-purple-600 hover:text-white transition-all"><i class="fa-solid fa-book-open"></i></button>
                                <button onclick="window.editCourse('${doc.id}')" class="p-2 bg-gray-100 text-gray-600 rounded hover:bg-brand hover:text-white transition-all"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="window.deleteCourse('${doc.id}')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                    list.innerHTML += html;
                });
                document.getElementById('statTotalCourses').innerText = querySnapshot.size;
                document.getElementById('statTotalStudents').innerText = totalStudents;
            } catch (error) { console.error(error); alert("Lỗi tải danh sách: " + error.message); }
        };

        // ... (Giữ nguyên các hàm toggleModal, editCourse, saveCourseBasic, deleteCourse, handleUpload từ phần trước) ...
        // Để tiết kiệm không gian hiển thị, tôi rút gọn phần CRUD cơ bản.
        // Bạn hãy giữ lại các hàm toggleModal, editCourse, saveCourseBasic như mã cũ đã hoạt động tốt.
        // Dưới đây là phần QUAN TRỌNG NHẤT: LOGIC EDITOR.

        window.toggleModal = (modalId, show) => { /* Code cũ */ 
            const modal = document.getElementById(modalId);
            if(show === undefined) show = modal.classList.contains('hidden');
            if(show) modal.classList.remove('hidden'); else modal.classList.add('hidden');
            // Reset form add logic here if needed
            if (modalId === 'courseModal' && show && !document.getElementById('courseId').value) {
                 document.getElementById('cTitle').value = ''; document.getElementById('courseId').value = '';
            }
        };

        window.saveCourseBasic = async () => { /* Code cũ */
             // Copy lại hàm saveCourseBasic từ code trước
             const id = document.getElementById('courseId').value;
             const data = {
                title: document.getElementById('cTitle').value,
                price: parseInt(document.getElementById('cPrice').value) || 0,
                students: parseInt(document.getElementById('cStudents').value) || 0,
                desc: document.getElementById('cDesc').value,
                thumbnail: document.getElementById('cThumb').value,
                updatedAt: new Date().toISOString()
            };
            try {
                if (id) await updateDoc(doc(db, "public_courses", id), data);
                else { data.createdAt = new Date().toISOString(); await setDoc(doc(collection(db, "public_courses")), data); }
                window.toggleModal('courseModal', false); loadCourses();
            } catch(e) { alert(e.message); }
        };
        
        window.editCourse = async (id) => { /* Code cũ */
            // Copy lại hàm editCourse từ code trước
             const d = await getDoc(doc(db, "public_courses", id));
             if(d.exists()){
                 const data = d.data();
                 document.getElementById('courseId').value = id;
                 document.getElementById('cTitle').value = data.title;
                 // ... fill others
                 window.toggleModal('courseModal', true);
             }
        };

        window.deleteCourse = async (id) => { /* Code cũ */ 
             if(confirm("Xóa khóa học?")) { await deleteDoc(doc(db, "public_courses", id)); loadCourses(); }
        };
        
        window.handleUpload = (input) => { alert("Vui lòng tích hợp API upload của bạn."); };


        // ============================================================
        // 2. LOGIC TRÌNH SOẠN THẢO GIÁO ÁN (PHẦN MỚI - PART 3)
        // ============================================================

        // --- A. Load & Render ---

        window.openCurriculumEditor = async (courseId) => {
            currentCourseId = courseId;
            activeChapIdx = -1;
            activeLesIdx = -1;
            pendingDeletions = []; // Reset hàng đợi xóa

            const modal = document.getElementById('curriculumModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Reset UI
            document.getElementById('editorWelcome').classList.remove('hidden');
            document.getElementById('editorForm').classList.add('hidden');
            document.getElementById('editorCourseTitle').innerText = "Đang tải...";

            try {
                const docRef = doc(db, "public_courses", courseId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('editorCourseTitle').innerText = data.title;
                    // Lấy dữ liệu curriculum, nếu chưa có thì khởi tạo mảng rỗng
                    currentCurriculum = data.curriculum || [];
                    renderCurriculumTree();
                }
            } catch (e) {
                console.error(e);
                alert("Lỗi tải nội dung: " + e.message);
            }
        };

        // Hàm vẽ cây thư mục (Recursive rendering không cần thiết vì chỉ có 2 cấp)
        function renderCurriculumTree() {
            const tree = document.getElementById('curriculumTree');
            tree.innerHTML = '';

            if (currentCurriculum.length === 0) {
                tree.innerHTML = `
                    <div class="text-center mt-10 text-gray-400">
                        <i class="fa-solid fa-layer-group text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">Chưa có nội dung.<br>Bấm "Thêm Chương" để bắt đầu.</p>
                    </div>`;
                return;
            }

            currentCurriculum.forEach((chap, cIdx) => {
                // HTML cho Chương
                const chapDiv = document.createElement('div');
                chapDiv.className = "mb-4 border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm";
                
                // Header chương
                chapDiv.innerHTML = `
                    <div class="bg-gray-50 p-3 flex justify-between items-center group cursor-pointer hover:bg-gray-100 transition-colors">
                        <div class="flex-1 font-bold text-gray-800 text-sm">
                            <i class="fa-solid fa-folder-open text-brand mr-2"></i> 
                            <span onclick="renameChapter(${cIdx})">${chap.title}</span>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="addLesson(${cIdx})" class="p-1.5 text-blue-600 hover:bg-blue-100 rounded" title="Thêm bài học"><i class="fa-solid fa-plus"></i></button>
                            <button onclick="deleteChapter(${cIdx})" class="p-1.5 text-red-600 hover:bg-red-100 rounded" title="Xóa chương"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;

                // List bài học trong chương
                const lessonsDiv = document.createElement('div');
                lessonsDiv.className = "divide-y divide-gray-100";
                
                if (chap.lessons && chap.lessons.length > 0) {
                    chap.lessons.forEach((les, lIdx) => {
                        const isActive = (cIdx === activeChapIdx && lIdx === activeLesIdx);
                        const lesItem = document.createElement('div');
                        lesItem.className = `p-3 pl-8 text-sm flex justify-between items-center cursor-pointer transition-colors ${isActive ? 'bg-teal-50 text-brand font-bold border-l-4 border-brand' : 'hover:bg-gray-50 text-gray-600'}`;
                        lesItem.onclick = () => selectLesson(cIdx, lIdx);
                        
                        // Icon theo loại
                        let icon = 'fa-circle-play';
                        if(les.type === 'pdf') icon = 'fa-file-pdf';
                        if(les.type === 'quiz') icon = 'fa-clipboard-question';

                        lesItem.innerHTML = `
                            <div class="flex items-center gap-2 truncate pr-2">
                                <i class="fa-regular ${icon} text-xs opacity-70"></i>
                                <span class="truncate">${les.title}</span>
                            </div>
                            <button onclick="event.stopPropagation(); deleteLesson(${cIdx}, ${lIdx})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        `;
                        lessonsDiv.appendChild(lesItem);
                    });
                } else {
                    lessonsDiv.innerHTML = `<div class="p-3 pl-8 text-xs text-gray-400 italic">Chưa có bài học nào</div>`;
                }

                chapDiv.appendChild(lessonsDiv);
                tree.appendChild(chapDiv);
            });
        }

        // --- B. Thao tác trên Dữ liệu (State Manipulation) ---

        window.addChapter = () => {
            const title = prompt("Nhập tên chương mới:", `Chương ${currentCurriculum.length + 1}`);
            if (title) {
                currentCurriculum.push({
                    id: 'chap_' + Date.now(),
                    title: title,
                    lessons: []
                });
                renderCurriculumTree();
            }
        };

        window.renameChapter = (cIdx) => {
            const newTitle = prompt("Đổi tên chương:", currentCurriculum[cIdx].title);
            if(newTitle) {
                currentCurriculum[cIdx].title = newTitle;
                renderCurriculumTree();
            }
        }

        window.deleteChapter = (cIdx) => {
            if(confirm(`Xóa chương "${currentCurriculum[cIdx].title}" và toàn bộ bài học bên trong?`)) {
                // Đưa toàn bộ file trong chương này vào danh sách chờ xóa
                const chap = currentCurriculum[cIdx];
                chap.lessons.forEach(l => {
                    if(l.type === 'pdf' && l.content && l.content.includes('http')) pendingDeletions.push(l.content);
                });
                
                currentCurriculum.splice(cIdx, 1);
                activeChapIdx = -1; activeLesIdx = -1;
                document.getElementById('editorWelcome').classList.remove('hidden');
                document.getElementById('editorForm').classList.add('hidden');
                renderCurriculumTree();
            }
        };

        window.addLesson = (cIdx) => {
            const newLesson = {
                id: 'les_' + Date.now(),
                title: "Bài học mới",
                type: 'video', // Mặc định
                content: '',
                isPreview: false,
                isPublished: true
            };
            currentCurriculum[cIdx].lessons.push(newLesson);
            renderCurriculumTree();
            // Tự động chọn bài vừa tạo
            selectLesson(cIdx, currentCurriculum[cIdx].lessons.length - 1);
        };

        window.deleteLesson = (cIdx, lIdx) => {
            if(confirm("Xóa bài học này?")) {
                const lesson = currentCurriculum[cIdx].lessons[lIdx];
                // Nếu bài học có file PDF/Ảnh lưu trên cloud, thêm vào hàng đợi xóa
                if(lesson.type === 'pdf' && lesson.content && lesson.content.includes('http')) {
                    pendingDeletions.push(lesson.content);
                }

                currentCurriculum[cIdx].lessons.splice(lIdx, 1);
                
                if(cIdx === activeChapIdx && lIdx === activeLesIdx) {
                    document.getElementById('editorWelcome').classList.remove('hidden');
                    document.getElementById('editorForm').classList.add('hidden');
                    activeChapIdx = -1; activeLesIdx = -1;
                }
                renderCurriculumTree();
            }
        };

        // --- C. Logic Editor & Binding ---

        window.selectLesson = (cIdx, lIdx) => {
            activeChapIdx = cIdx;
            activeLesIdx = lIdx;
            const data = currentCurriculum[cIdx].lessons[lIdx];

            // Render lại cây để highlight mục đang chọn
            renderCurriculumTree();

            // Ẩn welcome, hiện form
            document.getElementById('editorWelcome').classList.add('hidden');
            document.getElementById('editorForm').classList.remove('hidden');

            // Fill dữ liệu vào Form
            document.getElementById('editLessonIndex').innerText = lIdx + 1;
            document.getElementById('editLessonTitle').value = data.title;
            
            // Set type
            window.setLessonType(data.type); // Hàm UI đã viết ở phần trước
            
            // Set content specific fields
            if(data.type === 'video') {
                document.getElementById('videoUrlInput').value = data.content || '';
                window.previewVideo(data.content || '');
            } else if (data.type === 'pdf') {
                // Kiểm tra xem là link drive hay upload
                if(data.content && data.content.includes('drive.google.com')) {
                    document.querySelector('input[name="pdfSource"][value="drive"]').checked = true;
                    document.getElementById('driveUrlInput').value = data.content;
                    window.togglePdfSource(); // Update UI
                    window.previewDrive(data.content);
                } else {
                    document.querySelector('input[name="pdfSource"][value="upload"]').checked = true;
                    // Với file upload, ta không hiển thị lại input file, mà hiện link hiện tại (nếu cần)
                    // Ở đây đơn giản hóa: nếu có content (url), hiện preview
                    window.togglePdfSource();
                    if(data.content) {
                        document.getElementById('pdfFrame').src = data.content;
                        document.getElementById('pdfPreviewArea').classList.remove('hidden');
                    }
                }
            } else if (data.type === 'quiz') {
                document.getElementById('examSelect').value = data.examId || '';
            }

            document.getElementById('isPreview').checked = data.isPreview;
            document.getElementById('isPublished').checked = data.isPublished !== false;
        };

        // LẮNG NGHE SỰ KIỆN NHẬP LIỆU (AUTO UPDATE STATE)
        // Khi người dùng gõ, cập nhật ngay vào biến currentCurriculum
        
        document.getElementById('editLessonTitle').addEventListener('input', (e) => {
            if(activeChapIdx === -1) return;
            currentCurriculum[activeChapIdx].lessons[activeLesIdx].title = e.target.value;
            // Update title bên cây thư mục (Debounce nếu cần, ở đây làm simple)
            // renderCurriculumTree(); // Có thể gây lag nếu gõ nhanh, nên chỉ update khi blur
        });
        document.getElementById('editLessonTitle').addEventListener('blur', renderCurriculumTree);

        document.getElementById('videoUrlInput').addEventListener('input', (e) => {
             if(activeChapIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].content = e.target.value;
        });
        
        document.getElementById('driveUrlInput').addEventListener('input', (e) => {
             if(activeChapIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].content = e.target.value;
        });

        document.getElementById('examSelect').addEventListener('change', (e) => {
             if(activeChapIdx > -1) {
                 currentCurriculum[activeChapIdx].lessons[activeLesIdx].type = 'quiz';
                 currentCurriculum[activeChapIdx].lessons[activeLesIdx].examId = e.target.value;
             }
        });

        document.getElementById('isPreview').addEventListener('change', (e) => {
             if(activeChapIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].isPreview = e.target.checked;
        });
        document.getElementById('isPublished').addEventListener('change', (e) => {
             if(activeChapIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].isPublished = e.target.checked;
        });

        // Xử lý riêng cho Upload PDF (Logic phức tạp hơn)
        document.getElementById('pdfFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file || activeChapIdx === -1) return;

            // Hiển thị loading
            document.getElementById('uploadProgress').classList.remove('hidden');
            
            // Giả lập upload lên Cloudflare thông qua Worker
            // Nếu bạn có API, hãy thay thế đoạn này:
            try {
                /* const formData = new FormData();
                   formData.append('file', file);
                   const res = await fetch('YOUR_WORKER_UPLOAD_URL', { method: 'POST', body: formData });
                   const json = await res.json();
                   const fileUrl = json.url; 
                */
               
               // MOCKUP cho Demo (Vì tôi không có server upload của bạn)
               // Bạn cần thay thế bằng code upload thật
               alert("Đang giả lập upload... (Bạn cần gắn API upload thật vào dòng 340)");
               await new Promise(r => setTimeout(r, 1500)); // Fake wait
               const fileUrl = "https://example.com/demo.pdf"; // URL giả

               // Lưu URL vào data
               currentCurriculum[activeChapIdx].lessons[activeLesIdx].content = fileUrl;
               currentCurriculum[activeChapIdx].lessons[activeLesIdx].type = 'pdf';
               
               // Hiển thị
               document.getElementById('pdfFrame').src = fileUrl;
               document.getElementById('pdfPreviewArea').classList.remove('hidden');
               document.getElementById('uploadProgress').classList.add('hidden');
               alert("Upload thành công! (URL: " + fileUrl + ")");

            } catch(err) {
                alert("Lỗi upload: " + err.message);
                document.getElementById('uploadProgress').classList.add('hidden');
            }
        });


        // --- D. Lưu Trữ & Dọn Dẹp (Save & Cleanup) ---

        window.saveCurriculum = async () => {
            const btn = document.querySelector('button[onclick="saveCurriculum()"]');
            const originText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
            btn.disabled = true;

            try {
                // 1. Lưu cấu trúc mới lên Firestore
                await updateDoc(doc(db, "public_courses", currentCourseId), {
                    curriculum: currentCurriculum,
                    updatedAt: new Date().toISOString()
                });

                // 2. Xử lý xóa file rác trên Cloudflare (Nếu có)
                if (pendingDeletions.length > 0) {
                    console.log("Đang dọn dẹp file rác:", pendingDeletions);
                    
                    // Gọi API Worker để xóa file (Gửi mảng url cần xóa)
                    // Lưu ý: Worker của bạn cần hỗ trợ method DELETE hoặc POST với body chứa list file
                    /*
                    await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ files: pendingDeletions })
                    });
                    */
                   
                    // Nếu dùng file_content_fetcher cleanup.html logic:
                    // Vì cleanup.html chạy client-side với Firebase Storage SDK, 
                    // nếu bạn dùng R2 thì phải dùng API. 
                    // Tạm thời tôi log ra console.
                    console.warn("Đã đánh dấu xóa các file sau (Cần tích hợp API Worker để xóa thật):", pendingDeletions);
                }

                pendingDeletions = []; // Reset sau khi xóa thành công
                alert("Đã lưu giáo án thành công!");
                
            } catch (e) {
                console.error(e);
                alert("Lỗi khi lưu: " + e.message);
            } finally {
                btn.innerHTML = originText;
                btn.disabled = false;
            }
        };

        // --- E. Tích hợp Ngân hàng Đề ---
        window.loadExamsForSelect = async () => {
            try {
                // Lấy danh sách đề thi từ collection 'exams'
                const q = query(collection(db, "exams"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                const select = document.getElementById('examSelect');
                
                let html = '<option value="">-- Chọn đề thi từ kho --</option>';
                snapshot.forEach(doc => {
                    const exam = doc.data();
                    html += `<option value="${doc.id}">${exam.title} (${exam.questions ? exam.questions.length : 0} câu)</option>`;
                });
                select.innerHTML = html;
            } catch (e) {
                console.error("Không tải được danh sách đề thi:", e);
            }
        };

        // --- UI Utils (Copy lại từ phần 2 để đảm bảo hoạt động) ---
        window.setLessonType = (type) => {
            // Cập nhật biến global loại hiện tại
            if(activeChapIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].type = type;

            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white hover:shadow-sm transition-all";
            });
            const activeBtn = document.getElementById(
                type === 'video' ? 'btnTypeVideo' : 
                type === 'pdf' ? 'btnTypePdf' : 'btnTypeQuiz'
            );
            if(activeBtn) activeBtn.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold shadow-sm transition-all " + 
                (type === 'video' ? "bg-red-50 text-red-600" : 
                 type === 'pdf' ? "bg-blue-50 text-blue-600" : "bg-orange-50 text-orange-600");

            document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
            const panelId = type === 'video' ? 'panelVideo' : type === 'pdf' ? 'panelPdf' : 'panelQuiz';
            document.getElementById(panelId).classList.remove('hidden');
        };
        
        window.previewVideo = (url) => {
            const previewArea = document.getElementById('videoPreviewArea');
            const iframe = document.getElementById('videoFrame');
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                iframe.src = `https://www.youtube.com/embed/${match[2]}`;
                previewArea.classList.remove('hidden');
            } else { previewArea.classList.add('hidden'); iframe.src = ""; }
        };

        window.togglePdfSource = () => {
            const source = document.querySelector('input[name="pdfSource"]:checked').value;
            if(source === 'upload') {
                document.getElementById('pdfUploadArea').classList.remove('hidden');
                document.getElementById('pdfDriveArea').classList.add('hidden');
            } else {
                document.getElementById('pdfUploadArea').classList.add('hidden');
                document.getElementById('pdfDriveArea').classList.remove('hidden');
            }
        };

        window.previewDrive = (url) => {
            const previewArea = document.getElementById('pdfPreviewArea');
            const iframe = document.getElementById('pdfFrame');
            if(url.includes('drive.google.com')) {
                let embedUrl = url.replace('/view', '/preview').replace('/edit', '/preview');
                iframe.src = embedUrl;
                previewArea.classList.remove('hidden');
            } else { previewArea.classList.add('hidden'); }
        };
        
        window.closeCurriculumModal = () => {
             if(confirm("Đóng mà không lưu?")) {
                 document.getElementById('curriculumModal').classList.add('hidden');
                 document.body.style.overflow = '';
             }
        };

    </script>
</body>
</html>
