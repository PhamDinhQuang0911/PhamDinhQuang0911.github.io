<!DOCTYPE html>
<html lang="vi" class="transition-colors duration-200">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Kh√≥a h·ªçc - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { 
                    colors: { brand: '#0F766E', accent: '#F97316' } 
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Input Styles */
        .input-std {
            @apply w-full px-4 py-2 rounded-lg border outline-none transition-all duration-200 text-sm;
            @apply bg-white border-gray-300 text-gray-800 focus:ring-2 focus:ring-brand focus:border-transparent;
            @apply dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:focus:ring-brand;
        }
        
        /* Tree Item Styles */
        .tree-item {
            @apply flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all border border-transparent;
            @apply hover:bg-gray-100 dark:hover:bg-slate-700;
        }
        .tree-item.active {
            @apply bg-teal-50 border-teal-200 text-brand font-bold;
            @apply dark:bg-teal-900/30 dark:border-teal-700 dark:text-teal-400;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-gray-100 transition-colors duration-200">

    <header class="h-16 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='dashboard.html'" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fa-solid fa-arrow-left text-xl"></i></button>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span class="w-8 h-8 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg flex items-center justify-center"><i class="fa-solid fa-shapes"></i></span>
                Qu·∫£n l√Ω Kh√≥a h·ªçc
            </h1>
        </div>
        <div class="flex gap-2">
            <button onclick="window.toggleThemeMode()" id="themeToggleBtn" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-slate-600 transition-all flex items-center justify-center mr-2">
                <i class="fa-solid fa-moon"></i>
            </button>
            <button onclick="window.openCourseModal()" class="px-4 py-2 bg-brand text-white font-bold rounded-lg text-sm hover:bg-teal-700 transition-colors shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Th√™m kh√≥a m·ªõi
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 relative">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 dark:bg-slate-700 text-gray-500 dark:text-gray-400 text-xs uppercase font-bold sticky top-0 z-10 border-b border-gray-200 dark:border-slate-600">
                            <tr>
                                <th class="p-4 whitespace-nowrap w-20">·∫¢nh</th>
                                <th class="p-4 whitespace-nowrap">T√™n kh√≥a h·ªçc</th>
                                <th class="p-4 whitespace-nowrap">H·ªçc ph√≠</th>
                                <th class="p-4 whitespace-nowrap text-center">H·ªçc vi√™n</th>
                                <th class="p-4 whitespace-nowrap text-right">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="courseListTable" class="divide-y divide-gray-100 dark:divide-slate-700 text-sm">
                            <tr><td colspan="5" class="p-8 text-center text-gray-400 italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="courseModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900/60 backdrop-blur-sm p-4 transition-all duration-300">
        <div class="bg-white dark:bg-slate-800 w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="px-6 py-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-gray-50 dark:bg-slate-700/50">
                <h3 class="font-bold text-gray-800 dark:text-white text-lg" id="courseModalTitle">Th√¥ng tin kh√≥a h·ªçc</h3>
                <button onclick="window.toggleModal('courseModal', false)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">·∫¢nh b√¨a (16:9)</label>
                        <div class="relative group cursor-pointer border-2 border-dashed border-gray-300 dark:border-slate-600 rounded-xl overflow-hidden aspect-video bg-gray-50 dark:bg-slate-700 flex items-center justify-center hover:border-brand transition-all" onclick="document.getElementById('courseThumbInput').click()">
                            <img id="courseThumbPreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                            <div class="text-center text-gray-400 dark:text-gray-500 group-hover:text-brand z-10">
                                <i class="fa-solid fa-cloud-arrow-up text-3xl mb-1"></i>
                                <p class="text-xs font-bold">T·∫£i ·∫£nh l√™n</p>
                            </div>
                            <input type="file" id="courseThumbInput" class="hidden" accept="image/*" onchange="window.handleUpload(this, 'thumb')">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1">T√™n kh√≥a h·ªçc</label><input type="text" id="cTitle" class="input-std" placeholder="VD: Luy·ªán thi To√°n 10"></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1">Gi√° b√°n (VNƒê)</label><input type="number" id="cPrice" class="input-std font-bold text-brand" placeholder="0"></div>
                            <div><label class="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1">Gi√° g·ªëc</label><input type="number" id="cOriginalPrice" class="input-std text-gray-500 line-through"></div>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1">Tag (Nh√£n)</label><input type="text" id="cTag" class="input-std" placeholder="M·ªõi, Hot..."></div>
                        <div><label class="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1">S·ªë h·ªçc sinh (Fake)</label><input type="text" id="cStudentCount" class="input-std" value="0"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 flex flex-col h-full space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1">M√¥ t·∫£ ng·∫Øn</label>
                        <textarea id="cShortDesc" class="input-std h-24 resize-none" placeholder="Hi·ªán ·ªü trang ch·ªß..."></textarea>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-700 dark:text-gray-300">Gi·ªõi thi·ªáu chi ti·∫øt</label>
                            <button onclick="document.getElementById('descImgInput').click()" class="text-xs bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 px-2 py-1 rounded text-blue-600 dark:text-blue-400 font-bold"><i class="fa-regular fa-image"></i> Ch√®n ·∫£nh</button>
                            <input type="file" id="descImgInput" class="hidden" accept="image/*" onchange="window.handleUpload(this, 'desc')">
                        </div>
                        <textarea id="cFullDesc" class="input-std flex-1 font-mono text-sm leading-relaxed p-4 h-48" placeholder="H·ªó tr·ª£ HTML c∆° b·∫£n..."></textarea>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-100 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 flex justify-end gap-3">
                <button onclick="window.toggleModal('courseModal', false)" class="px-5 py-2.5 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-xl font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-600 text-sm">H·ªßy b·ªè</button>
                <button onclick="window.saveCourse()" class="px-6 py-2.5 bg-brand text-white rounded-xl font-bold shadow-lg hover:bg-teal-700 text-sm flex items-center gap-2"><i class="fa-solid fa-save"></i> L∆∞u th√¥ng tin</button>
            </div>
        </div>
    </div>

    <div id="curriculumModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900/80 backdrop-blur-sm p-4 transition-all duration-300">
        <div class="bg-white dark:bg-slate-800 w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 flex justify-between items-center bg-gray-50 dark:bg-slate-700/50 shrink-0">
                <div>
                    <h3 class="font-bold text-gray-800 dark:text-white text-lg flex items-center gap-2"><i class="fa-solid fa-layer-group text-purple-600"></i> Bi√™n t·∫≠p n·ªôi dung</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400" id="curriculumCourseTitle">ƒêang t·∫£i...</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.toggleModal('curriculumModal', false)" class="px-4 py-2 text-gray-500 dark:text-gray-400 font-bold hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-sm">ƒê√≥ng</button>
                    <button onclick="window.saveCurriculum()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm shadow hover:bg-blue-700 flex items-center gap-2"><i class="fa-solid fa-save"></i> L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 border-r border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900 flex flex-col">
                    <div class="p-4 border-b border-gray-200 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800">
                        <h4 class="font-bold text-sm text-gray-700 dark:text-gray-300 uppercase">C·∫•u tr√∫c</h4>
                        <button onclick="window.addChapter()" class="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 px-2 py-1 rounded font-bold hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors"><i class="fa-solid fa-plus"></i> Th√™m ch∆∞∆°ng</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="curriculumTree">
                        </div>
                </div>

                <div class="w-2/3 bg-white dark:bg-slate-800 flex flex-col">
                    <div id="editorPlaceholder" class="flex-1 flex flex-col items-center justify-center text-gray-400 dark:text-slate-500">
                        <i class="fa-regular fa-hand-point-left text-4xl mb-3"></i>
                        <p>Ch·ªçn m·ªôt b√†i h·ªçc ƒë·ªÉ ch·ªânh s·ª≠a</p>
                    </div>

                    <div id="lessonEditor" class="hidden flex-1 flex-col h-full">
                        <div class="p-6 border-b border-gray-100 dark:border-slate-700">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">T√™n b√†i h·ªçc</label>
                            <input type="text" id="leTitle" class="text-xl font-bold w-full bg-transparent border-none focus:ring-0 outline-none placeholder-gray-300 dark:placeholder-slate-600 text-gray-800 dark:text-white p-0" placeholder="Nh·∫≠p t√™n b√†i h·ªçc...">
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Lo·∫°i b√†i h·ªçc</label>
                                    <select id="leType" onchange="window.handleLessonTypeChange()" class="input-std">
                                        <option value="video">üé• Video (YouTube)</option>
                                        <option value="text">üìÑ T√†i li·ªáu (Text/PDF)</option>
                                        <option value="quiz">üìù B√†i t·∫≠p (ƒê·ªÅ thi)</option>
                                    </select>
                                </div>
                                <div class="flex items-center pt-6">
                                    <label class="flex items-center cursor-pointer gap-2 select-none">
                                        <input type="checkbox" id="lePreview" class="w-5 h-5 rounded border-gray-300 text-brand focus:ring-brand">
                                        <span class="text-sm font-bold text-gray-700 dark:text-gray-300">Cho ph√©p h·ªçc th·ª≠ (Free)</span>
                                    </label>
                                </div>
                            </div>

                            <div id="areaVideo" class="space-y-2">
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">ƒê∆∞·ªùng d·∫´n Video (YouTube ID ho·∫∑c URL)</label>
                                <input type="text" id="leVideoUrl" class="input-std font-mono text-blue-600 dark:text-blue-400" placeholder="VD: https://youtu.be/..." oninput="window.previewVideo(this.value)">
                                <div class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg mt-3 relative">
                                    <iframe id="videoPreviewFrame" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
                                    <div id="videoPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500">Preview Video</div>
                                </div>
                            </div>

                            <div id="areaText" class="hidden space-y-2 h-64 flex flex-col">
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">N·ªôi dung b√†i h·ªçc</label>
                                <textarea id="leContent" class="input-std flex-1 font-mono leading-relaxed resize-none p-4" placeholder="Nh·∫≠p n·ªôi dung b√†i h·ªçc, h·ªó tr·ª£ HTML..."></textarea>
                            </div>

                            <div id="areaQuiz" class="hidden space-y-2">
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Ch·ªçn ƒë·ªÅ thi t·ª´ Ng√¢n h√†ng</label>
                                <div class="flex gap-2">
                                    <select id="leExamSelect" class="input-std">
                                        <option value="">-- Ch·ªçn ƒë·ªÅ thi --</option>
                                        </select>
                                    <button onclick="window.refreshExamList()" class="px-3 bg-gray-100 dark:bg-slate-700 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600"><i class="fa-solid fa-rotate"></i></button>
                                </div>
                                <p class="text-xs text-gray-400 italic">H·ªçc sinh c·∫ßn l√†m ƒë·∫°t ƒëi·ªÉm qua m√¥n m·ªõi ƒë∆∞·ª£c t√≠nh l√† ho√†n th√†nh b√†i h·ªçc n√†y.</p>
                            </div>
                        </div>

                        <div class="p-4 border-t border-gray-100 dark:border-slate-700 bg-gray-50 dark:bg-slate-900 flex justify-between items-center">
                            <span class="text-xs text-gray-400 italic" id="leStatus">Ch∆∞a l∆∞u thay ƒë·ªïi</span>
                            <button onclick="window.updateCurrentLesson()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow text-sm">C·∫≠p nh·∫≠t b√†i h·ªçc</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notificationContainer" class="fixed top-5 right-5 z-[200] flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, getDocs, deleteDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // BI·∫æN TO√ÄN C·ª§C
        let currentCourseId = null;
        let currentThumbUrl = "";
        let currentUserId = null;
        
        // BI·∫æN CHO COURSE BUILDER
        let editingCurriculumCourseId = null;
        let currentCurriculum = []; // M·∫£ng ch·ª©a ch∆∞∆°ng (Chapters)
        let selectedChapterIndex = -1;
        let selectedLessonIndex = -1;
        let examListCache = []; // Cache danh s√°ch ƒë·ªÅ thi

        // --- DARK MODE LOGIC ---
        window.applyTheme = () => {
            const mode = localStorage.getItem('theme_mode') || 'auto';
            const html = document.documentElement;
            const btn = document.getElementById('themeToggleBtn');
            let isDark = false;
            if (mode === 'auto') {
                const hour = new Date().getHours();
                if (hour >= 18 || hour < 6) isDark = true;
                if(btn) btn.innerHTML = '<i class="fa-solid fa-clock"></i>'; 
            } else if (mode === 'dark') {
                isDark = true;
                if(btn) btn.innerHTML = '<i class="fa-solid fa-moon"></i>';
            } else {
                isDark = false;
                if(btn) btn.innerHTML = '<i class="fa-solid fa-sun"></i>';
            }
            if (isDark) html.classList.add('dark'); else html.classList.remove('dark');
        }
        window.toggleThemeMode = () => {
            const modes = ['light', 'dark', 'auto'];
            const current = localStorage.getItem('theme_mode') || 'auto';
            const nextMode = modes[(modes.indexOf(current) + 1) % modes.length];
            localStorage.setItem('theme_mode', nextMode);
            window.applyTheme();
        }
        window.applyTheme();

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else {
                currentUserId = user.uid;
                loadCourses();
                loadAllExamsForSelect(); // T·∫£i tr∆∞·ªõc danh s√°ch ƒë·ªÅ thi
            }
        });

        // --- H√ÄM UI ---
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            const container = el.querySelector('.modal-container') || el.children[0];
            if(show) { 
                el.classList.remove('opacity-0', 'pointer-events-none'); 
                document.body.classList.add('modal-active');
                if(container) { container.classList.remove('scale-95'); container.classList.add('scale-100'); }
            } else { 
                el.classList.add('opacity-0', 'pointer-events-none'); 
                document.body.classList.remove('modal-active');
                if(container) { container.classList.remove('scale-100'); container.classList.add('scale-95'); }
            }
        }

        window.showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            const color = type === 'success' ? 'green' : 'red';
            div.className = `pointer-events-auto bg-white dark:bg-slate-800 border-l-4 border-${color}-500 shadow-xl rounded-lg p-4 w-80 flex items-start gap-3 transform translate-x-full transition-all duration-300`;
            div.innerHTML = `<i class="fa-solid fa-${type==='success'?'check':'circle-exclamation'} text-${color}-500 mt-1"></i><div><h4 class="font-bold text-gray-800 dark:text-white text-sm">${type==='success'?'Th√†nh c√¥ng':'L·ªói'}</h4><p class="text-sm text-gray-600 dark:text-gray-300">${msg}</p></div>`;
            container.appendChild(div);
            requestAnimationFrame(() => div.classList.remove('translate-x-full'));
            setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 500); }, 3000);
        }

        // --- LOGIC 1: QU·∫¢N L√ù KH√ìA H·ªåC (CRUD) ---
        async function loadCourses() {
            const tbody = document.getElementById('courseListTable');
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            try {
                const q = query(collection(db, "public_courses"));
                const snap = await getDocs(q);
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</td></tr>'; return; }

                let html = '';
                snap.forEach(doc => {
                    const c = doc.data();
                    const priceText = parseInt(c.price || 0) === 0 ? '<span class="text-green-600 font-bold">Mi·ªÖn ph√≠</span>' : parseInt(c.price).toLocaleString('vi-VN') + 'ƒë';
                    html += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors group border-b border-gray-100 dark:border-slate-700 last:border-0">
                        <td class="p-4"><img src="${c.thumbnail || 'https://via.placeholder.com/100'}" class="w-12 h-12 rounded-lg object-cover border border-gray-200 dark:border-slate-600 shadow-sm"></td>
                        <td class="p-4"><div class="font-bold text-gray-800 dark:text-white text-base mb-0.5">${c.title}</div><div class="text-xs text-gray-400 dark:text-gray-500 line-clamp-1">${c.desc || c.shortDesc || '...'}</div></td>
                        <td class="p-4 font-mono font-bold text-gray-700 dark:text-gray-300">${priceText}</td>
                        <td class="p-4 text-center"><span class="bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded text-xs font-bold border border-blue-100 dark:border-blue-800">${c.students || 0}</span></td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2 opacity-100">
                                <button onclick="window.openCurriculumEditor('${doc.id}')" class="px-3 py-1.5 bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-300 border border-purple-200 dark:border-purple-800 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-colors text-xs font-bold flex items-center gap-1" title="Bi√™n t·∫≠p n·ªôi dung"><i class="fa-solid fa-layer-group"></i> Bi√™n t·∫≠p</button>
                                <button onclick="window.editCourse('${doc.id}')" class="p-2 bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors" title="S·ª≠a th√¥ng tin"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="window.deleteCourse('${doc.id}')" class="p-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors" title="X√≥a"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>'; }
        }

        window.openCourseModal = () => {
            currentCourseId = null; currentThumbUrl = "";
            document.getElementById('courseModalTitle').innerText = "Th√™m kh√≥a h·ªçc m·ªõi";
            ['cTitle','cPrice','cOriginalPrice','cTag','cStudentCount','cShortDesc','cFullDesc'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('courseThumbPreview').classList.add('hidden');
            window.toggleModal('courseModal', true);
        };

        window.editCourse = async (id) => {
            currentCourseId = id;
            try {
                const docSnap = await getDoc(doc(db, "public_courses", id));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('courseModalTitle').innerText = "Ch·ªânh s·ª≠a kh√≥a h·ªçc";
                    document.getElementById('cTitle').value = d.title;
                    document.getElementById('cPrice').value = d.price;
                    document.getElementById('cOriginalPrice').value = d.originalPrice;
                    document.getElementById('cTag').value = d.tag;
                    document.getElementById('cStudentCount').value = d.students;
                    document.getElementById('cShortDesc').value = d.shortDesc;
                    document.getElementById('cFullDesc').value = d.fullDesc;
                    currentThumbUrl = d.thumbnail;
                    if(d.thumbnail) { document.getElementById('courseThumbPreview').src = d.thumbnail; document.getElementById('courseThumbPreview').classList.remove('hidden'); }
                    window.toggleModal('courseModal', true);
                }
            } catch(e) { console.error(e); }
        };

        window.saveCourse = async () => {
            const data = {
                title: document.getElementById('cTitle').value,
                price: document.getElementById('cPrice').value,
                originalPrice: document.getElementById('cOriginalPrice').value,
                tag: document.getElementById('cTag').value,
                students: document.getElementById('cStudentCount').value,
                shortDesc: document.getElementById('cShortDesc').value,
                fullDesc: document.getElementById('cFullDesc').value,
                thumbnail: currentThumbUrl,
                updatedAt: new Date().toISOString()
            };
            if(!data.title) return window.showNotification("Vui l√≤ng nh·∫≠p t√™n kh√≥a h·ªçc", "error");
            try {
                if(currentCourseId) { await setDoc(doc(db, "public_courses", currentCourseId), data, {merge: true}); window.showNotification("ƒê√£ c·∫≠p nh·∫≠t kh√≥a h·ªçc!", "success"); } 
                else { data.createdAt = new Date().toISOString(); await addDoc(collection(db, "public_courses"), data); window.showNotification("ƒê√£ th√™m kh√≥a h·ªçc m·ªõi!", "success"); }
                window.toggleModal('courseModal', false); loadCourses();
            } catch(e) { window.showNotification("L·ªói l∆∞u: " + e.message, "error"); }
        };

        window.deleteCourse = async (id) => {
            if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√≥a h·ªçc n√†y kh√¥ng?")) {
                try { await deleteDoc(doc(db, "public_courses", id)); window.showNotification("ƒê√£ x√≥a kh√≥a h·ªçc!", "success"); loadCourses(); } catch(e) { window.showNotification("L·ªói x√≥a: " + e.message, "error"); }
            }
        };

        // --- LOGIC 2: COURSE BUILDER (BI√äN T·∫¨P N·ªòI DUNG) ---
        
        // 2.1 Load & Render Tree
        window.openCurriculumEditor = async (courseId) => {
            editingCurriculumCourseId = courseId;
            document.getElementById('curriculumCourseTitle').innerText = "ƒêang t·∫£i...";
            window.toggleModal('curriculumModal', true);
            
            try {
                const docSnap = await getDoc(doc(db, "public_courses", courseId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('curriculumCourseTitle').innerText = data.title;
                    currentCurriculum = data.curriculum || [];
                    renderCurriculumTree();
                    // Reset Editor View
                    document.getElementById('editorPlaceholder').classList.remove('hidden');
                    document.getElementById('lessonEditor').classList.add('hidden');
                    selectedChapterIndex = -1; selectedLessonIndex = -1;
                }
            } catch(e) { console.error(e); }
        };

        function renderCurriculumTree() {
            const container = document.getElementById('curriculumTree');
            container.innerHTML = '';
            
            if (currentCurriculum.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4">Ch∆∞a c√≥ ch∆∞∆°ng n√†o.</p>';
                return;
            }

            currentCurriculum.forEach((chap, cIdx) => {
                const chapDiv = document.createElement('div');
                chapDiv.className = "mb-2 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-600 overflow-hidden";
                
                // Header Ch∆∞∆°ng
                chapDiv.innerHTML = `
                    <div class="p-3 bg-gray-50 dark:bg-slate-700 flex items-center justify-between group">
                        <div class="flex items-center gap-2 flex-1">
                            <span class="font-bold text-sm text-gray-700 dark:text-gray-300">Ch∆∞∆°ng ${cIdx + 1}:</span>
                            <input type="text" value="${chap.title}" onchange="window.updateChapterTitle(${cIdx}, this.value)" class="bg-transparent border-none text-sm font-bold text-gray-800 dark:text-white outline-none w-full focus:bg-white dark:focus:bg-slate-600 rounded px-1">
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.deleteChapter(${cIdx})" class="text-red-500 hover:bg-red-100 p-1 rounded"><i class="fa-solid fa-trash text-xs"></i></button>
                            <button onclick="window.addLesson(${cIdx})" class="text-blue-600 hover:bg-blue-100 p-1 rounded" title="Th√™m b√†i h·ªçc"><i class="fa-solid fa-plus text-xs"></i></button>
                        </div>
                    </div>
                `;

                // List B√†i h·ªçc
                const lessonList = document.createElement('div');
                if (chap.lessons && chap.lessons.length > 0) {
                    chap.lessons.forEach((les, lIdx) => {
                        const isActive = (cIdx === selectedChapterIndex && lIdx === selectedLessonIndex);
                        const lesDiv = document.createElement('div');
                        lesDiv.className = `tree-item pl-8 text-sm ${isActive ? 'active' : 'text-gray-600 dark:text-gray-400'}`;
                        
                        let icon = 'fa-file-lines';
                        if (les.type === 'video') icon = 'fa-play-circle';
                        if (les.type === 'quiz') icon = 'fa-clipboard-question';

                        lesDiv.innerHTML = `
                            <div class="flex items-center gap-2 truncate" onclick="window.selectLesson(${cIdx}, ${lIdx})">
                                <i class="fa-regular ${icon}"></i> <span>${les.title}</span>
                            </div>
                            <button onclick="window.deleteLesson(${cIdx}, ${lIdx})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        `;
                        lessonList.appendChild(lesDiv);
                    });
                } else {
                    lessonList.innerHTML = '<div class="p-2 pl-8 text-xs text-gray-400 italic">Tr·ªëng</div>';
                }
                
                chapDiv.appendChild(lessonList);
                container.appendChild(chapDiv);
            });
        }

        // 2.2 CRUD Operations (Structure)
        window.addChapter = () => {
            currentCurriculum.push({ id: 'chap_' + Date.now(), title: 'Ch∆∞∆°ng m·ªõi', lessons: [] });
            renderCurriculumTree();
        };
        window.updateChapterTitle = (idx, val) => { currentCurriculum[idx].title = val; };
        window.deleteChapter = (idx) => { if(confirm('X√≥a ch∆∞∆°ng n√†y?')) { currentCurriculum.splice(idx, 1); renderCurriculumTree(); } };

        window.addLesson = (cIdx) => {
            currentCurriculum[cIdx].lessons.push({
                id: 'les_' + Date.now(),
                title: 'B√†i h·ªçc m·ªõi',
                type: 'video',
                content: '',
                isPreview: false
            });
            renderCurriculumTree();
            window.selectLesson(cIdx, currentCurriculum[cIdx].lessons.length - 1);
        };
        
        window.deleteLesson = (cIdx, lIdx) => {
            if(confirm('X√≥a b√†i h·ªçc n√†y?')) {
                currentCurriculum[cIdx].lessons.splice(lIdx, 1);
                renderCurriculumTree();
                if (cIdx === selectedChapterIndex && lIdx === selectedLessonIndex) {
                    document.getElementById('editorPlaceholder').classList.remove('hidden');
                    document.getElementById('lessonEditor').classList.add('hidden');
                }
            }
        };

        // 2.3 Editor Logic
        window.selectLesson = (cIdx, lIdx) => {
            selectedChapterIndex = cIdx; selectedLessonIndex = lIdx;
            const lesson = currentCurriculum[cIdx].lessons[lIdx];
            
            // Highlight in tree
            renderCurriculumTree();
            
            // Show Editor
            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('lessonEditor').classList.remove('hidden');
            document.getElementById('lessonEditor').classList.add('flex');
            
            // Fill Form
            document.getElementById('leTitle').value = lesson.title;
            document.getElementById('leType').value = lesson.type;
            document.getElementById('lePreview').checked = lesson.isPreview || false;
            
            // Trigger UI changes based on type
            window.handleLessonTypeChange();
            
            // Fill specific fields
            if (lesson.type === 'video') {
                document.getElementById('leVideoUrl').value = lesson.content || '';
                window.previewVideo(lesson.content);
            } else if (lesson.type === 'text') {
                document.getElementById('leContent').value = lesson.content || '';
            } else if (lesson.type === 'quiz') {
                document.getElementById('leExamSelect').value = lesson.examId || '';
            }
            
            document.getElementById('leStatus').innerText = "ƒêang ch·ªânh s·ª≠a...";
        };

        window.handleLessonTypeChange = () => {
            const type = document.getElementById('leType').value;
            document.getElementById('areaVideo').classList.add('hidden');
            document.getElementById('areaText').classList.add('hidden');
            document.getElementById('areaQuiz').classList.add('hidden');
            
            if(type === 'video') document.getElementById('areaVideo').classList.remove('hidden');
            if(type === 'text') document.getElementById('areaText').classList.remove('hidden');
            if(type === 'quiz') document.getElementById('areaQuiz').classList.remove('hidden');
        };

        window.previewVideo = (url) => {
            const frame = document.getElementById('videoPreviewFrame');
            const ph = document.getElementById('videoPlaceholder');
            if (!url) { frame.classList.add('hidden'); ph.classList.remove('hidden'); return; }
            
            let embedUrl = "";
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.split('v=')[1] || url.split('/').pop();
                const cleanId = videoId.split('&')[0];
                embedUrl = `https://www.youtube.com/embed/${cleanId}`;
            } else { embedUrl = url; }
            
            frame.src = embedUrl;
            frame.classList.remove('hidden'); ph.classList.add('hidden');
        };

        window.updateCurrentLesson = () => {
            if (selectedChapterIndex === -1 || selectedLessonIndex === -1) return;
            const lesson = currentCurriculum[selectedChapterIndex].lessons[selectedLessonIndex];
            
            lesson.title = document.getElementById('leTitle').value;
            lesson.type = document.getElementById('leType').value;
            lesson.isPreview = document.getElementById('lePreview').checked;
            
            if (lesson.type === 'video') lesson.content = document.getElementById('leVideoUrl').value;
            else if (lesson.type === 'text') lesson.content = document.getElementById('leContent').value;
            else if (lesson.type === 'quiz') lesson.examId = document.getElementById('leExamSelect').value;
            
            renderCurriculumTree(); // Refresh title in tree
            document.getElementById('leStatus').innerText = "ƒê√£ c·∫≠p nh·∫≠t v√†o b·ªô nh·ªõ t·∫°m (Ch∆∞a l∆∞u Server)";
            document.getElementById('leStatus').className = "text-xs text-green-600 font-bold italic";
        };

        window.saveCurriculum = async () => {
            const btn = document.querySelector('button[onclick="window.saveCurriculum()"]');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang l∆∞u...'; btn.disabled = true;
            try {
                await updateDoc(doc(db, "public_courses", editingCurriculumCourseId), {
                    curriculum: currentCurriculum, updatedAt: new Date().toISOString()
                });
                window.showNotification("ƒê√£ l∆∞u n·ªôi dung kh√≥a h·ªçc!", "success");
            } catch(e) { window.showNotification("L·ªói: " + e.message, "error"); }
            finally { btn.innerHTML = '<i class="fa-solid fa-save"></i> L∆∞u thay ƒë·ªïi'; btn.disabled = false; }
        };

        // --- UTILS: T·∫¢I ƒê·ªÄ THI CHO SELECT ---
        async function loadAllExamsForSelect() {
            try {
                // Ch·ªâ l·∫•y ƒë·ªÅ c·ªßa GV hi·ªán t·∫°i
                const q = query(collection(db, "exams"), where("teacherId", "==", currentUserId || "")); 
                const snap = await getDocs(q);
                const select = document.getElementById('leExamSelect');
                let html = '<option value="">-- Ch·ªçn ƒë·ªÅ thi --</option>';
                snap.forEach(d => {
                    html += `<option value="${d.id}">${d.data().title}</option>`;
                });
                select.innerHTML = html;
            } catch(e) { console.log("Ch∆∞a load ƒë∆∞·ª£c ƒë·ªÅ thi cho dropdown", e); }
        }
        window.refreshExamList = () => { loadAllExamsForSelect(); window.showNotification("ƒê√£ l√†m m·ªõi danh s√°ch ƒë·ªÅ thi"); };

        // --- UPLOAD ·∫¢NH (D√πng Worker) ---
        window.handleUpload = async (input, type) => {
            const file = input.files[0]; if (!file) return;
            window.showNotification("ƒêang t·∫£i ·∫£nh...", "info");
            try {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", { method: 'PUT', body: formData });
                const data = await res.json();
                
                if (type === 'thumb') {
                    currentThumbUrl = data.url;
                    document.getElementById('courseThumbPreview').src = data.url;
                    document.getElementById('courseThumbPreview').classList.remove('hidden');
                } else if (type === 'desc') {
                    const textarea = document.getElementById('cFullDesc');
                    textarea.value += `<div class="text-center my-4"><img src="${data.url}" class="rounded shadow inline-block"></div>`;
                }
                window.showNotification("T·∫£i ·∫£nh th√†nh c√¥ng!", "success");
            } catch(e) { window.showNotification("L·ªói upload: " + e.message, "error"); }
        };
    </script>
</body>
</html>
