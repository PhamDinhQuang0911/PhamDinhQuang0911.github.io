<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khóa học - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#0F766E', accent: '#F97316' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        /* Toast Animation */
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideInRight 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Tree View Styles */
        .tree-line { position: absolute; left: 14px; top: 0; bottom: 0; width: 1px; background: #e2e8f0; }
        .tree-connector { position: absolute; left: 0; top: 50%; width: 12px; height: 1px; background: #e2e8f0; }
    </style>
</head>
<body class="text-gray-700">

    <div id="toastContainer" class="fixed top-5 right-5 z-[200] space-y-3"></div>

    <div id="confirmModal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Xác nhận hành động</h3>
                <p id="confirmMessage" class="text-gray-500 text-sm mb-6">Bạn có chắc chắn muốn thực hiện?</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="window.closeConfirm(false)" class="px-4 py-2 border border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-gray-50">Hủy bỏ</button>
                    <button id="confirmBtnYes" class="px-6 py-2 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-700">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800">Quản lý Khóa học</h1>
                <p class="text-gray-500 text-sm mt-1">Hệ thống quản lý nội dung học tập E-Learning</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.toggleModal('courseModal')" class="bg-brand text-white px-5 py-2.5 rounded-xl hover:bg-teal-800 shadow-lg shadow-teal-700/20 font-bold transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-plus"></i> Thêm khóa học
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                            <th class="p-4 w-20">Ảnh</th>
                            <th class="p-4">Tên khóa học</th>
                            <th class="p-4">Cấu trúc</th>
                            <th class="p-4 text-center">Học viên</th>
                            <th class="p-4 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="courseListTable" class="text-sm">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="courseModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 backdrop-blur-md p-4 transition-all">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="font-extrabold text-gray-800 text-xl" id="modalTitle">Thiết lập Khóa học</h3>
                    <p class="text-xs text-gray-400 font-semibold mt-1">Điền thông tin cơ bản và hình ảnh hiển thị</p>
                </div>
                <button onclick="window.toggleModal('courseModal')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-8 space-y-6 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="courseId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Tên khóa học <span class="text-red-500">*</span></label>
                        <input type="text" id="cTitle" class="w-full px-5 py-3 border border-gray-200 rounded-xl focus:border-brand focus:ring-4 focus:ring-brand/10 outline-none transition-all font-bold text-gray-700 placeholder-gray-300" placeholder="VD: Luyện thi Toán 12 Cấp tốc...">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Giá bán (VNĐ)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-400 font-bold">₫</span>
                            <input type="number" id="cPrice" class="w-full pl-8 pr-4 py-3 border border-gray-200 rounded-xl focus:border-brand outline-none font-semibold" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Học viên ảo</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-400"><i class="fa-solid fa-users"></i></span>
                            <input type="number" id="cStudents" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:border-brand outline-none font-semibold" placeholder="0">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Mô tả ngắn</label>
                    <textarea id="cDesc" rows="3" class="w-full px-5 py-3 border border-gray-200 rounded-xl focus:border-brand outline-none text-sm resize-none" placeholder="Giới thiệu sơ lược về khóa học này..."></textarea>
                </div>

                <div>
                    <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Ảnh bìa khóa học</label>
                    <div class="border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center hover:border-brand hover:bg-teal-50/30 transition-all group relative cursor-pointer" onclick="document.getElementById('cThumbInput').click()">
                        <input type="file" id="cThumbInput" hidden accept="image/*" onchange="window.handleThumbUpload(this)">
                        <input type="text" id="cThumb" class="hidden"> <div id="thumbPreviewBox" class="hidden relative w-full aspect-video rounded-xl overflow-hidden shadow-sm mb-3 mx-auto max-w-sm">
                            <img id="previewThumb" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-white font-bold text-sm"><i class="fa-solid fa-pen mr-1"></i> Thay đổi ảnh</span>
                            </div>
                        </div>

                        <div id="thumbEmptyState">
                            <div class="w-14 h-14 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400 group-hover:text-brand group-hover:bg-white transition-colors">
                                <i class="fa-solid fa-image text-2xl"></i>
                            </div>
                            <p class="text-sm font-bold text-gray-600">Nhấn để tải ảnh lên</p>
                            <p class="text-xs text-gray-400 mt-1">Kích thước khuyến nghị: 1280x720 (16:9)</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-8 py-5 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 sticky bottom-0">
                <button onclick="window.toggleModal('courseModal')" class="px-5 py-2.5 text-gray-500 font-bold hover:bg-gray-200 rounded-xl transition-colors">Hủy bỏ</button>
                <button onclick="window.saveCourseBasic()" class="px-8 py-2.5 bg-brand text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all">Lưu Thiết Lập</button>
            </div>
        </div>
    </div>

    <div id="curriculumModal" class="hidden fixed inset-0 z-[60] bg-gray-900/95 backdrop-blur-sm transition-opacity duration-300">
        <div class="flex h-screen w-full p-4 gap-4">
            
            <div class="w-1/3 max-w-sm bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden animate-fade-in-up">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div>
                        <h3 class="font-extrabold text-gray-800 text-lg">Nội dung khóa học</h3>
                        <p id="editorCourseTitle" class="text-xs text-gray-500 truncate w-40">Đang tải...</p>
                    </div>
                    <button onclick="addChapter()" class="px-3 py-1.5 bg-brand text-white rounded-lg text-xs font-bold hover:bg-teal-800 shadow transition-all">
                        <i class="fa-solid fa-folder-plus mr-1"></i> Thêm Chương
                    </button>
                </div>
                <div id="curriculumTree" class="flex-1 overflow-y-auto p-3 space-y-2 bg-white scrollbar-hide"></div>
                <div class="p-4 border-t border-gray-100 bg-gray-50 text-center">
                    <button onclick="saveCurriculum()" class="w-full py-3 bg-gradient-to-r from-brand to-teal-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                        <i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN
                    </button>
                    <button onclick="closeCurriculumModal()" class="mt-2 text-xs text-gray-500 hover:text-red-500 font-semibold">Đóng không lưu</button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden relative animate-fade-in-up" style="animation-delay: 0.1s;">
                <div id="editorWelcome" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-10">
                    <img src="https://cdn-icons-png.flaticon.com/512/3079/3079296.png" class="w-24 h-24 mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-bold text-gray-400">Chọn một nội dung để biên tập</h3>
                    <p class="text-gray-400 text-sm">Cấu trúc: Chương > Bài học > Nội dung (Lý thuyết, BT, Quiz...)</p>
                </div>

                <div id="editorForm" class="hidden flex flex-col h-full">
                    <div class="h-16 border-b border-gray-100 flex items-center px-6 justify-between bg-white">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm"><i class="fa-solid fa-pen"></i></span>
                            <input type="text" id="editItemTitle" class="text-lg font-bold text-gray-800 outline-none border-b border-transparent focus:border-brand placeholder-gray-300 w-96 transition-all" placeholder="Tên nội dung...">
                        </div>
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="setItemType('video')" id="btnTypeVideo" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-brands fa-youtube mr-1"></i> Video</button>
                            <button onclick="setItemType('pdf')" id="btnTypePdf" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-solid fa-file-pdf mr-1"></i> Tài liệu</button>
                            <button onclick="setItemType('quiz')" id="btnTypeQuiz" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-solid fa-clipboard-question mr-1"></i> Bài tập</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-gray-50/50 p-8">
                        <div id="panelVideo" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Link YouTube</label>
                                <input type="text" id="videoUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand outline-none" placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                            <div id="videoPreviewArea" class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg hidden relative"><iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div>
                        </div>

                        <div id="panelPdf" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="flex gap-4 mb-4">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="pdfSource" value="upload" class="peer sr-only" checked onchange="togglePdfSource()"><div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand peer-checked:bg-teal-50 hover:bg-white text-center"><i class="fa-solid fa-cloud-arrow-up text-xl mb-1 block"></i>Tải file lên</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="pdfSource" value="drive" class="peer sr-only" onchange="togglePdfSource()"><div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-white text-center"><i class="fa-brands fa-google-drive text-xl mb-1 block"></i>Link Google Drive</div></label>
                            </div>
                            <div id="pdfUploadArea" class="bg-white p-8 rounded-xl border-2 border-dashed border-gray-300 text-center hover:border-brand cursor-pointer group" onclick="document.getElementById('pdfFileInput').click()">
                                <input type="file" id="pdfFileInput" accept=".pdf" class="hidden" onchange="window.handlePdfUpload(this)">
                                <i class="fa-solid fa-file-pdf text-3xl text-gray-400 group-hover:text-brand mb-2"></i>
                                <p class="font-bold text-gray-700">Nhấn để chọn file PDF từ máy tính</p>
                                <div id="pdfUploadProgress" class="hidden mt-4">
                                    <div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-brand h-1.5 rounded-full" style="width: 50%"></div></div>
                                    <p class="text-xs text-brand font-bold mt-1">Đang tải lên...</p>
                                </div>
                            </div>
                            <div id="pdfDriveArea" class="hidden bg-white p-6 rounded-xl border border-gray-200"><input type="text" id="driveUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none" placeholder="Dán link Google Drive công khai vào đây..."></div>
                            <div id="pdfPreviewArea" class="h-[500px] bg-gray-800 rounded-xl overflow-hidden shadow-lg hidden"><iframe id="pdfFrame" class="w-full h-full" src=""></iframe></div>
                        </div>

                        <div id="panelQuiz" class="content-panel hidden max-w-4xl mx-auto text-center py-10">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-orange-100">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Bài tập trắc nghiệm</h3>
                                <div id="selectedExamInfo" class="hidden mb-6 bg-orange-50 p-4 rounded-xl border border-orange-200 text-left">
                                    <div class="text-xs font-bold text-orange-600 uppercase mb-1">Đề thi đã chọn:</div>
                                    <div id="selectedExamTitle" class="font-bold text-gray-800 text-lg">...</div>
                                </div>
                                <button onclick="window.openExamSelector()" class="px-6 py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 shadow-lg"><i class="fa-solid fa-folder-open"></i> Chọn từ Ngân hàng đề</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border-t border-gray-100 p-4 flex gap-6 text-sm font-bold text-gray-600">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand"><input type="checkbox" id="isPreview" class="accent-brand w-4 h-4"><span>Cho phép học thử</span></label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand"><input type="checkbox" id="isPublished" checked class="accent-brand w-4 h-4"><span>Đã xuất bản</span></label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="examSelectorModal" class="hidden fixed inset-0 z-[70] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 text-lg">Chọn Đề Thi</h3>
                <div class="flex gap-2">
                    <a href="exam-editor.html" target="_blank" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700"><i class="fa-solid fa-plus-circle"></i> Tạo mới</a>
                    <button onclick="document.getElementById('examSelectorModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold text-sm">Đóng</button>
                </div>
            </div>
            <div class="px-6 py-2 bg-white border-b border-gray-100 flex items-center gap-2 text-sm" id="selectorBreadcrumb"></div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50"><div id="selectorContent" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, getDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG FIREBASE CỦA BẠN (DÁN VÀO ĐÂY)
        const firebaseConfig = {
            // ...
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE GLOBAL (3 CẤP)
        let currentCourseId = null;
        let currentCurriculum = []; // Mảng Chapters
        // Structure: Chapter -> lessons[] -> items[]
        let activeChapIdx = -1;
        let activeLesIdx = -1;
        let activeItemIdx = -1; // Cấp 3: Item (Nội dung)

        // --- UTILS ---
        window.showToast = (msg, type='success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-enter p-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] ${type==='success'?'bg-white border-l-4 border-green-500':'bg-white border-l-4 border-red-500'}`;
            toast.innerHTML = `<div class="font-bold text-sm text-gray-800">${msg}</div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        window.customConfirm = (msg, onYes) => {
            document.getElementById('confirmMessage').innerText = msg;
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            const btnYes = document.getElementById('confirmBtnYes');
            const newBtn = btnYes.cloneNode(true);
            btnYes.parentNode.replaceChild(newBtn, btnYes);
            newBtn.onclick = () => { modal.classList.add('hidden'); onYes(); };
        };
        window.closeConfirm = () => document.getElementById('confirmModal').classList.add('hidden');

        // --- MAIN LOAD ---
        onAuthStateChanged(auth, (user) => { if(!user) window.location.href='index.html'; else loadCourses(); });

        window.loadCourses = async () => {
            try {
                const q = query(collection(db, "public_courses"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const list = document.getElementById('courseListTable');
                list.innerHTML = '';
                if(querySnapshot.empty) return list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có khóa học.</td></tr>`;

                querySnapshot.forEach(doc => {
                    const c = doc.data();
                    // Đếm tổng số Item (Nội dung thực tế)
                    let itemCount = 0;
                    if(c.curriculum) c.curriculum.forEach(ch => { if(ch.lessons) ch.lessons.forEach(l => { if(l.items) itemCount += l.items.length; }) });

                    list.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="p-4"><img src="${c.thumbnail || 'https://via.placeholder.com/100'}" class="w-12 h-12 rounded-lg object-cover border"></td>
                        <td class="p-4"><div class="font-bold text-gray-800">${c.title}</div></td>
                        <td class="p-4 text-xs text-gray-500 font-bold">${c.curriculum ? c.curriculum.length : 0} chương • ${itemCount} bài</td>
                        <td class="p-4 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">${c.students || 0} HV</span></td>
                        <td class="p-4 text-right">
                            <button onclick="window.openCurriculumEditor('${doc.id}')" class="text-purple-600 hover:bg-purple-50 p-2 rounded"><i class="fa-solid fa-book-open"></i></button>
                            <button onclick="window.editCourse('${doc.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="window.deleteCourse('${doc.id}')" class="text-red-600 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } catch(e) { window.showToast(e.message, 'error'); }
        };

        // --- EDIT BASIC INFO (MODAL 1 - UPDATED) ---
        window.editCourse = async (id) => {
            const d = await getDoc(doc(db,"public_courses",id));
            if(d.exists()) {
                const dt = d.data();
                document.getElementById('courseId').value = id;
                document.getElementById('cTitle').value = dt.title;
                document.getElementById('cPrice').value = dt.price;
                document.getElementById('cStudents').value = dt.students;
                document.getElementById('cDesc').value = dt.desc || '';
                document.getElementById('cThumb').value = dt.thumbnail || '';
                
                // Hiển thị Preview ảnh
                if(dt.thumbnail) {
                    document.getElementById('previewThumb').src = dt.thumbnail;
                    document.getElementById('thumbPreviewBox').classList.remove('hidden');
                    document.getElementById('thumbEmptyState').classList.add('hidden');
                } else {
                    document.getElementById('thumbPreviewBox').classList.add('hidden');
                    document.getElementById('thumbEmptyState').classList.remove('hidden');
                }
                window.toggleModal('courseModal', true);
            }
        };

        window.handleThumbUpload = (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Preview ngay lập tức
                    document.getElementById('previewThumb').src = e.target.result;
                    document.getElementById('thumbPreviewBox').classList.remove('hidden');
                    document.getElementById('thumbEmptyState').classList.add('hidden');
                    // TODO: GỌI API UPLOAD THẬT Ở ĐÂY, sau đó gán URL vào #cThumb
                    // document.getElementById('cThumb').value = uploadedUrl;
                    window.showToast("Đã chọn ảnh (Cần tích hợp API Upload)", "info");
                };
                reader.readAsDataURL(file);
            }
        };

        window.saveCourseBasic = async () => {
            const id = document.getElementById('courseId').value;
            const data = {
                title: document.getElementById('cTitle').value,
                price: parseInt(document.getElementById('cPrice').value) || 0,
                students: parseInt(document.getElementById('cStudents').value) || 0,
                desc: document.getElementById('cDesc').value,
                thumbnail: document.getElementById('cThumb').value, // URL ảnh
                updatedAt: new Date().toISOString()
            };
            try {
                if(id) await updateDoc(doc(db,"public_courses",id), data);
                else { data.createdAt = new Date().toISOString(); await setDoc(doc(collection(db,"public_courses")), data); }
                window.showToast("Đã lưu thiết lập!");
                window.toggleModal('courseModal', false);
                loadCourses();
            } catch(e) { window.showToast(e.message, 'error'); }
        };

        // --- CURRICULUM EDITOR (3 LEVELS) ---
        window.openCurriculumEditor = async (courseId) => {
            currentCourseId = courseId;
            activeChapIdx = -1; activeLesIdx = -1; activeItemIdx = -1;
            document.getElementById('curriculumModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('editorWelcome').classList.remove('hidden');
            document.getElementById('editorForm').classList.add('hidden');
            
            try {
                const d = await getDoc(doc(db,"public_courses",courseId));
                if(d.exists()) {
                    const data = d.data();
                    document.getElementById('editorCourseTitle').innerText = data.title;
                    currentCurriculum = data.curriculum || [];
                    // Migration: Nếu dữ liệu cũ (2 cấp), ta cần convert sang 3 cấp
                    // Logic convert đơn giản: Biến lesson cũ thành item nằm trong lesson mới
                    normalizeCurriculumData();
                    renderCurriculumTree();
                }
            } catch(e) { window.showToast(e.message, 'error'); }
        };

        function normalizeCurriculumData() {
            // Đảm bảo cấu trúc: Chapter -> Lessons[] -> Items[]
            currentCurriculum.forEach(chap => {
                if(!chap.lessons) chap.lessons = [];
                chap.lessons.forEach(les => {
                    // Nếu lesson cũ chưa có items array (dữ liệu cũ)
                    if(!les.items) {
                        // Chuyển nội dung lesson cũ thành 1 item con
                        if(les.type && les.content) {
                            les.items = [{
                                id: 'it_' + Date.now() + Math.random(),
                                title: "Nội dung chính",
                                type: les.type,
                                content: les.content,
                                examId: les.examId || null,
                                examTitle: les.examTitle || null
                            }];
                        } else {
                            les.items = [];
                        }
                    }
                });
            });
        }

        function renderCurriculumTree() {
            const tree = document.getElementById('curriculumTree');
            tree.innerHTML = '';
            if(currentCurriculum.length === 0) return tree.innerHTML = `<div class="text-center mt-10 text-xs text-gray-400">Chưa có nội dung</div>`;

            currentCurriculum.forEach((chap, cIdx) => {
                const chapEl = document.createElement('div');
                chapEl.className = "mb-2 border border-gray-100 rounded-lg overflow-hidden bg-white shadow-sm";
                
                // Level 1: Chapter
                chapEl.innerHTML = `
                    <div class="bg-gray-50 p-2.5 flex justify-between items-center group hover:bg-gray-100 cursor-pointer select-none" onclick="toggleCollapse('chap_body_${cIdx}')">
                        <div class="font-bold text-gray-800 text-sm flex-1 truncate"><i class="fa-solid fa-folder text-brand mr-2"></i>${chap.title}</div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); renameChapter(${cIdx})" class="w-6 h-6 hover:bg-white rounded text-gray-500"><i class="fa-solid fa-pen text-[10px]"></i></button>
                            <button onclick="event.stopPropagation(); addLesson(${cIdx})" class="w-6 h-6 hover:bg-white rounded text-blue-600"><i class="fa-solid fa-plus text-[10px]"></i></button>
                            <button onclick="event.stopPropagation(); deleteChapter(${cIdx})" class="w-6 h-6 hover:bg-white rounded text-red-600"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                    </div>
                    <div id="chap_body_${cIdx}" class="pl-3 pr-1 pb-2 space-y-2 mt-1 hidden"></div>
                `;
                
                const chapBody = chapEl.querySelector(`#chap_body_${cIdx}`);
                // Mặc định mở chương đầu hoặc chương đang active
                if(cIdx === activeChapIdx || activeChapIdx === -1) chapBody.classList.remove('hidden');

                // Level 2: Lesson
                (chap.lessons || []).forEach((les, lIdx) => {
                    const lesEl = document.createElement('div');
                    lesEl.className = "relative pl-4 border-l-2 border-gray-200 hover:border-brand transition-colors";
                    lesEl.innerHTML = `
                        <div class="flex justify-between items-center py-1 group/les cursor-pointer">
                            <div class="text-sm font-bold text-gray-700 truncate" onclick="renameLesson(${cIdx},${lIdx})">${les.title}</div>
                            <div class="flex gap-1 opacity-0 group-hover/les:opacity-100">
                                <button onclick="addItem(${cIdx},${lIdx})" class="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold hover:bg-blue-100">+ Nội dung</button>
                                <button onclick="deleteLesson(${cIdx},${lIdx})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    `;

                    // Level 3: Item (Nội dung thực tế)
                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = "space-y-1 mt-1";
                    
                    (les.items || []).forEach((item, iIdx) => {
                        const isActive = (cIdx === activeChapIdx && lIdx === activeLesIdx && iIdx === activeItemIdx);
                        const icon = item.type === 'pdf' ? 'fa-file-pdf text-blue-500' : (item.type === 'quiz' ? 'fa-clipboard-question text-orange-500' : 'fa-play-circle text-red-500');
                        
                        const itemEl = document.createElement('div');
                        itemEl.className = `flex justify-between items-center px-2 py-1.5 rounded text-xs cursor-pointer ${isActive ? 'bg-brand text-white shadow-md' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'}`;
                        itemEl.onclick = () => selectItem(cIdx, lIdx, iIdx);
                        itemEl.innerHTML = `
                            <div class="flex items-center gap-2 truncate">
                                <i class="fa-solid ${icon}"></i>
                                <span class="truncate max-w-[120px]">${item.title}</span>
                            </div>
                            <button onclick="event.stopPropagation(); deleteItem(${cIdx},${lIdx},${iIdx})" class="${isActive?'text-white/70 hover:text-white':'text-gray-300 hover:text-red-500'}"><i class="fa-solid fa-times"></i></button>
                        `;
                        itemsContainer.appendChild(itemEl);
                    });
                    
                    lesEl.appendChild(itemsContainer);
                    chapBody.appendChild(lesEl);
                });

                tree.appendChild(chapEl);
            });
        }

        window.toggleCollapse = (id) => document.getElementById(id).classList.toggle('hidden');

        // --- ACTIONS 3 LEVELS ---
        window.addChapter = () => { currentCurriculum.push({ title: "Chương mới", lessons: [] }); renderCurriculumTree(); };
        window.renameChapter = (i) => { const t=prompt("Tên chương:",currentCurriculum[i].title); if(t){currentCurriculum[i].title=t;renderCurriculumTree();} };
        window.deleteChapter = (i) => customConfirm("Xóa chương này?",()=>{currentCurriculum.splice(i,1);renderCurriculumTree();});
        
        window.addLesson = (ci) => { currentCurriculum[ci].lessons.push({ title: "Bài học mới", items: [] }); renderCurriculumTree(); };
        window.renameLesson = (ci,li) => { const t=prompt("Tên bài học:",currentCurriculum[ci].lessons[li].title); if(t){currentCurriculum[ci].lessons[li].title=t;renderCurriculumTree();} };
        window.deleteLesson = (ci,li) => customConfirm("Xóa bài học này?",()=>{currentCurriculum[ci].lessons.splice(li,1);renderCurriculumTree();});

        window.addItem = (ci,li) => {
            currentCurriculum[ci].lessons[li].items.push({ 
                id: 'it_'+Date.now(), title: "Nội dung mới", type: 'video', content: '', isPublished: true 
            });
            renderCurriculumTree();
            selectItem(ci, li, currentCurriculum[ci].lessons[li].items.length - 1);
        };
        window.deleteItem = (ci,li,ii) => {
            if(confirm("Xóa nội dung này?")) {
                currentCurriculum[ci].lessons[li].items.splice(ii,1);
                if(ci==activeChapIdx && li==activeLesIdx && ii==activeItemIdx) {
                    document.getElementById('editorForm').classList.add('hidden');
                    document.getElementById('editorWelcome').classList.remove('hidden');
                }
                renderCurriculumTree();
            }
        };

        // --- EDITOR LOGIC ---
        window.selectItem = (ci, li, ii) => {
            activeChapIdx = ci; activeLesIdx = li; activeItemIdx = ii;
            const data = currentCurriculum[ci].lessons[li].items[ii];
            renderCurriculumTree(); // Update highlight
            
            document.getElementById('editorWelcome').classList.add('hidden');
            document.getElementById('editorForm').classList.remove('hidden');
            
            // Bind Data
            document.getElementById('editItemTitle').value = data.title;
            document.getElementById('isPreview').checked = data.isPreview || false;
            document.getElementById('isPublished').checked = data.isPublished !== false;
            
            window.setItemType(data.type);
            
            // Fill Content
            if(data.type === 'video') {
                document.getElementById('videoUrlInput').value = data.content || '';
                window.previewVideo(data.content || '');
            } else if (data.type === 'pdf') {
                if(data.content && data.content.includes('drive.google.com')) {
                    document.querySelector('input[name="pdfSource"][value="drive"]').checked = true;
                    document.getElementById('driveUrlInput').value = data.content;
                } else {
                    document.querySelector('input[name="pdfSource"][value="upload"]').checked = true;
                    if(data.content) document.getElementById('pdfFrame').src = data.content;
                }
                window.togglePdfSource();
            } else if(data.type === 'quiz') {
                document.getElementById('selectedExamTitle').innerText = data.examTitle || 'Chưa chọn đề';
                document.getElementById('selectedExamInfo').classList.toggle('hidden', !data.examId);
            }
        };

        // Auto Save to State
        document.getElementById('editItemTitle').oninput = (e) => { if(activeItemIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].title = e.target.value; };
        document.getElementById('editItemTitle').onblur = renderCurriculumTree;
        document.getElementById('videoUrlInput').oninput = (e) => { 
            if(activeItemIdx>-1) {
                currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content = e.target.value;
                window.previewVideo(e.target.value);
            }
        };
        document.getElementById('driveUrlInput').oninput = (e) => {
             if(activeItemIdx>-1) {
                currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content = e.target.value;
                window.togglePdfSource(); // Trigger preview update
             }
        };
        document.getElementById('isPreview').onchange = (e) => { if(activeItemIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].isPreview = e.target.checked; };

        // --- HELPER FUNCTIONS ---
        window.setItemType = (type) => {
            if(activeItemIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].type = type;
            
            // UI Tab Styling
            document.querySelectorAll('.type-btn').forEach(b => b.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all");
            const activeId = type==='video'?'btnTypeVideo':(type==='pdf'?'btnTypePdf':'btnTypeQuiz');
            const activeColor = type==='video'?'bg-red-50 text-red-600':(type==='pdf'?'bg-blue-50 text-blue-600':'bg-orange-50 text-orange-600');
            document.getElementById(activeId).className = `type-btn px-4 py-1.5 rounded-md text-sm font-bold shadow-sm transition-all ${activeColor}`;
            
            // Show Panel
            document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(type==='video'?'panelVideo':(type==='pdf'?'panelPdf':'panelQuiz')).classList.remove('hidden');
        };

        window.previewVideo = (url) => {
            if(!url) return document.getElementById('videoPreviewArea').classList.add('hidden');
            const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            if(m && m[2].length === 11) {
                document.getElementById('videoFrame').src = `https://www.youtube.com/embed/${m[2]}`;
                document.getElementById('videoPreviewArea').classList.remove('hidden');
            } else {
                document.getElementById('videoPreviewArea').classList.add('hidden');
            }
        };

        window.togglePdfSource = () => {
            const s = document.querySelector('input[name="pdfSource"]:checked').value;
            const isUpload = s === 'upload';
            document.getElementById('pdfUploadArea').classList.toggle('hidden', !isUpload);
            document.getElementById('pdfDriveArea').classList.toggle('hidden', isUpload);
            
            // Handle Preview logic
            let url = "";
            if(isUpload) {
                // Với mode upload, url nằm trong currentCurriculum.content
                if(activeItemIdx > -1) url = currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content;
            } else {
                url = document.getElementById('driveUrlInput').value;
            }

            const previewArea = document.getElementById('pdfPreviewArea');
            const iframe = document.getElementById('pdfFrame');
            
            if(url) {
                if(url.includes('drive.google.com')) {
                    // Convert view -> preview
                    url = url.replace('/view', '/preview').replace('/edit', '/preview');
                }
                iframe.src = url;
                previewArea.classList.remove('hidden');
            } else {
                previewArea.classList.add('hidden');
            }
        };

        // --- PDF UPLOAD HANDLER ---
        window.handlePdfUpload = (input) => {
            const file = input.files[0];
            if(!file) return;

            // Show Fake Progress
            document.getElementById('pdfUploadProgress').classList.remove('hidden');
            
            // SIMULATE UPLOAD (Thay bằng API thật của bạn)
            setTimeout(() => {
                // Giả sử server trả về URL này
                const fakeUrl = URL.createObjectURL(file); // Dùng Blob URL để preview tạm
                
                // Save to State
                currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content = fakeUrl;
                
                // Update UI
                document.getElementById('pdfUploadProgress').classList.add('hidden');
                document.getElementById('pdfFrame').src = fakeUrl;
                document.getElementById('pdfPreviewArea').classList.remove('hidden');
                window.showToast("Đã tải file lên (URL tạm)", "success");
            }, 1500);
        };

        // --- EXAM SELECTOR ---
        window.openExamSelector = () => { document.getElementById('examSelectorModal').classList.remove('hidden'); loadExamManager(null); };
        window.loadExamManager = async (folderId) => {
            const container = document.getElementById('selectorContent');
            const breadcrumb = document.getElementById('selectorBreadcrumb');
            container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Đang tải...</div>';
            
            // Breadcrumb UI
            breadcrumb.innerHTML = folderId 
                ? `<span class="text-gray-400 cursor-pointer hover:text-brand" onclick="loadExamManager(null)"><i class="fa-solid fa-home"></i></span> <span class="text-gray-300">/</span> <span class="font-bold text-gray-700">Thư mục</span>`
                : `<span class="font-bold text-brand"><i class="fa-solid fa-home"></i> Gốc</span>`;

            try {
                // Fetch Data
                const qF = query(collection(db, "folders"), where("parentId", "==", folderId || null));
                const qE = query(collection(db, "exams"), where("folderId", "==", folderId || null));
                const [snapF, snapE] = await Promise.all([getDocs(qF), getDocs(qE)]);

                container.innerHTML = '';
                snapF.forEach(d => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border hover:border-brand cursor-pointer flex flex-col items-center gap-2 aspect-square justify-center shadow-sm";
                    el.onclick = () => loadExamManager(d.id);
                    el.innerHTML = `<i class="fa-solid fa-folder text-4xl text-yellow-400"></i><div class="text-xs font-bold text-gray-700 text-center">${d.data().name}</div>`;
                    container.appendChild(el);
                });
                snapE.forEach(d => {
                    const e = d.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border hover:border-orange-500 cursor-pointer flex flex-col items-center gap-2 aspect-square justify-center shadow-sm group relative";
                    el.onclick = () => {
                        // Select Exam
                        if(activeItemIdx > -1) {
                            const item = currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx];
                            item.examId = d.id;
                            item.examTitle = e.title;
                            document.getElementById('selectedExamTitle').innerText = e.title;
                            document.getElementById('selectedExamInfo').classList.remove('hidden');
                            document.getElementById('examSelectorModal').classList.add('hidden');
                            window.showToast(`Đã chọn: ${e.title}`);
                        }
                    };
                    el.innerHTML = `<i class="fa-solid fa-file-lines text-3xl text-gray-400 group-hover:text-orange-500"></i><div class="text-xs font-bold text-gray-700 text-center line-clamp-2">${e.title}</div>`;
                    container.appendChild(el);
                });
                if(snapF.empty && snapE.empty) container.innerHTML = '<div class="col-span-full text-center text-gray-300 py-10">Thư mục trống</div>';
            } catch(e) { container.innerHTML = `<div class="text-red-500 col-span-full">${e.message}</div>`; }
        };

        window.saveCurriculum = async () => {
            const btn = document.querySelector('button[onclick="saveCurriculum()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
            try {
                await updateDoc(doc(db, "public_courses", currentCourseId), { curriculum: currentCurriculum });
                window.showToast("Lưu giáo án thành công!");
            } catch(e) { window.showToast("Lỗi lưu: "+e.message, 'error'); }
            finally { btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN'; }
        };
        
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if(show===undefined) show = el.classList.contains('hidden');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        };
        window.closeCurriculumModal = () => window.customConfirm("Đóng mà không lưu?", () => document.getElementById('curriculumModal').classList.add('hidden'));
        window.deleteCourse = (id) => window.customConfirm("Xóa khóa học này?", async()=>{ await deleteDoc(doc(db,"public_courses",id)); window.showToast("Đã xóa"); loadCourses(); });
    </script>
</body>
</html>
