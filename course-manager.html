<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Khóa học - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#0F766E', accent: '#F97316' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        /* Toast Animation */
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideInRight 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Tree View Styles */
        .tree-line { position: absolute; left: 14px; top: 0; bottom: 0; width: 1px; background: #e2e8f0; }
        .tree-connector { position: absolute; left: 0; top: 50%; width: 12px; height: 1px; background: #e2e8f0; }
        /* BƯỚC 2: Thêm vào thẻ <style> */
.draggable-source { opacity: 0.4; border: 2px dashed #0F766E; }
.drag-over-top { border-top: 2px solid #0F766E !important; }
.drag-over-bottom { border-bottom: 2px solid #0F766E !important; }
.drag-over-inside { background-color: #F0FDFA !important; border: 2px dashed #0F766E !important; }
    </style>
</head>
<body class="text-gray-700">

    <div id="toastContainer" class="fixed top-5 right-5 z-[200] space-y-3"></div>

    <div id="confirmModal" class="hidden fixed inset-0 z-[210] flex items-center justify-center bg-gray-900/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Xác nhận hành động</h3>
                <p id="confirmMessage" class="text-gray-500 text-sm mb-6">Bạn có chắc chắn muốn thực hiện?</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="window.closeConfirm(false)" class="px-4 py-2 border border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-gray-50">Hủy bỏ</button>
                    <button id="confirmBtnYes" class="px-6 py-2 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-700">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800">Quản lý Khóa học</h1>
                <p class="text-gray-500 text-sm mt-1">Hệ thống quản lý nội dung học tập E-Learning</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.toggleModal('courseModal')" class="bg-brand text-white px-5 py-2.5 rounded-xl hover:bg-teal-800 shadow-lg shadow-teal-700/20 font-bold transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-plus"></i> Thêm khóa học
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                            <th class="p-4 w-20">Ảnh</th>
                            <th class="p-4">Tên khóa học</th>
                            <th class="p-4">Cấu trúc</th>
                            <th class="p-4 text-center">Học viên</th>
                            <th class="p-4 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="courseListTable" class="text-sm">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="courseModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 backdrop-blur-md p-4 transition-all">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="font-extrabold text-gray-800 text-xl" id="modalTitle">Thiết lập Khóa học</h3>
                    <p class="text-xs text-gray-400 font-semibold mt-1">Điền thông tin cơ bản và hình ảnh hiển thị</p>
                </div>
                <button onclick="window.toggleModal('courseModal')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-8 space-y-6 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="courseId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="col-span-1 md:col-span-3">
        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Tên khóa học <span class="text-red-500">*</span></label>
        <input type="text" id="cTitle" class="w-full px-5 py-3 border border-gray-200 rounded-xl focus:border-brand focus:ring-4 focus:ring-brand/10 outline-none transition-all font-bold text-gray-700 placeholder-gray-300" placeholder="VD: Luyện thi Toán 12 Cấp tốc...">
    </div>

    <div>
        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Giá gốc (Niêm yết)</label>
        <div class="relative">
            <span class="absolute left-4 top-3 text-gray-400 font-bold line-through">₫</span>
            <input type="number" id="cOriginalPrice" class="w-full pl-8 pr-4 py-3 border border-gray-200 rounded-xl focus:border-brand outline-none font-semibold text-gray-500" placeholder="VD: 500000">
        </div>
    </div>

    <div>
        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Giá bán (Khuyến mãi)</label>
        <div class="relative">
            <span class="absolute left-4 top-3 text-brand font-bold">₫</span>
            <input type="number" id="cPrice" class="w-full pl-8 pr-4 py-3 border border-brand/30 bg-teal-50/30 rounded-xl focus:border-brand outline-none font-bold text-brand" placeholder="VD: 299000">
        </div>
    </div>

    <div>
        <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Học viên ảo</label>
        <div class="relative">
            <span class="absolute left-4 top-3 text-gray-400"><i class="fa-solid fa-users"></i></span>
            <input type="number" id="cStudents" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:border-brand outline-none font-semibold" placeholder="0">
        </div>
    </div>
</div>

                <div>
                    <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Mô tả ngắn</label>
                    <textarea id="cDesc" rows="3" class="w-full px-5 py-3 border border-gray-200 rounded-xl focus:border-brand outline-none text-sm resize-none" placeholder="Giới thiệu sơ lược về khóa học này..."></textarea>
                </div>

                <div>
                    <label class="block text-xs font-black text-gray-500 uppercase mb-2 ml-1">Ảnh bìa khóa học</label>
                    <div class="border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center hover:border-brand hover:bg-teal-50/30 transition-all group relative cursor-pointer" onclick="document.getElementById('cThumbInput').click()">
                        <input type="file" id="cThumbInput" hidden accept="image/*" onchange="window.handleThumbUpload(this)">
                        <input type="text" id="cThumb" class="hidden"> <div id="thumbPreviewBox" class="hidden relative w-full aspect-video rounded-xl overflow-hidden shadow-sm mb-3 mx-auto max-w-sm">
                            <img id="previewThumb" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-white font-bold text-sm"><i class="fa-solid fa-pen mr-1"></i> Thay đổi ảnh</span>
                            </div>
                        </div>

                        <div id="thumbEmptyState">
                            <div class="w-14 h-14 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400 group-hover:text-brand group-hover:bg-white transition-colors">
                                <i class="fa-solid fa-image text-2xl"></i>
                            </div>
                            <p class="text-sm font-bold text-gray-600">Nhấn để tải ảnh lên</p>
                            <p class="text-xs text-gray-400 mt-1">Kích thước khuyến nghị: 1280x720 (16:9)</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-8 py-5 border-t border-gray-100 bg-gray-50 flex justify-end gap-3 sticky bottom-0">
                <button onclick="window.toggleModal('courseModal')" class="px-5 py-2.5 text-gray-500 font-bold hover:bg-gray-200 rounded-xl transition-colors">Hủy bỏ</button>
                <button onclick="window.saveCourseBasic()" class="px-8 py-2.5 bg-brand text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all">Lưu Thiết Lập</button>
            </div>
        </div>
    </div>

    <div id="curriculumModal" class="hidden fixed inset-0 z-[60] bg-gray-900/95 backdrop-blur-sm transition-opacity duration-300">
        <div class="flex h-screen w-full p-4 gap-4">
            
            <div class="w-1/3 max-w-sm bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden animate-fade-in-up">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col gap-3">
    <div class="flex justify-between items-center">
        <div>
            <h3 class="font-extrabold text-gray-800 text-lg">Nội dung khóa học</h3>
            <p id="editorCourseTitle" class="text-xs text-gray-500 truncate w-40">Đang tải...</p>
        </div>
        <button onclick="addChapter()" class="px-3 py-1.5 bg-brand text-white rounded-lg text-xs font-bold hover:bg-teal-800 shadow transition-all">
            <i class="fa-solid fa-folder-plus mr-1"></i> Thêm Chương
        </button>
    </div>
    
    <div class="flex gap-2 border-t border-gray-200 pt-3">
        <button onclick="downloadTemplate()" class="flex-1 py-1.5 bg-white border border-gray-300 text-gray-600 rounded text-xs font-bold hover:bg-gray-100" title="Tải file mẫu">
            <i class="fa-solid fa-download mr-1"></i> Mẫu
        </button>
        <button onclick="exportCurriculum()" class="flex-1 py-1.5 bg-white border border-gray-300 text-green-600 rounded text-xs font-bold hover:bg-green-50" title="Xuất ra Excel">
            <i class="fa-solid fa-file-export mr-1"></i> Xuất
        </button>
        <button onclick="document.getElementById('importInput').click()" class="flex-1 py-1.5 bg-white border border-gray-300 text-blue-600 rounded text-xs font-bold hover:bg-blue-50" title="Nhập từ Excel">
            <i class="fa-solid fa-file-import mr-1"></i> Nhập
        </button>
        <input type="file" id="importInput" hidden accept=".xlsx, .xls" onchange="importCurriculum(this)">
    </div>
</div>
                <div id="curriculumTree" class="flex-1 overflow-y-auto p-3 space-y-2 bg-white scrollbar-hide"></div>
                <div class="p-4 border-t border-gray-100 bg-gray-50 text-center">
                    <button onclick="saveCurriculum()" class="w-full py-3 bg-gradient-to-r from-brand to-teal-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                        <i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN
                    </button>
                    <button onclick="closeCurriculumModal()" class="mt-2 text-xs text-gray-500 hover:text-red-500 font-semibold">Đóng không lưu</button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden relative animate-fade-in-up" style="animation-delay: 0.1s;">
                <div id="editorWelcome" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-10">
                    <img src="https://cdn-icons-png.flaticon.com/512/3079/3079296.png" class="w-24 h-24 mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-bold text-gray-400">Chọn một nội dung để biên tập</h3>
                    <p class="text-gray-400 text-sm">Cấu trúc: Chương > Bài học > Nội dung (Lý thuyết, BT, Quiz...)</p>
                </div>

                <div id="editorForm" class="hidden flex flex-col h-full">
                    <div class="h-16 border-b border-gray-100 flex items-center px-6 justify-between bg-white">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-sm"><i class="fa-solid fa-pen"></i></span>
                            <input type="text" id="editItemTitle" class="text-lg font-bold text-gray-800 outline-none border-b border-transparent focus:border-brand placeholder-gray-300 w-96 transition-all" placeholder="Tên nội dung...">
                        </div>
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <button onclick="setItemType('video')" id="btnTypeVideo" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-brands fa-youtube mr-1"></i> Video</button>
                            <button onclick="setItemType('pdf')" id="btnTypePdf" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-solid fa-file-pdf mr-1"></i> Tài liệu</button>
                            <button onclick="setItemType('quiz')" id="btnTypeQuiz" class="type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all"><i class="fa-solid fa-clipboard-question mr-1"></i> Bài tập</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-gray-50/50 p-8">
                        <div id="panelVideo" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Link YouTube</label>
                                <input type="text" id="videoUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand outline-none" placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                            <div id="videoPreviewArea" class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg hidden relative"><iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div>
                        </div>

                        <div id="panelPdf" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
                            <div class="flex gap-4 mb-4">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="pdfSource" value="upload" class="peer sr-only" checked onchange="togglePdfSource()"><div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-brand peer-checked:bg-teal-50 hover:bg-white text-center"><i class="fa-solid fa-cloud-arrow-up text-xl mb-1 block"></i>Tải file lên</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="pdfSource" value="drive" class="peer sr-only" onchange="togglePdfSource()"><div class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-white text-center"><i class="fa-brands fa-google-drive text-xl mb-1 block"></i>Link Google Drive</div></label>
                            </div>
                            <div id="pdfUploadArea" class="bg-white p-8 rounded-xl border-2 border-dashed border-gray-300 text-center hover:border-brand cursor-pointer group" onclick="document.getElementById('pdfFileInput').click()">
                                <input type="file" id="pdfFileInput" accept=".pdf" class="hidden" onchange="window.handlePdfUpload(this)">
                                <i class="fa-solid fa-file-pdf text-3xl text-gray-400 group-hover:text-brand mb-2"></i>
                                <p class="font-bold text-gray-700">Nhấn để chọn file PDF từ máy tính</p>
                                <div id="pdfUploadProgress" class="hidden mt-4">
                                    <div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-brand h-1.5 rounded-full" style="width: 50%"></div></div>
                                    <p class="text-xs text-brand font-bold mt-1">Đang tải lên...</p>
                                </div>
                            </div>
                            <div id="pdfDriveArea" class="hidden bg-white p-6 rounded-xl border border-gray-200"><input type="text" id="driveUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none" placeholder="Dán link Google Drive công khai vào đây..."></div>
                            <div id="pdfPreviewArea" class="h-[500px] bg-gray-800 rounded-xl overflow-hidden shadow-lg hidden"><iframe id="pdfFrame" class="w-full h-full" src=""></iframe></div>
                        </div>

                        <div id="panelQuiz" class="content-panel hidden max-w-4xl mx-auto text-center py-10">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-orange-100">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">Bài tập trắc nghiệm</h3>
                                <div id="selectedExamInfo" class="hidden mb-6 bg-orange-50 p-4 rounded-xl border border-orange-200 text-left">
                                    <div class="text-xs font-bold text-orange-600 uppercase mb-1">Đề thi đã chọn:</div>
                                    <div id="selectedExamTitle" class="font-bold text-gray-800 text-lg">...</div>
                                </div>
                                <button onclick="window.openExamSelector()" class="px-6 py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 shadow-lg"><i class="fa-solid fa-folder-open"></i> Chọn từ Ngân hàng đề</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border-t border-gray-100 p-4 flex gap-6 text-sm font-bold text-gray-600">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand"><input type="checkbox" id="isPreview" class="accent-brand w-4 h-4"><span>Cho phép học thử</span></label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-brand"><input type="checkbox" id="isPublished" checked class="accent-brand w-4 h-4"><span>Đã xuất bản</span></label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="examSelectorModal" class="hidden fixed inset-0 z-[70] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 text-lg">Chọn Đề Thi</h3>
                <div class="flex gap-2">
                    <a href="exam-editor.html" target="_blank" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700"><i class="fa-solid fa-plus-circle"></i> Tạo mới</a>
                    <button onclick="document.getElementById('examSelectorModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold text-sm">Đóng</button>
                </div>
            </div>
            <div class="px-6 py-2 bg-white border-b border-gray-100 flex items-center gap-2 text-sm" id="selectorBreadcrumb"></div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50"><div id="selectorContent" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
        </div>
    </div>
<div id="studentManagerModal" class="hidden fixed inset-0 z-[80] bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0">
            <div>
                <h3 class="font-black text-gray-800 text-lg"><i class="fa-solid fa-users text-green-600 mr-2"></i> Quản lý Học viên</h3>
                <p id="studentManagerCourseTitle" class="text-xs text-gray-500 font-bold mt-1">...</p>
            </div>
            <button onclick="document.getElementById('studentManagerModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        
        <div class="p-4 bg-white border-b border-gray-100 space-y-3 shrink-0">
            <div class="flex gap-2">
                <input type="text" id="inputStudentEmail" class="flex-1 px-4 py-2 border border-green-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm" placeholder="Nhập tên đăng nhập để thêm (VD: hocsinh123)">
                <button onclick="window.addStudentToCourse()" class="px-4 py-2 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-md text-sm whitespace-nowrap"><i class="fa-solid fa-plus mr-1"></i> Thêm thủ công</button>
            </div>
            
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                    <input type="text" id="studentSearchKeyword" onkeyup="window.renderStudentList()" placeholder="Tìm kiếm học viên..." class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white outline-none">
                </div>
                <select id="studentTypeFilter" onchange="window.renderStudentList()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm font-bold text-gray-600 outline-none bg-gray-50 cursor-pointer">
                    <option value="all">Tất cả</option>
                    <option value="paid">Đã mua (Paid)</option>
                    <option value="approved">Thêm tay (Manual)</option>
                </select>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-0">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-100 text-gray-500 font-bold text-xs uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-3 pl-6">Thông tin học viên</th>
                        <th class="p-3 text-center">Trạng thái</th>
                        <th class="p-3 text-right pr-6">Hành động</th>
                    </tr>
                </thead>
                <tbody id="enrolledStudentsList" class="divide-y divide-gray-100"></tbody>
            </table>
            <div id="emptyStudentList" class="text-center py-10 text-gray-400 hidden flex flex-col items-center">
                <i class="fa-solid fa-user-slash text-3xl mb-2 opacity-50"></i>
                <span>Không tìm thấy học viên nào.</span>
            </div>
        </div>
        
        <div class="bg-gray-50 p-3 text-center text-[10px] text-gray-400 font-bold border-t border-gray-100">
            Hiển thị danh sách học viên có quyền truy cập
        </div>
    </div>
</div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, getDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG FIREBASE CỦA BẠN (DÁN VÀO ĐÂY)
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE GLOBAL (3 CẤP)
        let currentCourseId = null;
        let currentCurriculum = []; // Mảng Chapters
        // Structure: Chapter -> lessons[] -> items[]
        let activeChapIdx = -1;
        let activeLesIdx = -1;
        let activeItemIdx = -1; // Cấp 3: Item (Nội dung)
        // Thêm vào phần khai báo biến đầu script
        let renameTarget = null; // { type: 'chap'|'les', cIdx, lIdx }
        let dragSrc = null; // Lưu thông tin phần tử đang được kéo

        // --- UTILS ---
        window.showToast = (msg, type='success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-enter p-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] ${type==='success'?'bg-white border-l-4 border-green-500':'bg-white border-l-4 border-red-500'}`;
            toast.innerHTML = `<div class="font-bold text-sm text-gray-800">${msg}</div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        window.customConfirm = (msg, onYes) => {
            document.getElementById('confirmMessage').innerText = msg;
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            const btnYes = document.getElementById('confirmBtnYes');
            const newBtn = btnYes.cloneNode(true);
            btnYes.parentNode.replaceChild(newBtn, btnYes);
            newBtn.onclick = () => { modal.classList.add('hidden'); onYes(); };
        };
        window.closeConfirm = () => document.getElementById('confirmModal').classList.add('hidden');

        // --- MAIN LOAD ---
        onAuthStateChanged(auth, (user) => { if(!user) window.location.href='index.html'; else loadCourses(); });

        window.loadCourses = async () => {
            try {
                const q = query(collection(db, "public_courses"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const list = document.getElementById('courseListTable');
                list.innerHTML = '';
                if(querySnapshot.empty) return list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Chưa có khóa học.</td></tr>`;

                querySnapshot.forEach(doc => {
                    const c = doc.data();
                    // Đếm tổng số Item (Nội dung thực tế)
                    let itemCount = 0;
                    if(c.curriculum) c.curriculum.forEach(ch => { if(ch.lessons) ch.lessons.forEach(l => { if(l.items) itemCount += l.items.length; }) });

                    list.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="p-4"><img src="${c.thumbnail || 'https://via.placeholder.com/100'}" class="w-12 h-12 rounded-lg object-cover border"></td>
                        <td class="p-4"><div class="font-bold text-gray-800">${c.title}</div></td>
                        <td class="p-4 text-xs text-gray-500 font-bold">${c.curriculum ? c.curriculum.length : 0} chương • ${itemCount} bài</td>
                        <td class="p-4 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">${c.students || 0} HV</span></td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2 opacity-100">
                                <button onclick="window.openStudentManager('${doc.id}')" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-600 hover:text-white transition-all shadow-sm" title="Quản lý học viên">
                                    <i class="fa-solid fa-user-plus"></i>
                                </button>
                                
                                <button onclick="window.openCurriculumEditor('${doc.id}')" class="p-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition-all shadow-sm" title="Soạn giáo án">
                                    <i class="fa-solid fa-book-open"></i>
                                </button>
                            <button onclick="window.editCourse('${doc.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="window.deleteCourse('${doc.id}')" class="text-red-600 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } catch(e) { window.showToast(e.message, 'error'); }
        };

        // --- EDIT BASIC INFO (MODAL 1 - UPDATED) ---
        // BƯỚC 2: Thay thế 2 hàm này trong thẻ <script>

// Hàm tải dữ liệu lên form sửa
window.editCourse = async (id) => {
    const d = await getDoc(doc(db, "public_courses", id));
    if(d.exists()) {
        const dt = d.data();
        document.getElementById('courseId').value = id;
        document.getElementById('cTitle').value = dt.title;
        
        // Cập nhật giá gốc
        document.getElementById('cOriginalPrice').value = dt.originalPrice || '';
        document.getElementById('cPrice').value = dt.price;
        
        document.getElementById('cStudents').value = dt.students;
        document.getElementById('cDesc').value = dt.desc || '';
        document.getElementById('cThumb').value = dt.thumbnail || '';
        
        // Preview ảnh (Code cũ giữ nguyên logic này)
        if(dt.thumbnail) {
            document.getElementById('previewThumb').src = dt.thumbnail;
            document.getElementById('thumbPreviewBox').classList.remove('hidden');
            document.getElementById('thumbEmptyState').classList.add('hidden');
        } else {
            document.getElementById('thumbPreviewBox').classList.add('hidden');
            document.getElementById('thumbEmptyState').classList.remove('hidden');
        }
        window.toggleModal('courseModal', true);
    }
};

// Hàm lưu dữ liệu
window.saveCourseBasic = async () => {
    const id = document.getElementById('courseId').value;
    const data = {
        title: document.getElementById('cTitle').value,
        originalPrice: parseInt(document.getElementById('cOriginalPrice').value) || 0, // Lưu giá gốc
        price: parseInt(document.getElementById('cPrice').value) || 0,
        students: parseInt(document.getElementById('cStudents').value) || 0,
        desc: document.getElementById('cDesc').value,
        thumbnail: document.getElementById('cThumb').value,
        updatedAt: new Date().toISOString()
    };
    
    if(!data.title) return window.showToast("Vui lòng nhập tên khóa học", "error");

    try {
        if(id) {
            await updateDoc(doc(db, "public_courses", id), data);
        } else { 
            data.createdAt = new Date().toISOString(); 
            await setDoc(doc(collection(db, "public_courses")), data); 
        }
        window.showToast("Đã lưu thiết lập thành công!");
        window.toggleModal('courseModal', false);
        loadCourses();
    } catch(e) { 
        window.showToast(e.message, 'error'); 
    }
};

        // --- CURRICULUM EDITOR (3 LEVELS) ---
        window.openCurriculumEditor = async (courseId) => {
            currentCourseId = courseId;
            activeChapIdx = -1; activeLesIdx = -1; activeItemIdx = -1;
            document.getElementById('curriculumModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('editorWelcome').classList.remove('hidden');
            document.getElementById('editorForm').classList.add('hidden');
            
            try {
                const d = await getDoc(doc(db,"public_courses",courseId));
                if(d.exists()) {
                    const data = d.data();
                    document.getElementById('editorCourseTitle').innerText = data.title;
                    currentCurriculum = data.curriculum || [];
                    // Migration: Nếu dữ liệu cũ (2 cấp), ta cần convert sang 3 cấp
                    // Logic convert đơn giản: Biến lesson cũ thành item nằm trong lesson mới
                    normalizeCurriculumData();
                    renderCurriculumTree();
                }
            } catch(e) { window.showToast(e.message, 'error'); }
        };

        function normalizeCurriculumData() {
            // Đảm bảo cấu trúc: Chapter -> Lessons[] -> Items[]
            currentCurriculum.forEach(chap => {
                if(!chap.lessons) chap.lessons = [];
                chap.lessons.forEach(les => {
                    // Nếu lesson cũ chưa có items array (dữ liệu cũ)
                    if(!les.items) {
                        // Chuyển nội dung lesson cũ thành 1 item con
                        if(les.type && les.content) {
                            les.items = [{
                                id: 'it_' + Date.now() + Math.random(),
                                title: "Nội dung chính",
                                type: les.type,
                                content: les.content,
                                examId: les.examId || null,
                                examTitle: les.examTitle || null
                            }];
                        } else {
                            les.items = [];
                        }
                    }
                });
            });
        }

        // BƯỚC 3.2: Thay thế hàm renderCurriculumTree cũ bằng hàm này
function renderCurriculumTree() {
    const tree = document.getElementById('curriculumTree');
    tree.innerHTML = '';
    if(currentCurriculum.length === 0) return tree.innerHTML = `<div class="text-center mt-10 text-xs text-gray-400">Chưa có nội dung</div>`;

    currentCurriculum.forEach((chap, cIdx) => {
        // --- LEVEL 1: CHAPTER ---
        const chapEl = document.createElement('div');
        chapEl.className = "mb-2 border border-gray-100 rounded-lg overflow-hidden bg-white shadow-sm transition-all";
        chapEl.draggable = true;
        // Sự kiện Drag cho Chapter
        setupDragEvents(chapEl, { type: 'chap', cIdx });

        const isCollapsed = chap.isCollapsed || false; // Trạng thái thu gọn

        chapEl.innerHTML = `
            <div class="bg-gray-50 p-2.5 flex justify-between items-center group hover:bg-gray-100 cursor-pointer select-none" onclick="toggleCollapse(${cIdx}, 'chap')">
                <div class="font-bold text-gray-800 text-sm flex-1 truncate flex items-center gap-2">
                    <i class="fa-solid fa-grip-lines text-gray-300 cursor-move hover:text-gray-500"></i>
                    <i class="fa-solid ${isCollapsed ? 'fa-folder' : 'fa-folder-open'} text-brand"></i>
                    ${chap.title}
                </div>
                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="event.stopPropagation(); openRenameModal('chap', ${cIdx})" class="w-6 h-6 hover:bg-white rounded text-gray-500"><i class="fa-solid fa-pen text-[10px]"></i></button>
                    <button onclick="event.stopPropagation(); addLesson(${cIdx})" class="w-6 h-6 hover:bg-white rounded text-blue-600"><i class="fa-solid fa-plus text-[10px]"></i></button>
                    <button onclick="event.stopPropagation(); deleteChapter(${cIdx})" class="w-6 h-6 hover:bg-white rounded text-red-600"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    <i class="fa-solid fa-chevron-${isCollapsed ? 'right' : 'down'} text-gray-400 text-xs ml-2 w-4 text-center"></i>
                </div>
            </div>
            <div id="chap_body_${cIdx}" class="pl-3 pr-1 pb-2 space-y-2 mt-1 ${isCollapsed ? 'hidden' : ''}"></div>
        `;
        
        const chapBody = chapEl.querySelector(`#chap_body_${cIdx}`);

        // --- LEVEL 2: LESSON ---
        (chap.lessons || []).forEach((les, lIdx) => {
            const lesEl = document.createElement('div');
            lesEl.className = "relative pl-4 border-l-2 border-gray-200 hover:border-brand transition-colors bg-white rounded";
            lesEl.draggable = true;
            setupDragEvents(lesEl, { type: 'les', cIdx, lIdx });

            const isLesCollapsed = les.isCollapsed || false;

            lesEl.innerHTML = `
                <div class="flex justify-between items-center py-1 group/les cursor-pointer select-none" onclick="toggleCollapse(${cIdx}, 'les', ${lIdx})">
                    <div class="text-sm font-bold text-gray-700 truncate flex items-center gap-2">
                        <i class="fa-solid fa-grip-vertical text-gray-300 text-xs cursor-move"></i>
                        <span class="${isLesCollapsed ? 'text-gray-500' : 'text-brand'}">${les.title}</span>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover/les:opacity-100 items-center">
                        <button onclick="event.stopPropagation(); openRenameModal('les', ${cIdx}, ${lIdx})" class="text-gray-400 hover:text-brand"><i class="fa-solid fa-pen text-[10px]"></i></button>
                        <button onclick="event.stopPropagation(); addItem(${cIdx},${lIdx})" class="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold hover:bg-blue-100">+ Mục</button>
                        <button onclick="event.stopPropagation(); deleteLesson(${cIdx},${lIdx})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xs"></i></button>
                        <i class="fa-solid fa-caret-${isLesCollapsed ? 'right' : 'down'} text-gray-300 text-xs ml-1"></i>
                    </div>
                </div>
            `;

            // --- LEVEL 3: ITEMS ---
            const itemsContainer = document.createElement('div');
            itemsContainer.className = `space-y-1 mt-1 ${isLesCollapsed ? 'hidden' : ''}`;
            
            (les.items || []).forEach((item, iIdx) => {
                const isActive = (cIdx === activeChapIdx && lIdx === activeLesIdx && iIdx === activeItemIdx);
                const icon = item.type === 'pdf' ? 'fa-file-pdf text-blue-500' : (item.type === 'quiz' ? 'fa-clipboard-question text-orange-500' : 'fa-play-circle text-red-500');
                
                const itemEl = document.createElement('div');
                itemEl.draggable = true;
                setupDragEvents(itemEl, { type: 'item', cIdx, lIdx, iIdx });

                itemEl.className = `flex justify-between items-center px-2 py-1.5 rounded text-xs cursor-pointer border border-transparent transition-all ${isActive ? 'bg-brand text-white shadow-md' : 'bg-gray-50 text-gray-600 hover:bg-gray-100 hover:border-gray-200'}`;
                itemEl.onclick = (e) => { e.stopPropagation(); selectItem(cIdx, lIdx, iIdx); };
                
                itemEl.innerHTML = `
                    <div class="flex items-center gap-2 truncate pointer-events-none">
                        <i class="fa-solid fa-grip-lines-vertical text-gray-300 text-[10px]"></i>
                        <i class="fa-solid ${icon}"></i>
                        <span class="truncate max-w-[120px]">${item.title}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteItem(${cIdx},${lIdx},${iIdx})" class="${isActive?'text-white/70 hover:text-white':'text-gray-300 hover:text-red-500'}"><i class="fa-solid fa-times"></i></button>
                `;
                itemsContainer.appendChild(itemEl);
            });
            
            lesEl.appendChild(itemsContainer);
            chapBody.appendChild(lesEl);
        });

        tree.appendChild(chapEl);
    });
}

        window.toggleCollapse = (id) => document.getElementById(id).classList.toggle('hidden');

        // --- ACTIONS 3 LEVELS ---
        window.addChapter = () => { currentCurriculum.push({ title: "Chương mới", lessons: [] }); renderCurriculumTree(); };
        window.renameChapter = (i) => { const t=prompt("Tên chương:",currentCurriculum[i].title); if(t){currentCurriculum[i].title=t;renderCurriculumTree();} };
        window.deleteChapter = (i) => customConfirm("Xóa chương này?",()=>{currentCurriculum.splice(i,1);renderCurriculumTree();});
        
        window.addLesson = (ci) => { currentCurriculum[ci].lessons.push({ title: "Bài học mới", items: [] }); renderCurriculumTree(); };
        window.renameLesson = (ci,li) => { const t=prompt("Tên bài học:",currentCurriculum[ci].lessons[li].title); if(t){currentCurriculum[ci].lessons[li].title=t;renderCurriculumTree();} };
        window.deleteLesson = (ci,li) => customConfirm("Xóa bài học này?",()=>{currentCurriculum[ci].lessons.splice(li,1);renderCurriculumTree();});

        window.addItem = (ci,li) => {
            currentCurriculum[ci].lessons[li].items.push({ 
                id: 'it_'+Date.now(), title: "Nội dung mới", type: 'video', content: '', isPublished: true 
            });
            renderCurriculumTree();
            selectItem(ci, li, currentCurriculum[ci].lessons[li].items.length - 1);
        };
        window.deleteItem = (ci,li,ii) => {
            if(confirm("Xóa nội dung này?")) {
                currentCurriculum[ci].lessons[li].items.splice(ii,1);
                if(ci==activeChapIdx && li==activeLesIdx && ii==activeItemIdx) {
                    document.getElementById('editorForm').classList.add('hidden');
                    document.getElementById('editorWelcome').classList.remove('hidden');
                }
                renderCurriculumTree();
            }
        };

        // --- EDITOR LOGIC ---
        window.selectItem = (ci, li, ii) => {
            activeChapIdx = ci; activeLesIdx = li; activeItemIdx = ii;
            const data = currentCurriculum[ci].lessons[li].items[ii];
            renderCurriculumTree(); // Update highlight
            
            document.getElementById('editorWelcome').classList.add('hidden');
            document.getElementById('editorForm').classList.remove('hidden');
            
            // Bind Data
            document.getElementById('editItemTitle').value = data.title;
            document.getElementById('isPreview').checked = data.isPreview || false;
            document.getElementById('isPublished').checked = data.isPublished !== false;
            
            window.setItemType(data.type);
            
            // Fill Content
            if(data.type === 'video') {
                document.getElementById('videoUrlInput').value = data.content || '';
                window.previewVideo(data.content || '');
            } else if (data.type === 'pdf') {
                if(data.content && data.content.includes('drive.google.com')) {
                    document.querySelector('input[name="pdfSource"][value="drive"]').checked = true;
                    document.getElementById('driveUrlInput').value = data.content;
                } else {
                    document.querySelector('input[name="pdfSource"][value="upload"]').checked = true;
                    if(data.content) document.getElementById('pdfFrame').src = data.content;
                }
                window.togglePdfSource();
            } else if(data.type === 'quiz') {
                document.getElementById('selectedExamTitle').innerText = data.examTitle || 'Chưa chọn đề';
                document.getElementById('selectedExamInfo').classList.toggle('hidden', !data.examId);
            }
        };

        // Auto Save to State
        document.getElementById('editItemTitle').oninput = (e) => { if(activeItemIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].title = e.target.value; };
        document.getElementById('editItemTitle').onblur = renderCurriculumTree;
        document.getElementById('videoUrlInput').oninput = (e) => { 
            if(activeItemIdx>-1) {
                currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content = e.target.value;
                window.previewVideo(e.target.value);
            }
        };
        document.getElementById('driveUrlInput').oninput = (e) => {
             if(activeItemIdx>-1) {
                currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content = e.target.value;
                window.togglePdfSource(); // Trigger preview update
             }
        };
        document.getElementById('isPreview').onchange = (e) => { if(activeItemIdx>-1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].isPreview = e.target.checked; };

        // --- HELPER FUNCTIONS ---
        window.setItemType = (type) => {
            if(activeItemIdx > -1) currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].type = type;
            
            // UI Tab Styling
            document.querySelectorAll('.type-btn').forEach(b => b.className = "type-btn px-4 py-1.5 rounded-md text-sm font-bold text-gray-500 hover:bg-white transition-all");
            const activeId = type==='video'?'btnTypeVideo':(type==='pdf'?'btnTypePdf':'btnTypeQuiz');
            const activeColor = type==='video'?'bg-red-50 text-red-600':(type==='pdf'?'bg-blue-50 text-blue-600':'bg-orange-50 text-orange-600');
            document.getElementById(activeId).className = `type-btn px-4 py-1.5 rounded-md text-sm font-bold shadow-sm transition-all ${activeColor}`;
            
            // Show Panel
            document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(type==='video'?'panelVideo':(type==='pdf'?'panelPdf':'panelQuiz')).classList.remove('hidden');
        };

        window.previewVideo = (url) => {
            if(!url) return document.getElementById('videoPreviewArea').classList.add('hidden');
            const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            if(m && m[2].length === 11) {
                document.getElementById('videoFrame').src = `https://www.youtube.com/embed/${m[2]}`;
                document.getElementById('videoPreviewArea').classList.remove('hidden');
            } else {
                document.getElementById('videoPreviewArea').classList.add('hidden');
            }
        };

        window.togglePdfSource = () => {
            const s = document.querySelector('input[name="pdfSource"]:checked').value;
            const isUpload = s === 'upload';
            document.getElementById('pdfUploadArea').classList.toggle('hidden', !isUpload);
            document.getElementById('pdfDriveArea').classList.toggle('hidden', isUpload);
            
            // Handle Preview logic
            let url = "";
            if(isUpload) {
                // Với mode upload, url nằm trong currentCurriculum.content
                if(activeItemIdx > -1) url = currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content;
            } else {
                url = document.getElementById('driveUrlInput').value;
            }

            const previewArea = document.getElementById('pdfPreviewArea');
            const iframe = document.getElementById('pdfFrame');
            
            if(url) {
                if(url.includes('drive.google.com')) {
                    // Convert view -> preview
                    url = url.replace('/view', '/preview').replace('/edit', '/preview');
                }
                iframe.src = url;
                previewArea.classList.remove('hidden');
            } else {
                previewArea.classList.add('hidden');
            }
        };

        // --- PDF UPLOAD HANDLER ---
        window.handlePdfUpload = (input) => {
            const file = input.files[0];
            if(!file) return;

            // Show Fake Progress
            document.getElementById('pdfUploadProgress').classList.remove('hidden');
            
            // SIMULATE UPLOAD (Thay bằng API thật của bạn)
            setTimeout(() => {
                // Giả sử server trả về URL này
                const fakeUrl = URL.createObjectURL(file); // Dùng Blob URL để preview tạm
                
                // Save to State
                currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].content = fakeUrl;
                
                // Update UI
                document.getElementById('pdfUploadProgress').classList.add('hidden');
                document.getElementById('pdfFrame').src = fakeUrl;
                document.getElementById('pdfPreviewArea').classList.remove('hidden');
                window.showToast("Đã tải file lên (URL tạm)", "success");
            }, 1500);
        };

        // --- EXAM SELECTOR ---
        window.openExamSelector = () => { document.getElementById('examSelectorModal').classList.remove('hidden'); loadExamManager(null); };
        window.loadExamManager = async (folderId) => {
            const container = document.getElementById('selectorContent');
            const breadcrumb = document.getElementById('selectorBreadcrumb');
            container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Đang tải...</div>';
            
            // Breadcrumb UI
            breadcrumb.innerHTML = folderId 
                ? `<span class="text-gray-400 cursor-pointer hover:text-brand" onclick="loadExamManager(null)"><i class="fa-solid fa-home"></i></span> <span class="text-gray-300">/</span> <span class="font-bold text-gray-700">Thư mục</span>`
                : `<span class="font-bold text-brand"><i class="fa-solid fa-home"></i> Gốc</span>`;

            try {
                // Fetch Data
                const qF = query(collection(db, "folders"), where("parentId", "==", folderId || null));
                const qE = query(collection(db, "exams"), where("folderId", "==", folderId || null));
                const [snapF, snapE] = await Promise.all([getDocs(qF), getDocs(qE)]);

                container.innerHTML = '';
                snapF.forEach(d => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border hover:border-brand cursor-pointer flex flex-col items-center gap-2 aspect-square justify-center shadow-sm";
                    el.onclick = () => loadExamManager(d.id);
                    el.innerHTML = `<i class="fa-solid fa-folder text-4xl text-yellow-400"></i><div class="text-xs font-bold text-gray-700 text-center">${d.data().name}</div>`;
                    container.appendChild(el);
                });
                snapE.forEach(d => {
                    const e = d.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border hover:border-orange-500 cursor-pointer flex flex-col items-center gap-2 aspect-square justify-center shadow-sm group relative";
                    el.onclick = () => {
                        // Select Exam
                        if(activeItemIdx > -1) {
                            const item = currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx];
                            item.examId = d.id;
                            item.examTitle = e.title;
                            document.getElementById('selectedExamTitle').innerText = e.title;
                            document.getElementById('selectedExamInfo').classList.remove('hidden');
                            document.getElementById('examSelectorModal').classList.add('hidden');
                            window.showToast(`Đã chọn: ${e.title}`);
                        }
                    };
                    el.innerHTML = `<i class="fa-solid fa-file-lines text-3xl text-gray-400 group-hover:text-orange-500"></i><div class="text-xs font-bold text-gray-700 text-center line-clamp-2">${e.title}</div>`;
                    container.appendChild(el);
                });
                if(snapF.empty && snapE.empty) container.innerHTML = '<div class="col-span-full text-center text-gray-300 py-10">Thư mục trống</div>';
            } catch(e) { container.innerHTML = `<div class="text-red-500 col-span-full">${e.message}</div>`; }
        };

        window.saveCurriculum = async () => {
            const btn = document.querySelector('button[onclick="saveCurriculum()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
            try {
                await updateDoc(doc(db, "public_courses", currentCourseId), { curriculum: currentCurriculum });
                window.showToast("Lưu giáo án thành công!");
            } catch(e) { window.showToast("Lỗi lưu: "+e.message, 'error'); }
            finally { btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> LƯU GIÁO ÁN'; }
        };
        
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if(show===undefined) show = el.classList.contains('hidden');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        };
        window.closeCurriculumModal = () => window.customConfirm("Đóng mà không lưu?", () => document.getElementById('curriculumModal').classList.add('hidden'));
        window.deleteCourse = (id) => window.customConfirm("Xóa khóa học này?", async()=>{ await deleteDoc(doc(db,"public_courses",id)); window.showToast("Đã xóa"); loadCourses(); });
        // --- LOGIC 1: ĐỔI TÊN (KHÔNG DÙNG PROMPT) ---
window.openRenameModal = (type, cIdx, lIdx = null) => {
    renameTarget = { type, cIdx, lIdx };
    const currentTitle = type === 'chap' 
        ? currentCurriculum[cIdx].title 
        : currentCurriculum[cIdx].lessons[lIdx].title;
    
    document.getElementById('renameInput').value = currentTitle;
    document.getElementById('renameModal').classList.remove('hidden');
    document.getElementById('renameInput').focus();
};

window.confirmRename = () => {
    const newName = document.getElementById('renameInput').value;
    if(!newName) return;
    
    if(renameTarget.type === 'chap') {
        currentCurriculum[renameTarget.cIdx].title = newName;
    } else {
        currentCurriculum[renameTarget.cIdx].lessons[renameTarget.lIdx].title = newName;
    }
    
    document.getElementById('renameModal').classList.add('hidden');
    renderCurriculumTree();
};

// --- LOGIC 2: THU GỌN (COLLAPSE) ---
window.toggleCollapse = (cIdx, type, lIdx = null) => {
    if(type === 'chap') {
        currentCurriculum[cIdx].isCollapsed = !currentCurriculum[cIdx].isCollapsed;
    } else {
        currentCurriculum[cIdx].lessons[lIdx].isCollapsed = !currentCurriculum[cIdx].lessons[lIdx].isCollapsed;
    }
    renderCurriculumTree();
};

// --- LOGIC 3: CÀI ĐẶT VIDEO (THÊM INPUT THỜI GIAN) ---
// Cập nhật sự kiện input cho trường thời gian
document.getElementById('videoMinTime').oninput = (e) => {
    if(activeItemIdx > -1) {
        currentCurriculum[activeChapIdx].lessons[activeLesIdx].items[activeItemIdx].minWatchTime = e.target.value;
    }
};

// Cập nhật hàm selectItem cũ để load dữ liệu thời gian
const originalSelectItem = window.selectItem;
window.selectItem = (cIdx, lIdx, iIdx) => {
    // Gọi lại logic cũ để hiện form
    activeChapIdx = cIdx; activeLesIdx = lIdx; activeItemIdx = iIdx;
    const data = currentCurriculum[cIdx].lessons[lIdx].items[iIdx];
    
    // Logic cũ (Rút gọn để bạn copy đè hoặc merge)
    renderCurriculumTree(); 
    document.getElementById('editorWelcome').classList.add('hidden');
    document.getElementById('editorForm').classList.remove('hidden');
    document.getElementById('editItemTitle').value = data.title;
    document.getElementById('isPreview').checked = data.isPreview || false;
    document.getElementById('isPublished').checked = data.isPublished !== false;
    window.setItemType(data.type);
    if(data.type === 'video') {
        document.getElementById('videoUrlInput').value = data.content || '';
        // MỚI: Load thời gian xem
        document.getElementById('videoMinTime').value = data.minWatchTime || 10;
        window.previewVideo(data.content || '');
    } else if (data.type === 'pdf') {
        if(data.content && data.content.includes('drive.google.com')) {
            document.querySelector('input[name="pdfSource"][value="drive"]').checked = true;
            document.getElementById('driveUrlInput').value = data.content;
        } else {
            document.querySelector('input[name="pdfSource"][value="upload"]').checked = true;
            if(data.content) document.getElementById('pdfFrame').src = data.content;
        }
        window.togglePdfSource();
    } else if(data.type === 'quiz') {
        document.getElementById('selectedExamTitle').innerText = data.examTitle || 'Chưa chọn đề';
        document.getElementById('selectedExamInfo').classList.toggle('hidden', !data.examId);
    }
};

// --- LOGIC 4: KÉO THẢ (DRAG & DROP ENGINE) ---
function setupDragEvents(el, data) {
    el.ondragstart = (e) => {
        e.stopPropagation();
        dragSrc = data;
        el.classList.add('draggable-source');
        e.dataTransfer.effectAllowed = 'move';
        // Hack để trên Firefox hoạt động
        e.dataTransfer.setData('text/plain', JSON.stringify(data)); 
    };

    el.ondragend = (e) => {
        el.classList.remove('draggable-source');
        document.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-inside').forEach(e => {
            e.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-inside');
        });
        dragSrc = null;
    };

    el.ondragover = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if(!dragSrc) return;
        
        // Logic hiển thị vạch chỉ dẫn (Trên/Dưới/Trong)
        const rect = el.getBoundingClientRect();
        const offset = e.clientY - rect.top;
        
        // Reset style
        el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-inside');

        // Logic Kéo Chapter
        if(dragSrc.type === 'chap' && data.type === 'chap') {
            if(offset < rect.height / 2) el.classList.add('drag-over-top');
            else el.classList.add('drag-over-bottom');
        }
        // Logic Kéo Lesson (vào Lesson khác hoặc vào Chapter)
        else if(dragSrc.type === 'les') {
            if(data.type === 'les') {
                if(offset < rect.height / 2) el.classList.add('drag-over-top');
                else el.classList.add('drag-over-bottom');
            } else if (data.type === 'chap') {
                el.classList.add('drag-over-inside'); // Kéo Lesson vào Chapter
            }
        }
        // Logic Kéo Item
        else if(dragSrc.type === 'item') {
            if(data.type === 'item') {
                 if(offset < rect.height / 2) el.classList.add('drag-over-top');
                else el.classList.add('drag-over-bottom');
            } else if(data.type === 'les') {
                 el.classList.add('drag-over-inside'); // Kéo Item vào Lesson
            }
        }
    };

    el.ondrop = (e) => {
        e.stopPropagation();
        e.preventDefault();
        if(!dragSrc) return;
        
        // Xử lý Logic di chuyển dữ liệu
        // 1. CHAPTER
        if(dragSrc.type === 'chap' && data.type === 'chap') {
            const srcItem = currentCurriculum[dragSrc.cIdx];
            currentCurriculum.splice(dragSrc.cIdx, 1); // Xóa cũ
            // Tính index mới (nếu kéo từ dưới lên thì index không đổi, nếu từ trên xuống thì -1)
            let newIdx = data.cIdx;
            if(el.classList.contains('drag-over-bottom')) newIdx++;
            if(dragSrc.cIdx < data.cIdx) newIdx--; 
            
            currentCurriculum.splice(newIdx, 0, srcItem); // Chèn mới
        }
        // 2. LESSON
        else if(dragSrc.type === 'les') {
            const srcLesson = currentCurriculum[dragSrc.cIdx].lessons[dragSrc.lIdx];
            
            if(data.type === 'les') {
                // Di chuyển trong cùng list hoặc khác list đều được
                currentCurriculum[dragSrc.cIdx].lessons.splice(dragSrc.lIdx, 1);
                
                let newLIdx = data.lIdx;
                if(el.classList.contains('drag-over-bottom')) newLIdx++;
                // Nếu cùng 1 chapter và kéo xuống dưới, phải trừ index
                if(dragSrc.cIdx === data.cIdx && dragSrc.lIdx < data.lIdx) newLIdx--;
                
                currentCurriculum[data.cIdx].lessons.splice(newLIdx, 0, srcLesson);
            } else if (data.type === 'chap') {
                // Thả vào Chapter (Append vào cuối)
                currentCurriculum[dragSrc.cIdx].lessons.splice(dragSrc.lIdx, 1);
                if(!currentCurriculum[data.cIdx].lessons) currentCurriculum[data.cIdx].lessons = [];
                currentCurriculum[data.cIdx].lessons.push(srcLesson);
            }
        }
        // 3. ITEM
        else if(dragSrc.type === 'item') {
             const srcItem = currentCurriculum[dragSrc.cIdx].lessons[dragSrc.lIdx].items[dragSrc.iIdx];
             
             if(data.type === 'item') {
                 currentCurriculum[dragSrc.cIdx].lessons[dragSrc.lIdx].items.splice(dragSrc.iIdx, 1);
                 
                 let newIIdx = data.iIdx;
                 if(el.classList.contains('drag-over-bottom')) newIIdx++;
                 if(dragSrc.cIdx === data.cIdx && dragSrc.lIdx === data.lIdx && dragSrc.iIdx < data.iIdx) newIIdx--;
                 
                 currentCurriculum[data.cIdx].lessons[data.lIdx].items.splice(newIIdx, 0, srcItem);
             } else if(data.type === 'les') {
                 // Thả vào Lesson (Append cuối)
                 currentCurriculum[dragSrc.cIdx].lessons[dragSrc.lIdx].items.splice(dragSrc.iIdx, 1);
                 currentCurriculum[data.cIdx].lessons[data.lIdx].items.push(srcItem);
             }
        }
        
        // Reset selection và Render lại
        activeChapIdx = -1; activeLesIdx = -1; activeItemIdx = -1;
        document.getElementById('editorForm').classList.add('hidden');
        document.getElementById('editorWelcome').classList.remove('hidden');
        renderCurriculumTree();
    };
}
        // ==========================================
// TÍNH NĂNG EXCEL (IMPORT / EXPORT / TEMPLATE)
// ==========================================

// 1. TẢI FILE MẪU
window.downloadTemplate = () => {
    // Tạo dữ liệu mẫu chuẩn
    const data = [
        {
            "Chương": "Chương 1: Giới thiệu",
            "Bài học": "Bài 1: Tổng quan",
            "Tên nội dung": "Video giới thiệu",
            "Loại (video/pdf/quiz)": "video",
            "Link/ID (Youtube hoặc Drive)": "https://www.youtube.com/watch?v=example",
            "Thời gian (phút)": 10,
            "Học thử (có/không)": "có"
        },
        {
            "Chương": "Chương 1: Giới thiệu",
            "Bài học": "Bài 1: Tổng quan",
            "Tên nội dung": "Tài liệu nhập môn",
            "Loại (video/pdf/quiz)": "pdf",
            "Link/ID (Youtube hoặc Drive)": "https://drive.google.com/file/d/example",
            "Thời gian (phút)": "",
            "Học thử (có/không)": "không"
        },
        {
            "Chương": "Chương 1: Giới thiệu",
            "Bài học": "Bài 2: Kiểm tra đầu vào",
            "Tên nội dung": "Đề khảo sát",
            "Loại (video/pdf/quiz)": "quiz",
            "Link/ID (Youtube hoặc Drive)": "ID_DE_THI_TU_NGAN_HANG",
            "Thời gian (phút)": "",
            "Học thử (có/không)": "không"
        }
    ];

    const ws = XLSX.utils.json_to_sheet(data);
    
    // Chỉnh độ rộng cột cho dễ nhìn
    const wscols = [{wch:25}, {wch:25}, {wch:30}, {wch:15}, {wch:40}, {wch:15}, {wch:15}];
    ws['!cols'] = wscols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Mau_Cau_Truc");
    XLSX.writeFile(wb, "Mau_Nhap_Khoa_Hoc.xlsx");
};

// 2. XUẤT CẤU TRÚC HIỆN TẠI RA EXCEL
window.exportCurriculum = () => {
    if(currentCurriculum.length === 0) return window.showToast("Giáo án trống, không có gì để xuất!", "error");

    const rows = [];
    
    currentCurriculum.forEach(chap => {
        // Nếu chương không có bài học, vẫn xuất dòng chương
        if(!chap.lessons || chap.lessons.length === 0) {
            rows.push({
                "Chương": chap.title, "Bài học": "", "Tên nội dung": "", "Loại (video/pdf/quiz)": "", "Link/ID (Youtube hoặc Drive)": "", "Thời gian (phút)": "", "Học thử (có/không)": ""
            });
        } else {
            chap.lessons.forEach(les => {
                // Nếu bài học không có item
                if(!les.items || les.items.length === 0) {
                    rows.push({
                        "Chương": chap.title, "Bài học": les.title, "Tên nội dung": "", "Loại (video/pdf/quiz)": "", "Link/ID (Youtube hoặc Drive)": "", "Thời gian (phút)": "", "Học thử (có/không)": ""
                    });
                } else {
                    les.items.forEach(item => {
                        let content = item.content || "";
                        // Nếu là quiz thì lấy ID đề thi
                        if(item.type === 'quiz') content = item.examId || "";
                        
                        rows.push({
                            "Chương": chap.title,
                            "Bài học": les.title,
                            "Tên nội dung": item.title,
                            "Loại (video/pdf/quiz)": item.type,
                            "Link/ID (Youtube hoặc Drive)": content,
                            "Thời gian (phút)": item.minWatchTime || "",
                            "Học thử (có/không)": item.isPreview ? "có" : "không"
                        });
                    });
                }
            });
        }
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Cau_Truc_Khoa_Hoc");
    XLSX.writeFile(wb, `Cau_Truc_${document.getElementById('cTitle').value || 'Khoa_Hoc'}.xlsx`);
};

// 3. NHẬP TỪ EXCEL (IMPORT)
window.importCurriculum = (input) => {
    const file = input.files[0];
    if(!file) return;

    if(!confirm("Cảnh báo: Hành động này sẽ GHI ĐÈ toàn bộ cấu trúc giáo án hiện tại. Bạn có chắc chắn muốn tiếp tục?")) {
        input.value = ''; // Reset input
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);

            if(json.length === 0) return window.showToast("File rỗng!", "error");

            // LOGIC PARSING: Chuyển Flat JSON -> Nested Array (Chapter > Lesson > Item)
            const newCurriculum = [];
            let currentChap = null;
            let currentLes = null;

            // Biến tạm để nhớ giá trị dòng trước (nếu người dùng merge cell hoặc để trống ô lặp lại)
            let lastChapName = "";
            let lastLesName = "";

            json.forEach(row => {
                // Lấy giá trị các cột (Trim space thừa)
                let cName = (row["Chương"] || "").toString().trim();
                let lName = (row["Bài học"] || "").toString().trim();
                let iName = (row["Tên nội dung"] || "").toString().trim();
                let iType = (row["Loại (video/pdf/quiz)"] || "video").toString().toLowerCase().trim();
                let iLink = (row["Link/ID (Youtube hoặc Drive)"] || "").toString().trim();
                let iTime = row["Thời gian (phút)"];
                let iPreview = (row["Học thử (có/không)"] || "").toString().toLowerCase().includes("có");

                // Logic điền đầy (Fill down) nếu để trống (giả lập merge cell)
                if(cName === "") cName = lastChapName; else lastChapName = cName;
                if(lName === "") lName = lastLesName; else lastLesName = lName;

                // 1. Xử lý CHƯƠNG
                if(cName) {
                    // Nếu chưa có chương hoặc tên chương thay đổi -> Tạo chương mới
                    if(!currentChap || currentChap.title !== cName) {
                        currentChap = { title: cName, lessons: [], isCollapsed: false };
                        newCurriculum.push(currentChap);
                        currentLes = null; // Reset lesson khi qua chương mới
                    }
                }

                // 2. Xử lý BÀI HỌC
                if(lName && currentChap) {
                    if(!currentLes || currentLes.title !== lName) {
                        currentLes = { title: lName, items: [], isCollapsed: false };
                        currentChap.lessons.push(currentLes);
                    }
                }

                // 3. Xử lý NỘI DUNG (ITEM)
                if(iName && currentLes) {
                    const newItem = {
                        id: 'it_' + Date.now() + Math.random().toString(36).substr(2, 9),
                        title: iName,
                        type: iType,
                        content: iLink, // Mặc định gán link vào content
                        minWatchTime: iTime || 10,
                        isPreview: iPreview,
                        isPublished: true
                    };

                    // Nếu là Quiz, content chính là ExamID. Cần query lấy Title đề thi (tuy nhiên import excel khó check title ngay, tạm thời để trống title)
                    if(iType === 'quiz') {
                        newItem.examId = iLink;
                        newItem.examTitle = "Đề thi (ID: " + iLink + ")"; // Placeholder
                    }

                    currentLes.items.push(newItem);
                }
            });

            // Cập nhật dữ liệu
            currentCurriculum = newCurriculum;
            renderCurriculumTree();
            window.showToast("Đã nhập cấu trúc thành công!", "success");
            
            // Reset UI editor
            document.getElementById('editorForm').classList.add('hidden');
            document.getElementById('editorWelcome').classList.remove('hidden');

        } catch (err) {
            console.error(err);
            window.showToast("Lỗi đọc file: " + err.message, "error");
        } finally {
            input.value = ''; // Reset để chọn lại file cũ được
        }
    };
    reader.readAsArrayBuffer(file);
};
// --- LOGIC QUẢN LÝ HỌC VIÊN (MỚI) ---
        let currentManageCourseId = null;
        let currentManageCourseTitle = "";
        let allStudentsData = []; // Biến lưu danh sách tạm để lọc

        window.openStudentManager = async (courseId) => {
            currentManageCourseId = courseId;
            document.getElementById('studentManagerModal').classList.remove('hidden');
            document.getElementById('enrolledStudentsList').innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang tải danh sách...</td></tr>';
            
            try {
                // 1. Lấy thông tin khóa học
                const cSnap = await getDoc(doc(db, "public_courses", courseId));
                if (cSnap.exists()) {
                    currentManageCourseTitle = cSnap.data().title;
                    document.getElementById('studentManagerCourseTitle').innerText = currentManageCourseTitle;
                }

                // 2. Lấy TẤT CẢ đơn hàng liên quan (Không lọc status ở API để tránh lỗi index, sẽ lọc ở JS)
                const q = query(collection(db, "orders"), where("courseId", "==", courseId));
                const snap = await getDocs(q);
                
                allStudentsData = []; // Reset list

                snap.forEach(d => {
                    const data = d.data();
                    // Chỉ lấy đơn Đã mua (paid) hoặc Được duyệt (approved)
                    if(data.status === 'paid' || data.status === 'approved') {
                        allStudentsData.push({
                            id: d.id, // Order ID (Dùng để xóa)
                            name: data.userName || "Không tên",
                            email: data.userEmail || data.userId, // Hiển thị email hoặc UID
                            date: data.createdAt,
                            status: data.status, // 'paid' hoặc 'approved'
                            amount: data.amount || 0
                        });
                    }
                });

                // 3. Hiển thị ra bảng
                window.renderStudentList();

            } catch (e) { 
                console.error(e);
                window.showToast("Lỗi tải danh sách: " + e.message, "error"); 
            }
        };
        window.renderStudentList = () => {
            const keyword = document.getElementById('studentSearchKeyword').value.toLowerCase();
            const filterType = document.getElementById('studentTypeFilter').value; // all, paid, approved
            const listContainer = document.getElementById('enrolledStudentsList');
            const emptyMsg = document.getElementById('emptyStudentList');

            // Logic lọc dữ liệu
            const filtered = allStudentsData.filter(s => {
                const matchText = s.name.toLowerCase().includes(keyword) || s.email.toLowerCase().includes(keyword);
                const matchType = filterType === 'all' || s.status === filterType;
                return matchText && matchType;
            });

            // Sắp xếp mới nhất lên đầu
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            listContainer.innerHTML = '';
            if (filtered.length === 0) {
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            let html = '';
            filtered.forEach(s => {
                // Config hiển thị theo trạng thái
                let badge = '';
                let icon = '';
                
                if (s.status === 'paid') {
                    badge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold uppercase border border-green-200">Đã mua ${s.amount ? '('+(s.amount/1000)+'k)' : ''}</span>`;
                    icon = `<div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center font-bold text-xs"><i class="fa-solid fa-cart-shopping"></i></div>`;
                } else {
                    badge = `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase border border-blue-200">Thêm tay</span>`;
                    icon = `<div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-xs"><i class="fa-solid fa-user-check"></i></div>`;
                }

                html += `
                <tr class="hover:bg-gray-50 group border-b border-gray-50 last:border-0 transition-colors">
                    <td class="p-3 pl-6">
                        <div class="flex items-center gap-3">
                            ${icon}
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${s.name}</div>
                                <div class="text-xs text-gray-500 font-mono">${s.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-3 text-center">
                        <div class="flex flex-col items-center gap-1">
                            ${badge}
                            <span class="text-[10px] text-gray-400">${new Date(s.date).toLocaleDateString('vi-VN')}</span>
                        </div>
                    </td>
                    <td class="p-3 text-right pr-6">
                        <button onclick="window.removeStudentFromCourse('${s.id}')" class="w-8 h-8 rounded-lg text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all" title="Xóa khỏi khóa học">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                </tr>`;
            });
            listContainer.innerHTML = html;
        };
        window.removeStudentFromCourse = async (orderId) => {
            if(!confirm("Bạn có chắc chắn muốn xóa học viên này khỏi khóa học?\nHành động này sẽ xóa đơn hàng và thu hồi quyền truy cập.")) return;
            
            // Tìm nút xóa đang bấm để hiện loading (Optional UX)
            // const btn = event.currentTarget; 
            // btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                // Xóa đơn hàng trong collection 'orders'
                await deleteDoc(doc(db, "orders", orderId));
                
                window.showToast("Đã xóa học viên thành công!", "success");
                
                // Tải lại danh sách (Gọi lại hàm mở modal để fetch lại data mới nhất)
                window.openStudentManager(currentManageCourseId);
                
            } catch(e) {
                console.error(e);
                window.showToast("Lỗi khi xóa: " + e.message, "error");
            }
        };

       window.addStudentToCourse = async () => {
            let inputValue = document.getElementById('inputStudentEmail').value.trim();
            if (!inputValue) return window.showToast("Vui lòng nhập tên đăng nhập!", "error");

            let email = inputValue;
            if (!email.includes('@')) email = inputValue + "@gmail.com";

            const btn = document.querySelector('button[onclick="window.addStudentToCourse()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Tìm User
                const qUser = query(collection(db, "users"), where("email", "==", email));
                const userSnap = await getDocs(qUser);

                if (userSnap.empty) {
                    alert(`Không tìm thấy user "${email}".\nHọc viên cần đăng nhập web ít nhất 1 lần.`);
                    btn.innerHTML = originalText; btn.disabled = false; return;
                }

                const userData = userSnap.docs[0].data();
                const userId = userSnap.docs[0].id;

                // 2. Kiểm tra xem đã có trong khóa chưa (CHECK CẢ PAID VÀ APPROVED)
                // Lưu ý: Firestore JS SDK cũ khó dùng OR trong query phức tạp, nên ta query theo course+user rồi lọc JS
                const qCheck = query(collection(db, "orders"), where("courseId", "==", currentManageCourseId), where("userId", "==", userId));
                const checkSnap = await getDocs(qCheck);
                
                let exists = false;
                checkSnap.forEach(d => {
                    const st = d.data().status;
                    if(st === 'paid' || st === 'approved') exists = true;
                });

                if (exists) {
                    window.showToast("Học viên này đã có trong khóa học!", "info");
                } else {
                    // 3. Tạo Order Approved
                    await setDoc(doc(collection(db, "orders")), {
                        userId: userId,
                        userEmail: email,
                        userName: userData.displayName || "Học viên",
                        courseId: currentManageCourseId,
                        courseTitle: currentManageCourseTitle,
                        amount: 0,
                        status: 'approved',
                        createdAt: new Date().toISOString(),
                        note: 'Thêm thủ công bởi Admin'
                    });
                    
                    window.showToast(`Đã thêm: ${email}`, "success");
                    document.getElementById('inputStudentEmail').value = '';
                    // Reload
                    window.openStudentManager(currentManageCourseId);
                }

            } catch (e) {
                console.error(e);
                window.showToast("Lỗi: " + e.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };     
    </script>
    
    <div id="renameModal" class="hidden fixed inset-0 z-[220] flex items-center justify-center bg-gray-900/60 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 animate-fade-in-up">
        <h3 class="font-bold text-gray-800 text-lg mb-4">Đổi tên nội dung</h3>
        <input type="text" id="renameInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none font-bold text-gray-700" placeholder="Nhập tên mới..." onkeyup="if(event.key==='Enter') confirmRename()">
        <div class="flex justify-end gap-2 mt-6">
            <button onclick="document.getElementById('renameModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">Hủy</button>
            <button onclick="confirmRename()" class="px-6 py-2 bg-brand text-white font-bold rounded-lg shadow-lg hover:shadow-xl">Lưu</button>
        </div>
    </div>
</div>

<div id="panelVideo" class="content-panel hidden space-y-6 max-w-4xl mx-auto">
    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-4">
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Đường dẫn Video (YouTube)</label>
            <input type="text" id="videoUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand outline-none" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Thời gian xem tối thiểu (Phút)</label>
            <div class="relative">
                <input type="number" id="videoMinTime" value="10" class="w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand outline-none font-mono font-bold" placeholder="10">
                <span class="absolute right-4 top-2 text-gray-400 text-sm font-bold">Phút</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">Học sinh cần xem đủ thời gian này mới được tính là hoàn thành.</p>
        </div>
    </div>
    <div id="videoPreviewArea" class="aspect-video bg-black rounded-xl overflow-hidden shadow-lg hidden relative"><iframe id="videoFrame" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div>
</div>
</body>
</html>
