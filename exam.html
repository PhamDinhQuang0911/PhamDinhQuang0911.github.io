<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√†m b√†i thi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      loader: {load: ['[tex]/color']},
      tex: {
        packages: {'[+]': ['color']},
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      chtml: {
          scale: 1,
          minScale: 0.5,
          mtextInheritFont: true,
          merrorInheritFont: true,
          mathml: false,
          displayAlign: 'left',
          displayIndent: '0'
      },
      options: {
        renderActions: {
          addMenu: [0, '', ''] 
        }
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; overscroll-behavior-y: none; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* CSS quan tr·ªçng: Ch·ªëng tr√†n ·∫£nh v√† c√¥ng th·ª©c */
        #questionContent img, #answerOptions img { max-width: 100% !important; height: auto !important; display: block; margin: 0.5rem auto; border-radius: 8px; }
        mjx-container { max-width: 100% !important; overflow-x: auto; overflow-y: hidden; display: block !important; }
        .mjx-chtml { outline: 0; }

        /* Style cho n√∫t c√¢u h·ªèi (Palette) */
        .q-btn {
            width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: 700; font-size: 0.85rem;
            border: 1px solid #E5E7EB; background-color: white; color: #4B5563;
            transition: all 0.2s; position: relative; cursor: pointer;
        }
        .q-btn:hover { background-color: #F9FAFB; border-color: #D1D5DB; }
        .q-btn.active { background-color: #FF6A00 !important; color: white !important; border-color: #FF6A00 !important; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(255, 106, 0, 0.3); z-index: 10; }
        .q-btn.answered { background-color: #EFF6FF; color: #2563EB; border-color: #BFDBFE; }
        .q-btn.flagged::after { content: "\f024"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -4px; right: -4px; font-size: 10px; color: #EF4444; background: #FEF2F2; border-radius: 50%; padding: 2px; border: 1px solid #FECACA; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <div id="paletteBackdrop" onclick="closeMobilePalette()" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden transition-opacity opacity-0 pointer-events-none"></div>

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-sm animate-bounce">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            
            <h1 id="lobbyTitle" class="text-2xl font-bold mb-2">ƒêang t·∫£i d·ªØ li·ªáu...</h1>
            
            <div id="accessDeniedMsg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl mb-4 text-sm font-bold border border-red-200 text-left flex items-start gap-3">
                <i class="fa-solid fa-triangle-exclamation mt-0.5 text-lg"></i> 
                <span id="errorText">L·ªói truy c·∫≠p</span>
            </div>

            <p class="text-sm text-gray-500 mb-8 flex items-center justify-center gap-2">
                <i class="fa-regular fa-clock"></i> Th·ªùi gian l√†m b√†i: <span id="lobbyDuration" class="font-bold text-blue-600 text-lg">--</span> ph√∫t
            </p>
            
            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between"><span class="text-gray-500">Tr·∫°ng th√°i:</span><span id="lobbyStatusBadge" class="font-bold text-gray-700">Checking...</span></div>
                <div class="flex justify-between"><span class="text-gray-500">S·ªë l∆∞·ª£t:</span><span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span></div>
                <div class="flex justify-between hidden" id="lobbyTimeRange"><span class="text-gray-500">M·ªü ƒë·ªÅ:</span><span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span></div>
            </div>

            <button id="btnStartExam" onclick="startExam()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all transform active:scale-95 flex items-center justify-center gap-2">
                <i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i
            </button>
            <button onclick="window.history.back()" class="mt-6 text-gray-400 text-sm hover:text-gray-600 flex items-center justify-center gap-1 mx-auto">
                <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i
            </button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 md:px-6 hidden">
        <div class="flex items-center gap-3 md:gap-4 overflow-hidden">
            <button onclick="finishExam(false)" class="text-gray-400 hover:text-red-500 transition-colors shrink-0" title="Tho√°t">
                <i class="fa-solid fa-arrow-right-from-bracket text-xl transform rotate-180"></i>
            </button>
            <div class="overflow-hidden">
                <h1 id="examTitle" class="text-base md:text-lg font-bold text-gray-800 truncate">B√†i thi</h1>
                <p class="text-xs text-gray-500 truncate hidden sm:block">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>
        <div class="flex items-center gap-2 md:gap-4 shrink-0">
            <div id="cheatWarning" class="hidden text-red-500 bg-red-50 px-2 md:px-3 py-1 rounded-full text-xs font-bold border border-red-100 flex items-center gap-1">
                <i class="fa-solid fa-triangle-exclamation animate-pulse"></i> <span id="cheatCount">0</span> c·∫£nh b√°o
            </div>
            <div class="bg-gray-900 text-white px-3 md:px-4 py-1.5 md:py-2 rounded-lg font-mono font-bold text-sm md:text-base shadow-sm flex items-center gap-2">
                <i class="fa-regular fa-clock text-orange-400 hidden md:inline"></i> <span id="timer">00:00</span>
            </div>
            <button onclick="finishExam()" class="hidden md:flex px-4 md:px-6 py-1.5 md:py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-colors items-center gap-2">
                <i class="fa-solid fa-paper-plane"></i> N·ªôp b√†i
            </button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden relative">
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar pb-20 md:pb-6" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-sm min-h-full relative border border-gray-100">
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">C√¢u h·ªèi</span>
                        <h2 class="text-xl font-bold text-gray-800">C√¢u <span id="currentQNum" class="text-2xl text-blue-600">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-red-500 text-2xl transition-colors p-2" title="ƒê√°nh d·∫•u">
                        <i class="fa-regular fa-flag"></i>
                    </button>
                </div>
                
                <div id="questionContent" class="text-lg text-gray-800 font-medium leading-relaxed mb-8 overflow-x-auto"></div>
                
                <div id="answerOptions" class="space-y-4 overflow-x-auto"></div>
            </div>
        </div>

        <aside id="paletteSidebar" class="fixed inset-y-0 right-0 w-80 bg-white border-l border-gray-200 z-40 transform translate-x-full transition-transform duration-300 md:relative md:translate-x-0 md:flex flex-col md:w-80 md:shadow-none shadow-2xl">
             <div class="p-4 md:p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-gray-700 text-lg">Danh s√°ch c√¢u h·ªèi</h3>
                    <div class="flex gap-3 mt-2 text-xs text-gray-500 font-medium">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded"></span> ƒêang l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-300 rounded"></span> ƒê√£ l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-white border border-red-400 rounded relative"><i class="fa-solid fa-flag text-[8px] text-red-500 absolute -top-0.5 -right-0.5"></i></span> C·ªù</div>
                    </div>
                </div>
                <button onclick="closeMobilePalette()" class="md:hidden p-2 text-gray-400 hover:text-gray-600 bg-white rounded-full shadow-sm border border-gray-100">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 md:p-5 no-scrollbar">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
            
            <div class="p-4 md:p-5 border-t border-gray-200 md:hidden">
                <button onclick="finishExam()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-200 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> N·ªôp b√†i thi
                </button>
            </div>
        </aside>

        <div class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex justify-between items-center z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] gap-3 safe-area-bottom">
            <button id="prevBtnMob" class="flex-1 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-600 transition-colors flex items-center justify-center gap-1">
                <i class="fa-solid fa-chevron-left"></i> Tr∆∞·ªõc
            </button>
            
            <button onclick="openMobilePalette()" class="flex-1 py-2.5 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-xl font-bold transition-colors flex items-center justify-center gap-2 border border-blue-100">
                <i class="fa-solid fa-list-ol"></i> Danh s√°ch
            </button>
            
            <button id="nextBtnMob" class="flex-1 py-2.5 bg-orange-custom hover:bg-orange-600 text-white rounded-xl font-bold shadow-md shadow-orange-200 transition-colors flex items-center justify-center gap-1">
                Sau <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </main>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-50 hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl transform scale-95 transition-transform duration-200 modal-content">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2 text-2xl"><i class="fa-solid fa-lock"></i></div>
                <h3 class="font-bold text-gray-800 text-lg">Y√™u c·∫ßu m·∫≠t kh·∫©u</h3>
                <p class="text-xs text-gray-500">ƒê·ªÅ thi n√†y ƒë∆∞·ª£c b·∫£o v·ªá.</p>
            </div>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl mb-4 text-center font-bold text-lg focus:border-blue-500 outline-none" placeholder="¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑">
            <div class="flex gap-2">
                <button onclick="closePasswordModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-colors">H·ªßy</button>
                <button onclick="verifyPassword()" class="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-colors">V√†o thi</button>
            </div>
        </div>
    </div>
    
    <div id="confirmSubmitModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-50 hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
         <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl transform scale-95 transition-transform duration-200 modal-content text-center">
            <div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-pulse"><i class="fa-solid fa-circle-question"></i></div>
            <h3 class="font-bold text-gray-800 text-xl mb-2">N·ªôp b√†i thi?</h3>
            <p class="text-gray-500 mb-6">B·∫°n c√≤n <span id="unansweredCount" class="font-bold text-red-500">0</span> c√¢u ch∆∞a l√†m. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i ngay b√¢y gi·ªù?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmSubmitModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">Ki·ªÉm tra l·∫°i</button>
                <button onclick="confirmFinishExam()" class="flex-1 py-3 bg-orange-custom text-white rounded-xl font-bold shadow-md hover:bg-orange-600 transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-paper-plane"></i> N·ªôp ngay</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üèÜ</div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6" id="resultMsg">ƒê√£ n·ªôp b√†i th√†nh c√¥ng.</p>
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-8 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">ƒê√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            <button onclick="window.location.href='dashboard.html'" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">V·ªÅ trang ch·ªß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser, examData, examId;
        let questions = [], answers = {}, flagged = {};
        let currentIdx = 0, timerInterval, timeLeft = 0, cheatCount = 0, isActive = false;

        const dom = {
            lobby: document.getElementById('lobbyScreen'),
            header: document.getElementById('examHeader'),
            main: document.getElementById('examMain'),
            content: document.getElementById('questionContent'),
            options: document.getElementById('answerOptions'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timer'),
            errBox: document.getElementById('accessDeniedMsg'),
            errTxt: document.getElementById('errorText'),
            btnStart: document.getElementById('btnStartExam'),
            badge: document.getElementById('questionTypeBadge'),
            passModal: document.getElementById('passwordModal'),
            passInput: document.getElementById('examPasswordInput'),
            confirmModal: document.getElementById('confirmSubmitModal'),
            unansweredCnt: document.getElementById('unansweredCount'),
            sidebar: document.getElementById('paletteSidebar'),
            backdrop: document.getElementById('paletteBackdrop')
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                examId = new URLSearchParams(window.location.search).get('id');
                if(!examId) return window.location.href = 'dashboard.html';
                document.getElementById('examIdDisplay').textContent = examId;
                await loadLobby();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadLobby() {
            try {
                dom.btnStart.disabled = true;
                dom.btnStart.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang ki·ªÉm tra...';
                
                const snap = await getDoc(doc(db, "exams", examId));
                if (!snap.exists()) throw new Error("ƒê·ªÅ thi kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a!");
                examData = snap.data();
                
                document.getElementById('lobbyTitle').textContent = examData.title;
                document.getElementById('lobbyDuration').textContent = examData.duration || '‚àû';

                // KI·ªÇM TRA L·ªöP H·ªåC (QUAN TR·ªåNG)
                if (examData.accessType === 'class' && examData.allowedClassId) {
                    const classSnap = await getDoc(doc(db, "classes", examData.allowedClassId));
                    if (!classSnap.exists()) throw new Error("L·ªõp h·ªçc ƒë∆∞·ª£c giao ƒë·ªÅ n√†y ƒë√£ b·ªã x√≥a!");
                    const students = classSnap.data().students || [];
                    const myEmail = currentUser.email.toLowerCase();
                    const isMember = students.some(s => (s.email && s.email.toLowerCase() === myEmail) || (s.username && `${s.username}@hocsinh.com`.toLowerCase() === myEmail));
                    if (!isMember) throw new Error("B·∫°n kh√¥ng thu·ªôc l·ªõp ƒë∆∞·ª£c giao ƒë·ªÅ thi n√†y!");
                }

                // KI·ªÇM TRA S·ªê L·∫¶N L√ÄM B√ÄI
                if (examData.attempts > 0) {
                    // C·∫ßn Index tr√™n Firebase: results [examId ASC, studentId ASC]
                    const q = query(collection(db, "results"), where("examId", "==", examId), where("studentId", "==", currentUser.uid));
                    const attemptsSnap = await getDocs(q);
                    const doneCount = attemptsSnap.size;
                    
                    document.getElementById('lobbyAttempts').textContent = doneCount;
                    document.getElementById('lobbyMaxAttempts').textContent = examData.attempts;

                    if (doneCount >= examData.attempts) throw new Error(`B·∫°n ƒë√£ h·∫øt s·ªë l∆∞·ª£t l√†m b√†i (${doneCount}/${examData.attempts})!`);
                }

                // KI·ªÇM TRA TH·ªúI GIAN
                const now = new Date();
                if (examData.startTime && now < new Date(examData.startTime)) {
                    document.getElementById('lobbyTimeRange').classList.remove('hidden');
                    document.getElementById('lobbyTimeText').textContent = new Date(examData.startTime).toLocaleString('vi-VN');
                    throw new Error(`Ch∆∞a ƒë·∫øn gi·ªù l√†m b√†i!`);
                }
                if (examData.endTime && now > new Date(examData.endTime)) {
                    throw new Error(`ƒê√£ h·∫øt h·∫°n l√†m b√†i!`);
                }

                if (!examData.questions || examData.questions.length === 0) throw new Error("ƒê·ªÅ thi n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o!");

                // N·∫øu t·∫•t c·∫£ OK
                dom.btnStart.disabled = false;
                dom.btnStart.classList.replace('bg-gray-300', 'bg-blue-600');
                dom.btnStart.innerHTML = '<i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i';
                dom.btnStart.classList.add('shadow-lg', 'shadow-blue-200');
                document.getElementById('lobbyStatusBadge').textContent = 'S·∫µn s√†ng';
                document.getElementById('lobbyStatusBadge').className = 'font-bold text-green-600';

            } catch (err) {
                console.error(err);
                let msg = err.message;
                if (err.message.includes("indexes")) msg = "L·ªói h·ªá th·ªëng: Thi·∫øu Index tr√™n Firebase. Vui l√≤ng b√°o gi√°o vi√™n b·∫•m F12 ƒë·ªÉ t·∫°o Index.";
                showError(msg);
            }
        }

        function showError(msg) {
            dom.errBox.classList.remove('hidden');
            dom.errTxt.textContent = msg;
            dom.btnStart.disabled = true;
            dom.btnStart.innerHTML = '<i class="fa-solid fa-ban"></i> Kh√¥ng th·ªÉ l√†m b√†i';
            dom.btnStart.classList.replace('bg-blue-600', 'bg-red-500');
            dom.btnStart.classList.remove('shadow-blue-200');
            document.getElementById('lobbyStatusBadge').textContent = 'Kh√¥ng ƒë·∫°t';
            document.getElementById('lobbyStatusBadge').className = 'font-bold text-red-500';
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN ---
        // G·∫Øn v√†o window ƒë·ªÉ HTML g·ªçi ƒë∆∞·ª£c
        window.startExam = () => {
            if (examData.password) {
                dom.passModal.classList.remove('hidden');
                setTimeout(() => { dom.passModal.classList.remove('opacity-0'); dom.passModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'); dom.passInput.focus(); }, 10);
            } else {
                initExam();
            }
        };

        window.closePasswordModal = () => {
             dom.passModal.classList.add('opacity-0'); dom.passModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
             setTimeout(() => { dom.passModal.classList.add('hidden'); dom.passInput.value = ''; }, 200);
        }

        window.verifyPassword = () => {
            if (dom.passInput.value === examData.password) {
                closePasswordModal();
                initExam();
            } else {
                alert("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!");
                dom.passInput.select();
            }
        };
        
        dom.passInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') window.verifyPassword(); });

        window.initExam = () => {
            dom.lobby.classList.add('hidden');
            dom.header.classList.remove('hidden');
            dom.main.classList.remove('hidden');
            
            questions = [...(examData.questions || [])];
            if(examData.shuffle) questions.sort(() => Math.random() - 0.5);

            renderPalette();
            renderQuestion(0);

            timeLeft = (examData.duration || 45) * 60;
            if (timeLeft > 0) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const m = Math.floor(timeLeft / 60);
                    const s = timeLeft % 60;
                    dom.timer.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                    if (timeLeft <= 300) dom.timer.parentElement.classList.add('bg-red-50', 'border-red-100', 'text-red-600');
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        confirmFinishExam(true);
                    }
                }, 1000);
            } else {
                dom.timer.textContent = "‚àû";
            }
            
            isActive = true;
            if (examData.proctoring) {
                document.getElementById('cheatWarning').classList.remove('hidden');
                window.addEventListener('blur', () => {
                    if(isActive) {
                        cheatCount++;
                        document.getElementById('cheatCount').textContent = cheatCount;
                    }
                });
            }
        };

        window.renderQuestion = (idx) => {
            currentIdx = idx;
            const q = questions[idx];
            document.getElementById('currentQNum').textContent = idx + 1;
            
            const typeNames = {'mc': 'Tr·∫Øc nghi·ªám', 'tf': 'ƒê√∫ng/Sai', 'short': 'Tr·∫£ l·ªùi ng·∫Øn', 'essay': 'T·ª± lu·∫≠n'};
            dom.badge.textContent = typeNames[q.type] || 'C√¢u h·ªèi';
            dom.badge.className = `inline-block px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider mb-1 ${q.type === 'essay' ? 'bg-purple-100 text-purple-700' : (q.type === 'tf' ? 'bg-orange-100 text-orange-700' : (q.type === 'short' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'))}`;

            dom.content.innerHTML = q.content.replace(/\n/g, '<br>');
            dom.options.innerHTML = '';

            const fb = document.getElementById('flagBtn');
            fb.className = flagged[idx] ? "text-red-500 text-2xl transition-colors p-2 tooltip-left" : "text-gray-300 hover:text-red-500 text-2xl transition-colors p-2 tooltip-left";
            fb.innerHTML = flagged[idx] ? '<i class="fa-solid fa-flag"></i>' : '<i class="fa-regular fa-flag"></i>';

            if (q.type === 'mc') {
                q.options.forEach((opt, i) => {
                    const checked = answers[idx] === i;
                    const div = document.createElement('label');
                    div.className = "block cursor-pointer group w-full";
                    div.innerHTML = `
                        <input type="radio" name="q" class="hidden custom-radio" ${checked?'checked':''}>
                        <div class="flex items-start p-4 border-2 border-gray-100 rounded-xl transition-all hover:border-blue-300 group-hover:bg-blue-50 group-hover:shadow-sm h-full">
                            <div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400 transition-colors shrink-0 mt-0.5">${String.fromCharCode(65+i)}</div>
                            <div class="flex-1 font-medium text-gray-700 leading-relaxed overflow-x-auto">${opt}</div>
                        </div>`;
                    div.querySelector('input').onchange = () => { answers[idx] = i; updatePalette(); };
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 q.statements.forEach((stmt, i) => {
                    // answers[idx] s·∫Ω l√† object {0: true, 1: false...}
                    const val = answers[idx] ? answers[idx][i] : null;
                    const div = document.createElement('div');
                    div.className = "bg-white border-2 border-gray-100 rounded-xl p-4 hover:border-orange-200 transition-all";
                    div.innerHTML = `
                        <div class="font-medium text-gray-800 mb-3 leading-relaxed">${stmt.text}</div>
                        <div class="flex gap-4">
                            <label class="flex-1 cursor-pointer group"><input type="radio" name="tf-${idx}-${i}" class="hidden custom-radio" value="true" ${val===true?'checked':''}><div class="py-2 px-4 border-2 border-gray-200 rounded-lg text-center font-bold text-gray-500 transition-all group-hover:border-green-400 group-hover:text-green-600 flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> ƒê√∫ng</div></label>
                            <label class="flex-1 cursor-pointer group"><input type="radio" name="tf-${idx}-${i}" class="hidden custom-radio" value="false" ${val===false?'checked':''}><div class="py-2 px-4 border-2 border-gray-200 rounded-lg text-center font-bold text-gray-500 transition-all group-hover:border-red-400 group-hover:text-red-600 flex items-center justify-center gap-2"><i class="fa-solid fa-xmark"></i> Sai</div></label>
                        </div>`;
                    
                    div.querySelectorAll('input').forEach(inp => inp.onchange = (e) => {
                        if(!answers[idx]) answers[idx] = {};
                        answers[idx][i] = (e.target.value === 'true');
                        updatePalette();
                    });
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'short') {
                const inp = document.createElement('input');
                inp.type = "text";
                inp.className = "w-full p-4 border-2 border-gray-200 rounded-xl font-bold text-lg outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100 transition-all text-gray-700";
                inp.placeholder = "Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n ·ªü ƒë√¢y...";
                inp.value = answers[idx] || '';
                inp.onchange = (e) => { answers[idx] = e.target.value; updatePalette(); };
                dom.options.appendChild(inp);
            } else if (q.type === 'essay') {
                const ta = document.createElement('textarea');
                ta.className = "w-full p-4 border-2 border-gray-200 rounded-xl font-medium text-base outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-100 transition-all text-gray-700 min-h-[200px] resize-y";
                ta.placeholder = "Nh·∫≠p b√†i l√†m t·ª± lu·∫≠n c·ªßa b·∫°n ·ªü ƒë√¢y...";
                ta.value = answers[idx] || '';
                ta.onchange = (e) => { answers[idx] = e.target.value; updatePalette(); };
                dom.options.appendChild(ta);
            }

            if (window.MathJax) {
                MathJax.typesetPromise([dom.content, dom.options]).then(() => {
                     // Fix ·∫£nh sau khi MathJax ch·∫°y
                     dom.content.querySelectorAll('img').forEach(img => {
                        img.style.maxWidth = '100%'; img.style.height = 'auto';
                    });
                });
            }
            updatePalette();
            closeMobilePalette();
        };

        window.toggleFlag = () => {
            flagged[currentIdx] = !flagged[currentIdx];
            updatePalette();
            const fb = document.getElementById('flagBtn');
            fb.className = flagged[currentIdx] ? "text-red-500 text-2xl transition-colors p-2 tooltip-left" : "text-gray-300 hover:text-red-500 text-2xl transition-colors p-2 tooltip-left";
            fb.innerHTML = flagged[currentIdx] ? '<i class="fa-solid fa-flag"></i>' : '<i class="fa-regular fa-flag"></i>';
        };

        function updatePalette() {
            dom.palette.innerHTML = '';
            questions.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = "q-btn";
                if (i === currentIdx) btn.classList.add('active');
                else if (flagged[i]) btn.classList.add('flagged');
                else {
                    const ans = answers[i];
                    // Logic check answered ph·ª©c t·∫°p h∆°n v√¨ c√≥ TF
                    let hasAns = false;
                    if (ans !== undefined && ans !== null && ans !== "") {
                        if (typeof ans === 'object') {
                            // Cho TF: Ph·∫£i tr·∫£ l·ªùi √≠t nh·∫•t 1 √Ω m·ªõi t√≠nh l√† answered
                            if (Object.keys(ans).length > 0) hasAns = true;
                        } else {
                            hasAns = true;
                        }
                    }
                    if (hasAns) btn.classList.add('answered');
                }
                btn.onclick = () => renderQuestion(i);
                dom.palette.appendChild(btn);
            });
            
            document.getElementById('prevBtnMob').disabled = currentIdx === 0;
            document.getElementById('nextBtnMob').disabled = currentIdx === questions.length - 1;
            document.getElementById('prevBtnMob').classList.toggle('opacity-50', currentIdx === 0);
            document.getElementById('nextBtnMob').classList.toggle('opacity-50', currentIdx === questions.length - 1);
        }
        
        function renderPalette() { updatePalette(); }

        // --- MOBILE SIDEBAR FUNCTIONS ---
        window.openMobilePalette = () => {
            dom.sidebar.classList.remove('translate-x-full');
            dom.backdrop.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            document.body.classList.add('overflow-hidden'); 
        }

        window.closeMobilePalette = () => {
            dom.sidebar.classList.add('translate-x-full');
            dom.backdrop.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => dom.backdrop.classList.add('hidden'), 300);
             document.body.classList.remove('overflow-hidden');
        }

        window.finishExam = (auto = false) => {
            if(auto) { confirmFinishExam(true); return; }
            let unanswered = 0;
            questions.forEach((q, i) => {
                 const ans = answers[i];
                 let hasAns = false;
                 if (ans !== undefined && ans !== null && ans !== "") {
                    if (typeof ans === 'object') { if (Object.keys(ans).length > 0) hasAns = true; } 
                    else { hasAns = true; }
                 }
                 if(!hasAns) unanswered++;
            });
            dom.unansweredCnt.textContent = unanswered;
            dom.confirmModal.classList.remove('hidden');
            setTimeout(() => { dom.confirmModal.classList.remove('opacity-0'); dom.confirmModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'); }, 10);
        }

        window.closeConfirmSubmitModal = () => {
            dom.confirmModal.classList.add('opacity-0'); dom.confirmModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => dom.confirmModal.classList.add('hidden'), 200);
        }

        window.confirmFinishExam = async (auto = false) => {
            if (!auto) closeConfirmSubmitModal();
            isActive = false;
            clearInterval(timerInterval);
            
            // Disable UI
            dom.header.classList.add('pointer-events-none', 'opacity-50');
            dom.main.classList.add('pointer-events-none', 'opacity-50');
            
            // T√≠nh ƒëi·ªÉm s∆° b·ªô
            let correct = 0;
            questions.forEach((q, i) => {
                const ans = answers[i];
                if (q.type === 'mc' && ans === q.correct) correct++;
                if (q.type === 'short' && q.answer && ans && ans.trim().toLowerCase() === q.answer.trim().toLowerCase()) correct++;
                if (q.type === 'tf' && ans && q.statements) {
                    let allCorrect = true;
                    // Check t·ª´ng √Ω, n·∫øu √Ω n√†o sai ho·∫∑c ch∆∞a ch·ªçn th√¨ false
                    q.statements.forEach((s, si) => { if(s.isTrue !== ans[si]) allCorrect = false; });
                    // Ph·∫£i tr·∫£ l·ªùi ƒë·ªß c√°c √Ω m·ªõi t√≠nh
                    if(allCorrect && Object.keys(ans).length === q.statements.length) correct++;
                }
            });
            const score = (correct * (10 / questions.length)).toFixed(2);

            try {
                await addDoc(collection(db, "results"), {
                    examId: examId, 
                    studentId: currentUser.uid, 
                    studentName: currentUser.displayName,
                    score: parseFloat(score), 
                    answers: answers, 
                    cheatCount: cheatCount,
                    correctCount: correct, 
                    totalQuestions: questions.length,
                    submittedAt: new Date().toISOString()
                });
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                document.getElementById('scoreDisplay').textContent = score;
                document.getElementById('correctCount').textContent = `${correct}/${questions.length}`;
                
                if (examData.showScore === 'immediate' || (examData.showScore === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('scoreSection').classList.remove('hidden');
                } else {
                    document.getElementById('resultMsg').textContent = "B√†i l√†m ƒë√£ ƒë∆∞·ª£c l∆∞u. ƒêi·ªÉm s·ªë s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë sau.";
                }

                document.getElementById('resultModal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('resultModal').classList.remove('opacity-0'); document.getElementById('resultModalContent').classList.add('scale-100'); }, 10);

            } catch (e) {
                console.error(e);
                alert("L·ªói l∆∞u k·∫øt qu·∫£: " + e.message + "\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c b√°o gi√°o vi√™n.");
                dom.header.classList.remove('pointer-events-none', 'opacity-50');
                dom.main.classList.remove('pointer-events-none', 'opacity-50');
            }
        };
        
        // Navigation Events
        document.getElementById('prevBtnMob').onclick = () => { if(currentIdx > 0) renderQuestion(currentIdx - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIdx < questions.length - 1) renderQuestion(currentIdx + 1); };
    </script>
</body>
</html>
