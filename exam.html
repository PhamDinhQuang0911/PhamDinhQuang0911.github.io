<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m b√†i thi - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* Question & Palette Styles */
        .q-btn.active { background-color: #FF6A00; color: white; border-color: #FF6A00; }
        .q-btn.answered { background-color: #E0F2FE; color: #0284C7; border-color: #38BDF8; }
        .q-btn.flagged { border-color: #EF4444; color: #EF4444; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 text-center animate-fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-sm">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            
            <h1 id="lobbyTitle" class="text-2xl font-extrabold text-gray-800 mb-2">ƒêang t·∫£i th√¥ng tin...</h1>
            <p class="text-gray-500 text-sm mb-6 flex items-center justify-center gap-2">
                <i class="fa-regular fa-clock"></i> Th·ªùi gian: <span id="lobbyDuration" class="font-bold">--</span> ph√∫t
            </p>

            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between">
                    <span class="text-gray-500">Tr·∫°ng th√°i:</span>
                    <span id="lobbyStatusBadge" class="font-bold text-gray-700">ƒêang ki·ªÉm tra...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">S·ªë l∆∞·ª£t ƒë√£ l√†m:</span>
                    <span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span>
                </div>
                <div class="flex justify-between hidden" id="lobbyTimeRange">
                    <span class="text-gray-500">M·ªü ƒë·ªÅ:</span>
                    <span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span>
                </div>
            </div>

            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all shadow-md flex items-center justify-center gap-2 cursor-not-allowed">
                <i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i
            </button>
            <button onclick="window.history.back()" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Quay l·∫°i</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 lg:px-8 hidden">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center font-bold">
                <i class="fa-solid fa-pen-nib"></i>
            </div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[150px] md:max-w-xs">To√°n th·∫ßy Choang</h1>
                <p class="text-[10px] md:text-xs text-gray-500">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>

        <div class="flex items-center gap-3 md:gap-6">
            <div id="cheatWarning" class="hidden flex items-center gap-1 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse">
                <i class="fa-solid fa-triangle-exclamation"></i> <span id="cheatCount">0</span> vi ph·∫°m
            </div>

            <div class="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg">
                <i class="fa-regular fa-clock text-orange-400 animate-pulse"></i>
                <span id="timer" class="font-mono font-bold text-lg md:text-xl tracking-widest">00:00</span>
            </div>
            <button onclick="finishExam()" class="hidden md:block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md shadow-blue-200">
                N·ªôp b√†i
            </button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden">
        
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar relative" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 min-h-full p-6 md:p-10 relative">
                
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">TR·∫ÆC NGHI·ªÜM</span>
                        <h2 class="text-lg font-bold text-gray-400">C√¢u h·ªèi <span id="currentQNum">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-yellow-400 transition-colors" title="ƒê√°nh d·∫•u xem l·∫°i">
                        <i class="fa-solid fa-flag text-xl"></i>
                    </button>
                </div>

                <div id="questionContent" class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed mb-8">
                    </div>

                <div id="answerOptions" class="space-y-3">
                    </div>

                <div class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex justify-between z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <button id="prevBtnMob" class="px-4 py-2 bg-gray-100 rounded-lg font-bold text-gray-600 text-sm">Tr∆∞·ªõc</button>
                    <button onclick="window.togglePaletteMobile()" class="px-2 py-2 text-gray-400"><i class="fa-solid fa-list"></i></button>
                    <button id="nextBtnMob" class="px-4 py-2 bg-orange-custom text-white rounded-lg font-bold text-sm shadow-md shadow-orange-200">C√¢u sau</button>
                </div>
            </div>
        </div>

        <aside id="paletteSidebar" class="w-80 bg-white border-l border-gray-200 hidden md:flex flex-col z-10">
            <div class="p-5 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-700">Danh s√°ch c√¢u h·ªèi</h3>
                <div class="flex gap-4 mt-2 text-xs text-gray-500">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded-sm"></span> ƒêang l√†m</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-300 rounded-sm"></span> ƒê√£ l√†m</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 border border-red-400 text-red-500 rounded-sm flex items-center justify-center text-[8px]"><i class="fa-solid fa-flag"></i></span> C·ªù</div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5">
                <div class="grid grid-cols-5 gap-3" id="questionPalette">
                    </div>
            </div>

            <div class="p-5 border-t border-gray-200">
                <button onclick="finishExam()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-200 transition-all transform hover:-translate-y-1">
                    N·ªôp b√†i thi
                </button>
            </div>
        </aside>

        <div class="hidden md:flex fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-2xl border border-gray-100 gap-4 items-center z-40">
            <button id="prevBtn" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span class="text-sm font-bold text-gray-500"><span id="navCurrent">1</span> / <span id="navTotal">--</span></span>
            <button id="nextBtn" class="w-10 h-10 rounded-full bg-orange-custom hover:bg-orange-600 text-white flex items-center justify-center shadow-md shadow-orange-200 transition-colors">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </main>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÅ thi</h3>
            <p class="text-xs text-gray-500 mb-4">Gi√°o vi√™n y√™u c·∫ßu m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p.</p>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-2 border rounded-lg mb-4 outline-none focus:border-blue-500" placeholder="M·∫≠t kh·∫©u...">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm">H·ªßy</button>
                <button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm shadow-lg">V√†o thi</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üèÜ</div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6" id="resultMsg">B√†i l√†m ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.</p>
            
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-8 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">S·ªë c√¢u ƒë√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            
            <button onclick="window.location.href='dashboard.html'" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">
                <i class="fa-solid fa-house mr-2"></i> V·ªÅ S·∫£nh ch√≠nh
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let currentUser = null;
        let examData = null;
        let examId = null;
        let currentQuestions = [];
        let userAnswers = {}; 
        let flaggedQuestions = {};
        let currentIndex = 0;
        let timerInterval;
        let timeLeft = 0;
        let cheatCount = 0;
        let isExamActive = false;

        // UI Refs
        const dom = {
            lobby: document.getElementById('lobbyScreen'),
            lobbyTitle: document.getElementById('lobbyTitle'),
            lobbyDuration: document.getElementById('lobbyDuration'),
            lobbyStatus: document.getElementById('lobbyStatusBadge'),
            lobbyAttempts: document.getElementById('lobbyAttempts'),
            lobbyMax: document.getElementById('lobbyMaxAttempts'),
            btnStart: document.getElementById('btnStartExam'),
            
            header: document.getElementById('examHeader'),
            main: document.getElementById('examMain'),
            timer: document.getElementById('timer'),
            
            content: document.getElementById('questionContent'),
            options: document.getElementById('answerOptions'),
            palette: document.getElementById('questionPalette'),
            
            resultModal: document.getElementById('resultModal'),
            scoreSec: document.getElementById('scoreSection'),
            score: document.getElementById('scoreDisplay'),
            correct: document.getElementById('correctCount'),
            total: document.getElementById('totalCount')
        };

        // 1. INIT
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                examId = urlParams.get('id');
                if (!examId) window.location.href = 'dashboard.html';
                
                dom.header.querySelector('#examIdDisplay').textContent = examId;
                await loadExamLobby(examId);
            } else {
                window.location.href = 'index.html';
            }
        });

        // 2. LOAD LOBBY
        async function loadExamLobby(id) {
            try {
                // Fetch Exam
                const examSnap = await getDoc(doc(db, "exams", id));
                if (!examSnap.exists()) { alert("ƒê·ªÅ thi kh√¥ng t·ªìn t·∫°i!"); window.location.href = 'dashboard.html'; return; }
                examData = examSnap.data();

                // Fetch Attempts
                const q = query(collection(db, "results"), where("examId", "==", id), where("studentId", "==", currentUser.uid));
                const attemptSnap = await getDocs(q);
                const attemptsDone = attemptSnap.size;

                // UI Update
                dom.lobbyTitle.textContent = examData.title;
                dom.lobbyDuration.textContent = examData.duration || 'Kh√¥ng gi·ªõi h·∫°n';
                dom.lobbyAttempts.textContent = attemptsDone;
                dom.lobbyMax.textContent = (examData.attempts && examData.attempts > 0) ? examData.attempts : "‚àû";

                // Check Conditions
                const now = new Date();
                let canStart = true;
                let statusMsg = "S·∫µn s√†ng";
                let statusColor = "text-green-600";

                // Check Time
                if (examData.startTime && now < new Date(examData.startTime)) {
                    canStart = false; statusMsg = "Ch∆∞a ƒë·∫øn gi·ªù thi"; statusColor = "text-orange-500";
                    document.getElementById('lobbyTimeText').textContent = new Date(examData.startTime).toLocaleString('vi-VN');
                    document.getElementById('lobbyTimeRange').classList.remove('hidden');
                }
                if (examData.endTime && now > new Date(examData.endTime)) {
                    canStart = false; statusMsg = "ƒê√£ h·∫øt h·∫°n l√†m b√†i"; statusColor = "text-red-500";
                }
                
                // Check Attempts
                if (examData.attempts && examData.attempts > 0 && attemptsDone >= examData.attempts) {
                    canStart = false; statusMsg = "H·∫øt l∆∞·ª£t l√†m b√†i"; statusColor = "text-red-500";
                }

                dom.lobbyStatus.textContent = statusMsg;
                dom.lobbyStatus.className = `font-bold ${statusColor}`;

                if (canStart) {
                    dom.btnStart.disabled = false;
                    dom.btnStart.classList.remove('bg-gray-300', 'cursor-not-allowed');
                    dom.btnStart.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-blue-300');
                }

            } catch (e) { console.error(e); alert("L·ªói t·∫£i d·ªØ li·ªáu!"); }
        }

        // 3. START FLOW
        window.requestStart = () => {
            if (examData.password) {
                document.getElementById('passwordModal').classList.remove('hidden');
            } else {
                startExam();
            }
        };

        window.verifyPassword = () => {
            const input = document.getElementById('examPasswordInput').value;
            if (input === examData.password) {
                document.getElementById('passwordModal').classList.add('hidden');
                startExam();
            } else {
                alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
            }
        };

        function startExam() {
            // Hide Lobby, Show Exam
            dom.lobby.classList.add('hidden');
            dom.header.classList.remove('hidden');
            dom.main.classList.remove('hidden');
            
            // Prepare Data (Shuffle)
            currentQuestions = [...(examData.questions || [])];
            
            if (examData.shuffle) {
                // Shuffle questions
                for (let i = currentQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentQuestions[i], currentQuestions[j]] = [currentQuestions[j], currentQuestions[i]];
                }
                // Shuffle options (Logic ph·ª©c t·∫°p h∆°n v√¨ c·∫ßn map l·∫°i correct index, t·∫°m th·ªùi ch·ªâ shuffle c√¢u h·ªèi)
                currentQuestions.forEach(q => {
                     if (q.type === 'mc' && q.options) {
                         // Simple shuffle options logic could go here, 
                         // but requires re-mapping 'correct' index. 
                         // For safety in this demo, we keep options order or implement mapping if needed.
                         // Let's implement option shuffle:
                         const ops = q.options.map((txt, idx) => ({txt, originalIdx: idx}));
                         for (let i = ops.length - 1; i > 0; i--) {
                             const j = Math.floor(Math.random() * (i + 1));
                             [ops[i], ops[j]] = [ops[j], ops[i]];
                         }
                         q.options = ops.map(o => o.txt);
                         // Find new correct index
                         const newCorrect = ops.findIndex(o => o.originalIdx === q.correct);
                         q.correct = newCorrect;
                     }
                });
            }

            // Init Timer
            timeLeft = (examData.duration || 45) * 60;
            if (timeLeft > 0) runTimer();
            else dom.timer.textContent = "‚àû";

            // Init Proctoring
            if (examData.proctoring) {
                document.addEventListener("visibilitychange", handleVisibilityChange);
                document.getElementById('cheatWarning').classList.remove('hidden');
            }

            dom.navTotal.textContent = currentQuestions.length;
            renderPalette();
            renderQuestion(0);
            isExamActive = true;
            
            // Fullscreen suggest
            try { document.documentElement.requestFullscreen().catch(e=>{}); } catch(e){}
        }

        // 4. TIMER & PROCTORING
        function runTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishExam(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            dom.timer.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            if(timeLeft < 300) dom.timer.classList.add('text-red-500');
        }

        function handleVisibilityChange() {
            if (document.hidden && isExamActive) {
                cheatCount++;
                document.getElementById('cheatCount').textContent = cheatCount;
                alert(`C·∫¢NH B√ÅO: B·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh thi! Vi ph·∫°m l·∫ßn ${cheatCount}.`);
            }
        }

        // 5. RENDER ENGINE (QUESTION)
        function renderQuestion(index) {
            currentIndex = index;
            const q = currentQuestions[index];
            
            document.getElementById('currentQNum').textContent = index + 1;
            document.getElementById('navCurrent').textContent = index + 1;
            
            // Flag Icon state
            const flagBtn = document.getElementById('flagBtn');
            flagBtn.className = flaggedQuestions[index] ? "text-yellow-400" : "text-gray-300 hover:text-yellow-400";
            flagBtn.innerHTML = flaggedQuestions[index] ? '<i class="fa-solid fa-flag text-xl"></i>' : '<i class="fa-regular fa-flag text-xl"></i>';

            // Content
            let contentHtml = q.content.replace(/\n/g, '<br>');
            dom.content.innerHTML = contentHtml;
            dom.options.innerHTML = '';
            
            const badge = document.getElementById('questionTypeBadge');
            const typeNames = { mc: 'TR·∫ÆC NGHI·ªÜM', tf: 'ƒê√öNG / SAI', short: 'TR·∫¢ L·ªúI NG·∫ÆN', essay: 'T·ª∞ LU·∫¨N' };
            badge.textContent = typeNames[q.type] || 'C√ÇU H·ªéI';

            // Render Inputs
            if (q.type === 'mc') {
                q.options.forEach((opt, i) => {
                    const isChecked = userAnswers[index] === i;
                    const div = document.createElement('label');
                    div.className = "block cursor-pointer group";
                    div.innerHTML = `
                        <input type="radio" name="q-${index}" class="hidden custom-radio" value="${i}" ${isChecked ? 'checked' : ''}>
                        <div class="flex items-center p-4 border-2 border-gray-100 rounded-xl transition-all hover:border-blue-200 group-hover:bg-blue-50">
                            <div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400 transition-colors">${String.fromCharCode(65 + i)}</div>
                            <div class="flex-1 font-medium text-gray-700">${opt}</div>
                        </div>`;
                    div.querySelector('input').addEventListener('change', () => saveAnswer(index, i));
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 const table = document.createElement('div');
                 table.className = "w-full border border-gray-200 rounded-xl overflow-hidden";
                 let html = `<div class="grid grid-cols-12 bg-gray-50 p-3 border-b text-xs font-bold text-gray-500 uppercase"><div class="col-span-8">M·ªánh ƒë·ªÅ</div><div class="col-span-2 text-center text-green-600">ƒê√∫ng</div><div class="col-span-2 text-center text-red-500">Sai</div></div>`;
                 q.statements.forEach((stmt, i) => {
                     const ans = userAnswers[index] || [];
                     html += `<div class="grid grid-cols-12 p-4 border-b items-center hover:bg-gray-50"><div class="col-span-8 font-medium text-gray-700">${stmt.text}</div>
                     <div class="col-span-2 text-center"><input type="radio" name="q-${index}-s-${i}" class="w-5 h-5 accent-green-600" onchange="window.saveTFAnswer(${index}, ${i}, true)" ${ans[i]===true?'checked':''}></div>
                     <div class="col-span-2 text-center"><input type="radio" name="q-${index}-s-${i}" class="w-5 h-5 accent-red-500" onchange="window.saveTFAnswer(${index}, ${i}, false)" ${ans[i]===false?'checked':''}></div></div>`;
                 });
                 table.innerHTML = html;
                 dom.options.appendChild(table);
            } else if (q.type === 'short' || q.type === 'essay') {
                const isEssay = q.type === 'essay';
                const input = document.createElement(isEssay ? 'textarea' : 'input');
                input.className = `w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none text-gray-700 ${isEssay ? 'min-h-[200px]' : 'text-lg font-bold'}`;
                if(!isEssay) input.type = 'text';
                input.placeholder = "Nh·∫≠p c√¢u tr·∫£ l·ªùi...";
                input.value = userAnswers[index] || '';
                input.addEventListener('change', (e) => saveAnswer(index, e.target.value));
                dom.options.appendChild(input);
            }

            if (window.MathJax) MathJax.typesetPromise([dom.content, dom.options]);
            updatePalette();
        }

        // 6. ANSWER LOGIC
        function saveAnswer(qIndex, val) { userAnswers[qIndex] = val; updatePalette(); }
        window.saveTFAnswer = (qIndex, sIndex, val) => {
            if (!userAnswers[qIndex]) userAnswers[qIndex] = [];
            userAnswers[qIndex][sIndex] = val;
            updatePalette();
        }
        window.toggleFlag = () => {
            flaggedQuestions[currentIndex] = !flaggedQuestions[currentIndex];
            renderQuestion(currentIndex);
        }

        function updatePalette() {
            const btns = dom.palette.querySelectorAll('button');
            btns.forEach((btn, i) => {
                btn.className = "w-10 h-10 rounded-lg text-sm font-bold border transition-all duration-200 q-btn";
                if (i === currentIndex) btn.classList.add('active', 'scale-110');
                else if (flaggedQuestions[i]) btn.classList.add('flagged', 'bg-white');
                else {
                    const ans = userAnswers[i];
                    const hasAns = (ans !== undefined && ans !== '' && ans !== null && (!Array.isArray(ans) || ans.some(x=>x!==null)));
                    if (hasAns) btn.classList.add('answered');
                    else btn.classList.add('bg-gray-50', 'text-gray-400');
                }
            });
        }

        function renderPalette() {
            dom.palette.innerHTML = '';
            currentQuestions.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.onclick = () => renderQuestion(i);
                dom.palette.appendChild(btn);
            });
            updatePalette();
        }

        // 7. SUBMIT & SCORING
        window.finishExam = async (auto = false) => {
            if (!auto && !confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) return;
            isExamActive = false;
            clearInterval(timerInterval);
            document.removeEventListener("visibilitychange", handleVisibilityChange);

            // Calculate Score (Client-side estimate)
            let score = 0;
            let correctCount = 0;
            let totalQ = currentQuestions.length;

            currentQuestions.forEach((q, i) => {
                const u = userAnswers[i];
                if (!u && u !== 0) return; 

                if (q.type === 'mc') {
                    if (u === q.correct) correctCount++;
                } else if (q.type === 'short') {
                    if (q.answer && u.trim().toLowerCase() === q.answer.trim().toLowerCase()) correctCount++;
                } else if (q.type === 'tf') {
                    if (Array.isArray(u) && q.statements) {
                        const allMatch = q.statements.every((s, idx) => s.isTrue === u[idx]);
                        if (allMatch) correctCount++;
                    }
                }
            });
            
            score = totalQ > 0 ? (correctCount * (10 / totalQ)).toFixed(2) : 0;

            // Save to Firebase
            try {
                await addDoc(collection(db, "results"), {
                    examId: examId,
                    studentId: currentUser.uid,
                    studentName: currentUser.displayName || currentUser.email,
                    score: parseFloat(score),
                    answers: userAnswers,
                    correctCount: correctCount,
                    totalCount: totalQ,
                    cheatCount: cheatCount,
                    submittedAt: new Date().toISOString()
                });
            } catch (e) { console.error("Save error", e); }

            // Show Result Logic based on Settings
            dom.resultModal.classList.remove('hidden');
            setTimeout(() => {
                 dom.resultModal.classList.remove('opacity-0');
                 document.getElementById('resultModalContent').classList.remove('scale-90');
                 document.getElementById('resultModalContent').classList.add('scale-100');
            }, 10);

            const showScoreSetting = examData.showScore || 'immediate';
            if (showScoreSetting === 'immediate' || (showScoreSetting === 'after_exam' && timeLeft <= 0)) {
                dom.scoreSec.classList.remove('hidden');
                dom.score.textContent = score;
                dom.correct.textContent = correctCount;
                dom.total.textContent = totalQ;
            } else {
                document.getElementById('resultMsg').textContent = "B√†i l√†m ƒë√£ ƒë∆∞·ª£c l∆∞u. ƒêi·ªÉm s·ªë s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë sau.";
            }
        }

        // Navigation
        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtn').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        document.getElementById('prevBtnMob').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        
        window.togglePaletteMobile = () => {
             const p = document.getElementById('paletteSidebar');
             p.classList.toggle('hidden');
             p.classList.toggle('fixed');
             p.classList.toggle('inset-0');
             p.classList.toggle('z-50');
             p.classList.toggle('w-full');
        }

    </script>
</body>
</html>
