<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Làm bài thi - Hệ thống trắc nghiệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#0F766E', 
                        accent: '#F97316',
                        'brand-dark': '#0D6E66'
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                macros: {
                    heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
                    hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
                    tich: "\\cdot",
                    deg: "^\\circ"
                }
            },
            svg: { fontCache: 'global' },
            startup: { typeset: false }
        };
    </script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8FAFC; user-select: none; }
        
        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Xử lý ảnh trong câu hỏi */
        .question-content img { 
            max-width: 100%; 
            height: auto; 
            border-radius: 8px; 
            margin-top: 4px; 
            margin-bottom: 4px;
            display: inline-block; /* Để xếp hàng nếu nhỏ */
            border: 1px solid #e2e8f0;
        }
        /* Class hỗ trợ xếp ảnh hàng ngang */
        .image-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 8px 0;
        }
        .image-grid img { margin: 0; }

        .math-tex { overflow-x: auto; overflow-y: hidden; }

        /* Animation */
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Nút câu hỏi */
        .q-btn { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 800; font-size: 0.9rem; border: 1px solid #E2E8F0; background-color: white; color: #64748B; transition: all 0.2s; position: relative; cursor: pointer; }
        .q-btn:hover { border-color: #0F766E; color: #0F766E; }
        .q-btn.active { background-color: #0F766E !important; color: white !important; border-color: #0F766E !important; box-shadow: 0 4px 6px -1px rgba(15, 118, 110, 0.3); transform: scale(1.05); }
        .q-btn.answered { background-color: #F0FDFA; color: #0F766E; border-color: #CCFBF1; }
        .q-btn.flagged::after { content: "\f024"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -4px; right: -4px; font-size: 10px; color: #EF4444; background: #FEF2F2; border-radius: 50%; padding: 2px; border: 1px solid #FECACA; }

        /* Custom Radio */
        .custom-radio:checked + div { border-color: #0F766E; background-color: #F0FDFA; }
        .custom-radio:checked + div .check-circle { background-color: #0F766E; border-color: #0F766E; color: white; }
        
        /* Mobile Sidebar */
        .mobile-sidebar { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: white; z-index: 50; transform: translateX(100%); transition: transform 0.3s ease-in-out; box-shadow: -5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .mobile-sidebar.open { transform: translateX(0); }
        .sidebar-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar-backdrop.show { opacity: 1; pointer-events: auto; }
        
        .solution-box { border-left: 4px solid #10B981; background-color: #F0FDF4; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="mobileBackdrop" class="sidebar-backdrop" onclick="closeAllSidebars()"></div>

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-[#F8FAFC] flex flex-col items-center justify-center p-4">
        <div class="max-w-lg w-full bg-white rounded-3xl shadow-xl border border-gray-200 p-8 text-center animate-fade-in relative overflow-hidden">
            <div class="w-20 h-20 bg-teal-50 text-brand rounded-2xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm border border-teal-100 transform rotate-3">
                <i class="fa-solid fa-book-open-reader"></i>
            </div>
            
            <h1 id="lobbyTitle" class="text-2xl md:text-3xl font-black text-gray-800 mb-2 leading-tight">Đang tải thông tin...</h1>
            <div id="accessDeniedMsg" class="hidden bg-red-50 text-red-600 p-3 rounded-lg border border-red-200 mb-4 text-sm font-bold animate-pulse"><i class="fa-solid fa-ban mr-2"></i> Bạn không có quyền làm đề này!</div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">Thời gian</p>
                    <p class="text-xl font-black text-gray-800"><span id="lobbyDuration">--</span> <span class="text-sm font-medium text-gray-500">phút</span></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">Số câu hỏi</p>
                    <p class="text-xl font-black text-gray-800"><span id="lobbyQCount">--</span> <span class="text-sm font-medium text-gray-500">câu</span></p>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl text-left text-sm text-blue-800 mb-6 border border-blue-100">
                <p class="font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-circle-info"></i> Lưu ý làm bài:</p>
                <ul class="list-disc pl-5 space-y-1 text-xs opacity-90">
                    <li>Đảm bảo kết nối mạng ổn định.</li>
                    <li>Không thoát trình duyệt khi đang làm bài.</li>
                    <li>Hệ thống sẽ tự động nộp bài khi hết giờ.</li>
                </ul>
            </div>
            
            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-4 bg-gray-200 text-gray-400 font-bold rounded-xl transition-all shadow-none flex items-center justify-center gap-2 cursor-not-allowed text-lg">
                <i class="fa-solid fa-spinner fa-spin hidden" id="lobbySpinner"></i> 
                <span>Đang chuẩn bị đề...</span>
            </button>
            
            <button onclick="window.location.href='dashboard.html'" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold underline decoration-dotted">Quay lại trang chủ</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white border-b border-gray-200 h-16 md:h-20 flex items-center justify-between px-4 md:px-8 shrink-0 z-20 hidden shadow-sm">
        <div class="flex items-center gap-4">
            <button onclick="window.history.back()" class="md:hidden text-gray-400 hover:text-gray-600"><i class="fa-solid fa-arrow-left text-xl"></i></button>
            <div id="headerLogoContainer" class="flex items-center gap-3">
                <div class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white font-bold shadow-sm">
                    <i class="fa-solid fa-graduation-cap"></i>
                </div>
                <span class="font-black text-xl text-brand tracking-tight hidden md:block">Thầy Choang</span>
            </div>
            <div class="h-8 w-px bg-gray-200 mx-2 hidden md:block"></div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[200px]">Bài thi</h1>
                <p class="text-[10px] md:text-xs text-gray-500 font-bold bg-gray-100 px-2 py-0.5 rounded-full w-fit mt-0.5">Mã: <span id="examIdDisplay">--</span></p>
            </div>
        </div>
        
        <div class="flex items-center gap-3 md:gap-6">
            <div class="flex flex-col items-end md:items-center bg-orange-50 text-orange-700 px-4 py-1.5 rounded-xl border border-orange-200">
                <div class="text-[10px] uppercase font-bold text-orange-400 leading-none mb-0.5">Thời gian còn lại</div>
                <div class="flex items-center gap-2">
                    <i class="fa-regular fa-clock animate-pulse"></i>
                    <span id="timerDisplay" class="font-mono font-black text-xl tracking-wide">00:00</span>
                </div>
            </div>
            <button onclick="submitExam()" class="hidden md:flex bg-brand hover:bg-teal-700 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-teal-100 transition-all items-center gap-2 transform active:scale-95">
                <i class="fa-solid fa-paper-plane"></i> Nộp bài
            </button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden relative hidden bg-[#F8FAFC]">
        <div class="w-full md:w-3/4 flex flex-col h-full relative">
            <div id="examContainer" class="flex-1 overflow-y-auto p-4 md:p-8 pb-24 scroll-smooth">
                <div id="questionsList" class="max-w-4xl mx-auto space-y-8"></div>
            </div>
        </div>

        <div class="hidden md:flex w-1/4 bg-white border-l border-gray-200 flex-col shadow-[-5px_0_15px_rgba(0,0,0,0.02)] z-10">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <span class="font-bold text-gray-700 text-sm uppercase">Danh sách câu hỏi</span>
                <span class="bg-gray-200 text-gray-600 text-xs font-bold px-2 py-1 rounded-md" id="navProgress">0/0</span>
            </div>
            <div class="flex-1 overflow-y-auto p-5 custom-scrollbar">
                <div id="questionNavGrid" class="grid grid-cols-5 gap-3"></div>
            </div>
            <div class="p-5 border-t border-gray-200 bg-gray-50">
                <div class="flex flex-wrap gap-4 text-xs text-gray-500 justify-center mb-4">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-brand rounded-sm"></span> Đang làm</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-teal-50 border border-teal-200 rounded-sm"></span> Đã làm</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-white border border-red-300 rounded-sm flex items-center justify-center relative"><span class="absolute w-1.5 h-1.5 bg-red-500 rounded-full"></span></span> Cờ</div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 grid grid-cols-4 gap-3 z-30 md:hidden shadow-[0_-4px_10px_rgba(0,0,0,0.05)] safe-area-bottom">
        <button id="prevBtnMob" class="py-3 bg-gray-100 rounded-xl text-gray-600 font-bold hover:bg-gray-200"><i class="fa-solid fa-chevron-left"></i></button>
        <button onclick="toggleMobilePalette('paletteSidebar')" class="py-3 bg-teal-50 text-brand rounded-xl font-bold border border-teal-100 relative">
            <i class="fa-solid fa-list-ol text-lg"></i>
            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden" id="navDot"></span>
        </button>
        <button id="nextBtnMob" class="py-3 bg-gray-100 rounded-xl text-gray-600 font-bold hover:bg-gray-200"><i class="fa-solid fa-chevron-right"></i></button>
        <button onclick="submitExam()" class="py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold rounded-xl text-xs uppercase shadow-md active:scale-95">NỘP BÀI</button>
    </div>

    <aside id="paletteSidebar" class="mobile-sidebar bg-white border-l border-gray-200">
        <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-800">Danh sách câu hỏi</h3>
            <button onclick="closeAllSidebars()" class="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-5">
            <div class="grid grid-cols-5 gap-3" id="mobilePaletteGrid"></div>
        </div>
    </aside>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentExam = null;
        let userAnswers = {};
        let flaggedQuestions = {};
        let timeRemaining = 0;
        let timerInterval = null;
        let examId = null;
        let currentIndex = 0;

        // --- 1. KIỂM TRA ĐĂNG NHẬP ---
        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            examId = urlParams.get('id');

            if (user) {
                // Đã đăng nhập -> Tải Logo & Load thông tin đề (Lobby)
                loadSiteLogo();
                if (examId) {
                    loadLobbyData(examId);
                } else {
                    alert("Không tìm thấy ID đề thi!");
                    window.location.href = "student.html";
                }
            } else {
                // Chưa đăng nhập -> Hiện Modal yêu cầu đăng ký (FIX LỖI NÚT ẨN)
                if (examId) sessionStorage.setItem('pendingExamUrl', window.location.href);
                
                const modalHtml = `
                    <div class="fixed inset-0 bg-gray-900/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center animate-bounce-in relative overflow-hidden">
                            <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm border border-orange-200">
                                <i class="fa-solid fa-user-lock"></i>
                            </div>
                            <h3 class="text-2xl font-black text-gray-800 mb-2">Yêu cầu tài khoản</h3>
                            <p class="text-gray-500 mb-6 text-sm">Em cần đăng nhập hoặc đăng ký để làm bài thi này và lưu kết quả vào hệ thống.</p>
                            
                            <div class="space-y-3">
                                <button onclick="window.location.href='index.html?mode=register'" class="w-full py-3.5 bg-[#0F766E] hover:bg-[#0D6E66] text-white font-bold rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 transform hover:scale-[1.02]">
                                    <i class="fa-solid fa-user-plus"></i> Đăng ký tài khoản ngay
                                </button>
                                
                                <button onclick="window.location.href='index.html'" class="w-full py-3.5 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all border border-gray-200">
                                    Đã có tài khoản? Đăng nhập
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
        });

        // --- 2. TẢI LOGO ---
        async function loadSiteLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    const logoUrl = docSnap.data().logo;
                    const container = document.getElementById('headerLogoContainer');
                    // Hiển thị logo đẹp hơn
                    container.innerHTML = `
                        <img src="${logoUrl}" class="h-10 w-10 object-contain rounded-lg bg-white shadow-sm border border-gray-100 p-0.5">
                        <span class="font-black text-xl text-brand tracking-tight hidden md:block">Thầy Choang</span>
                    `;
                }
            } catch (e) {}
        }

        // --- 3. TẢI THÔNG TIN ĐỀ (LOBBY) ---
        async function loadLobbyData(id) {
            try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (!docSnap.exists()) {
                    document.getElementById('lobbyTitle').innerText = "Đề thi không tồn tại!";
                    return;
                }

                currentExam = { id: docSnap.id, ...docSnap.data() };
                
                // Cập nhật thông tin vào Lobby
                document.getElementById('lobbyTitle').innerText = currentExam.title;
                document.getElementById('lobbyDuration').innerText = currentExam.duration || '--';
                document.getElementById('lobbyQCount').innerText = currentExam.questions ? currentExam.questions.length : 0;
                document.getElementById('examIdDisplay').innerText = currentExam.id.substring(0, 6).toUpperCase();

                // Kích hoạt nút Bắt đầu
                const btnStart = document.getElementById('btnStartExam');
                btnStart.disabled = false;
                btnStart.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
                btnStart.classList.add('bg-brand', 'text-white', 'hover:bg-teal-700', 'shadow-lg');
                btnStart.innerHTML = '<i class="fa-solid fa-play"></i> Bắt đầu làm bài';

            } catch (error) {
                console.error("Lỗi tải đề:", error);
                document.getElementById('lobbyTitle').innerText = "Lỗi tải dữ liệu!";
            }
        }

        // --- 4. BẮT ĐẦU LÀM BÀI ---
        window.requestStart = () => {
            // Ẩn Lobby, Hiện Main Exam
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('examHeader').classList.remove('hidden');
            document.getElementById('examHeader').classList.add('flex'); // Fix layout flex
            document.getElementById('examMain').classList.remove('hidden');
            
            // Render nội dung
            renderExamUI(currentExam);
            startTimer(currentExam.duration);
        };

        // --- 5. RENDER GIAO DIỆN BÀI THI ---
        function renderExamUI(exam) {
            document.title = exam.title;
            const listContainer = document.getElementById('questionsList');
            const navContainer = document.getElementById('questionNavGrid');
            const mobileNavContainer = document.getElementById('mobilePaletteGrid');
            
            listContainer.innerHTML = '';
            navContainer.innerHTML = '';
            mobileNavContainer.innerHTML = '';

            // Render câu hỏi
            if (exam.questions && Array.isArray(exam.questions)) {
                document.getElementById('navProgress').innerText = `0/${exam.questions.length}`;
                
                exam.questions.forEach((q, index) => {
                    // Tạo khối câu hỏi
                    const qDiv = document.createElement('div');
                    qDiv.id = `q-${index}`;
                    qDiv.className = "bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-200 mb-6 relative group transition-all hover:shadow-md";
                    
                    // Header câu hỏi
                    const headerHtml = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <span class="bg-gray-100 text-gray-600 font-black px-3 py-1.5 rounded-lg text-sm shadow-sm border border-gray-200">Câu ${index + 1}</span>
                                <span class="text-xs font-bold text-gray-400 uppercase bg-gray-50 px-2 py-1 rounded hidden md:inline-block">${q.type === 'mc' ? 'Trắc nghiệm' : (q.type==='tf'?'Đúng/Sai':'Điền đáp án')}</span>
                            </div>
                            <button onclick="toggleFlag(${index})" id="flag-btn-${index}" class="text-gray-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50" title="Đánh dấu xem lại">
                                <i class="fa-regular fa-flag text-xl"></i>
                            </button>
                        </div>
                    `;

                    // Nội dung câu hỏi (Xử lý ảnh thông minh ở đây)
                    const contentHtml = `<div class="text-lg text-gray-800 font-medium leading-relaxed math-content mb-6">${formatContent(q.content)}</div>`;

                    // Đáp án
                    let answersHtml = '';
                    if (q.type === 'mc') { // Trắc nghiệm
                        answersHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
                        ['A', 'B', 'C', 'D'].forEach(opt => {
                            const content = q[`option${opt}`];
                            if (content) {
                                answersHtml += `
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="q-${index}" value="${opt}" class="hidden custom-radio" onchange="selectAnswer(${index}, '${opt}')">
                                        <div class="flex items-start p-4 border-2 border-gray-100 rounded-xl hover:border-teal-200 group-hover:bg-teal-50/50 transition-all h-full">
                                            <div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-3 font-bold text-gray-400 shrink-0 mt-0.5 group-hover:border-teal-400 group-hover:text-teal-600 transition-all shadow-sm bg-white">${opt}</div>
                                            <div class="flex-1 text-gray-700 font-medium mt-1">${formatContent(content)}</div>
                                        </div>
                                    </label>
                                `;
                            }
                        });
                        answersHtml += '</div>';
                    } else if (q.type === 'short') { // Điền đáp án
                        answersHtml = `
                            <div class="relative">
                                <input type="text" class="w-full p-4 pl-12 border-2 border-gray-200 rounded-xl font-bold text-lg outline-none focus:border-brand focus:ring-4 focus:ring-teal-50 transition-all placeholder-gray-300" placeholder="Nhập đáp án của bạn..." onchange="selectAnswer(${index}, this.value)">
                                <i class="fa-solid fa-pen absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        `;
                    }

                    qDiv.innerHTML = headerHtml + contentHtml + answersHtml;
                    listContainer.appendChild(qDiv);

                    // Tạo nút điều hướng
                    const navBtn = document.createElement('button');
                    navBtn.id = `nav-${index}`;
                    navBtn.className = "q-btn";
                    navBtn.innerText = index + 1;
                    navBtn.onclick = () => {
                        document.getElementById(`q-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                        closeAllSidebars();
                    };
                    navContainer.appendChild(navBtn);
                    
                    // Clone cho mobile palette
                    const mobNavBtn = navBtn.cloneNode(true);
                    mobNavBtn.id = `mob-nav-${index}`;
                    mobNavBtn.onclick = () => {
                        document.getElementById(`q-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                        closeAllSidebars();
                    };
                    mobileNavContainer.appendChild(mobNavBtn);
                });

                // Render MathJax & TikZ
                if (window.MathJax) MathJax.typesetPromise();
                
                // Tinh chỉnh ảnh sau khi render
                setTimeout(optimizeImages, 500);
            }
        }

        // --- 6. XỬ LÝ ẢNH THÔNG MINH (GRID LAYOUT) ---
        function optimizeImages() {
            const contents = document.querySelectorAll('.math-content');
            contents.forEach(div => {
                const imgs = div.querySelectorAll('img');
                if (imgs.length > 1) {
                    // Nếu có nhiều ảnh gần nhau, nhóm chúng vào grid
                    // Logic đơn giản: Bọc tất cả ảnh vào div.image-grid
                    const parent = imgs[0].parentNode;
                    // Kiểm tra xem đã bọc chưa để tránh lặp
                    if (!parent.classList.contains('image-grid')) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'image-grid';
                        // Insert wrapper trước ảnh đầu tiên
                        imgs[0].parentNode.insertBefore(wrapper, imgs[0]);
                        // Di chuyển các ảnh vào wrapper
                        imgs.forEach(img => wrapper.appendChild(img));
                    }
                }
            });
        }

        // --- 7. UTILS & LOGIC ---
        window.formatContent = (text) => {
            if (!text) return "";
            // Xử lý xuống dòng
            let formatted = text.replace(/\n/g, '<br>');
            // Fix các lỗi LaTeX phổ biến
            formatted = formatted.replace(/\\lq\\lq/g, '"').replace(/\\rq\\rq/g, '"');
            return formatted;
        };

        window.selectAnswer = (index, value) => {
            userAnswers[index] = value;
            // Update UI nút
            const updateBtnStyle = (id) => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.classList.add('answered');
                    btn.classList.remove('active'); // Bỏ focus
                }
            };
            updateBtnStyle(`nav-${index}`);
            updateBtnStyle(`mob-nav-${index}`);
            
            // Cập nhật tiến độ
            const answeredCount = Object.keys(userAnswers).length;
            document.getElementById('navProgress').innerText = `${answeredCount}/${currentExam.questions.length}`;
        };

        window.toggleFlag = (index) => {
            flaggedQuestions[index] = !flaggedQuestions[index];
            const icon = document.querySelector(`#q-${index} #flag-btn-${index} i`);
            if (icon) {
                icon.className = flaggedQuestions[index] ? "fa-solid fa-flag text-red-500" : "fa-regular fa-flag";
            }
            // Update Nav
            const navBtn = document.getElementById(`nav-${index}`);
            const mobNavBtn = document.getElementById(`mob-nav-${index}`);
            if (flaggedQuestions[index]) {
                navBtn.classList.add('flagged');
                mobNavBtn.classList.add('flagged');
            } else {
                navBtn.classList.remove('flagged');
                mobNavBtn.classList.remove('flagged');
            }
        };

        // --- 8. TIMER & SUBMIT ---
        function startTimer(minutes) {
            timeRemaining = minutes * 60;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("Hết giờ làm bài! Hệ thống sẽ tự động nộp bài.");
                    submitExam(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const s = (timeRemaining % 60).toString().padStart(2, '0');
            const el = document.getElementById('timerDisplay');
            el.innerText = `${m}:${s}`;
            if (timeRemaining < 300) { // < 5 phút
                el.parentElement.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                el.parentElement.classList.remove('bg-orange-50', 'text-orange-700');
            }
        }

        window.submitExam = async (auto = false) => {
            if (!auto && !confirm("Bạn có chắc chắn muốn nộp bài không?")) return;
            
            clearInterval(timerInterval);
            
            // Tính điểm
            let correctCount = 0;
            const totalQ = currentExam.questions.length;
            
            currentExam.questions.forEach((q, idx) => {
                const u = userAnswers[idx];
                if (q.type === 'mc' && u === q.correct) correctCount++;
                if (q.type === 'short' && q.answer && u && u.trim().toLowerCase() === q.answer.trim().toLowerCase()) correctCount++;
            });
            
            const score = Math.round((correctCount / totalQ) * 10 * 100) / 100;

            try {
                // Lưu kết quả
                await addDoc(collection(db, "results"), {
                    examId: currentExam.id,
                    examTitle: currentExam.title,
                    studentId: auth.currentUser.uid,
                    studentName: auth.currentUser.displayName || "Học sinh",
                    score: score,
                    totalQuestions: totalQ,
                    correctAnswers: correctCount,
                    userAnswers: userAnswers,
                    submittedAt: new Date().toISOString()
                });
                
                alert(`Nộp bài thành công!\nĐiểm số: ${score}/10\nSố câu đúng: ${correctCount}/${totalQ}`);
                window.location.href = "student.html"; 
            } catch (e) {
                console.error(e);
                alert("Lỗi nộp bài: " + e.message);
            }
        };

        // UI Helpers
        window.toggleMobilePalette = (id) => {
            const sb = document.getElementById(id);
            const bd = document.getElementById('mobileBackdrop');
            if (sb.classList.contains('open')) {
                sb.classList.remove('open');
                bd.classList.remove('show');
            } else {
                sb.classList.add('open');
                bd.classList.add('show');
            }
        };
        
        window.closeAllSidebars = () => {
            document.getElementById('paletteSidebar').classList.remove('open');
            document.getElementById('mobileBackdrop').classList.remove('show');
        };

        // Navigation Mobile Buttons
        document.getElementById('prevBtnMob').onclick = () => {
            const prev = document.getElementById(`q-${currentIndex - 1}`);
            if(prev) { prev.scrollIntoView({block:'center'}); currentIndex--; }
        };
        document.getElementById('nextBtnMob').onclick = () => {
            const next = document.getElementById(`q-${currentIndex + 1}`);
            if(next) { next.scrollIntoView({block:'center'}); currentIndex++; }
        };

    </script>
</body>
</html>
