<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√†m b√†i thi - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    // --- C·∫§U H√åNH MATHJAX (ƒê·ªíNG B·ªò V·ªöI EDITOR) ---
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        macros: {
          heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
          hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ"
        }
      },
      svg: { fontCache: 'global' },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; overscroll-behavior-y: none; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* CSS SIDEBAR MOBILE */
        .mobile-sidebar {
            position: fixed; top: 0; right: 0; bottom: 0; width: 280px;
            background: white; z-index: 50;
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        .mobile-sidebar.open { transform: translateX(0); }
        .sidebar-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar-backdrop.show { opacity: 1; pointer-events: auto; }

        /* CSS N√öT C√ÇU H·ªéI */
        .q-btn { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 1px solid #E5E7EB; background-color: white; color: #4B5563; transition: all 0.2s; position: relative; cursor: pointer; }
        .q-btn.active { background-color: #FF6A00 !important; color: white !important; border-color: #FF6A00 !important; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(255, 106, 0, 0.3); z-index: 10; }
        .q-btn.answered { background-color: #EFF6FF; color: #2563EB; border-color: #BFDBFE; }
        .q-btn.flagged::after { content: "\f024"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -4px; right: -4px; font-size: 10px; color: #EF4444; background: #FEF2F2; border-radius: 50%; padding: 2px; border: 1px solid #FECACA; }
        
        .q-btn.correct { background-color: #10B981 !important; color: white !important; border-color: #059669 !important; }
        .q-btn.wrong { background-color: #EF4444 !important; color: white !important; border-color: #DC2626 !important; }
        .q-btn.partial { background-color: #F59E0B !important; color: white !important; border-color: #D97706 !important; }

        /* CSS ·∫¢NH & MATHJAX */
        #questionContent img, #answerOptions img, .solution-box img { max-width: 100% !important; height: auto !important; display: block; margin: 10px auto; border-radius: 8px; }
        mjx-container { display: inline-block !important; overflow: visible !important; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .pb-mobile-nav { padding-bottom: 80px; }
        .solution-box { border-left: 4px solid #10B981; background-color: #ECFDF5; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        /* --- CSS M·ªöI: H·ªó tr·ª£ hi·ªÉn th·ªã s·∫°ch --- */
        .origin-top-left { transform-origin: top left; }
        /* ·∫®n tri·ªát ƒë·ªÉ c√°c th√†nh ph·∫ßn editor l·ªçt sang */
        .image-placeholder, 
        .group.relative .absolute { display: none !important; }
        /* ·∫®n c√°c d√≤ng h∆∞·ªõng d·∫´n text nh·ªè */
        .text-\[10px\], .text-xs.font-bold.text-blue-700 { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <div id="mobileBackdrop" class="sidebar-backdrop" onclick="closeAllSidebars()"></div>

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 text-center animate-fade-in relative overflow-hidden overflow-y-auto max-h-full">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fa-solid fa-graduation-cap"></i></div>
            
            <h1 id="lobbyTitle" class="text-2xl font-extrabold text-gray-800 mb-2">ƒêang t·∫£i...</h1>
            <div id="accessDeniedMsg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 mb-4 text-sm font-bold animate-pulse text-left"><i class="fa-solid fa-ban mr-2"></i> B·∫°n kh√¥ng thu·ªôc l·ªõp ƒë∆∞·ª£c giao ƒë·ªÅ n√†y!</div>
            
            <div class="bg-blue-50 p-4 rounded-xl text-left text-sm text-blue-800 mb-4 space-y-2 border border-blue-100">
                <p class="font-bold border-b border-blue-200 pb-1"><i class="fa-solid fa-circle-info mr-2"></i>H∆∞·ªõng d·∫´n l√†m b√†i:</p>
                <ul class="list-disc pl-5 space-y-1 text-xs md:text-sm">
                    <li>C√¢u tr·∫£ l·ªùi ng·∫Øn ch·ªâ nh·∫≠p s·ªë ho·∫∑c ch·ªØ, kh√¥ng nh·∫≠p ƒë∆°n v·ªã.</li>
                    <li>S·ª≠ d·ª•ng gi·∫•y nh√°p ƒë·ªÉ t√≠nh to√°n c·∫©n th·∫≠n.</li>
                    <li>B·∫•m n√∫t (<i class="fa-regular fa-flag"></i>) ƒë·ªÉ ƒë√°nh d·∫•u c√¢u kh√≥ xem l·∫°i sau.</li>
                </ul>
            </div>

            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between"><span class="text-gray-500"><i class="fa-regular fa-clock mr-1"></i> Th·ªùi gian:</span><span class="font-bold text-gray-800"><span id="lobbyDuration">--</span> ph√∫t</span></div>
                <div class="flex justify-between"><span class="text-gray-500">S·ªë l∆∞·ª£t:</span><span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span></div>
                <div class="flex justify-between hidden" id="lobbyTimeRange"><span class="text-gray-500">M·ªü ƒë·ªÅ:</span><span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span></div>
                <div class="flex justify-between pt-2 border-t border-gray-200"><span class="text-gray-500">Tr·∫°ng th√°i:</span><span id="lobbyStatusBadge" class="font-bold text-gray-700">Checking...</span></div>
            </div>
            
            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all shadow-md flex items-center justify-center gap-2 cursor-not-allowed"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            <button onclick="window.location.href='dashboard.html'" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Quay l·∫°i Dashboard</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 lg:px-8 hidden">
        <div class="flex items-center gap-4">
            <button onclick="window.history.back()" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center font-bold"><i class="fa-solid fa-pen-nib"></i></div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[150px] md:max-w-xs">B√†i thi</h1>
                <p class="text-[10px] md:text-xs text-gray-500">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3 md:gap-6">
            <div id="cheatWarning" class="hidden flex items-center gap-1 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> <span id="cheatCount">0</span> vi ph·∫°m</div>
            
            <div class="bg-gradient-to-r from-red-600 to-orange-500 text-white px-4 py-2 rounded-lg shadow-lg border-2 border-white flex items-center gap-2 animate-pulse-slow">
                <i class="fa-regular fa-clock"></i>
                <span id="timer" class="font-mono font-extrabold text-lg md:text-xl tracking-widest">00:00</span>
            </div>
            
            <button onclick="checkFinish()" class="hidden md:block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md shadow-blue-200">N·ªôp b√†i</button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden relative">
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar relative pb-mobile-nav" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 min-h-full p-6 md:p-10 relative">
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">C√ÇU H·ªéI</span>
                        <h2 class="text-lg font-bold text-gray-400">C√¢u s·ªë <span id="currentQNum">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-red-500 transition-colors" title="ƒê√°nh d·∫•u"><i class="fa-regular fa-flag text-xl"></i></button>
                </div>
                <div id="questionContent" class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed mb-8"></div>
                <div id="answerOptions" class="space-y-3"></div>
            </div>
        </div>

        <aside id="paletteSidebar" class="mobile-sidebar bg-white border-l border-gray-200 md:relative md:transform-none md:w-80 md:flex md:z-10 md:shadow-none">
            <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-gray-700">Danh s√°ch c√¢u h·ªèi</h3>
                    <div class="flex flex-wrap gap-3 mt-3 text-xs text-gray-500">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded-sm"></span> ƒêang l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-200 rounded-sm"></span> ƒê√£ l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-white border border-red-200 rounded-sm flex items-center justify-center"><i class="fa-solid fa-flag text-[8px] text-red-500"></i></span> C·ªù</div>
                    </div>
                </div>
                <button onclick="closeAllSidebars()" class="md:hidden text-gray-400 hover:text-red-500 text-xl px-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 no-scrollbar">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
            <div class="p-5 border-t border-gray-200 hidden md:block">
                 <button onclick="checkFinish()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all">N·ªôp b√†i thi</button>
            </div>
        </aside>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 grid grid-cols-4 gap-2 z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom">
            <button id="prevBtnMob" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="toggleMobilePalette('paletteSidebar')" class="py-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100"><i class="fa-solid fa-list-ol"></i></button>
            <button id="nextBtnMob" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-chevron-right"></i></button>
            <button onclick="checkFinish()" class="py-2.5 bg-red-600 text-white font-bold rounded-lg text-xs uppercase flex items-center justify-center gap-1 shadow-md"><i class="fa-solid fa-paper-plane"></i> N·ªôp</button>
        </div>
        
        <div class="hidden md:flex fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-2xl border border-gray-100 gap-4 items-center z-40">
            <button id="prevBtn" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-sm font-bold text-gray-500"><span id="navCurrent">1</span> / <span id="navTotal">--</span></span>
            <button id="nextBtn" class="w-10 h-10 rounded-full bg-orange-custom hover:bg-orange-600 text-white flex items-center justify-center shadow-md shadow-orange-200 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </main>

    <div id="solutionView" class="hidden fixed inset-0 z-[90] bg-gray-50 flex h-full">
        <aside id="solutionSidebar" class="mobile-sidebar bg-white border-r border-gray-200 md:relative md:transform-none md:w-80 md:flex md:z-10">
            <div class="p-5 border-b border-gray-200 bg-white flex justify-between items-center shadow-sm">
                <h3 class="font-bold text-gray-700">K·∫øt qu·∫£ chi ti·∫øt</h3>
                <button onclick="closeAllSidebars()" class="md:hidden text-gray-400 hover:text-red-500 text-xl px-2"><i class="fa-solid fa-xmark"></i></button>
                <button onclick="window.location.href='dashboard.html'" class="hidden md:block text-xs font-bold text-gray-500 hover:text-blue-600">Tho√°t</button>
            </div>
            <div class="p-4 border-b border-gray-200 bg-white">
                 <h4 class="text-xs font-bold text-blue-600 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> L·ªãch s·ª≠ l√†m b√†i</h4>
                <div class="bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                    <table class="w-full text-[10px] text-left text-gray-600">
                        <thead class="bg-gray-100 text-gray-500 font-bold uppercase"><tr><th class="px-2 py-1.5">L·∫ßn</th><th class="px-2 py-1.5 text-center">ƒêi·ªÉm</th><th class="px-2 py-1.5 text-right">Ng√†y n·ªôp</th></tr></thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-3 border-b border-gray-100 bg-white text-xs flex gap-3 text-gray-500 justify-center">
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> ƒê√∫ng</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-sm"></span> Sai</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 rounded-sm"></span> 1 ph·∫ßn</div>
            </div>
            <div class="flex-1 overflow-y-auto p-5 no-scrollbar"><div class="grid grid-cols-5 gap-3" id="solutionPalette"></div></div>
        </aside>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth bg-gray-100 w-full pb-mobile-nav" id="solutionContentArea">
            <div class="md:hidden mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                 <h3 class="font-bold text-gray-800">K·∫øt qu·∫£ chi ti·∫øt</h3>
                 <button onclick="window.location.href='dashboard.html'" class="px-3 py-1.5 bg-gray-100 rounded text-xs font-bold">Tho√°t</button>
            </div>
            <div class="max-w-4xl mx-auto space-y-6 pb-20" id="solutionList"></div>
        </div>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 grid grid-cols-3 gap-2 z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom">
            <button onclick="window.location.href='dashboard.html'" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold text-sm">Tho√°t</button>
            <button onclick="toggleMobilePalette('solutionSidebar')" class="py-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100"><i class="fa-solid fa-list-ol"></i> DS</button>
            <button onclick="document.getElementById('solutionContentArea').scrollTo({top:0, behavior:'smooth'})" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-arrow-up"></i> L√™n</button>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Th√¥ng b√°o</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">N·ªôi dung...</p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">H·ªßy b·ªè</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÅ thi</h3>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="M·∫≠t kh·∫©u...">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm">H·ªßy</button><button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">V√†o thi</button></div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div id="resultIcon" class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üí™</div>
            <h2 class="text-2xl font-extrabold text-gray-800 mb-2" id="resultTitle">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6 text-sm" id="resultMsg">ƒê√£ n·ªôp b√†i th√†nh c√¥ng.</p>
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-6 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">ƒê√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            <div class="space-y-3">
                <button id="btnViewSolution" onclick="viewDetailSolutions()" class="w-full py-3 rounded-xl bg-orange-100 text-orange-600 font-bold hover:bg-orange-200 transition-colors hidden"><i class="fa-solid fa-eye mr-2"></i> Xem l·ªùi gi·∫£i chi ti·∫øt</button>
                <button onclick="window.location.href='dashboard.html'" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">V·ªÅ trang ch·ªß</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let currentUser, examData, examId;
        let currentQuestions = [], userAnswers = {}, flaggedQuestions = {};
        let currentIndex = 0, timerInterval, timeLeft = 0, cheatCount = 0, isExamActive = false;
        window.examHistory = [];
        
        const dom = { lobby: document.getElementById('lobbyScreen'), header: document.getElementById('examHeader'), main: document.getElementById('examMain'), content: document.getElementById('questionContent'), options: document.getElementById('answerOptions'), palette: document.getElementById('questionPalette'), timer: document.getElementById('timer'), badge: document.getElementById('questionTypeBadge') };
        
        // MODAL HELPERS
        let modalResolve = null;
        const modalEl = document.getElementById('customModal'), modalBox = document.getElementById('customModalBox'), modalTitle = document.getElementById('modalTitle'), modalMsg = document.getElementById('modalMessage'), btnConfirm = document.getElementById('btnConfirm'), btnCancel = document.getElementById('btnCancel');
        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if(modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (msg, type='info') => { return new Promise(resolve => { modalTitle.innerText=type==='error'?'L·ªói':'Th√¥ng b√°o'; modalMsg.innerText=msg; btnCancel.classList.add('hidden'); btnConfirm.innerText="ƒê√£ hi·ªÉu"; modalEl.classList.remove('opacity-0','pointer-events-none'); modalBox.classList.add('scale-100'); btnConfirm.onclick=()=>{resolve(true);closeCustomModal();}; }); };
        window.customConfirm = (msg) => { return new Promise(resolve => { modalTitle.innerText="X√°c nh·∫≠n"; modalMsg.innerText=msg; btnCancel.classList.remove('hidden'); btnConfirm.innerText="ƒê·ªìng √Ω"; modalEl.classList.remove('opacity-0','pointer-events-none'); modalBox.classList.add('scale-100'); btnConfirm.onclick=()=>{resolve(true);closeCustomModal();}; btnCancel.onclick=()=>{resolve(false);closeCustomModal();}; }); };

        // --- C√ÅC H√ÄM X·ª¨ L√ù N·ªòI DUNG ---
        function cleanTikzCode(code) { 
            let c = code.replace(/\\resizebox\{[^}]+\}\{[^}]+\}\{\s*(\\begin\{tikzpicture\}[\s\S]*?\\end\{tikzpicture\})\s*\}/g, "$1"); 
            return c.replace(/\\begin\{center\}/g, "").replace(/\\end\{center\}/g, ""); 
        }

        function processNestedTikz(text) {
            if (!text) return ""; 
            let res = "", rem = String(text);
            while (true) {
                const start = rem.indexOf("\\begin{tikzpicture}"); 
                if (start === -1) { res += rem; break; }
                res += rem.substring(0, start); rem = rem.substring(start);
                let d = 0, end = -1, pos = "\\begin{tikzpicture}".length; d = 1;
                while (d > 0) { 
                    const no = rem.indexOf("\\begin{tikzpicture}", pos);
                    const nc = rem.indexOf("\\end{tikzpicture}", pos); 
                    if (nc === -1) { end = rem.length; d = 0; break; } 
                    if (no !== -1 && no < nc) { d++; pos = no + 19; } 
                    else { d--; pos = nc + 17; if (d === 0) end = pos; } 
                }
                let raw = rem.substring(0, end);
                let final = cleanTikzCode(raw); 
                if (!final.includes("\\usetikzlibrary")) final = "\\usetikzlibrary{calc,intersections,arrows.meta}\n" + final;
                res += `<div class="flex justify-center my-4 overflow-x-auto"><script type="text/tikz">${final}<\/script></div>`; 
                rem = rem.substring(end);
            }
            return res;
        }
        // 1. H√†m x·ª≠ l√Ω b·∫£ng bi·ªÉu (Gi·ªëng h·ªát Editor: h·ªó tr·ª£ Scale)
        // 1. H√†m x·ª≠ l√Ω b·∫£ng bi·ªÉu (T·ª± ƒë·ªông Scale)
        function processTabular(text) {
            if (!text) return "";
            // Lo·∫°i b·ªè m√¥i tr∆∞·ªùng table bao ngo√†i
            let processed = text.replace(/\\begin\{table\}(\[.*?\])?/g, '').replace(/\\end\{table\}/g, '');
            const regex = /\\begin\{tabular\}(\{|\[).*?(\}|\])([\s\S]*?)\\end\{tabular\}/g;
            return processed.replace(regex, (match, open, close, body) => {
                const rows = body.split('\\\\').filter(r => r.trim().length > 0);
                let html = '<div class="my-3 w-full js-scale-wrapper" style="position: relative; width: 100%;">';
                html += '<table class="js-scale-table border-collapse border border-gray-300 bg-white text-sm origin-top-left" style="min-width: max-content;">';
                rows.forEach((row, rIdx) => {
                    let cleanRow = row.replace(/\\hline/g, '').trim();
                    if(cleanRow.length === 0) return;
                    const cols = cleanRow.split('&');
                    html += `<tr class="${rIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                    cols.forEach(col => { html += `<td class="border border-gray-300 px-3 py-2 align-middle">${col.trim()}</td>`; });
                    html += '</tr>';
                });
                html += '</table></div>';
                return html;
            });
        }

        // 2. H√†m t√≠nh to√°n Scale b·∫£ng
        window.autoScaleTables = () => {
            document.querySelectorAll('.js-scale-wrapper').forEach(wrap => {
                const table = wrap.querySelector('table');
                if (!table) return;
                table.style.transform = 'none'; table.style.width = 'auto'; wrap.style.height = 'auto';
                const containerWidth = wrap.offsetWidth;
                const tableWidth = table.scrollWidth;
                if (tableWidth > containerWidth) {
                    const scale = containerWidth / tableWidth;
                    table.style.transform = `scale(${scale})`;
                    wrap.style.height = `${table.scrollHeight * scale}px`;
                    wrap.style.overflow = 'hidden'; 
                }
            });
        };
        window.addEventListener('resize', window.autoScaleTables);
        // 3. H√†m x·ª≠ l√Ω danh s√°ch (itemchoice, enumerate, listEX...)
        function processLatexLists(text) {
            let processed = text;

            // X·ª≠ l√Ω itemchoice (Tr·∫Øc nghi·ªám ƒë√∫ng sai)
            processed = processed.replace(/\\begin\{itemchoice\}([\s\S]*?)\\end\{itemchoice\}/g, (match, body) => {
                const items = body.split('\\itemch').filter(s => s.trim().length > 0);
                const htmlItems = items.map(item => {
                    let content = item.trim().replace(/\\\\/g, '<br>').replace(/\n/g, ' ');
                    return `<li class="flex items-start gap-2 mb-1">
                        <span class="text-blue-600 font-bold shrink-0">‚Ä¢</span> 
                        <div class="leading-relaxed">${content}</div>
                    </li>`;
                }).join('');
                return `<ul class="my-3 pl-2">${htmlItems}</ul>`;
            });

            // H√†m ph·ª• t√°ch item
            const parseItems = (bodyStr) => {
                const rawItems = bodyStr.split(/\\item(?![a-zA-Z])/).filter(s => s.trim().length > 0);
                return rawItems.map((item) => {
                    let content = item.trim();
                    let label = null;
                    if (content.startsWith('[')) {
                        const closeBracket = content.indexOf(']');
                        if (closeBracket > -1) {
                            label = content.substring(1, closeBracket);
                            content = content.substring(closeBracket + 1).trim();
                        }
                    }
                    content = processTabular(content); // X·ª≠ l√Ω n·∫øu c√≥ b·∫£ng l·ªìng b√™n trong
                    return { label, content };
                });
            };

            // X·ª≠ l√Ω listEX, enumEX (Chia c·ªôt)
            const regexCols = /\\begin\{(?:listEX|enumEX)\}(?:\[(\d+)\]|\{(\d+)\}(?:\[(.*?)\])?)([\s\S]*?)\\end\{(?:listEX|enumEX)\}/g;
            processed = processed.replace(regexCols, (match, c1, c2, style, body) => {
                const cols = c1 || c2 || 1;
                const items = parseItems(body);
                let gridHtml = `<div class="grid grid-cols-1 md:grid-cols-${cols} gap-4 my-3">`;
                items.forEach((it, idx) => {
                    let displayLabel = it.label;
                    if (!displayLabel && match.includes('enumEX')) displayLabel = String.fromCharCode(97 + idx) + ')';
                    gridHtml += `<div class="flex gap-2">${displayLabel ? `<span class="font-bold text-gray-700 shrink-0">${displayLabel}</span>` : `<span class="text-gray-400 shrink-0">‚Ä¢</span>`}<div>${it.content}</div></div>`;
                });
                gridHtml += `</div>`;
                return gridHtml;
            });

            // X·ª≠ l√Ω enumerate (ƒê√°nh s·ªë 1, 2, 3...)
            processed = processed.replace(/\\begin\{enumerate\}([\s\S]*?)\\end\{enumerate\}/g, (match, body) => {
                const items = parseItems(body);
                let html = `<ol class="list-decimal pl-6 space-y-1 my-2">`;
                items.forEach(it => {
                    html += it.label ? `<li class="list-none -ml-4"><span class="font-bold mr-1">${it.label}</span>${it.content}</li>` : `<li>${it.content}</li>`;
                });
                html += `</ol>`;
                return html;
            });

            // X·ª≠ l√Ω itemize (G·∫°ch ƒë·∫ßu d√≤ng)
            processed = processed.replace(/\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g, (match, body) => {
                const items = parseItems(body);
                let html = `<ul class="list-disc pl-6 space-y-1 my-2">`;
                items.forEach(it => {
                    html += it.label ? `<li class="list-none -ml-4"><span class="font-bold mr-1">${it.label}</span>${it.content}</li>` : `<li>${it.content}</li>`;
                });
                html += `</ul>`;
                return html;
            });

            return processed;
        }
        // --- H√ÄM FORMAT TH√îNG MINH: BI·∫æN M√É EDITOR TH√ÄNH M√É H·ªåC SINH ---
        window.formatContent = (text) => {
            if (text === null || text === undefined) return "";
            
            let processed = text;

            // 1. D·ªåN D·∫∏P LATEX V√Ä K√ù T·ª∞ R√ÅC
            processed = processed.replace(/\\lq\\lq/g, '"').replace(/\\rq\\rq/g, '"');
            processed = processed.replace(/\\lq/g, '"').replace(/\\rq/g, '"');
            processed = processed.replace(/\\(h|v)space\*?\{[^}]+\}/g, ''); 
            processed = processed.replace(/\\(no)?indent/g, '');
            processed = processed.replace(/\\wideparen\{([^}]+)\}/g, '\\overset{\\frown}{$1}');

            // 2. X·ª¨ L√ù ·∫¢NH & PLACEHOLDER
            processed = processed.replace(/<div[^>]*class="[^"]*image-placeholder[^"]*"[^>]*>[\s\S]*?<\/div>/g, '');
            processed = processed.replace(
                /<div[^>]*class="[^"]*group relative[^"]*"[^>]*>[\s\S]*?(<img[^>]+>)[\s\S]*?<\/div>/gi, 
                '<div class="flex justify-center my-3">$1</div>'
            );
            processed = processed.replace(/Click ƒë√∫p ƒë·ªÉ t·∫£i file|ho·∫∑c Ctrl \+ V ƒë·ªÉ d√°n ·∫£nh|·∫¢NH T·ª™ IMMINI|V·ªä TR√ç H√åNH TIKZ/gi, '');

            // 3. X·ª≠ l√Ω TikZ
            processed = processNestedTikz(processed);

            // 4. X·ª≠ l√Ω B·∫£ng bi·ªÉu (Scale)
            processed = processTabular(processed);

            // 5. X·ª≠ l√Ω danh s√°ch (itemchoice, enumerate...) - [M·ªöI TH√äM]
            processed = processLatexLists(processed);

            // 6. D·ªçn r√°c cu·ªëi c√πng
            processed = processed.replace(/^\s*\}\s*$/gm, ''); 
            processed = processed.replace(/\}\s*$/g, '');

            // 7. Ph√¢n t√°ch HTML/LaTeX ƒë·ªÉ hi·ªÉn th·ªã
            const regex = /(\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\]|\\\([\s\S]*?\\\)|(?:\$[\s\S]*?\$)|<script type="text\/tikz">[\s\S]*?<\/script>|<div[^>]*class="js-scale-wrapper"[\s\S]*?<\/div>|<div class="flex justify-center my-3"><img[\s\S]*?<\/div>|<img.*?>|<ul[\s\S]*?<\/ul>|<ol[\s\S]*?<\/ol>|<div class="grid[\s\S]*?<\/div>)/g;
            
            const parts = processed.split(regex);
            
            return parts.map(part => {
                if (part.includes('<script type="text/tikz">') || 
                    part.includes('<img') || 
                    part.includes('js-scale-wrapper') || 
                    part.includes('<ul') || // B·∫£o v·ªá danh s√°ch
                    part.includes('<ol') || 
                    part.includes('class="grid') ||
                    part.trim().startsWith('$') || 
                    part.trim().startsWith('\\(') || 
                    part.trim().startsWith('\\[')) {
                    return part;
                }
                else {
                    let cleanPart = part.replace(/\}/g, '');
                    return cleanPart.replace(/\\\\/g, '<br>').replace(/\n/g, '<br>');
                }
            }).join('');
        };
        
        function autoScaleMath() {
            document.querySelectorAll('mjx-container').forEach(node => {
                const parent = node.parentElement;
                if(parent && parent.offsetWidth > 0 && node.offsetWidth > parent.offsetWidth) {
                    const scale = (parent.offsetWidth / node.offsetWidth) * 0.95;
                    node.style.transform = `scale(${scale})`;
                    node.style.transformOrigin = 'left center';
                    node.style.marginRight = `-${node.offsetWidth - (node.offsetWidth * scale)}px`;
                }
            });
        }

        // [FILE: exam.html] - T√¨m onAuthStateChanged v√† thay th·∫ø

        // --- 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P & T·∫¢I ƒê·ªÄ (ƒê√É FIX) ---
       // --- 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P & T·∫¢I ƒê·ªÄ (ƒê√É S·ª¨A T√äN H√ÄM ƒê√öNG) ---
        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            examId = urlParams.get('id');

            if (user) {
                currentUser = user; // G√°n user ƒë·ªÉ d√πng cho vi·ªác n·ªôp b√†i/xem l·ªãch s·ª≠
                
                // T·∫£i Logo
                if(typeof loadSiteLogo === 'function') loadSiteLogo(); 

                if (examId) {
                    // [QUAN TR·ªåNG] G·ªçi ƒë√∫ng t√™n h√†m l√† loadLobbyData
                    loadLobbyData(examId); 
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y ID ƒë·ªÅ thi!");
                    window.location.href = "student.html";
                }
            } else {
                // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
                if (examId) sessionStorage.setItem('pendingExamUrl', window.location.href);
                if(typeof showLoginRequestModal === 'function') showLoginRequestModal();
            }
        });

        // 2. Hi·ªÉn th·ªã th√¥ng b√°o y√™u c·∫ßu ƒëƒÉng k√Ω (T·∫°o Modal b·∫±ng JS ƒë·ªÉ kh√¥ng ph·∫£i s·ª≠a HTML nhi·ªÅu)
        // --- H√ÄM HI·ªÇN TH·ªä MODAL Y√äU C·∫¶U ƒêƒÇNG NH·∫¨P (ƒê√É FIX M√ÄU N√öT) ---
        function showLoginRequestModal() {
            const modalHtml = `
                <div class="fixed inset-0 bg-gray-900/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center animate-bounce-in relative">
                        <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl border border-orange-200">
                            <i class="fa-solid fa-user-lock"></i>
                        </div>
                        <h3 class="text-xl font-black text-gray-800 mb-2">Y√™u c·∫ßu t√†i kho·∫£n</h3>
                        <p class="text-gray-500 mb-6 text-sm">Em c·∫ßn ƒëƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω ƒë·ªÉ l√†m b√†i thi n√†y v√† l∆∞u k·∫øt qu·∫£ v√†o h·ªá th·ªëng.</p>
                        
                        <div class="space-y-3">
                            <button onclick="window.location.href='index.html?mode=register'" 
                                class="w-full py-3.5 bg-[#0F766E] hover:bg-[#0D6E66] text-white font-bold rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 transform hover:scale-[1.02]">
                                <i class="fa-solid fa-user-plus"></i> ƒêƒÉng k√Ω t√†i kho·∫£n ngay
                            </button>
                            
                            <button onclick="window.location.href='index.html'" 
                                class="w-full py-3.5 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all border border-gray-200">
                                ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        // --- 3. H√ÄM T·∫¢I TH√îNG TIN M√ÄN H√åNH CH·ªú (LOBBY) ---
        // --- C·∫¨P NH·∫¨T H√ÄM LOAD LOBBY (ƒê√É S·ª¨A T√äN BI·∫æN) ---
        // --- H√ÄM T·∫¢I M√ÄN H√åNH CH·ªú & X·ª¨ L√ù L·ªúI GI·∫¢I (FULL LOGIC) ---
        async function loadLobbyData(id) {
            try {
                // 1. T·∫£i th√¥ng tin ƒë·ªÅ thi
                const docSnap = await getDoc(doc(db, "exams", id));
                if (!docSnap.exists()) {
                    document.getElementById('lobbyTitle').innerText = "ƒê·ªÅ thi kh√¥ng t·ªìn t·∫°i!";
                    return;
                }
                examData = { id: docSnap.id, ...docSnap.data() }; 
                
                // 2. [M·ªöI] T·∫£i l·ªãch s·ª≠ l√†m b√†i (ƒê·ªÉ bi·∫øt ƒë√£ l√†m ch∆∞a)
                const q = query(collection(db, "results"), where("examId","==",id), where("studentId","==",currentUser.uid));
                const snap = await getDocs(q);
                window.examHistory = [];
                snap.forEach(d => window.examHistory.push(d.data()));
                // S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu
                window.examHistory.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
                const att = window.examHistory.length;

                // 3. [M·ªöI] KI·ªÇM TRA CH·∫æ ƒê·ªò XEM L·∫†I (REVIEW MODE)
                // Logic: N·∫øu link c√≥ ?mode=review -> Ki·ªÉm tra l·ªãch s·ª≠ -> V√†o th·∫≥ng l·ªùi gi·∫£i
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('mode') === 'review') {
                    if (att > 0) {
                        console.log("ƒêang v√†o ch·∫ø ƒë·ªô xem l·ªùi gi·∫£i...");
                        // Chu·∫©n b·ªã d·ªØ li·ªáu
                        currentQuestions = examData.questions || [];
                        userAnswers = window.examHistory[0].answers || {};
                        
                        // ·∫®n m√†n h√¨nh ch·ªù ngay
                        document.getElementById('lobbyScreen').classList.add('hidden');
                        
                        // V√†o m√†n h√¨nh l·ªùi gi·∫£i
                        viewDetailSolutions(); 
                        return; // <--- D·ª™NG T·∫†I ƒê√ÇY (B·ªè qua check th·ªùi gian)
                    } else {
                        window.customAlert("B·∫°n ch∆∞a l√†m b√†i n√†y n√™n kh√¥ng th·ªÉ xem l·ªùi gi·∫£i!", "error");
                        // Code s·∫Ω ch·∫°y ti·∫øp xu·ªëng d∆∞·ªõi ƒë·ªÉ hi·ªán n√∫t "B·∫Øt ƒë·∫ßu l√†m b√†i"
                    }
                }

                // 4. ƒêi·ªÅn th√¥ng tin l√™n giao di·ªán Lobby
                // 4. ƒêi·ªÅn th√¥ng tin l√™n giao di·ªán Lobby
                document.getElementById('lobbyTitle').innerText = examData.title || "B√†i thi";
                document.getElementById('lobbyDuration').innerText = examData.duration || '--';
                
                const qCount = examData.questions ? examData.questions.length : 0;
                if(document.getElementById('lobbyQCount')) document.getElementById('lobbyQCount').innerText = qCount;
                if(document.getElementById('lobbyAttempts')) document.getElementById('lobbyAttempts').innerText = att;
                if(document.getElementById('lobbyMaxAttempts')) document.getElementById('lobbyMaxAttempts').innerText = examData.attempts || '‚àû';

                // --- 5. LOGIC KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN V√ÄO THI ---
                // --- 5. LOGIC KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN V√ÄO THI ---
                let ok = true, msg = "S·∫µn s√†ng", color = "text-green-600";
                
                // [FIX LOGIC] L·∫•y t·∫•t c·∫£ gi√° tr·ªã 'mode' trong URL (v√¨ c√≥ th·ªÉ c√≥ c·∫£ 'course' v√† 'practice')
                const modes = urlParams.getAll('mode');
                // N·∫øu c√≥ c·ªù 'practice' HO·∫∂C 'course' th√¨ ƒë·ªÅu t√≠nh l√† ch·∫ø ƒë·ªô luy·ªán t·∫≠p
                const isPracticeMode = modes.includes('practice') || modes.includes('course');

                // 5.1 Check th·ªùi gian m·ªü/ƒë√≥ng ƒë·ªÅ
                const now = new Date();
                if(examData.startTime && now < new Date(examData.startTime)) { 
                    ok=false; msg="Ch∆∞a ƒë·∫øn gi·ªù m·ªü ƒë·ªÅ"; color="text-orange-500"; 
                    document.getElementById('lobbyTimeRange').classList.remove('hidden'); 
                    document.getElementById('lobbyTimeText').textContent=new Date(examData.startTime).toLocaleString('vi-VN'); 
                }
                if(examData.endTime && now > new Date(examData.endTime)) { 
                    ok=false; msg="ƒê·ªÅ thi ƒë√£ ƒë√≥ng"; color="text-red-500"; 
                }

                // 5.2 Check s·ªë l∆∞·ª£t: Ch·ªâ ch·∫∑n n·∫øu KH√îNG PH·∫¢I ch·∫ø ƒë·ªô luy·ªán t·∫≠p/kh√≥a h·ªçc
                if(!isPracticeMode && examData.attempts > 0 && att >= examData.attempts) { 
                    ok=false; msg="H·∫øt l∆∞·ª£t l√†m b√†i"; color="text-red-500"; 
                }

                // 5.3 C·∫≠p nh·∫≠t giao di·ªán th√¥ng b√°o n·∫øu ƒëang trong ch·∫ø ƒë·ªô luy·ªán t·∫≠p
                if(isPracticeMode) {
                    msg = "Ch·∫ø ƒë·ªô luy·ªán t·∫≠p (Kh√¥ng gi·ªõi h·∫°n l∆∞·ª£t l√†m)";
                    color = "text-blue-600";
                    if(document.getElementById('lobbyMaxAttempts')) {
                        document.getElementById('lobbyMaxAttempts').innerText = '‚àû (Luy·ªán t·∫≠p)';
                    }
                }

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i UI
                const stat = document.getElementById('lobbyStatusBadge');
                if(stat) { stat.textContent = msg; stat.className = `font-bold ${color}`; }

                // K√≠ch ho·∫°t n√∫t B·∫Øt ƒë·∫ßu
                const btnStart = document.getElementById('btnStartExam');
                if(btnStart) {
                    if(ok) {
                        btnStart.disabled = false;
                        btnStart.classList.remove('bg-gray-300', 'cursor-not-allowed', 'text-gray-400');
                        btnStart.classList.add('bg-[#0F766E]', 'text-white', 'shadow-lg', 'hover:bg-teal-700');
                        btnStart.innerHTML = '<i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i';
                    } else {
                        btnStart.disabled = true;
                        btnStart.classList.remove('bg-[#0F766E]', 'text-white', 'shadow-lg', 'hover:bg-teal-700');
                        btnStart.classList.add('bg-gray-300', 'cursor-not-allowed', 'text-gray-500');
                        btnStart.innerHTML = `<i class="fa-solid fa-ban"></i> ${msg}`;
                    }
                }

            } catch (error) {
                console.error("L·ªói t·∫£i ƒë·ªÅ:", error);
                document.getElementById('lobbyTitle').innerText = "L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng F5!";
                document.getElementById('lobbyTitle').classList.add('text-red-500');
            }
        }
        // --- 2. H√ÄM T·∫¢I LOGO (THAY TH·∫æ ICON M≈®) ---
        async function loadSiteLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    const logoUrl = docSnap.data().logo;
                    
                    // 1. Thay logo ·ªü M√†n h√¨nh ch·ªù (Lobby)
                    const lobbyIconContainer = document.querySelector('#lobbyScreen .w-20.h-20');
                    if (lobbyIconContainer) {
                        // Thay th·∫ø to√†n b·ªô kh·ªëi icon m≈© b·∫±ng ·∫£nh logo
                        lobbyIconContainer.className = "w-24 h-24 mx-auto mb-6 flex items-center justify-center";
                        lobbyIconContainer.innerHTML = `<img src="${logoUrl}" class="w-full h-full object-contain drop-shadow-md">`;
                    }

                    // 2. Thay logo ·ªü Header (Khi l√†m b√†i)
                    const headerLogoContainer = document.getElementById('headerLogoContainer');
                    if (headerLogoContainer) {
                        headerLogoContainer.innerHTML = `
                            <img src="${logoUrl}" class="h-10 w-10 object-contain rounded-lg bg-white shadow-sm border border-gray-100 p-0.5">
                            <span class="font-black text-xl text-[#0F766E] tracking-tight hidden md:block">Th·∫ßy Choang</span>
                        `;
                    }
                }
            } catch (e) { console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c logo:", e); }
        }
        window.requestStart = () => { if(examData.password) document.getElementById('passwordModal').classList.remove('hidden'); else startExam(); }
        window.verifyPassword = () => { if(document.getElementById('examPasswordInput').value===examData.password) { document.getElementById('passwordModal').classList.add('hidden'); startExam(); } else window.customAlert("Sai m·∫≠t kh·∫©u","error"); }

        // H√†m h·ªó tr·ª£ tr·ªôn m·∫£ng ng·∫´u nhi√™n
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startExam() {
            dom.lobby.classList.add('hidden');
            dom.header.classList.remove('hidden'); dom.main.classList.remove('hidden');
            
            // 1. LOGIC TR·ªòN ƒê·ªÄ TH√îNG MINH (THEO NH√ìM + ƒê·∫¢O ƒê√ÅP √ÅN)
            let rawQuestions = JSON.parse(JSON.stringify(examData.questions || [])); // Clone deep ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng d·ªØ li·ªáu g·ªëc
            
            if(examData.shuffle) {
                // Ph√¢n lo·∫°i c√¢u h·ªèi
                const groups = { mc: [], tf: [], short: [], essay: [] };
                rawQuestions.forEach(q => { if(groups[q.type]) groups[q.type].push(q); });

                // Tr·ªôn th·ª© t·ª± c√¢u trong t·ª´ng nh√≥m
                shuffleArray(groups.mc);
                shuffleArray(groups.tf);
                shuffleArray(groups.short);
                shuffleArray(groups.essay);

                // Tr·ªôn ƒë√°p √°n A,B,C,D cho c√¢u Tr·∫Øc nghi·ªám
                groups.mc.forEach(q => {
                    if (q.options && q.options.length > 0) {
                        // T·∫°o m·∫£ng t·∫°m ch·ª©a n·ªôi dung v√† index c≈©: [{txt: "N·ªôi dung A", idx: 0}, ...]
                        let mapped = q.options.map((opt, i) => ({ txt: opt, originalIdx: i }));
                        shuffleArray(mapped); // Tr·ªôn m·∫£ng t·∫°m
                        
                        // C·∫≠p nh·∫≠t l·∫°i options m·ªõi
                        q.options = mapped.map(m => m.txt);
                        // T√¨m xem ƒë√°p √°n ƒë√∫ng (correct) gi·ªù ch·∫°y ƒëi ƒë√¢u r·ªìi c·∫≠p nh·∫≠t l·∫°i index m·ªõi
                        q.correct = mapped.findIndex(m => m.originalIdx === q.correct);
                    }
                });

                // G·ªôp l·∫°i theo th·ª© t·ª± c·ªë ƒë·ªãnh: TN -> ƒêS -> ƒêi·ªÅn -> T·ª± lu·∫≠n
                currentQuestions = [...groups.mc, ...groups.tf, ...groups.short, ...groups.essay];
            } else {
                currentQuestions = rawQuestions;
            }
            
            // 2. KH·ªûI T·∫†O TIMER (Logic m·ªõi ·ªü b∆∞·ªõc sau)
            const durationMinutes = examData.duration || 45;
            timeLeft = durationMinutes * 60;
            
            if(timeLeft > 0) {
                // T√≠nh th·ªùi ƒëi·ªÉm k·∫øt th√∫c tuy·ªát ƒë·ªëi (Timestamp) ƒë·ªÉ ch·ªëng vi·ªác browser ng·ªß ƒë√¥ng
                window.endTimeStamp = Date.now() + (timeLeft * 1000);
                runTimer(); 
            } else {
                dom.timer.textContent = "‚àû";
            }
            
            // 3. KH·ªûI T·∫†O GI√ÅM S√ÅT (Cheat Detection)
            if(examData.proctoring) {
                document.getElementById('cheatWarning').classList.remove('hidden');
                initProctoring(); // G·ªçi h√†m gi√°m s√°t ri√™ng
            }
            
            isExamActive = true;
            renderPalette(); renderQuestion(0);
            try{document.documentElement.requestFullscreen().catch(()=>{});}catch(e){}
        }

        function runTimer() {
            updateTimer(); // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
            
            timerInterval = setInterval(() => {
                // T√≠nh l·∫°i timeLeft d·ª±a tr√™n th·ªùi gian th·ª±c t·∫ø so v·ªõi m·ªëc ƒë√≠ch
                const now = Date.now();
                const diff = Math.ceil((window.endTimeStamp - now) / 1000);
                
                timeLeft = diff;

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    updateTimer();
                    clearInterval(timerInterval);
                    submitReal(true); // N·ªôp b√†i t·ª± ƒë·ªông
                } else {
                    updateTimer();
                }
            }, 1000);
        }
        function initProctoring() {
            const handleCheat = () => {
                if (isExamActive) {
                    cheatCount++;
                    document.getElementById('cheatCount').textContent = cheatCount;
                    // C√≥ th·ªÉ th√™m logic: N·∫øu cheat > 5 l·∫ßn th√¨ t·ª± n·ªôp b√†i
                }
            };

            // B·∫Øt s·ª± ki·ªán r·ªùi tab ho·∫∑c ·∫©n tr√¨nh duy·ªát
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === 'hidden') {
                    handleCheat();
                }
            });

            // B·∫Øt s·ª± ki·ªán m·∫•t ti√™u ƒëi·ªÉm (Alt+Tab ho·∫∑c b·∫•m sang ·ª©ng d·ª•ng kh√°c)
            window.addEventListener("blur", () => {
                handleCheat();
            });
        }
        function updateTimer() { const m=Math.floor(timeLeft/60), s=timeLeft%60; dom.timer.textContent=`${m<10?'0'+m:m}:${s<10?'0'+s:s}`; if(timeLeft<300) dom.timer.parentElement.classList.add('bg-red-50','text-red-600'); }

        function renderQuestion(idx) {
            currentIndex = idx;
            const q = currentQuestions[idx];
            document.getElementById('currentQNum').textContent = idx + 1;
            
            const badge = dom.badge;
            badge.textContent = q.type==='mc'?'TR·∫ÆC NGHI·ªÜM':(q.type==='tf'?'ƒê√öNG/SAI':(q.type==='short'?'TR·∫¢ L·ªúI NG·∫ÆN':'T·ª∞ LU·∫¨N'));
            
            dom.content.innerHTML = window.formatContent(q.content);
            dom.options.innerHTML = '';

            const fb = document.getElementById('flagBtn');
            fb.className = flaggedQuestions[idx] ? "text-red-500 text-2xl" : "text-gray-300 hover:text-red-500 text-2xl";
            fb.innerHTML = flaggedQuestions[idx] ? '<i class="fa-solid fa-flag"></i>' : '<i class="fa-regular fa-flag"></i>';

            if(q.type === 'mc') {
                q.options.forEach((opt, i) => {
                    const checked = userAnswers[idx] === i;
                    const div = document.createElement('label'); div.className = "block cursor-pointer group w-full";
                    div.innerHTML = `<input type="radio" name="q" class="hidden custom-radio" ${checked?'checked':''}><div class="flex items-start p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 group-hover:bg-blue-50 group-hover:shadow-sm h-full"><div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400 shrink-0 mt-0.5">${String.fromCharCode(65+i)}</div><div class="flex-1 text-gray-700 leading-relaxed">${window.formatContent(opt)}</div></div>`;
                    div.querySelector('input').onchange = () => { userAnswers[idx]=i; updatePalette(); };
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 q.statements.forEach((stmt, i) => {
                    const val = userAnswers[idx]?userAnswers[idx][i]:null;
                    const div = document.createElement('div'); div.className = "bg-white border-2 border-gray-100 rounded-xl p-4 hover:border-orange-200 transition-all";
                    div.innerHTML = `<div class="font-medium text-gray-800 mb-2">${window.formatContent(stmt.text)}</div><div class="flex gap-4"><label class="flex-1 cursor-pointer"><input type="radio" name="tf-${idx}-${i}" value="true" ${val===true?'checked':''} class="mr-2">ƒê√∫ng</label><label class="flex-1 cursor-pointer"><input type="radio" name="tf-${idx}-${i}" value="false" ${val===false?'checked':''} class="mr-2">Sai</label></div>`;
                    div.querySelectorAll('input').forEach(inp => inp.onchange = (e) => {
                        if(!userAnswers[idx]) userAnswers[idx]={}; userAnswers[idx][i]=(e.target.value==='true'); updatePalette();
                    });
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'short') {
                const inp = document.createElement('input');
                inp.className = "w-full p-4 border-2 rounded-xl font-bold text-lg outline-none focus:border-green-500";
                inp.placeholder = "Nh·∫≠p ƒë√°p √°n...";
                inp.value = userAnswers[idx] || '';
                inp.onchange = (e) => { userAnswers[idx]=e.target.value; updatePalette(); };
                dom.options.appendChild(inp);
            } else { 
                const ta = document.createElement('textarea');
                ta.className = "w-full p-4 border-2 rounded-xl min-h-[200px] outline-none focus:border-purple-500";
                ta.placeholder = "Nh·∫≠p b√†i l√†m...";
                ta.value = userAnswers[idx] || '';
                ta.onchange = (e) => { userAnswers[idx]=e.target.value; updatePalette(); };
                dom.options.appendChild(ta);
            }

            if(window.MathJax) {
                MathJax.typesetPromise([dom.content, dom.options]).then(() => {
                    autoScaleMath();
                    // TH√äM D√íNG N√ÄY:
                    window.autoScaleTables(); 
                }).catch(()=>{});
            }
            updatePalette();
            closeAllSidebars();
        }

        function updatePalette() {
            dom.palette.innerHTML = '';
            currentQuestions.forEach((q, i) => {
                const btn = document.createElement('button'); btn.className = "q-btn"; btn.textContent = i+1;
                if(i===currentIndex) btn.classList.add('active');
                else if(flaggedQuestions[i]) btn.classList.add('flagged');
                else {
                    const a = userAnswers[i];
                    let done = (a!==undefined && a!==null && a!=="");
                    if(q.type==='tf' && typeof a==='object') done = Object.keys(a).length>0;
                    if(done) btn.classList.add('answered');
                }
                btn.onclick = () => renderQuestion(i);
                dom.palette.appendChild(btn);
            });
            
            document.getElementById('prevBtnMob').disabled = currentIndex===0;
            document.getElementById('nextBtnMob').disabled = currentIndex===currentQuestions.length-1;
            document.getElementById('prevBtnMob').classList.toggle('opacity-50', currentIndex===0);
            document.getElementById('nextBtnMob').classList.toggle('opacity-50', currentIndex===currentQuestions.length-1);
        }
        function renderPalette() { updatePalette(); }

        window.toggleMobilePalette = (id) => {
            const sb = document.getElementById(id); const bd = document.getElementById('mobileBackdrop');
            if(sb.classList.contains('open')) { sb.classList.remove('open'); bd.classList.remove('show'); }
            else { sb.classList.add('open'); bd.classList.add('show'); }
        }
        window.closeAllSidebars = () => {
            document.getElementById('paletteSidebar').classList.remove('open');
            document.getElementById('solutionSidebar').classList.remove('open');
            document.getElementById('mobileBackdrop').classList.remove('show');
        }

        window.toggleFlag = () => { flaggedQuestions[currentIndex] = !flaggedQuestions[currentIndex]; renderQuestion(currentIndex); }

        window.checkFinish = () => {
            let left = 0;
            currentQuestions.forEach((q,i) => {
                const a = userAnswers[i];
                let done = (a!==undefined && a!==null && a!=="");
                if(q.type==='tf' && typeof a==='object') done = Object.keys(a).length === (q.statements?.length||0);
                if(!done) left++;
            });
            if(left>0) window.customConfirm(`C√≤n ${left} c√¢u ch∆∞a l√†m. N·ªôp lu√¥n?`).then(y => { if(y) submitReal(); });
            else submitReal();
        }

        async function submitReal(auto=false) {
            isExamActive = false;
            clearInterval(timerInterval);
            
            let correct = 0;
            const normalize = (s) => String(s).replace(/\$| /g,'').toLowerCase().trim();
            
            currentQuestions.forEach((q,i) => {
                const u = userAnswers[i];
                if(q.type==='mc' && u===q.correct) correct++;
                if(q.type==='short' && q.answer && u && normalize(u)===normalize(q.answer)) correct++;
                if(q.type==='tf' && u && q.statements) {
                    let matches=0; q.statements.forEach((s,si) => { if(u[si]===s.isTrue) matches++; });
                    if(matches === q.statements.length) correct++;
                }
            });
            const score = parseFloat((correct * (10/currentQuestions.length)).toFixed(2));

            // [LOGIC M·ªöI] Ki·ªÉm tra ƒëi·ªÉm t·ªëi thi·ªÉu (M·∫∑c ƒë·ªãnh 5 n·∫øu kh√¥ng c√†i ƒë·∫∑t)
            const passScore = examData.passScore !== undefined ? Number(examData.passScore) : 5;
            const isPassed = score >= passScore;

            try {
                // L∆∞u th√™m tr∆∞·ªùng isPassed v√†o database
                await addDoc(collection(db, "results"), {
                    examId, 
                    studentId: currentUser.uid, 
                    studentName: currentUser.displayName || currentUser.email,
                    score, 
                    answers: userAnswers, 
                    cheatCount, 
                    correctCount: correct, 
                    totalQuestions: currentQuestions.length,
                    isPassed: isPassed, // <--- Quan tr·ªçng: L∆∞u tr·∫°ng th√°i ƒê·∫°t/Tr∆∞·ª£t
                    passScoreSnapshot: passScore, // L∆∞u l·∫°i m·ªëc ƒëi·ªÉm chu·∫©n t·∫°i th·ªùi ƒëi·ªÉm thi
                    submittedAt: new Date().toISOString()
                });
                
                document.getElementById('scoreDisplay').textContent = score;
                document.getElementById('correctCount').textContent = `${correct}/${currentQuestions.length}`;

                // [LOGIC M·ªöI] Thay ƒë·ªïi giao di·ªán d·ª±a tr√™n k·∫øt qu·∫£ ƒê·∫°t hay Tr∆∞·ª£t
                const resultTitle = document.getElementById('resultTitle');
                const resultMsg = document.getElementById('resultMsg');
                const resultIcon = document.getElementById('resultIcon');
                const scoreDisplay = document.getElementById('scoreDisplay');

                if (isPassed) {
                    resultTitle.textContent = "Ch√∫c m·ª´ng! B·∫°n ƒë√£ v∆∞·ª£t qua";
                    resultTitle.className = "text-2xl font-extrabold text-green-600 mb-2";
                    resultMsg.textContent = `B·∫°n ƒë√£ ƒë·∫°t ${score} ƒëi·ªÉm (ƒêi·ªÉm chu·∫©n: ${passScore})`;
                    resultIcon.innerHTML = "üéâ"; // Icon ph√°o hoa
                    scoreDisplay.className = "text-6xl font-black text-green-600"; // M√†u xanh
                } else {
                    resultTitle.textContent = "Ch∆∞a ƒë·∫°t y√™u c·∫ßu";
                    resultTitle.className = "text-2xl font-extrabold text-red-600 mb-2";
                    resultMsg.textContent = `C·∫ßn t·ªëi thi·ªÉu ${passScore} ƒëi·ªÉm ƒë·ªÉ qua b√†i. H√£y √¥n t·∫≠p th√™m!`;
                    resultIcon.innerHTML = "fighting"; // Icon c·ªë l√™n (ho·∫∑c icon bu·ªìn)
                    resultIcon.textContent = "üòì"; 
                    scoreDisplay.className = "text-6xl font-black text-red-500"; // M√†u ƒë·ªè
                }
                
                if (examData.showScore === 'immediate' || (examData.showScore === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('scoreSection').classList.remove('hidden');
                }
                if (examData.showResult === 'immediate' || (examData.showResult === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('btnViewSolution').classList.remove('hidden');
                }
                
                document.getElementById('resultModal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('resultModal').classList.remove('opacity-0'); document.getElementById('resultModalContent').classList.add('scale-100'); }, 50);
            } catch(e) { window.customAlert("L·ªói l∆∞u b√†i: "+e.message, "error"); }
        }

        window.viewDetailSolutions = () => {
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('examMain').classList.add('hidden');
            document.getElementById('examHeader').classList.add('hidden');
            document.getElementById('solutionView').classList.remove('hidden');
            
            const list = document.getElementById('solutionList');
            const pal = document.getElementById('solutionPalette');
            list.innerHTML = ''; pal.innerHTML = '';
            
            const historyBody = document.getElementById('historyTableBody');
            historyBody.innerHTML = '';
            if (window.examHistory && window.examHistory.length > 0) {
                window.examHistory.forEach((h, idx) => {
                    const date = new Date(h.submittedAt);
                    historyBody.innerHTML += `<tr class="border-b border-gray-50"><td class="px-2 py-2">#${window.examHistory.length - idx}</td><td class="px-2 py-2 text-center text-blue-600 font-bold">${h.score}</td><td class="px-2 py-2 text-right text-gray-400 text-xs">${date.getDate()}/${date.getMonth()+1}</td></tr>`;
                });
            }

            const normalize = (str) => String(str).replace(/\$| /g, '').toLowerCase().trim();
            currentQuestions.forEach((q, idx) => {
                const u = userAnswers[idx];
                let isCorrect = false;
                let ansHtml = '';
                
                if(q.type==='mc') {
                    isCorrect = (u===q.correct);
                    ansHtml = `<div>B·∫°n ch·ªçn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u!==undefined?String.fromCharCode(65+u):'Ch∆∞a l√†m'}</b> | ƒê√°p √°n: <b class="text-green-600">${String.fromCharCode(65+q.correct)}</b></div>`;
                } else if (q.type==='short') {
                    isCorrect = (q.answer && u && normalize(u)===normalize(q.answer));
                    ansHtml = `<div>B·∫°n ƒëi·ªÅn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u||'Tr·ªëng'}</b> | ƒê√°p √°n: <b class="text-green-600">${q.answer}</b></div>`;
                } else if (q.type==='tf') {
                    let matches=0;
                    ansHtml='<ul class="text-sm mt-2">';
                    q.statements.forEach((s,i)=>{
                        const uc = (u&&u[i]!==undefined)?(u[i]?'ƒê':'S'):'_';
                        const tc = s.isTrue?'ƒê':'S';
                        const m = (u&&u[i]===s.isTrue);
                        if(m) matches++;
                        ansHtml+=`<li>- ${window.formatContent(s.text)}: <b class="${m?'text-green-600':'text-red-500'}">${uc}</b> (ƒê√∫ng: ${tc})</li>`;
                    });
                    ansHtml+='</ul>';
                    isCorrect = (matches === q.statements.length);
                }

                const btn = document.createElement('button');
                btn.className = `q-btn ${isCorrect?'correct':(isCorrect===false?'wrong':'partial')}`;
                btn.textContent = idx+1;
                btn.onclick = () => { document.getElementById(`sol-q-${idx}`).scrollIntoView({behavior:'smooth', block:'center'}); closeAllSidebars(); };
                pal.appendChild(btn);

                const item = document.createElement('div');
                item.id = `sol-q-${idx}`;
                item.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-200";
                item.innerHTML = `
                    <div class="font-bold text-gray-500 text-sm mb-2">C√¢u ${idx+1} (${q.type.toUpperCase()})</div>
                    <div class="mb-4 text-gray-800 text-lg">${window.formatContent(q.content)}</div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3">${ansHtml}</div>
                    ${q.solution ? `<div class="solution-box"><div class="font-bold text-green-700 mb-1">L·ªùi gi·∫£i:</div><div class="text-gray-700">${window.formatContent(q.solution)}</div></div>` : ''}
                `;
                list.appendChild(item);
            });
            
            if(window.MathJax) {
                MathJax.typesetPromise([list]).then(() => {
                    autoScaleMath();
                    window.autoScaleTables(); // <--- TH√äM D√íNG N√ÄY
                }).catch(()=>{});
            }
        }

        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtn').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        document.getElementById('prevBtnMob').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
    </script>
</body>
</html>
