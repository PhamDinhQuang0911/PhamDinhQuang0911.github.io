<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√†m b√†i thi - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* N√∫t c√¢u h·ªèi */
        .q-btn { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 1px solid #E5E7EB; background-color: white; color: #4B5563; transition: all 0.2s; position: relative; cursor: pointer; }
        .q-btn.active { background-color: #FF6A00 !important; color: white !important; border-color: #FF6A00 !important; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(255, 106, 0, 0.3); z-index: 10; }
        .q-btn.answered { background-color: #EFF6FF; color: #2563EB; border-color: #BFDBFE; }
        .q-btn.flagged::after { content: "\f024"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -4px; right: -4px; font-size: 10px; color: #EF4444; background: #FEF2F2; border-radius: 50%; padding: 2px; border: 1px solid #FECACA; }
        
        /* Tr·∫°ng th√°i Review */
        .q-btn.correct { background-color: #10B981 !important; color: white !important; border-color: #059669 !important; }
        .q-btn.wrong { background-color: #EF4444 !important; color: white !important; border-color: #DC2626 !important; }
        .q-btn.partial { background-color: #F59E0B !important; color: white !important; border-color: #D97706 !important; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* MathJax Scroll Fix */
        mjx-container { overflow-x: auto; overflow-y: hidden; max-width: 100%; display: block !important; padding-bottom: 5px; }
        .solution-box { border-left: 4px solid #10B981; background-color: #ECFDF5; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        
        /* Modal Transition */
        .modal { transition: opacity 0.2s ease; }
        .modal.opacity-0 { pointer-events: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 text-center animate-fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-sm"><i class="fa-solid fa-graduation-cap"></i></div>
            <h1 id="lobbyTitle" class="text-2xl font-extrabold text-gray-800 mb-2">ƒêang t·∫£i...</h1>
            <div id="accessDeniedMsg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 mb-4 text-sm font-bold animate-pulse text-left"><i class="fa-solid fa-ban mr-2"></i> B·∫°n kh√¥ng thu·ªôc l·ªõp ƒë∆∞·ª£c giao ƒë·ªÅ n√†y!</div>
            <p class="text-gray-500 text-sm mb-6"><i class="fa-regular fa-clock"></i> Th·ªùi gian: <span id="lobbyDuration" class="font-bold">--</span> ph√∫t</p>
            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between"><span class="text-gray-500">Tr·∫°ng th√°i:</span><span id="lobbyStatusBadge" class="font-bold text-gray-700">Checking...</span></div>
                <div class="flex justify-between"><span class="text-gray-500">S·ªë l∆∞·ª£t:</span><span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span></div>
                <div class="flex justify-between hidden" id="lobbyTimeRange"><span class="text-gray-500">M·ªü ƒë·ªÅ:</span><span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span></div>
            </div>
            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all shadow-md flex items-center justify-center gap-2 cursor-not-allowed"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            <button onclick="window.location.href='dashboard.html'" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Quay l·∫°i Dashboard</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 lg:px-8 hidden">
        <div class="flex items-center gap-4">
            <button onclick="window.history.back()" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center font-bold"><i class="fa-solid fa-pen-nib"></i></div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[150px] md:max-w-xs">B√†i thi</h1>
                <p class="text-[10px] md:text-xs text-gray-500">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3 md:gap-6">
            <div id="cheatWarning" class="hidden flex items-center gap-1 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> <span id="cheatCount">0</span> vi ph·∫°m</div>
            <div class="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg"><i class="fa-regular fa-clock text-orange-400 animate-pulse"></i><span id="timer" class="font-mono font-bold text-lg md:text-xl tracking-widest">00:00</span></div>
            <button onclick="checkFinish()" class="hidden md:block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md shadow-blue-200">N·ªôp b√†i</button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden">
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar relative" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 min-h-full p-6 md:p-10 relative">
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">C√ÇU H·ªéI</span>
                        <h2 class="text-lg font-bold text-gray-400">C√¢u s·ªë <span id="currentQNum">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-red-500 transition-colors" title="ƒê√°nh d·∫•u"><i class="fa-regular fa-flag text-xl"></i></button>
                </div>
                <div id="questionContent" class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed mb-8"></div>
                <div id="answerOptions" class="space-y-3"></div>
            </div>
        </div>

        <aside id="paletteSidebar" class="w-80 bg-white border-l border-gray-200 hidden md:flex flex-col z-10">
            <div class="p-5 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-700">Danh s√°ch c√¢u h·ªèi</h3>
                <div class="flex flex-wrap gap-3 mt-3 text-xs text-gray-500">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded-sm"></span> ƒêang l√†m</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-200 rounded-sm"></span> ƒê√£ l√†m</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 border border-red-200 bg-red-50 text-red-500 rounded-sm flex items-center justify-center text-[8px]"><i class="fa-solid fa-flag"></i></span> ƒê√°nh d·∫•u</div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-5">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
            <div class="p-5 border-t border-gray-200">
                <button onclick="checkFinish()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-200 transition-all">N·ªôp b√†i thi</button>
            </div>
        </aside>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex justify-between z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button id="prevBtnMob" class="px-4 py-2 bg-gray-100 rounded-lg font-bold text-gray-600 text-sm">Tr∆∞·ªõc</button>
            <button onclick="togglePaletteMobile()" class="px-3 py-2 text-blue-600 font-bold bg-blue-50 rounded-lg"><i class="fa-solid fa-list mr-1"></i> DS C√¢u h·ªèi</button>
            <button id="nextBtnMob" class="px-4 py-2 bg-orange-custom text-white rounded-lg font-bold text-sm">C√¢u sau</button>
        </div>
        
        <div class="hidden md:flex fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-2xl border border-gray-100 gap-4 items-center z-40">
            <button id="prevBtn" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-sm font-bold text-gray-500"><span id="navCurrent">1</span> / <span id="navTotal">--</span></span>
            <button id="nextBtn" class="w-10 h-10 rounded-full bg-orange-custom hover:bg-orange-600 text-white flex items-center justify-center shadow-md shadow-orange-200 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </main>

    <div id="solutionView" class="hidden fixed inset-0 z-[90] bg-gray-50 flex h-full">
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shrink-0 hidden md:flex">
            <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-700">K·∫øt qu·∫£ chi ti·∫øt</h3>
                <button onclick="window.location.href='dashboard.html'" class="text-xs font-bold text-gray-500 hover:text-blue-600">Tho√°t</button>
            </div>
            <div class="p-3 border-b border-gray-100 bg-white text-xs flex gap-3 text-gray-500 justify-center">
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> ƒê√∫ng</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-sm"></span> Sai</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 rounded-sm"></span> 1 ph·∫ßn</div>
            </div>
            <div class="flex-1 overflow-y-auto p-5">
                <div class="grid grid-cols-5 gap-3" id="solutionPalette"></div>
            </div>
        </aside>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth bg-gray-100 w-full" id="solutionContentArea">
            <div class="md:hidden mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                <h3 class="font-bold text-gray-800">K·∫øt qu·∫£ chi ti·∫øt</h3>
                <button onclick="window.location.href='dashboard.html'" class="px-3 py-1.5 bg-gray-100 rounded text-xs font-bold">Tho√°t</button>
            </div>
            <div class="max-w-4xl mx-auto space-y-6 pb-20" id="solutionList"></div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Th√¥ng b√°o</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">N·ªôi dung...</p>
                <input type="text" id="modalInput" class="hidden mt-4 w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none" placeholder="Nh·∫≠p th√¥ng tin...">
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">H·ªßy b·ªè</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÅ thi</h3>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="M·∫≠t kh·∫©u...">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm">H·ªßy</button><button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">V√†o thi</button></div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üèÜ</div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6" id="resultMsg">ƒê√£ n·ªôp b√†i th√†nh c√¥ng.</p>
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-6 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">ƒê√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            <div class="space-y-3">
                <button id="btnViewSolution" onclick="viewDetailSolutions()" class="w-full py-3 rounded-xl bg-orange-100 text-orange-600 font-bold hover:bg-orange-200 transition-colors hidden"><i class="fa-solid fa-eye mr-2"></i> Xem l·ªùi gi·∫£i chi ti·∫øt</button>
                <button onclick="window.location.href='dashboard.html'" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">V·ªÅ trang ch·ªß</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let currentUser, examData, examId;
        let currentQuestions = [], userAnswers = {}, flaggedQuestions = {};
        let currentIndex = 0, timerInterval, timeLeft = 0, cheatCount = 0, isExamActive = false;

        const dom = { lobby: document.getElementById('lobbyScreen'), header: document.getElementById('examHeader'), main: document.getElementById('examMain'), content: document.getElementById('questionContent'), options: document.getElementById('answerOptions'), palette: document.getElementById('questionPalette'), timer: document.getElementById('timer'), badge: document.getElementById('questionTypeBadge') };

        // MODAL SYSTEM
        let modalResolve = null;
        const modalEl = document.getElementById('customModal');
        const modalBox = document.getElementById('customModalBox');
        const modalTitle = document.getElementById('modalTitle');
        const modalMsg = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnCancel = document.getElementById('btnCancel');

        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if (modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (message, type = 'info') => { return new Promise((resolve) => { modalTitle.innerText = type === 'error' ? 'L·ªói' : 'Th√¥ng b√°o'; modalMsg.innerText = message; modalIcon.innerHTML = type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-bell text-blue-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.add('hidden'); btnConfirm.innerText = "ƒê√£ hi·ªÉu"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-95'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; modalResolve = resolve; }); };

        // FIX: X·ª≠ l√Ω chu·ªói an to√†n
        function formatContent(text) {
            if (text === null || text === undefined) return "";
            return String(text).replace(/\\\\/g, '<br>').replace(/\n/g, '<br>');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const p = new URLSearchParams(window.location.search);
                examId = p.get('id');
                if(!examId) { window.customAlert("Kh√¥ng t√¨m th·∫•y ID ƒë·ªÅ thi!").then(() => window.location.href='dashboard.html'); return; }
                document.getElementById('examIdDisplay').textContent = examId;
                await loadLobby(examId);
            } else { window.location.href = 'index.html'; }
        });

        async function loadLobby(id) {
            try {
                const s = await getDoc(doc(db, "exams", id));
                if(!s.exists()) { document.getElementById('lobbyTitle').textContent = "ƒê·ªÅ thi kh√¥ng t·ªìn t·∫°i!"; return; }
                examData = s.data();
                
                const q = query(collection(db, "results"), where("examId","==",id), where("studentId","==",currentUser.uid));
                const snapshot = await getDocs(q);
                const att = snapshot.size;

                // --- FIX: LOGIC REVIEW M·ªöI ---
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('mode') === 'review') {
                    if (att > 0) {
                        const resultsList = [];
                        snapshot.forEach(doc => resultsList.push(doc.data()));
                        resultsList.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                        
                        currentQuestions = examData.questions || [];
                        userAnswers = resultsList[0].answers || {};
                        
                        // ·∫®N LOBBY NGAY L·∫¨P T·ª®C
                        document.getElementById('lobbyScreen').classList.add('hidden');
                        viewDetailSolutions(); 
                        return; // D·ª™NG H√ÄM T·∫†I ƒê√ÇY
                    } else {
                        await window.customAlert("B·∫°n ch∆∞a l√†m b√†i n√†y l·∫ßn n√†o!", "error");
                        window.location.href = "dashboard.html";
                        return;
                    }
                }
                // -----------------------------

                document.getElementById('lobbyTitle').textContent = examData.title;
                document.getElementById('lobbyDuration').textContent = examData.duration || '‚àû';
                
                let canStart = true, msg = "S·∫µn s√†ng", color = "text-green-600";
                if (examData.accessType === 'class' && examData.allowedClassId) {
                    try {
                        const classSnap = await getDoc(doc(db, "classes", examData.allowedClassId));
                        if (classSnap.exists()) {
                            const students = classSnap.data().students || [];
                            const userEmail = currentUser.email.toLowerCase();
                            const isMember = students.some(st => (st.email && st.email.toLowerCase() === userEmail) || (st.username && `${st.username}@hocsinh.com`.toLowerCase() === userEmail));
                            if (!isMember) { canStart = false; msg = "Kh√¥ng thu·ªôc l·ªõp"; color = "text-red-600"; document.getElementById('accessDeniedMsg').classList.remove('hidden'); }
                        } else { canStart = false; msg = "L·ªõp b·ªã x√≥a"; color = "text-red-600"; }
                    } catch (err) { console.error(err); }
                }

                document.getElementById('lobbyAttempts').textContent = att;
                document.getElementById('lobbyMaxAttempts').textContent = examData.attempts || '‚àû';

                const now = new Date();
                if(examData.startTime && now < new Date(examData.startTime)) { canStart=false; msg="Ch∆∞a ƒë·∫øn gi·ªù thi"; color="text-orange-500"; document.getElementById('lobbyTimeText').textContent = new Date(examData.startTime).toLocaleString('vi-VN'); document.getElementById('lobbyTimeRange').classList.remove('hidden'); }
                if(examData.endTime && now > new Date(examData.endTime)) { canStart=false; msg="ƒê√£ h·∫øt h·∫°n"; color="text-red-500"; }
                if(examData.attempts > 0 && att >= examData.attempts) { canStart=false; msg="H·∫øt l∆∞·ª£t l√†m b√†i"; color="text-red-500"; }

                document.getElementById('lobbyStatusBadge').textContent = msg;
                document.getElementById('lobbyStatusBadge').className = `font-bold ${color}`;
                const btn = document.getElementById('btnStartExam');
                if(canStart) { btn.disabled = false; btn.classList.replace('bg-gray-300','bg-blue-600'); btn.classList.remove('cursor-not-allowed'); } 
                else { btn.disabled = true; btn.classList.replace('bg-blue-600','bg-gray-300'); btn.classList.add('cursor-not-allowed'); }
            } catch(e) { console.error(e); window.customAlert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message, "error"); }
        }

        window.requestStart = () => { if(examData.password) document.getElementById('passwordModal').classList.remove('hidden'); else startExam(); }
        window.verifyPassword = () => { if(document.getElementById('examPasswordInput').value === examData.password) { document.getElementById('passwordModal').classList.add('hidden'); startExam(); } else window.customAlert("Sai m·∫≠t kh·∫©u", "error"); }

        function startExam() {
            dom.lobby.classList.add('hidden'); dom.header.classList.remove('hidden'); dom.main.classList.remove('hidden');
            currentQuestions = [...(examData.questions || [])];
            if(examData.shuffle) { for (let i = currentQuestions.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [currentQuestions[i], currentQuestions[j]] = [currentQuestions[j], currentQuestions[i]]; } }
            timeLeft = (examData.duration || 45) * 60;
            if(timeLeft > 0) runTimer(); else dom.timer.textContent = "‚àû";
            if(examData.proctoring) { document.getElementById('cheatWarning').classList.remove('hidden'); document.addEventListener("visibilitychange", handleCheat); window.addEventListener("blur", handleCheat); }
            document.getElementById('navTotal').textContent = currentQuestions.length;
            isExamActive = true; renderPalette(); renderQuestion(0);
            try { document.documentElement.requestFullscreen().catch(()=>{}); } catch(e){}
        }

        function runTimer() { updateTimer(); timerInterval = setInterval(() => { timeLeft--; updateTimer(); if(timeLeft <= 0) { clearInterval(timerInterval); submitReal(true); } }, 1000); }
        function updateTimer() { const m = Math.floor(timeLeft/60), s = timeLeft%60; dom.timer.textContent = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`; if(timeLeft < 300) dom.timer.classList.add('text-red-500'); }
        function handleCheat() { if(!isExamActive) return; if (document.hidden || !document.hasFocus()) { cheatCount++; document.getElementById('cheatCount').textContent = cheatCount; } }

        function renderQuestion(idx) {
            currentIndex = idx; const q = currentQuestions[idx];
            document.getElementById('currentQNum').textContent = idx + 1; document.getElementById('navCurrent').textContent = idx + 1;
            const fb = document.getElementById('flagBtn');
            fb.innerHTML = flaggedQuestions[idx] ? '<i class="fa-solid fa-flag text-xl"></i>' : '<i class="fa-regular fa-flag text-xl"></i>';
            fb.className = flaggedQuestions[idx] ? "text-red-500" : "text-gray-300 hover:text-red-500";
            
            let typeName = "C√¢u h·ªèi"; if(q.type==='mc') typeName="Tr·∫Øc nghi·ªám"; else if(q.type==='tf') typeName="ƒê√∫ng/Sai"; else if(q.type==='short') typeName="ƒêi·ªÅn ƒë√°p √°n"; else if(q.type==='essay') typeName="T·ª± lu·∫≠n";
            dom.badge.textContent = typeName;
            
            dom.content.innerHTML = formatContent(q.content);
            dom.options.innerHTML = '';
            
            if(q.type === 'mc') {
                if(q.options) q.options.forEach((opt, i) => {
                    const chk = userAnswers[idx] === i;
                    const div = document.createElement('label'); div.className = "block cursor-pointer group";
                    div.innerHTML = `<input type="radio" name="q" class="hidden custom-radio" ${chk?'checked':''}><div class="flex items-center p-4 border-2 border-gray-100 rounded-xl hover:border-blue-200 group-hover:bg-blue-50"><div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400">${String.fromCharCode(65+i)}</div><div class="flex-1 text-base">${formatContent(opt)}</div></div>`;
                    div.querySelector('input').onchange = () => saveAnswer(idx, i); dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 let h = `<div class="grid grid-cols-12 bg-gray-100 p-3 font-bold text-xs text-gray-500 uppercase rounded-t-xl border border-gray-200"><div class="col-span-8">M·ªánh ƒë·ªÅ</div><div class="col-span-2 text-center text-green-600">ƒê√∫ng</div><div class="col-span-2 text-center text-red-500">Sai</div></div>`;
                 if(q.statements) q.statements.forEach((s, i) => {
                     const ans = userAnswers[idx] || [];
                     h += `<div class="grid grid-cols-12 p-3 border-b border-x border-gray-200 items-center hover:bg-gray-50 last:rounded-b-xl"><div class="col-span-8 text-sm font-medium text-gray-700">${formatContent(s.text)}</div><div class="col-span-2 text-center"><input type="radio" name="tf${i}" class="w-5 h-5 accent-green-600" onchange="window.saveTF(${idx},${i},true)" ${ans[i]===true?'checked':''}></div><div class="col-span-2 text-center"><input type="radio" name="tf${i}" class="w-5 h-5 accent-red-500" onchange="window.saveTF(${idx},${i},false)" ${ans[i]===false?'checked':''}></div></div>`;
                 });
                 dom.options.innerHTML = h;
            } else {
                const isE = q.type==='essay';
                const el = document.createElement(isE?'textarea':'input');
                el.className = `w-full p-4 border-2 rounded-xl focus:border-blue-500 outline-none text-gray-800 ${isE?'min-h-[150px]':''}`;
                if(!isE) el.type = 'text'; el.placeholder = isE ? "Nh·∫≠p b√†i l√†m t·ª± lu·∫≠n..." : "Nh·∫≠p ƒë√°p √°n ng·∫Øn g·ªçn...";
                el.value = userAnswers[idx] || '';
                el.onchange = (e) => saveAnswer(idx, e.target.value);
                dom.options.appendChild(el);
            }
            if(window.MathJax) MathJax.typesetPromise([dom.content, dom.options]).catch(e=>console.log(e));
            updatePalette();
        }

        function saveAnswer(idx, val) { userAnswers[idx] = val; updatePalette(); }
        window.saveTF = (qIdx, sIdx, val) => { if(!userAnswers[qIdx]) userAnswers[qIdx] = []; userAnswers[qIdx][sIdx] = val; updatePalette(); }
        window.toggleFlag = () => { flaggedQuestions[currentIndex] = !flaggedQuestions[currentIndex]; renderQuestion(currentIndex); }

        function updatePalette() {
            dom.palette.innerHTML = '';
            currentQuestions.forEach((q, i) => {
                const btn = document.createElement('button'); btn.className = "q-btn"; btn.textContent = i + 1;
                if(i === currentIndex) btn.classList.add('active');
                else if(flaggedQuestions[i]) btn.classList.add('flagged');
                else {
                    const a = userAnswers[i];
                    let isDone = false;
                    if(q.type === 'tf') isDone = Array.isArray(a) && a.length === (q.statements?.length || 0) && a.every(x => x !== null && x !== undefined);
                    else isDone = (a !== undefined && a !== null && a !== "");
                    if(isDone) btn.classList.add('answered');
                }
                btn.onclick = () => renderQuestion(i); dom.palette.appendChild(btn);
            });
        }
        function renderPalette() { updatePalette(); }

        // --- X·ª¨ L√ù N·ªòP B√ÄI ---
        window.checkFinish = () => {
            let unanswered = 0;
            currentQuestions.forEach((q, i) => {
                const a = userAnswers[i];
                let isDone = false;
                if(q.type === 'tf') isDone = Array.isArray(a) && a.length === (q.statements?.length || 0) && a.every(x => x !== null && x !== undefined);
                else isDone = (a !== undefined && a !== null && a !== "");
                if(!isDone) unanswered++;
            });
            // Thay confirm m·∫∑c ƒë·ªãnh b·∫±ng customAlert/Modal n·∫øu mu·ªën, ·ªü ƒë√¢y t·∫°m d√πng alert logic
            if(confirm(`B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a l√†m. N·ªôp ngay?`)) submitReal();
        }

        window.submitReal = async (auto = false) => {
            isExamActive = false;
            clearInterval(timerInterval);
            document.removeEventListener("visibilitychange", handleCheat);
            window.removeEventListener("blur", handleCheat);

            let correct = 0;
            currentQuestions.forEach((q,i) => {
                const u = userAnswers[i];
                if(q.type==='mc' && u===q.correct) correct++;
                if(q.type==='short' && q.answer && u && String(u).trim().toLowerCase()===String(q.answer).trim().toLowerCase()) correct++;
                if(q.type==='tf' && Array.isArray(u) && q.statements) { 
                    let ok = true;
                    if(u.length < q.statements.length) ok = false;
                    else q.statements.forEach((s,si) => { if(u[si] !== s.isTrue) ok = false; });
                    if(ok) correct++;
                }
            });
            const score = (correct * (10/Math.max(currentQuestions.length, 1))).toFixed(2);

            try {
                await addDoc(collection(db, "results"), {
                    examId, 
                    studentId: currentUser.uid,
                    studentName: currentUser.displayName || currentUser.email,
                    score: parseFloat(score),
                    answers: userAnswers,
                    cheatCount,
                    submittedAt: new Date().toISOString()
                });

                document.getElementById('resultModal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('resultModal').classList.remove('opacity-0'); document.getElementById('resultModalContent').classList.add('scale-100'); }, 50);

                if(examData.showScore === 'immediate' || (examData.showScore === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('scoreSection').classList.remove('hidden');
                    document.getElementById('scoreDisplay').textContent = score;
                    document.getElementById('correctCount').textContent = correct;
                    document.getElementById('totalCount').textContent = currentQuestions.length;
                }
                if(examData.showResult === 'immediate' || (examData.showResult === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('btnViewSolution').classList.remove('hidden');
                }
            } catch(e) { window.customAlert("L·ªói n·ªôp b√†i: " + e.message, "error"); }
        }

        // --- XEM L·ªúI GI·∫¢I CHI TI·∫æT ---
        window.viewDetailSolutions = () => {
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('examMain').classList.add('hidden');
            document.getElementById('examHeader').classList.add('hidden');
            
            const solutionView = document.getElementById('solutionView');
            solutionView.classList.remove('hidden');
            
            const list = document.getElementById('solutionList');
            const palette = document.getElementById('solutionPalette');
            
            list.innerHTML = '';
            palette.innerHTML = '';

            currentQuestions.forEach((q, idx) => {
                const u = userAnswers[idx];
                let isCorrect = false;
                let ansDisplay = '';

                // Logic check ƒë√∫ng sai
                if(q.type === 'mc') {
                    isCorrect = (u === q.correct);
                    const charUser = u !== undefined ? String.fromCharCode(65 + u) : "Ch∆∞a l√†m";
                    const charTrue = String.fromCharCode(65 + q.correct);
                    ansDisplay = `<div>B·∫°n ch·ªçn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${charUser}</b> | ƒê√°p √°n: <b class="text-green-600">${charTrue}</b></div>`;
                }
                else if(q.type === 'short') {
                    // FIX: Th√™m String() ƒë·ªÉ tr√°nh l·ªói u.trim()
                    const userVal = String(u || '').trim().toLowerCase();
                    const trueVal = String(q.answer || '').trim().toLowerCase();
                    isCorrect = (userVal === trueVal);
                    ansDisplay = `<div>B·∫°n ƒëi·ªÅn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u||'Tr·ªëng'}</b> | ƒê√°p √°n: <b class="text-green-600">${q.answer}</b></div>`;
                }
                else if(q.type === 'tf') {
                    let allRight = true;
                    if(q.statements) {
                        ansDisplay = '<ul class="mt-2 text-sm">';
                        q.statements.forEach((s, i) => {
                            const userChoice = (u && u[i] !== undefined) ? (u[i] ? 'ƒê√∫ng' : 'Sai') : 'Tr·ªëng';
                            const trueChoice = s.isTrue ? 'ƒê√∫ng' : 'Sai';
                            const match = (u && u[i] === s.isTrue);
                            if(!match) allRight = false;
                            ansDisplay += `<li>- ${s.text}: B·∫°n ch·ªçn <b class="${match?'text-green-600':'text-red-500'}">${userChoice}</b> (ƒê√°p √°n: ${trueChoice})</li>`;
                        });
                        ansDisplay += '</ul>';
                    }
                    isCorrect = allRight;
                }
                else {
                    ansDisplay = `<div class="text-orange-500 italic">C√¢u t·ª± lu·∫≠n c·∫ßn gi√°o vi√™n ch·∫•m.</div>`;
                    isCorrect = null; // M√†u v√†ng
                }

                // Render n√∫t Palette
                const btn = document.createElement('button');
                btn.className = `q-btn ${isCorrect === true ? 'correct' : (isCorrect === false ? 'wrong' : 'partial')}`;
                btn.textContent = idx + 1;
                btn.onclick = () => document.getElementById(`sol-q-${idx}`).scrollIntoView({behavior: 'smooth', block: 'center'});
                palette.appendChild(btn);

                // Render N·ªôi dung
                const item = document.createElement('div');
                item.id = `sol-q-${idx}`;
                item.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-200";
                item.innerHTML = `
                    <div class="font-bold text-gray-500 text-sm mb-2">C√¢u ${idx + 1} (${q.type.toUpperCase()})</div>
                    <div class="mb-4 text-gray-800 text-lg">${formatContent(q.content)}</div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3">${ansDisplay}</div>
                    ${q.solution ? `<div class="solution-box"><div class="font-bold text-green-700 mb-1"><i class="fa-solid fa-lightbulb mr-2"></i>L·ªùi gi·∫£i chi ti·∫øt:</div><div class="text-gray-700">${formatContent(q.solution)}</div></div>` : ''}
                `;
                list.appendChild(item);
            });

            // FIX: G·ªçi MathJax render l·∫°i sau khi ƒë√£ th√™m n·ªôi dung v√†o DOM
            if(window.MathJax) {
                setTimeout(() => {
                    MathJax.typesetPromise([list]).catch(e => console.log('MathJax error:', e));
                }, 100);
            }
        }
        
        // Navigation Buttons
        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtn').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        document.getElementById('prevBtnMob').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        
        window.togglePaletteMobile = () => {
             const p = document.getElementById('paletteSidebar');
             if(p.classList.contains('hidden')) { p.classList.remove('hidden', 'md:flex'); p.classList.add('fixed', 'inset-0', 'z-50', 'w-full', 'flex'); }
             else { p.classList.add('hidden', 'md:flex'); p.classList.remove('fixed', 'inset-0', 'z-50', 'w-full', 'flex'); }
        }
    </script>
</body>
</html>
