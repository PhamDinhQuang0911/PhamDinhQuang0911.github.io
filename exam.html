<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m b√†i thi - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* --- STYLE CHO PALETTE C√ÇU H·ªéI --- */
        .q-btn {
            width: 100%;
            aspect-ratio: 1; /* H√¨nh vu√¥ng */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid #E5E7EB;
            background-color: white;
            color: #4B5563;
            transition: all 0.2s;
            position: relative;
        }

        /* 1. ƒêang ch·ªçn (Active) - ∆Øu ti√™n cao nh·∫•t */
        .q-btn.active { 
            background-color: #FF6A00 !important; 
            color: white !important; 
            border-color: #FF6A00 !important; 
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(255, 106, 0, 0.3);
            z-index: 10;
        }

        /* 2. ƒê√£ tr·∫£ l·ªùi (Answered) */
        .q-btn.answered { 
            background-color: #EFF6FF; 
            color: #2563EB; 
            border-color: #BFDBFE; 
        }

        /* 3. ƒê√°nh d·∫•u (Flagged) - Hi·ªÉn th·ªã icon c·ªù nh·ªè */
        .q-btn.flagged::after {
            content: "\f024"; /* FontAwesome flag icon code */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 10px;
            color: #EF4444;
            background: #FEF2F2;
            border-radius: 50%;
            padding: 2px;
            border: 1px solid #FECACA;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 text-center animate-fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-sm"><i class="fa-solid fa-graduation-cap"></i></div>
            <h1 id="lobbyTitle" class="text-2xl font-extrabold text-gray-800 mb-2">ƒêang t·∫£i...</h1>
            <p class="text-gray-500 text-sm mb-6"><i class="fa-regular fa-clock"></i> Th·ªùi gian: <span id="lobbyDuration" class="font-bold">--</span> ph√∫t</p>
            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between"><span class="text-gray-500">Tr·∫°ng th√°i:</span><span id="lobbyStatusBadge" class="font-bold text-gray-700">Checking...</span></div>
                <div class="flex justify-between"><span class="text-gray-500">S·ªë l∆∞·ª£t:</span><span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span></div>
                <div class="flex justify-between hidden" id="lobbyTimeRange"><span class="text-gray-500">M·ªü ƒë·ªÅ:</span><span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span></div>
            </div>
            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all shadow-md flex items-center justify-center gap-2 cursor-not-allowed"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            <button onclick="window.history.back()" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Quay l·∫°i</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 lg:px-8 hidden">
        <div class="flex items-center gap-4">
            <button onclick="window.history.back()" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center font-bold"><i class="fa-solid fa-pen-nib"></i></div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[150px] md:max-w-xs">B√†i thi</h1>
                <p class="text-[10px] md:text-xs text-gray-500">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3 md:gap-6">
            <div id="cheatWarning" class="hidden flex items-center gap-1 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> <span id="cheatCount">0</span> vi ph·∫°m</div>
            <div class="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg"><i class="fa-regular fa-clock text-orange-400 animate-pulse"></i><span id="timer" class="font-mono font-bold text-lg md:text-xl tracking-widest">00:00</span></div>
            <button onclick="finishExam()" class="hidden md:block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md shadow-blue-200">N·ªôp b√†i</button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden">
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar relative" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 min-h-full p-6 md:p-10 relative">
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">TR·∫ÆC NGHI·ªÜM</span>
                        <h2 class="text-lg font-bold text-gray-400">C√¢u h·ªèi <span id="currentQNum">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-red-500 transition-colors" title="ƒê√°nh d·∫•u"><i class="fa-regular fa-flag text-xl"></i></button>
                </div>
                <div id="questionContent" class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed mb-8"></div>
                <div id="answerOptions" class="space-y-3"></div>
            </div>
        </div>

        <aside id="paletteSidebar" class="w-80 bg-white border-l border-gray-200 hidden md:flex flex-col z-10">
            <div class="p-5 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-700">Danh s√°ch c√¢u h·ªèi</h3>
                <div class="flex flex-wrap gap-3 mt-3 text-xs text-gray-500">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded-sm"></span> ƒêang l√†m</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-200 rounded-sm"></span> ƒê√£ l√†m</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 border border-red-200 bg-red-50 text-red-500 rounded-sm flex items-center justify-center text-[8px]"><i class="fa-solid fa-flag"></i></span> ƒê√°nh d·∫•u</div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-5">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
            <div class="p-5 border-t border-gray-200">
                <button onclick="finishExam()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-200 transition-all">N·ªôp b√†i thi</button>
            </div>
        </aside>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex justify-between z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button id="prevBtnMob" class="px-4 py-2 bg-gray-100 rounded-lg font-bold text-gray-600 text-sm">Tr∆∞·ªõc</button>
            <button onclick="togglePaletteMobile()" class="px-3 py-2 text-blue-600 font-bold bg-blue-50 rounded-lg"><i class="fa-solid fa-list mr-1"></i> DS C√¢u h·ªèi</button>
            <button id="nextBtnMob" class="px-4 py-2 bg-orange-custom text-white rounded-lg font-bold text-sm">C√¢u sau</button>
        </div>
        <div class="hidden md:flex fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-2xl border border-gray-100 gap-4 items-center z-40">
            <button id="prevBtn" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-sm font-bold text-gray-500"><span id="navCurrent">1</span> / <span id="navTotal">--</span></span>
            <button id="nextBtn" class="w-10 h-10 rounded-full bg-orange-custom hover:bg-orange-600 text-white flex items-center justify-center shadow-md shadow-orange-200 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </main>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÅ thi</h3>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="M·∫≠t kh·∫©u...">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm">H·ªßy</button><button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">V√†o thi</button></div>
        </div>
    </div>
    <div id="resultModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üèÜ</div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6" id="resultMsg">ƒê√£ n·ªôp b√†i th√†nh c√¥ng.</p>
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-8 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">ƒê√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            <button onclick="window.location.href='dashboard.html'" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">V·ªÅ trang ch·ªß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // VARS
        let currentUser, examData, examId;
        let currentQuestions = [], userAnswers = {}, flaggedQuestions = {};
        let currentIndex = 0, timerInterval, timeLeft = 0, cheatCount = 0, isExamActive = false;

        // UI
        const dom = {
            lobby: document.getElementById('lobbyScreen'),
            header: document.getElementById('examHeader'),
            main: document.getElementById('examMain'),
            content: document.getElementById('questionContent'),
            options: document.getElementById('answerOptions'),
            palette: document.getElementById('questionPalette'),
            timer: document.getElementById('timer')
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const p = new URLSearchParams(window.location.search);
                examId = p.get('id');
                if(!examId) return window.location.href='dashboard.html';
                document.getElementById('examIdDisplay').textContent = examId;
                await loadLobby(examId);
            } else window.location.href = 'index.html';
        });

        async function loadLobby(id) {
            try {
                const s = await getDoc(doc(db, "exams", id));
                if(!s.exists()) return alert("ƒê·ªÅ kh√¥ng t·ªìn t·∫°i!");
                examData = s.data();
                
                // Get Attempts
                const q = query(collection(db, "results"), where("examId","==",id), where("studentId","==",currentUser.uid));
                const att = (await getDocs(q)).size;
                
                document.getElementById('lobbyTitle').textContent = examData.title;
                document.getElementById('lobbyDuration').textContent = examData.duration || '‚àû';
                document.getElementById('lobbyAttempts').textContent = att;
                document.getElementById('lobbyMaxAttempts').textContent = examData.attempts || '‚àû';
                
                // Check Access
                const now = new Date();
                let ok = true, msg = "S·∫µn s√†ng", color = "text-green-600";
                
                if(examData.startTime && now < new Date(examData.startTime)) { ok=false; msg="Ch∆∞a ƒë·∫øn gi·ªù"; color="text-orange-500"; }
                if(examData.endTime && now > new Date(examData.endTime)) { ok=false; msg="H·∫øt h·∫°n"; color="text-red-500"; }
                if(examData.attempts > 0 && att >= examData.attempts) { ok=false; msg="H·∫øt l∆∞·ª£t"; color="text-red-500"; }

                const stat = document.getElementById('lobbyStatusBadge');
                stat.textContent = msg; stat.className = `font-bold ${color}`;
                
                const btn = document.getElementById('btnStartExam');
                if(ok) { btn.disabled = false; btn.classList.replace('bg-gray-300','bg-blue-600'); btn.classList.remove('cursor-not-allowed'); }

            } catch(e) { console.error(e); alert("L·ªói t·∫£i d·ªØ li·ªáu"); }
        }

        window.requestStart = () => {
            if(examData.password) document.getElementById('passwordModal').classList.remove('hidden');
            else startExam();
        }

        window.verifyPassword = () => {
            if(document.getElementById('examPasswordInput').value === examData.password) {
                document.getElementById('passwordModal').classList.add('hidden');
                startExam();
            } else alert("Sai m·∫≠t kh·∫©u");
        }

        function startExam() {
            dom.lobby.classList.add('hidden');
            dom.header.classList.remove('hidden');
            dom.main.classList.remove('hidden');
            
            // Prepare questions
            currentQuestions = [...(examData.questions || [])];
            if(examData.shuffle) {
                // Fisher-Yates shuffle
                for (let i = currentQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [currentQuestions[i], currentQuestions[j]] = [currentQuestions[j], currentQuestions[i]];
                }
            }

            // Init Timer
            timeLeft = (examData.duration || 45) * 60;
            if(timeLeft > 0) runTimer(); else dom.timer.textContent = "‚àû";

            // Init Proctoring
            if(examData.proctoring) {
                document.getElementById('cheatWarning').classList.remove('hidden');
                document.addEventListener("visibilitychange", handleCheat); // Tab switch
                window.addEventListener("blur", handleCheat); // Click away / Alt+Tab
            }

            document.getElementById('navTotal').textContent = currentQuestions.length;
            isExamActive = true;
            renderPalette();
            renderQuestion(0);
            
            // Fullscreen attempt
            try { document.documentElement.requestFullscreen().catch(()=>{}); } catch(e){}
        }

        // --- CORE FEATURES ---
        function runTimer() {
            updateTimer();
            timerInterval = setInterval(() => {
                timeLeft--; updateTimer();
                if(timeLeft <= 0) { clearInterval(timerInterval); finishExam(true); }
            }, 1000);
        }
        function updateTimer() {
            const m = Math.floor(timeLeft/60), s = timeLeft%60;
            dom.timer.textContent = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            if(timeLeft < 300) dom.timer.classList.add('text-red-500');
        }

        // X·ª¨ L√ù GIAN L·∫¨N (C·∫¨P NH·∫¨T M·ªöI)
        function handleCheat() {
            if(!isExamActive) return; // N·∫øu ch∆∞a thi ho·∫∑c ƒë√£ n·ªôp th√¨ kh√¥ng t√≠nh
            
            // Ki·ªÉm tra tr·∫°ng th√°i th·ª±c t·∫ø
            if (document.hidden || !document.hasFocus()) {
                cheatCount++;
                document.getElementById('cheatCount').textContent = cheatCount;
                
                // Play sound (Optional)
                // const audio = new Audio('warning.mp3'); audio.play();
                
                // Show Warning
                alert(`‚ö†Ô∏è C·∫¢NH B√ÅO GIAN L·∫¨N!\nH·ªá th·ªëng ph√°t hi·ªán b·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i.\nVi ph·∫°m l·∫ßn: ${cheatCount}`);
            }
        }

        function renderQuestion(idx) {
            currentIndex = idx;
            const q = currentQuestions[idx];
            
            document.getElementById('currentQNum').textContent = idx + 1;
            document.getElementById('navCurrent').textContent = idx + 1;

            // Update Flag Icon
            const fb = document.getElementById('flagBtn');
            fb.innerHTML = flaggedQuestions[idx] ? '<i class="fa-solid fa-flag text-xl"></i>' : '<i class="fa-regular fa-flag text-xl"></i>';
            fb.className = flaggedQuestions[idx] ? "text-red-500" : "text-gray-300 hover:text-red-500";

            // Content
            dom.content.innerHTML = q.content.replace(/\n/g, '<br>');
            dom.options.innerHTML = '';
            
            if(q.type === 'mc') {
                q.options.forEach((opt, i) => {
                    const chk = userAnswers[idx] === i;
                    const div = document.createElement('label');
                    div.className = "block cursor-pointer group";
                    div.innerHTML = `<input type="radio" name="q" class="hidden custom-radio" ${chk?'checked':''}><div class="flex items-center p-4 border-2 border-gray-100 rounded-xl hover:border-blue-200 group-hover:bg-blue-50"><div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400">${String.fromCharCode(65+i)}</div><div class="flex-1">${opt}</div></div>`;
                    div.querySelector('input').onchange = () => saveAnswer(idx, i);
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 let h = `<div class="grid grid-cols-12 bg-gray-50 p-2 font-bold text-xs text-gray-500 uppercase rounded-t-lg"><div class="col-span-8">M·ªánh ƒë·ªÅ</div><div class="col-span-2 text-center text-green-600">ƒê√∫ng</div><div class="col-span-2 text-center text-red-500">Sai</div></div>`;
                 q.statements.forEach((s, i) => {
                     const ans = userAnswers[idx] || [];
                     h += `<div class="grid grid-cols-12 p-3 border-b items-center hover:bg-gray-50"><div class="col-span-8 text-sm">${s.text}</div><div class="col-span-2 text-center"><input type="radio" name="tf${i}" class="w-4 h-4" onchange="window.saveTF(${idx},${i},true)" ${ans[i]===true?'checked':''}></div><div class="col-span-2 text-center"><input type="radio" name="tf${i}" class="w-4 h-4" onchange="window.saveTF(${idx},${i},false)" ${ans[i]===false?'checked':''}></div></div>`;
                 });
                 dom.options.innerHTML = `<div class="border rounded-lg">${h}</div>`;
            } else {
                const isE = q.type==='essay';
                const el = document.createElement(isE?'textarea':'input');
                el.className = `w-full p-4 border-2 rounded-xl focus:border-blue-500 outline-none ${isE?'min-h-[150px]':''}`;
                if(!isE) el.type = 'text';
                el.placeholder = "Nh·∫≠p c√¢u tr·∫£ l·ªùi...";
                el.value = userAnswers[idx] || '';
                el.onchange = (e) => saveAnswer(idx, e.target.value);
                dom.options.appendChild(el);
            }

            if(window.MathJax) MathJax.typesetPromise([dom.content, dom.options]);
            updatePalette();
        }

        function saveAnswer(idx, val) { userAnswers[idx] = val; updatePalette(); }
        window.saveTF = (qIdx, sIdx, val) => {
            if(!userAnswers[qIdx]) userAnswers[qIdx] = [];
            userAnswers[qIdx][sIdx] = val; updatePalette();
        }
        window.toggleFlag = () => { flaggedQuestions[currentIndex] = !flaggedQuestions[currentIndex]; renderQuestion(currentIndex); }

        function updatePalette() {
            dom.palette.innerHTML = '';
            currentQuestions.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.className = "q-btn";
                btn.textContent = i + 1;
                
                // Style Logic
                if(i === currentIndex) btn.classList.add('active');
                else if(flaggedQuestions[i]) btn.classList.add('flagged');
                else {
                    const a = userAnswers[i];
                    // Check if answered (not null/undefined/empty)
                    const answered = (a !== undefined && a !== null && a !== "") && (!Array.isArray(a) || a.some(x=>x!==null));
                    if(answered) btn.classList.add('answered');
                }
                
                btn.onclick = () => renderQuestion(i);
                dom.palette.appendChild(btn);
            });
        }
        
        function renderPalette() { updatePalette(); }

        window.finishExam = async (auto) => {
            if(!auto && !confirm("N·ªôp b√†i ngay?")) return;
            isExamActive = false;
            clearInterval(timerInterval);
            document.removeEventListener("visibilitychange", handleCheat);
            window.removeEventListener("blur", handleCheat);

            // Calc Score
            let correct = 0;
            currentQuestions.forEach((q,i) => {
                const u = userAnswers[i];
                if(q.type==='mc' && u===q.correct) correct++;
                if(q.type==='short' && q.answer && u && u.trim().toLowerCase()===q.answer.trim().toLowerCase()) correct++;
                if(q.type==='tf' && Array.isArray(u)) { if(q.statements.every((s,si)=>s.isTrue===u[si])) correct++; }
            });
            const score = (correct * (10/currentQuestions.length)).toFixed(2);

            // Save
            await addDoc(collection(db, "results"), {
                examId, studentId: currentUser.uid,
                studentName: currentUser.displayName,
                score: parseFloat(score),
                answers: userAnswers,
                cheatCount,
                submittedAt: new Date().toISOString()
            });

            // Show Result
            document.getElementById('resultModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('resultModal').classList.remove('opacity-0');
                document.getElementById('resultModalContent').classList.add('scale-100');
            }, 50);

            if(examData.showScore === 'immediate' || (examData.showScore === 'after_exam' && timeLeft <= 0)) {
                document.getElementById('scoreSection').classList.remove('hidden');
                document.getElementById('scoreDisplay').textContent = score;
                document.getElementById('correctCount').textContent = correct;
                document.getElementById('totalCount').textContent = currentQuestions.length;
            }
        }
        
        // Navigation Events
        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtn').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        document.getElementById('prevBtnMob').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        
        window.togglePaletteMobile = () => {
             const p = document.getElementById('paletteSidebar');
             if(p.classList.contains('hidden')) {
                 p.classList.remove('hidden', 'md:flex');
                 p.classList.add('fixed', 'inset-0', 'z-50', 'w-full', 'flex');
             } else {
                 p.classList.add('hidden', 'md:flex');
                 p.classList.remove('fixed', 'inset-0', 'z-50', 'w-full', 'flex');
             }
        }
    </script>
</body>
</html>
