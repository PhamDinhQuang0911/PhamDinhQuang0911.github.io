<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√†m b√†i thi - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        macros: {
          heva: ["\\left\\{\\begin{matrix} #1 \\end{matrix}\\right.", 1],
          hoac: ["\\left[\\begin{matrix} #1 \\end{matrix}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ"
        }
      },
      svg: { fontCache: 'global' },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; overscroll-behavior-y: none; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* CSS SIDEBAR MOBILE (TR∆Ø·ª¢T) */
        .mobile-sidebar {
            position: fixed; top: 0; right: 0; bottom: 0; width: 280px;
            background: white; z-index: 50;
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        .mobile-sidebar.open { transform: translateX(0); }
        .sidebar-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar-backdrop.show { opacity: 1; pointer-events: auto; }

        /* CSS N√öT C√ÇU H·ªéI */
        .q-btn { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 1px solid #E5E7EB; background-color: white; color: #4B5563; transition: all 0.2s; position: relative; cursor: pointer; }
        .q-btn.active { background-color: #FF6A00 !important; color: white !important; border-color: #FF6A00 !important; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(255, 106, 0, 0.3); z-index: 10; }
        .q-btn.answered { background-color: #EFF6FF; color: #2563EB; border-color: #BFDBFE; }
        .q-btn.flagged::after { content: "\f024"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -4px; right: -4px; font-size: 10px; color: #EF4444; background: #FEF2F2; border-radius: 50%; padding: 2px; border: 1px solid #FECACA; }
        
        .q-btn.correct { background-color: #10B981 !important; color: white !important; border-color: #059669 !important; }
        .q-btn.wrong { background-color: #EF4444 !important; color: white !important; border-color: #DC2626 !important; }
        .q-btn.partial { background-color: #F59E0B !important; color: white !important; border-color: #D97706 !important; }

        /* CSS CH·ªêNG TR√ÄN & ·∫®N THANH CU·ªòN X√ÅM */
        #questionContent img, #answerOptions img, .solution-box img { max-width: 100% !important; height: auto !important; display: block; margin: 10px auto; border-radius: 8px; }
        
        mjx-container { 
            max-width: 100% !important; 
            overflow-x: auto !important; 
            overflow-y: hidden; 
            display: inline-grid !important; /* Fix l·ªói heva/hoac */
            scrollbar-width: none; /* Firefox: ·∫®n thanh cu·ªôn */
            -ms-overflow-style: none; /* IE: ·∫®n thanh cu·ªôn */
        }
        mjx-container::-webkit-scrollbar { 
            display: none; /* Chrome/Safari: ·∫®n thanh cu·ªôn */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .pb-mobile-nav { padding-bottom: 80px; }
        .solution-box { border-left: 4px solid #10B981; background-color: #ECFDF5; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <div id="mobileBackdrop" class="sidebar-backdrop" onclick="closeAllSidebars()"></div>

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 text-center animate-fade-in relative overflow-hidden overflow-y-auto max-h-full">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fa-solid fa-graduation-cap"></i></div>
            
            <h1 id="lobbyTitle" class="text-2xl font-extrabold text-gray-800 mb-2">ƒêang t·∫£i...</h1>
            <div id="accessDeniedMsg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 mb-4 text-sm font-bold animate-pulse text-left"><i class="fa-solid fa-ban mr-2"></i> B·∫°n kh√¥ng thu·ªôc l·ªõp ƒë∆∞·ª£c giao ƒë·ªÅ n√†y!</div>
            
            <div class="bg-blue-50 p-4 rounded-xl text-left text-sm text-blue-800 mb-4 space-y-2 border border-blue-100">
                <p class="font-bold border-b border-blue-200 pb-1"><i class="fa-solid fa-circle-info mr-2"></i>H∆∞·ªõng d·∫´n l√†m b√†i:</p>
                <ul class="list-disc pl-5 space-y-1 text-xs md:text-sm">
                    <li>C√¢u tr·∫£ l·ªùi ng·∫Øn ch·ªâ nh·∫≠p s·ªë ho·∫∑c ch·ªØ, kh√¥ng nh·∫≠p ƒë∆°n v·ªã.</li>
                    <li>S·ª≠ d·ª•ng gi·∫•y nh√°p ƒë·ªÉ t√≠nh to√°n c·∫©n th·∫≠n.</li>
                    <li>B·∫•m n√∫t (<i class="fa-regular fa-flag"></i>) ƒë·ªÉ ƒë√°nh d·∫•u c√¢u kh√≥ xem l·∫°i sau.</li>
                </ul>
            </div>

            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between"><span class="text-gray-500"><i class="fa-regular fa-clock mr-1"></i> Th·ªùi gian:</span><span class="font-bold text-gray-800"><span id="lobbyDuration">--</span> ph√∫t</span></div>
                <div class="flex justify-between"><span class="text-gray-500">S·ªë l∆∞·ª£t:</span><span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span></div>
                <div class="flex justify-between hidden" id="lobbyTimeRange"><span class="text-gray-500">M·ªü ƒë·ªÅ:</span><span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span></div>
                <div class="flex justify-between pt-2 border-t border-gray-200"><span class="text-gray-500">Tr·∫°ng th√°i:</span><span id="lobbyStatusBadge" class="font-bold text-gray-700">Checking...</span></div>
            </div>
            
            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all shadow-md flex items-center justify-center gap-2 cursor-not-allowed"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            <button onclick="window.location.href='dashboard.html'" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Quay l·∫°i Dashboard</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 lg:px-8 hidden">
        <div class="flex items-center gap-4">
            <button onclick="window.history.back()" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center font-bold"><i class="fa-solid fa-pen-nib"></i></div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[150px] md:max-w-xs">B√†i thi</h1>
                <p class="text-[10px] md:text-xs text-gray-500">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3 md:gap-6">
            <div id="cheatWarning" class="hidden flex items-center gap-1 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> <span id="cheatCount">0</span> vi ph·∫°m</div>
            <div class="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg"><i class="fa-regular fa-clock text-orange-400 animate-pulse"></i><span id="timer" class="font-mono font-bold text-lg md:text-xl tracking-widest">00:00</span></div>
            <button onclick="checkFinish()" class="hidden md:block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md shadow-blue-200">N·ªôp b√†i</button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden relative">
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar relative pb-mobile-nav" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 min-h-full p-6 md:p-10 relative">
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">C√ÇU H·ªéI</span>
                        <h2 class="text-lg font-bold text-gray-400">C√¢u s·ªë <span id="currentQNum">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-red-500 transition-colors" title="ƒê√°nh d·∫•u"><i class="fa-regular fa-flag text-xl"></i></button>
                </div>
                <div id="questionContent" class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed mb-8"></div>
                <div id="answerOptions" class="space-y-3"></div>
            </div>
        </div>

        <aside id="paletteSidebar" class="mobile-sidebar bg-white border-l border-gray-200 md:relative md:transform-none md:w-80 md:flex md:z-10 md:shadow-none">
            <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-gray-700">Danh s√°ch c√¢u h·ªèi</h3>
                    <div class="flex flex-wrap gap-3 mt-3 text-xs text-gray-500">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded-sm"></span> ƒêang l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-200 rounded-sm"></span> ƒê√£ l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-white border border-red-200 rounded-sm flex items-center justify-center"><i class="fa-solid fa-flag text-[8px] text-red-500"></i></span> C·ªù</div>
                    </div>
                </div>
                <button onclick="closeAllSidebars()" class="md:hidden text-gray-400 hover:text-red-500 text-xl px-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 no-scrollbar">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
            <div class="p-5 border-t border-gray-200 hidden md:block">
                 <button onclick="checkFinish()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all">N·ªôp b√†i thi</button>
            </div>
        </aside>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 grid grid-cols-4 gap-2 z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom">
            <button id="prevBtnMob" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="toggleMobilePalette('paletteSidebar')" class="py-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100"><i class="fa-solid fa-list-ol"></i></button>
            <button id="nextBtnMob" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-chevron-right"></i></button>
            <button onclick="checkFinish()" class="py-2.5 bg-red-600 text-white font-bold rounded-lg text-xs uppercase flex items-center justify-center gap-1 shadow-md"><i class="fa-solid fa-paper-plane"></i> N·ªôp</button>
        </div>
        
        <div class="hidden md:flex fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-2xl border border-gray-100 gap-4 items-center z-40">
            <button id="prevBtn" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-sm font-bold text-gray-500"><span id="navCurrent">1</span> / <span id="navTotal">--</span></span>
            <button id="nextBtn" class="w-10 h-10 rounded-full bg-orange-custom hover:bg-orange-600 text-white flex items-center justify-center shadow-md shadow-orange-200 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </main>

    <div id="solutionView" class="hidden fixed inset-0 z-[90] bg-gray-50 flex h-full">
        <aside id="solutionSidebar" class="mobile-sidebar bg-white border-r border-gray-200 md:relative md:transform-none md:w-80 md:flex md:z-10">
            <div class="p-5 border-b border-gray-200 bg-white flex justify-between items-center shadow-sm">
                <h3 class="font-bold text-gray-700">K·∫øt qu·∫£ chi ti·∫øt</h3>
                <button onclick="closeAllSidebars()" class="md:hidden text-gray-400 hover:text-red-500 text-xl px-2"><i class="fa-solid fa-xmark"></i></button>
                <button onclick="window.location.href='dashboard.html'" class="hidden md:block text-xs font-bold text-gray-500 hover:text-blue-600">Tho√°t</button>
            </div>
            <div class="p-4 border-b border-gray-200 bg-white">
                 <h4 class="text-xs font-bold text-blue-600 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> L·ªãch s·ª≠ l√†m b√†i</h4>
                <div class="bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                    <table class="w-full text-[10px] text-left text-gray-600">
                        <thead class="bg-gray-100 text-gray-500 font-bold uppercase"><tr><th class="px-2 py-1.5">L·∫ßn</th><th class="px-2 py-1.5 text-center">ƒêi·ªÉm</th><th class="px-2 py-1.5 text-right">Ng√†y n·ªôp</th></tr></thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-3 border-b border-gray-100 bg-white text-xs flex gap-3 text-gray-500 justify-center">
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> ƒê√∫ng</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-sm"></span> Sai</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 rounded-sm"></span> 1 ph·∫ßn</div>
            </div>
            <div class="flex-1 overflow-y-auto p-5 no-scrollbar"><div class="grid grid-cols-5 gap-3" id="solutionPalette"></div></div>
        </aside>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth bg-gray-100 w-full pb-mobile-nav" id="solutionContentArea">
            <div class="md:hidden mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                 <h3 class="font-bold text-gray-800">K·∫øt qu·∫£ chi ti·∫øt</h3>
                 <button onclick="window.location.href='dashboard.html'" class="px-3 py-1.5 bg-gray-100 rounded text-xs font-bold">Tho√°t</button>
            </div>
            <div class="max-w-4xl mx-auto space-y-6 pb-20" id="solutionList"></div>
        </div>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 grid grid-cols-3 gap-2 z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom">
            <button onclick="window.location.href='dashboard.html'" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold text-sm">Tho√°t</button>
            <button onclick="toggleMobilePalette('solutionSidebar')" class="py-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100"><i class="fa-solid fa-list-ol"></i> DS</button>
            <button onclick="document.getElementById('solutionContentArea').scrollTo({top:0, behavior:'smooth'})" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-arrow-up"></i> L√™n</button>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Th√¥ng b√°o</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">N·ªôi dung...</p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">H·ªßy b·ªè</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÅ thi</h3>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="M·∫≠t kh·∫©u...">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm">H·ªßy</button><button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">V√†o thi</button></div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div id="resultIcon" class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üí™</div>
            <h2 class="text-2xl font-extrabold text-gray-800 mb-2" id="resultTitle">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6 text-sm" id="resultMsg">ƒê√£ n·ªôp b√†i th√†nh c√¥ng.</p>
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-6 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">ƒê√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            <div class="space-y-3">
                <button id="btnViewSolution" onclick="viewDetailSolutions()" class="w-full py-3 rounded-xl bg-orange-100 text-orange-600 font-bold hover:bg-orange-200 transition-colors hidden"><i class="fa-solid fa-eye mr-2"></i> Xem l·ªùi gi·∫£i chi ti·∫øt</button>
                <button onclick="window.location.href='dashboard.html'" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">V·ªÅ trang ch·ªß</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let currentUser, examData, examId;
        let currentQuestions = [], userAnswers = {}, flaggedQuestions = {};
        let currentIndex = 0, timerInterval, timeLeft = 0, cheatCount = 0, isExamActive = false;
        window.examHistory = [];
        
        const dom = { lobby: document.getElementById('lobbyScreen'), header: document.getElementById('examHeader'), main: document.getElementById('examMain'), content: document.getElementById('questionContent'), options: document.getElementById('answerOptions'), palette: document.getElementById('questionPalette'), timer: document.getElementById('timer'), badge: document.getElementById('questionTypeBadge') };
        
        // MODAL HELPERS
        let modalResolve = null;
        const modalEl = document.getElementById('customModal'), modalBox = document.getElementById('customModalBox'), modalTitle = document.getElementById('modalTitle'), modalMsg = document.getElementById('modalMessage'), btnConfirm = document.getElementById('btnConfirm'), btnCancel = document.getElementById('btnCancel');
        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if(modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (msg, type='info') => { return new Promise(resolve => { modalTitle.innerText=type==='error'?'L·ªói':'Th√¥ng b√°o'; modalMsg.innerText=msg; btnCancel.classList.add('hidden'); btnConfirm.innerText="ƒê√£ hi·ªÉu"; modalEl.classList.remove('opacity-0','pointer-events-none'); modalBox.classList.add('scale-100'); btnConfirm.onclick=()=>{resolve(true);closeCustomModal();}; }); };
        window.customConfirm = (msg) => { return new Promise(resolve => { modalTitle.innerText="X√°c nh·∫≠n"; modalMsg.innerText=msg; btnCancel.classList.remove('hidden'); btnConfirm.innerText="ƒê·ªìng √Ω"; modalEl.classList.remove('opacity-0','pointer-events-none'); modalBox.classList.add('scale-100'); btnConfirm.onclick=()=>{resolve(true);closeCustomModal();}; btnCancel.onclick=()=>{resolve(false);closeCustomModal();}; }); };

        // --- H√ÄM X·ª¨ L√ù FORMAT VƒÇN B·∫¢N (FIX L·ªñI XU·ªêNG D√íNG) ---
        function formatContent(text) {
            if (text === null || text === undefined) return "";
            let s = String(text);
            // Thay th·∫ø \n th√†nh <br>
            s = s.replace(/\n/g, '<br>');
            // Thay th·∫ø \\ th√†nh <br> n·∫øu kh√¥ng n·∫±m trong c√¥ng th·ª©c to√°n
            // Logic: Ch·ªâ replace n·∫øu kh√¥ng n·∫±m gi·ªØa $$ ho·∫∑c \[ \]
            // (ƒê∆°n gi·∫£n h√≥a: Replace h·∫øt v√¨ MathJax s·∫Ω t·ª± x·ª≠ l√Ω l·∫°i n·∫øu c·∫ßn, ho·∫∑c ƒë·ªÉ an to√†n ch·ªâ replace \n)
            // Tuy nhi√™n user y√™u c·∫ßu fix l·ªói \\ xu·ªëng d√≤ng trong text. 
            // Ta s·∫Ω thay th·∫ø \\ th√†nh <br> nh∆∞ng c·∫©n th·∫≠n. 
            // T·ªët nh·∫•t l√† replace \\ (c√≥ kho·∫£ng tr·∫Øng ho·∫∑c cu·ªëi d√≤ng)
            s = s.replace(/\\\\/g, '<br>'); 
            return s;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const p = new URLSearchParams(window.location.search);
                examId = p.get('id');
                if(!examId) { window.location.href='dashboard.html'; return; }
                document.getElementById('examIdDisplay').textContent = examId;
                await loadLobby(examId);
            } else window.location.href = 'index.html';
        });

        async function loadLobby(id) {
            try {
                const s = await getDoc(doc(db, "exams", id));
                if(!s.exists()) { document.getElementById('lobbyTitle').textContent = "ƒê·ªÅ kh√¥ng t·ªìn t·∫°i"; return; }
                examData = s.data();
                
                const q = query(collection(db, "results"), where("examId","==",id), where("studentId","==",currentUser.uid));
                const snap = await getDocs(q);
                window.examHistory = [];
                snap.forEach(d => window.examHistory.push(d.data()));
                window.examHistory.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
                const att = window.examHistory.length;

                if (new URLSearchParams(window.location.search).get('mode') === 'review') {
                    if (att > 0) {
                        currentQuestions = examData.questions || [];
                        userAnswers = window.examHistory[0].answers || {};
                        document.getElementById('lobbyScreen').classList.add('hidden');
                        viewDetailSolutions(); return;
                    }
                }

                document.getElementById('lobbyTitle').textContent = examData.title;
                document.getElementById('lobbyDuration').textContent = examData.duration || '‚àû';
                document.getElementById('lobbyAttempts').textContent = att;
                document.getElementById('lobbyMaxAttempts').textContent = examData.attempts || '‚àû';

                let ok = true, msg = "S·∫µn s√†ng", color = "text-green-600";
                
                if (examData.accessType === 'class' && examData.allowedClassId) {
                    const clSnap = await getDoc(doc(db, "classes", examData.allowedClassId));
                    if(clSnap.exists()) {
                        const sts = clSnap.data().students || [];
                        const me = currentUser.email.toLowerCase();
                        if(!sts.some(s => (s.email||s.username+'@hocsinh.com').toLowerCase()===me)) {
                            ok=false; document.getElementById('accessDeniedMsg').classList.remove('hidden');
                        }
                    } else { ok=false; msg="L·ªõp b·ªã x√≥a"; color="text-red-600"; }
                }

                const now = new Date();
                if(examData.startTime && now < new Date(examData.startTime)) { ok=false; msg="Ch∆∞a ƒë·∫øn gi·ªù"; color="text-orange-500"; document.getElementById('lobbyTimeRange').classList.remove('hidden'); document.getElementById('lobbyTimeText').textContent=new Date(examData.startTime).toLocaleString('vi-VN'); }
                if(examData.endTime && now > new Date(examData.endTime)) { ok=false; msg="ƒê√£ h·∫øt h·∫°n"; color="text-red-500"; }
                if(examData.attempts > 0 && att >= examData.attempts) { ok=false; msg="H·∫øt l∆∞·ª£t"; color="text-red-500"; }

                const stat = document.getElementById('lobbyStatusBadge');
                stat.textContent = msg; stat.className = `font-bold ${color}`;
                
                const btn = document.getElementById('btnStartExam');
                if(ok) { btn.disabled=false; btn.classList.replace('bg-gray-300','bg-blue-600'); btn.classList.remove('cursor-not-allowed'); }
                else { btn.disabled=true; btn.classList.replace('bg-blue-600','bg-gray-300'); btn.classList.add('cursor-not-allowed'); }

            } catch(e) { console.error(e); window.customAlert("L·ªói t·∫£i: "+e.message); }
        }

        window.requestStart = () => { if(examData.password) document.getElementById('passwordModal').classList.remove('hidden'); else startExam(); }
        window.verifyPassword = () => { if(document.getElementById('examPasswordInput').value===examData.password) { document.getElementById('passwordModal').classList.add('hidden'); startExam(); } else window.customAlert("Sai m·∫≠t kh·∫©u","error"); }

        function startExam() {
            dom.lobby.classList.add('hidden');
            dom.header.classList.remove('hidden'); dom.main.classList.remove('hidden');
            currentQuestions = [...(examData.questions || [])];
            if(examData.shuffle) currentQuestions.sort(()=>Math.random()-0.5);
            
            timeLeft = (examData.duration||45)*60;
            if(timeLeft>0) runTimer(); else dom.timer.textContent="‚àû";
            
            if(examData.proctoring) {
                document.getElementById('cheatWarning').classList.remove('hidden');
                window.addEventListener('blur', () => { if(isExamActive) { cheatCount++; document.getElementById('cheatCount').textContent = cheatCount; } });
            }
            
            isExamActive = true;
            renderPalette(); renderQuestion(0);
            try{document.documentElement.requestFullscreen().catch(()=>{});}catch(e){}
        }

        function runTimer() {
            updateTimer();
            timerInterval = setInterval(() => { timeLeft--; updateTimer(); if(timeLeft<=0) { clearInterval(timerInterval); submitReal(true); } }, 1000);
        }
        function updateTimer() { const m=Math.floor(timeLeft/60), s=timeLeft%60; dom.timer.textContent=`${m<10?'0'+m:m}:${s<10?'0'+s:s}`; if(timeLeft<300) dom.timer.parentElement.classList.add('bg-red-50','text-red-600'); }

        function renderQuestion(idx) {
            currentIndex = idx;
            const q = currentQuestions[idx];
            document.getElementById('currentQNum').textContent = idx + 1;
            
            const badge = dom.badge;
            badge.textContent = q.type==='mc'?'TR·∫ÆC NGHI·ªÜM':(q.type==='tf'?'ƒê√öNG/SAI':(q.type==='short'?'TR·∫¢ L·ªúI NG·∫ÆN':'T·ª∞ LU·∫¨N'));
            
            dom.content.innerHTML = formatContent(q.content);
            dom.options.innerHTML = '';

            const fb = document.getElementById('flagBtn');
            fb.className = flaggedQuestions[idx] ? "text-red-500 text-2xl" : "text-gray-300 hover:text-red-500 text-2xl";
            fb.innerHTML = flaggedQuestions[idx] ? '<i class="fa-solid fa-flag"></i>' : '<i class="fa-regular fa-flag"></i>';

            if(q.type === 'mc') {
                q.options.forEach((opt, i) => {
                    const checked = userAnswers[idx] === i;
                    const div = document.createElement('label'); div.className = "block cursor-pointer group w-full";
                    div.innerHTML = `<input type="radio" name="q" class="hidden custom-radio" ${checked?'checked':''}><div class="flex items-start p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 group-hover:bg-blue-50 group-hover:shadow-sm h-full"><div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400 shrink-0 mt-0.5">${String.fromCharCode(65+i)}</div><div class="flex-1 text-gray-700 leading-relaxed">${formatContent(opt)}</div></div>`;
                    div.querySelector('input').onchange = () => { userAnswers[idx]=i; updatePalette(); };
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 q.statements.forEach((stmt, i) => {
                    const val = userAnswers[idx]?userAnswers[idx][i]:null;
                    const div = document.createElement('div'); div.className = "bg-white border-2 border-gray-100 rounded-xl p-4 hover:border-orange-200 transition-all";
                    div.innerHTML = `<div class="font-medium text-gray-800 mb-2">${formatContent(stmt.text)}</div><div class="flex gap-4"><label class="flex-1 cursor-pointer"><input type="radio" name="tf-${idx}-${i}" value="true" ${val===true?'checked':''} class="mr-2">ƒê√∫ng</label><label class="flex-1 cursor-pointer"><input type="radio" name="tf-${idx}-${i}" value="false" ${val===false?'checked':''} class="mr-2">Sai</label></div>`;
                    div.querySelectorAll('input').forEach(inp => inp.onchange = (e) => {
                        if(!userAnswers[idx]) userAnswers[idx]={}; userAnswers[idx][i]=(e.target.value==='true'); updatePalette();
                    });
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'short') {
                const inp = document.createElement('input');
                inp.className = "w-full p-4 border-2 rounded-xl font-bold text-lg outline-none focus:border-green-500";
                inp.placeholder = "Nh·∫≠p ƒë√°p √°n...";
                inp.value = userAnswers[idx] || '';
                inp.onchange = (e) => { userAnswers[idx]=e.target.value; updatePalette(); };
                dom.options.appendChild(inp);
            } else { 
                const ta = document.createElement('textarea');
                ta.className = "w-full p-4 border-2 rounded-xl min-h-[200px] outline-none focus:border-purple-500";
                ta.placeholder = "Nh·∫≠p b√†i l√†m...";
                ta.value = userAnswers[idx] || '';
                ta.onchange = (e) => { userAnswers[idx]=e.target.value; updatePalette(); };
                dom.options.appendChild(ta);
            }

            if(window.MathJax) setTimeout(() => MathJax.typesetPromise([dom.content, dom.options]).catch(()=>{}), 50);
            updatePalette();
            closeAllSidebars();
        }

        function updatePalette() {
            dom.palette.innerHTML = '';
            currentQuestions.forEach((q, i) => {
                const btn = document.createElement('button'); btn.className = "q-btn"; btn.textContent = i+1;
                if(i===currentIndex) btn.classList.add('active');
                else if(flaggedQuestions[i]) btn.classList.add('flagged');
                else {
                    const a = userAnswers[i];
                    let done = (a!==undefined && a!==null && a!=="");
                    if(q.type==='tf' && typeof a==='object') done = Object.keys(a).length>0;
                    if(done) btn.classList.add('answered');
                }
                btn.onclick = () => renderQuestion(i);
                dom.palette.appendChild(btn);
            });
            
            document.getElementById('prevBtnMob').disabled = currentIndex===0;
            document.getElementById('nextBtnMob').disabled = currentIndex===currentQuestions.length-1;
            document.getElementById('prevBtnMob').classList.toggle('opacity-50', currentIndex===0);
            document.getElementById('nextBtnMob').classList.toggle('opacity-50', currentIndex===currentQuestions.length-1);
        }
        function renderPalette() { updatePalette(); }

        window.toggleMobilePalette = (id) => {
            const sb = document.getElementById(id); const bd = document.getElementById('mobileBackdrop');
            if(sb.classList.contains('open')) { sb.classList.remove('open'); bd.classList.remove('show'); }
            else { sb.classList.add('open'); bd.classList.add('show'); }
        }
        window.closeAllSidebars = () => {
            document.getElementById('paletteSidebar').classList.remove('open');
            document.getElementById('solutionSidebar').classList.remove('open');
            document.getElementById('mobileBackdrop').classList.remove('show');
        }

        window.toggleFlag = () => { flaggedQuestions[currentIndex] = !flaggedQuestions[currentIndex]; renderQuestion(currentIndex); }

        window.checkFinish = () => {
            let left = 0;
            currentQuestions.forEach((q,i) => {
                const a = userAnswers[i];
                let done = (a!==undefined && a!==null && a!=="");
                if(q.type==='tf' && typeof a==='object') done = Object.keys(a).length === (q.statements?.length||0);
                if(!done) left++;
            });
            if(left>0) window.customConfirm(`C√≤n ${left} c√¢u ch∆∞a l√†m. N·ªôp lu√¥n?`).then(y => { if(y) submitReal(); });
            else submitReal();
        }

        async function submitReal(auto=false) {
            isExamActive = false;
            clearInterval(timerInterval);
            
            let correct = 0;
            const normalize = (s) => String(s).replace(/\$| /g,'').toLowerCase().trim();
            
            currentQuestions.forEach((q,i) => {
                const u = userAnswers[i];
                if(q.type==='mc' && u===q.correct) correct++;
                if(q.type==='short' && q.answer && u && normalize(u)===normalize(q.answer)) correct++;
                if(q.type==='tf' && u && q.statements) {
                    let matches=0; q.statements.forEach((s,si) => { if(u[si]===s.isTrue) matches++; });
                    if(matches === q.statements.length) correct++;
                }
            });
            const score = parseFloat((correct * (10/currentQuestions.length)).toFixed(2));

            try {
                await addDoc(collection(db, "results"), {
                    examId, studentId: currentUser.uid, studentName: currentUser.displayName||currentUser.email,
                    score, answers: userAnswers, cheatCount, correctCount: correct, totalQuestions: currentQuestions.length,
                    submittedAt: new Date().toISOString()
                });
                
                document.getElementById('scoreDisplay').textContent = score;
                document.getElementById('correctCount').textContent = `${correct}/${currentQuestions.length}`;
                
                if (examData.showScore === 'immediate' || (examData.showScore === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('scoreSection').classList.remove('hidden');
                }
                if (examData.showResult === 'immediate' || (examData.showResult === 'after_exam' && timeLeft <= 0)) {
                    document.getElementById('btnViewSolution').classList.remove('hidden');
                }
                
                document.getElementById('resultModal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('resultModal').classList.remove('opacity-0'); document.getElementById('resultModalContent').classList.add('scale-100'); }, 50);
            } catch(e) { window.customAlert("L·ªói l∆∞u b√†i: "+e.message, "error"); }
        }

        window.viewDetailSolutions = () => {
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('examMain').classList.add('hidden');
            document.getElementById('examHeader').classList.add('hidden');
            document.getElementById('solutionView').classList.remove('hidden');
            
            const list = document.getElementById('solutionList');
            const pal = document.getElementById('solutionPalette');
            list.innerHTML = ''; pal.innerHTML = '';
            
            const historyBody = document.getElementById('historyTableBody');
            historyBody.innerHTML = '';
            if (window.examHistory && window.examHistory.length > 0) {
                window.examHistory.forEach((h, idx) => {
                    const date = new Date(h.submittedAt);
                    historyBody.innerHTML += `<tr class="border-b border-gray-50"><td class="px-2 py-2">#${window.examHistory.length - idx}</td><td class="px-2 py-2 text-center text-blue-600 font-bold">${h.score}</td><td class="px-2 py-2 text-right text-gray-400 text-xs">${date.getDate()}/${date.getMonth()+1}</td></tr>`;
                });
            }

            const normalize = (str) => String(str).replace(/\$| /g, '').toLowerCase().trim();
            currentQuestions.forEach((q, idx) => {
                const u = userAnswers[idx];
                let isCorrect = false;
                let ansHtml = '';
                
                if(q.type==='mc') {
                    isCorrect = (u===q.correct);
                    ansHtml = `<div>B·∫°n ch·ªçn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u!==undefined?String.fromCharCode(65+u):'Ch∆∞a l√†m'}</b> | ƒê√°p √°n: <b class="text-green-600">${String.fromCharCode(65+q.correct)}</b></div>`;
                } else if (q.type==='short') {
                    isCorrect = (q.answer && u && normalize(u)===normalize(q.answer));
                    ansHtml = `<div>B·∫°n ƒëi·ªÅn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u||'Tr·ªëng'}</b> | ƒê√°p √°n: <b class="text-green-600">${q.answer}</b></div>`;
                } else if (q.type==='tf') {
                    let matches=0;
                    ansHtml='<ul class="text-sm mt-2">';
                    q.statements.forEach((s,i)=>{
                        const uc = (u&&u[i]!==undefined)?(u[i]?'ƒê':'S'):'_';
                        const tc = s.isTrue?'ƒê':'S';
                        const m = (u&&u[i]===s.isTrue);
                        if(m) matches++;
                        ansHtml+=`<li>- ${formatContent(s.text)}: <b class="${m?'text-green-600':'text-red-500'}">${uc}</b> (ƒê√∫ng: ${tc})</li>`;
                    });
                    ansHtml+='</ul>';
                    isCorrect = (matches === q.statements.length);
                }

                const btn = document.createElement('button');
                btn.className = `q-btn ${isCorrect?'correct':(isCorrect===false?'wrong':'partial')}`;
                btn.textContent = idx+1;
                btn.onclick = () => { document.getElementById(`sol-q-${idx}`).scrollIntoView({behavior:'smooth', block:'center'}); closeAllSidebars(); };
                pal.appendChild(btn);

                const item = document.createElement('div');
                item.id = `sol-q-${idx}`;
                item.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-200";
                item.innerHTML = `
                    <div class="font-bold text-gray-500 text-sm mb-2">C√¢u ${idx+1} (${q.type.toUpperCase()})</div>
                    <div class="mb-4 text-gray-800 text-lg">${formatContent(q.content)}</div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3">${ansHtml}</div>
                    ${q.solution ? `<div class="solution-box"><div class="font-bold text-green-700 mb-1">L·ªùi gi·∫£i:</div><div class="text-gray-700">${formatContent(q.solution)}</div></div>` : ''}
                `;
                list.appendChild(item);
            });
            
            if(window.MathJax) setTimeout(() => MathJax.typesetPromise([list]).catch(()=>{}), 100);
        }

        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtn').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        document.getElementById('prevBtnMob').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
    </script>
</body>
</html>
