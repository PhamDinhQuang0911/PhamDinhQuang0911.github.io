<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√†m b√†i thi - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    // --- C·∫§U H√åNH MATHJAX ---
    window.MathJax = {
      loader: { load: ['[tex]/noerrors', '[tex]/noundefined'] },
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors', 'noundefined']},
        macros: {
          heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
          hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ",
          R: "\\mathbb{R}",
          N: "\\mathbb{N}",
          Z: "\\mathbb{Z}",
          vectors: ["\\overrightarrow{#1}", 1],
          mtx: ["\\left[\\begin{matrix}#1\\end{matrix}\\right]", 1]
        }
      },
      options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; overscroll-behavior-y: none; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        
        /* CSS SIDEBAR MOBILE */
        .mobile-sidebar { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: white; z-index: 50; transform: translateX(100%); transition: transform 0.3s ease-in-out; box-shadow: -5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .mobile-sidebar.open { transform: translateX(0); }
        .sidebar-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar-backdrop.show { opacity: 1; pointer-events: auto; }

        /* CSS N√öT C√ÇU H·ªéI */
        .q-btn { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 1px solid #E5E7EB; background-color: white; color: #4B5563; transition: all 0.2s; position: relative; cursor: pointer; }
        .q-btn.active { background-color: #FF6A00 !important; color: white !important; border-color: #FF6A00 !important; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(255, 106, 0, 0.3); z-index: 10; }
        .q-btn.answered { background-color: #EFF6FF; color: #2563EB; border-color: #BFDBFE; }
        .q-btn.flagged::after { content: "\f024"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: -4px; right: -4px; font-size: 10px; color: #EF4444; background: #FEF2F2; border-radius: 50%; padding: 2px; border: 1px solid #FECACA; }
        .q-btn.correct { background-color: #10B981 !important; color: white !important; border-color: #059669 !important; }
        .q-btn.wrong { background-color: #EF4444 !important; color: white !important; border-color: #DC2626 !important; }
        .q-btn.partial { background-color: #F59E0B !important; color: white !important; border-color: #D97706 !important; }

        /* CSS ·∫¢NH & MATHJAX */
        /* CSS ·∫¢NH & MATHJAX (ƒê√É T·ªêI ∆ØU MOBILE) */
        /* 1. Thu h·∫πp kho·∫£ng c√°ch ·∫£nh (margin: 2px) */
        /* CSS ·∫¢NH & MATHJAX (B·∫¢N UPDATE: SI√äU S√ÅT V·ªöI CH·ªÆ) */
        
        /* 1. C·∫•u h√¨nh ·∫£nh: ƒê∆∞a margin v·ªÅ 0 ho·∫∑c r·∫•t nh·ªè */
        /* CSS ·∫¢NH & MATHJAX (B·∫¢N FINAL: S√ÅT TUY·ªÜT ƒê·ªêI) */
        
        /* 1. ·∫¢nh: Kh√¥ng c√≤n kho·∫£ng c√°ch n√†o (Margin 0) */
        #questionContent img, #answerOptions img, .solution-box img { 
            max-width: 100% !important; 
            height: auto !important; 
            display: block; 
            margin: 0 auto !important; /* X√≥a s·∫°ch l·ªÅ */
            padding: 0 !important;
            border-radius: 4px; 
        }
        
        /* 2. VƒÉn b·∫£n: √âp d√≤ng s√°t l·∫°i (Line-height th·∫•p) */
        #questionContent, .solution-box, #answerOptions { 
            line-height: 1.25 !important; /* M·ª©c th·∫•p nh·∫•t d·ªÖ ƒë·ªçc */
            font-size: 16px; 
            text-align: justify; 
        }

        /* 3. ƒêo·∫°n vƒÉn (P): X√≥a kho·∫£ng c√°ch gi·ªØa c√°c ƒëo·∫°n */
        #questionContent p, .solution-box p, #answerOptions p {
            margin-top: 0 !important;
            margin-bottom: 0 !important; /* S√°t d√≠nh v√†o nhau */
            padding: 0 !important;
        }
        
        /* 4. C√¥ng th·ª©c To√°n: S√°t v√†o d√≤ng ch·ªØ */
        mjx-container:not([display="true"]) { margin: 0 !important; }
        
        mjx-container[display="true"] { 
            display: block !important; 
            margin: 2px 0 !important; /* Ch·ªâ ch·ª´a 2px t√≠ x√≠u ƒë·ªÉ kh√¥ng ƒë√® l√™n ch·ªØ */
            padding: 0 !important;
            max-width: 100%;
            overflow-x: auto; 
            overflow-y: hidden !important; 
        }

        /* 5. Mobile: Thu nh·ªè c√¥ng th·ª©c ƒë·ªÉ v·ª´a m√†n h√¨nh */
        @media (max-width: 640px) {
            mjx-container {
                font-size: 85% !important;
            }
            mjx-container[display="true"] {
                max-width: 100vw !important;
                font-size: 80% !important;
            }
            #questionContent {
                padding: 0 !important;
            }
        }
        mjx-assistive-mml { display: none !important; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-radio:checked + div { border-color: #FF6A00; background-color: #FFF7ED; color: #C2410C; font-weight: bold; }
        .custom-radio:checked + div .check-circle { background-color: #FF6A00; border-color: #FF6A00; color: white; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* [FIX MOBILE] TƒÉng padding ƒë√°y v√† x·ª≠ l√Ω cu·ªôn m∆∞·ª£t */
        .pb-mobile-nav { 
            padding-bottom: 180px !important; /* TƒÉng m·∫°nh t·ª´ 80px l√™n 180px ƒë·ªÉ tr√°nh b·ªã footer che ho√†n to√†n */
        }

        /* K√≠ch ho·∫°t cu·ªôn m∆∞·ª£t cho v√πng c√¢u h·ªèi */
        #questionArea {
            -webkit-overflow-scrolling: touch; /* Cu·ªôn m∆∞·ª£t tr√™n iPhone/iPad */
            scroll-behavior: smooth;
            overscroll-behavior: contain; /* NgƒÉn vi·ªác k√©o tr√¥i c·∫£ trang web */
        }

        /* X·ª≠ l√Ω v√πng an to√†n cho iPhone ƒë·ªùi m·ªõi (Tai th·ªè/Dynamic Island) */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
            padding-bottom: constant(safe-area-inset-bottom);
        }

        /* ƒê·∫£m b·∫£o thanh ƒëi·ªÅu h∆∞·ªõng n·ªïi l√™n tr√™n v√† c√≥ hi·ªáu ·ª©ng k√≠nh m·ªù */
        .fixed.bottom-0 {
            z-index: 50 !important;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .solution-box { border-left: 4px solid #10B981; background-color: #ECFDF5; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .origin-top-left { transform-origin: top left; }
        .image-placeholder, .group.relative .absolute { display: none !important; }
        .text-\[10px\], .text-xs.font-bold.text-blue-700 { display: none !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-gray-50">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <div class="fixed top-0 left-0 w-full h-1.5 bg-gray-200 z-[60]">
        <div id="examProgressBar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all duration-500 ease-out shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: 0%"></div>
    </div>

    <div id="mobileBackdrop" class="sidebar-backdrop" onclick="closeAllSidebars()"></div>

    <div id="lobbyScreen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 text-center animate-fade-in relative overflow-hidden overflow-y-auto max-h-full">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fa-solid fa-graduation-cap"></i></div>
            
            <h1 id="lobbyTitle" class="text-2xl font-extrabold text-gray-800 mb-2">ƒêang t·∫£i...</h1>
            <div id="accessDeniedMsg" class="hidden bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 mb-4 text-sm font-bold animate-pulse text-left"><i class="fa-solid fa-ban mr-2"></i> B·∫°n kh√¥ng thu·ªôc l·ªõp ƒë∆∞·ª£c giao ƒë·ªÅ n√†y!</div>
            
            <div class="bg-blue-50 p-4 rounded-xl text-left text-sm text-blue-800 mb-4 space-y-2 border border-blue-100">
                <p class="font-bold border-b border-blue-200 pb-1"><i class="fa-solid fa-circle-info mr-2"></i>H∆∞·ªõng d·∫´n l√†m b√†i:</p>
                <ul class="list-disc pl-5 space-y-1 text-xs md:text-sm">
                    <li>C√¢u tr·∫£ l·ªùi ng·∫Øn ch·ªâ nh·∫≠p s·ªë ho·∫∑c ch·ªØ, kh√¥ng nh·∫≠p ƒë∆°n v·ªã.</li>
                    <li>S·ª≠ d·ª•ng gi·∫•y nh√°p ƒë·ªÉ t√≠nh to√°n c·∫©n th·∫≠n.</li>
                    <li>B·∫•m n√∫t (<i class="fa-regular fa-flag"></i>) ƒë·ªÉ ƒë√°nh d·∫•u c√¢u kh√≥ xem l·∫°i sau.</li>
                </ul>
            </div>

            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left space-y-3 text-sm border border-gray-200">
                <div class="flex justify-between"><span class="text-gray-500"><i class="fa-regular fa-clock mr-1"></i> Th·ªùi gian:</span><span class="font-bold text-gray-800"><span id="lobbyDuration">--</span> ph√∫t</span></div>
                <div class="flex justify-between"><span class="text-gray-500">S·ªë l∆∞·ª£t:</span><span class="font-bold text-gray-800"><span id="lobbyAttempts">0</span> / <span id="lobbyMaxAttempts">--</span></span></div>
                <div class="flex justify-between hidden" id="lobbyTimeRange"><span class="text-gray-500">M·ªü ƒë·ªÅ:</span><span id="lobbyTimeText" class="font-bold text-gray-800 text-xs text-right">--</span></div>
                <div class="flex justify-between pt-2 border-t border-gray-200"><span class="text-gray-500">Tr·∫°ng th√°i:</span><span id="lobbyStatusBadge" class="font-bold text-gray-700">Checking...</span></div>
            </div>
            
            <button id="btnStartExam" onclick="requestStart()" disabled class="w-full py-3.5 bg-gray-300 text-white font-bold rounded-xl transition-all shadow-md flex items-center justify-center gap-2 cursor-not-allowed"><i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            <button onclick="window.location.href='dashboard.html'" class="mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Quay l·∫°i Dashboard</button>
        </div>
    </div>

    <header id="examHeader" class="bg-white shadow-sm z-20 shrink-0 h-16 flex items-center justify-between px-4 lg:px-8 hidden">
        <div class="flex items-center gap-4">
            <button onclick="window.history.back()" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center font-bold"><i class="fa-solid fa-pen-nib"></i></div>
            <div>
                <h1 id="examTitle" class="text-sm md:text-lg font-bold text-gray-800 leading-tight truncate max-w-[150px] md:max-w-xs">B√†i thi</h1>
                <p class="text-[10px] md:text-xs text-gray-500">M√£ ƒë·ªÅ: <span id="examIdDisplay">---</span></p>
            </div>
        </div>
        <div class="flex items-center gap-3 md:gap-6">
            <div id="cheatWarning" class="hidden flex items-center gap-1 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i> <span id="cheatCount">0</span> vi ph·∫°m</div>
            
            <div class="bg-gradient-to-r from-red-600 to-orange-500 text-white px-4 py-2 rounded-lg shadow-lg border-2 border-white flex items-center gap-2 animate-pulse-slow">
                <i class="fa-regular fa-clock"></i>
                <span id="timer" class="font-mono font-extrabold text-lg md:text-xl tracking-widest">00:00</span>
            </div>
            
            <button onclick="checkFinish()" class="hidden md:block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md shadow-blue-200">N·ªôp b√†i</button>
        </div>
    </header>

    <main id="examMain" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto hidden relative">
        <div class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar relative pb-mobile-nav" id="questionArea">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-200 min-h-full p-6 md:p-10 relative">
                <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                    <div>
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold uppercase tracking-wider mb-1" id="questionTypeBadge">C√ÇU H·ªéI</span>
                        <h2 class="text-lg font-bold text-gray-400">C√¢u s·ªë <span id="currentQNum">1</span></h2>
                    </div>
                    <button onclick="toggleFlag()" id="flagBtn" class="text-gray-300 hover:text-red-500 transition-colors" title="ƒê√°nh d·∫•u"><i class="fa-regular fa-flag text-xl"></i></button>
                </div>
                <div id="questionContent" class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed mb-8"></div>
                <div id="answerOptions" class="space-y-3"></div>
            </div>
        </div>

        <aside id="paletteSidebar" class="mobile-sidebar bg-white border-l border-gray-200 md:relative md:transform-none md:w-80 md:flex md:z-10 md:shadow-none">
            <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-gray-700">Danh s√°ch c√¢u h·ªèi</h3>
                    <div class="flex flex-wrap gap-3 mt-3 text-xs text-gray-500">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-custom rounded-sm"></span> ƒêang l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-200 rounded-sm"></span> ƒê√£ l√†m</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-white border border-red-200 rounded-sm flex items-center justify-center"><i class="fa-solid fa-flag text-[8px] text-red-500"></i></span> C·ªù</div>
                    </div>
                </div>
                <button onclick="closeAllSidebars()" class="md:hidden text-gray-400 hover:text-red-500 text-xl px-2"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 no-scrollbar">
                <div class="grid grid-cols-5 gap-3" id="questionPalette"></div>
            </div>
            <div class="p-5 border-t border-gray-200 hidden md:block">
                 <button onclick="checkFinish()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all">N·ªôp b√†i thi</button>
            </div>
        </aside>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 grid grid-cols-4 gap-2 z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom">
            <button id="prevBtnMob" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="toggleMobilePalette('paletteSidebar')" class="py-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100"><i class="fa-solid fa-list-ol"></i></button>
            <button id="nextBtnMob" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-chevron-right"></i></button>
            <button onclick="checkFinish()" class="py-2.5 bg-red-600 text-white font-bold rounded-lg text-xs uppercase flex items-center justify-center gap-1 shadow-md"><i class="fa-solid fa-paper-plane"></i> N·ªôp</button>
        </div>
        
        <div class="hidden md:flex fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-2xl border border-gray-100 gap-4 items-center z-40">
            <button id="prevBtn" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
            <span class="text-sm font-bold text-gray-500"><span id="navCurrent">1</span> / <span id="navTotal">--</span></span>
            <button id="nextBtn" class="w-10 h-10 rounded-full bg-orange-custom hover:bg-orange-600 text-white flex items-center justify-center shadow-md shadow-orange-200 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </main>

    <div id="solutionView" class="hidden fixed inset-0 z-[90] bg-gray-50 flex h-full">
        <aside id="solutionSidebar" class="mobile-sidebar bg-white border-r border-gray-200 md:relative md:transform-none md:w-80 md:flex md:z-10">
            <div class="p-5 border-b border-gray-200 bg-white flex justify-between items-center shadow-sm">
                <h3 class="font-bold text-gray-700">K·∫øt qu·∫£ chi ti·∫øt</h3>
                <button onclick="closeAllSidebars()" class="md:hidden text-gray-400 hover:text-red-500 text-xl px-2"><i class="fa-solid fa-xmark"></i></button>
                <button onclick="window.location.href='dashboard.html'" class="hidden md:block text-xs font-bold text-gray-500 hover:text-blue-600">Tho√°t</button>
            </div>
            <div class="p-4 border-b border-gray-200 bg-white">
                 <h4 class="text-xs font-bold text-blue-600 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> L·ªãch s·ª≠ l√†m b√†i</h4>
                <div class="bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                    <table class="w-full text-[10px] text-left text-gray-600">
                        <thead class="bg-gray-100 text-gray-500 font-bold uppercase"><tr><th class="px-2 py-1.5">L·∫ßn</th><th class="px-2 py-1.5 text-center">ƒêi·ªÉm</th><th class="px-2 py-1.5 text-right">Ng√†y n·ªôp</th></tr></thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-3 border-b border-gray-100 bg-white text-xs flex gap-3 text-gray-500 justify-center">
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-sm"></span> ƒê√∫ng</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-sm"></span> Sai</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 rounded-sm"></span> 1 ph·∫ßn</div>
            </div>
            <div class="flex-1 overflow-y-auto p-5 no-scrollbar"><div class="grid grid-cols-5 gap-3" id="solutionPalette"></div></div>
        </aside>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth bg-gray-100 w-full pb-mobile-nav" id="solutionContentArea">
            <div class="md:hidden mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                 <h3 class="font-bold text-gray-800">K·∫øt qu·∫£ chi ti·∫øt</h3>
                 <button onclick="window.location.href='dashboard.html'" class="px-3 py-1.5 bg-gray-100 rounded text-xs font-bold">Tho√°t</button>
            </div>
            <div class="max-w-4xl mx-auto space-y-6 pb-20" id="solutionList"></div>
        </div>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-2 grid grid-cols-3 gap-2 z-30 md:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom">
            <button onclick="window.location.href='dashboard.html'" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold text-sm">Tho√°t</button>
            <button onclick="toggleMobilePalette('solutionSidebar')" class="py-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100"><i class="fa-solid fa-list-ol"></i> DS</button>
            <button onclick="document.getElementById('solutionContentArea').scrollTo({top:0, behavior:'smooth'})" class="py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold"><i class="fa-solid fa-arrow-up"></i> L√™n</button>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Th√¥ng b√°o</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">N·ªôi dung...</p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">H·ªßy b·ªè</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÅ thi</h3>
            <input type="password" id="examPasswordInput" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="M·∫≠t kh·∫©u...">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('passwordModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold text-sm">H·ªßy</button><button onclick="verifyPassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">V√†o thi</button></div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-gray-900 bg-opacity-80 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 relative" id="resultModalContent">
            <div id="resultIcon" class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce">üí™</div>
            <h2 class="text-2xl font-extrabold text-gray-800 mb-2" id="resultTitle">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6 text-sm" id="resultMsg">ƒê√£ n·ªôp b√†i th√†nh c√¥ng.</p>
            <div id="scoreSection" class="bg-gray-50 rounded-2xl p-6 mb-6 border border-gray-100 hidden">
                <p class="text-sm text-gray-400 uppercase font-bold tracking-wide mb-1">ƒêi·ªÉm s·ªë</p>
                <div class="text-6xl font-black text-orange-custom" id="scoreDisplay">--</div>
                <div class="text-sm text-gray-500 mt-2 font-medium">ƒê√∫ng: <span id="correctCount">--</span>/<span id="totalCount">--</span></div>
            </div>
            <div class="space-y-3">
                <button id="btnViewSolution" onclick="viewDetailSolutions()" class="w-full py-3 rounded-xl bg-orange-100 text-orange-600 font-bold hover:bg-orange-200 transition-colors hidden"><i class="fa-solid fa-eye mr-2"></i> Xem l·ªùi gi·∫£i chi ti·∫øt</button>
                <button onclick="returnToContext()" id="btnBackContext" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-colors">V·ªÅ trang ch·ªß</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, where, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // [IMPORT ƒê√öNG] Import ƒë·∫ßy ƒë·ªß c√°c h√†m t·ª´ utils.js
        import { formatContent, autoScaleTables, renderTikz, compressImage, watermarkImage } from "./utils.js"; 

        // G√°n v√†o window ƒë·ªÉ HTML g·ªçi ƒë∆∞·ª£c
        window.formatContent = formatContent;
        window.autoScaleTables = autoScaleTables;
        window.renderTikz = renderTikz;

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        let currentUser, examData, examId;
        let currentQuestions = [], userAnswers = {}, flaggedQuestions = {};
        let currentIndex = 0, timerInterval, timeLeft = 0, cheatCount = 0, isExamActive = false;
        let syncInterval = null; // Bi·∫øn qu·∫£n l√Ω l∆∞u Cloud 10p/l·∫ßn
        window.examHistory = [];

        // --- H√ÄM L∆ØU TR·ªÆ (M·ªöI) ---
        function saveLocal() {
            // L∆∞u ngay v√†o tr√¨nh duy·ªát (Mi·ªÖn ph√≠, T·ª©c th√¨)
            if(currentUser && examId) {
                localStorage.setItem(`ans_${currentUser.uid}_${examId}`, JSON.stringify(userAnswers));
            }
        }

        function startAutoSync() {
            // L∆∞u l√™n Cloud m·ªói 10 ph√∫t (600.000ms)
            if(syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(async () => {
                if(!isExamActive) return;
                try {
                    const attemptRef = doc(db, "exam_attempts", `${currentUser.uid}_${examId}`);
                    await updateDoc(attemptRef, {
                        answers: userAnswers,
                        lastUpdated: new Date().toISOString()
                    });
                    console.log("Auto-synced to Cloud (10 mins)");
                } catch(e) { console.error("Sync fail", e); }
            }, 600000); 
        }
        
        const dom = { lobby: document.getElementById('lobbyScreen'), header: document.getElementById('examHeader'), main: document.getElementById('examMain'), content: document.getElementById('questionContent'), options: document.getElementById('answerOptions'), palette: document.getElementById('questionPalette'), timer: document.getElementById('timer'), badge: document.getElementById('questionTypeBadge') };
        
        // MODAL HELPERS
        let modalResolve = null;
        const modalEl = document.getElementById('customModal'), modalBox = document.getElementById('customModalBox'), modalTitle = document.getElementById('modalTitle'), modalMsg = document.getElementById('modalMessage'), btnConfirm = document.getElementById('btnConfirm'), btnCancel = document.getElementById('btnCancel');
        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if(modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (msg, type='info') => { return new Promise(resolve => { modalTitle.innerText=type==='error'?'L·ªói':'Th√¥ng b√°o'; modalMsg.innerText=msg; btnCancel.classList.add('hidden'); btnConfirm.innerText="ƒê√£ hi·ªÉu"; modalEl.classList.remove('opacity-0','pointer-events-none'); modalBox.classList.add('scale-100'); btnConfirm.onclick=()=>{resolve(true);closeCustomModal();}; }); };
        window.customConfirm = (msg) => { return new Promise(resolve => { modalTitle.innerText="X√°c nh·∫≠n"; modalMsg.innerText=msg; btnCancel.classList.remove('hidden'); btnConfirm.innerText="ƒê·ªìng √Ω"; modalEl.classList.remove('opacity-0','pointer-events-none'); modalBox.classList.add('scale-100'); btnConfirm.onclick=()=>{resolve(true);closeCustomModal();}; btnCancel.onclick=()=>{resolve(false);closeCustomModal();}; }); };

        // AUTH & LOAD DATA
        onAuthStateChanged(auth, async (user) => {
            const urlParams = new URLSearchParams(window.location.search);
            examId = urlParams.get('id');
            if (user) {
                currentUser = user; 
                if(typeof loadSiteLogo === 'function') loadSiteLogo(); 
                if (examId) loadLobbyData(examId); else { window.customAlert("Kh√¥ng t√¨m th·∫•y ID ƒë·ªÅ thi!", "error"); window.location.href = "student.html"; }
            } else {
                if (examId) sessionStorage.setItem('pendingExamUrl', window.location.href);
                showLoginRequestModal();
            }
        });

        function showLoginRequestModal() {
            const modalHtml = `<div class="fixed inset-0 bg-gray-900/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center animate-bounce-in relative"><div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl border border-orange-200"><i class="fa-solid fa-user-lock"></i></div><h3 class="text-xl font-black text-gray-800 mb-2">Y√™u c·∫ßu t√†i kho·∫£n</h3><p class="text-gray-500 mb-6 text-sm">Em c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l√†m b√†i.</p><button onclick="window.location.href='index.html'" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">ƒêƒÉng nh·∫≠p ngay</button></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

async function loadLobbyData(id) {
            try {
                // 1. T·∫£i d·ªØ li·ªáu ƒê·ªÅ thi g·ªëc
                const docSnap = await getDoc(doc(db, "exams", id));
                if (!docSnap.exists()) { document.getElementById('lobbyTitle').innerText = "ƒê·ªÅ thi kh√¥ng t·ªìn t·∫°i!"; return; }
                examData = { id: docSnap.id, ...docSnap.data() }; 
                
                // 2. [FIX CH√çNH X√ÅC] T√åM C·∫§U H√åNH TRONG CURRICULUM KH√ìA H·ªåC
                const urlParamsCheck = new URLSearchParams(window.location.search);
                const courseIdOverride = urlParamsCheck.get('courseId');
                
                if (courseIdOverride) {
                    try {
                        const cSnap = await getDoc(doc(db, "public_courses", courseIdOverride));
                        if (cSnap.exists()) {
                            const cData = cSnap.data();
                            let foundItem = null;
                            if (cData.curriculum && Array.isArray(cData.curriculum)) {
                                for (const chap of cData.curriculum) {
                                    if (chap.lessons && Array.isArray(chap.lessons)) {
                                        for (const les of chap.lessons) {
                                            if (les.items && Array.isArray(les.items)) {
                                                const match = les.items.find(it => it.type === 'quiz' && (it.examId === id || it.content === id));
                                                if (match) { foundItem = match; break; }
                                            }
                                        }
                                    }
                                    if (foundItem) break;
                                }
                            }
                            if (foundItem) {
                                if (foundItem.minScore !== undefined && foundItem.minScore !== "" && foundItem.minScore !== null) { examData.passScore = Number(foundItem.minScore); examData.showResult = 'pass_score'; }
                                if (foundItem.viewPrice !== undefined && foundItem.viewPrice !== "" && Number(foundItem.viewPrice) > 0) { examData.feeQpoint = Number(foundItem.viewPrice); examData.showResult = 'fee_qpoint'; }
                                if (foundItem.viewLimit !== undefined && foundItem.viewLimit !== "") { examData.viewLimit = Number(foundItem.viewLimit); }
                            }
                        }
                    } catch (e) { console.error("L·ªói khi t·∫£i c·∫•u h√¨nh kh√≥a h·ªçc:", e); }
                }
                
                // 3. T·∫£i l·ªãch s·ª≠ l√†m b√†i
                const q = query(collection(db, "results"), where("examId","==",id), where("studentId","==",currentUser.uid));
                const snap = await getDocs(q);
                window.examHistory = [];
                snap.forEach(d => window.examHistory.push(d.data()));
                window.examHistory.sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
                const att = window.examHistory.length;

                // --- [M·ªöI] KI·ªÇM TRA B√ÄI L√ÄM D·ªû ---
                const attemptRef = doc(db, "exam_attempts", `${currentUser.uid}_${examId}`);
                const attemptSnap = await getDoc(attemptRef);
                const btnStart = document.getElementById('btnStartExam');

                if (attemptSnap.exists()) {
                    // C√ì B√ÄI D·ªû -> Hi·ªán n√∫t "Ti·∫øp t·ª•c"
                    btnStart.innerHTML = '<i class="fa-solid fa-play"></i> Ti·∫øp t·ª•c l√†m b√†i';
                    btnStart.classList.remove('bg-gray-300', 'cursor-not-allowed', 'text-gray-400');
                    btnStart.classList.add('bg-yellow-600', 'text-white', 'shadow-lg', 'hover:bg-yellow-700');
                    btnStart.disabled = false;
                    btnStart.onclick = () => requestStart(true); // true = Ch·∫ø ƒë·ªô Resume
                } else {
                    // KH√îNG C√ì B√ÄI D·ªû -> Logic c≈©
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('mode') === 'review') {
                        if (att > 0) { currentQuestions = examData.questions || []; userAnswers = window.examHistory[0].answers || {}; document.getElementById('lobbyScreen').classList.add('hidden'); viewDetailSolutions(); return; } 
                        else { window.customAlert("B·∫°n ch∆∞a l√†m b√†i n√†y n√™n kh√¥ng th·ªÉ xem l·ªùi gi·∫£i!", "error"); }
                    }

                    document.getElementById('lobbyTitle').innerText = examData.title || "B√†i thi";
                    document.getElementById('lobbyDuration').innerText = examData.duration || '--';
                    if(document.getElementById('lobbyAttempts')) document.getElementById('lobbyAttempts').innerText = att;
                    if(document.getElementById('lobbyMaxAttempts')) document.getElementById('lobbyMaxAttempts').innerText = examData.attempts || '‚àû';

                    let ok = true, msg = "S·∫µn s√†ng", color = "text-green-600";
                    const modes = urlParams.getAll('mode');
                    const isPracticeMode = modes.includes('practice') || modes.includes('course');
                    const now = new Date();
                    
                    if(examData.startTime && now < new Date(examData.startTime)) { ok=false; msg="Ch∆∞a ƒë·∫øn gi·ªù m·ªü ƒë·ªÅ"; color="text-orange-500"; document.getElementById('lobbyTimeRange').classList.remove('hidden'); document.getElementById('lobbyTimeText').textContent=new Date(examData.startTime).toLocaleString('vi-VN'); }
                    if(examData.endTime && now > new Date(examData.endTime)) { ok=false; msg="ƒê·ªÅ thi ƒë√£ ƒë√≥ng"; color="text-red-500"; }
                    if(!isPracticeMode && examData.attempts > 0 && att >= examData.attempts) { ok=false; msg="H·∫øt l∆∞·ª£t l√†m b√†i"; color="text-red-500"; }
                    if(isPracticeMode) { msg = "Ch·∫ø ƒë·ªô luy·ªán t·∫≠p"; color = "text-blue-600"; if(document.getElementById('lobbyMaxAttempts')) document.getElementById('lobbyMaxAttempts').innerText = '‚àû (Luy·ªán t·∫≠p)'; }

                    const stat = document.getElementById('lobbyStatusBadge'); if(stat) { stat.textContent = msg; stat.className = `font-bold ${color}`; }
                    if(btnStart) {
                        if(ok) { 
                            btnStart.disabled = false; 
                            btnStart.classList.remove('bg-gray-300', 'cursor-not-allowed', 'text-gray-400'); 
                            btnStart.classList.add('bg-[#0F766E]', 'text-white', 'shadow-lg', 'hover:bg-teal-700'); 
                            btnStart.innerHTML = '<i class="fa-solid fa-play"></i> B·∫Øt ƒë·∫ßu l√†m b√†i'; 
                            btnStart.onclick = () => requestStart(false); // false = B√†i m·ªõi
                        } else { 
                            btnStart.disabled = true; 
                            btnStart.classList.add('bg-gray-300', 'cursor-not-allowed', 'text-gray-500'); 
                            btnStart.innerHTML = `<i class="fa-solid fa-ban"></i> ${msg}`; 
                        }
                    }
                }
            } catch (error) { console.error("L·ªói t·∫£i ƒë·ªÅ:", error); document.getElementById('lobbyTitle').innerText = "L·ªói t·∫£i d·ªØ li·ªáu!"; }
        }

        window.requestStart = (isResume = false) => { 
            if(examData.password && !isResume) document.getElementById('passwordModal').classList.remove('hidden'); 
            else startExam(isResume); 
        }
        
        window.verifyPassword = () => { 
            if(document.getElementById('examPasswordInput').value===examData.password) { 
                document.getElementById('passwordModal').classList.add('hidden'); 
                startExam(false); 
            } else window.customAlert("Sai m·∫≠t kh·∫©u","error"); 
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        async function startExam(isResume) {
            dom.lobby.classList.add('hidden'); dom.header.classList.remove('hidden'); dom.main.classList.remove('hidden');
            
            let rawQuestions = JSON.parse(JSON.stringify(examData.questions || []));
            const savedOrder = localStorage.getItem(`order_${currentUser.uid}_${examId}`);
            
            if(examData.shuffle && !savedOrder) {
                const groups = { mc: [], tf: [], short: [], essay: [] };
                rawQuestions.forEach(q => { if(groups[q.type]) groups[q.type].push(q); });
                
                shuffleArray(groups.mc); shuffleArray(groups.tf); shuffleArray(groups.short); shuffleArray(groups.essay);
                groups.mc.forEach(q => { if (q.options && q.options.length > 0) { let mapped = q.options.map((opt, i) => ({ txt: opt, originalIdx: i })); shuffleArray(mapped); q.options = mapped.map(m => m.txt); q.correct = mapped.findIndex(m => m.originalIdx === q.correct); } });
                
                currentQuestions = [...groups.mc, ...groups.tf, ...groups.short, ...groups.essay];
                localStorage.setItem(`order_${currentUser.uid}_${examId}`, "true"); 
            } else { 
                currentQuestions = rawQuestions; 
            }
            
            // --- T√çNH TO√ÅN TH·ªúI GIAN & KH√îI PH·ª§C (LOGIC M·ªöI) ---
            const durationMinutes = examData.duration || 45;
            const attemptRef = doc(db, "exam_attempts", `${currentUser.uid}_${examId}`);
            let startTimeMs;

            if (isResume) {
                const snap = await getDoc(attemptRef);
                if(snap.exists()) {
                    const data = snap.data();
                    startTimeMs = data.startTime;
                    // G·ªôp ƒë√°p √°n: Cloud + LocalStorage (Local ƒë√® l√™n Cloud v√¨ m·ªõi h∆°n)
                    const cloudAnswers = data.answers || {};
                    const localAnswers = JSON.parse(localStorage.getItem(`ans_${currentUser.uid}_${examId}`)) || {};
                    userAnswers = { ...cloudAnswers, ...localAnswers };
                    
                    // T√≠nh th·ªùi gian c√≤n l·∫°i = T·ªïng gi·ªù - (Hi·ªán t·∫°i - L√∫c b·∫Øt ƒë·∫ßu)
                    const elapsedTime = Math.floor((Date.now() - startTimeMs) / 1000);
                    timeLeft = (durationMinutes * 60) - elapsedTime;
                } else {
                    isResume = false; // L·ªói d·ªØ li·ªáu -> L√†m b√†i m·ªõi
                }
            }
            
            if (!isResume) {
                // B√†i m·ªõi: Set th·ªùi gian v√† t·∫°o b·∫£n ghi Cloud
                startTimeMs = Date.now();
                userAnswers = {};
                timeLeft = durationMinutes * 60;
                
                // [QUAN TR·ªåNG] T·∫°o b·∫£n ghi Attempt ƒë·ªÉ b·∫Øt ƒë·∫ßu t√≠nh gi·ªù
                await setDoc(attemptRef, {
                    examId: examId,
                    studentId: currentUser.uid,
                    startTime: startTimeMs,
                    answers: {},
                    lastUpdated: new Date().toISOString()
                });
            }

            if(timeLeft <= 0) {
                window.customAlert("ƒê√£ h·∫øt th·ªùi gian l√†m b√†i!", "error");
                submitReal(true);
                return;
            }

            // C·∫≠p nh·∫≠t m·ªëc th·ªùi gian cho ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
            if(timeLeft > 0) { window.endTimeStamp = Date.now() + (timeLeft * 1000); runTimer(); } else { dom.timer.textContent = "‚àû"; }
            
            // B·∫Øt ƒë·∫ßu l∆∞u 10p/l·∫ßn
            startAutoSync();

            if(examData.proctoring) { document.getElementById('cheatWarning').classList.remove('hidden'); initProctoring(); }
            
            isExamActive = true;
            renderPalette(); renderQuestion(0);
            try{document.documentElement.requestFullscreen().catch(()=>{});}catch(e){}
        }

        function runTimer() { updateTimer(); timerInterval = setInterval(() => { const now = Date.now(); const diff = Math.ceil((window.endTimeStamp - now) / 1000); timeLeft = diff; if (timeLeft <= 0) { timeLeft = 0; updateTimer(); clearInterval(timerInterval); submitReal(true); } else { updateTimer(); } }, 1000); }
        // --- LOGIC GI√ÅM S√ÅT M·ªöI: CH·ªêNG ƒê·∫æM TR√ôNG & HI·ªÜN C·∫¢NH B√ÅO ---
        // --- FIX L·ªñI: N√öT "QUAY L·∫†I" B·ªä ƒê∆† & CH·ªêNG ƒê·∫æM TR√ôNG ---
        // --- LOGIC GI√ÅM S√ÅT M·ªöI (FIX L·ªñI UPLOAD B·ªä T√çNH VI PH·∫†M) ---
        // --- LOGIC GI√ÅM S√ÅT (FIX L·ªñI) ---
        // --- LOGIC GI√ÅM S√ÅT & CH·ªêNG GIAN L·∫¨N (B·∫¢N FIX) ---
        let lastCheatTime = 0; 
        window.isUploading = false; 
        let uploadTimeout = null; 

        // H√†m ƒë∆∞·ª£c g·ªçi khi b·∫•m n√∫t "Ch·ªçn ·∫£nh" ho·∫∑c "Ch·ª•p ·∫£nh"
        window.triggerUploadMode = () => {
            window.isUploading = true;
            console.log("Upload mode: ON (Mi·ªÖn tr·ª´ gian l·∫≠n)");
            
            // T·ª± ƒë·ªông t·∫Øt sau 15 gi√¢y (ph√≤ng tr∆∞·ªùng h·ª£p h·ªçc sinh kh√¥ng ch·ªçn g√¨ m√† b·∫•m Cancel)
            if (uploadTimeout) clearTimeout(uploadTimeout);
            uploadTimeout = setTimeout(() => {
                window.isUploading = false;
                console.log("Upload mode: Auto-OFF (Timeout)");
            }, 15000); 
        };

        // S·ª± ki·ªán: Khi quay l·∫°i Tab -> T·∫Øt ngay ch·∫ø ƒë·ªô Upload
        window.addEventListener('focus', () => {
            if (window.isUploading) {
                // Delay nh·ªè 0.5s ƒë·ªÉ ch·∫Øc ch·∫Øn c√°c s·ª± ki·ªán blur/focus c·ªßa file dialog ƒë√£ xong
                setTimeout(() => { 
                    window.isUploading = false; 
                    console.log("Upload mode: OFF (Quay l·∫°i tab)");
                }, 500);
            }
        });
        
        window.closeCheatModal = () => {
            const cm = document.getElementById('cheatModal');
            cm.classList.add('opacity-0');
            const innerDiv = cm.querySelector('div');
            if(innerDiv) innerDiv.classList.remove('scale-100');

            setTimeout(() => {
                cm.classList.add('hidden');
                cm.classList.remove('pointer-events-none'); 
            }, 300);
        };

        function initProctoring() {
            const handleCheat = () => {
                // 1. N·∫øu ch∆∞a b·∫Øt ƒë·∫ßu thi -> B·ªè qua
                if (!isExamActive) return;

                // 2. N·∫øu ƒëang trong qu√° tr√¨nh t·∫£i ·∫£nh -> B·ªè qua (Kh√¥ng ph·∫°t)
                if (window.isUploading) {
                    console.log("Ph√°t hi·ªán r·ªùi tab nh∆∞ng ƒëang Upload -> B·ªè qua.");
                    return;
                }

                // 3. Logic ph·∫°t: Gi√£n c√°ch 2 gi√¢y gi·ªØa c√°c l·∫ßn ph·∫°t ƒë·ªÉ tr√°nh spam
                if (Date.now() - lastCheatTime > 2000) {
                    lastCheatTime = Date.now();
                    cheatCount++;
                    console.warn("GIAN L·∫¨N: R·ªùi tab l·∫ßn th·ª© " + cheatCount);
                    
                    // C·∫≠p nh·∫≠t giao di·ªán
                    document.getElementById('cheatCount').textContent = cheatCount;
                    if(document.getElementById('cheatModalCount')) {
                        document.getElementById('cheatModalCount').textContent = cheatCount;
                    }

                    // HI·ªÜN MODAL C·∫¢NH B√ÅO
                    const cm = document.getElementById('cheatModal');
                    if (cm) {
                        cm.classList.remove('hidden', 'pointer-events-none'); 
                        setTimeout(() => {
                            cm.classList.remove('opacity-0');
                            const innerDiv = cm.querySelector('div');
                            if(innerDiv) innerDiv.classList.add('scale-100');
                        }, 10);
                    }
                }
            };

            // B·∫Øt s·ª± ki·ªán ·∫©n tab (Switch tab, minimize browser)
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === 'hidden') handleCheat();
            });

            // B·∫Øt s·ª± ki·ªán m·∫•t ti√™u ƒëi·ªÉm (Click sang ph·∫ßn m·ªÅm kh√°c, Alt+Tab)
            window.addEventListener("blur", () => {
                handleCheat();
            });
        }
        function updateTimer() { const m=Math.floor(timeLeft/60), s=timeLeft%60; dom.timer.textContent=`${m<10?'0'+m:m}:${s<10?'0'+s:s}`; if(timeLeft<300) dom.timer.parentElement.classList.add('bg-red-50','text-red-600'); }

        // --- RENDER QUESTION (GIAO DI·ªÜN M·ªöI C√ì UPLOAD ·∫¢NH) ---
        function renderQuestion(idx) {
            currentIndex = idx;
            const q = currentQuestions[idx];
            document.getElementById('currentQNum').textContent = idx + 1;
            dom.badge.textContent = q.type==='mc'?'TR·∫ÆC NGHI·ªÜM':(q.type==='tf'?'ƒê√öNG/SAI':(q.type==='short'?'TR·∫¢ L·ªúI NG·∫ÆN':'T·ª∞ LU·∫¨N'));
            dom.content.innerHTML = window.formatContent(q.content);
            dom.options.innerHTML = '';

            const fb = document.getElementById('flagBtn');
            fb.className = flaggedQuestions[idx] ? "text-red-500 text-2xl" : "text-gray-300 hover:text-red-500 text-2xl";
            fb.innerHTML = flaggedQuestions[idx] ? '<i class="fa-solid fa-flag"></i>' : '<i class="fa-regular fa-flag"></i>';

            if(q.type === 'mc') {
                q.options.forEach((opt, i) => {
                    const checked = userAnswers[idx] === i;
                    const div = document.createElement('label'); div.className = "block cursor-pointer group w-full";
                    div.innerHTML = `<input type="radio" name="q" class="hidden custom-radio" ${checked?'checked':''}><div class="flex items-start p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 group-hover:bg-blue-50 group-hover:shadow-sm h-full transition-all"><div class="check-circle w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 font-bold text-gray-400 shrink-0 mt-0.5 group-hover:scale-110 transition-transform">${String.fromCharCode(65+i)}</div><div class="flex-1 text-gray-700 leading-relaxed">${window.formatContent(opt)}</div></div>`;
                    div.querySelector('input').onchange = () => { userAnswers[idx]=i; updatePalette(); saveLocal(); };
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'tf') {
                 q.statements.forEach((stmt, i) => {
                    const val = userAnswers[idx]?userAnswers[idx][i]:null;
                    const div = document.createElement('div'); div.className = "bg-white border-2 border-gray-100 rounded-xl p-4 hover:border-orange-200 transition-all";
                    div.innerHTML = `<div class="font-medium text-gray-800 mb-2">${window.formatContent(stmt.text)}</div><div class="flex gap-4"><label class="flex-1 cursor-pointer hover:bg-green-50 p-2 rounded transition-colors"><input type="radio" name="tf-${idx}-${i}" value="true" ${val===true?'checked':''} class="mr-2 accent-green-600">ƒê√∫ng</label><label class="flex-1 cursor-pointer hover:bg-red-50 p-2 rounded transition-colors"><input type="radio" name="tf-${idx}-${i}" value="false" ${val===false?'checked':''} class="mr-2 accent-red-600">Sai</label></div>`;
                    div.querySelectorAll('input').forEach(inp => inp.onchange = (e) => {
                        if(!userAnswers[idx]) userAnswers[idx]={}; userAnswers[idx][i]=(e.target.value==='true'); updatePalette(); saveLocal();
                    });
                    dom.options.appendChild(div);
                });
            } else if (q.type === 'short') {
                const inp = document.createElement('input');
                inp.className = "w-full p-4 border-2 rounded-xl font-bold text-lg outline-none focus:border-green-500 transition-all";
                inp.placeholder = "Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...";
                inp.value = userAnswers[idx] || '';
                inp.onchange = (e) => { userAnswers[idx]=e.target.value; updatePalette(); saveLocal(); };
                dom.options.appendChild(inp);
            } else { 
                // --- T·ª∞ LU·∫¨N (C·∫¨P NH·∫¨T) ---
                const wrapper = document.createElement('div');
                wrapper.className = "space-y-4 pb-24"; 

                // Khu v·ª±c hi·ªÉn th·ªã ·∫£nh ƒë√£ n·ªôp
                const submittedWrapper = document.createElement('div');
                submittedWrapper.id = `submitted-area-wrapper-${idx}`;
                submittedWrapper.className = userAnswers[idx] ? "bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4" : "hidden";
                
                submittedWrapper.innerHTML = `
                    <div class="flex items-center justify-between mb-3 border-b border-blue-200 pb-2">
                        <div class="flex items-center gap-2 text-blue-700 font-bold text-sm">
                            <i class="fa-solid fa-check-circle"></i> B√†i l√†m ƒë√£ l∆∞u:
                        </div>
                        <button onclick="window.deleteAllImages(${idx})" class="text-xs bg-white text-red-600 border border-red-200 px-3 py-1.5 rounded-lg hover:bg-red-600 hover:text-white font-bold shadow-sm transition-colors flex items-center gap-1">
                            <i class="fa-solid fa-trash-can"></i> X√≥a t·∫•t c·∫£
                        </button>
                    </div>
                    <div id="submitted-area-${idx}" class="submitted-content grid gap-6">
                        ${userAnswers[idx] || ''}
                    </div>
                `;
                wrapper.appendChild(submittedWrapper);

                const actionGrid = document.createElement('div');
                actionGrid.className = "grid grid-cols-2 gap-3";
                actionGrid.innerHTML = `
                    <label class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-blue-300 rounded-xl bg-blue-50 text-blue-600 font-bold cursor-pointer hover:bg-blue-100 hover:shadow-md transition-all active:scale-95">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm mb-2 text-xl"><i class="fa-regular fa-image"></i></div>
                        <span class="text-xs uppercase tracking-wide">Ch·ªçn ·∫£nh</span>
                        <input type="file" accept="image/*" multiple class="hidden" onclick="window.triggerUploadMode()" onchange="handleStudentUpload(this, ${idx})">
                    </label>
                    <label class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-purple-300 rounded-xl bg-purple-50 text-purple-600 font-bold cursor-pointer hover:bg-purple-100 hover:shadow-md transition-all active:scale-95">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm mb-2 text-xl"><i class="fa-solid fa-camera"></i></div>
                        <span class="text-xs uppercase tracking-wide">Ch·ª•p ·∫£nh</span>
                        <input type="file" accept="image/*" capture="environment" class="hidden" onclick="window.triggerUploadMode()" onchange="handleStudentUpload(this, ${idx})">
                    </label>
                `;
                wrapper.appendChild(actionGrid);

                const previewArea = document.createElement('div'); previewArea.id = `preview-area-${idx}`; previewArea.className = "grid grid-cols-2 md:grid-cols-3 gap-3 mt-2 empty:hidden"; wrapper.appendChild(previewArea);

                const saveBtnArea = document.createElement('div'); saveBtnArea.id = `upload-actions-${idx}`; saveBtnArea.className = "hidden mt-4 sticky bottom-20 z-10"; 
                saveBtnArea.innerHTML = `<button onclick="autoNumberPages(${idx})" class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform active:scale-95 flex items-center justify-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> ƒê√≥ng d·∫•u s·ªë trang & N·ªôp b√†i</button>`;
                wrapper.appendChild(saveBtnArea);

                dom.options.appendChild(wrapper);
            }

            if(window.MathJax) { MathJax.typesetPromise([dom.content, dom.options]).then(() => { if(window.renderTikz) window.renderTikz(); if(window.autoScaleTables) window.autoScaleTables(); }).catch(()=>{}); }
            updatePalette();
            closeAllSidebars();
        }

        function updatePalette() {
            dom.palette.innerHTML = '';
            currentQuestions.forEach((q, i) => {
                const btn = document.createElement('button'); btn.className = "q-btn"; btn.textContent = i+1;
                if(i===currentIndex) btn.classList.add('active'); else if(flaggedQuestions[i]) btn.classList.add('flagged');
                else {
                    const a = userAnswers[i]; let done = (a!==undefined && a!==null && a!=="");
                    if(q.type==='tf' && typeof a==='object') done = Object.keys(a).length>0;
                    if(done) btn.classList.add('answered');
                }
                btn.onclick = () => renderQuestion(i); dom.palette.appendChild(btn);
            });
            // Update Progress Bar
            const answeredCount = Object.keys(userAnswers).length;
            const totalCount = currentQuestions.length;
            const percent = totalCount > 0 ? (answeredCount / totalCount) * 100 : 0;
            const bar = document.getElementById('examProgressBar'); if(bar) bar.style.width = `${percent}%`;

            document.getElementById('prevBtnMob').disabled = currentIndex===0; document.getElementById('nextBtnMob').disabled = currentIndex===currentQuestions.length-1;
            document.getElementById('prevBtnMob').classList.toggle('opacity-50', currentIndex===0); document.getElementById('nextBtnMob').classList.toggle('opacity-50', currentIndex===currentQuestions.length-1);
        }
        function renderPalette() { updatePalette(); }

        window.toggleMobilePalette = (id) => { const sb = document.getElementById(id); const bd = document.getElementById('mobileBackdrop'); if(sb.classList.contains('open')) { sb.classList.remove('open'); bd.classList.remove('show'); } else { sb.classList.add('open'); bd.classList.add('show'); } }
        window.closeAllSidebars = () => { document.getElementById('paletteSidebar').classList.remove('open'); document.getElementById('solutionSidebar').classList.remove('open'); document.getElementById('mobileBackdrop').classList.remove('show'); }
        window.toggleFlag = () => { flaggedQuestions[currentIndex] = !flaggedQuestions[currentIndex]; renderQuestion(currentIndex); }
        window.checkFinish = () => { let left = 0; currentQuestions.forEach((q,i) => { const a = userAnswers[i]; let done = (a!==undefined && a!==null && a!==""); if(q.type==='tf' && typeof a==='object') done = Object.keys(a).length === (q.statements?.length||0); if(!done) left++; }); if(left>0) window.customConfirm(`C√≤n ${left} c√¢u ch∆∞a l√†m. N·ªôp lu√¥n?`).then(y => { if(y) submitReal(); }); else submitReal(); }

        async function submitReal(auto=false) {
            isExamActive = false; 
            clearInterval(timerInterval); 
            // [QUAN TR·ªåNG] D·ª´ng vi·ªác ƒë·ªìng b·ªô Cloud
            if(syncInterval) clearInterval(syncInterval);

            // 1. T√çNH ƒêI·ªÇM (LOGIC C≈®)
            let totalScore = 0; let correct = 0; const normalize = (s) => String(s).replace(/\$| /g,'').toLowerCase().trim();
            let configuredPoints = 0; let unconfiguredCount = 0;
            currentQuestions.forEach(q => { if (q.point && parseFloat(q.point) > 0) configuredPoints += parseFloat(q.point); else unconfiguredCount++; });
            let defaultPointPerQuestion = 0; if (unconfiguredCount > 0) { const remainingScore = Math.max(0, 10 - configuredPoints); defaultPointPerQuestion = remainingScore / unconfiguredCount; } else if (configuredPoints === 0) { defaultPointPerQuestion = 10 / currentQuestions.length; }

            currentQuestions.forEach((q, i) => {
                const u = userAnswers[i]; let isCorrect = false;
                if (q.type === 'mc' && u === q.correct) isCorrect = true;
                else if (q.type === 'short' && q.answer && u && normalize(u) === normalize(q.answer)) isCorrect = true;
                else if (q.type === 'tf' && u && q.statements) { let matches = 0; q.statements.forEach((s, si) => { if (u[si] === s.isTrue) matches++; }); if (matches === q.statements.length) isCorrect = true; }
                if (isCorrect) { correct++; totalScore += (q.point && parseFloat(q.point) > 0) ? parseFloat(q.point) : defaultPointPerQuestion; }
            });

            const score = parseFloat(totalScore.toFixed(2));
            const passScore = examData.passScore !== undefined ? Number(examData.passScore) : 5;
            const isPassed = score >= passScore;

            try {
                // 2. L∆ØU K·∫æT QU·∫¢ V√ÄO FIRESTORE (LOGIC C≈®)
                await addDoc(collection(db, "results"), { examId, studentId: currentUser.uid, studentName: currentUser.displayName || currentUser.email, score, answers: userAnswers, cheatCount, correctCount: correct, totalQuestions: currentQuestions.length, isPassed: isPassed, passScoreSnapshot: passScore, submittedAt: new Date().toISOString() });
                
                // 3. [M·ªöI] X√ìA D·ªÆ LI·ªÜU T·∫†M (CLEANUP)
                // X√≥a b·∫£n ghi "ƒëang l√†m d·ªü" tr√™n Cloud
                await deleteDoc(doc(db, "exam_attempts", `${currentUser.uid}_${examId}`));
                // X√≥a d·ªØ li·ªáu trong m√°y
                localStorage.removeItem(`ans_${currentUser.uid}_${examId}`);
                localStorage.removeItem(`order_${currentUser.uid}_${examId}`);

                // 4. HI·ªÇN TH·ªä K·∫æT QU·∫¢ & PH√ÅO HOA (LOGIC C≈®)
                document.getElementById('scoreDisplay').textContent = score; document.getElementById('correctCount').textContent = `${correct}/${currentQuestions.length}`;
                const resultTitle = document.getElementById('resultTitle'); const resultMsg = document.getElementById('resultMsg'); const resultIcon = document.getElementById('resultIcon'); const scoreDisplay = document.getElementById('scoreDisplay');

                if (isPassed) {
                    resultTitle.textContent = "Ch√∫c m·ª´ng! B·∫°n ƒë√£ v∆∞·ª£t qua"; resultTitle.className = "text-2xl font-extrabold text-green-600 mb-2";
                    resultMsg.textContent = `B·∫°n ƒë√£ ƒë·∫°t ${score} ƒëi·ªÉm (ƒêi·ªÉm chu·∫©n: ${passScore})`; resultIcon.innerHTML = "üéâ"; scoreDisplay.className = "text-6xl font-black text-green-600";
                    window.fireConfetti(score); // B·∫ÆN PH√ÅO HOA
                } else {
                    resultTitle.textContent = "Ch∆∞a ƒë·∫°t y√™u c·∫ßu"; resultTitle.className = "text-2xl font-extrabold text-red-600 mb-2";
                    resultMsg.textContent = `C·∫ßn t·ªëi thi·ªÉu ${passScore} ƒëi·ªÉm ƒë·ªÉ qua b√†i. H√£y √¥n t·∫≠p th√™m!`; resultIcon.innerHTML = "üòì"; scoreDisplay.className = "text-6xl font-black text-red-500";
                }
                
                if (examData.showScore === 'immediate' || (examData.showScore === 'after_exam' && timeLeft <= 0)) { document.getElementById('scoreSection').classList.remove('hidden'); }
                
                // 5. X·ª¨ L√ù N√öT XEM GI·∫¢I (LOGIC C≈® + OVERRIDE)
                const btnView = document.getElementById('btnViewSolution');
                
                // S·ª≠ d·ª•ng examData ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t Override t·ª´ kh√≥a h·ªçc
                let finalMode = examData.showResult; 
                let finalPassScore = parseFloat(examData.passScore) || 5;
                let finalFee = parseInt(examData.feeQpoint) || 0;

                const isTimeOk = (finalMode !== 'after_exam' || timeLeft <= 0);

                if (finalMode === 'never') {
                    btnView.classList.add('hidden');
                } 
                else if (finalMode === 'pass_score') {
                    if (score >= finalPassScore) {
                        btnView.classList.remove('hidden');
                        btnView.classList.replace('bg-gray-200', 'bg-orange-100');
                        btnView.classList.replace('text-gray-500', 'text-orange-600');
                        btnView.innerHTML = `<i class="fa-solid fa-eye mr-2"></i> Xem l·ªùi gi·∫£i chi ti·∫øt`;
                        btnView.onclick = viewDetailSolutions;
                    } else {
                        btnView.classList.remove('hidden');
                        btnView.classList.replace('bg-orange-100', 'bg-gray-200');
                        btnView.classList.replace('text-orange-600', 'text-gray-500');
                        btnView.innerHTML = `<i class="fa-solid fa-lock mr-2"></i> ƒê·∫°t ${finalPassScore}ƒë ƒë·ªÉ xem`;
                        btnView.onclick = () => window.customAlert(`N·ªôi dung kh√≥a h·ªçc y√™u c·∫ßu b·∫°n ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu ${finalPassScore} ƒëi·ªÉm ƒë·ªÉ m·ªü kh√≥a l·ªùi gi·∫£i. H√£y c·ªë g·∫Øng l√†m b√†i t·ªët h∆°n nh√©!`, 'warning');
                    }
                } 
                else if (finalMode === 'fee_qpoint') {
                    btnView.classList.remove('hidden');
                    btnView.className = "w-full py-3 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold hover:shadow-lg transition-all";
                    btnView.innerHTML = `<i class="fa-solid fa-unlock-keyhole mr-2"></i> M·ªü kh√≥a l·ªùi gi·∫£i (${finalFee} Qpoint)`;
                    btnView.onclick = () => window.handlePayAndShowSolution(finalFee);
                } 
                else {
                    if (isTimeOk) {
                        btnView.classList.remove('hidden');
                        btnView.classList.replace('bg-gray-200', 'bg-orange-100');
                        btnView.classList.replace('text-gray-500', 'text-orange-600');
                        btnView.innerHTML = `<i class="fa-solid fa-eye mr-2"></i> Xem l·ªùi gi·∫£i chi ti·∫øt`;
                        btnView.onclick = viewDetailSolutions;
                    } else {
                        btnView.classList.add('hidden');
                    }
                }
                
                document.getElementById('resultModal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('resultModal').classList.remove('opacity-0'); document.getElementById('resultModalContent').classList.add('scale-100'); }, 50);
            } catch(e) { window.customAlert("L·ªói l∆∞u b√†i: "+e.message, "error"); }
        }

        window.viewDetailSolutions = () => {
            document.getElementById('resultModal').classList.add('hidden'); document.getElementById('examMain').classList.add('hidden'); document.getElementById('examHeader').classList.add('hidden'); document.getElementById('solutionView').classList.remove('hidden');
            const list = document.getElementById('solutionList'); const pal = document.getElementById('solutionPalette'); list.innerHTML = ''; pal.innerHTML = '';
            const historyBody = document.getElementById('historyTableBody'); historyBody.innerHTML = '';
            if (window.examHistory && window.examHistory.length > 0) { window.examHistory.forEach((h, idx) => { const date = new Date(h.submittedAt); historyBody.innerHTML += `<tr class="border-b border-gray-50"><td class="px-2 py-2">#${window.examHistory.length - idx}</td><td class="px-2 py-2 text-center text-blue-600 font-bold">${h.score}</td><td class="px-2 py-2 text-right text-gray-400 text-xs">${date.getDate()}/${date.getMonth()+1}</td></tr>`; }); }

            const normalize = (str) => String(str).replace(/\$| /g, '').toLowerCase().trim();
            currentQuestions.forEach((q, idx) => {
                const u = userAnswers[idx]; let isCorrect = false; let ansHtml = '';
                if(q.type==='mc') { isCorrect = (u===q.correct); ansHtml = `<div>B·∫°n ch·ªçn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u!==undefined?String.fromCharCode(65+u):'Ch∆∞a l√†m'}</b> | ƒê√°p √°n: <b class="text-green-600">${String.fromCharCode(65+q.correct)}</b></div>`; }
                else if (q.type==='short') { isCorrect = (q.answer && u && normalize(u)===normalize(q.answer)); ansHtml = `<div>B·∫°n ƒëi·ªÅn: <b class="${isCorrect?'text-green-600':'text-red-500'}">${u||'Tr·ªëng'}</b> | ƒê√°p √°n: <b class="text-green-600">${q.answer}</b></div>`; }
                else if (q.type==='tf') { let matches=0; ansHtml='<ul class="text-sm mt-2">'; q.statements.forEach((s,i)=>{ const uc = (u&&u[i]!==undefined)?(u[i]?'ƒê':'S'):'_'; const tc = s.isTrue?'ƒê':'S'; const m = (u&&u[i]===s.isTrue); if(m) matches++; ansHtml+=`<li>- ${window.formatContent(s.text)}: <b class="${m?'text-green-600':'text-red-500'}">${uc}</b> (ƒê√∫ng: ${tc})</li>`; }); ansHtml+='</ul>'; isCorrect = (matches === q.statements.length); }

                const btn = document.createElement('button'); btn.className = `q-btn ${isCorrect?'correct':(isCorrect===false?'wrong':'partial')}`; btn.textContent = idx+1; btn.onclick = () => { document.getElementById(`sol-q-${idx}`).scrollIntoView({behavior:'smooth', block:'center'}); closeAllSidebars(); }; pal.appendChild(btn);
                const item = document.createElement('div'); item.id = `sol-q-${idx}`; item.className = "bg-white p-6 rounded-2xl shadow-sm border border-gray-200";
                item.innerHTML = `<div class="font-bold text-gray-500 text-sm mb-2">C√¢u ${idx+1} (${q.type.toUpperCase()})</div><div class="mb-4 text-gray-800 text-lg">${window.formatContent(q.content)}</div><div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3">${ansHtml}</div>${q.solution ? `<div class="solution-box"><div class="font-bold text-green-700 mb-1">L·ªùi gi·∫£i:</div><div class="text-gray-700">${window.formatContent(q.solution)}</div></div>` : ''}`;
                list.appendChild(item);
            });
            if(window.MathJax) { MathJax.typesetPromise([list]).then(() => { if(window.renderTikz) window.renderTikz(); if(window.autoScaleTables) window.autoScaleTables(); }).catch(()=>{}); }
        }

        window.returnToContext = () => { const urlParams = new URLSearchParams(window.location.search); const courseId = urlParams.get('courseId'); const modes = urlParams.getAll('mode'); const isCourseContext = modes.includes('course') || modes.includes('practice') || !!courseId; if (isCourseContext && courseId) { window.location.href = `course-player.html?id=${courseId}`; } else { window.location.href = 'dashboard.html'; } };
        const urlParamsTest = new URLSearchParams(window.location.search); if (urlParamsTest.get('courseId') && document.getElementById('btnBackContext')) { document.getElementById('btnBackContext').innerText = "Quay l·∫°i b√†i h·ªçc"; }

        document.getElementById('prevBtn').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtn').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };
        document.getElementById('prevBtnMob').onclick = () => { if(currentIndex > 0) renderQuestion(currentIndex - 1); };
        document.getElementById('nextBtnMob').onclick = () => { if(currentIndex < currentQuestions.length - 1) renderQuestion(currentIndex + 1); };

        // --- C√ÅC H√ÄM X·ª¨ L√ù UPLOAD ·∫¢NH & PH√ÅO HOA ---
        window.tempStudentFiles = {}; 
        window.handleStudentUpload = (input, qIdx) => { const files = Array.from(input.files); if(files.length === 0) return; if(!window.tempStudentFiles[qIdx]) window.tempStudentFiles[qIdx] = []; window.tempStudentFiles[qIdx].push(...files); renderStudentPreview(qIdx); document.getElementById(`upload-actions-${qIdx}`).classList.remove('hidden'); };
        window.renderStudentPreview = (qIdx) => { const container = document.getElementById(`preview-area-${qIdx}`); container.innerHTML = ''; window.tempStudentFiles[qIdx].forEach((file, i) => { const url = URL.createObjectURL(file); const div = document.createElement('div'); div.className = "relative group aspect-[3/4]"; div.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded-lg border border-gray-300 shadow-sm"><button onclick="removeStudentFile(${qIdx}, ${i})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs shadow-md hover:bg-red-600">√ó</button><div class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded backdrop-blur-sm">Trang ${i+1}</div>`; container.appendChild(div); }); };
        window.removeStudentFile = (qIdx, fileIdx) => { window.tempStudentFiles[qIdx].splice(fileIdx, 1); renderStudentPreview(qIdx); if(window.tempStudentFiles[qIdx].length === 0) document.getElementById(`upload-actions-${qIdx}`).classList.add('hidden'); };
        
        window.autoNumberPages = async (qIdx) => {
            const files = window.tempStudentFiles[qIdx];
            if(!files || files.length === 0) return;

            window.showToast = (msg, type) => window.customAlert(msg, type); 
            window.showToast("ƒêang x·ª≠ l√Ω ·∫£nh v√† t·∫£i l√™n...", "info");
            
            const uploadBtn = document.querySelector(`#upload-actions-${qIdx} button`);
            if(uploadBtn) { uploadBtn.disabled = true; uploadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i l√™n...'; }

            let htmlImgs = "";
            
            // L·∫•y n·ªôi dung c≈© ƒë·ªÉ ƒë·∫øm s·ªë trang ti·∫øp theo
            const currentHtml = userAnswers[qIdx] || "";
            // ƒê·∫øm s·ªë l∆∞·ª£ng th·∫ª img ƒëang c√≥ (ƒë·ªÉ ƒë√°nh s·ªë trang ti·∫øp theo)
            const existingCount = (currentHtml.match(/<img/g) || []).length;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    // T√≠nh s·ªë trang = S·ªë ·∫£nh c≈© + Th·ª© t·ª± ·∫£nh m·ªõi + 1
                    const pageNum = existingCount + i + 1;
                    const watermarkText = `C√¢u ${qIdx + 1}: T·ªù th·ª© ${pageNum}`;
                    
                    const markedFile = await watermarkImage(files[i], watermarkText);
                    const compressed = await compressImage(markedFile, 0.7, 1000);

                    const formData = new FormData();
                    // L∆∞u ƒë√∫ng th∆∞ m·ª•c submissions/
                    const fileName = `submissions/${currentUser.uid}_${Date.now()}_${i}.jpg`;
                    formData.append('file', compressed, fileName);

                    const res = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", { method: 'PUT', body: formData });
                    if(!res.ok) throw new Error("L·ªói upload ·∫£nh");
                    const data = await res.json();
                    
                    // [T·∫†O KH·ªêI ·∫¢NH C√ì N√öT X√ìA]
                    const uniqueId = `img-wrapper-${Date.now()}-${i}`;
                    
                    // HTML cho t·ª´ng ·∫£nh (bao g·ªìm n√∫t x√≥a)
                    htmlImgs += `
                        <div id="${uniqueId}" class="relative inline-block w-full max-w-md border-2 border-gray-200 rounded-lg mb-4 bg-white group shadow-sm" style="position: relative;">
                            
                            <img src="${data.url}" class="w-full h-auto block rounded-lg" loading="lazy">
                            
                            <div onclick="window.deleteStudentImage('${data.url}', ${qIdx}, '${uniqueId}')" 
                                 class="absolute top-2 right-2 w-9 h-9 bg-red-600 text-white rounded-full flex items-center justify-center shadow-md cursor-pointer hover:bg-red-700 hover:scale-110 transition-all z-50 border-2 border-white"
                                 title="X√≥a ·∫£nh n√†y">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </div>

                            <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] font-bold px-2 py-1 rounded backdrop-blur-sm z-40 pointer-events-none">
                                T·ªù ${pageNum}
                            </div>
                        </div>`;
                }

                // N·ªëi ·∫£nh m·ªõi v√†o b√†i l√†m c≈©
                userAnswers[qIdx] = currentHtml + htmlImgs;
                
                // L∆∞u l·∫°i ngay
                saveLocal();

                // D·ªçn d·∫πp giao di·ªán upload t·∫°m
                window.tempStudentFiles[qIdx] = [];
                document.getElementById(`preview-area-${qIdx}`).innerHTML = ''; 
                document.getElementById(`upload-actions-${qIdx}`).classList.add('hidden'); 
                
                // Render l·∫°i c√¢u h·ªèi ƒë·ªÉ hi·ªán ·∫£nh m·ªõi
                renderQuestion(qIdx); 
                window.showToast("ƒê√£ n·ªôp ·∫£nh th√†nh c√¥ng!", "success");

            } catch (e) {
                console.error(e);
                window.customAlert("L·ªói t·∫£i ·∫£nh: " + e.message, "error");
            } finally {
                if(uploadBtn) { uploadBtn.disabled = false; uploadBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> ƒê√≥ng d·∫•u s·ªë trang & N·ªôp b√†i'; }
            }
        };
        // --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO G√ìC M√ÄN H√åNH (TOAST) ---
        window.showToast = (message, type = 'success') => {
            // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o n·∫øu ch∆∞a c√≥
            let toast = document.getElementById('toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-notification';
                // Style cho th√¥ng b√°o: N·ªïi b·∫≠t, n·∫±m g√≥c tr√™n ph·∫£i
                toast.style.cssText = "position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 12px 24px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); transform: translateX(120%);";
                document.body.appendChild(toast);
            }

            // Ch·ªçn m√†u d·ª±a tr√™n lo·∫°i th√¥ng b√°o
            if (type === 'error') toast.style.backgroundColor = "#EF4444"; // ƒê·ªè
            else if (type === 'info') toast.style.backgroundColor = "#3B82F6"; // Xanh d∆∞∆°ng
            else toast.style.backgroundColor = "#10B981"; // Xanh l√° (Success)

            toast.textContent = message;
            
            // Hi·ªáu ·ª©ng tr∆∞·ª£t ra
            requestAnimationFrame(() => {
                toast.style.transform = "translateX(0)";
            });

            // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => {
                toast.style.transform = "translateX(120%)";
            }, 3000);
        };
        // --- H√ÄM X√ìA T·∫§T C·∫¢ ·∫¢NH C·ª¶A 1 C√ÇU (C√ì X√ìA CLOUD) ---
        window.deleteAllImages = async (qIdx) => {
            const confirmDelete = await window.customConfirm("C·∫¢NH B√ÅO: B·∫°n c√≥ mu·ªën x√≥a TO√ÄN B·ªò ·∫£nh c·ªßa c√¢u n√†y kh√¥ng?\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn c√°c file ƒë√£ t·∫£i l√™n.");
            if (!confirmDelete) return;

            window.isUploading = true; // B·∫≠t c·ªù ƒë·ªÉ tr√°nh b·ªã ph·∫°t khi hi·ªán th√¥ng b√°o
            window.showToast("ƒêang x√≥a d·ªØ li·ªáu tr√™n m√°y ch·ªß...", "info");
            
            try {
                // 1. L·∫•y n·ªôi dung HTML hi·ªán t·∫°i ƒë·ªÉ t√¨m c√°c link ·∫£nh c·∫ßn x√≥a
                const containerHtml = userAnswers[qIdx] || "";
                
                // D√πng Regex ƒë·ªÉ tr√≠ch xu·∫•t t·∫•t c·∫£ src="..." trong th·∫ª img
                const imgMatches = containerHtml.match(/src="([^"]+)"/g);
                
                if (imgMatches && imgMatches.length > 0) {
                    const deletePromises = imgMatches.map(async (srcAttr) => {
                        const url = srcAttr.replace('src="', '').replace('"', '');
                        
                        // Logic l·∫•y key t·ª´ URL
                        let keyName = url;
                        if (url.startsWith('http')) {
                            try {
                                const urlObj = new URL(url);
                                keyName = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                                keyName = decodeURIComponent(keyName);
                            } catch(e) {}
                        }
                        
                        // G·ªçi API x√≥a t·ª´ng ·∫£nh
                        return fetch(`https://upload-helper.phamngockhanh-942001.workers.dev/?key=${encodeURIComponent(keyName)}`, { 
                            method: 'DELETE' 
                        }).catch(err => console.warn("L·ªói x√≥a file:", keyName, err));
                    });

                    // Ch·ªù x√≥a h·∫øt tr√™n Cloud
                    await Promise.all(deletePromises);
                }

                // 2. X√≥a d·ªØ li·ªáu c·ª•c b·ªô
                delete userAnswers[qIdx];
                saveLocal();
                
                // 3. C·∫≠p nh·∫≠t giao di·ªán
                document.getElementById(`submitted-area-wrapper-${qIdx}`).classList.add('hidden');
                document.getElementById(`submitted-area-${qIdx}`).innerHTML = '';
                
                // Reset m·∫£ng file t·∫°m n·∫øu c√≥
                window.tempStudentFiles[qIdx] = []; 
                document.getElementById(`preview-area-${qIdx}`).innerHTML = '';
                document.getElementById(`upload-actions-${qIdx}`).classList.add('hidden');

                window.showToast("ƒê√£ x√≥a s·∫°ch b√†i l√†m v√† file tr√™n server!", "success");

            } catch (e) {
                console.error("L·ªói x√≥a t·∫•t c·∫£:", e);
                window.customAlert("C√≥ l·ªói khi x√≥a file: " + e.message, "error");
            } finally {
                // T·∫Øt c·ªù upload sau 1s ƒë·ªÉ h·ªá th·ªëng gi√°m s√°t l·∫°i b√¨nh th∆∞·ªùng
                setTimeout(() => { window.isUploading = false; }, 1000);
            }
        };
        // --- H√ÄM B·∫ÆN PH√ÅO HOA (ƒê√É S·ª¨A L·ªñI HI·ªÇN TH·ªä ƒê√à L√äN MODAL) ---
        window.fireConfetti = (score) => {
            // 1. D∆∞·ªõi 8 ƒëi·ªÉm th√¨ th√¥i
            if (score < 8) return;

            // C·∫•u h√¨nh Z-Index cao h∆°n Modal (Modal l√† 70, ta ƒë·ªÉ 100)
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 200 };
            const randomInRange = (min, max) => Math.random() * (max - min) + min;

            // --- LEVEL 1: T·ª™ 8 ƒê·∫æN D∆Ø·ªöI 9 ƒêI·ªÇM (B·∫Øn ki·ªÉu Realistic - T∆∞ng b·ª´ng) ---
            if (score >= 8 && score < 9) {
                const count = 200;
                const originDefaults = { origin: { y: 0.7 } };

                function fire(particleRatio, opts) {
                    confetti(Object.assign({}, defaults, originDefaults, opts, {
                        particleCount: Math.floor(count * particleRatio)
                    }));
                }

                fire(0.25, { spread: 26, startVelocity: 55 });
                fire(0.2, { spread: 60 });
                fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                fire(0.1, { spread: 120, startVelocity: 45 });
            }

            // --- LEVEL 2: T·ª™ 9 ƒêI·ªÇM TR·ªû L√äN (Si√™u ng·∫ßu + L·ªùi ch√∫c Gen Z) ---
            if (score >= 9) {
                // A. DANH S√ÅCH L·ªúI CH√öC (Th√™m nhi·ªÅu c√¢u b·∫Øt trend)
                const messages = [
                    "ƒê·ªânh n√≥c, k·ªãch tr·∫ßn! üöÄ",
                    "10 ƒëi·ªÉm kh√¥ng c√≥ nh∆∞ng! üíØ",
                    "Out tr√¨nh server! üéÆ",
                    "Ngh·ªá c·∫£ c·ªß! üé®",
                    "Slay qu√° ƒëi! üíÖ",
                    "Ki·∫øp n·∫°n th·ª© 82 ƒë√£ qua! üôè",
                    "Th·∫ßy Choang t·ª± h√†o v·ªÅ em! üåü",
                    "M√£i m·∫≠n, m√£i keo! ü§ù",
                    "Qu√° d·ªØ ch∆∞a! üò±",
                    "Phong ƒë·ªô l√† nh·∫•t th·ªùi, ƒë·∫≥ng c·∫•p l√† m√£i m√£i! üëë",
                    "Ch·∫•n ƒë·ªông ƒë·ªãa c·∫ßu! üåç",
                    "Ng·∫ßu ƒë√©t ƒë√®n ƒë·∫πt! üòé",
                    "Flex nh·∫π c√°i ƒëi·ªÉm 9+ üí™"
                ];
                
                const randomMsg = messages[Math.floor(Math.random() * messages.length)];

                // B. HI·ªÜN POPUP L·ªúI CH√öC (ƒê√® l√™n t·∫•t c·∫£)
                const msgDiv = document.createElement('div');
                msgDiv.style.cssText = "position:fixed; top:40%; left:50%; transform:translate(-50%, -50%); z-index:300; text-align:center; animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); pointer-events:none; width: 100%;";
                msgDiv.innerHTML = `
                    <div style="font-size: 5rem; margin-bottom: 10px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));">üèÜ</div>
                    <div style="display:inline-block; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: clamp(1.5rem, 4vw, 2.5rem); color: #F59E0B; text-shadow: 2px 2px 0px #fff; background: linear-gradient(135deg, #fff, #FFF7ED); padding: 20px 40px; border-radius: 30px; border: 4px solid #F59E0B; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: rotate(-2deg);">
                        ${randomMsg}
                    </div>
                    <style>@keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0) rotate(10deg); opacity:0; } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity:1; } }</style>
                `;
                document.body.appendChild(msgDiv);
                
                // X√≥a l·ªùi ch√∫c sau 4.5 gi√¢y
                setTimeout(() => {
                    msgDiv.style.transition = "all 0.5s";
                    msgDiv.style.opacity = "0";
                    msgDiv.style.transform = "translate(-50%, -100%)";
                    setTimeout(() => msgDiv.remove(), 500);
                }, 4500);

                // C. B·∫ÆN PH√ÅO HOA LI√äN THANH (3 gi√¢y)
                var duration = 3000;
                var animationEnd = Date.now() + duration;
                
                var interval = setInterval(function() {
                    var timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    var particleCount = 50 * (timeLeft / duration);
                    
                    // B·∫Øn t·ª´ 2 g√≥c m√†n h√¨nh
                    confetti(Object.assign({}, defaults, { 
                        particleCount, 
                        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
                    }));
                    confetti(Object.assign({}, defaults, { 
                        particleCount, 
                        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
                    }));
                }, 250);
            }
        };
    </script>
    <div id="cheatModal" class="fixed inset-0 z-[200] flex items-center justify-center bg-red-900/95 hidden backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transform scale-90 transition-transform duration-300 border-4 border-red-500 relative">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl text-red-600 border-4 border-red-200 animate-pulse">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h2 class="text-2xl font-black text-red-600 mb-2 uppercase">C·∫£nh b√°o vi ph·∫°m!</h2>
            <p class="text-gray-700 mb-4 font-bold">H·ªá th·ªëng ph√°t hi·ªán b·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i.</p>
            <p class="text-sm text-gray-500 mb-6">H√†nh ƒë·ªông n√†y ƒë√£ ƒë∆∞·ª£c ghi l·∫°i. Vui l√≤ng t·∫≠p trung l√†m b√†i n·∫øu kh√¥ng mu·ªën b·ªã h·ªßy k·∫øt qu·∫£.</p>
            
            <div class="bg-red-50 rounded-lg p-3 mb-6 border border-red-100">
                <p class="text-xs text-red-500 font-bold uppercase mb-1">S·ªë l·∫ßn vi ph·∫°m</p>
                <p class="text-3xl font-black text-red-700" id="cheatModalCount">0</p>
            </div>

            <button onclick="closeCheatModal()" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-lg transition-all active:scale-95">
                ƒê√£ hi·ªÉu, t√¥i s·∫Ω quay l·∫°i l√†m b√†i
            </button>
        </div>
    </div>
</body>
</html>
