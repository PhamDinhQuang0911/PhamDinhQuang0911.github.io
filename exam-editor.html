<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản lý đề thi - Toán thầy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        // CẤU HÌNH MACRO CHO GIÁO VIÊN TOÁN VIỆT NAM
        macros: {
          heva: ["\\left\\{\\begin{matrix} #1 \\end{matrix}\\right.", 1],
          hoac: ["\\left[\\begin{matrix} #1 \\end{matrix}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ"
        }
      },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8F9FA; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        .sidebar-item.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 700; border-right: 3px solid #1D4ED8; }
        
        /* Preview Item Styles */
        .preview-item { transition: all 0.2s; border: 1px solid #E5E7EB; cursor: pointer; background: white; }
        .preview-item:hover { border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .preview-item.active { border-color: #3B82F6; ring: 2px solid #DBEAFE; }
        
        /* MathJax Fix - Inline Display */
        mjx-container { display: inline-block !important; margin: 0 2px !important; }
        mjx-container[display="true"] { display: block !important; margin: 1em 0 !important; }

        /* Form & Scrollbar */
        .form-input { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; outline: none; transition: all 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: #3B82F6; ring: 2px solid #DBEAFE; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { backdrop-filter: blur(2px); }
        
        /* Modal Transition */
        .modal { transition: opacity 0.2s ease; }
        .modal.opacity-0 { pointer-events: none; }

        /* Custom Toggle */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <div id="sidebarOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass transition-opacity"></div>

    <aside id="mainSidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex flex-col z-40 shadow-xl transition-transform duration-300 -translate-x-full md:relative md:translate-x-0 flex-shrink-0">
        <div class="p-5 border-b border-gray-100 relative">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm shrink-0"><i class="fa-regular fa-file-lines"></i></div>
                <div class="flex-1 overflow-hidden">
                    <h3 id="sidebarExamTitle" class="font-bold text-gray-800 truncate text-sm" title="Tên đề thi">Đề thi mới</h3>
                    <p class="text-xs text-orange-500 font-bold" id="examStatus">• Bản nháp</p>
                </div>
            </div>
            <button onclick="window.toggleSidebar()" class="md:hidden absolute top-5 right-5 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Cấu hình</div>
            <ul class="space-y-1 mb-6">
                <li><button onclick="switchView('settings'); window.toggleSidebar()" id="menu-settings" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-sliders w-5"></i> Cài đặt & Cấu hình</button></li>
                <li><button onclick="switchView('editor'); window.toggleSidebar()" id="menu-editor" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-list-check w-5"></i> Nội dung câu hỏi</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <button onclick="window.location.href='dashboard.html?view=exambank'" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-arrow-right-from-bracket"></i> Quay lại</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative w-full">
        <div class="md:hidden h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.toggleSidebar()" class="text-gray-600 hover:text-blue-600 text-xl p-1"><i class="fa-solid fa-bars"></i></button>
                <span class="font-bold text-gray-800 text-sm truncate max-w-[200px]" id="mobileHeaderTitle">Cài đặt đề thi</span>
            </div>
        </div>

        <div id="view-settings" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 sticky top-0 bg-gray-50 py-2 z-10">
                    <div class="hidden md:block">
                        <h1 class="text-2xl font-bold text-gray-800">Cài đặt đề thi</h1>
                        <p class="text-sm text-gray-500">Thiết lập thông tin và bảo mật.</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="saveExam('draft')" id="btnSaveDraft" class="flex-1 md:flex-none justify-center px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl text-sm flex items-center gap-2"><i class="fa-regular fa-floppy-disk"></i> Lưu nháp</button>
                        <button onclick="saveExam('published')" id="btnPublish" class="flex-1 md:flex-none justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 text-sm flex items-center gap-2"><i class="fa-solid fa-rocket"></i> Xuất bản</button>
                    </div>
                </div>

                <div id="publishedLinkArea" class="hidden bg-green-50 p-4 rounded-xl border border-green-200 mb-6 shadow-sm">
                    <label class="block text-xs font-bold text-green-700 uppercase mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-check-circle"></i> Link bài thi (Đã xuất bản)
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="settingShareLink" class="w-full px-3 py-2 border border-green-300 rounded-lg text-green-800 bg-white focus:outline-none text-sm font-mono" readonly>
                        <button onclick="copySettingLink()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors text-sm whitespace-nowrap">Sao chép</button>
                        <button onclick="window.open(document.getElementById('settingShareLink').value, '_blank')" class="px-3 py-2 bg-white border border-green-300 text-green-600 font-bold rounded-lg hover:bg-green-50 text-sm"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                    </div>
                </div>

                <div class="space-y-4 md:space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-info-circle text-blue-600 mr-2"></i> Cấu hình chung</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2"><label class="form-group-title">Tên đề thi <span class="text-red-500">*</span></label><input type="text" id="settingTitle" class="form-input font-bold" placeholder="VD: Kiểm tra 15 phút"></div>
                            <div><label class="form-group-title">Khối lớp</label><select id="settingGrade" class="form-input bg-white"><option value="12">Khối 12</option><option value="11">Khối 11</option><option value="10">Khối 10</option><option value="9">Khối 9</option></select></div>
                            <div><label class="form-group-title">Môn học</label><select id="settingSubject" class="form-input bg-white"><option>Toán học</option><option>Vật lý</option><option>Hóa học</option><option>Tiếng Anh</option></select></div>
                            <div><label class="form-group-title">Thời gian (phút)</label><input type="number" id="settingDuration" value="45" class="form-input"></div>
                            <div><label class="form-group-title">Mục đích</label><select id="settingPurpose" class="form-input bg-white"><option value="exam">Thi / Kiểm tra</option><option value="practice">Luyện tập</option></select></div>
                            <div class="col-span-1 md:col-span-2 pt-2 border-t border-dashed"><label class="form-group-title block mb-2">Thời gian mở đề (Tùy chọn)</label><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><span class="text-xs text-gray-500">Từ:</span><input type="datetime-local" id="settingStartTime" class="form-input"></div><div><span class="text-xs text-gray-500">Đến:</span><input type="datetime-local" id="settingEndTime" class="form-input"></div></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-shield-halved text-red-600 mr-2"></i> Bảo mật</h3>
                            <div class="space-y-3">
                                <div><label class="form-group-title">Mật khẩu</label><input type="text" id="settingPassword" placeholder="Không bắt buộc" class="form-input"></div>
                                <div><label class="form-group-title">Số lượt làm</label><input type="number" id="settingAttempts" value="1" class="form-input"></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Giám sát tự động</span><input type="checkbox" id="settingProctoring" class="toggle-checkbox w-5 h-5"></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Đảo câu hỏi</span><input type="checkbox" id="settingShuffle" checked class="toggle-checkbox w-5 h-5"></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-square-poll-vertical text-green-600 mr-2"></i> Kết quả</h3>
                            <div class="space-y-4">
                                <div><label class="form-group-title">Xem điểm</label><div class="grid grid-cols-3 gap-2 text-xs"><label><input type="radio" name="settingShowScore" value="immediate" checked> Ngay</label><label><input type="radio" name="settingShowScore" value="after_exam"> Hết giờ</label><label><input type="radio" name="settingShowScore" value="never"> Không</label></div></div>
                                <div><label class="form-group-title">Xem đáp án</label><div class="grid grid-cols-3 gap-2 text-xs"><label><input type="radio" name="settingShowResult" value="immediate" checked> Ngay</label><label><input type="radio" name="settingShowResult" value="after_exam"> Hết giờ</label><label><input type="radio" name="settingShowResult" value="never"> Không</label></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-users text-purple-600 mr-2"></i> Đối tượng</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('public')"><input type="radio" name="settingAccess" value="public" checked> <div><div class="font-bold text-sm">Công khai</div><div class="text-xs text-gray-500">Ai cũng có thể làm</div></div></label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('class')"><input type="radio" name="settingAccess" value="class"> <div><div class="font-bold text-sm">Lớp học</div><div class="text-xs text-gray-500">Chỉ lớp được chọn</div></div></label>
                            <div id="classSelectionArea" class="hidden pl-6"><select id="settingClassSelect" class="form-input bg-white border-blue-300 font-bold text-blue-800"><option value="">-- Chọn lớp --</option></select></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-editor" class="hidden flex-1 h-full flex flex-col md:flex-row relative bg-gray-100">
            <div class="w-full md:w-1/2 lg:w-5/12 h-1/2 md:h-full flex flex-col border-r border-gray-200 bg-white z-10">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-list-ol mr-2"></i>Danh sách (<span id="totalQCount">0</span>)</h3>
                    <div class="flex gap-2">
                        <button onclick="openScoringModal()" class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-200"><i class="fa-solid fa-calculator mr-1"></i> Chia điểm</button>
                        <button onclick="document.getElementById('texInput').click()" class="px-3 py-1.5 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200"><i class="fa-solid fa-file-import mr-1"></i> LaTeX</button>
                        <input type="file" id="texInput" accept=".tex,.txt" class="hidden" onchange="handleTexUpload(this)">
                    </div>
                </div>
                <div id="previewList" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                    <div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.<br>Hãy thêm câu hỏi hoặc Import Tex.</div>
                </div>
            </div>

            <div class="w-full md:w-1/2 lg:w-7/12 h-1/2 md:h-full flex flex-col bg-white">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-pen-to-square mr-2 text-blue-600"></i>Chỉnh sửa</h3>
                    <div class="flex gap-2">
                        <button onclick="addNewQuestion('mc')" class="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-xs font-bold" title="Thêm Trắc nghiệm">+TN</button>
                        <button onclick="addNewQuestion('tf')" class="p-1.5 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 text-xs font-bold" title="Thêm Đúng/Sai">+ĐS</button>
                        <button onclick="addNewQuestion('short')" class="p-1.5 bg-green-50 text-green-600 rounded hover:bg-green-100 text-xs font-bold" title="Thêm Điền khuyết">+Điền</button>
                        <button onclick="addNewQuestion('essay')" class="p-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 text-xs font-bold" title="Thêm Tự luận">+TL</button>
                        <div class="w-[1px] h-6 bg-gray-200 mx-1"></div>
                        <button onclick="deleteCurrentQuestion()" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <div id="editorArea" class="flex-1 overflow-y-auto p-4 md:p-6 bg-white relative">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>
                </div>
            </div>
        </div>
    </main>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Thông báo</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">Nội dung...</p>
                <input type="text" id="modalInput" class="hidden mt-4 w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none" placeholder="Nhập thông tin...">
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">Hủy bỏ</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-70 px-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-green-600 animate-bounce"><i class="fa-solid fa-check"></i></div>
                <h3 class="text-2xl font-bold text-gray-800">Xuất bản thành công!</h3><p class="text-gray-500 text-sm">Đề thi đã sẵn sàng.</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Link bài thi</label>
                <div class="flex gap-2">
                    <input type="text" id="shareLinkInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-600 bg-white focus:outline-none text-sm font-mono" readonly>
                    <button onclick="copyLink()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors text-sm">Copy</button>
                </div>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="closeShareModal()" class="flex-1 px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-colors">Đóng</button>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="font-bold text-yellow-800"><i class="fa-solid fa-calculator mr-2"></i>Cấu hình điểm số</h3>
                <button onclick="closeScoringModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Trắc nghiệm + Điền từ</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countMcShort">0</b></span></div>
                        <input type="number" id="scoreTotalMcShort" class="form-input text-right font-bold text-blue-600" placeholder="Tổng điểm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Đúng / Sai</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countTF">0</b></span></div>
                        <input type="number" id="scoreTotalTF" class="form-input text-right font-bold text-orange-600" placeholder="Tổng điểm">
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Chi tiết Tự luận (<span id="countEssay">0</span> câu)</h4>
                    <div id="essayScoreList" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-xs text-gray-400 italic">Không có câu tự luận nào.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50 rounded-b-xl">
                <button onclick="closeScoringModal()" class="px-4 py-2 bg-white border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-100">Hủy</button>
                <button onclick="applyScoring()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Áp dụng</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        
        let currentUser = null, currentExamId = null;
        window.questions = []; // SINGLE SOURCE
        window.currentQIndex = -1;

        // MODAL SYSTEM
        let modalResolve = null;
        const modalEl = document.getElementById('customModal');
        const modalBox = document.getElementById('customModalBox');
        const modalTitle = document.getElementById('modalTitle');
        const modalMsg = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnCancel = document.getElementById('btnCancel');

        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if (modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (message, type = 'info') => { return new Promise((resolve) => { modalTitle.innerText = type === 'error' ? 'Lỗi' : 'Thông báo'; modalMsg.innerText = message; modalIcon.innerHTML = type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-bell text-blue-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.add('hidden'); btnConfirm.innerText = "Đã hiểu"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-95'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; modalResolve = resolve; }); };
        window.customConfirm = (message) => { return new Promise((resolve) => { modalTitle.innerText = "Xác nhận"; modalMsg.innerText = message; modalIcon.innerHTML = '<i class="fa-solid fa-circle-question text-orange-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.remove('hidden'); btnConfirm.innerText = "Đồng ý"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-95'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; btnCancel.onclick = () => { resolve(false); modalResolve = null; closeCustomModal(); }; }); };

        // CONTENT FORMATTER (Fix lỗi \\ xuống dòng)
        function formatContent(text) {
            if (text === null || text === undefined) return "";
            return String(text).replace(/\\\\/g, '<br>').replace(/\n/g, '<br>');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadTeacherClasses();
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('id');
                if (examId) { currentExamId = examId; loadExamData(examId); }
            } else { window.location.href = 'index.html'; }
        });

        // --- CORE FUNCTIONS ---
        window.loadExamData = async (id) => {
            try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('settingTitle').value = data.title || '';
                    document.getElementById('settingGrade').value = data.grade || '12';
                    document.getElementById('settingSubject').value = data.subject || 'Toán học';
                    document.getElementById('settingDuration').value = data.duration || 45;
                    document.getElementById('settingPassword').value = data.password || '';
                    // Load Questions & Sort
                    window.questions = data.questions || [];
                    sortQuestionsByType(); // Auto sort on load
                    renderPreviewList();
                    if(window.questions.length > 0) loadQuestionToEditor(0);
                    
                    if(data.status === 'published') {
                        document.getElementById('examStatus').textContent = '• Đã xuất bản';
                        document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                        document.getElementById('publishedLinkArea').classList.remove('hidden');
                        document.getElementById('settingShareLink').value = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + id;
                    }
                }
            } catch(e) { console.error(e); }
        };

        // Hàm sắp xếp câu hỏi theo nhóm
        function sortQuestionsByType() {
            const order = { 'mc': 1, 'tf': 2, 'short': 3, 'essay': 4 };
            window.questions.sort((a, b) => (order[a.type] || 99) - (order[b.type] || 99));
        }

        window.renderPreviewList = () => {
            const list = document.getElementById('previewList');
            document.getElementById('totalQCount').textContent = window.questions.length;
            list.innerHTML = '';
            
            if (window.questions.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.</div>';
                document.getElementById('editorArea').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>';
                window.currentQIndex = -1;
                return;
            }

            let currentType = '';
            window.questions.forEach((q, idx) => {
                // Render Group Header
                let typeLabel = q.type === 'mc' ? 'TRẮC NGHIỆM' : (q.type === 'tf' ? 'ĐÚNG/SAI' : (q.type === 'short' ? 'TRẢ LỜI NGẮN' : 'TỰ LUẬN'));
                if (q.type !== currentType) {
                    currentType = q.type;
                    const header = document.createElement('div');
                    header.className = "text-xs font-bold text-gray-500 uppercase mt-4 mb-2 pl-1 border-b border-gray-200 pb-1";
                    header.textContent = `PHẦN: ${typeLabel}`;
                    list.appendChild(header);
                }

                // Render Preview Item
                const div = document.createElement('div');
                div.className = `preview-item p-4 rounded-lg mb-3 text-sm relative ${idx === window.currentQIndex ? 'active' : ''}`;
                div.onclick = () => loadQuestionToEditor(idx);
                
                // Content with MathJax
                let html = `
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-blue-600">Câu ${idx+1}</span>
                        <span class="bg-orange-100 text-orange-600 text-xs px-2 py-0.5 rounded font-bold">${q.point || 0}đ</span>
                    </div>
                    <div class="mb-3 text-gray-800">${formatContent(q.content)}</div>
                `;

                // Show options/solution preview
                if (q.type === 'mc' && q.options) {
                    html += `<div class="grid grid-cols-2 gap-2 text-xs text-gray-600">`;
                    q.options.forEach((o, i) => {
                        const isCorrect = i === q.correct;
                        html += `<div class="${isCorrect ? 'text-green-600 font-bold' : ''}">${String.fromCharCode(65+i)}. ${formatContent(o)}</div>`;
                    });
                    html += `</div>`;
                } else if (q.type === 'short') {
                    html += `<div class="text-xs text-green-600 mt-2"><b>Đ/A:</b> ${q.answer}</div>`;
                }

                // Show Solution if exists
                if (q.solution) {
                    html += `<div class="mt-3 pt-2 border-t border-dashed border-gray-200 text-xs text-gray-500">
                        <b class="text-green-600"><i class="fa-solid fa-lightbulb"></i> Lời giải:</b> ${formatContent(q.solution)}
                    </div>`;
                }

                div.innerHTML = html;
                list.appendChild(div);
            });
            if(window.MathJax) MathJax.typesetPromise([list]).catch(e=>{});
        };

        // --- SAFE SAVE MEMORY (Fix lỗi null) ---
        window.saveCurrentQuestionToMemory = () => {
            if (window.currentQIndex === -1 || !window.questions[window.currentQIndex]) return;
            const q = window.questions[window.currentQIndex];
            
            const contentEl = document.getElementById('editContent');
            if (!contentEl) return; 

            q.content = contentEl.value;
            const solEl = document.getElementById('editSolution');
            if(solEl) q.solution = solEl.value;
            const pointEl = document.getElementById('editPoint');
            if(pointEl) q.point = parseFloat(pointEl.value) || 0;

            if (q.type === 'mc') {
                const optInputs = document.querySelectorAll('.mc-option');
                q.options = Array.from(optInputs).map(i => i.value);
            } else if (q.type === 'tf') {
                const rows = document.querySelectorAll('#editorArea .flex.items-center.border');
                q.statements = [];
                rows.forEach(row => {
                    const text = row.querySelector('.tf-text').value;
                    const isTrue = row.querySelector('.tf-check').checked;
                    q.statements.push({text, isTrue});
                });
            } else if (q.type === 'short') {
                const ansEl = document.getElementById('editShortAns');
                if(ansEl) q.answer = ansEl.value;
            }
        };

        window.loadQuestionToEditor = (index) => {
            if (window.currentQIndex !== -1 && window.currentQIndex !== index) saveCurrentQuestionToMemory();
            window.currentQIndex = index;
            renderPreviewList(); 
            
            const q = window.questions[index];
            const editor = document.getElementById('editorArea');
            // Render Editor HTML
            let html = `<div class="mb-4"><label class="form-group-title">Nội dung</label><textarea id="editContent" class="form-input min-h-[120px]" oninput="autoSaveMemory()">${q.content || ''}</textarea></div>`;
            
            if (q.type === 'mc') {
                html += `<div class="grid grid-cols-1 gap-3 mb-4">`;
                const opts = q.options || ["", "", "", ""];
                opts.forEach((opt, i) => {
                    html += `<div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full border flex items-center justify-center font-bold cursor-pointer ${q.correct === i ? 'bg-blue-600 text-white' : 'bg-gray-50'}" onclick="setCorrectMC(${i})">${String.fromCharCode(65+i)}</div><input type="text" class="form-input mc-option" value="${opt}" placeholder="Phương án ${String.fromCharCode(65+i)}" oninput="autoSaveMemory()"></div>`;
                });
                html += `</div>`;
            } else if (q.type === 'tf') {
                html += `<div class="space-y-2 mb-4">`;
                const stmts = q.statements || [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}];
                stmts.forEach((s, i) => {
                    html += `<div class="flex items-center gap-2 border p-2 rounded"><span class="font-bold text-xs text-gray-400 w-4">${i+1}</span><input type="text" class="form-input tf-text" value="${s.text}" oninput="autoSaveMemory()"><label class="flex items-center gap-1"><input type="checkbox" class="w-4 h-4 tf-check" ${s.isTrue?'checked':''} onchange="autoSaveMemory()"><span class="text-xs font-bold text-green-600">Đúng</span></label></div>`;
                });
                html += `</div>`;
            } else if (q.type === 'short') {
                html += `<div class="mb-4"><label class="form-group-title">Đáp án mẫu</label><input type="text" id="editShortAns" class="form-input font-bold text-green-700" value="${q.answer || ''}" oninput="autoSaveMemory()"></div>`;
            }

            html += `<div class="mb-4"><label class="form-group-title">Lời giải</label><textarea id="editSolution" class="form-input min-h-[80px]" oninput="autoSaveMemory()">${q.solution || ''}</textarea></div>`;
            html += `<div class="mb-4 w-1/3"><label class="form-group-title">Điểm</label><input type="number" id="editPoint" class="form-input font-bold text-orange-600" value="${q.point || 0}" step="0.1" oninput="autoSaveMemory()"></div>`;
            
            editor.innerHTML = html;
        };

        window.addNewQuestion = (type) => {
            if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();
            const newQ = { type: type, content: "", solution: "", point: 0 };
            if (type === 'mc') { newQ.options = ["", "", "", ""]; newQ.correct = -1; }
            if (type === 'tf') { newQ.statements = [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}]; }
            if (type === 'short') { newQ.answer = ""; }
            window.questions.push(newQ);
            sortQuestionsByType(); 
            renderPreviewList();
            loadQuestionToEditor(window.questions.length - 1); 
        };

        window.autoSaveMemory = () => { saveCurrentQuestionToMemory(); };
        window.setCorrectMC = (idx) => { window.questions[window.currentQIndex].correct = idx; loadQuestionToEditor(window.currentQIndex); };
        window.deleteCurrentQuestion = async () => { if (window.currentQIndex === -1) return; if(await window.customConfirm("Xóa câu hỏi này?")) { window.questions.splice(window.currentQIndex, 1); window.currentQIndex = -1; renderPreviewList(); document.getElementById('editorArea').innerHTML = ''; } };

        // --- IMPORTER ---
        function cleanLatex(text) {
            if (!text) return "";
            let cleaned = text.replace(/^%.*$/gm, '').replace(/(?<!\\)%.*/g, '').replace(/^\s*\[.*?\]/gm, '');
            return cleaned.trim();
        }
        function extractBracedContent(text) { let results = []; let braceCount = 0; let startIndex = -1; for (let i = 0; i < text.length; i++) { if (text[i] === '{') { if (braceCount === 0) startIndex = i + 1; braceCount++; } else if (text[i] === '}') { braceCount--; if (braceCount === 0 && startIndex !== -1) { results.push(text.substring(startIndex, i)); startIndex = -1; } } } return results; }

        window.handleTexUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { 
                if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();
                const content = e.target.result;
                const blockRegex = /\\begin\{(ex|bt|vd)\}([\s\S]*?)\\end\{\1\}/g;
                let match, count = 0;
                while ((match = blockRegex.exec(content)) !== null) {
                    let fullBody = match[2].replace(/^\s*\[.*?\]/, ''); // Clean ID
                    let qType = 'essay'; 
                    let qData = { content: '', solution: '', options: [], statements: [], answer: '', point: 0 };
                    const loigiaiIndex = fullBody.lastIndexOf('\\loigiai');
                    let mainContent = fullBody;
                    if (loigiaiIndex !== -1) {
                        const afterLoigiai = fullBody.substring(loigiaiIndex);
                        const braceContent = extractBracedContent(afterLoigiai);
                        if (braceContent.length > 0) qData.solution = cleanLatex(braceContent[0]);
                        mainContent = fullBody.substring(0, loigiaiIndex);
                    }
                    if (mainContent.includes('\\choiceTF')) {
                        qType = 'tf'; const parts = mainContent.split('\\choiceTF'); qData.content = cleanLatex(parts[0]);
                        const rawStatements = extractBracedContent(parts[1]);
                        rawStatements.forEach(stmt => { qData.statements.push({ text: cleanLatex(stmt.replace('\\True', '').trim()), isTrue: stmt.includes('\\True') }); });
                    } else if (mainContent.includes('\\choice')) {
                        qType = 'mc'; const parts = mainContent.split('\\choice'); qData.content = cleanLatex(parts[0]);
                        const rawOptions = extractBracedContent(parts[1]);
                        rawOptions.forEach((opt, idx) => { if (idx < 4) { qData.options.push(cleanLatex(opt.replace('\\True', '').trim())); if (opt.includes('\\True')) qData.correct = idx; } });
                    } else if (mainContent.includes('\\shortans')) {
                        qType = 'short'; const parts = mainContent.split('\\shortans'); qData.content = cleanLatex(parts[0]);
                        const ansContent = extractBracedContent(mainContent.substring(mainContent.indexOf('\\shortans')));
                        if(ansContent.length>0) qData.answer = cleanLatex(ansContent[0]);
                    } else { qType = 'essay'; qData.content = cleanLatex(mainContent); }
                    window.questions.push({ type: qType, ...qData }); count++;
                }
                sortQuestionsByType();
                renderPreviewList();
                window.showToast(`Đã nhập ${count} câu hỏi!`);
                input.value = "";
            };
            reader.readAsText(file);
        }

        // --- SAVE EXAM ---
        window.saveExam = async function(status) {
            if (window.currentQIndex !== -1) saveCurrentQuestionToMemory(); // Save pending changes
            const title = document.getElementById('settingTitle').value;
            if(!title) return window.customAlert("Vui lòng nhập tên đề thi!", "error");

            const btn = status === 'published' ? document.getElementById('btnPublish') : document.getElementById('btnSaveDraft');
            const originalText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...'; btn.disabled = true;

            const settings = {
                title: title,
                grade: document.getElementById('settingGrade').value,
                subject: document.getElementById('settingSubject').value,
                duration: parseInt(document.getElementById('settingDuration').value) || 0,
                purpose: document.getElementById('settingPurpose').value,
                startTime: document.getElementById('settingStartTime').value,
                endTime: document.getElementById('settingEndTime').value,
                password: document.getElementById('settingPassword').value,
                attempts: parseInt(document.getElementById('settingAttempts').value) || 0,
                proctoring: document.getElementById('settingProctoring').checked,
                shuffle: document.getElementById('settingShuffle').checked,
                showScore: document.querySelector('input[name="settingShowScore"]:checked').value,
                showResult: document.querySelector('input[name="settingShowResult"]:checked').value,
                accessType: document.querySelector('input[name="settingAccess"]:checked').value,
                allowedClassId: document.getElementById('settingClassSelect').value
            };

            try {
                const examRef = currentExamId ? doc(db, "exams", currentExamId) : doc(collection(db, "exams"));
                await setDoc(examRef, { ...settings, teacherId: currentUser.uid, questions: window.questions, questionCount: window.questions.length, status: status, updatedAt: new Date().toISOString(), ...(currentExamId ? {} : { createdAt: new Date().toISOString() }) }, { merge: true });
                currentExamId = examRef.id;
                document.getElementById('sidebarExamTitle').textContent = title;
                if (status === 'published') {
                    const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + currentExamId;
                    document.getElementById('shareLinkInput').value = link;
                    document.getElementById('shareModal').classList.remove('opacity-0', 'pointer-events-none');
                    document.getElementById('shareModal').querySelector('div').classList.add('scale-100');
                    document.getElementById('examStatus').textContent = '• Đã xuất bản';
                    document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                    // UPDATE LINK AREA
                    document.getElementById('publishedLinkArea').classList.remove('hidden');
                    document.getElementById('settingShareLink').value = link;
                } else { window.showToast("Đã lưu bản nháp thành công!", "success"); }
                if (!window.location.search.includes('id=')) window.history.pushState({path:window.location.href.split('?')[0] + '?id=' + currentExamId},'',window.location.href.split('?')[0] + '?id=' + currentExamId);
            } catch(e) { console.error(e); window.customAlert("Lỗi lưu: " + e.message, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        // --- HELPERS ---
        window.switchView = (viewId) => {
            document.getElementById('view-settings').classList.add('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('flex');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            if (viewId === 'settings') { document.getElementById('view-settings').classList.remove('hidden'); document.getElementById('menu-settings').classList.add('active'); } 
            else { document.getElementById('view-editor').classList.remove('hidden'); document.getElementById('view-editor').classList.add('flex'); document.getElementById('menu-editor').classList.add('active'); if(window.MathJax) MathJax.typesetPromise(); }
        }
        
        window.copyLink = () => { document.getElementById("shareLinkInput").select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); }
        window.copySettingLink = () => { document.getElementById("settingShareLink").select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); }
        window.closeShareModal = () => { document.getElementById('shareModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.showToast = (message, type='success') => { const c = document.getElementById('toastContainer'); const d = document.createElement('div'); d.className = `bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] transform translate-x-full transition-transform duration-300`; d.innerHTML = `<div><h4 class="font-bold text-gray-800 text-sm">THÔNG BÁO</h4><p class="text-sm text-gray-600">${message}</p></div>`; c.appendChild(d); requestAnimationFrame(()=>d.classList.remove('translate-x-full')); setTimeout(()=>{d.classList.add('translate-x-full'); setTimeout(()=>d.remove(), 500);}, 3000); }
        window.togglePrivasySettings = (type) => { document.getElementById('classSelectionArea').className = type === 'class' ? 'pl-6 block' : 'hidden'; }
        async function loadTeacherClasses() { const s = document.getElementById('settingClassSelect'); if (!currentUser) return; const q = query(collection(db, "classes"), where("teacherId", "==", currentUser.uid)); const snap = await getDocs(q); s.innerHTML = ''; const d = document.createElement('option'); d.value = ""; d.textContent = "-- Chọn lớp học --"; s.appendChild(d); snap.forEach(doc => { const o = document.createElement('option'); o.value = doc.id; o.textContent = doc.data().name; s.appendChild(o); }); }
        window.toggleSidebar = () => { const s = document.getElementById('mainSidebar'); const o = document.getElementById('sidebarOverlay'); if (s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } }
        
        // Scoring Logic
        window.openScoringModal = () => { document.getElementById('scoringModal').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('scoringModal').querySelector('div').classList.add('scale-100'); let cM=0, cTF=0, cE=0; let h=''; window.questions.forEach((q,i)=>{ if(q.type==='essay'){ cE++; h+=`<div class="flex items-center gap-2 text-sm"><span class="w-16 font-bold">Câu ${i+1}</span><input type="number" id="essay-score-${i}" class="form-input h-8 text-right w-20" value="${q.point||0}" step="0.1"></div>`; } else if(q.type==='tf') cTF++; else cM++; }); document.getElementById('countMcShort').textContent=cM; document.getElementById('countTF').textContent=cTF; document.getElementById('countEssay').textContent=cE; document.getElementById('essayScoreList').innerHTML = cE>0 ? h : '<p class="text-xs text-gray-400 italic">Không có câu tự luận.</p>'; }
        window.closeScoringModal = () => { document.getElementById('scoringModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.applyScoring = () => { const tM = parseFloat(document.getElementById('scoreTotalMcShort').value)||0; const tTF = parseFloat(document.getElementById('scoreTotalTF').value)||0; let cM=0, cTF=0; window.questions.forEach(q=>{if(q.type==='mc'||q.type==='short')cM++; else if(q.type==='tf')cTF++;}); const pM=cM>0?(tM/cM):0; const pTF=cTF>0?(tTF/cTF):0; window.questions.forEach((q,i)=>{ if(q.type==='mc'||q.type==='short') q.point=parseFloat(pM.toFixed(2)); else if(q.type==='tf') q.point=parseFloat(pTF.toFixed(2)); else if(q.type==='essay'){ const inp=document.getElementById(`essay-score-${i}`); if(inp) q.point=parseFloat(inp.value)||0; } }); closeScoringModal(); renderPreviewList(); window.showToast("Đã chia điểm!"); }
    </script>
</body>
</html>
