<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đề thi - Toán thầy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8F9FA; }
        .sidebar-item.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 700; border-right: 3px solid #1D4ED8; }
        .question-card:hover { border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        mjx-container { font-size: 110% !important; }
        
        /* Form styles */
        .form-group-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6B7280; margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; outline: none; transition: all 0.2s; }
        .form-input:focus { border-color: #3B82F6; ring: 2px solid #DBEAFE; }
        
        /* Custom Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-sm flex-shrink-0">
        <div class="p-5 border-b border-gray-100">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                    <i class="fa-regular fa-file-lines"></i>
                </div>
                <div class="flex-1 overflow-hidden">
                    <h3 id="sidebarExamTitle" class="font-bold text-gray-800 truncate text-sm" title="Tên đề thi">Đề thi mới</h3>
                    <p class="text-xs text-orange-500 font-bold" id="examStatus">• Bản nháp</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Cấu hình</div>
            <ul class="space-y-1 mb-6">
                <li>
                    <button onclick="switchView('settings')" id="menu-settings" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm">
                        <i class="fa-solid fa-sliders w-5"></i> Cài đặt & Cấu hình
                    </button>
                </li>
                <li>
                    <button onclick="switchView('editor')" id="menu-editor" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm">
                        <i class="fa-solid fa-list-check w-5"></i> Nội dung câu hỏi
                    </button>
                </li>
            </ul>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <button onclick="window.location.href='dashboard.html'" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> Quay lại Sảnh chính
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
        
        <div id="view-settings" class="flex-1 overflow-y-auto p-8 scroll-smooth">
            <div class="max-w-4xl mx-auto pb-10">
                <div class="flex justify-between items-center mb-8 sticky top-0 bg-gray-50 py-2 z-10">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Cài đặt đề thi</h1>
                        <p class="text-sm text-gray-500">Thiết lập thông tin, thời gian và bảo mật.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveExam('draft')" id="btnSaveDraft" class="px-5 py-2.5 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl transition-all flex items-center gap-2 text-sm">
                            <i class="fa-regular fa-floppy-disk"></i> Lưu nháp
                        </button>
                        <button onclick="saveExam('published')" id="btnPublish" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-rocket"></i> Xuất bản
                        </button>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-5 pb-3 border-b border-gray-100 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-sm"><i class="fa-solid fa-info"></i></div>
                            Cấu hình chung
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="form-group-title">Tên đề thi <span class="text-red-500">*</span></label>
                                <input type="text" id="settingTitle" class="form-input font-bold text-gray-700" placeholder="VD: Kiểm tra 15 phút Toán đại số">
                            </div>
                            <div>
                                <label class="form-group-title">Khối lớp</label>
                                <select id="settingGrade" class="form-input bg-white">
                                    <option value="12">Khối 12</option>
                                    <option value="11">Khối 11</option>
                                    <option value="10">Khối 10</option>
                                    <option value="9">Khối 9</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-group-title">Môn học</label>
                                <select id="settingSubject" class="form-input bg-white">
                                    <option>Toán học</option>
                                    <option>Vật lý</option>
                                    <option>Hóa học</option>
                                    <option>Tiếng Anh</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-group-title">Thời gian (phút)</label>
                                <input type="number" id="settingDuration" value="45" class="form-input">
                                <p class="text-xs text-gray-400 mt-1">Nhập 0 để không giới hạn.</p>
                            </div>
                            <div>
                                <label class="form-group-title">Mục đích</label>
                                <select id="settingPurpose" class="form-input bg-white">
                                    <option value="exam">Kiểm tra / Thi</option>
                                    <option value="practice">Luyện tập</option>
                                </select>
                            </div>
                            <div class="col-span-2 border-t border-dashed border-gray-200 pt-4 mt-2">
                                <label class="form-group-title mb-3 block">Thời gian giao đề (Tùy chọn)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><span class="text-xs text-gray-500 mb-1 block">Từ ngày</span><input type="datetime-local" id="settingStartTime" class="form-input text-sm"></div>
                                    <div><span class="text-xs text-gray-500 mb-1 block">Đến ngày</span><input type="datetime-local" id="settingEndTime" class="form-input text-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-5 pb-3 border-b border-gray-100 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center text-sm"><i class="fa-solid fa-shield-halved"></i></div>
                            Bảo mật
                        </h3>
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="form-group-title">Mật khẩu đề thi</label><input type="text" id="settingPassword" placeholder="Để trống nếu không cần" class="form-input"></div>
                                <div><label class="form-group-title">Số lượt làm bài</label><input type="number" id="settingAttempts" value="1" class="form-input"></div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                                <div><p class="font-bold text-gray-700 text-sm">Giám sát tự động</p><p class="text-xs text-gray-400">Cảnh báo khi rời màn hình</p></div>
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settingProctoring" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                                <div><p class="font-bold text-gray-700 text-sm">Đảo câu hỏi</p><p class="text-xs text-gray-400">Mỗi học sinh một mã đề</p></div>
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settingShuffle" class="sr-only peer" checked><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-5 pb-3 border-b border-gray-100 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center text-sm"><i class="fa-solid fa-square-poll-vertical"></i></div>
                            Kết quả thi
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="form-group-title mb-2 block">Cho xem điểm</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <label class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border hover:border-blue-300"><input type="radio" name="settingShowScore" value="immediate" class="text-blue-600" checked><span class="text-sm font-medium">Làm xong xem ngay</span></label>
                                    <label class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border hover:border-blue-300"><input type="radio" name="settingShowScore" value="after_exam" class="text-blue-600"><span class="text-sm font-medium">Khi hết giờ</span></label>
                                    <label class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border hover:border-blue-300"><input type="radio" name="settingShowScore" value="never" class="text-blue-600"><span class="text-sm font-medium">Không xem</span></label>
                                </div>
                            </div>
                            <div>
                                <label class="form-group-title mb-2 block">Cho xem đáp án chi tiết</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <label class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border hover:border-blue-300"><input type="radio" name="settingShowResult" value="immediate" class="text-blue-600" checked><span class="text-sm font-medium">Làm xong xem ngay</span></label>
                                    <label class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border hover:border-blue-300"><input type="radio" name="settingShowResult" value="after_exam" class="text-blue-600"><span class="text-sm font-medium">Khi hết giờ</span></label>
                                    <label class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border hover:border-blue-300"><input type="radio" name="settingShowResult" value="never" class="text-blue-600"><span class="text-sm font-medium">Không xem</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-5 pb-3 border-b border-gray-100 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center text-sm"><i class="fa-solid fa-users"></i></div>
                            Ai được phép làm
                        </h3>
                         <div class="flex flex-col gap-3">
                             <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all" onclick="togglePrivasySettings('public')">
                                 <input type="radio" name="settingAccess" value="public" class="w-5 h-5 text-blue-600" checked>
                                 <div><div class="font-bold text-sm text-gray-800">Công khai (Public)</div><div class="text-xs text-gray-500">Ai có link cũng có thể vào làm bài</div></div>
                             </label>
                             
                             <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all" onclick="togglePrivasySettings('class')">
                                 <input type="radio" name="settingAccess" value="class" class="w-5 h-5 text-blue-600">
                                 <div><div class="font-bold text-sm text-gray-800">Chỉ lớp được giao</div><div class="text-xs text-gray-500">Chỉ học sinh trong lớp được chọn mới được làm</div></div>
                             </label>

                             <div id="classSelectionArea" class="hidden pl-10 pr-2 transition-all bg-gray-50 p-3 rounded-lg border border-gray-200 mt-1">
                                 <label class="form-group-title mb-1 block">Chọn lớp áp dụng:</label>
                                 <select id="settingClassSelect" class="form-input bg-white border-blue-300 text-blue-800 font-bold">
                                     <option value="">-- Đang tải danh sách lớp --</option>
                                 </select>
                                 <p class="text-xs text-orange-500 mt-2 italic flex items-center gap-1">
                                     <i class="fa-solid fa-circle-exclamation"></i> Bài thi sẽ tự động hiện trong tài khoản của học sinh lớp này.
                                 </p>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <div id="view-editor" class="flex-1 flex hidden h-full">
            <div class="flex-1 overflow-y-auto p-6 bg-gray-100 scroll-smooth" id="questionsContainer">
                <div class="max-w-3xl mx-auto pb-24 space-y-4" id="questionsList">
                    <div id="emptyState" class="text-center py-20 text-gray-400 border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fa-regular fa-folder-open text-blue-300"></i></div>
                        <h3 class="text-lg font-bold text-gray-600">Chưa có câu hỏi nào</h3>
                        <p class="text-sm mt-1">Chọn loại câu hỏi bên phải để bắt đầu soạn đề.</p>
                    </div>
                </div>
            </div>

            <div class="w-72 bg-white border-l border-gray-200 p-5 flex flex-col gap-3 shadow-xl z-10 flex-shrink-0">
                <h3 class="font-bold text-gray-800 text-sm mb-2 flex items-center gap-2"><i class="fa-solid fa-plus-circle text-blue-600"></i> Thêm câu hỏi</h3>
                <button onclick="addQuestion('mc')" class="w-full p-3 bg-white border border-gray-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold"><i class="fa-solid fa-list-ul"></i></div><div><span class="text-sm font-bold text-gray-700 block">Trắc nghiệm</span></div>
                </button>
                <button onclick="addQuestion('essay')" class="w-full p-3 bg-white border border-gray-200 hover:border-purple-500 hover:bg-purple-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center font-bold"><i class="fa-solid fa-pen-nib"></i></div><div><span class="text-sm font-bold text-gray-700 block">Tự luận</span></div>
                </button>
                <button onclick="addQuestion('tf')" class="w-full p-3 bg-white border border-gray-200 hover:border-orange-500 hover:bg-orange-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center font-bold"><i class="fa-solid fa-check-double"></i></div><div><span class="text-sm font-bold text-gray-700 block">Đúng / Sai</span></div>
                </button>
                <button onclick="addQuestion('short')" class="w-full p-3 bg-white border border-gray-200 hover:border-green-500 hover:bg-green-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center font-bold"><i class="fa-solid fa-keyboard"></i></div><div><span class="text-sm font-bold text-gray-700 block">Trả lời ngắn</span></div>
                </button>
                <div class="border-t border-gray-100 my-2 pt-3">
                    <h3 class="font-bold text-gray-800 text-sm mb-3 flex items-center gap-2"><i class="fa-solid fa-file-import text-green-600"></i> Nhập liệu</h3>
                    <button onclick="document.getElementById('texInput').click()" class="w-full py-2 bg-green-50 text-green-700 border border-green-200 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors flex items-center justify-center gap-2 mb-2"><i class="fa-solid fa-file-arrow-up"></i> Tải file LaTeX</button>
                    <input type="file" id="texInput" accept=".tex,.txt" class="hidden" onchange="handleTexUpload(this)">
                </div>
            </div>
        </div>
    </main>

    <div id="shareModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-70">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-green-600 animate-bounce"><i class="fa-solid fa-check"></i></div>
                <h3 class="text-2xl font-bold text-gray-800">Xuất bản thành công!</h3><p class="text-gray-500">Đề thi đã sẵn sàng. Hãy gửi link dưới đây cho học sinh.</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Link bài thi</label>
                <div class="flex gap-2">
                    <input type="text" id="shareLinkInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-600 bg-white focus:outline-none" readonly>
                    <button onclick="copyLink()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">Copy</button>
                </div>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="window.open(document.getElementById('shareLinkInput').value, '_blank')" class="px-5 py-2.5 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl transition-colors">Mở thử</button>
                <button onclick="closeShareModal()" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-colors">Đóng</button>
            </div>
        </div>
    </div>

    <template id="tpl-mc"><div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group transition-all hover:border-blue-400 mb-6" data-type="mc"><div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10"><button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button></div><div class="mb-3"><span class="inline-block px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Trắc nghiệm</span><textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-200 outline-none min-h-[80px] text-gray-700 text-sm" placeholder="Nhập nội dung câu hỏi..."></textarea></div><div class="grid grid-cols-2 gap-3 mb-3"><div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg"><input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600"><input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm" placeholder="Phương án A"></div><div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg"><input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600"><input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm" placeholder="Phương án B"></div><div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg"><input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600"><input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm" placeholder="Phương án C"></div><div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg"><input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600"><input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm" placeholder="Phương án D"></div></div><input type="text" class="w-full px-3 py-2 text-xs text-gray-500 italic border-b border-dashed border-gray-200 focus:border-blue-300 outline-none bg-transparent" placeholder="Lời giải..."></div></template>
    <template id="tpl-essay"><div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group mb-6 transition-all hover:border-purple-400" data-type="essay"><div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10"><button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button></div><div class="mb-3"><span class="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Tự luận</span><textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none min-h-[100px] text-gray-700 text-sm" placeholder="Nhập đề bài tự luận..."></textarea></div><textarea class="w-full p-3 bg-white border border-gray-200 rounded-lg text-sm min-h-[60px] outline-none" placeholder="Đáp án tham khảo..."></textarea></div></template>
    <template id="tpl-tf"><div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group mb-6 transition-all hover:border-orange-400" data-type="tf"><div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10"><button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button></div><div class="mb-3"><span class="inline-block px-2 py-0.5 bg-orange-100 text-orange-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Đúng / Sai</span><textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-orange-200 outline-none min-h-[60px] text-gray-700 text-sm" placeholder="Nhập câu dẫn..."></textarea></div><div class="space-y-2 mb-3"><div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-gray-400 uppercase"><div class="col-span-8 pl-1">Mệnh đề</div><div class="col-span-2 text-center text-green-600">Đúng</div><div class="col-span-2 text-center text-red-500">Sai</div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm" placeholder="Mệnh đề 1"></div><div class="col-span-2 text-center"><input type="radio" name="tf-1-${id}" value="true" class="w-4 h-4"></div><div class="col-span-2 text-center"><input type="radio" name="tf-1-${id}" value="false" class="w-4 h-4"></div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm" placeholder="Mệnh đề 2"></div><div class="col-span-2 text-center"><input type="radio" name="tf-2-${id}" value="true" class="w-4 h-4"></div><div class="col-span-2 text-center"><input type="radio" name="tf-2-${id}" value="false" class="w-4 h-4"></div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm" placeholder="Mệnh đề 3"></div><div class="col-span-2 text-center"><input type="radio" name="tf-3-${id}" value="true" class="w-4 h-4"></div><div class="col-span-2 text-center"><input type="radio" name="tf-3-${id}" value="false" class="w-4 h-4"></div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm" placeholder="Mệnh đề 4"></div><div class="col-span-2 text-center"><input type="radio" name="tf-4-${id}" value="true" class="w-4 h-4"></div><div class="col-span-2 text-center"><input type="radio" name="tf-4-${id}" value="false" class="w-4 h-4"></div></div></div><textarea class="w-full px-3 py-2 text-xs bg-gray-50 border border-gray-200 rounded outline-none h-16 resize-none" placeholder="Giải thích..."></textarea></div></template>
    <template id="tpl-short"><div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group mb-6 transition-all hover:border-green-400" data-type="short"><div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10"><button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button></div><div class="mb-3"><span class="inline-block px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Trả lời ngắn</span><textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-green-200 outline-none min-h-[80px] text-gray-700 text-sm" placeholder="Nhập câu hỏi..."></textarea></div><div class="mb-3"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Đáp án mẫu:</label><input type="text" class="w-full px-3 py-2 border border-green-200 bg-green-50 rounded-lg text-sm font-bold text-green-800 outline-none" placeholder="VD: 15 cm"></div><textarea class="w-full px-3 py-2 text-xs bg-white border border-gray-200 rounded outline-none h-16 resize-none" placeholder="Lời giải..."></textarea></div></template>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-96 transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Thông báo</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">Nội dung...</p>
                <input type="text" id="modalInput" class="hidden mt-4 w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none" placeholder="Nhập thông tin...">
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">Hủy bỏ</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">Đồng ý</button>
            </div>
        </div>
    </div>
    <div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col gap-3"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentExamId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadTeacherClasses();
                
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('id');
                if (examId) {
                    currentExamId = examId;
                    loadExamData(examId);
                } else {
                    document.getElementById('sidebarExamTitle').textContent = "Đề thi mới (Chưa lưu)";
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- CUSTOM MODAL LOGIC START ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icons = { success: '<i class="fa-solid fa-circle-check text-green-500"></i>', error: '<i class="fa-solid fa-circle-exclamation text-red-500"></i>', info: '<i class="fa-solid fa-circle-info text-blue-500"></i>' };
            const borderColors = { success: 'border-green-500', error: 'border-red-500', info: 'border-blue-500' };
            toast.className = `bg-white border-l-4 ${borderColors[type]} shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `<div class="text-xl">${icons[type]}</div><div><h4 class="font-bold text-gray-800 text-sm uppercase">${type==='success'?'Thành công':(type==='error'?'Lỗi':'Thông báo')}</h4><p class="text-sm text-gray-600">${message}</p></div>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        // --- CUSTOM MODAL LOGIC START (ĐÃ SỬA LỖI) ---
        
        // Biến lưu trạng thái Promise
        let modalResolve = null;

        // Lấy các phần tử DOM
        const modalEl = document.getElementById('customModal');
        const modalBox = document.getElementById('customModalBox');
        const modalTitle = document.getElementById('modalTitle');
        const modalMsg = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const modalInput = document.getElementById('modalInput');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnCancel = document.getElementById('btnCancel');

        // Hàm đóng Modal
        window.closeCustomModal = () => {
            modalEl.classList.add('opacity-0', 'pointer-events-none');
            modalBox.classList.remove('scale-100'); 
            modalBox.classList.add('scale-95');
            
            // Nếu đóng mà chưa bấm nút nào (vd: bấm X), coi như là Hủy (null)
            if (modalResolve) {
                modalResolve(null);
                modalResolve = null;
            }
        };

        // Hàm hiện thông báo (Toast)
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icons = { success: '<i class="fa-solid fa-circle-check text-green-500"></i>', error: '<i class="fa-solid fa-circle-exclamation text-red-500"></i>', info: '<i class="fa-solid fa-circle-info text-blue-500"></i>' };
            const borderColors = { success: 'border-green-500', error: 'border-red-500', info: 'border-blue-500' };
            toast.className = `bg-white border-l-4 ${borderColors[type]} shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `<div class="text-xl">${icons[type]}</div><div><h4 class="font-bold text-gray-800 text-sm uppercase">${type==='success'?'Thành công':(type==='error'?'Lỗi':'Thông báo')}</h4><p class="text-sm text-gray-600">${message}</p></div>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        // Hàm Confirm (Xác nhận) - SỬA LỖI QUAN TRỌNG TẠI ĐÂY
        window.customConfirm = (message, title = "Xác nhận") => {
            return new Promise((resolve) => {
                // Setup UI
                modalTitle.innerText = title; 
                modalMsg.innerText = message;
                modalIcon.innerHTML = '<i class="fa-solid fa-circle-question text-orange-500"></i>';
                modalInput.classList.add('hidden'); 
                btnCancel.classList.remove('hidden'); 
                btnConfirm.innerText = "Đồng ý";
                
                // Hiện Modal
                modalEl.classList.remove('opacity-0', 'pointer-events-none'); 
                modalBox.classList.remove('scale-95'); 
                modalBox.classList.add('scale-100');

                // --- KHẮC PHỤC LỖI: Resolve trước, Close sau ---
                btnConfirm.onclick = () => { 
                    resolve(true); // Báo là Đồng ý
                    modalResolve = null; // Xóa biến nhớ để hàm close không ghi đè
                    closeCustomModal(); 
                };
                
                btnCancel.onclick = () => { 
                    resolve(false); // Báo là Hủy
                    modalResolve = null; 
                    closeCustomModal(); 
                };
                
                // Lưu resolve để dùng cho nút X
                modalResolve = resolve;
            });
        };

        // Hàm Alert (Thông báo đơn)
        window.customAlert = (message, type = 'info') => {
            return new Promise((resolve) => {
                modalTitle.innerText = type === 'error' ? 'Lỗi' : 'Thông báo'; 
                modalMsg.innerText = message;
                modalIcon.innerHTML = type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : (type === 'success' ? '<i class="fa-solid fa-circle-check text-green-500"></i>' : '<i class="fa-solid fa-bell text-blue-500"></i>');
                modalInput.classList.add('hidden'); 
                btnCancel.classList.add('hidden'); 
                btnConfirm.innerText = "Đã hiểu";
                
                modalEl.classList.remove('opacity-0', 'pointer-events-none'); 
                modalBox.classList.remove('scale-95'); 
                modalBox.classList.add('scale-100');
                
                // --- KHẮC PHỤC LỖI ---
                btnConfirm.onclick = () => { 
                    resolve(true); 
                    modalResolve = null;
                    closeCustomModal(); 
                };
                
                modalResolve = resolve;
            });
        };
        // --- CUSTOM MODAL LOGIC END ---

        async function loadTeacherClasses() {
            const select = document.getElementById('settingClassSelect');
            select.innerHTML = '<option value="">-- Đang tải... --</option>';
            if (!currentUser) return;
            try {
                const q = query(collection(db, "classes"), where("teacherId", "==", currentUser.uid));
                const snap = await getDocs(q);
                select.innerHTML = '';
                if (snap.empty) {
                    const opt = document.createElement('option'); opt.value = ""; opt.textContent = "Thầy chưa tạo lớp nào!"; select.appendChild(opt);
                } else {
                    const defaultOpt = document.createElement('option'); defaultOpt.value = ""; defaultOpt.textContent = "-- Chọn lớp học --"; select.appendChild(defaultOpt);
                    snap.forEach(doc => {
                        const cl = doc.data(); const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = `${cl.name} (Sĩ số: ${cl.studentCount || 0})`; select.appendChild(opt);
                    });
                }
            } catch(e) { console.error("Lỗi tải lớp:", e); select.innerHTML = '<option value="">Lỗi: ' + e.message + '</option>'; }
        }

        window.togglePrivasySettings = function(type) {
            const area = document.getElementById('classSelectionArea');
            if (type === 'class') area.classList.remove('hidden'); else area.classList.add('hidden');
        }

        async function loadExamData(id) {
            try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('settingTitle').value = data.title || '';
                    document.getElementById('settingGrade').value = data.grade || '12';
                    document.getElementById('settingSubject').value = data.subject || 'Toán học';
                    document.getElementById('settingDuration').value = data.duration || 45;
                    document.getElementById('settingPurpose').value = data.purpose || 'exam';
                    document.getElementById('settingStartTime').value = data.startTime || '';
                    document.getElementById('settingEndTime').value = data.endTime || '';
                    document.getElementById('settingPassword').value = data.password || '';
                    document.getElementById('settingAttempts').value = data.attempts || 1;
                    document.getElementById('settingProctoring').checked = data.proctoring || false;
                    document.getElementById('settingShuffle').checked = data.shuffle !== false;

                    if(data.showScore) document.querySelector(`input[name="settingShowScore"][value="${data.showScore}"]`).checked = true;
                    if(data.showResult) document.querySelector(`input[name="settingShowResult"][value="${data.showResult}"]`).checked = true;
                    
                    if(data.accessType) {
                        document.querySelector(`input[name="settingAccess"][value="${data.accessType}"]`).checked = true;
                        togglePrivasySettings(data.accessType);
                    }
                    if(data.allowedClassId) { setTimeout(() => { document.getElementById('settingClassSelect').value = data.allowedClassId; }, 1000); }

                    document.getElementById('sidebarExamTitle').textContent = data.title;
                    if (data.questions && data.questions.length > 0) {
                        document.getElementById('emptyState').classList.add('hidden');
                        data.questions.forEach(q => addQuestion(q.type === 'mc' ? 'mc' : (q.type === 'tf' ? 'tf' : (q.type === 'short' ? 'short' : 'essay')), q));
                    }
                }
            } catch (e) { console.error(e); }
        }

        window.saveExam = async function(status) {
            const title = document.getElementById('settingTitle').value;
            if(!title) return customAlert("Vui lòng nhập tên đề thi!", "error");

            const accessType = document.querySelector('input[name="settingAccess"]:checked').value;
            const allowedClassId = document.getElementById('settingClassSelect').value;

            if(accessType === 'class' && !allowedClassId) {
                await customAlert("Vui lòng chọn lớp học để giao đề!", "error");
                document.getElementById('settingClassSelect').focus();
                return;
            }

            const settings = {
                title: title,
                grade: document.getElementById('settingGrade').value,
                subject: document.getElementById('settingSubject').value,
                duration: parseInt(document.getElementById('settingDuration').value) || 0,
                purpose: document.getElementById('settingPurpose').value,
                startTime: document.getElementById('settingStartTime').value,
                endTime: document.getElementById('settingEndTime').value,
                password: document.getElementById('settingPassword').value,
                attempts: parseInt(document.getElementById('settingAttempts').value) || 0,
                proctoring: document.getElementById('settingProctoring').checked,
                shuffle: document.getElementById('settingShuffle').checked,
                showScore: document.querySelector('input[name="settingShowScore"]:checked').value,
                showResult: document.querySelector('input[name="settingShowResult"]:checked').value,
                accessType: accessType,
                allowedClassId: accessType === 'class' ? allowedClassId : null
            };

            const questionCards = document.querySelectorAll('.question-card');
            const questions = [];
            questionCards.forEach(card => {
                const type = card.dataset.type;
                const content = card.querySelector('textarea').value;
                const solution = card.querySelector('input:last-of-type') ? card.querySelector('input:last-of-type').value : card.querySelector('textarea:last-of-type').value;
                let qData = { type, content, solution };
                if(type === 'mc') {
                    const opts = Array.from(card.querySelectorAll('input[type="text"]')).map(i => i.value);
                    let correctIdx = -1;
                    card.querySelectorAll('input[type="radio"]').forEach((r, i) => { if(r.checked) correctIdx = i; });
                    qData.options = opts; qData.correct = correctIdx;
                } else if (type === 'tf') {
                    const statements = [];
                    const rows = card.querySelectorAll('.grid.items-center');
                    rows.forEach(row => {
                        const text = row.querySelector('input[type="text"]').value;
                        const isTrue = row.querySelector('input[value="true"]').checked;
                        statements.push({ text, isTrue });
                    });
                    qData.statements = statements;
                } else if (type === 'short') {
                    qData.answer = card.querySelector('input[placeholder*="VD"]').value;
                }
                questions.push(qData);
            });

            const btn = status === 'published' ? document.getElementById('btnPublish') : document.getElementById('btnSaveDraft');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
            btn.disabled = true;

            try {
                const examRef = currentExamId ? doc(db, "exams", currentExamId) : doc(collection(db, "exams"));
                await setDoc(examRef, {
                    ...settings,
                    teacherId: currentUser.uid,
                    questions: questions,
                    questionCount: questions.length,
                    status: status, 
                    updatedAt: new Date().toISOString(),
                    ...(currentExamId ? {} : { createdAt: new Date().toISOString() })
                }, { merge: true });

                currentExamId = examRef.id;
                document.getElementById('sidebarExamTitle').textContent = title;
                const statusEl = document.getElementById('examStatus');
                statusEl.textContent = status === 'published' ? '• Đã xuất bản' : '• Bản nháp';
                statusEl.className = `text-xs font-bold ${status === 'published' ? 'text-green-600' : 'text-orange-500'}`;

                if (status === 'published') {
                    const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + currentExamId;
                    document.getElementById('shareLinkInput').value = link;
                    const modal = document.getElementById('shareModal');
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                } else {
                    showToast("Đã lưu bản nháp thành công!", "success");
                }
                if (!window.location.search.includes('id=')) {
                    const newUrl = window.location.href.split('?')[0] + '?id=' + currentExamId;
                    window.history.pushState({path:newUrl},'',newUrl);
                }
            } catch(e) { console.error(e); customAlert("Lỗi lưu: " + e.message, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        window.copyLink = function() {
            const copyText = document.getElementById("shareLinkInput"); copyText.select(); document.execCommand("copy"); showToast("Đã sao chép link bài thi!", "info");
        }
        window.closeShareModal = function() {
            const modal = document.getElementById('shareModal'); modal.classList.add('opacity-0', 'pointer-events-none');
        }
    </script>

    <script>
        function switchView(viewId) {
            document.getElementById('view-settings').classList.add('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('flex');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            if (viewId === 'settings') {
                document.getElementById('view-settings').classList.remove('hidden');
                document.getElementById('menu-settings').classList.add('active');
            } else if (viewId === 'editor') {
                document.getElementById('view-editor').classList.remove('hidden');
                document.getElementById('view-editor').classList.add('flex');
                document.getElementById('menu-editor').classList.add('active');
            }
        }

        let qCount = 0;
        function addQuestion(type, data = null) {
            document.getElementById('emptyState').classList.add('hidden');
            const tpl = document.getElementById(`tpl-${type}`);
            const clone = tpl.content.cloneNode(true);
            qCount++;
            const container = clone.querySelector('div');
            container.innerHTML = container.innerHTML.replaceAll('${id}', qCount);
            if(data) {
                container.querySelector('textarea').value = data.content || '';
                const lastInput = container.querySelector('input:last-of-type') || container.querySelector('textarea:last-of-type');
                if(lastInput && data.solution) lastInput.value = data.solution;
                if (type === 'mc' && data.options) {
                    const texts = container.querySelectorAll('input[type="text"]');
                    const radios = container.querySelectorAll('input[type="radio"]');
                    data.options.forEach((opt, i) => { if(texts[i]) texts[i].value = opt; if(radios[i] && i === data.correct) radios[i].checked = true; });
                } else if (type === 'tf' && data.statements) {
                    const rows = container.querySelectorAll('.grid.items-center');
                    data.statements.forEach((stmt, idx) => {
                        if(rows[idx]) {
                            rows[idx].querySelector('input[type="text"]').value = stmt.text;
                            if(stmt.isTrue) rows[idx].querySelector('input[value="true"]').checked = true; else rows[idx].querySelector('input[value="false"]').checked = true;
                        }
                    });
                } else if (type === 'short' && data.answer) {
                    container.querySelector('input[placeholder*="VD"]').value = data.answer;
                }
            }
            document.getElementById('questionsList').appendChild(clone);
            if (window.MathJax) MathJax.typesetPromise();
        }

        // Updated delete function using Custom Confirm
        window.deleteQuestion = async function(btn) { 
            if(await customConfirm("Bạn có chắc chắn muốn xóa câu hỏi này không?", "Xác nhận xóa")) {
                const card = btn.closest('.question-card');
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                card.style.transition = 'all 0.3s';
                setTimeout(() => { card.remove(); showToast("Đã xóa câu hỏi!", "success"); }, 300);
            }
        }

        function handleTexUpload(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { parseTexAndAdd(e.target.result); input.value = ""; };
            reader.readAsText(file);
        }
        function parseTexAndAdd(texContent) {
            const blockRegex = /\\begin\{(ex|bt|vd)\}([\s\S]*?)\\end\{\1\}/g;
            let match, count = 0;
            while ((match = blockRegex.exec(texContent)) !== null) {
                let body = match[2];
                let qType = 'essay';
                let qData = { content: '', solution: '', options: [], statements: [], answer: '' };
                const loigiaiMatch = body.match(/\\loigiai\s*\{([\s\S]*)\}\s*$/);
                if (loigiaiMatch) { qData.solution = loigiaiMatch[1].trim(); body = body.substring(0, body.lastIndexOf('\\loigiai')); }
                if (body.includes('\\choiceTF')) {
                    qType = 'tf';
                    const parts = body.split('\\choiceTF'); qData.content = parts[0].trim();
                    const itemRegex = /\{\s*(\\True\s+)?((?:[^{}]|\{[^{}]*\})*)\}/g; let itemMatch;
                    while ((itemMatch = itemRegex.exec(parts[1])) !== null) qData.statements.push({ text: itemMatch[2].trim(), isTrue: !!itemMatch[1] });
                } else if (body.includes('\\choice')) {
                    qType = 'mc';
                    const parts = body.split('\\choice'); qData.content = parts[0].trim();
                    const itemRegex = /\{\s*(\\True\s+)?((?:[^{}]|\{[^{}]*\})*)\}/g; let itemMatch, idx = 0;
                    while ((itemMatch = itemRegex.exec(parts[1])) !== null && idx < 4) { qData.options.push(itemMatch[2].trim()); if(itemMatch[1]) qData.correct = idx; idx++; }
                } else if (body.includes('\\shortans')) {
                    qType = 'short';
                    const shortMatch = body.match(/\\shortans\s*\{((?:[^{}]|\{[^{}]*\})*)\}/);
                    if (shortMatch) { qData.answer = shortMatch[1].trim(); qData.content = body.replace(shortMatch[0], '').trim(); } else qData.content = body.trim();
                } else { qData.content = body.trim(); }
                addQuestion(qType, qData); count++;
            }
            if (count > 0) showToast(`Đã nhập thành công ${count} câu hỏi!`, "success");
        }
    </script>
</body>
</html>
