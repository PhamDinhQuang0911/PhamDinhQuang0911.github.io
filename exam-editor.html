<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản lý đề thi - Smart LaTeX Import</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      loader: { load: ['[tex]/noerrors', '[tex]/noundefined'] },
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors', 'noundefined']},
        macros: {
          heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
          hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ",
          R: "\\mathbb{R}",
          N: "\\mathbb{N}",
          Z: "\\mathbb{Z}",
          vectors: ["\\overrightarrow{#1}", 1],
          mtx: ["\\left[\\begin{matrix}#1\\end{matrix}\\right]", 1]
        }
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      // Đã xóa phần chtml scale để font chữ hiển thị tự nhiên, sắc nét
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8F9FA; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        .sidebar-item.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 700; border-right: 3px solid #1D4ED8; }
         { transition: all 0.2s; border: 1px solid #E5E7EB; cursor: pointer; background: white; }
        .preview-item:hover { border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .preview-item.active { border-color: #3B82F6; ring: 2px solid #DBEAFE; background-color: #F0F9FF; }
        .group-header { position: sticky; top: 0; background-color: #F9FAFB; z-index: 20; padding-top: 10px; padding-bottom: 5px; border-bottom: 1px solid #E5E7EB; }
        .palette-container { padding: 0.5rem; background: #F9FAFB; border-bottom: 1px solid #E5E7EB; overflow-y: auto; max-height: 120px; }
        .palette-grid { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        .palette-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; border-radius: 4px; border: 1px solid #D1D5DB; color: #4B5563; transition: all 0.2s; background: white; }
        .palette-btn:hover { border-color: #3B82F6; color: #3B82F6; }
        .palette-btn.active { background-color: #3B82F6; color: white; border-color: #3B82F6; }
        
        /* --- BẢN SỬA LỖI: HIỂN THỊ MATHJAX CHUẨN --- */
        /* 1. Tăng khoảng cách dòng cho văn bản chứa công thức để không bị dính */
        .preview-item, #editorArea, .question-content {
            line-height: 1.6 !important; 
            font-size: 15px;
            color: #1f2937;
        }

        /* 2. Xử lý MathJax Inline (Công thức cùng dòng) */
        mjx-container:not([display="true"]) {
            margin: 0 2px !important; 
        }

        /* 3. Xử lý MathJax Display (Công thức riêng dòng) */
        mjx-container[display="true"] {
            display: block !important;
            margin: 1em 0 !important;
            overflow-x: auto; /* Chỉ cuộn ngang khi là công thức dài */
            overflow-y: visible !important; /* QUAN TRỌNG: Không bao giờ cắt ngọn công thức */
            padding: 0.5rem 0;
            max-width: 100%;
        }

        /* 4. Ẩn phần hỗ trợ đọc màn hình để tránh rác giao diện */
        mjx-assistive-mml {
            display: none !important; 
        }
        
        .form-input { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; outline: none; transition: all 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: #3B82F6; ring: 2px solid #DBEAFE; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { backdrop-filter: blur(2px); }
        .modal { transition: opacity 0.2s ease; }
        .modal.opacity-0 { pointer-events: none; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .progress-bar-bg { background-color: #E5E7EB; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease; }
        /* Thêm vào phần <style> */
        .image-placeholder:focus {
            border-color: #2563EB !important; /* Xanh đậm */
            background-color: #EFF6FF !important; /* Nền xanh nhạt */
            outline: 2px solid #3B82F6; /* Viền focus */
            outline-offset: 2px;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <div id="sidebarOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass transition-opacity"></div>

    <aside id="mainSidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex flex-col z-40 shadow-xl transition-transform duration-300 -translate-x-full md:relative md:translate-x-0 flex-shrink-0">
        <div class="p-5 border-b border-gray-100 relative">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm shrink-0"><i class="fa-regular fa-file-lines"></i></div>
                <div class="flex-1 overflow-hidden">
                    <h3 id="sidebarExamTitle" class="font-bold text-gray-800 truncate text-sm" title="Tên đề thi">Đề thi mới</h3>
                    <p class="text-xs text-orange-500 font-bold" id="examStatus">• Bản nháp</p>
                </div>
            </div>
            <button onclick="window.toggleSidebar()" class="md:hidden absolute top-5 right-5 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Cấu hình</div>
            <ul class="space-y-1 mb-6">
                <li><button onclick="switchView('settings'); window.toggleSidebar()" id="menu-settings" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-sliders w-5"></i> Cài đặt & Cấu hình</button></li>
                <li><button onclick="switchView('editor'); window.toggleSidebar()" id="menu-editor" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-list-check w-5"></i> Nội dung câu hỏi</button></li>
                <li><button onclick="switchView('stats'); window.toggleSidebar()" id="menu-stats" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-chart-pie w-5"></i> Thống kê & Báo cáo</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-200 space-y-2">
            <button onclick="handleNewExam()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm flex items-center justify-center gap-2 rounded-lg transition-colors shadow-md shadow-blue-200">
                <i class="fa-solid fa-plus-circle"></i> Soạn đề mới
            </button>
            <button onclick="handleBackNavigation()" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-arrow-right-from-bracket"></i> Quay lại</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative w-full">
        <div class="md:hidden h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.toggleSidebar()" class="text-gray-600 hover:text-blue-600 text-xl p-1"><i class="fa-solid fa-bars"></i></button>
                <span class="font-bold text-gray-800 text-sm truncate max-w-[200px]" id="mobileHeaderTitle">Cài đặt đề thi</span>
            </div>
        </div>

        <div id="view-settings" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 sticky top-0 bg-gray-50 py-2 z-10">
                    <div class="hidden md:block">
                        <h1 class="text-2xl font-bold text-gray-800">Cài đặt đề thi</h1>
                        <p class="text-sm text-gray-500">Thiết lập thông tin và bảo mật.</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="saveExam('draft')" id="btnSaveDraft" class="flex-1 md:flex-none justify-center px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl text-sm flex items-center gap-2"><i class="fa-regular fa-floppy-disk"></i> Lưu nháp</button>
                        <button onclick="saveExam('published')" id="btnPublish" class="flex-1 md:flex-none justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 text-sm flex items-center gap-2"><i class="fa-solid fa-rocket"></i> Xuất bản</button>
                    </div>
                </div>

                <div id="publishedLinkArea" class="hidden bg-green-50 p-4 rounded-xl border border-green-200 mb-6 shadow-sm">
                    <label class="block text-xs font-bold text-green-700 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> Link bài thi (Đã xuất bản)</label>
                    <div class="flex gap-2">
                        <input type="text" id="settingShareLink" class="w-full px-3 py-2 border border-green-300 rounded-lg text-green-800 bg-white focus:outline-none text-sm font-mono" readonly>
                        <button onclick="copySettingLink()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors text-sm whitespace-nowrap">Sao chép</button>
                        <button onclick="window.open(document.getElementById('settingShareLink').value, '_blank')" class="px-3 py-2 bg-white border border-green-300 text-green-600 font-bold rounded-lg hover:bg-green-50 text-sm"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                    </div>
                </div>

                <div class="space-y-4 md:space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-info-circle text-blue-600 mr-2"></i> Cấu hình chung</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2"><label class="form-group-title">Tên đề thi <span class="text-red-500">*</span></label><input type="text" id="settingTitle" class="form-input font-bold" placeholder="VD: Kiểm tra 15 phút"></div>
                            <div><label class="form-group-title">Khối lớp</label><select id="settingGrade" class="form-input bg-white"><option value="12">Khối 12</option><option value="11">Khối 11</option><option value="10">Khối 10</option><option value="9">Khối 9</option></select></div>
                            <div><label class="form-group-title">Môn học</label><select id="settingSubject" class="form-input bg-white"><option>Toán học</option><option>Vật lý</option><option>Hóa học</option><option>Tiếng Anh</option></select></div>
                            <div><label class="form-group-title">Thời gian (phút)</label><input type="number" id="settingDuration" value="90" class="form-input"></div>
                            <div><label class="form-group-title">Mục đích</label><select id="settingPurpose" class="form-input bg-white"><option value="exam">Thi / Kiểm tra</option><option value="practice">Luyện tập</option></select></div>
                            <div class="col-span-1 md:col-span-2 pt-2 border-t border-dashed"><label class="form-group-title block mb-2">Thời gian mở đề (Tùy chọn)</label><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><span class="text-xs text-gray-500">Từ:</span><input type="datetime-local" id="settingStartTime" class="form-input"></div><div><span class="text-xs text-gray-500">Đến:</span><input type="datetime-local" id="settingEndTime" class="form-input"></div></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-shield-halved text-red-600 mr-2"></i> Bảo mật</h3>
                            <div class="space-y-3">
                                <div><label class="form-group-title">Mật khẩu</label><input type="text" id="settingPassword" placeholder="Không bắt buộc" class="form-input"></div>
                                <div><label class="form-group-title">Số lượt làm</label><input type="number" id="settingAttempts" value="1" class="form-input"></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Giám sát tự động</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settingProctoring" class="toggle-checkbox sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Đảo câu hỏi</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settingShuffle" checked class="toggle-checkbox sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-square-poll-vertical text-green-600 mr-2"></i> Kết quả & Đáp án</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="form-group-title">Học sinh xem điểm</label>
                                    <div class="grid grid-cols-3 gap-2 text-xs">
                                        <label class="cursor-pointer hover:text-blue-600"><input type="radio" name="settingShowScore" value="immediate" checked> Ngay nộp</label>
                                        <label class="cursor-pointer hover:text-blue-600"><input type="radio" name="settingShowScore" value="after_exam"> Hết giờ</label>
                                        <label class="cursor-pointer hover:text-blue-600"><input type="radio" name="settingShowScore" value="never"> Không</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-group-title">Xem lời giải chi tiết</label>
                                    <div class="space-y-2 text-sm text-gray-700">
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="settingShowResult" value="immediate" checked onchange="toggleResultOptions()"> <span>Ngay sau khi nộp</span></label>
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="settingShowResult" value="after_exam" onchange="toggleResultOptions()"> <span>Khi hết giờ làm bài</span></label>
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="settingShowResult" value="never" onchange="toggleResultOptions()"> <span>Không cho xem</span></label>
                                        
                                        <div class="flex items-center gap-2">
                                            <label class="flex items-center gap-2 cursor-pointer whitespace-nowrap">
                                                <input type="radio" name="settingShowResult" value="pass_score" onchange="toggleResultOptions()"> 
                                                <span>Đạt điểm tối thiểu:</span>
                                            </label>
                                            <input type="number" id="settingPassScoreInput" class="form-input w-20 h-8 text-sm p-1 text-center font-bold text-blue-600" placeholder="5" value="5" disabled>
                                        </div>

                                        <div class="flex items-center gap-2">
                                            <label class="flex items-center gap-2 cursor-pointer whitespace-nowrap">
                                                <input type="radio" name="settingShowResult" value="fee_qpoint" onchange="toggleResultOptions()"> 
                                                <span>Trả phí (Qpoint):</span>
                                            </label>
                                            <input type="number" id="settingFeeQpointInput" class="form-input w-20 h-8 text-sm p-1 text-center font-bold text-orange-600" placeholder="0" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-users text-purple-600 mr-2"></i> Đối tượng</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('public')"><input type="radio" name="settingAccess" value="public" checked> <div><div class="font-bold text-sm">Công khai</div><div class="text-xs text-gray-500">Ai cũng có thể làm</div></div></label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('class')"><input type="radio" name="settingAccess" value="class"> <div><div class="font-bold text-sm">Lớp học</div><div class="text-xs text-gray-500">Chỉ các lớp được chọn</div></div></label>
                            <div id="classSelectionArea" class="hidden pl-6 mt-2">
                                <div id="classCheckboxList" class="max-h-40 overflow-y-auto border border-blue-200 rounded-lg p-2 bg-gray-50 space-y-1 custom-scrollbar">
                                    <p class="text-xs text-gray-400 italic">Đang tải danh sách lớp...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-editor" class="hidden flex-1 h-full flex flex-col md:flex-row relative bg-gray-100">
            <div class="w-full md:w-1/2 lg:w-5/12 h-1/2 md:h-full flex flex-col border-r border-gray-200 bg-white z-10">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-list-ol mr-2"></i>Danh sách (<span id="totalQCount">0</span>)</h3>
                    <div class="flex gap-2">
                        <button onclick="openScoringModal()" class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-200"><i class="fa-solid fa-calculator mr-1"></i> Chia điểm</button>
                        <button onclick="document.getElementById('texInput').click()" class="px-3 py-1.5 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200"><i class="fa-solid fa-file-import mr-1"></i> LaTeX</button>
                        <input type="file" id="texInput" accept=".tex,.txt" class="hidden" onchange="handleTexUpload(this)">
                    </div>
                </div>
                
                <div id="quickPaletteContainer" class="palette-container hidden">
                    <div class="palette-grid" id="quickPalette"></div>
                </div>

                <div id="previewList" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 scroll-smooth relative">
                    <div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.<br>Hãy thêm câu hỏi hoặc Import Tex.</div>
                </div>
            </div>

            <div class="w-full md:w-1/2 lg:w-7/12 h-1/2 md:h-full flex flex-col bg-white">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-pen-to-square mr-2 text-blue-600"></i>Chỉnh sửa</h3>
                    <div class="flex gap-2">
                        <button onclick="addNewQuestion('mc')" class="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-xs font-bold">+TN</button>
                        <button onclick="addNewQuestion('tf')" class="p-1.5 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 text-xs font-bold">+ĐS</button>
                        <button onclick="addNewQuestion('short')" class="p-1.5 bg-green-50 text-green-600 rounded hover:bg-green-100 text-xs font-bold">+Điền</button>
                        <button onclick="addNewQuestion('essay')" class="p-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 text-xs font-bold">+TL</button>
                        <div class="w-[1px] h-6 bg-gray-200 mx-1"></div>
                         <button onclick="document.getElementById('imgUploadInput').click()" class="p-1.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 text-xs font-bold" title="Chèn ảnh"><i class="fa-regular fa-image"></i> Ảnh</button>
                        <input type="file" id="imgUploadInput" accept="image/*" class="hidden">
                        <div class="w-[1px] h-6 bg-gray-200 mx-1"></div>                                             
                        <button onclick="deleteCurrentQuestion()" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 text-xs" title="Xóa câu hiện tại"><i class="fa-solid fa-trash"></i></button>
                        <button onclick="deleteAllQuestions()" class="p-1.5 ml-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs shadow-sm" title="Xóa TOÀN BỘ câu hỏi"><i class="fa-solid fa-dumpster-fire"></i> Xóa hết</button>
                        <button onclick="cleanWhitespace()" class="p-1.5 ml-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-xs font-bold" title="Tự động xóa dòng trắng thừa quanh ảnh"><i class="fa-solid fa-broom"></i> Dọn dòng</button>
                    </div>
                </div>
                <div id="editorArea" class="flex-1 overflow-y-auto p-4 md:p-6 bg-white relative">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>
                </div>
            </div>
        </div>

        <div id="view-stats" class="hidden flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
           <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                    <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-chart-pie mr-2 text-blue-600"></i>Thống kê kết quả</h1>
                    <button onclick="window.exportToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Xuất Excel</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Học sinh đã nộp</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statTotalSubmissions">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Điểm trung bình</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statAvgScore">0.0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Điểm cao nhất</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statMaxScore">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Điểm thấp nhất</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statMinScore">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">Phổ điểm thi</h3>
                        <div class="h-64"><canvas id="scoreChart"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex flex-col h-[340px]">
                        <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">Phân tích câu hỏi (Tỉ lệ đúng)</h3>
                        <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3" id="questionAnalysisList">
                            <p class="text-gray-400 text-xs text-center">Chưa có dữ liệu.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex flex-col gap-4 bg-gray-50">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar items-center" id="classFilterContainer">
                                <button onclick="filterStats('all')" class="px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm whitespace-nowrap transition-colors" id="filterBtnAll">Tất cả</button>
                            </div>
                            <div class="shrink-0">
                                <select id="sortStats" class="form-input text-sm py-1.5 w-40 bg-white" onchange="renderStatsTable()">
                                    <option value="score_desc">Điểm cao -> thấp</option>
                                    <option value="score_asc">Điểm thấp -> cao</option>
                                    <option value="time_desc">Nộp mới nhất</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pt-2 border-t border-gray-200">
                            <span class="text-xs font-bold text-gray-500 uppercase mr-2">Lọc theo:</span>
                            <div class="flex bg-white rounded-lg border border-gray-300 p-1 shadow-sm">
                                <button onclick="filterStatus('all')" id="stBtn_all" class="px-3 py-1 text-xs font-bold rounded bg-gray-100 text-gray-800">Tất cả</button>
                                <button onclick="filterStatus('done')" id="stBtn_done" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:bg-gray-50">Đã nộp</button>
                                <button onclick="filterStatus('missing')" id="stBtn_missing" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:bg-gray-50">Chưa nộp</button>
                                <button onclick="filterStatus('not_graded')" id="stBtn_not_graded" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:bg-gray-50 text-red-500">Chưa chấm</button>
                                <button onclick="filterStatus('graded')" id="stBtn_graded" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:bg-gray-50">Đã chấm</button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-6 py-3">Học sinh</th>
                                    <th class="px-6 py-3 text-center">Điểm (Cao nhất)</th>
                                    <th class="px-6 py-3 text-center text-red-600">Vi phạm</th> <th class="px-6 py-3 text-center">Số lượt</th>
                                    <th class="px-6 py-3 text-right">Ngày nộp</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="historyModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[110] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50 rounded-t-xl">
                <h3 class="font-bold text-blue-800" id="histModalTitle">Lịch sử làm bài</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto" id="histModalContent"></div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Thông báo</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">Nội dung...</p>
                <input type="text" id="modalInput" class="hidden mt-4 w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none" placeholder="Nhập thông tin...">
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">Hủy bỏ</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-70 px-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-green-600 animate-bounce"><i class="fa-solid fa-check"></i></div>
                <h3 class="text-2xl font-bold text-gray-800">Xuất bản thành công!</h3><p class="text-gray-500 text-sm">Đề thi đã sẵn sàng.</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Link bài thi</label>
                <div class="flex gap-2">
                    <input type="text" id="shareLinkInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-600 bg-white focus:outline-none text-sm font-mono" readonly>
                    <button onclick="copyLink()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors text-sm">Copy</button>
                </div>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="closeShareModal()" class="flex-1 px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-colors">Đóng</button>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="font-bold text-yellow-800"><i class="fa-solid fa-calculator mr-2"></i>Cấu hình điểm số</h3>
                <button onclick="closeScoringModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Trắc nghiệm + Điền từ</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countMcShort">0</b></span></div>
                        <input type="number" id="scoreTotalMcShort" class="form-input text-right font-bold text-blue-600" placeholder="Tổng điểm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Đúng / Sai</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countTF">0</b></span></div>
                        <input type="number" id="scoreTotalTF" class="form-input text-right font-bold text-orange-600" placeholder="Tổng điểm">
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Chi tiết Tự luận (<span id="countEssay">0</span> câu)</h4>
                    <div id="essayScoreList" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-xs text-gray-400 italic">Không có câu tự luận nào.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50 rounded-b-xl">
                <button onclick="closeScoringModal()" class="px-4 py-2 bg-white border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-100">Hủy</button>
                <button onclick="applyScoring()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Áp dụng</button>
            </div>
        </div>
    </div>
    
    <div id="batchImageModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[120] flex items-center justify-center bg-gray-900 bg-opacity-70 px-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl transform scale-95 transition-transform duration-300 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold"><i class="fa-solid fa-images"></i></div>
                    <h3 class="font-bold text-gray-800">Tải lên file ảnh</h3>
                </div>
                <button onclick="closeBatchImageModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto bg-gray-50/50 flex-1">
                 <p class="text-sm text-gray-500 mb-4 px-1">Hệ thống phát hiện các ảnh sau trong mã LaTeX. Vui lòng tải ảnh tương ứng lên để thay thế.</p>
                 <div id="batchImageList" class="space-y-3">
                     </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeBatchImageModal()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 text-sm">Xong</button>
            </div>
        </div>
    </div>
    
    <div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col gap-3 pointer-events-none"></div>
    
    <input type="file" id="batchFileInput" accept="image/*" class="hidden">
    <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden">

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        
        // --- IMPORT TỪ UTILS.JS ---
        import { compileTikZToImage, formatContent, convertArrayToMatrix, autoScaleTables, cleanTikzCode, extractNextBrace } from "./utils.js";

        // Gán vào window
        window.formatContent = formatContent;
        window.autoScaleTables = autoScaleTables;
        window.convertArrayToMatrix = convertArrayToMatrix; 

    // --- HÀM MỚI: BẬT/TẮT Ô NHẬP LIỆU KẾT QUẢ ---
        window.toggleResultOptions = () => {
            const val = document.querySelector('input[name="settingShowResult"]:checked').value;
            const passInput = document.getElementById('settingPassScoreInput');
            const feeInput = document.getElementById('settingFeeQpointInput');
            
            // Reset trạng thái
            passInput.disabled = true; passInput.classList.add('bg-gray-100');
            feeInput.disabled = true; feeInput.classList.add('bg-gray-100');

            if (val === 'pass_score') {
                passInput.disabled = false; passInput.classList.remove('bg-gray-100'); 
            } else if (val === 'fee_qpoint') {
                feeInput.disabled = false; feeInput.classList.remove('bg-gray-100'); 
            }
        };

        // CẤU HÌNH FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const storage = getStorage(app);
        
        let currentUser = null, currentExamId = null;
        window.questions = [];
        window.originalQuestionsData = []; 
        window.currentQIndex = -1;
        let sessionUploadedFiles = [];
        let statsMap = {}; 
        let classStudentList = [];
        let modalResolve = null;
        // --- THÊM MỚI ---
        let currentClassFilter = 'all';
        let currentStatusFilter = 'all';
        let fullStudentList = [];

        const modalEl = document.getElementById('customModal');
        const modalBox = document.getElementById('customModalBox');
        const modalTitle = document.getElementById('modalTitle');
        const modalMsg = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnCancel = document.getElementById('btnCancel');

        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if (modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (message, type = 'info') => { return new Promise((resolve) => { modalTitle.innerText = type === 'error' ? 'Lỗi' : 'Thông báo'; modalMsg.innerText = message; modalIcon.innerHTML = type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-bell text-blue-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.add('hidden'); btnConfirm.innerText = "Đã hiểu"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; modalResolve = resolve; }); };
        window.customConfirm = (message) => { return new Promise((resolve) => { modalTitle.innerText = "Xác nhận"; modalMsg.innerText = message; modalIcon.innerHTML = '<i class="fa-solid fa-circle-question text-orange-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.remove('hidden'); btnConfirm.innerText = "Đồng ý"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-95'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; btnCancel.onclick = () => { resolve(false); modalResolve = null; closeCustomModal(); }; }); };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadTeacherClasses();
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('id');
                if (examId) { currentExamId = examId; loadExamData(examId); }
            } else { window.location.href = 'index.html'; }
        });

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 800; 
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function handleImageUpload(file) {
            if (!file) return;
            window.showToast("Đang tải ảnh lên Cloudflare...", "info");
            try {
                const compressedBlob = await compressImage(file);
                const formData = new FormData();
                const fileName = `images/${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
                formData.append('file', compressedBlob, fileName);

                const response = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", {
                    method: 'PUT',
                    body: formData
                });

                if (!response.ok) throw new Error("Lỗi kết nối Cloudflare");
                
                const data = await response.json();
                sessionUploadedFiles.push(data.key); 

                insertAtCursor(`\n<div class="flex justify-center"><img src="${data.url}" class="max-w-full h-auto rounded-lg shadow-sm" style="max-height:300px;"></div>\n`);
                autoSaveMemory(); 
                window.showToast("Đã chèn ảnh thành công!", "success");
            } catch (error) { 
                console.error(error); 
                window.showToast("Lỗi tải ảnh: " + error.message, "error"); 
            }
        }

        function insertAtCursor(text) {
            const textarea = document.getElementById('editContent');
            if (!textarea) return;
            const start = textarea.selectionStart; const end = textarea.selectionEnd; const value = textarea.value;
            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length; textarea.focus();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('imgUploadInput').addEventListener('change', (e) => { if(e.target.files.length > 0) handleImageUpload(e.target.files[0]); });
            document.body.addEventListener('paste', (e) => {
                if (e.target.id === 'editContent') {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let index in items) {
                        const item = items[index];
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            e.preventDefault(); const blob = item.getAsFile(); handleImageUpload(blob); return;
                        }
                    }
                }
            });
        });

        let pendingImageUploads = []; 
        let currentBatchUploadId = null;

        function getPlaceholderHTML(id, note = "Vị trí ảnh") {
            return `
            <div class="image-placeholder my-3 p-4 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-center flex flex-col items-center justify-center select-none cursor-pointer hover:bg-gray-100 transition-all group relative outline-none" 
                data-id="${id}" 
                tabindex="0"
                onclick="event.stopPropagation(); this.focus();" 
                ondblclick="triggerBatchUpload('${id}')"
                title="Click để chọn (rồi bấm Ctrl+V), Click đúp để tải file">
                
                <div class="text-gray-400 group-focus:text-blue-600 text-3xl mb-2 transition-colors">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <div class="text-xs font-bold text-gray-500 group-focus:text-blue-700 uppercase mb-1">${note}</div>
                <div class="text-[10px] text-gray-400 group-focus:text-blue-500">
                    Click đúp để tải file<br>hoặc <b>Ctrl + V</b> để dán ảnh
                </div>
            </div>`;
        }

        function processLatexImagesWithDetection(text, questionIndex) {
            if (!text) return "";
            let processed = String(text);
            
            // 1. Xử lý immini và includegraphics
            while (true) {
                const idx = processed.indexOf('\\immini');
                if (idx === -1) break;
                const before = processed.substring(0, idx); 
                let remainder = processed.substring(idx + 7).trim();
                if (remainder.startsWith('[')) { const cb = remainder.indexOf(']'); if (cb > -1) remainder = remainder.substring(cb + 1).trim(); }
                const arg1 = extractNextBrace(remainder); if (!arg1) break; 
                const arg2 = extractNextBrace(arg1.remaining); if (!arg2) break; 
                
                let imgPath = "", placeholderType = "", needsUpload = false;
                if (arg2.content.includes('includegraphics')) { 
                    const igIdx = arg2.content.indexOf('\\includegraphics'); 
                    const afterIg = arg2.content.substring(igIdx); 
                    const pathBlock = extractNextBrace(afterIg.substring(afterIg.indexOf('{'))); 
                    if (pathBlock) { imgPath = pathBlock.content; needsUpload = true; placeholderType = "Ảnh từ immini"; } 
                } 
                else if (arg2.content.includes('tikzpicture')) { 
                    needsUpload = true; placeholderType = "Vị trí hình TikZ"; imgPath = "tikz_diagram_placeholder"; 
                }
                
                let ph = "";
                if (needsUpload) {
                    const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                    const imgType = (placeholderType.includes("TikZ")) ? 'tikz' : 'normal';
                    // Dùng cleanTikzCode từ utils
                    const tikzContent = (imgType === 'tikz') ? cleanTikzCode(arg2.content) : null;
                    
                    pendingImageUploads.push({ id: uid, originalPath: imgPath, questionIdx: questionIndex, type: imgType, contentCode: tikzContent });
                    ph = getPlaceholderHTML(uid, placeholderType);
                } else { 
                    ph = `<div class="text-xs text-gray-400 italic border border-dashed p-2 text-center">[Khối hình không xác định]</div>`; 
                }
                
                const contentText = arg1.content; 
                const match = contentText.match(/\\(choice|choiceTF|shortans)/); 
                let newContent = "";
                if (match && match.index !== undefined) newContent = contentText.substring(0, match.index) + '\n\n' + ph + '\n\n' + contentText.substring(match.index); 
                else newContent = contentText + '\n\n' + ph;
                processed = before + newContent + arg2.remaining;
            }

            // 2. Xử lý TikZ độc lập
            const tikzRegex = /\\begin\{tikzpicture\}[\s\S]*?\\end\{tikzpicture\}/g;
            processed = processed.replace(tikzRegex, (match) => {
                 const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`; 
                 pendingImageUploads.push({ 
                     id:uid, 
                     originalPath:"standalone_tikz", 
                     questionIdx:questionIndex, 
                     type: 'tikz', 
                     contentCode: cleanTikzCode(match) 
                 }); 
                 return getPlaceholderHTML(uid, "Hình TikZ");
            });

            // 3. Xử lý ảnh canh giữa
            processed = processed.replace(/\\begin\{center\}\s*([\s\S]*?)\\includegraphics\s*(?:\[.*?\])?\s*\{(.*?)\}([\s\S]*?)\\end\{center\}/g, (m, pre, p, post) => { 
                const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`; 
                pendingImageUploads.push({id:uid, originalPath:p, questionIdx:questionIndex, type: 'normal'}); 
                return getPlaceholderHTML(uid, "Ảnh canh giữa"); 
            });
            
            // 4. Xử lý ảnh thường còn lại
            processed = processed.replace(/\\includegraphics\s*(?:\[.*?\])?\s*\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g, (m, p) => { 
                const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`; 
                pendingImageUploads.push({id:uid, originalPath:p, questionIdx:questionIndex, type: 'normal'}); 
                return getPlaceholderHTML(uid, "Ảnh"); 
            });

            return processed;
        }

        window.renderBatchImageModal = () => {
            const list = document.getElementById('batchImageList');
            const modal = document.getElementById('batchImageModal');
            list.innerHTML = '';
            
            const normalImages = pendingImageUploads.filter(item => item.type === 'normal');
            
            if (normalImages.length === 0) {
                closeBatchImageModal();
                return;
            }

            const folderDiv = document.createElement('div');
            folderDiv.className = "mb-4 p-4 bg-blue-50 border border-blue-200 rounded-xl flex items-center justify-between shadow-sm";
            folderDiv.innerHTML = `
                <div>
                    <h4 class="font-bold text-blue-800 text-sm"><i class="fa-solid fa-magic-wand-sparkles mr-1"></i> Tự động quét ảnh</h4>
                    <p class="text-xs text-blue-600 mt-1">Chọn folder chứa ảnh để hệ thống tự ghép tên file.</p>
                </div>
                <button onclick="document.getElementById('folderInput').click()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-xs shadow-md hover:bg-blue-700 transition-colors whitespace-nowrap">
                    <i class="fa-solid fa-folder-open mr-1"></i> Chọn thư mục
                </button>
            `;
            list.appendChild(folderDiv);

            normalImages.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-xl hover:shadow-sm transition-shadow";
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs shrink-0">${index + 1}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="text-xs font-bold text-blue-600 mb-0.5">Câu hỏi số ${item.questionIdx + 1}</div>
                        <div class="text-xs text-gray-500 truncate" title="${item.originalPath}"><i class="fa-regular fa-folder-open mr-1"></i>.../${item.originalPath.split('/').pop()}</div>
                    </div>
                    <button onclick="triggerBatchUpload('${item.id}')" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 font-bold text-xs rounded-lg hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-upload mr-1"></i> Chọn lẻ
                    </button>
                `;
                list.appendChild(div);
            });

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-100');
        };

        window.triggerBatchUpload = (id) => {
            currentBatchUploadId = id;
            document.getElementById('batchFileInput').click();
        };

        window.closeBatchImageModal = () => {
            document.getElementById('batchImageModal').classList.add('opacity-0', 'pointer-events-none');
        };

        // --- HÀM FIX: XÓA SẠCH CHỮ THỪA & DÒNG TRẮNG ---
        // --- HÀM CẬP NHẬT: LƯU VÀO FOLDER "images/" & GIỮ NGUYÊN TÍNH NĂNG SẠCH ---
        async function uploadAndReplaceImage(file, batchId) {
            // 1. Nén ảnh
            const compressedBlob = await compressImage(file);
            const formData = new FormData();
            
            // [THAY ĐỔI] Thêm tiền tố "images/" để gom ảnh vào thư mục riêng
            const fileName = `images/img_${Date.now()}_${Math.random().toString(36).substr(2,6)}.jpg`;
            
            formData.append('file', compressedBlob, fileName);

            // 2. Upload
            // 2. Upload (Dùng PUT ngay để tránh lỗi 405)
            const response = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", {
                method: 'PUT', 
                body: formData
            });

            if (!response.ok) throw new Error(`Lỗi kết nối Server (${response.status})`);
            const data = await response.json();
            const url = data.url;

            // 3. Mã HTML ảnh đơn giản
            const simpleImgTag = `<div class="flex justify-center my-1"><img src="${url}" class="rounded-lg shadow-sm" style="max-height:350px;" loading="lazy"></div>`;

            // 4. Thay thế & Xóa chữ thừa (Dùng DOM + Marker như cũ)
            let replacedCount = 0;
            window.questions.forEach(q => {
                ['content', 'solution'].forEach(field => {
                    if (q[field] && q[field].includes(batchId)) {
                        // Tạo DOM ảo
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = q[field];

                        // Tìm thẻ khung
                        const placeholder = tempDiv.querySelector(`div[data-id="${batchId}"]`);
                        
                        if (placeholder) {
                            // Xóa khung, thay bằng Marker
                            placeholder.outerHTML = "___IMAGE_MARKER___"; 
                            
                            // Regex xóa sạch dòng trắng/br bao quanh marker
                            let newHTML = tempDiv.innerHTML;
                            newHTML = newHTML.replace(/(\s*<br\s*\/?>\s*|\s+)*___IMAGE_MARKER___(\s*<br\s*\/?>\s*|\s+)*/gi, '\n' + simpleImgTag + '\n');
                            
                            q[field] = newHTML;
                            replacedCount++;
                        }
                    }
                });
            });

            // 5. Cập nhật Editor ngay lập tức
            const editorContent = document.getElementById('editContent');
            const editorSolution = document.getElementById('editSolution');
            
            const updateTextArea = (el) => {
                if (el && el.value.includes(batchId)) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = el.value;
                    const ph = tempDiv.querySelector(`div[data-id="${batchId}"]`);
                    if(ph) {
                        ph.outerHTML = "___IMAGE_MARKER___";
                        let txt = tempDiv.innerHTML;
                        txt = txt.replace(/(\s*<br\s*\/?>\s*|\s+)*___IMAGE_MARKER___(\s*<br\s*\/?>\s*|\s+)*/gi, '\n' + simpleImgTag + '\n');
                        el.value = txt;
                    }
                }
            };

            updateTextArea(editorContent);
            updateTextArea(editorSolution);
            window.autoSaveMemory();

            // 6. Dọn dẹp
            pendingImageUploads = pendingImageUploads.filter(item => item.id !== batchId);
            renderBatchImageModal();
            if(window.renderMissingImagesPanel) window.renderMissingImagesPanel();
            renderPreviewList(); 
            
            return true;
        }

        document.getElementById('batchFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; 
            if (!file || !currentBatchUploadId) return;

            try {
                window.showToast("Đang tải ảnh lên...", "info"); 
                await uploadAndReplaceImage(file, currentBatchUploadId);
                window.showToast("Cập nhật ảnh thành công!", "success");
            } catch (err) { 
                console.error(err); 
                window.showToast("Lỗi: " + err.message, "error"); 
            } finally { 
                e.target.value = '';
            }
        });

        // --- CẬP NHẬT: UPLOAD FOLDER TUẦN TỰ + RETRY (KHẮC PHỤC LỖI 405) ---
        // --- [MỚI HOÀN TOÀN] XỬ LÝ UPLOAD THƯ MỤC THÔNG MINH ---
        document.getElementById('folderInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // 1. Lọc chỉ lấy file ảnh
            const validImages = files.filter(f => f.type.startsWith('image/'));
            if (validImages.length === 0) {
                window.showToast("Không tìm thấy file ảnh nào trong thư mục!", "warning");
                return;
            }

            window.showToast(`Đang phân tích ${validImages.length} ảnh...`, "info");
            
            // Khóa giao diện để tránh lỗi
            const btnClose = document.querySelector('#batchImageModal button[onclick="closeBatchImageModal()"]');
            if(btnClose) btnClose.disabled = true;

            let successCount = 0;
            const processQueue = [...pendingImageUploads]; // Copy danh sách chờ

            // --- HÀM CON: UPLOAD ĐƠN LẺ (ĐỘC LẬP) ---
            const uploadSingleImage = async (file) => {
                const formData = new FormData();
                // Đổi tên file ngẫu nhiên để tránh trùng trên server
                const newName = `images/auto_${Date.now()}_${Math.random().toString(36).substr(2,5)}.jpg`;
                
                // Nén ảnh (nếu hàm compressImage có sẵn, nếu không dùng file gốc)
                let blobToSend = file;
                if (window.compressImage) {
                    try { blobToSend = await window.compressImage(file); } catch (e) {}
                }
                formData.append('file', blobToSend, newName);

                // GỬI PUT (Bắt buộc dùng PUT cho Worker của bạn)
                const res = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", {
                    method: 'PUT',
                    body: formData
                });
                
                if (!res.ok) throw new Error(`Server Error ${res.status}`);
                return await res.json();
            };

            // 2. VÒNG LẶP XỬ LÝ (TUẦN TỰ)
            for (const item of processQueue) {
                // Tách tên file gốc từ đường dẫn (VD: "C:/Img/Hinh1.png" -> "hinh1")
                const rawName = item.originalPath.split(/[/\\]/).pop(); 
                const targetName = rawName.split('.')[0].toLowerCase().trim();

                // Tìm file trong thư mục có tên chứa từ khóa này
                const matchFile = validImages.find(f => f.name.toLowerCase().includes(targetName));

                if (matchFile) {
                    // CƠ CHẾ THỬ LẠI (RETRY 3 LẦN)
                    let attempts = 0;
                    let isUploaded = false;

                    while (attempts < 3 && !isUploaded) {
                        attempts++;
                        try {
                            const msg = attempts > 1 ? ` (Thử lại ${attempts})...` : '...';
                            window.showToast(`Đang tải: ${matchFile.name}${msg}`, "info");

                            // Gọi hàm upload độc lập
                            const data = await uploadSingleImage(matchFile);
                            
                            // --> THÀNH CÔNG: THAY THẾ VÀO BÀI
                            const imgTag = `<div class="flex justify-center my-1"><img src="${data.url}" class="rounded-lg shadow-sm" style="max-height:350px;" loading="lazy"></div>`;
                            
                            // Cập nhật nội dung câu hỏi
                            window.questions.forEach(q => {
                                ['content', 'solution'].forEach(key => {
                                    if (q[key] && q[key].includes(item.id)) {
                                        const tempDiv = document.createElement('div');
                                        tempDiv.innerHTML = q[key];
                                        const ph = tempDiv.querySelector(`div[data-id="${item.id}"]`);
                                        if (ph) {
                                            // Thay thế và xóa khoảng trắng thừa
                                            const MARKER = "###_IMG_###";
                                            ph.outerHTML = MARKER;
                                            let html = tempDiv.innerHTML;
                                            // Xóa <br> trước và sau
                                            html = html.replace(/(?:<br\s*\/?>|\s)+###_IMG_###(?:<br\s*\/?>|\s)+/gi, '\n' + imgTag + '\n');
                                            html = html.replace("###_IMG_###", imgTag);
                                            q[key] = html;
                                        }
                                    }
                                });
                            });

                            // Cập nhật Editor nếu đang mở câu đó
                            const editContent = document.getElementById('editContent');
                            if (editContent && editContent.value.includes(item.id)) {
                                window.loadQuestionToEditor(window.currentQIndex);
                            }

                            // Đánh dấu đã xong
                            pendingImageUploads = pendingImageUploads.filter(i => i.id !== item.id);
                            item._done = true;
                            successCount++;
                            isUploaded = true;

                            // Nghỉ 1 giây để server không chặn (Tránh lỗi 405)
                            await new Promise(r => setTimeout(r, 1000));

                        } catch (err) {
                            console.warn(`Lỗi file ${matchFile.name}:`, err);
                            if (attempts < 3) await new Promise(r => setTimeout(r, 2000)); // Nghỉ 2s nếu lỗi
                        }
                    }
                }
            }

            // 3. KẾT THÚC
            if(btnClose) btnClose.disabled = false;
            
            // Vẽ lại danh sách còn thiếu
            if (window.renderBatchImageModal) window.renderBatchImageModal();
            if (window.renderMissingImagesPanel) window.renderMissingImagesPanel();
            window.renderPreviewList();

            if (successCount > 0) window.showToast(`Tuyệt vời! Đã cập nhật xong ${successCount} ảnh.`, "success");
            else window.showToast("Không tìm thấy ảnh nào khớp tên.", "warning");

            e.target.value = ''; // Reset input
        });

        // --- 1. HÀM TẢI DỮ LIỆU ĐỀ THI (ĐÃ FIX LỖI NULL) ---
        window.loadExamData = async (id) => { 
             try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('settingTitle').value = data.title || '';
                    document.getElementById('settingGrade').value = data.grade || '12';
                    document.getElementById('settingSubject').value = data.subject || 'Toán học';
                    document.getElementById('settingDuration').value = data.duration || 45;
                    document.getElementById('settingPurpose').value = data.purpose || 'exam';
                    document.getElementById('settingStartTime').value = data.startTime || '';
                    document.getElementById('settingEndTime').value = data.endTime || '';
                    document.getElementById('settingPassword').value = data.password || '';
                    document.getElementById('settingAttempts').value = (data.attempts !== undefined) ? data.attempts : 1;
                    document.getElementById('settingProctoring').checked = (data.proctoring === true);
                    document.getElementById('settingShuffle').checked = (data.shuffle !== false);
                    
                    if(data.showScore) { const r = document.querySelector(`input[name="settingShowScore"][value="${data.showScore}"]`); if(r) r.checked = true; }
                    if(data.showResult) { const r = document.querySelector(`input[name="settingShowResult"][value="${data.showResult}"]`); if(r) r.checked = true; }
                    document.getElementById('settingPassScoreInput').value = data.passScore || 5;
                    document.getElementById('settingFeeQpointInput').value = data.feeQpoint || 0;
                    if(window.toggleResultOptions) window.toggleResultOptions();

                    // [FIX] Xử lý Access Type an toàn, bỏ qua nút filter cũ
                    if(data.accessType) {
                        const r = document.querySelector(`input[name="settingAccess"][value="${data.accessType}"]`);
                        if(r) r.checked = true;
                        window.togglePrivasySettings(data.accessType);
                    }
                    
                    setTimeout(async () => { 
                        let selectedIds = [];
                        if (data.allowedClassIds && Array.isArray(data.allowedClassIds)) selectedIds = data.allowedClassIds;
                        else if (data.allowedClassId) selectedIds = [data.allowedClassId]; 
                        selectedIds.forEach(id => { const cb = document.querySelector(`.class-checkbox[value="${id}"]`); if(cb) cb.checked = true; });
                    }, 800); 

                    window.questions = data.questions || [];
                    window.originalQuestionsData = JSON.parse(JSON.stringify(window.questions));
                    if(window.sortQuestionsByType) window.sortQuestionsByType();
                    if(window.renderPreviewList) window.renderPreviewList();
                    if(window.questions.length > 0) window.loadQuestionToEditor(0);
                    
                    if(data.status === 'published') {
                        const st = document.getElementById('examStatus');
                        if(st) { st.textContent = '• Đã xuất bản'; st.classList.replace('text-orange-500', 'text-green-600'); }
                        document.getElementById('publishedLinkArea').classList.remove('hidden');
                        document.getElementById('settingShareLink').value = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + id;
                    }
                }
            } catch(e) { console.error(e); }
        };

        function sortQuestionsByType() {
            const order = { 'mc': 1, 'tf': 2, 'short': 3, 'essay': 4 };
            window.questions.sort((a, b) => (order[a.type] || 99) - (order[b.type] || 99));
        }

        window.renderTikz = () => {
            const scripts = document.querySelectorAll('script[type="text/tikz"]');
            if (scripts.length === 0) return;
            const oldScript = document.querySelector('script[src*="tikzjax.js"]');
            if (oldScript) oldScript.remove();
            const newScript = document.createElement('script');
            newScript.src = "https://tikzjax.com/v1/tikzjax.js?v=" + Date.now();
            document.head.appendChild(newScript);
        };

        window.renderPreviewList = () => { 
            const list = document.getElementById('previewList');
            const palette = document.getElementById('quickPalette');
            document.getElementById('totalQCount').textContent = window.questions.length;
            list.innerHTML = ''; palette.innerHTML = '';
            
            if (window.questions.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.<br>Hãy thêm câu hỏi hoặc Import Tex.</div>';
                document.getElementById('editorArea').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>';
                document.getElementById('quickPaletteContainer').classList.add('hidden');
                window.currentQIndex = -1;
                return;
            }

            document.getElementById('quickPaletteContainer').classList.remove('hidden');
            let currentType = '';
            
            window.questions.forEach((q, idx) => {
                const pBtn = document.createElement('button');
                pBtn.className = `palette-btn ${idx === window.currentQIndex ? 'active' : ''}`;
                pBtn.textContent = idx + 1;
                pBtn.onclick = () => loadQuestionToEditor(idx);
                palette.appendChild(pBtn);

                let typeLabel = q.type === 'mc' ? 'TRẮC NGHIỆM' : (q.type === 'tf' ? 'ĐÚNG/SAI' : (q.type === 'short' ? 'TRẢ LỜI NGẮN' : 'TỰ LUẬN'));
                if (q.type !== currentType) {
                    currentType = q.type;
                    const header = document.createElement('div');
                    header.className = "group-header text-xs font-bold text-gray-500 uppercase mb-2 pl-1";
                    header.textContent = `PHẦN: ${typeLabel}`;
                    list.appendChild(header);
                }

                const div = document.createElement('div');
                div.className = `preview-item p-4 rounded-lg mb-3 text-sm relative ${idx === window.currentQIndex ? 'active' : ''}`;
                div.id = `q-preview-${idx}`;
                div.onclick = () => loadQuestionToEditor(idx);
                
                let html = `
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-blue-600">Câu ${idx+1}</span>
                        <span class="bg-orange-100 text-orange-600 text-xs px-2 py-0.5 rounded font-bold">${q.point || 0}đ</span>
                    </div>
                    <div class="mb-3 text-gray-800">${formatContent(q.content)}</div>
                `;

                if (q.type === 'mc' && q.options) {
                    html += `<div class="grid grid-cols-2 gap-2 text-xs text-gray-600">`;
                    q.options.forEach((o, i) => {
                        const isCorrect = i === q.correct;
                        html += `<div class="${isCorrect ? 'text-green-600 font-bold' : ''}">${String.fromCharCode(65+i)}. ${formatContent(o)}</div>`;
                    });
                    html += `</div>`;
                } else if (q.type === 'tf' && q.statements) {
                    html += `<div class="mt-2 space-y-1">`;
                    q.statements.forEach((s, i) => {
                        html += `<div class="flex justify-between text-xs border-b border-dashed border-gray-100 pb-1">
                            <span class="flex-1 mr-2 text-gray-700">- ${formatContent(s.text)}</span>
                            <span class="font-bold ${s.isTrue ? 'text-green-600' : 'text-red-500'} whitespace-nowrap">${s.isTrue ? 'Đúng' : 'Sai'}</span>
                        </div>`;
                    });
                    html += `</div>`;
                } else if (q.type === 'short') {
                    html += `<div class="text-xs text-green-600 mt-2"><b>Đ/A:</b> ${q.answer}</div>`;
                }

                if (q.solution) {
                    html += `<div class="mt-3 pt-2 border-t border-dashed border-gray-200 text-xs text-gray-500">
                        <b class="text-green-600"><i class="fa-solid fa-lightbulb"></i> Lời giải:</b> ${formatContent(q.solution)}
                    </div>`;
                }
                div.innerHTML = html;
                list.appendChild(div);
            });
            if(window.MathJax) MathJax.typesetPromise([list]).catch(e=>{});
            setTimeout(() => {
                window.renderTikz();
                window.autoScaleTables(); 
            }, 500);
        };

        window.saveCurrentQuestionToMemory = () => { 
            if (window.currentQIndex === -1 || !window.questions[window.currentQIndex]) return;
            const q = window.questions[window.currentQIndex];
            const contentEl = document.getElementById('editContent'); if (!contentEl) return; 
            q.content = contentEl.value;
            const solEl = document.getElementById('editSolution'); if(solEl) q.solution = solEl.value;
            const pointEl = document.getElementById('editPoint'); if(pointEl) q.point = parseFloat(pointEl.value) || 0;
            if (q.type === 'mc') { const optInputs = document.querySelectorAll('.mc-option'); q.options = Array.from(optInputs).map(i => i.value); } 
            else if (q.type === 'tf') { const rows = document.querySelectorAll('#editorArea .flex.items-center.border'); q.statements = []; rows.forEach(row => { const text = row.querySelector('.tf-text').value; const isTrue = row.querySelector('.tf-check').checked; q.statements.push({text, isTrue}); }); } 
            else if (q.type === 'short') { const ansEl = document.getElementById('editShortAns'); if(ansEl) q.answer = ansEl.value; }
        };

        window.loadQuestionToEditor = (index) => { 
            if (window.currentQIndex !== -1 && window.currentQIndex !== index) saveCurrentQuestionToMemory();
            window.currentQIndex = index;
            renderPreviewList(); 
            setTimeout(() => { const activeItem = document.getElementById(`q-preview-${index}`); if(activeItem) activeItem.scrollIntoView({behavior: 'smooth', block: 'nearest'}); }, 100);
            const q = window.questions[index];
            const editor = document.getElementById('editorArea');
            let html = `<div class="mb-4"><label class="form-group-title">Nội dung</label><textarea id="editContent" class="form-input min-h-[120px]" oninput="autoSaveMemory()">${q.content || ''}</textarea></div>`;
            if (q.type === 'mc') {
                html += `<div class="grid grid-cols-1 gap-3 mb-4">`;
                const opts = q.options || ["", "", "", ""];
                opts.forEach((opt, i) => { html += `<div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full border flex items-center justify-center font-bold cursor-pointer ${q.correct === i ? 'bg-blue-600 text-white' : 'bg-gray-50'}" onclick="setCorrectMC(${i})">${String.fromCharCode(65+i)}</div><input type="text" class="form-input mc-option" value="${opt}" placeholder="Phương án ${String.fromCharCode(65+i)}" oninput="autoSaveMemory()"></div>`; });
                html += `</div>`;
            } else if (q.type === 'tf') {
                html += `<div class="space-y-2 mb-4">`;
                const stmts = q.statements || [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}];
                stmts.forEach((s, i) => { html += `<div class="flex items-center gap-2 border p-2 rounded"><span class="font-bold text-xs text-gray-400 w-4">${i+1}</span><input type="text" class="form-input tf-text" value="${s.text}" oninput="autoSaveMemory()"><label class="flex items-center gap-1"><input type="checkbox" class="w-4 h-4 tf-check" ${s.isTrue?'checked':''} onchange="autoSaveMemory()"><span class="text-xs font-bold text-green-600">Đúng</span></label></div>`; });
                html += `</div>`;
            } else if (q.type === 'short') {
                html += `<div class="mb-4"><label class="form-group-title">Đáp án mẫu</label><input type="text" id="editShortAns" class="form-input font-bold text-green-700" value="${q.answer || ''}" oninput="autoSaveMemory()"></div>`;
            }
            html += `<div class="mb-4"><label class="form-group-title">Lời giải</label><textarea id="editSolution" class="form-input min-h-[80px]" oninput="autoSaveMemory()">${q.solution || ''}</textarea></div>`;
            html += `<div class="mb-4 w-1/3"><label class="form-group-title">Điểm</label><input type="number" id="editPoint" class="form-input font-bold text-orange-600" value="${q.point || 0}" step="0.1" oninput="autoSaveMemory()"></div>`;
            editor.innerHTML = html;
            setTimeout(() => window.renderTikz(), 200);
        };

        window.addNewQuestion = (type) => { if (window.currentQIndex !== -1) saveCurrentQuestionToMemory(); const newQ = { type: type, content: "", solution: "", point: 0 }; if (type === 'mc') { newQ.options = ["", "", "", ""]; newQ.correct = -1; } if (type === 'tf') { newQ.statements = [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}]; } if (type === 'short') { newQ.answer = ""; } window.questions.push(newQ); sortQuestionsByType(); renderPreviewList(); loadQuestionToEditor(window.questions.length - 1); };
        window.autoSaveMemory = () => { saveCurrentQuestionToMemory(); };
        window.setCorrectMC = (idx) => { window.questions[window.currentQIndex].correct = idx; loadQuestionToEditor(window.currentQIndex); };
        window.deleteCurrentQuestion = async () => { if (window.currentQIndex === -1) return; if(await window.customConfirm("Xóa câu hỏi này?")) { window.questions.splice(window.currentQIndex, 1); window.currentQIndex = -1; renderPreviewList(); document.getElementById('editorArea').innerHTML = ''; } };

        function cleanLatex(text) { if (!text) return ""; let cleaned = text.replace(/^%.*$/gm, '').replace(/(?<!\\)%.*/g, '').replace(/^\s*\[.*?\]/gm, ''); return cleaned.trim(); }
        
        // --- HÀM MỚI: BẢNG TRẠNG THÁI THÔNG MINH (XANH/ĐỎ) ---
        window.renderMissingImagesPanel = () => {
            const panel = document.getElementById('missingImagesPanel');
            const grid = document.getElementById('missingImagesGrid');
            const countDisplay = document.getElementById('missingCountDisplay');
            
            if (!panel || !grid) return;

            // Lấy tất cả ảnh TikZ (kể cả xong hay chưa xong)
            const tikzItems = pendingImageUploads.filter(item => item.type === 'tikz');

            if (tikzItems.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');
            countDisplay.textContent = tikzItems.length;
            grid.innerHTML = '';

            tikzItems.forEach(item => {
                const btn = document.createElement('button');
                btn.textContent = item.questionIdx + 1;
                
                // --- XỬ LÝ MÀU SẮC DỰA TRÊN TRẠNG THÁI ---
                let className = "w-full aspect-square flex items-center justify-center rounded font-bold text-xs shadow-sm transition-all border ";
                
                if (item._done) {
                    // THÀNH CÔNG -> MÀU XANH
                    className += "bg-green-100 border-green-500 text-green-700 hover:bg-green-200";
                    btn.title = "Đã biên dịch thành công";
                } else if (item.retries >= 3) {
                    // THẤT BẠI (Sau 3 lần) -> MÀU ĐỎ
                    className += "bg-red-100 border-red-500 text-red-700 hover:bg-red-200 animate-pulse";
                    btn.title = "Lỗi biên dịch. Click đúp để tải ảnh thủ công.";
                } else {
                    // ĐANG CHỜ -> MÀU TRẮNG/XÁM
                    className += "bg-white border-gray-300 text-gray-600 hover:bg-orange-100 hover:border-orange-500";
                    btn.title = "Đang chờ xử lý...";
                }
                
                btn.className = className;
                
                // --- XỬ LÝ SỰ KIỆN ---
                
                // 1. Click đơn: Cuộn đến câu hỏi
                btn.onclick = () => {
                    loadQuestionToEditor(item.questionIdx);
                    // Tìm placeholder hoặc ảnh đã chèn để highlight
                    setTimeout(() => {
                        // Nếu chưa xong -> Tìm placeholder
                        let target = document.querySelector(`.image-placeholder[data-id="${item.id}"]`);
                        
                        // Nếu đã xong -> Tìm thẻ img (nếu cần, nhưng thường chỉ cần cuộn đến câu là đủ)
                        if (!target && item._done) {
                             // Đã xong thì chỉ cần focus vào editor là được
                             window.showToast(`Câu ${item.questionIdx + 1} đã có hình!`, 'success');
                             return;
                        }

                        if (target) {
                            target.scrollIntoView({behavior: "smooth", block: "center"});
                            target.classList.add('ring-4', 'ring-orange-400');
                            setTimeout(() => target.classList.remove('ring-4', 'ring-orange-400'), 1000);
                        }
                    }, 300);
                };

                // 2. Click đúp: Mở hộp thoại tải ảnh (Cho trường hợp lỗi màu đỏ)
                btn.ondblclick = (e) => {
                    e.stopPropagation(); // Ngăn sự kiện click đơn
                    if (!item._done) {
                        window.triggerBatchUpload(item.id);
                    } else {
                        window.showToast("Hình này đã biên dịch xong rồi!", "info");
                    }
                };

                grid.appendChild(btn);
            });
        };

        window.finishImportProcess = () => {
            sortQuestionsByType(); 
            renderPreviewList(); 
            window.showToast("Đã nhập câu hỏi thành công!"); 
            
            if(window.MathJax) MathJax.typesetPromise();
            setTimeout(() => { 
                if(window.renderTikz) window.renderTikz(); 
                window.autoScaleTables(); 
            }, 500);
            
            if (pendingImageUploads.some(i => i.type === 'normal')) renderBatchImageModal();
            if (pendingImageUploads.some(i => i.type === 'tikz')) window.renderMissingImagesPanel();
        };

        window.handleManualImport = () => {
            document.getElementById('importModeModal').classList.add('opacity-0', 'pointer-events-none');
            window.finishImportProcess(); 
        };

        // --- HÀM CẬP NHẬT: XÓA KHOẢNG TRẮNG CHO TIKZ/VPS ---
        // --- HÀM FIX: XÓA CHỮ THỪA CHO TIKZ ---
        // --- HÀM MỚI: BIÊN DỊCH SONG SONG 2 LUỒNG (BATCH PROCESSING) ---
        // --- HÀM MỚI: WORKER POOL (CHẠY ĐUA 2 LUỒNG) ---
        // --- HÀM XỬ LÝ BIÊN DỊCH: WORKER POOL + REAL-TIME UI UPDATE ---
        window.handleAutoCompileAll = async () => {
            // 1. Chuẩn bị giao diện: Ẩn modal chọn, hiện thanh tiến độ
            document.getElementById('importModeModal').classList.add('opacity-0', 'pointer-events-none');
            const pm = document.getElementById('progressModal');
            pm.classList.remove('opacity-0', 'pointer-events-none');

            // 2. Lấy danh sách ảnh cần làm
            // Lưu ý: Map sang object mới để quản lý retry, nhưng vẫn giữ tham chiếu ID để update lại mảng gốc
            let queue = pendingImageUploads
                .filter(i => i.type === 'tikz' && !i._done)
                .map(item => ({ ...item, retries: 0 }));

            const total = queue.length;
            let finishedCount = 0;

            // Hàm cập nhật thanh tiến độ và bảng trạng thái
            const updateUI = () => {
                const pct = total > 0 ? Math.round((finishedCount / total) * 100) : 100;
                document.getElementById('compileProgressBar').style.width = `${pct}%`;
                document.getElementById('compileProgressText').innerText = `${finishedCount}/${total}`;
                document.getElementById('compilePercent').innerText = `${pct}%`;
                
                // QUAN TRỌNG: Gọi hàm vẽ lại bảng để ô đổi màu Xanh/Đỏ ngay lập tức
                if (window.renderMissingImagesPanel) window.renderMissingImagesPanel(); 
            };
            
            // Gọi lần đầu để reset bảng về trạng thái chờ
            if (window.renderMissingImagesPanel) window.renderMissingImagesPanel();

            // --- ĐỊNH NGHĨA CÔNG NHÂN (WORKER) ---
            const runWorker = async (workerId) => {
                // Chạy liên tục khi hàng đợi còn việc
                while (queue.length > 0) {
                    // Lấy 1 nhiệm vụ ra khỏi hàng đợi
                    const item = queue.shift();
                    
                    try {
                        console.log(`[Worker ${workerId}] Đang xử lý ảnh ${item.questionIdx + 1}...`);

                        // Gọi API (Hàm utils đã được cập nhật timeout 40s)
                        const url = await compileTikZToImage(item.contentCode);

                        // --> THÀNH CÔNG (Không bị treo, có link ảnh)
                        const imgTag = `<div class="flex justify-center my-1"><img src="${url}" class="rounded-lg shadow-sm" style="max-height:350px;" loading="lazy"></div>`;
                        
                        // Thay thế Marker trong nội dung câu hỏi bằng thẻ ảnh thật
                        window.questions.forEach(q => {
                            ['content', 'solution'].forEach(key => {
                                if (q[key] && q[key].includes(item.id)) {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = q[key];
                                    const ph = tempDiv.querySelector(`div[data-id="${item.id}"]`);
                                    if(ph) {
                                        ph.outerHTML = "___IMG_MARKER___";
                                        q[key] = tempDiv.innerHTML.replace(/___IMG_MARKER___/g, '\n' + imgTag + '\n');
                                    }
                                }
                            });
                        });

                        // Cập nhật trạng thái "Đã xong" vào danh sách gốc (pendingImageUploads)
                        const original = pendingImageUploads.find(i => i.id === item.id);
                        if(original) original._done = true;

                        // Tăng biến đếm và cập nhật giao diện (Ô sẽ chuyển XANH)
                        finishedCount++;
                        updateUI();
                        console.log(`[Worker ${workerId}] -> Ảnh ${item.questionIdx + 1} XONG.`);

                    } catch (err) {
                        // --> NẾU CÓ LỖI (Mạng, Timeout, v.v...)
                        console.warn(`[Worker ${workerId}] Lỗi ảnh ${item.questionIdx + 1}: ${err.message}`);
                        
                        item.retries++;
                        
                        // Cập nhật số lần retry vào danh sách gốc để bảng hiển thị màu ĐỎ nếu fail
                        const original = pendingImageUploads.find(i => i.id === item.id);
                        if(original) original.retries = item.retries;

                        if (item.retries < 3) {
                            // Nếu chưa quá 3 lần: Đẩy ngược lại vào đầu hàng đợi để thử lại ngay
                            console.log(`[Worker ${workerId}] -> Đẩy lại vào hàng đợi (Lần thử ${item.retries + 1})`);
                            queue.unshift(item);
                            
                            // QUAN TRỌNG: Nghỉ 3 giây để "xả" kết nối lỗi trước khi làm tiếp
                            await new Promise(r => setTimeout(r, 3000));
                        } else {
                            // Nếu đã lỗi 3 lần: Bỏ qua, coi như xong lượt này (nhưng trạng thái là lỗi)
                            console.error(`[Worker ${workerId}] -> BỎ QUA ảnh ${item.questionIdx + 1} sau 3 lần lỗi.`);
                            finishedCount++; 
                            updateUI(); // Ô sẽ chuyển ĐỎ
                        }
                    }
                    
                    // Nghỉ nhẹ 500ms giữa các ảnh để trình duyệt đóng socket cũ, tránh tắc nghẽn
                    await new Promise(r => setTimeout(r, 500));
                }
            };

            // 3. KHỞI ĐỘNG 2 CÔNG NHÂN CHẠY SONG SONG
            const workers = [runWorker(1), runWorker(2)];
            
            // Đợi tất cả công nhân hoàn thành hết việc
            await Promise.all(workers);

            // 4. KẾT THÚC
            setTimeout(() => {
                pm.classList.add('opacity-0', 'pointer-events-none');
                window.finishImportProcess();
                
                // Vẽ lại lần cuối để đảm bảo màu sắc đúng
                if (window.renderMissingImagesPanel) window.renderMissingImagesPanel();
                
                const failed = pendingImageUploads.filter(i => i.type === 'tikz' && !i._done);
                if (failed.length === 0) {
                    window.showToast("Xuất sắc! Đã biên dịch xong 100%.", "success");
                } else {
                    window.showToast(`Hoàn tất. Có ${failed.length} ảnh bị lỗi (Màu đỏ).`, "warning");
                }
            }, 800);
        };
        window.handleTexUpload = (input) => {
            const file = input.files[0]; 
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();
                
                let content = e.target.result;

                // --- [UPDATE] XỬ LÝ LÀM SẠCH LATEX THEO YÊU CẦU ---
                // 1. Loại bỏ \, (khoảng trắng nhỏ gây lỗi hiển thị)
                // 2. Loại bỏ môi trường multicols (Xóa tag, giữ nội dung)
                content = content.replace(/\\begin\{multicols\}\{.*?\}/g, "");
                content = content.replace(/\\end\{multicols\}/g, "");

                // 3. [FIX] Sửa lỗi align* -> Chuyển thành aligned và thêm $$ bao quanh
                // Cách này đảm bảo MathJax nhận diện đúng là khối công thức
                content = content.replace(/\\begin\{align\*\}([\s\S]*?)\\end\{align\*\}/g, (match, p1) => {
                    return `$$ \\begin{aligned}${p1}\\end{aligned} $$`;
                });
                // ---------------------------------------------------

                content = content.replace(/(?<!\\)%.*/g, '');
                content = content.replace(/\\begin\{array\}\s*\{[^{}]*?\}/g, '\\begin{matrix}');
                content = content.replace(/\\begin\{array\}/g, '\\begin{matrix}');
                content = content.replace(/\\end\{array\}/g, '\\end{matrix}');

                pendingImageUploads = [];
                
                const blockRegex = /\\begin\{(ex|bt|vd)\}([\s\S]*?)\\end\{\1\}/g;
                let match, count = 0;
                
                while ((match = blockRegex.exec(content)) !== null) {
                    let fullBody = match[2];
                    fullBody = fullBody.replace(/^\s*\[.*?\]/, ''); 
                    
                    let qType = 'essay';
                    let qData = { content: '', solution: '', options: [], statements: [], answer: '', point: 0 };
                    
                    let mainContent = fullBody;
                    const loigiaiIndex = fullBody.lastIndexOf('\\loigiai');
                    
                    if (loigiaiIndex !== -1) {
                        mainContent = fullBody.substring(0, loigiaiIndex);
                        const solPart = fullBody.substring(loigiaiIndex);
                        const solMatch = solPart.match(/\\loigiai\s*\{([\s\S]*)\}/);
                        if (solMatch) {
                             // Tìm đóng ngoặc chính xác cho lời giải
                             let depth = 0; let start = solPart.indexOf('{'); let end = -1;
                             for(let i=start; i<solPart.length; i++){
                                 if(solPart[i]=='{') depth++;
                                 else if(solPart[i]=='}') depth--;
                                 if(depth===0 && start!==-1) { end=i; break; }
                             }
                             if(end !== -1) {
                                 const solContent = solPart.substring(start+1, end);
                                 qData.solution = processLatexImagesWithDetection(cleanTikzCode(solContent), count);
                             }
                        }
                    }
                    
                    let procBody = processLatexImagesWithDetection(cleanTikzCode(mainContent), count);
                    
                    if (procBody.includes('\\choiceTF')) {
                        qType = 'tf';
                        const parts = procBody.split('\\choiceTF');
                        qData.content = parts[0].trim();
                        const statementsRaw = parts[1];
                        
                        let tempStmts = [];
                        let cursor = 0; 
                        function getNextArg(str) {
                            const s = str.indexOf('{', cursor); 
                            if(s===-1) return null;
                            let d=1; let e=-1;
                            for(let i=s+1; i<str.length; i++){
                                if(str[i]=='{') d++; else if(str[i]=='}') d--;
                                if(d===0){ e=i; break; }
                            }
                            if(e!==-1) { cursor=e+1; return str.substring(s+1, e); }
                            return null;
                        }
                        
                        cursor = 0; 
                        while(cursor < statementsRaw.length){
                            let txt = getNextArg(statementsRaw);
                            if(txt===null) break;
                            let isT = txt.includes('\\True');
                            tempStmts.push({text: txt.replace('\\True','').replace('\\False','').trim(), isTrue: isT});
                        }
                        qData.statements = tempStmts;

                    } else if (procBody.includes('\\choice')) {
                        qType = 'mc';
                        const parts = procBody.split('\\choice');
                        qData.content = parts[0].trim();
                        let cursor = 0;
                        let optsRaw = parts[1];
                        function getNextArg(str) { 
                            const s = str.indexOf('{', cursor); if(s===-1) return null;
                            let d=1; let e=-1;
                            for(let i=s+1; i<str.length; i++){ if(str[i]=='{') d++; else if(str[i]=='}') d--; if(d===0){ e=i; break; } }
                            if(e!==-1) { cursor=e+1; return str.substring(s+1, e); } return null;
                        }
                        let optCount = 0;
                        while(optCount < 4) {
                            let txt = getNextArg(optsRaw);
                            if(txt===null) break;
                            if(txt.includes('\\True')) qData.correct = optCount;
                            qData.options.push(txt.replace('\\True','').trim());
                            optCount++;
                        }
                    } else if (procBody.includes('\\shortans')) {
                        qType = 'short';
                        const parts = procBody.split('\\shortans');
                        qData.content = parts[0].trim();
                        let start = procBody.indexOf('\\shortans') + 9;
                        let depth = 0, end = -1;
                        if(procBody[start] !== '{') start = procBody.indexOf('{', start);
                        for(let i=start; i<procBody.length; i++){
                            if(procBody[i]=='{') depth++; else if(procBody[i]=='}') depth--;
                            if(depth===0 && depth !== -1) { end=i; break; }
                        }
                        if(end!==-1) qData.answer = procBody.substring(start+1, end).trim();
                    } else {
                        qType = 'essay';
                        qData.content = procBody;
                    }
                    
                    window.questions.push({ type: qType, ...qData });
                    count++;
                }

                input.value = ""; 
                
                const tikzCount = pendingImageUploads.filter(i => i.type === 'tikz').length;

                if (tikzCount > 0) {
                    document.getElementById('detectTikzCount').innerText = tikzCount;
                    const m = document.getElementById('importModeModal');
                    m.classList.remove('opacity-0', 'pointer-events-none');
                    m.querySelector('div').classList.add('scale-100');
                } else {
                    window.finishImportProcess();
                }
            };
            
            reader.readAsText(file);
        }

        function getAllImageUrls(dataObj) {
            const str = JSON.stringify(dataObj);
            const regex = /https:\/\/firebasestorage\.googleapis\.com\/v0\/b\/[^"'\s\\]+/g;
            return str.match(regex) || [];
        }

        // --- HÀM LƯU ĐỀ THI (CHUẨN HÓA LOGIC THAM CHIẾU) ---
        window.saveExam = async function(status) { 
            if (window.currentQIndex !== -1) saveCurrentQuestionToMemory(); 
            
            const title = document.getElementById('settingTitle').value.trim();
            if(!title) return window.customAlert("Vui lòng nhập tên đề thi!", "error");
            
            const btn = status === 'published' ? document.getElementById('btnPublish') : document.getElementById('btnSaveDraft');
            const originalText = btn.innerHTML; 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...'; 
            btn.disabled = true;

            try {
                // 1. Thu thập cấu hình
                const accessType = document.querySelector('input[name="settingAccess"]:checked').value;
                
                // Lấy danh sách lớp được chọn (Chỉ lấy nếu chọn chế độ "Lớp học")
                let selectedClassIds = [];
                if (accessType === 'class') {
                    selectedClassIds = Array.from(document.querySelectorAll('.class-checkbox:checked')).map(cb => cb.value);
                    if (status === 'published' && selectedClassIds.length === 0) {
                        throw new Error("Vui lòng chọn ít nhất một lớp học để giao bài!");
                    }
                }

                const settings = {
                    title: title, 
                    grade: document.getElementById('settingGrade').value, 
                    subject: document.getElementById('settingSubject').value,
                    duration: parseInt(document.getElementById('settingDuration').value) || 0, 
                    purpose: document.getElementById('settingPurpose').value,
                    startTime: document.getElementById('settingStartTime').value, 
                    endTime: document.getElementById('settingEndTime').value,
                    password: document.getElementById('settingPassword').value, 
                    attempts: parseInt(document.getElementById('settingAttempts').value) || 0,
                    proctoring: document.getElementById('settingProctoring').checked, 
                    shuffle: document.getElementById('settingShuffle').checked,
                    showScore: document.querySelector('input[name="settingShowScore"]:checked').value, 
                    showResult: document.querySelector('input[name="settingShowResult"]:checked').value,
                    passScore: parseFloat(document.getElementById('settingPassScoreInput').value) || 5,
                    feeQpoint: parseInt(document.getElementById('settingFeeQpointInput').value) || 0,
                    
                    // QUAN TRỌNG: Lưu danh sách lớp vào thẳng đề thi
                    accessType: accessType,
                    allowedClassIds: selectedClassIds 
                };

                // 2. Xử lý ảnh rác (Giữ nguyên logic cũ của bạn)
                if (currentExamId && window.originalQuestionsData.length > 0) {
                    const oldImages = getAllImageUrls(window.originalQuestionsData);
                    const newImages = getAllImageUrls(window.questions);
                    const deletedImages = oldImages.filter(url => !newImages.includes(url));
                    
                    if (deletedImages.length > 0) {
                        Promise.all(deletedImages.map(url => {
                            try { return deleteObject(ref(storage, url)).catch(e => console.log("Ignore delete err", e)); }
                            catch(e) { return Promise.resolve(); }
                        }));
                    }
                }
                sessionUploadedFiles = [];
                window.originalQuestionsData = JSON.parse(JSON.stringify(window.questions));

                // 3. Lưu dữ liệu vào Firestore
                const examRef = currentExamId ? doc(db, "exams", currentExamId) : doc(collection(db, "exams"));
                
                await setDoc(examRef, { 
                    ...settings, 
                    teacherId: currentUser.uid, 
                    questions: window.questions, 
                    questionCount: window.questions.length, 
                    status: status, 
                    updatedAt: new Date().toISOString(), 
                    ...(currentExamId ? {} : { createdAt: new Date().toISOString() }) 
                }, { merge: true });

                currentExamId = examRef.id; 
                document.getElementById('sidebarExamTitle').textContent = title;

                // 4. Hoàn tất
                if (status === 'published') {
                    const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + currentExamId;
                    document.getElementById('shareLinkInput').value = link; 
                    document.getElementById('shareModal').classList.remove('opacity-0', 'pointer-events-none');
                    document.getElementById('shareModal').querySelector('div').classList.add('scale-100');
                    document.getElementById('examStatus').textContent = '• Đã xuất bản'; 
                    document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                    document.getElementById('publishedLinkArea').classList.remove('hidden'); 
                    document.getElementById('settingShareLink').value = link;
                    
                    // Thông báo rõ ràng về việc giao bài
                    if(accessType === 'class') {
                        window.showToast(`Đã giao bài thành công cho ${selectedClassIds.length} lớp!`, "success");
                    } else {
                        window.showToast("Xuất bản công khai thành công!", "success");
                    }
                } else { 
                    window.showToast("Đã lưu bản nháp thành công!", "success"); 
                }
                
                if (!window.location.search.includes('id=')) window.history.pushState({path:window.location.href.split('?')[0] + '?id=' + currentExamId},'',window.location.href.split('?')[0] + '?id=' + currentExamId);

            } catch(e) { 
                console.error(e); 
                window.customAlert("Lỗi lưu đề thi: " + e.message, "error"); 
            } finally { 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            }
        };

        window.loadStats = async () => { 
            if (!currentExamId) return;
            
            // 1. Lấy kết quả thi
            const qRes = query(collection(db, "results"), where("examId", "==", currentExamId));
            const snapRes = await getDocs(qRes);
            statsMap = {}; 
            snapRes.forEach(d => { 
                const r = d.data();
                const attemptData = { ...r, id: d.id };
                const key = r.studentId || r.studentName; 
                if (!statsMap[key]) { 
                    statsMap[key] = { ...attemptData, attempts: [attemptData], bestScore: r.score }; 
                } else { 
                    statsMap[key].attempts.push(attemptData); 
                    if (r.score > statsMap[key].bestScore) { 
                        statsMap[key].bestScore = r.score; 
                        statsMap[key].score = r.score; 
                    } 
                } 
            });

            // 2. Lấy danh sách YÊU CẦU LÀM LẠI (Mới)
            window.reattemptRequests = {};
            try {
                const qReq = query(collection(db, "access_requests"), where("examId", "==", currentExamId), where("status", "==", "pending"));
                const snapReq = await getDocs(qReq);
                snapReq.forEach(d => {
                    const req = d.data();
                    window.reattemptRequests[req.studentId] = d.id; // Lưu ID yêu cầu theo StudentID
                });
            } catch(e) { console.log("Lỗi tải yêu cầu:", e); }

            // 3. Lấy thông tin lớp học
            const examRef = await getDoc(doc(db, "exams", currentExamId));
            const examData = examRef.data();
            fullStudentList = [];
            
            const classContainer = document.getElementById('classFilterContainer');
            if(classContainer) {
                classContainer.innerHTML = `<button onclick="filterStats('all')" class="px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm whitespace-nowrap transition-colors" id="filterBtnAll">Tất cả</button>`;
                
                if (examData.allowedClassIds && examData.allowedClassIds.length > 0) {
                    const uniqueIds = [...new Set(examData.allowedClassIds)];
                    for (const classId of uniqueIds) {
                        try {
                            const classSnap = await getDoc(doc(db, "classes", classId));
                            if (classSnap.exists()) {
                                const cls = classSnap.data();
                                const btn = document.createElement('button');
                                btn.className = `px-3 py-1.5 rounded-lg text-sm font-bold bg-white text-gray-600 border hover:bg-gray-50 shadow-sm whitespace-nowrap transition-colors class-filter-btn`;
                                btn.dataset.id = classId;
                                btn.textContent = cls.name;
                                btn.onclick = () => filterStats(classId);
                                classContainer.appendChild(btn);

                                const students = cls.students || [];
                                students.forEach(st => {
                                    fullStudentList.push({ 
                                        studentId: st.uid, 
                                        studentName: st.name, 
                                        className: cls.name, 
                                        classId: classId 
                                    });
                                });
                            }
                        } catch(e) {}
                    }
                } else {
                    fullStudentList = Object.values(statsMap).map(s => ({ 
                        studentId: s.studentId, 
                        studentName: s.studentName, 
                        className: 'Tự do', 
                        classId: 'public' 
                    }));
                }
            }
            renderStatsDashboard();
        };

        window.renderStatsDashboard = () => { 
            const uniqueStudents = Object.values(statsMap); 
            const totalSubs = uniqueStudents.length;
            let totalScore = 0; 
            uniqueStudents.forEach(r => totalScore += parseFloat(r.bestScore)||0); 
            const avg = totalSubs > 0 ? (totalScore / totalSubs).toFixed(2) : 0;
            const scores = uniqueStudents.map(r => r.bestScore); 
            const maxScore = scores.length > 0 ? Math.max(...scores) : 0; 
            const minScore = scores.length > 0 ? Math.min(...scores) : 0;
            
            document.getElementById('statTotalSubmissions').textContent = totalSubs; 
            document.getElementById('statAvgScore').textContent = avg;
            document.getElementById('statMaxScore').textContent = maxScore; 
            document.getElementById('statMinScore').textContent = minScore;
            
            // Vẽ biểu đồ
            const spectrum = Array(11).fill(0); 
            scores.forEach(s => spectrum[Math.floor(s)]++);
            const ctx = document.getElementById('scoreChart').getContext('2d'); 
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'bar', data: { labels: ['0-1', '1-2', '2-3', '3-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10', '10'], datasets: [{ label: 'Số lượng', data: spectrum, backgroundColor: '#3B82F6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
            
            // Phân tích câu hỏi
            const qListDiv = document.getElementById('questionAnalysisList'); 
            if(qListDiv) {
                qListDiv.innerHTML = '';
                const qStats = window.questions.map(() => ({ correct: 0, total: 0 }));
                Object.values(statsMap).forEach(student => { 
                    student.attempts.forEach(attempt => { 
                        if(attempt.answers) { 
                            window.questions.forEach((q, idx) => { 
                                const u = attempt.answers[idx]; 
                                if (u !== undefined && u !== null) { 
                                    qStats[idx].total++; 
                                    let isCorrect = false; 
                                    if (q.type === 'mc' && u === q.correct) isCorrect = true; 
                                    else if (q.type === 'short' && q.answer && String(u).trim().toLowerCase() === String(q.answer).trim().toLowerCase()) isCorrect = true; 
                                    if (isCorrect) qStats[idx].correct++; 
                                } 
                            }); 
                        } 
                    }); 
                });
                qStats.forEach((stat, idx) => { 
                    const percent = stat.total > 0 ? Math.round((stat.correct / stat.total) * 100) : 0; 
                    const colorClass = percent > 80 ? 'bg-green-500' : (percent > 50 ? 'bg-yellow-500' : 'bg-red-500'); 
                    qListDiv.innerHTML += `<div class="flex items-center gap-2 text-xs"><span class="w-10 font-bold text-gray-500">Câu ${idx+1}</span><div class="flex-1 progress-bar-bg"><div class="progress-bar-fill ${colorClass}" style="width: ${percent}%"></div></div><span class="w-8 text-right font-bold text-gray-700">${percent}%</span></div>`; 
                });
            }
            renderStatsTable(); // Gọi hàm vẽ bảng
        };

        window.filterStats = (classId) => {
            currentClassFilter = classId;
            // Update giao diện nút Lớp (Đổi màu nút đang chọn)
            const btnAll = document.getElementById('filterBtnAll');
            if(btnAll) btnAll.className = classId === 'all' 
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm whitespace-nowrap transition-colors" 
                : "px-3 py-1.5 rounded-lg text-sm font-bold bg-white text-gray-600 border hover:bg-gray-50 shadow-sm whitespace-nowrap transition-colors";
            
            document.querySelectorAll('.class-filter-btn').forEach(btn => {
                const isActive = btn.dataset.id === classId;
                btn.className = isActive 
                    ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm whitespace-nowrap transition-colors class-filter-btn" 
                    : "px-3 py-1.5 rounded-lg text-sm font-bold bg-white text-gray-600 border hover:bg-gray-50 shadow-sm whitespace-nowrap transition-colors class-filter-btn";
            });
            renderStatsTable();
        };

        window.filterStatus = (status) => {
            currentStatusFilter = status;
            // Update giao diện nút Trạng thái
            ['all', 'done', 'missing', 'graded', 'not_graded'].forEach(s => {
                const btn = document.getElementById(`stBtn_${s}`);
                if (!btn) return;
                if (s === status) btn.className = "px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700 border border-blue-200 transition-colors";
                else btn.className = "px-3 py-1 text-xs font-bold rounded text-gray-500 hover:bg-gray-50 transition-colors";
            });
            renderStatsTable();
        };

        window.renderStatsTable = () => {
            const tbody = document.getElementById('statsTableBody'); 
            if (!tbody) return;
            tbody.innerHTML = '';

            let combinedData = fullStudentList.map(st => {
                const result = statsMap[st.studentId] || statsMap[st.studentName];
                // Kiểm tra xem có yêu cầu làm lại không
                const requestId = window.reattemptRequests ? window.reattemptRequests[st.studentId] : null;
                
                if (result) {
                    return { ...st, ...result, hasSubmitted: true, requestId: requestId };
                } else {
                    return { ...st, score: '--', attempts: [], hasSubmitted: false, status: 'Chưa làm', requestId: requestId };
                }
            });

            // Thêm học sinh tự do
            Object.values(statsMap).forEach(res => {
                if (!combinedData.find(d => d.studentId === res.studentId)) {
                    combinedData.push({ 
                        ...res, className: 'Khác', classId: 'other', hasSubmitted: true,
                        requestId: window.reattemptRequests ? window.reattemptRequests[res.studentId] : null
                    });
                }
            });

            // (Giữ nguyên phần lọc và sắp xếp cũ...)
            // ... [CODE LỌC GIỮ NGUYÊN] ...
            let filteredData = combinedData.filter(item => {
                if (currentClassFilter !== 'all' && item.classId !== currentClassFilter) return false;
                if (currentStatusFilter === 'done' && !item.hasSubmitted) return false;
                if (currentStatusFilter === 'missing' && item.hasSubmitted) return false;
                if (currentStatusFilter === 'graded' && (!item.hasSubmitted || !item.gradedAt)) return false;
                if (currentStatusFilter === 'not_graded' && (!item.hasSubmitted || item.gradedAt)) return false;
                return true;
            });
            
            const sortType = document.getElementById('sortStats').value;
            filteredData.sort((a, b) => { 
                if (sortType === 'time_desc') return new Date(b.submittedAt || 0) - new Date(a.submittedAt || 0);
                const sA = parseFloat(a.bestScore) || 0; 
                const sB = parseFloat(b.bestScore) || 0; 
                return sortType === 'score_desc' ? sB - sA : sA - sB; 
            });

            // Render HTML
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400 text-sm">Không tìm thấy học sinh nào.</td></tr>';
                return;
            }

            filteredData.forEach(r => { 
                const dateStr = r.submittedAt ? new Date(r.submittedAt).toLocaleString('vi-VN') : '<span class="text-gray-400 italic">Chưa nộp</span>'; 
                const scoreClass = !r.hasSubmitted ? 'text-gray-300' : (r.bestScore >= 8 ? 'text-green-600' : (r.bestScore >= 5 ? 'text-blue-600' : 'text-red-500')); 
                const attemptCount = r.attempts ? r.attempts.length : 0; 
                
                const nameHtml = r.hasSubmitted 
                    ? `<button onclick="showStudentHistory('${r.studentName}')" class="font-bold text-blue-600 hover:underline flex items-center gap-2"><i class="fa-solid fa-user-graduate"></i> ${r.studentName}</button>` 
                    : `<span class="text-gray-500 flex items-center gap-2"><i class="fa-regular fa-user"></i> ${r.studentName}</span>`;
                
                let statusBadge = '';
                if (r.hasSubmitted) {
                    if (r.gradedAt) statusBadge = '<span class="text-[10px] bg-green-100 text-green-700 px-1.5 rounded border border-green-200">Đã chấm</span>';
                    else statusBadge = '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 rounded border border-yellow-200">Chờ chấm</span>';
                }

                const cheatBadge = (r.hasSubmitted && r.cheatCount > 0) 
                    ? `<span class="ml-1 bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold"><i class="fa-solid fa-triangle-exclamation"></i> ${r.cheatCount}</span>` : '';

                // --- NÚT CẤP QUYỀN (MỚI) ---
                // --- NÚT XỬ LÝ YÊU CẦU ---
                let actionBtn = '';
                if (r.requestId) {
                    // CÓ YÊU CẦU: Hiện 2 nút Duyệt (Xanh) và Từ chối (Xám)
                    // Lưu lý do xin phép vào data attribute để hiển thị tooltip nếu cần
                    actionBtn = `
                        <div class="flex flex-col gap-1 items-end">
                            <button onclick="approveReattempt('${r.studentId}', '${r.requestId}', '${r.studentName}')" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-bold shadow-sm whitespace-nowrap flex items-center gap-1">
                                <i class="fa-solid fa-check"></i> Duyệt
                            </button>
                            <button onclick="denyReattempt('${r.requestId}', '${r.studentName}')" class="px-3 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300 text-xs font-bold shadow-sm whitespace-nowrap flex items-center gap-1">
                                <i class="fa-solid fa-xmark"></i> Từ chối
                            </button>
                        </div>`;
                } else if (r.hasSubmitted) {
                    // CHƯA CÓ YÊU CẦU (Đã nộp): Nút cấp lại thủ công
                    actionBtn = `<button onclick="approveReattempt('${r.studentId}', null, '${r.studentName}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center transition-colors" title="Cấp quyền làm lại thủ công"><i class="fa-solid fa-rotate-right"></i></button>`;
                }

                tbody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-gray-50 transition-colors ${!r.hasSubmitted ? 'bg-gray-50/50' : ''}">
                        <td class="px-6 py-3">
                            <div class="font-medium text-gray-900">${nameHtml}</div>
                            <div class="text-[10px] text-gray-500 flex items-center gap-1 mt-1">
                                <span class="bg-gray-100 px-1.5 rounded border border-gray-200 text-gray-600">${r.className || 'Tự do'}</span>
                                ${statusBadge} ${cheatBadge}
                            </div>
                        </td>
                        <td class="px-6 py-3 text-center font-bold ${scoreClass} text-lg">${r.hasSubmitted ? r.bestScore : '--'}</td>
                        <td class="px-6 py-3 text-center text-xs text-gray-500 font-bold">${attemptCount}</td>
                        <td class="px-6 py-3 text-right text-xs text-gray-500 font-mono">
                            <div class="flex flex-col items-end gap-1">
                                <span>${dateStr}</span>
                                ${actionBtn}
                            </div>
                        </td>
                    </tr>`; 
            });
        };
        
        window.showStudentHistory = (studentName) => {
            const studentData = Object.values(statsMap).find(s => s.studentName === studentName);
            if (!studentData || !studentData.attempts) return;
            
            const modal = document.getElementById('historyModal'); 
            const content = document.getElementById('histModalContent'); 
            const title = document.getElementById('histModalTitle');
            
            title.innerHTML = `<i class="fa-solid fa-clock-rotate-left mr-2"></i>Lịch sử: ${studentName}`; 
            
            // Tạo bảng lịch sử nâng cao
            content.innerHTML = `
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="bg-blue-50 text-blue-800 uppercase text-xs">
                        <tr><th class="p-3">Lần thi</th><th class="p-3 text-center">Điểm</th><th class="p-3 text-center">Vi phạm</th><th class="p-3 text-right">Hành động</th></tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="histTbody"></tbody>
                </table>`;
            
            const tbody = document.getElementById('histTbody'); 
            // Sắp xếp: Mới nhất lên đầu
            const sortedAttempts = [...studentData.attempts].sort((a,b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            
            sortedAttempts.forEach((att, idx) => { 
                const attemptIndex = sortedAttempts.length - idx; // Lần 1, Lần 2...
                const cheatBadge = att.cheatCount > 0 ? `<span class="text-red-500 font-bold text-xs"><i class="fa-solid fa-triangle-exclamation"></i> ${att.cheatCount}</span>` : `<span class="text-green-500"><i class="fa-solid fa-check"></i></span>`;
                
                // Nút mở Giao diện Chấm thi
                // Lưu index vào attribute để hàm openGrading truy xuất
                tbody.innerHTML += `
                    <tr>
                        <td class="p-3 font-bold">Lần ${attemptIndex} <div class="text-[10px] text-gray-400 font-normal">${new Date(att.submittedAt).toLocaleString('vi-VN')}</div></td>
                        <td class="p-3 text-center font-black text-blue-600 text-lg">${att.score}</td>
                        <td class="p-3 text-center">${cheatBadge}</td>
                        <td class="p-3 text-right">
                            <button onclick='window.openGrading(${JSON.stringify(att).replace(/'/g, "&apos;")})' class="px-3 py-1.5 bg-white border border-blue-200 text-blue-600 rounded-lg hover:bg-blue-50 text-xs font-bold shadow-sm transition-all">
                                <i class="fa-solid fa-pen-nib mr-1"></i> Chấm / Xem
                            </button>
                        </td>
                    </tr>`; 
            });
            
            modal.classList.remove('opacity-0', 'pointer-events-none'); 
            modal.querySelector('div').classList.add('scale-100');
        };
        window.closeHistoryModal = () => { document.getElementById('historyModal').classList.add('opacity-0', 'pointer-events-none'); };
        window.exportToExcel = () => { if (Object.keys(statsMap).length === 0) return window.showToast("Chưa có dữ liệu để xuất!", "error"); const wb = XLSX.utils.book_new(); const dataSummary = Object.values(statsMap).map((r, i) => ({ "STT": i + 1, "Họ tên": r.studentName, "Điểm cao nhất": r.bestScore, "Số lần thi": r.attempts.length, "Ngày nộp cuối": new Date(r.submittedAt).toLocaleString('vi-VN') })); const wsSummary = XLSX.utils.json_to_sheet(dataSummary); XLSX.utils.book_append_sheet(wb, wsSummary, "Tong_Hop"); XLSX.writeFile(wb, `KetQua_${document.getElementById('settingTitle').value.replace(/\s/g, '_')}.xlsx`); };

        window.switchView = (viewId) => { document.getElementById('view-settings').classList.add('hidden'); document.getElementById('view-editor').classList.add('hidden'); document.getElementById('view-editor').classList.remove('flex'); document.getElementById('view-stats').classList.add('hidden'); document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active')); if (viewId === 'settings') { document.getElementById('view-settings').classList.remove('hidden'); document.getElementById('menu-settings').classList.add('active'); } else if (viewId === 'editor') { document.getElementById('view-editor').classList.remove('hidden'); document.getElementById('view-editor').classList.add('flex'); document.getElementById('menu-editor').classList.add('active'); if(window.MathJax) MathJax.typesetPromise(); } else if (viewId === 'stats') { document.getElementById('view-stats').classList.remove('hidden'); document.getElementById('menu-stats').classList.add('active'); loadStats(); } };
        window.copyLink = () => { document.getElementById("shareLinkInput").select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); };
        window.copySettingLink = () => { document.getElementById("settingShareLink").select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); };
        window.closeShareModal = () => { document.getElementById('shareModal').classList.add('opacity-0', 'pointer-events-none'); };
        window.showToast = (message, type='success') => { const c = document.getElementById('toastContainer'); const d = document.createElement('div'); d.className = `bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] transform translate-x-full transition-transform duration-300`; d.innerHTML = `<div><h4 class="font-bold text-gray-800 text-sm">THÔNG BÁO</h4><p class="text-sm text-gray-600">${message}</p></div>`; c.appendChild(d); requestAnimationFrame(()=>d.classList.remove('translate-x-full')); setTimeout(()=>{d.classList.add('translate-x-full'); setTimeout(()=>d.remove(), 500);}, 3000); };
        window.togglePrivasySettings = (type) => { document.getElementById('classSelectionArea').className = type === 'class' ? 'pl-6 block mt-2' : 'hidden'; };
        
        async function loadTeacherClasses() { 
            const container = document.getElementById('classCheckboxList'); 
            if (!currentUser || !container) return; 
            const q = query(collection(db, "classes"), where("teacherId", "==", currentUser.uid)); 
            const snap = await getDocs(q); 
            container.innerHTML = ''; 
            
            if(snap.empty) {
                container.innerHTML = '<p class="text-xs text-red-500 p-2">Thầy cô chưa tạo lớp học nào.</p>';
                return;
            }

            snap.forEach(doc => { 
                const cls = doc.data();
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-1.5 hover:bg-white rounded cursor-pointer';
                div.innerHTML = `
                    <input type="checkbox" id="cls_${doc.id}" value="${doc.id}" class="class-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                    <label for="cls_${doc.id}" class="text-sm text-gray-700 font-bold cursor-pointer select-none flex-1">${cls.name}</label>
                `;
                container.appendChild(div);
            }); 
        };

        window.toggleSidebar = () => { const s = document.getElementById('mainSidebar'); const o = document.getElementById('sidebarOverlay'); if (s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } };
        window.openScoringModal = () => { document.getElementById('scoringModal').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('scoringModal').querySelector('div').classList.add('scale-100'); let cM=0, cTF=0, cE=0; let h=''; window.questions.forEach((q,i)=>{ if(q.type==='essay'){ cE++; h+=`<div class="flex items-center gap-2 text-sm"><span class="w-16 font-bold">Câu ${i+1}</span><input type="number" id="essay-score-${i}" class="form-input h-8 text-right w-20" value="${q.point||0}" step="0.1"></div>`; } else if(q.type==='tf') cTF++; else cM++; }); document.getElementById('countMcShort').textContent=cM; document.getElementById('countTF').textContent=cTF; document.getElementById('countEssay').textContent=cE; document.getElementById('essayScoreList').innerHTML = cE>0 ? h : '<p class="text-xs text-gray-400 italic">Không có câu tự luận.</p>'; };
        window.closeScoringModal = () => { document.getElementById('scoringModal').classList.add('opacity-0', 'pointer-events-none'); };
        window.applyScoring = () => { const tM = parseFloat(document.getElementById('scoreTotalMcShort').value)||0; const tTF = parseFloat(document.getElementById('scoreTotalTF').value)||0; let cM=0, cTF=0; window.questions.forEach(q=>{if(q.type==='mc'||q.type==='short')cM++; else if(q.type==='tf')cTF++;}); const pM=cM>0?(tM/cM):0; const pTF=cTF>0?(tTF/cTF):0; window.questions.forEach((q,i)=>{ if(q.type==='mc'||q.type==='short') q.point=parseFloat(pM.toFixed(2)); else if(q.type==='tf') q.point=parseFloat(pTF.toFixed(2)); else if(q.type==='essay'){ const inp=document.getElementById(`essay-score-${i}`); if(inp) q.point=parseFloat(inp.value)||0; } }); closeScoringModal(); renderPreviewList(); window.showToast("Đã chia điểm!"); };
        // --- 1. HÀM TẠO ĐỀ MỚI (QUICK ACCESS) ---
        window.handleNewExam = async () => {
            const hasUnsavedChanges = JSON.stringify(window.questions) !== JSON.stringify(window.originalQuestionsData);
            const hasPendingImages = sessionUploadedFiles.length > 0;

            if (hasUnsavedChanges || hasPendingImages) {
                const confirmReset = await window.customConfirm(
                    "CẢNH BÁO: Bạn đang có nội dung chưa lưu!\n\nNếu tạo đề mới ngay, các thay đổi và HÌNH ẢNH vừa tải lên (chưa lưu) sẽ bị XÓA VĨNH VIỄN.\n\nBạn có chắc chắn muốn tiếp tục?"
                );
                if (!confirmReset) return;
            }

            const loadingToast = document.createElement('div');
            loadingToast.className = 'fixed inset-0 bg-black/50 z-[200] flex items-center justify-center';
            loadingToast.innerHTML = '<div class="bg-white p-6 rounded-xl flex flex-col items-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i><p class="font-bold">Đang khởi tạo phiên làm việc mới...</p></div>';
            document.body.appendChild(loadingToast);

            try {
                if (sessionUploadedFiles.length > 0) {
                    await Promise.all(sessionUploadedFiles.map(key => deleteR2Image(key)));
                }
                // Reload trang (không kèm ID) để về trạng thái trắng tinh
                window.location.href = 'exam-editor.html';
            } catch (err) {
                console.error("Lỗi dọn dẹp:", err);
                window.location.href = 'exam-editor.html';
            }
        };

        // --- HÀM MỚI: DỌN DẸP KHOẢNG TRẮNG THỪA QUANH ẢNH ---
        // --- HÀM MỚI: DỌN DẸP KHOẢNG TRẮNG (PHIÊN BẢN MẠNH MẼ & AN TOÀN) ---
        window.cleanWhitespace = () => {
            let count = 0;

            // Hàm con: Xử lý dọn dẹp theo hướng (Trước/Sau)
            const cleanNode = (node, direction) => {
                let sibling = direction === 'prev' ? node.previousSibling : node.nextSibling;
                
                // Vòng lặp quét liên tục các phần tử lân cận
                while (sibling) {
                    // Lưu lại phần tử tiếp theo trước khi có thể bị xóa
                    const nextSibling = direction === 'prev' ? sibling.previousSibling : sibling.nextSibling;
                    let shouldRemove = false;

                    // 1. Nếu là thẻ <br> -> XÓA
                    if (sibling.nodeName === 'BR') {
                        shouldRemove = true;
                    }
                    // 2. Nếu là Văn bản (Text Node)
                    else if (sibling.nodeType === 3) {
                        const text = sibling.textContent;
                        if (!text.trim()) {
                            // Nếu chỉ toàn dấu cách -> XÓA
                            shouldRemove = true;
                        } else {
                            // Nếu có chữ nhưng bị thừa dấu cách ở đầu/đuôi -> CẮT GỌT
                            // Ví dụ: "Câu hỏi:   " -> "Câu hỏi:"
                            const trimmed = direction === 'prev' ? text.trimEnd() : text.trimStart();
                            if (trimmed !== text) {
                                sibling.textContent = trimmed;
                                count++;
                            }
                            // Gặp chữ rồi thì dừng lại, không xóa tiếp
                            break;
                        }
                    }
                    // 3. Nếu là Thẻ Khối (P, DIV, SPAN...) mà bên trong rỗng tuếch
                    // Ví dụ: <p>&nbsp;</p> hoặc <p><br></p>
                    else if (sibling.nodeType === 1 && ['P', 'DIV', 'SPAN', 'STRONG', 'EM'].includes(sibling.nodeName)) {
                        // Kiểm tra xem bên trong có ảnh hay nội dung gì không
                        if (!sibling.innerText.trim() && !sibling.querySelector('img')) {
                            shouldRemove = true;
                        } else {
                            break; // Gặp khối có nội dung thì dừng
                        }
                    } else {
                        break; // Gặp thẻ lạ thì dừng
                    }

                    if (shouldRemove) {
                        sibling.remove();
                        count++;
                    }
                    
                    // Tiếp tục xét phần tử kế tiếp
                    sibling = nextSibling;
                }
            };

            // Duyệt qua tất cả câu hỏi
            window.questions.forEach(q => {
                let isModified = false;
                ['content', 'solution'].forEach(key => {
                    if (!q[key]) return;
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = q[key];
                    
                    // Tìm tất cả ảnh trong nội dung
                    const images = tempDiv.querySelectorAll('img');
                    if (images.length === 0) return;

                    images.forEach(img => {
                        // Xác định mục tiêu là khối bao quanh ảnh (nếu có class flex) hoặc chính thẻ img
                        let target = img;
                        if (img.parentElement && img.parentElement.classList.contains('flex')) {
                            target = img.parentElement;
                        }
                        
                        // Quét sạch phía trước và phía sau
                        cleanNode(target, 'prev');
                        cleanNode(target, 'next');
                    });

                    // Nếu nội dung thay đổi so với ban đầu thì cập nhật
                    if (tempDiv.innerHTML !== q[key]) {
                        q[key] = tempDiv.innerHTML;
                        isModified = true;
                    }
                });
                
                if (isModified) count++;
            });

            if (count > 0) {
                window.renderPreviewList();
                // Load lại câu hiện tại để thấy ngay kết quả
                if (window.currentQIndex !== -1) window.loadQuestionToEditor(window.currentQIndex);
                window.showToast(`Đã dọn sạch rác cho ${count} câu hỏi!`, "success");
            } else {
                window.showToast("Không tìm thấy khoảng trắng thừa nào.", "info");
            }
        };
        // --- 2. HÀM XÓA TOÀN BỘ CÂU HỎI ---
        window.deleteAllQuestions = async () => {
            if (window.questions.length === 0) {
                window.showToast("Danh sách đang trống!", "warning");
                return;
            }
            const confirmDel = await window.customConfirm(
                `CẢNH BÁO NGUY HIỂM!\n\nBạn sắp xóa toàn bộ ${window.questions.length} câu hỏi trong đề này.\nHành động này không thể hoàn tác.\n\nBạn có chắc chắn không?`
            );
            if (confirmDel) {
                window.questions = [];
                window.currentQIndex = -1;
                window.renderPreviewList();
                document.getElementById('editorArea').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>';
                window.showToast("Đã xóa sạch câu hỏi!", "success");
            }
        };
        // --- HÀM QUAY LẠI THÔNG MINH (ĐÃ SỬA) ---
        window.handleBackNavigation = async () => {
            const hasUnsavedChanges = JSON.stringify(window.questions) !== JSON.stringify(window.originalQuestionsData);
            const hasPendingImages = sessionUploadedFiles.length > 0;

            // 1. Xác định đích đến dựa trên URL hiện tại
            const urlParams = new URLSearchParams(window.location.search);
            const assignToClassId = urlParams.get('assignTo'); // Lấy ID lớp nếu đang giao bài
            
            let targetUrl = 'dashboard.html?view=exambank'; // Mặc định về Ngân hàng đề

            if (assignToClassId) {
                // Nếu đang soạn đề cho lớp -> Quay về chi tiết lớp đó, tab Bài tập
                targetUrl = `dashboard.html?view=class_detail&id=${assignToClassId}&tab=exams`;
            }

            // 2. Kiểm tra dữ liệu chưa lưu
            if (hasUnsavedChanges || hasPendingImages) {
                const confirmLeave = await window.customConfirm(
                    "Bạn chưa lưu thay đổi.\nNếu thoát bây giờ, các ảnh vừa tải lên sẽ bị XÓA BỎ VĨNH VIỄN.\nBạn có chắc chắn muốn thoát?"
                );

                if (confirmLeave) {
                    if (hasPendingImages) {
                        const toast = document.createElement('div');
                        toast.className = 'fixed inset-0 bg-black/50 z-[200] flex items-center justify-center';
                        toast.innerHTML = '<div class="bg-white p-6 rounded-xl flex flex-col items-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i><p class="font-bold">Đang dọn dẹp dữ liệu rác...</p></div>';
                        document.body.appendChild(toast);
                        
                        try {
                            await Promise.all(sessionUploadedFiles.map(key => deleteR2Image(key)));
                            sessionUploadedFiles = []; 
                        } catch(e) { console.log("Lỗi dọn dẹp:", e); }
                    }
                    window.location.href = targetUrl; // <--- Dùng biến targetUrl động
                }
            } else {
                window.location.href = targetUrl; // <--- Dùng biến targetUrl động
            }
        };
        
        window.addEventListener('pagehide', () => {
            if (sessionUploadedFiles.length > 0) {
                sessionUploadedFiles.forEach(key => deleteR2Image(key));
            }
        });      
        
        async function deleteR2Image(input) {
            if (!input) return;
            try {
                let keyName = input;
                if (input.startsWith('http')) {
                    try {
                        const urlObj = new URL(input);
                        keyName = urlObj.pathname.substring(1); 
                        keyName = decodeURIComponent(keyName);
                    } catch(e) { console.warn("Lỗi parse URL:", input); }
                }
                
                return fetch(`https://upload-helper.phamngockhanh-942001.workers.dev/?key=${encodeURIComponent(keyName)}`, {
                    method: 'DELETE',
                    keepalive: true 
                });
            } catch (e) { console.error("Lỗi xóa R2:", e); }
        }
        
        window.addEventListener('resize', () => {
            window.autoScaleTables();
        });
        
        document.addEventListener('paste', async (e) => {
            const activeEl = document.activeElement;
            if (!activeEl || !activeEl.classList.contains('image-placeholder')) return;

            const id = activeEl.getAttribute('data-id');
            if (!id) return;

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault(); 
                    const file = item.getAsFile();
                    const originalContent = activeEl.innerHTML;
                    activeEl.innerHTML = '<div class="animate-bounce text-blue-600"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><p class="text-xs mt-2 font-bold">Đang xử lý ảnh...</p></div>';
                    try {
                        window.showToast("Đang tải ảnh từ bộ nhớ tạm...", "info");
                        await uploadAndReplaceImage(file, id);
                        window.showToast("Dán ảnh thành công!", "success");
                    } catch (err) {
                        console.error(err);
                        activeEl.innerHTML = originalContent; 
                        window.showToast("Lỗi dán ảnh: " + err.message, "error");
                    }
                    return; 
                }
            }
        });
    // --- LOGIC CHẤM THI (GRADING) ---
        let currentGradingAttempt = null;

        window.openGrading = (attempt) => {
            currentGradingAttempt = attempt;
            document.getElementById('historyModal').classList.add('opacity-0', 'pointer-events-none'); // Ẩn modal lịch sử
            
            const modal = document.getElementById('gradingModal');
            document.getElementById('gradingStudentName').textContent = attempt.studentName;
            document.getElementById('gradingTotalScore').textContent = attempt.score;
            
            renderGradingView();
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 50);
        };

        window.closeGradingModal = () => {
            const modal = document.getElementById('gradingModal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        window.renderGradingView = () => {
            const container = document.getElementById('gradingQuestionList');
            const nav = document.getElementById('gradingNavList');
            container.innerHTML = '';
            nav.innerHTML = '';
            
            const answers = currentGradingAttempt.answers || {};

            window.questions.forEach((q, idx) => {
                const u = answers[idx];
                let isCorrect = false; 
                let score = 0;
                let maxPoint = parseFloat(q.point) || 0;
                
                // Logic chấm tự động để hiển thị màu
                if (q.type === 'mc' && u === q.correct) isCorrect = true;
                else if (q.type === 'short' && q.answer && String(u).trim().toLowerCase() === String(q.answer).trim().toLowerCase()) isCorrect = true;
                else if (q.type === 'tf') {/*...*/ } // (Giản lược hiển thị TF)

                // Render Nav Item
                const navItem = document.createElement('button');
                navItem.className = `w-full text-left p-3 rounded-lg text-xs font-bold mb-1 border ${q.type==='essay' ? 'bg-purple-50 border-purple-200 text-purple-700' : (isCorrect ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700')}`;
                navItem.innerHTML = `Câu ${idx+1} <span class="float-right">${q.type.toUpperCase()}</span>`;
                navItem.onclick = () => document.getElementById(`grade-q-${idx}`).scrollIntoView({behavior:'smooth', block:'center'});
                nav.appendChild(navItem);

                // Render Main Content
                const card = document.createElement('div');
                card.id = `grade-q-${idx}`;
                card.className = "bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden";
                
                let answerHtml = '';
                
                if (q.type === 'essay') {
                    // HIỂN THỊ ẢNH TỰ LUẬN
                    if (u && u.includes('<img')) {
                        answerHtml = `<div class="p-4 bg-gray-50 border-t border-b border-gray-100">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Bài làm của học sinh:</div>
                            <div class="grading-essay-content">${u}</div>
                        </div>`;
                    } else {
                        answerHtml = `<div class="p-4 text-gray-400 italic text-sm">Học sinh không nộp bài cho câu này.</div>`;
                    }
                    
                    // Ô NHẬP ĐIỂM CHO TỰ LUẬN
                    // Nếu chưa có điểm riêng, mặc định là 0 (hoặc logic tự chia điểm trước đó nếu có)
                    // Ở đây ta tạm lấy maxPoint nếu chưa chấm, hoặc cần lưu điểm chấm riêng vào attempt
                    // [TODO] Cần lưu điểm chấm tay vào cấu trúc dữ liệu. Tạm thời dùng input để nhập.
                    
                    answerHtml += `
                        <div class="p-4 bg-yellow-50 flex items-center justify-between">
                            <span class="font-bold text-yellow-800 text-sm"><i class="fa-solid fa-pen-nib mr-2"></i>Chấm điểm:</span>
                            <div class="flex items-center gap-2">
                                <input type="number" id="manual-score-${idx}" class="form-input w-24 text-right font-bold text-lg text-blue-600" 
                                    value="${maxPoint}" max="${maxPoint}" min="0" step="0.1" onchange="updateTotalScore()">
                                <span class="text-gray-500 font-bold">/ ${maxPoint}đ</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Các loại câu khác (Chỉ xem, không sửa điểm)
                    let userText = (u !== undefined) ? (q.type==='mc' ? `Phương án ${String.fromCharCode(65+u)}` : u) : 'Bỏ trống';
                    answerHtml = `<div class="p-3 border-t bg-gray-50 text-sm">
                        Học sinh chọn: <b class="${isCorrect?'text-green-600':'text-red-600'}">${userText}</b> 
                        ${!isCorrect ? `| Đáp án đúng: <b class="text-green-600">${q.type==='mc'?String.fromCharCode(65+q.correct):q.answer}</b>` : ''}
                    </div>`;
                }

                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-gray-700">Câu ${idx+1}</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">${maxPoint} điểm</span>
                        </div>
                        <div class="text-gray-800 mb-4">${window.formatContent(q.content)}</div>
                        ${q.solution ? `<div class="text-sm text-gray-500 border-l-4 border-blue-200 pl-3 py-1 bg-blue-50/50 italic">${window.formatContent(q.solution)}</div>` : ''}
                    </div>
                    ${answerHtml}
                `;
                container.appendChild(card);
            });
            
            if(window.MathJax) MathJax.typesetPromise([container]).catch(()=>{});
        };

        window.updateTotalScore = () => {
            let total = 0;
            // Tính tổng lại dựa trên các ô nhập điểm (Essay) và điểm tự động (Trắc nghiệm)
            const answers = currentGradingAttempt.answers || {};
            window.questions.forEach((q, idx) => {
                if (q.type === 'essay') {
                    const inp = document.getElementById(`manual-score-${idx}`);
                    if (inp) total += parseFloat(inp.value) || 0;
                } else {
                    // Logic tính điểm cũ cho trắc nghiệm
                    // (Đơn giản hóa: Nếu đúng cộng full điểm câu đó)
                    const u = answers[idx];
                    let isCorrect = false;
                    if (q.type === 'mc' && u === q.correct) isCorrect = true;
                    else if (q.type === 'short' && q.answer && String(u).trim().toLowerCase() === String(q.answer).trim().toLowerCase()) isCorrect = true;
                    // (Thêm logic TF nếu cần)
                    
                    if (isCorrect) total += (parseFloat(q.point) || 0);
                }
            });
            
            document.getElementById('gradingTotalScore').textContent = parseFloat(total.toFixed(2));
        };

        window.saveGradingResult = async () => {
            if (!currentGradingAttempt || !currentGradingAttempt.id) return window.customAlert("Lỗi dữ liệu bài thi!", "error");
            
            const newScore = parseFloat(document.getElementById('gradingTotalScore').textContent);
            const btn = document.querySelector('#gradingModal button[onclick="saveGradingResult()"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...'; btn.disabled = true;

            try {
                // Cập nhật điểm mới vào Firestore
                await updateDoc(doc(db, "results", currentGradingAttempt.id), {
                    score: newScore,
                    gradedAt: new Date().toISOString(),
                    graderId: currentUser.uid // Lưu người chấm
                });
                
                // Cập nhật lại statsMap cục bộ để không cần reload trang
                if (currentGradingAttempt) {
                    currentGradingAttempt.score = newScore;
                    // Tìm và update trong mảng attempts của statsMap
                    // (Phần này có thể bỏ qua, chỉ cần reloadStats nếu muốn chắc ăn)
                }
                
                window.showToast("Đã lưu kết quả chấm thi!", "success");
                loadStats(); // Tải lại bảng thống kê
                closeGradingModal();
            } catch (e) {
                console.error(e);
                window.customAlert("Lỗi lưu điểm: " + e.message, "error");
            } finally {
                btn.innerHTML = oldText; btn.disabled = false;
            }
        };
    // ============================================================
        // ĐOẠN MÃ BỔ SUNG (BẮT BUỘC CÓ ĐỂ VẼ VÀ CHẤM)
        // ============================================================

        // ============================================================
        // [FIX] LOGIC CHẤM THI, VẼ CANVAS & CHẤM NHANH
        // ============================================================
        let gradingTool = 'cursor';

        window.setGradingTool = (tool) => {
            gradingTool = tool;
            document.querySelectorAll('.grading-tool-btn').forEach(b => {
                b.classList.remove('bg-blue-100', 'text-blue-600', 'shadow-sm');
                b.classList.add('hover:bg-white', 'text-gray-600');
            });
            const activeBtn = document.querySelector(`button[onclick="setGradingTool('${tool}')"]`);
            if(activeBtn) {
                activeBtn.classList.remove('hover:bg-white', 'text-gray-600');
                activeBtn.classList.add('bg-blue-100', 'text-blue-600', 'shadow-sm');
            }
            // Đổi cursor
            if(tool === 'pen' || tool === 'eraser') document.body.style.cursor = 'crosshair';
            else if(tool.startsWith('mark_')) document.body.style.cursor = 'copy';
            else document.body.style.cursor = 'default';
        };

        window.runAIGrading = () => { window.showToast("Tính năng AI đang được phát triển...", "info"); };

        window.initCanvas = (idx) => {
            const canvas = document.getElementById(`grading-canvas-${idx}`);
            const img = document.getElementById(`essay-img-${idx}`);
            if(!canvas || !img) return;

            // Hàm set kích thước canvas chuẩn theo ảnh hiển thị
            const fitCanvas = () => {
                canvas.width = img.offsetWidth;  // Lấy kích thước hiển thị thực tế
                canvas.height = img.offsetHeight;
            };

            // Đợi ảnh load xong hoặc resize
            if (img.complete) fitCanvas();
            else img.onload = fitCanvas;
            
            // Resize canvas khi cửa sổ thay đổi để không bị lệch nét
            window.addEventListener('resize', fitCanvas);

            const ctx = canvas.getContext('2d');
            let isDown = false;
            let lastX = 0, lastY = 0;

            // Lấy tọa độ chuẩn (kể cả khi scroll)
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const start = (e) => {
                if(gradingTool === 'cursor') return;
                
                // Nếu là cảm ứng hoặc vẽ, chặn scroll màn hình
                if(e.type === 'touchstart' || gradingTool === 'pen') {
                    // e.preventDefault(); // (Có thể bỏ dòng này nếu muốn scroll bằng 2 ngón)
                }

                isDown = true;
                const pos = getPos(e);
                lastX = pos.x; 
                lastY = pos.y;

                // --- LOGIC CHẤM NHANH (1 CLICK) ---
                if (gradingTool === 'mark_correct' || gradingTool === 'mark_wrong') {
                    ctx.lineWidth = 4; 
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    const input = document.getElementById(`manual-score-${idx}`);
                    let currentVal = parseFloat(input ? input.value : 0) || 0;

                    if (gradingTool === 'mark_correct') {
                        // Vẽ dấu V (Xanh)
                        ctx.strokeStyle = '#10B981';
                        ctx.beginPath();
                        ctx.moveTo(lastX - 10, lastY);
                        ctx.lineTo(lastX - 3, lastY + 10); // Đỉnh nhọn
                        ctx.lineTo(lastX + 15, lastY - 15);
                        ctx.stroke();
                        // Cộng điểm (+0.25)
                        if(input) input.value = (currentVal + 0.25).toFixed(2);
                    } else {
                        // Vẽ dấu X (Đỏ)
                        ctx.strokeStyle = '#EF4444';
                        ctx.beginPath();
                        ctx.moveTo(lastX - 10, lastY - 10); ctx.lineTo(lastX + 10, lastY + 10);
                        ctx.moveTo(lastX + 10, lastY - 10); ctx.lineTo(lastX - 10, lastY + 10);
                        ctx.stroke();
                        // Trừ điểm (-0.25)
                        if(input) {
                            let newVal = currentVal - 0.25;
                            input.value = (newVal < 0 ? 0 : newVal).toFixed(2);
                        }
                    }
                    
                    if(window.updateTotalScore) window.updateTotalScore();
                    isDown = false; // Chấm xong nhả ngay
                }
            };

            const move = (e) => {
                if(!isDown) return;
                if(gradingTool === 'cursor' || gradingTool.startsWith('mark_')) return;

                e.preventDefault(); // Chặn scroll khi đang vẽ nét
                const pos = getPos(e);
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                
                // Cấu hình nét vẽ
                const color = document.getElementById('penColor').value;
                ctx.strokeStyle = color;
                
                if(gradingTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 20; // Tẩy to
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.lineWidth = 2; // Nét bút thanh mảnh
                }

                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            };

            const end = () => { isDown = false; };

            // Mouse Events
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseout', end);

            // Touch Events (Mobile/Tablet) - Quan trọng để vẽ trên điện thoại
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('touchend', end);
        };

        // Hàm cập nhật tổng điểm khi chấm nhanh
        window.updateTotalScore = () => {
            let total = 0;
            document.querySelectorAll('input[id^="manual-score-"]').forEach(inp => {
                total += parseFloat(inp.value) || 0;
            });
            // Cộng thêm điểm trắc nghiệm (tự động) nếu có
            // Tạm thời lấy tổng input manual + điểm MC từ attempt (nếu cần logic phức tạp hơn)
            document.getElementById('gradingTotalScore').textContent = parseFloat(total.toFixed(2));
        };

        // [FIX LỖI] Hàm Lưu Kết Quả
        window.saveGradingResult = async () => {
            if (!currentGradingAttempt || !currentGradingAttempt.id) return window.customAlert("Lỗi dữ liệu bài thi!", "error");
            
            const btn = document.querySelector('#gradingModal button[onclick="saveGradingResult()"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...'; btn.disabled = true;

            try {
                const newScore = parseFloat(document.getElementById('gradingTotalScore').textContent);
                
                // Gọi updateDoc (đã được import ở bước 1)
                await updateDoc(doc(db, "results", currentGradingAttempt.id), {
                    score: newScore,
                    gradedAt: new Date().toISOString(),
                    graderId: currentUser.uid 
                });
                
                window.showToast("Đã lưu kết quả chấm thi!", "success");
                
                // Refresh lại bảng thống kê
                if(window.loadStats) window.loadStats(); 
                window.closeGradingModal();

            } catch (e) {
                console.error(e);
                window.customAlert("Lỗi lưu điểm: " + e.message, "error");
            } finally {
                btn.innerHTML = oldText; btn.disabled = false;
            }
        };
    // --- HÀM DUYỆT YÊU CẦU LÀM LẠI ---
        // --- HÀM DUYỆT YÊU CẦU LÀM LẠI ---
        window.approveReattempt = async (studentId, requestId, studentName) => {
            const confirmMsg = requestId 
                ? `Đồng ý cho ${studentName} làm lại bài?\nKết quả cũ sẽ bị XÓA VĨNH VIỄN.`
                : `Cảnh báo: Cấp quyền thủ công cho ${studentName}.\nBài làm cũ sẽ bị XÓA. Tiếp tục?`;

            if (await window.customConfirm(confirmMsg)) {
                try {
                    window.showToast("Đang xử lý...", "info");
                    
                    // 1. Xóa tất cả kết quả thi cũ của học sinh này
                    const qRes = query(collection(db, "results"), where("examId", "==", currentExamId), where("studentId", "==", studentId));
                    const snapRes = await getDocs(qRes);
                    
                    const deletePromises = snapRes.docs.map(d => deleteDoc(d.ref));
                    await Promise.all(deletePromises);

                    // 2. Xóa yêu cầu (nếu có)
                    if (requestId) {
                        await deleteDoc(doc(db, "access_requests", requestId));
                    } else {
                        // Quét sạch request treo nếu duyệt thủ công
                        const qReq = query(collection(db, "access_requests"), where("examId", "==", currentExamId), where("studentId", "==", studentId));
                        const snapReq = await getDocs(qReq);
                        snapReq.docs.forEach(async d => await deleteDoc(d.ref));
                    }

                    window.showToast(`Đã cấp quyền cho ${studentName}`, "success");
                    loadStats(); // Tải lại bảng
                } catch (e) {
                    console.error(e);
                    window.customAlert("Lỗi: " + e.message, "error");
                }
            }
        };

        // --- HÀM TỪ CHỐI YÊU CẦU ---
        window.denyReattempt = async (requestId, studentName) => {
            if (await window.customConfirm(`Từ chối yêu cầu của ${studentName}?`)) {
                try {
                    await deleteDoc(doc(db, "access_requests", requestId));
                    window.showToast("Đã từ chối yêu cầu.", "info");
                    loadStats();
                } catch (e) {
                    console.error(e);
                    window.showToast("Lỗi: " + e.message, "error");
                }
            }
        };
        // ============================================================
    </script>
    <div id="missingImagesPanel" class="hidden fixed bottom-4 right-4 z-50 bg-white border-2 border-orange-500 shadow-2xl rounded-xl w-64 overflow-hidden flex flex-col max-h-[60vh]">
        <div class="bg-orange-500 text-white p-3 flex justify-between items-center shadow-sm">
            <h4 class="font-bold text-sm"><i class="fa-solid fa-images mr-2"></i>Ảnh cần chèn (<span id="missingCountDisplay">0</span>)</h4>
            <button onclick="document.getElementById('missingImagesPanel').classList.add('hidden')" class="hover:text-gray-200"><i class="fa-solid fa-minus"></i></button>
        </div>
        <div class="p-3 bg-gray-50 overflow-y-auto flex-1">
            <div id="missingImagesGrid" class="grid grid-cols-4 gap-2"></div>
        </div>
        <div class="p-2 bg-white text-[10px] text-center text-gray-400 border-t">
            Bấm vào số để đến vị trí ảnh
        </div>
    </div>
    <div id="importModeModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[150] flex items-center justify-center bg-gray-900 bg-opacity-70 px-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fa-brands fa-searchengin"></i></div>
                <h3 class="text-xl font-black text-gray-800 mb-2">Phát hiện <span id="detectTikzCount" class="text-blue-600">0</span> hình TikZ</h3>
                <p class="text-gray-500 mb-6 text-sm">Hệ thống phát hiện mã nguồn hình vẽ trong file LaTeX.<br>Bạn muốn xử lý chúng như thế nào?</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="handleAutoCompileAll()" class="group relative p-4 border-2 border-green-500 bg-green-50 rounded-xl hover:bg-green-100 transition-all text-left">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-xs"><i class="fa-solid fa-bolt"></i></span>
                            <span class="font-bold text-green-700">Tự động (VPS)</span>
                        </div>
                        <p class="text-xs text-gray-600">Gửi sang VPS vẽ và tự động chèn ảnh vào đề.</p>
                        <span class="absolute top-2 right-2 text-[10px] bg-green-200 text-green-800 px-1.5 py-0.5 rounded font-bold">Mới</span>
                    </button>
                    <button onclick="handleManualImport()" class="p-4 border-2 border-gray-200 hover:border-blue-400 bg-white hover:bg-blue-50 rounded-xl transition-all text-left">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold text-xs"><i class="fa-regular fa-hand-point-up"></i></span>
                            <span class="font-bold text-gray-700">Thủ công</span>
                        </div>
                        <p class="text-xs text-gray-500">Giữ nguyên ô chờ. Bạn tự tải ảnh lên sau.</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="progressModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[160] flex items-center justify-center bg-gray-900 bg-opacity-80 px-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 text-center">
            <div class="mb-4"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i></div>
            <h3 class="font-bold text-gray-800 text-lg mb-1">Đang biên dịch hình vẽ...</h3>
            <p class="text-gray-500 text-sm mb-4">Vui lòng giữ nguyên kết nối.</p>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2 overflow-hidden">
                <div id="compileProgressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs font-bold text-gray-600">
                <span id="compileProgressText">0/0</span><span id="compilePercent">0%</span>
            </div>
        </div>
    </div>
    <div id="gradingModal" class="fixed inset-0 z-[120] bg-gray-900 bg-opacity-95 hidden flex flex-col transition-opacity duration-300 opacity-0">
        <div class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-4 shrink-0 shadow-md z-20">
            <div class="flex items-center gap-4">
                <button onclick="closeGradingModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left"></i></button>
                <div>
                    <h3 class="font-bold text-gray-800 text-lg leading-tight" id="gradingStudentName">Tên học sinh</h3>
                    <p class="text-xs text-gray-500">Đang chấm: <span id="gradingAttemptNum">--</span></p>
                </div>
            </div>

            <div id="gradingToolbar" class="flex items-center gap-3">
                <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg border">
                    <button onclick="setGradingTool('cursor')" class="grading-tool-btn p-1.5 rounded bg-white shadow-sm text-blue-600" title="Di chuyển"><i class="fa-solid fa-arrow-pointer"></i></button>
                    <button onclick="setGradingTool('pen')" class="grading-tool-btn p-1.5 rounded hover:bg-white text-gray-600" title="Bút viết"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="setGradingTool('eraser')" class="grading-tool-btn p-1.5 rounded hover:bg-white text-gray-600" title="Tẩy"><i class="fa-solid fa-eraser"></i></button>
                    <div class="w-[1px] h-4 bg-gray-300 mx-1"></div>
                    <input type="color" id="penColor" value="#ff0000" class="w-6 h-6 border-0 p-0 rounded cursor-pointer">
                </div>

                <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg border hidden md:flex">
                    <button onclick="setGradingTool('mark_correct')" class="grading-tool-btn p-1.5 rounded hover:bg-green-100 text-green-600" title="Đúng (Click để chấm)"><i class="fa-solid fa-check"></i></button>
                    <button onclick="setGradingTool('mark_wrong')" class="grading-tool-btn p-1.5 rounded hover:bg-red-100 text-red-600" title="Sai (Click để chấm)"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <button onclick="runAIGrading()" class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg text-xs font-bold shadow hover:opacity-90 flex items-center gap-1">
                    <i class="fa-solid fa-robot"></i> <span class="hidden md:inline">Chấm AI</span>
                </button>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p class="text-xs text-gray-500 uppercase font-bold">Tổng điểm</p>
                    <p class="text-2xl font-black text-blue-600" id="gradingTotalScore">0.0</p>
                </div>
                <button onclick="saveGradingResult()" class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> Lưu
                </button>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden bg-gray-100 relative">
            <div class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col hidden lg:flex">
                <div class="p-4 font-bold text-gray-600 text-sm uppercase border-b bg-gray-100">Danh sách câu hỏi</div>
                <div class="flex-1 overflow-y-auto p-3 space-y-2" id="gradingNavList"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 flex justify-center" id="gradingWorkspace">
                <div class="max-w-4xl w-full space-y-6" id="gradingQuestionList"></div>
            </div>
        </div>
    </div>
</body>
</html>
