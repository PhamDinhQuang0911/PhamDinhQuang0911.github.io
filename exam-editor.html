<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản lý đề thi - Toán thầy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8F9FA; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        .sidebar-item.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 700; border-right: 3px solid #1D4ED8; }
        
        /* Preview Item Styles */
        .preview-item { transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
        .preview-item:hover { background-color: #F3F4F6; }
        .preview-item.active { border-color: #3B82F6; background-color: #EFF6FF; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* MathJax Fix */
        mjx-container { overflow-x: auto; overflow-y: hidden; max-width: 100%; display: inline-block !important; margin: 0 2px !important; }
        mjx-container[display="true"] { display: block !important; }

        /* Form & Scrollbar */
        .form-input { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; outline: none; transition: all 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: #3B82F6; ring: 2px solid #DBEAFE; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { backdrop-filter: blur(2px); }
        .modal { transition: opacity 0.2s ease; }
        .modal.opacity-0 { pointer-events: none; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <div id="sidebarOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass transition-opacity"></div>

    <aside id="mainSidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex flex-col z-40 shadow-xl transition-transform duration-300 -translate-x-full md:relative md:translate-x-0 flex-shrink-0">
        <div class="p-5 border-b border-gray-100 relative">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm shrink-0"><i class="fa-regular fa-file-lines"></i></div>
                <div class="flex-1 overflow-hidden">
                    <h3 id="sidebarExamTitle" class="font-bold text-gray-800 truncate text-sm" title="Tên đề thi">Đề thi mới</h3>
                    <p class="text-xs text-orange-500 font-bold" id="examStatus">• Bản nháp</p>
                </div>
            </div>
            <button onclick="window.toggleSidebar()" class="md:hidden absolute top-5 right-5 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Cấu hình</div>
            <ul class="space-y-1 mb-6">
                <li><button onclick="switchView('settings'); window.toggleSidebar()" id="menu-settings" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-sliders w-5"></i> Cài đặt & Cấu hình</button></li>
                <li><button onclick="switchView('editor'); window.toggleSidebar()" id="menu-editor" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-list-check w-5"></i> Nội dung câu hỏi</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <button onclick="window.location.href='dashboard.html?view=exambank'" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-arrow-right-from-bracket"></i> Quay lại</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative w-full">
        <div class="md:hidden h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.toggleSidebar()" class="text-gray-600 hover:text-blue-600 text-xl p-1"><i class="fa-solid fa-bars"></i></button>
                <span class="font-bold text-gray-800 text-sm truncate max-w-[200px]" id="mobileHeaderTitle">Cài đặt đề thi</span>
            </div>
        </div>

        <div id="view-settings" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 sticky top-0 bg-gray-50 py-2 z-10">
                    <div class="hidden md:block">
                        <h1 class="text-2xl font-bold text-gray-800">Cài đặt đề thi</h1>
                        <p class="text-sm text-gray-500">Thiết lập thông tin và bảo mật.</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="saveExam('draft')" id="btnSaveDraft" class="flex-1 md:flex-none justify-center px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl text-sm flex items-center gap-2"><i class="fa-regular fa-floppy-disk"></i> Lưu nháp</button>
                        <button onclick="saveExam('published')" id="btnPublish" class="flex-1 md:flex-none justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 text-sm flex items-center gap-2"><i class="fa-solid fa-rocket"></i> Xuất bản</button>
                    </div>
                </div>

                <div id="publishedLinkArea" class="hidden bg-green-50 p-4 rounded-xl border border-green-200 mb-6">
                    <label class="block text-xs font-bold text-green-700 uppercase mb-2">Link bài thi (Đã xuất bản)</label>
                    <div class="flex gap-2">
                        <input type="text" id="settingShareLink" class="w-full px-3 py-2 border border-green-300 rounded-lg text-green-800 bg-white focus:outline-none text-sm font-mono" readonly>
                        <button onclick="copySettingLink()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors text-sm">Copy</button>
                        <button onclick="window.open(document.getElementById('settingShareLink').value, '_blank')" class="px-4 py-2 bg-white border border-green-300 text-green-600 font-bold rounded-lg hover:bg-green-50 text-sm"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                    </div>
                </div>

                <div class="space-y-4 md:space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-info-circle text-blue-600 mr-2"></i> Cấu hình chung</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2"><label class="form-group-title">Tên đề thi <span class="text-red-500">*</span></label><input type="text" id="settingTitle" class="form-input font-bold" placeholder="VD: Kiểm tra 15 phút"></div>
                            <div><label class="form-group-title">Khối lớp</label><select id="settingGrade" class="form-input bg-white"><option value="12">Khối 12</option><option value="11">Khối 11</option><option value="10">Khối 10</option><option value="9">Khối 9</option></select></div>
                            <div><label class="form-group-title">Môn học</label><select id="settingSubject" class="form-input bg-white"><option>Toán học</option><option>Vật lý</option><option>Hóa học</option><option>Tiếng Anh</option></select></div>
                            <div><label class="form-group-title">Thời gian (phút)</label><input type="number" id="settingDuration" value="45" class="form-input"></div>
                            <div><label class="form-group-title">Mục đích</label><select id="settingPurpose" class="form-input bg-white"><option value="exam">Thi / Kiểm tra</option><option value="practice">Luyện tập</option></select></div>
                            <div class="col-span-1 md:col-span-2 pt-2 border-t border-dashed"><label class="form-group-title block mb-2">Thời gian mở đề (Tùy chọn)</label><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><span class="text-xs text-gray-500">Từ:</span><input type="datetime-local" id="settingStartTime" class="form-input"></div><div><span class="text-xs text-gray-500">Đến:</span><input type="datetime-local" id="settingEndTime" class="form-input"></div></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-shield-halved text-red-600 mr-2"></i> Bảo mật</h3>
                            <div class="space-y-3">
                                <div><label class="form-group-title">Mật khẩu</label><input type="text" id="settingPassword" placeholder="Không bắt buộc" class="form-input"></div>
                                <div><label class="form-group-title">Số lượt làm</label><input type="number" id="settingAttempts" value="1" class="form-input"></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Giám sát tự động</span><input type="checkbox" id="settingProctoring" class="toggle-checkbox w-5 h-5"></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Đảo câu hỏi</span><input type="checkbox" id="settingShuffle" checked class="toggle-checkbox w-5 h-5"></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-square-poll-vertical text-green-600 mr-2"></i> Kết quả</h3>
                            <div class="space-y-4">
                                <div><label class="form-group-title">Xem điểm</label><div class="grid grid-cols-3 gap-2 text-xs"><label><input type="radio" name="settingShowScore" value="immediate" checked> Ngay</label><label><input type="radio" name="settingShowScore" value="after_exam"> Hết giờ</label><label><input type="radio" name="settingShowScore" value="never"> Không</label></div></div>
                                <div><label class="form-group-title">Xem đáp án</label><div class="grid grid-cols-3 gap-2 text-xs"><label><input type="radio" name="settingShowResult" value="immediate" checked> Ngay</label><label><input type="radio" name="settingShowResult" value="after_exam"> Hết giờ</label><label><input type="radio" name="settingShowResult" value="never"> Không</label></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-users text-purple-600 mr-2"></i> Đối tượng</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('public')"><input type="radio" name="settingAccess" value="public" checked> <div><div class="font-bold text-sm">Công khai</div><div class="text-xs text-gray-500">Ai cũng có thể làm</div></div></label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('class')"><input type="radio" name="settingAccess" value="class"> <div><div class="font-bold text-sm">Lớp học</div><div class="text-xs text-gray-500">Chỉ lớp được chọn</div></div></label>
                            <div id="classSelectionArea" class="hidden pl-6"><select id="settingClassSelect" class="form-input bg-white border-blue-300 font-bold text-blue-800"><option value="">-- Chọn lớp --</option></select></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-editor" class="hidden flex-1 h-full flex flex-col md:flex-row relative bg-gray-100">
            <div class="w-full md:w-1/2 lg:w-5/12 h-1/2 md:h-full flex flex-col border-r border-gray-200 bg-white z-10">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-list-ol mr-2"></i>Danh sách câu hỏi (<span id="totalQCount">0</span>)</h3>
                    <div class="flex gap-2">
                        <button onclick="openScoringModal()" class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-200"><i class="fa-solid fa-calculator mr-1"></i> Chia điểm</button>
                        <button onclick="document.getElementById('texInput').click()" class="px-3 py-1.5 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200"><i class="fa-solid fa-file-import mr-1"></i> Import Tex</button>
                        <input type="file" id="texInput" accept=".tex,.txt" class="hidden" onchange="handleTexUpload(this)">
                    </div>
                </div>
                <div id="previewList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                    <div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.<br>Hãy thêm câu hỏi hoặc Import Tex.</div>
                </div>
            </div>

            <div class="w-full md:w-1/2 lg:w-7/12 h-1/2 md:h-full flex flex-col bg-white">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-pen-to-square mr-2 text-blue-600"></i>Chỉnh sửa câu hỏi</h3>
                    <div class="flex gap-2">
                        <button onclick="addNewQuestion('mc')" class="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-xs font-bold" title="Thêm Trắc nghiệm">+TN</button>
                        <button onclick="addNewQuestion('tf')" class="p-1.5 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 text-xs font-bold" title="Thêm Đúng/Sai">+ĐS</button>
                        <button onclick="addNewQuestion('short')" class="p-1.5 bg-green-50 text-green-600 rounded hover:bg-green-100 text-xs font-bold" title="Thêm Điền khuyết">+Điền</button>
                        <button onclick="addNewQuestion('essay')" class="p-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 text-xs font-bold" title="Thêm Tự luận">+TL</button>
                        <div class="w-[1px] h-6 bg-gray-200 mx-1"></div>
                        <button onclick="deleteCurrentQuestion()" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <div id="editorArea" class="flex-1 overflow-y-auto p-4 md:p-6 bg-white relative">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm">
                        <p>Chọn câu hỏi bên trái để sửa</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="scoringModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="font-bold text-yellow-800"><i class="fa-solid fa-calculator mr-2"></i>Cấu hình điểm số</h3>
                <button onclick="closeScoringModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Trắc nghiệm + Điền từ</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countMcShort">0</b></span></div>
                        <input type="number" id="scoreTotalMcShort" class="form-input text-right font-bold text-blue-600" placeholder="Tổng điểm nhóm này">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Đúng / Sai</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countTF">0</b></span></div>
                        <input type="number" id="scoreTotalTF" class="form-input text-right font-bold text-orange-600" placeholder="Tổng điểm nhóm này">
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Chi tiết Tự luận (<span id="countEssay">0</span> câu)</h4>
                    <div id="essayScoreList" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-xs text-gray-400 italic">Không có câu tự luận nào.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50 rounded-b-xl">
                <button onclick="closeScoringModal()" class="px-4 py-2 bg-white border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-100">Hủy</button>
                <button onclick="applyScoring()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Áp dụng chia điểm</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        
        let currentUser = null, currentExamId = null;
        window.questions = []; // SINGLE SOURCE OF TRUTH
        window.currentQIndex = -1;

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadTeacherClasses();
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('id');
                if (examId) { currentExamId = examId; loadExamData(examId); }
            } else { window.location.href = 'index.html'; }
        });

        // --- CORE FUNCTIONS: EXAM DATA ---
        window.loadExamData = async (id) => {
            try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Fill Settings
                    document.getElementById('settingTitle').value = data.title || '';
                    document.getElementById('settingGrade').value = data.grade || '12';
                    document.getElementById('settingSubject').value = data.subject || 'Toán học';
                    document.getElementById('settingDuration').value = data.duration || 45;
                    document.getElementById('settingPurpose').value = data.purpose || 'exam';
                    document.getElementById('settingStartTime').value = data.startTime || '';
                    document.getElementById('settingEndTime').value = data.endTime || '';
                    document.getElementById('settingPassword').value = data.password || '';
                    document.getElementById('settingAttempts').value = data.attempts || 1;
                    document.getElementById('settingProctoring').checked = data.proctoring || false;
                    document.getElementById('settingShuffle').checked = data.shuffle !== false;
                    if(data.showScore) document.querySelector(`input[name="settingShowScore"][value="${data.showScore}"]`).checked = true;
                    if(data.showResult) document.querySelector(`input[name="settingShowResult"][value="${data.showResult}"]`).checked = true;
                    if(data.accessType) {
                        document.querySelector(`input[name="settingAccess"][value="${data.accessType}"]`).checked = true;
                        window.togglePrivasySettings(data.accessType);
                    }
                    if(data.allowedClassId) setTimeout(() => document.getElementById('settingClassSelect').value = data.allowedClassId, 500);
                    
                    document.getElementById('sidebarExamTitle').textContent = data.title;
                    if(data.status === 'published') {
                        document.getElementById('examStatus').textContent = '• Đã xuất bản';
                        document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                        // NEW: Show Link Area
                        document.getElementById('publishedLinkArea').classList.remove('hidden');
                        const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + id;
                        document.getElementById('settingShareLink').value = link;
                    }

                    // Load Questions
                    window.questions = data.questions || [];
                    renderPreviewList();
                    if(window.questions.length > 0) loadQuestionToEditor(0);
                }
            } catch(e) { console.error(e); }
        };

        // --- CORE FUNCTIONS: EDITOR LOGIC (SPLIT VIEW) ---
        window.renderPreviewList = () => {
            const list = document.getElementById('previewList');
            document.getElementById('totalQCount').textContent = window.questions.length;
            list.innerHTML = '';
            
            if (window.questions.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.<br>Hãy thêm câu hỏi hoặc Import Tex.</div>';
                document.getElementById('editorArea').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>';
                window.currentQIndex = -1;
                return;
            }

            window.questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = `preview-item p-3 rounded-lg mb-2 text-sm text-gray-700 ${idx === window.currentQIndex ? 'active' : ''}`;
                div.onclick = () => loadQuestionToEditor(idx);
                
                // Safe content render
                let contentPreview = q.content ? q.content.substring(0, 100) : 'Trống';
                // Replace formatting for preview text only if needed, but MathJax handles the raw string best.
                
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-xs uppercase text-blue-600">Câu ${idx + 1} (${q.type.toUpperCase()})</span>
                        <span class="text-xs font-bold text-orange-500 bg-orange-50 px-1.5 rounded">${q.point || 0}đ</span>
                    </div>
                    <div class="line-clamp-3 overflow-hidden text-xs">${q.content}</div>
                `;
                list.appendChild(div);
            });
            if(window.MathJax) MathJax.typesetPromise([list]).catch(e=>{});
        };

        window.loadQuestionToEditor = (index) => {
            // Save current before switching (if valid)
            if (window.currentQIndex !== -1 && window.currentQIndex !== index) saveCurrentQuestionToMemory();
            
            window.currentQIndex = index;
            renderPreviewList(); // Update active state
            
            const q = window.questions[index];
            const editor = document.getElementById('editorArea');
            let html = `<div class="mb-4"><label class="form-group-title">Nội dung câu hỏi</label><textarea id="editContent" class="form-input min-h-[120px]" oninput="autoSaveMemory()">${q.content || ''}</textarea></div>`;
            
            if (q.type === 'mc') {
                html += `<div class="grid grid-cols-1 gap-3 mb-4">`;
                const opts = q.options || ["", "", "", ""];
                const labels = ["A", "B", "C", "D"];
                opts.forEach((opt, i) => {
                    html += `<div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full border flex items-center justify-center font-bold text-gray-500 bg-gray-50 cursor-pointer hover:bg-blue-100 ${q.correct === i ? 'bg-blue-600 text-white border-blue-600' : ''}" onclick="setCorrectMC(${i})">${labels[i]}</div><input type="text" class="form-input mc-option" value="${opt}" placeholder="Phương án ${labels[i]}" oninput="autoSaveMemory()"></div>`;
                });
                html += `</div>`;
            } else if (q.type === 'tf') {
                html += `<div class="space-y-2 mb-4">`;
                const stmts = q.statements || [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}];
                stmts.forEach((s, i) => {
                    html += `<div class="flex items-center gap-2 border p-2 rounded"><span class="font-bold text-xs text-gray-400 w-4">${i+1}</span><input type="text" class="form-input tf-text" value="${s.text}" placeholder="Mệnh đề ${i+1}" oninput="autoSaveMemory()"><label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="w-4 h-4 tf-check" ${s.isTrue?'checked':''} onchange="autoSaveMemory()"><span class="text-xs font-bold ${s.isTrue?'text-green-600':'text-gray-400'}">Đúng</span></label></div>`;
                });
                html += `</div>`;
            } else if (q.type === 'short') {
                html += `<div class="mb-4"><label class="form-group-title">Đáp án mẫu</label><input type="text" id="editShortAns" class="form-input font-bold text-green-700" value="${q.answer || ''}" placeholder="Nhập đáp án chính xác" oninput="autoSaveMemory()"></div>`;
            } else if (q.type === 'essay') {
                html += `<div class="p-3 bg-purple-50 text-purple-700 text-xs rounded mb-4">Câu tự luận sẽ được chấm thủ công bởi giáo viên.</div>`;
            }

            html += `<div class="mb-4"><label class="form-group-title">Lời giải chi tiết</label><textarea id="editSolution" class="form-input min-h-[80px]" placeholder="Nhập lời giải..." oninput="autoSaveMemory()">${q.solution || ''}</textarea></div>`;
            html += `<div class="mb-4 w-1/3"><label class="form-group-title">Điểm số</label><input type="number" id="editPoint" class="form-input font-bold text-orange-600" value="${q.point || 0}" step="0.1" oninput="autoSaveMemory()"></div>`;
            
            editor.innerHTML = html;
        };

        window.addNewQuestion = (type) => {
            if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();
            const newQ = { type: type, content: "", solution: "", point: 0 };
            if (type === 'mc') { newQ.options = ["", "", "", ""]; newQ.correct = -1; }
            if (type === 'tf') { newQ.statements = [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}]; }
            if (type === 'short') { newQ.answer = ""; }
            window.questions.push(newQ);
            renderPreviewList();
            loadQuestionToEditor(window.questions.length - 1);
            // Scroll preview to bottom
            const list = document.getElementById('previewList'); list.scrollTop = list.scrollHeight;
        };

        window.saveCurrentQuestionToMemory = () => {
            if (window.currentQIndex === -1 || !window.questions[window.currentQIndex]) return;
            const q = window.questions[window.currentQIndex];
            
            const contentEl = document.getElementById('editContent');
            if(contentEl) q.content = contentEl.value;
            
            const solEl = document.getElementById('editSolution');
            if(solEl) q.solution = solEl.value;

            const pointEl = document.getElementById('editPoint');
            if(pointEl) q.point = parseFloat(pointEl.value) || 0;

            if (q.type === 'mc') {
                const optInputs = document.querySelectorAll('.mc-option');
                q.options = Array.from(optInputs).map(i => i.value);
            } else if (q.type === 'tf') {
                const rows = document.querySelectorAll('#editorArea .flex.items-center.border');
                q.statements = [];
                rows.forEach(row => {
                    const text = row.querySelector('.tf-text').value;
                    const isTrue = row.querySelector('.tf-check').checked;
                    q.statements.push({text, isTrue});
                });
            } else if (q.type === 'short') {
                const ansEl = document.getElementById('editShortAns');
                if(ansEl) q.answer = ansEl.value;
            }
        };

        window.autoSaveMemory = () => {
            // Debounce or just save directly (lightweight)
            saveCurrentQuestionToMemory();
            // Optional: Update Preview Text Only (don't re-render whole list to keep focus)
        };

        window.setCorrectMC = (idx) => {
            window.questions[window.currentQIndex].correct = idx;
            loadQuestionToEditor(window.currentQIndex); // Re-render to show active state
        };

        window.deleteCurrentQuestion = async () => {
            if (window.currentQIndex === -1) return;
            if(confirm("Xóa câu hỏi này?")) {
                window.questions.splice(window.currentQIndex, 1);
                window.currentQIndex = -1;
                renderPreviewList();
                document.getElementById('editorArea').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>';
            }
        };

        // --- NEW: CLEAN LATEX IMPORT ---
        function cleanLatex(text) {
            if (!text) return "";
            // 1. Xóa comments (dòng bắt đầu bằng %)
            let cleaned = text.replace(/^%.*$/gm, '');
            // 2. Xóa comments inline (%...) nhưng phải cẩn thận với \% (ký tự phần trăm)
            // Regex: Tìm % không đi sau \
            cleaned = cleaned.replace(/(?<!\\)%.*/g, '');
            // 3. Xóa ID câu hỏi dạng [9D1...] thường thấy sau \begin{ex}
            // Cách đơn giản: Xóa mọi thứ trong [...] ngay đầu dòng hoặc đầu câu
            cleaned = cleaned.replace(/^\s*\[.*?\]/gm, '');
            return cleaned.trim();
        }

        window.handleTexUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { 
                if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();
                const content = e.target.result;
                // Basic block regex for extest
                const blockRegex = /\\begin\{(ex|bt|vd)\}([\s\S]*?)\\end\{\1\}/g;
                let match;
                let count = 0;
                while ((match = blockRegex.exec(content)) !== null) {
                    let fullBody = match[2];
                    
                    // CLEAN ID TAGS IN BODY if they exist right at start
                    fullBody = fullBody.replace(/^\s*\[.*?\]/, ''); 

                    let qType = 'essay'; 
                    let qData = { content: '', solution: '', options: [], statements: [], answer: '', point: 0 };

                    const loigiaiIndex = fullBody.lastIndexOf('\\loigiai');
                    let mainContent = fullBody;
                    if (loigiaiIndex !== -1) {
                        const afterLoigiai = fullBody.substring(loigiaiIndex);
                        // Extract content inside {} of loigiai
                        const braceContent = extractBracedContent(afterLoigiai);
                        if (braceContent.length > 0) qData.solution = cleanLatex(braceContent[0]);
                        mainContent = fullBody.substring(0, loigiaiIndex);
                    }

                    if (mainContent.includes('\\choiceTF')) {
                        qType = 'tf';
                        const parts = mainContent.split('\\choiceTF');
                        qData.content = cleanLatex(parts[0]);
                        const rawStatements = extractBracedContent(parts[1]);
                        rawStatements.forEach(stmt => {
                            const isTrue = stmt.includes('\\True');
                            const text = stmt.replace('\\True', '').trim();
                            qData.statements.push({ text: cleanLatex(text), isTrue: isTrue });
                        });
                    } else if (mainContent.includes('\\choice')) {
                        qType = 'mc';
                        const parts = mainContent.split('\\choice');
                        qData.content = cleanLatex(parts[0]);
                        const rawOptions = extractBracedContent(parts[1]);
                        rawOptions.forEach((opt, idx) => {
                            if (idx < 4) {
                                const isCorrect = opt.includes('\\True');
                                const text = opt.replace('\\True', '').trim();
                                qData.options.push(cleanLatex(text));
                                if (isCorrect) qData.correct = idx;
                            }
                        });
                    } else if (mainContent.includes('\\shortans')) {
                        qType = 'short';
                        const parts = mainContent.split('\\shortans');
                        qData.content = cleanLatex(parts[0]);
                        // Extract answer inside {}
                        const ansMatch = mainContent.match(/\\shortans\{ (.*?) \}/) || mainContent.match(/\\shortans\{(.*?)\}/);
                        if (ansMatch) qData.answer = cleanLatex(ansMatch[1]);
                        else {
                             // Fallback manual extract
                             const ansContent = extractBracedContent(mainContent.substring(mainContent.indexOf('\\shortans')));
                             if(ansContent.length>0) qData.answer = cleanLatex(ansContent[0]);
                        }
                    } else {
                        qType = 'essay';
                        qData.content = cleanLatex(mainContent);
                    }
                    // Final clean of content
                    qData.content = cleanLatex(qData.content);
                    window.questions.push({ type: qType, ...qData });
                    count++;
                }
                renderPreviewList();
                window.showToast(`Đã nhập ${count} câu hỏi!`);
                input.value = "";
            };
            reader.readAsText(file);
        }

        // --- NEW: SCORING LOGIC ---
        window.openScoringModal = () => {
            const modal = document.getElementById('scoringModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');

            // Count questions
            let cMcShort = 0, cTF = 0, cEssay = 0;
            let essayHtml = '';
            window.questions.forEach((q, idx) => {
                if (q.type === 'mc' || q.type === 'short') cMcShort++;
                else if (q.type === 'tf') cTF++;
                else if (q.type === 'essay') {
                    cEssay++;
                    essayHtml += `<div class="flex items-center gap-2 text-sm"><span class="w-16 font-bold text-gray-500">Câu ${idx+1}</span><input type="number" id="essay-score-${idx}" class="form-input h-8 text-right w-20" value="${q.point||0}" step="0.1"> <span class="text-xs text-gray-400">điểm</span></div>`;
                }
            });

            document.getElementById('countMcShort').textContent = cMcShort;
            document.getElementById('countTF').textContent = cTF;
            document.getElementById('countEssay').textContent = cEssay;
            
            if(cEssay > 0) document.getElementById('essayScoreList').innerHTML = essayHtml;
            else document.getElementById('essayScoreList').innerHTML = '<p class="text-xs text-gray-400 italic">Không có câu tự luận nào.</p>';
        };

        window.closeScoringModal = () => {
            const modal = document.getElementById('scoringModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        window.applyScoring = () => {
            const totalMcShort = parseFloat(document.getElementById('scoreTotalMcShort').value) || 0;
            const totalTF = parseFloat(document.getElementById('scoreTotalTF').value) || 0;
            
            let cMcShort = 0, cTF = 0;
            window.questions.forEach(q => { if(q.type === 'mc' || q.type === 'short') cMcShort++; else if(q.type === 'tf') cTF++; });

            const pointPerMcShort = cMcShort > 0 ? (totalMcShort / cMcShort) : 0;
            const pointPerTF = cTF > 0 ? (totalTF / cTF) : 0;

            window.questions.forEach((q, idx) => {
                if (q.type === 'mc' || q.type === 'short') {
                    q.point = parseFloat(pointPerMcShort.toFixed(2));
                } else if (q.type === 'tf') {
                    q.point = parseFloat(pointPerTF.toFixed(2));
                } else if (q.type === 'essay') {
                    const inp = document.getElementById(`essay-score-${idx}`);
                    if(inp) q.point = parseFloat(inp.value) || 0;
                }
            });

            closeScoringModal();
            renderPreviewList();
            window.showToast("Đã chia điểm thành công!");
        };

        // --- SAVE EXAM ---
        window.saveExam = async function(status) {
            // Save current editor state first
            if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();

            const title = document.getElementById('settingTitle').value;
            if(!title) return alert("Vui lòng nhập tên đề thi!");

            const accessType = document.querySelector('input[name="settingAccess"]:checked').value;
            const allowedClassId = document.getElementById('settingClassSelect').value;

            const settings = {
                title: title,
                grade: document.getElementById('settingGrade').value,
                subject: document.getElementById('settingSubject').value,
                duration: parseInt(document.getElementById('settingDuration').value) || 0,
                purpose: document.getElementById('settingPurpose').value,
                startTime: document.getElementById('settingStartTime').value,
                endTime: document.getElementById('settingEndTime').value,
                password: document.getElementById('settingPassword').value,
                attempts: parseInt(document.getElementById('settingAttempts').value) || 0,
                proctoring: document.getElementById('settingProctoring').checked,
                shuffle: document.getElementById('settingShuffle').checked,
                showScore: document.querySelector('input[name="settingShowScore"]:checked').value,
                showResult: document.querySelector('input[name="settingShowResult"]:checked').value,
                accessType: accessType,
                allowedClassId: accessType === 'class' ? allowedClassId : null
            };

            const btn = status === 'published' ? document.getElementById('btnPublish') : document.getElementById('btnSaveDraft');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...'; btn.disabled = true;

            try {
                const examRef = currentExamId ? doc(db, "exams", currentExamId) : doc(collection(db, "exams"));
                await setDoc(examRef, {
                    ...settings,
                    teacherId: currentUser.uid,
                    questions: window.questions,
                    questionCount: window.questions.length,
                    status: status, 
                    updatedAt: new Date().toISOString(),
                    ...(currentExamId ? {} : { createdAt: new Date().toISOString() })
                }, { merge: true });

                currentExamId = examRef.id;
                document.getElementById('sidebarExamTitle').textContent = title;
                
                if (status === 'published') {
                    const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + currentExamId;
                    document.getElementById('shareLinkInput').value = link;
                    // Update setting tab link area
                    document.getElementById('publishedLinkArea').classList.remove('hidden');
                    document.getElementById('settingShareLink').value = link;
                    document.getElementById('examStatus').textContent = '• Đã xuất bản';
                    document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                    
                    const modal = document.getElementById('shareModal');
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                } else {
                    window.showToast("Đã lưu bản nháp thành công!", "success");
                }
                
                if (!window.location.search.includes('id=')) {
                    const newUrl = window.location.href.split('?')[0] + '?id=' + currentExamId;
                    window.history.pushState({path:newUrl},'',newUrl);
                }
            } catch(e) { console.error(e); alert("Lỗi lưu: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        // --- HELPERS ---
        window.switchView = (viewId) => {
            document.getElementById('view-settings').classList.add('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('flex'); // Important for flex layout
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            if (viewId === 'settings') {
                document.getElementById('view-settings').classList.remove('hidden');
                document.getElementById('menu-settings').classList.add('active');
                if(window.innerWidth < 768) document.getElementById('mobileHeaderTitle').textContent = "Cài đặt đề thi";
            } else if (viewId === 'editor') {
                document.getElementById('view-editor').classList.remove('hidden');
                document.getElementById('view-editor').classList.add('flex');
                document.getElementById('menu-editor').classList.add('active');
                if(window.innerWidth < 768) document.getElementById('mobileHeaderTitle').textContent = "Nội dung câu hỏi";
            }
        }
        
        window.copyLink = () => { const copyText = document.getElementById("shareLinkInput"); copyText.select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); }
        window.copySettingLink = () => { const copyText = document.getElementById("settingShareLink"); copyText.select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); }
        window.closeShareModal = () => { document.getElementById('shareModal').classList.add('opacity-0', 'pointer-events-none'); }
        window.showToast = (message, type='success') => { const container = document.getElementById('toastContainer'); const toast = document.createElement('div'); toast.className = `bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] transform translate-x-full transition-transform duration-300`; toast.innerHTML = `<div><h4 class="font-bold text-gray-800 text-sm">THÔNG BÁO</h4><p class="text-sm text-gray-600">${message}</p></div>`; container.appendChild(toast); requestAnimationFrame(() => toast.classList.remove('translate-x-full')); setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 500); }, 3000); }
        window.togglePrivasySettings = (type) => { const area = document.getElementById('classSelectionArea'); if (type === 'class') area.classList.remove('hidden'); else area.classList.add('hidden'); }
        async function loadTeacherClasses() { const select = document.getElementById('settingClassSelect'); if (!currentUser) return; const q = query(collection(db, "classes"), where("teacherId", "==", currentUser.uid)); const snap = await getDocs(q); select.innerHTML = ''; const defaultOpt = document.createElement('option'); defaultOpt.value = ""; defaultOpt.textContent = "-- Chọn lớp học --"; select.appendChild(defaultOpt); snap.forEach(doc => { const cl = doc.data(); const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = cl.name; select.appendChild(opt); }); }
        window.toggleSidebar = () => { const sidebar = document.getElementById('mainSidebar'); const overlay = document.getElementById('sidebarOverlay'); if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); } }
        
        function extractBracedContent(text) { let results = []; let braceCount = 0; let startIndex = -1; for (let i = 0; i < text.length; i++) { if (text[i] === '{') { if (braceCount === 0) startIndex = i + 1; braceCount++; } else if (text[i] === '}') { braceCount--; if (braceCount === 0 && startIndex !== -1) { results.push(text.substring(startIndex, i)); startIndex = -1; } } } return results; }
    </script>
</body>
</html>
