<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đề thi - Toán thầy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8F9FA; }
        .sidebar-item.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 700; border-right: 3px solid #1D4ED8; }
        .question-card:hover { border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        mjx-container { font-size: 110% !important; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <!-- SIDEBAR (TRÁI) -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-sm flex-shrink-0">
        <div class="p-5 border-b border-gray-100">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                    <i class="fa-regular fa-file-lines"></i>
                </div>
                <div class="flex-1 overflow-hidden">
                    <h3 id="sidebarExamTitle" class="font-bold text-gray-800 truncate text-sm" title="Tên đề thi">Đề thi mới</h3>
                    <p class="text-xs text-orange-500 font-bold" id="examStatus">• Bản nháp</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Cấu hình</div>
            <ul class="space-y-1 mb-6">
                <li>
                    <button onclick="switchView('settings')" id="menu-settings" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm">
                        <i class="fa-solid fa-sliders w-5"></i> Cài đặt chung
                    </button>
                </li>
                <li>
                    <button onclick="switchView('editor')" id="menu-editor" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm">
                        <i class="fa-solid fa-list-check w-5"></i> Nội dung câu hỏi
                    </button>
                </li>
            </ul>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <button onclick="window.location.href='dashboard.html'" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> Quay lại Sảnh chính
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT (PHẢI) -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
        
        <!-- === VIEW 1: CÀI ĐẶT (MẶC ĐỊNH) === -->
        <div id="view-settings" class="flex-1 overflow-y-auto p-8">
            <div class="max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Cài đặt đề thi</h1>
                        <p class="text-sm text-gray-500">Thiết lập thông tin cơ bản và cấu hình phòng thi.</p>
                    </div>
                    <!-- Nút hành động chính -->
                    <div class="flex gap-3">
                        <button onclick="saveExam('draft')" id="btnSaveDraft" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-all flex items-center gap-2 text-sm">
                            <i class="fa-regular fa-floppy-disk"></i> Lưu nháp
                        </button>
                        <button onclick="saveExam('published')" id="btnPublish" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-rocket"></i> Xuất bản
                        </button>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Thông tin cơ bản -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 pb-2 border-b border-gray-100 flex items-center gap-2">
                            <i class="fa-solid fa-circle-info text-blue-500"></i> Thông tin chung
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tên đề thi <span class="text-red-500">*</span></label>
                                <input type="text" id="settingTitle" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-bold text-gray-700" placeholder="VD: Kiểm tra 15 phút Toán đại số">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Môn học</label>
                                <select class="w-full px-4 py-2.5 rounded-xl border border-gray-300 bg-white focus:outline-none focus:border-blue-500">
                                    <option>Toán học</option>
                                    <option>Vật lý</option>
                                    <option>Hóa học</option>
                                    <option>Tiếng Anh</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Thời gian (phút)</label>
                                <input type="number" id="settingDuration" value="45" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW 2: EDITOR (SOẠN THẢO) === -->
        <div id="view-editor" class="flex-1 flex hidden h-full">
            <!-- Khu vực danh sách câu hỏi (Giữa) -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-100 scroll-smooth" id="questionsContainer">
                <div class="max-w-3xl mx-auto pb-24 space-y-4" id="questionsList">
                    <div id="emptyState" class="text-center py-20 text-gray-400 border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm">
                            <i class="fa-regular fa-folder-open text-blue-300"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-600">Chưa có câu hỏi nào</h3>
                        <p class="text-sm mt-1">Chọn loại câu hỏi bên phải để bắt đầu soạn đề.</p>
                    </div>
                </div>
            </div>

            <!-- Toolbar Công cụ (Phải) -->
            <div class="w-72 bg-white border-l border-gray-200 p-5 flex flex-col gap-3 shadow-xl z-10 flex-shrink-0">
                <h3 class="font-bold text-gray-800 text-sm mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle text-blue-600"></i> Thêm câu hỏi
                </h3>
                
                <button onclick="addQuestion('mc')" class="w-full p-3 bg-white border border-gray-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fa-solid fa-list-ul"></i></div>
                    <div><span class="text-sm font-bold text-gray-700 block">Trắc nghiệm</span></div>
                </button>
                <button onclick="addQuestion('essay')" class="w-full p-3 bg-white border border-gray-200 hover:border-purple-500 hover:bg-purple-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-colors"><i class="fa-solid fa-pen-nib"></i></div>
                    <div><span class="text-sm font-bold text-gray-700 block">Tự luận</span></div>
                </button>
                <button onclick="addQuestion('tf')" class="w-full p-3 bg-white border border-gray-200 hover:border-orange-500 hover:bg-orange-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition-colors"><i class="fa-solid fa-check-double"></i></div>
                    <div><span class="text-sm font-bold text-gray-700 block">Đúng / Sai</span></div>
                </button>
                <button onclick="addQuestion('short')" class="w-full p-3 bg-white border border-gray-200 hover:border-green-500 hover:bg-green-50 rounded-xl text-left flex items-center gap-3 transition-all shadow-sm group">
                    <div class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-colors"><i class="fa-solid fa-keyboard"></i></div>
                    <div><span class="text-sm font-bold text-gray-700 block">Trả lời ngắn</span></div>
                </button>

                <div class="border-t border-gray-100 my-2 pt-3">
                    <h3 class="font-bold text-gray-800 text-sm mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-file-import text-green-600"></i> Nhập liệu
                    </h3>
                    <button onclick="document.getElementById('texInput').click()" class="w-full py-2 bg-green-50 text-green-700 border border-green-200 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors flex items-center justify-center gap-2 mb-2">
                        <i class="fa-solid fa-file-arrow-up"></i> Tải file LaTeX
                    </button>
                    <input type="file" id="texInput" accept=".tex,.txt" class="hidden" onchange="handleTexUpload(this)">
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL CHIA SẺ LINK (MỚI) -->
    <div id="shareModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-70">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-green-600 animate-bounce">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">Xuất bản thành công!</h3>
                <p class="text-gray-500">Đề thi đã sẵn sàng. Hãy gửi link dưới đây cho học sinh.</p>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Link bài thi</label>
                <div class="flex gap-2">
                    <input type="text" id="shareLinkInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-600 bg-white focus:outline-none" readonly>
                    <button onclick="copyLink()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">
                        Copy
                    </button>
                </div>
            </div>

            <div class="flex justify-center gap-3">
                <button onclick="window.open(document.getElementById('shareLinkInput').value, '_blank')" class="px-5 py-2.5 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl transition-colors">
                    <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i> Mở thử
                </button>
                <button onclick="closeShareModal()" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-colors">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="tpl-mc">
        <div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group transition-all hover:border-blue-400 mb-6" data-type="mc">
            <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10">
                <button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="mb-3">
                <span class="inline-block px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Trắc nghiệm</span>
                <textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-blue-200 outline-none min-h-[80px] text-gray-700 text-sm" placeholder="Nhập nội dung câu hỏi..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg focus-within:border-blue-400 transition-all">
                    <input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600 cursor-pointer">
                    <input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm ml-1" placeholder="Phương án A">
                </div>
                <div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg focus-within:border-blue-400 transition-all">
                    <input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600 cursor-pointer">
                    <input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm ml-1" placeholder="Phương án B">
                </div>
                <div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg focus-within:border-blue-400 transition-all">
                    <input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600 cursor-pointer">
                    <input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm ml-1" placeholder="Phương án C">
                </div>
                <div class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-lg focus-within:border-blue-400 transition-all">
                    <input type="radio" name="correct-rad-${id}" class="w-4 h-4 text-blue-600 cursor-pointer">
                    <input type="text" class="flex-1 bg-transparent border-0 outline-none text-sm ml-1" placeholder="Phương án D">
                </div>
            </div>
            <input type="text" class="w-full px-3 py-2 text-xs text-gray-500 italic border-b border-dashed border-gray-200 focus:border-blue-300 outline-none bg-transparent" placeholder="Nhập lời giải chi tiết (tùy chọn)...">
        </div>
    </template>

    <template id="tpl-essay">
        <div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group mb-6 transition-all hover:border-purple-400" data-type="essay">
            <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10">
                <button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="mb-3">
                <span class="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Tự luận</span>
                <textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-purple-200 outline-none min-h-[100px] text-gray-700 text-sm" placeholder="Nhập đề bài tự luận..."></textarea>
            </div>
            <textarea class="w-full p-3 bg-white border border-gray-200 rounded-lg text-sm min-h-[60px] outline-none focus:border-purple-400 focus:ring-1 focus:ring-purple-400" placeholder="Đáp án / Lời giải tham khảo..."></textarea>
        </div>
    </template>

    <template id="tpl-tf">
        <div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group mb-6 transition-all hover:border-orange-400" data-type="tf">
            <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10">
                <button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="mb-3">
                <span class="inline-block px-2 py-0.5 bg-orange-100 text-orange-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Đúng / Sai</span>
                <textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-orange-200 outline-none min-h-[60px] text-gray-700 text-sm" placeholder="Nhập câu dẫn..."></textarea>
            </div>
            <div class="space-y-2 mb-3">
                <div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-gray-400 uppercase">
                    <div class="col-span-8 pl-1">Mệnh đề</div>
                    <div class="col-span-2 text-center text-green-600">Đúng</div>
                    <div class="col-span-2 text-center text-red-500">Sai</div>
                </div>
                <!-- 4 Mệnh đề -->
                <div class="grid grid-cols-12 gap-2 items-center">
                    <div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm focus:border-orange-400 outline-none" placeholder="Mệnh đề 1"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-1-${id}" value="true" class="w-4 h-4 cursor-pointer"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-1-${id}" value="false" class="w-4 h-4 cursor-pointer"></div>
                </div>
                <div class="grid grid-cols-12 gap-2 items-center">
                    <div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm focus:border-orange-400 outline-none" placeholder="Mệnh đề 2"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-2-${id}" value="true" class="w-4 h-4 cursor-pointer"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-2-${id}" value="false" class="w-4 h-4 cursor-pointer"></div>
                </div>
                <div class="grid grid-cols-12 gap-2 items-center">
                    <div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm focus:border-orange-400 outline-none" placeholder="Mệnh đề 3"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-3-${id}" value="true" class="w-4 h-4 cursor-pointer"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-3-${id}" value="false" class="w-4 h-4 cursor-pointer"></div>
                </div>
                <div class="grid grid-cols-12 gap-2 items-center">
                    <div class="col-span-8"><input type="text" class="w-full px-3 py-1.5 border border-gray-200 rounded text-sm focus:border-orange-400 outline-none" placeholder="Mệnh đề 4"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-4-${id}" value="true" class="w-4 h-4 cursor-pointer"></div>
                    <div class="col-span-2 text-center"><input type="radio" name="tf-4-${id}" value="false" class="w-4 h-4 cursor-pointer"></div>
                </div>
            </div>
            <textarea class="w-full px-3 py-2 text-xs bg-gray-50 border border-gray-200 rounded outline-none h-16 resize-none" placeholder="Giải thích chi tiết..."></textarea>
        </div>
    </template>

    <template id="tpl-short">
        <div class="question-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative group mb-6 transition-all hover:border-green-400" data-type="short">
            <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-lg shadow-sm border border-gray-100 z-10">
                <button onclick="deleteQuestion(this)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="mb-3">
                <span class="inline-block px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded uppercase tracking-wide mb-2">Trả lời ngắn</span>
                <textarea class="w-full p-3 bg-gray-50 border-0 rounded-lg focus:ring-2 focus:ring-green-200 outline-none min-h-[80px] text-gray-700 text-sm" placeholder="Nhập câu hỏi..."></textarea>
            </div>
            <div class="mb-3">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Đáp án mẫu:</label>
                <input type="text" class="w-full px-3 py-2 border border-green-200 bg-green-50 rounded-lg text-sm font-bold text-green-800 outline-none focus:border-green-500" placeholder="VD: 15 cm">
            </div>
            <textarea class="w-full px-3 py-2 text-xs bg-white border border-gray-200 rounded outline-none h-16 resize-none" placeholder="Lời giải chi tiết..."></textarea>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CẤU HÌNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentExamId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('id');
                
                if (examId) {
                    currentExamId = examId;
                    loadExamData(examId);
                } else {
                    document.getElementById('sidebarExamTitle').textContent = "Đề thi mới (Chưa lưu)";
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadExamData(id) {
            try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('settingTitle').value = data.title;
                    document.getElementById('settingDuration').value = data.duration || 45;
                    document.getElementById('sidebarExamTitle').textContent = data.title;
                    
                    const statusText = data.status === 'published' ? '• Đã xuất bản' : '• Bản nháp';
                    const statusEl = document.getElementById('examStatus');
                    statusEl.textContent = statusText;
                    statusEl.className = `text-xs font-bold ${data.status === 'published' ? 'text-green-600' : 'text-orange-500'}`;

                    if (data.questions && data.questions.length > 0) {
                        document.getElementById('emptyState').classList.add('hidden');
                        data.questions.forEach(q => addQuestion(q.type === 'mc' ? 'mc' : (q.type === 'tf' ? 'tf' : (q.type === 'short' ? 'short' : 'essay')), q));
                    }
                }
            } catch (e) { console.error(e); }
        }

        // LƯU & XUẤT BẢN
        window.saveExam = async function(status) {
            const title = document.getElementById('settingTitle').value;
            const duration = document.getElementById('settingDuration').value;
            if(!title) return alert("Vui lòng nhập tên đề thi!");

            const questionCards = document.querySelectorAll('.question-card');
            const questions = [];
            
            questionCards.forEach(card => {
                const type = card.dataset.type;
                const content = card.querySelector('textarea').value;
                const solution = card.querySelector('input:last-of-type') ? card.querySelector('input:last-of-type').value : card.querySelector('textarea:last-of-type').value;
                
                let qData = { type, content, solution };
                if(type === 'mc') {
                    const opts = Array.from(card.querySelectorAll('input[type="text"]')).map(i => i.value);
                    let correctIdx = -1;
                    card.querySelectorAll('input[type="radio"]').forEach((r, i) => { if(r.checked) correctIdx = i; });
                    qData.options = opts;
                    qData.correct = correctIdx;
                } else if (type === 'tf') {
                    const statements = [];
                    const rows = card.querySelectorAll('.grid.items-center');
                    rows.forEach(row => {
                        const text = row.querySelector('input[type="text"]').value;
                        const isTrue = row.querySelector('input[value="true"]').checked;
                        statements.push({ text, isTrue });
                    });
                    qData.statements = statements;
                } else if (type === 'short') {
                    qData.answer = card.querySelector('input[placeholder*="VD"]').value;
                }
                questions.push(qData);
            });

            // Logic lưu
            const btn = status === 'published' ? document.getElementById('btnPublish') : document.getElementById('btnSaveDraft');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';
            btn.disabled = true;

            try {
                const examRef = currentExamId ? doc(db, "exams", currentExamId) : doc(collection(db, "exams"));
                
                await setDoc(examRef, {
                    title: title,
                    duration: duration,
                    teacherId: currentUser.uid,
                    questions: questions,
                    questionCount: questions.length,
                    status: status, // 'draft' hoặc 'published'
                    updatedAt: new Date().toISOString(),
                    ...(currentExamId ? {} : { createdAt: new Date().toISOString() })
                }, { merge: true });

                currentExamId = examRef.id;
                
                // Cập nhật UI
                document.getElementById('sidebarExamTitle').textContent = title;
                const statusEl = document.getElementById('examStatus');
                statusEl.textContent = status === 'published' ? '• Đã xuất bản' : '• Bản nháp';
                statusEl.className = `text-xs font-bold ${status === 'published' ? 'text-green-600' : 'text-orange-500'}`;

                // Nếu xuất bản -> Hiện modal link
                if (status === 'published') {
                    const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + currentExamId;
                    document.getElementById('shareLinkInput').value = link;
                    
                    const modal = document.getElementById('shareModal');
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                } else {
                    alert("Đã lưu bản nháp thành công!");
                }

                // Update URL
                if (!window.location.search.includes('id=')) {
                    const newUrl = window.location.href.split('?')[0] + '?id=' + currentExamId;
                    window.history.pushState({path:newUrl},'',newUrl);
                }

            } catch(e) {
                console.error(e);
                alert("Lỗi lưu: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // COPY LINK
        window.copyLink = function() {
            const copyText = document.getElementById("shareLinkInput");
            copyText.select();
            document.execCommand("copy");
            alert("Đã sao chép link bài thi!");
        }

        window.closeShareModal = function() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-95');
            modal.querySelector('div').classList.remove('scale-100');
        }
    </script>

    <script>
        // UI Helpers & Question Logic (Non-module)
        function switchView(viewId) {
            document.getElementById('view-settings').classList.add('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('flex');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));

            if (viewId === 'settings') {
                document.getElementById('view-settings').classList.remove('hidden');
                document.getElementById('menu-settings').classList.add('active');
            } else if (viewId === 'editor') {
                document.getElementById('view-editor').classList.remove('hidden');
                document.getElementById('view-editor').classList.add('flex');
                document.getElementById('menu-editor').classList.add('active');
            }
        }

        let qCount = 0;
        function addQuestion(type, data = null) {
            document.getElementById('emptyState').classList.add('hidden');
            const tpl = document.getElementById(`tpl-${type}`);
            const clone = tpl.content.cloneNode(true);
            qCount++;
            const container = clone.querySelector('div');
            container.innerHTML = container.innerHTML.replaceAll('${id}', qCount);
            
            if(data) {
                container.querySelector('textarea').value = data.content || '';
                const lastInput = container.querySelector('input:last-of-type') || container.querySelector('textarea:last-of-type');
                if(lastInput && data.solution) lastInput.value = data.solution;

                if (type === 'mc' && data.options) {
                    const texts = container.querySelectorAll('input[type="text"]');
                    const radios = container.querySelectorAll('input[type="radio"]');
                    data.options.forEach((opt, i) => {
                        if(texts[i]) texts[i].value = opt;
                        if(radios[i] && i === data.correct) radios[i].checked = true;
                    });
                } else if (type === 'tf' && data.statements) {
                    const rows = container.querySelectorAll('.grid.items-center');
                    data.statements.forEach((stmt, idx) => {
                        if(rows[idx]) {
                            rows[idx].querySelector('input[type="text"]').value = stmt.text;
                            if(stmt.isTrue) rows[idx].querySelector('input[value="true"]').checked = true;
                            else rows[idx].querySelector('input[value="false"]').checked = true;
                        }
                    });
                } else if (type === 'short' && data.answer) {
                    container.querySelector('input[placeholder*="VD"]').value = data.answer;
                }
            }

            document.getElementById('questionsList').appendChild(clone);
            const containerDiv = document.getElementById('questionsContainer');
            containerDiv.scrollTo({ top: containerDiv.scrollHeight, behavior: 'smooth' });
            if (window.MathJax) MathJax.typesetPromise();
        }

        function deleteQuestion(btn) {
            if(confirm("Xóa câu này?")) btn.closest('.question-card').remove();
        }
        
        function handleTexUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { parseTexAndAdd(e.target.result); input.value = ""; };
            reader.readAsText(file);
        }

        function parseTexAndAdd(texContent) {
            const blockRegex = /\\begin\{(ex|bt|vd)\}([\s\S]*?)\\end\{\1\}/g;
            let match, count = 0;
            while ((match = blockRegex.exec(texContent)) !== null) {
                let body = match[2];
                let qType = 'essay';
                let qData = { content: '', solution: '', options: [], statements: [], answer: '' };

                const loigiaiMatch = body.match(/\\loigiai\s*\{([\s\S]*)\}\s*$/);
                if (loigiaiMatch) {
                    qData.solution = loigiaiMatch[1].trim();
                    body = body.substring(0, body.lastIndexOf('\\loigiai'));
                }

                if (body.includes('\\choiceTF')) {
                    qType = 'tf';
                    const parts = body.split('\\choiceTF');
                    qData.content = parts[0].trim();
                    const itemRegex = /\{\s*(\\True\s+)?((?:[^{}]|\{[^{}]*\})*)\}/g;
                    let itemMatch;
                    while ((itemMatch = itemRegex.exec(parts[1])) !== null) {
                        qData.statements.push({ text: itemMatch[2].trim(), isTrue: !!itemMatch[1] });
                    }
                } else if (body.includes('\\choice')) {
                    qType = 'mc';
                    const parts = body.split('\\choice');
                    qData.content = parts[0].trim();
                    const itemRegex = /\{\s*(\\True\s+)?((?:[^{}]|\{[^{}]*\})*)\}/g;
                    let itemMatch;
                    let idx = 0;
                    while ((itemMatch = itemRegex.exec(parts[1])) !== null && idx < 4) {
                        qData.options.push(itemMatch[2].trim());
                        if(itemMatch[1]) qData.correct = idx;
                        idx++;
                    }
                } else if (body.includes('\\shortans')) {
                    qType = 'short';
                    const shortMatch = body.match(/\\shortans\s*\{((?:[^{}]|\{[^{}]*\})*)\}/);
                    if (shortMatch) {
                        qData.answer = shortMatch[1].trim();
                        qData.content = body.replace(shortMatch[0], '').trim();
                    } else qData.content = body.trim();
                } else {
                    qData.content = body.trim();
                }
                addQuestion(qType, qData);
                count++;
            }
            if (count > 0) alert(`Đã nhập ${count} câu hỏi!`);
        }
    </script>
</body>
</html>
