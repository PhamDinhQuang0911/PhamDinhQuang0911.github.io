<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản lý đề thi - Smart LaTeX Import</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        macros: {
          heva: ["\\left\\{\\begin{aligned}#1\\end{aligned}\\right.", 1],
          hoac: ["\\left[\\begin{aligned}#1\\end{aligned}\\right.", 1],
          tich: "\\cdot",
          deg: "^\\circ"
        }
      },
      svg: { fontCache: 'global' },
      startup: { typeset: false }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F8F9FA; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        .sidebar-item.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 700; border-right: 3px solid #1D4ED8; }
        .preview-item { transition: all 0.2s; border: 1px solid #E5E7EB; cursor: pointer; background: white; }
        .preview-item:hover { border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .preview-item.active { border-color: #3B82F6; ring: 2px solid #DBEAFE; background-color: #F0F9FF; }
        .group-header { position: sticky; top: 0; background-color: #F9FAFB; z-index: 20; padding-top: 10px; padding-bottom: 5px; border-bottom: 1px solid #E5E7EB; }
        .palette-container { padding: 0.5rem; background: #F9FAFB; border-bottom: 1px solid #E5E7EB; overflow-y: auto; max-height: 120px; }
        .palette-grid { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        .palette-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; border-radius: 4px; border: 1px solid #D1D5DB; color: #4B5563; transition: all 0.2s; background: white; }
        .palette-btn:hover { border-color: #3B82F6; color: #3B82F6; }
        .palette-btn.active { background-color: #3B82F6; color: white; border-color: #3B82F6; }
        mjx-container { display: inline-block !important; margin: 0 1px !important; vertical-align: middle; }
        mjx-container[display="true"] { display: block !important; margin: 0.5em 0 !important; width: 100% !important; overflow-x: auto; }
        .form-input { width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #E5E7EB; outline: none; transition: all 0.2s; font-size: 0.9rem; }
        .form-input:focus { border-color: #3B82F6; ring: 2px solid #DBEAFE; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { backdrop-filter: blur(2px); }
        .modal { transition: opacity 0.2s ease; }
        .modal.opacity-0 { pointer-events: none; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .progress-bar-bg { background-color: #E5E7EB; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease; }
        /* Thêm vào phần <style> */
        .image-placeholder:focus {
            border-color: #2563EB !important; /* Xanh đậm */
            background-color: #EFF6FF !important; /* Nền xanh nhạt */
            outline: 2px solid #3B82F6; /* Viền focus */
            outline-offset: 2px;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <div id="sidebarOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass transition-opacity"></div>

    <aside id="mainSidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex flex-col z-40 shadow-xl transition-transform duration-300 -translate-x-full md:relative md:translate-x-0 flex-shrink-0">
        <div class="p-5 border-b border-gray-100 relative">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm shrink-0"><i class="fa-regular fa-file-lines"></i></div>
                <div class="flex-1 overflow-hidden">
                    <h3 id="sidebarExamTitle" class="font-bold text-gray-800 truncate text-sm" title="Tên đề thi">Đề thi mới</h3>
                    <p class="text-xs text-orange-500 font-bold" id="examStatus">• Bản nháp</p>
                </div>
            </div>
            <button onclick="window.toggleSidebar()" class="md:hidden absolute top-5 right-5 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Cấu hình</div>
            <ul class="space-y-1 mb-6">
                <li><button onclick="switchView('settings'); window.toggleSidebar()" id="menu-settings" class="sidebar-item active w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-sliders w-5"></i> Cài đặt & Cấu hình</button></li>
                <li><button onclick="switchView('editor'); window.toggleSidebar()" id="menu-editor" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-list-check w-5"></i> Nội dung câu hỏi</button></li>
                <li><button onclick="switchView('stats'); window.toggleSidebar()" id="menu-stats" class="sidebar-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 text-sm"><i class="fa-solid fa-chart-pie w-5"></i> Thống kê & Báo cáo</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <button onclick="handleBackNavigation()" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-arrow-right-from-bracket"></i> Quay lại</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative w-full">
        <div class="md:hidden h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.toggleSidebar()" class="text-gray-600 hover:text-blue-600 text-xl p-1"><i class="fa-solid fa-bars"></i></button>
                <span class="font-bold text-gray-800 text-sm truncate max-w-[200px]" id="mobileHeaderTitle">Cài đặt đề thi</span>
            </div>
        </div>

        <div id="view-settings" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 sticky top-0 bg-gray-50 py-2 z-10">
                    <div class="hidden md:block">
                        <h1 class="text-2xl font-bold text-gray-800">Cài đặt đề thi</h1>
                        <p class="text-sm text-gray-500">Thiết lập thông tin và bảo mật.</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="saveExam('draft')" id="btnSaveDraft" class="flex-1 md:flex-none justify-center px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold rounded-xl text-sm flex items-center gap-2"><i class="fa-regular fa-floppy-disk"></i> Lưu nháp</button>
                        <button onclick="saveExam('published')" id="btnPublish" class="flex-1 md:flex-none justify-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 text-sm flex items-center gap-2"><i class="fa-solid fa-rocket"></i> Xuất bản</button>
                    </div>
                </div>

                <div id="publishedLinkArea" class="hidden bg-green-50 p-4 rounded-xl border border-green-200 mb-6 shadow-sm">
                    <label class="block text-xs font-bold text-green-700 uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> Link bài thi (Đã xuất bản)</label>
                    <div class="flex gap-2">
                        <input type="text" id="settingShareLink" class="w-full px-3 py-2 border border-green-300 rounded-lg text-green-800 bg-white focus:outline-none text-sm font-mono" readonly>
                        <button onclick="copySettingLink()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors text-sm whitespace-nowrap">Sao chép</button>
                        <button onclick="window.open(document.getElementById('settingShareLink').value, '_blank')" class="px-3 py-2 bg-white border border-green-300 text-green-600 font-bold rounded-lg hover:bg-green-50 text-sm"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                    </div>
                </div>

                <div class="space-y-4 md:space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-info-circle text-blue-600 mr-2"></i> Cấu hình chung</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1 md:col-span-2"><label class="form-group-title">Tên đề thi <span class="text-red-500">*</span></label><input type="text" id="settingTitle" class="form-input font-bold" placeholder="VD: Kiểm tra 15 phút"></div>
                            <div><label class="form-group-title">Khối lớp</label><select id="settingGrade" class="form-input bg-white"><option value="12">Khối 12</option><option value="11">Khối 11</option><option value="10">Khối 10</option><option value="9">Khối 9</option></select></div>
                            <div><label class="form-group-title">Môn học</label><select id="settingSubject" class="form-input bg-white"><option>Toán học</option><option>Vật lý</option><option>Hóa học</option><option>Tiếng Anh</option></select></div>
                            <div><label class="form-group-title">Thời gian (phút)</label><input type="number" id="settingDuration" value="90" class="form-input"></div>
                            <div><label class="form-group-title">Mục đích</label><select id="settingPurpose" class="form-input bg-white"><option value="exam">Thi / Kiểm tra</option><option value="practice">Luyện tập</option></select></div>
                            <div class="col-span-1 md:col-span-2 pt-2 border-t border-dashed"><label class="form-group-title block mb-2">Thời gian mở đề (Tùy chọn)</label><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><span class="text-xs text-gray-500">Từ:</span><input type="datetime-local" id="settingStartTime" class="form-input"></div><div><span class="text-xs text-gray-500">Đến:</span><input type="datetime-local" id="settingEndTime" class="form-input"></div></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-shield-halved text-red-600 mr-2"></i> Bảo mật</h3>
                            <div class="space-y-3">
                                <div><label class="form-group-title">Mật khẩu</label><input type="text" id="settingPassword" placeholder="Không bắt buộc" class="form-input"></div>
                                <div><label class="form-group-title">Số lượt làm</label><input type="number" id="settingAttempts" value="1" class="form-input"></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Giám sát tự động</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settingProctoring" class="toggle-checkbox sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label></div>
                                <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-700">Đảo câu hỏi</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settingShuffle" checked class="toggle-checkbox sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-square-poll-vertical text-green-600 mr-2"></i> Kết quả</h3>
                            <div class="space-y-4">
                                <div><label class="form-group-title">Xem điểm</label><div class="grid grid-cols-3 gap-2 text-xs"><label><input type="radio" name="settingShowScore" value="immediate" checked> Ngay</label><label><input type="radio" name="settingShowScore" value="after_exam"> Hết giờ</label><label><input type="radio" name="settingShowScore" value="never"> Không</label></div></div>
                                <div><label class="form-group-title">Xem đáp án</label><div class="grid grid-cols-3 gap-2 text-xs"><label><input type="radio" name="settingShowResult" value="immediate" checked> Ngay</label><label><input type="radio" name="settingShowResult" value="after_exam"> Hết giờ</label><label><input type="radio" name="settingShowResult" value="never"> Không</label></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100"><i class="fa-solid fa-users text-purple-600 mr-2"></i> Đối tượng</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('public')"><input type="radio" name="settingAccess" value="public" checked> <div><div class="font-bold text-sm">Công khai</div><div class="text-xs text-gray-500">Ai cũng có thể làm</div></div></label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50" onclick="togglePrivasySettings('class')"><input type="radio" name="settingAccess" value="class"> <div><div class="font-bold text-sm">Lớp học</div><div class="text-xs text-gray-500">Chỉ các lớp được chọn</div></div></label>
                            <div id="classSelectionArea" class="hidden pl-6 mt-2">
                                <div id="classCheckboxList" class="max-h-40 overflow-y-auto border border-blue-200 rounded-lg p-2 bg-gray-50 space-y-1 custom-scrollbar">
                                    <p class="text-xs text-gray-400 italic">Đang tải danh sách lớp...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-editor" class="hidden flex-1 h-full flex flex-col md:flex-row relative bg-gray-100">
            <div class="w-full md:w-1/2 lg:w-5/12 h-1/2 md:h-full flex flex-col border-r border-gray-200 bg-white z-10">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-list-ol mr-2"></i>Danh sách (<span id="totalQCount">0</span>)</h3>
                    <div class="flex gap-2">
                        <button onclick="openScoringModal()" class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded text-xs font-bold hover:bg-yellow-200"><i class="fa-solid fa-calculator mr-1"></i> Chia điểm</button>
                        <button onclick="document.getElementById('texInput').click()" class="px-3 py-1.5 bg-green-100 text-green-700 rounded text-xs font-bold hover:bg-green-200"><i class="fa-solid fa-file-import mr-1"></i> LaTeX</button>
                        <input type="file" id="texInput" accept=".tex,.txt" class="hidden" onchange="handleTexUpload(this)">
                    </div>
                </div>
                
                <div id="quickPaletteContainer" class="palette-container hidden">
                    <div class="palette-grid" id="quickPalette"></div>
                </div>

                <div id="previewList" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 scroll-smooth relative">
                    <div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.<br>Hãy thêm câu hỏi hoặc Import Tex.</div>
                </div>
            </div>

            <div class="w-full md:w-1/2 lg:w-7/12 h-1/2 md:h-full flex flex-col bg-white">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-pen-to-square mr-2 text-blue-600"></i>Chỉnh sửa</h3>
                    <div class="flex gap-2">
                        <button onclick="addNewQuestion('mc')" class="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-xs font-bold">+TN</button>
                        <button onclick="addNewQuestion('tf')" class="p-1.5 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 text-xs font-bold">+ĐS</button>
                        <button onclick="addNewQuestion('short')" class="p-1.5 bg-green-50 text-green-600 rounded hover:bg-green-100 text-xs font-bold">+Điền</button>
                        <button onclick="addNewQuestion('essay')" class="p-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 text-xs font-bold">+TL</button>
                        <div class="w-[1px] h-6 bg-gray-200 mx-1"></div>
                         <button onclick="document.getElementById('imgUploadInput').click()" class="p-1.5 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 text-xs font-bold" title="Chèn ảnh"><i class="fa-regular fa-image"></i> Ảnh</button>
                        <input type="file" id="imgUploadInput" accept="image/*" class="hidden">
                        <div class="w-[1px] h-6 bg-gray-200 mx-1"></div>                                             
                        <button onclick="deleteCurrentQuestion()" class="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <div id="editorArea" class="flex-1 overflow-y-auto p-4 md:p-6 bg-white relative">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>
                </div>
            </div>
        </div>

        <div id="view-stats" class="hidden flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
           <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                    <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-chart-pie mr-2 text-blue-600"></i>Thống kê kết quả</h1>
                    <button onclick="window.exportToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Xuất Excel</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Học sinh đã nộp</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statTotalSubmissions">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Điểm trung bình</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statAvgScore">0.0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Điểm cao nhất</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statMaxScore">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-gray-500 text-xs uppercase font-bold">Điểm thấp nhất</p>
                        <h3 class="text-3xl font-black text-gray-800 mt-1" id="statMinScore">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">Phổ điểm thi</h3>
                        <div class="h-64"><canvas id="scoreChart"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex flex-col h-[340px]">
                        <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase">Phân tích câu hỏi (Tỉ lệ đúng)</h3>
                        <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3" id="questionAnalysisList">
                            <p class="text-gray-400 text-xs text-center">Chưa có dữ liệu.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row gap-4 justify-between bg-gray-50">
                        <div class="flex gap-2">
                            <button onclick="filterStats('all')" class="px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm" id="filterBtnAll">Tất cả</button>
                            <button onclick="filterStats('class')" class="hidden px-3 py-1.5 rounded-lg text-sm font-bold bg-white text-gray-600 border hover:bg-gray-100" id="filterBtnClass">Theo lớp</button>
                        </div>
                        <div class="flex gap-2">
                            <select id="sortStats" class="form-input text-sm py-1.5 w-40" onchange="renderStatsTable()">
                                <option value="score_desc">Điểm cao -> thấp</option>
                                <option value="score_asc">Điểm thấp -> cao</option>
                                <option value="time_desc">Nộp mới nhất</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-6 py-3">Học sinh</th>
                                    <th class="px-6 py-3 text-center">Điểm (Cao nhất)</th>
                                    <th class="px-6 py-3 text-center">Số lượt</th>
                                    <th class="px-6 py-3 text-right">Ngày nộp</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="historyModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[110] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50 rounded-t-xl">
                <h3 class="font-bold text-blue-800" id="histModalTitle">Lịch sử làm bài</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto" id="histModalContent"></div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
            <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg" id="modalTitle">Thông báo</h3>
                <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-5xl mb-4 text-orange-500"><i class="fa-solid fa-circle-question"></i></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg">Nội dung...</p>
                <input type="text" id="modalInput" class="hidden mt-4 w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none" placeholder="Nhập thông tin...">
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">Hủy bỏ</button>
                <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-70 px-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-green-600 animate-bounce"><i class="fa-solid fa-check"></i></div>
                <h3 class="text-2xl font-bold text-gray-800">Xuất bản thành công!</h3><p class="text-gray-500 text-sm">Đề thi đã sẵn sàng.</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Link bài thi</label>
                <div class="flex gap-2">
                    <input type="text" id="shareLinkInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-600 bg-white focus:outline-none text-sm font-mono" readonly>
                    <button onclick="copyLink()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors text-sm">Copy</button>
                </div>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="closeShareModal()" class="flex-1 px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-colors">Đóng</button>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="font-bold text-yellow-800"><i class="fa-solid fa-calculator mr-2"></i>Cấu hình điểm số</h3>
                <button onclick="closeScoringModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Trắc nghiệm + Điền từ</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countMcShort">0</b></span></div>
                        <input type="number" id="scoreTotalMcShort" class="form-input text-right font-bold text-blue-600" placeholder="Tổng điểm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Đúng / Sai</label>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-1"><span>Số lượng: <b id="countTF">0</b></span></div>
                        <input type="number" id="scoreTotalTF" class="form-input text-right font-bold text-orange-600" placeholder="Tổng điểm">
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Chi tiết Tự luận (<span id="countEssay">0</span> câu)</h4>
                    <div id="essayScoreList" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-xs text-gray-400 italic">Không có câu tự luận nào.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex justify-end gap-2 bg-gray-50 rounded-b-xl">
                <button onclick="closeScoringModal()" class="px-4 py-2 bg-white border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-100">Hủy</button>
                <button onclick="applyScoring()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Áp dụng</button>
            </div>
        </div>
    </div>
    
    <div id="batchImageModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[120] flex items-center justify-center bg-gray-900 bg-opacity-70 px-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl transform scale-95 transition-transform duration-300 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold"><i class="fa-solid fa-images"></i></div>
                    <h3 class="font-bold text-gray-800">Tải lên file ảnh</h3>
                </div>
                <button onclick="closeBatchImageModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto bg-gray-50/50 flex-1">
                 <p class="text-sm text-gray-500 mb-4 px-1">Hệ thống phát hiện các ảnh sau trong mã LaTeX. Vui lòng tải ảnh tương ứng lên để thay thế.</p>
                 <div id="batchImageList" class="space-y-3">
                     </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeBatchImageModal()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 text-sm">Xong</button>
            </div>
        </div>
    </div>
    
    <div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col gap-3 pointer-events-none"></div>
    
    <input type="file" id="batchFileInput" accept="image/*" class="hidden">
    <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78", authDomain: "lms-thitracnghiem.firebaseapp.com", projectId: "lms-thitracnghiem", storageBucket: "lms-thitracnghiem.firebasestorage.app", messagingSenderId: "760187217240", appId: "1:760187217240:web:d043cd5808c349f87a712d" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const storage = getStorage(app);
        
        let currentUser = null, currentExamId = null;
        window.questions = [];
        window.originalQuestionsData = []; 
        window.currentQIndex = -1;
        
        // MẢNG THEO DÕI ẢNH TẠM THỜI
        let sessionUploadedFiles = [];
        
        let statsMap = {}; 
        let classStudentList = [];

        let modalResolve = null;
        const modalEl = document.getElementById('customModal');
        const modalBox = document.getElementById('customModalBox');
        const modalTitle = document.getElementById('modalTitle');
        const modalMsg = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnCancel = document.getElementById('btnCancel');

        window.closeCustomModal = () => { modalEl.classList.add('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-95'); if (modalResolve) { modalResolve(null); modalResolve = null; } };
        window.customAlert = (message, type = 'info') => { return new Promise((resolve) => { modalTitle.innerText = type === 'error' ? 'Lỗi' : 'Thông báo'; modalMsg.innerText = message; modalIcon.innerHTML = type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-bell text-blue-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.add('hidden'); btnConfirm.innerText = "Đã hiểu"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-100'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; modalResolve = resolve; }); };
        window.customConfirm = (message) => { return new Promise((resolve) => { modalTitle.innerText = "Xác nhận"; modalMsg.innerText = message; modalIcon.innerHTML = '<i class="fa-solid fa-circle-question text-orange-500"></i>'; document.getElementById('modalInput').classList.add('hidden'); btnCancel.classList.remove('hidden'); btnConfirm.innerText = "Đồng ý"; modalEl.classList.remove('opacity-0', 'pointer-events-none'); modalBox.classList.remove('scale-95'); modalBox.classList.add('scale-100'); btnConfirm.onclick = () => { resolve(true); modalResolve = null; closeCustomModal(); }; btnCancel.onclick = () => { resolve(false); modalResolve = null; closeCustomModal(); }; }); };

        function cleanTikzCode(code) {
            let cleaned = code;
            const resizeRegex = /\\resizebox\{[^}]+\}\{[^}]+\}\{\s*(\\begin\{tikzpicture\}[\s\S]*?\\end\{tikzpicture\})\s*\}/g;
            cleaned = cleaned.replace(resizeRegex, "$1");
            cleaned = cleaned.replace(/\\begin\{center\}/g, "").replace(/\\end\{center\}/g, "");
            return cleaned;
        }

        function processNestedTikz(text) {
            if (!text) return "";
            let result = "";
            let remaining = String(text);
            
            while (true) {
                const startIdx = remaining.indexOf("\\begin{tikzpicture}");
                if (startIdx === -1) { result += remaining; break; }
                
                result += remaining.substring(0, startIdx);
                remaining = remaining.substring(startIdx);
                
                let depth = 0; let endIdx = -1;
                const openTag = "\\begin{tikzpicture}"; const closeTag = "\\end{tikzpicture}";
                let searchPos = openTag.length; depth = 1;

                while (depth > 0) {
                    const nextOpen = remaining.indexOf(openTag, searchPos);
                    const nextClose = remaining.indexOf(closeTag, searchPos);
                    if (nextClose === -1) { endIdx = remaining.length; depth = 0; break; }
                    if (nextOpen !== -1 && nextOpen < nextClose) { depth++; searchPos = nextOpen + openTag.length; } 
                    else { depth--; searchPos = nextClose + closeTag.length; if (depth === 0) endIdx = searchPos; }
                }
                
                let rawTikz = remaining.substring(0, endIdx);
                let finalTikz = cleanTikzCode(rawTikz);
                if (!finalTikz.includes("\\usetikzlibrary")) finalTikz = "\\usetikzlibrary{calc,intersections,arrows.meta}\n" + finalTikz;

                result += `<div class="flex justify-center my-4 overflow-x-auto"><script type="text/tikz">${finalTikz}<\/script></div>`;
                remaining = remaining.substring(endIdx);
            }
            return result;
        }
        
        // --- HÀM XỬ LÝ BẢNG BIỂU ---
        function processTabular(text) {
            if (!text) return "";
            
            // Loại bỏ môi trường table bao ngoài
            let processed = text.replace(/\\begin\{table\}(\[.*?\])?/g, '').replace(/\\end\{table\}/g, '');

            const regex = /\\begin\{tabular\}(\{|\[).*?(\}|\])([\s\S]*?)\\end\{tabular\}/g;
            
            return processed.replace(regex, (match, open, close, body) => {
                const rows = body.split('\\\\').filter(r => r.trim().length > 0);
                
                // THAY ĐỔI: Bỏ overflow-x-auto, thêm js-scale-table
                // Wrapper div cần position relative
                let html = '<div class="my-3 w-full js-scale-wrapper" style="position: relative; width: 100%;">';
                
                // Table: Thêm origin-top-left để scale từ góc
                html += '<table class="js-scale-table border-collapse border border-gray-300 bg-white text-sm origin-top-left" style="min-width: max-content;">';
                
                rows.forEach((row, rIdx) => {
                    let cleanRow = row.replace(/\\hline/g, '').trim();
                    if(cleanRow.length === 0) return;

                    const cols = cleanRow.split('&');
                    html += `<tr class="${rIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                    cols.forEach(col => {
                        html += `<td class="border border-gray-300 px-3 py-2">${col.trim()}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table></div>';
                return html;
            });
        }

        // --- HÀM XỬ LÝ LIST ---
        function processLatexLists(text) {
            let processed = text;

            processed = processed.replace(/\\begin\{itemchoice\}([\s\S]*?)\\end\{itemchoice\}/g, (match, body) => {
                const items = body.split('\\itemch').filter(s => s.trim().length > 0);
                const htmlItems = items.map(item => {
                    let content = item.trim().replace(/\\\\/g, '<br>').replace(/\n/g, ' ');
                    return `<li class="flex items-start gap-2 mb-1">
                        <span class="text-blue-600 font-bold shrink-0">•</span> 
                        <div class="leading-relaxed">${content}</div>
                    </li>`;
                }).join('');
                return `<ul class="my-3 pl-2">${htmlItems}</ul>`;
            });

            const parseItems = (bodyStr) => {
                const rawItems = bodyStr.split(/\\item(?![a-zA-Z])/).filter(s => s.trim().length > 0);
                return rawItems.map((item) => {
                    let content = item.trim();
                    let label = null;
                    if (content.startsWith('[')) {
                        const closeBracket = content.indexOf(']');
                        if (closeBracket > -1) {
                            label = content.substring(1, closeBracket);
                            content = content.substring(closeBracket + 1).trim();
                        }
                    }
                    content = processTabular(content);
                    return { label, content };
                });
            };

            const regexCols = /\\begin\{(?:listEX|enumEX)\}(?:\[(\d+)\]|\{(\d+)\}(?:\[(.*?)\])?)([\s\S]*?)\\end\{(?:listEX|enumEX)\}/g;
            processed = processed.replace(regexCols, (match, c1, c2, style, body) => {
                const cols = c1 || c2 || 1;
                const items = parseItems(body);
                let gridHtml = `<div class="grid grid-cols-1 md:grid-cols-${cols} gap-4 my-3">`;
                items.forEach((it, idx) => {
                    let displayLabel = it.label;
                    if (!displayLabel && match.includes('enumEX')) displayLabel = String.fromCharCode(97 + idx) + ')';
                    gridHtml += `<div class="flex gap-2">${displayLabel ? `<span class="font-bold text-gray-700 shrink-0">${displayLabel}</span>` : `<span class="text-gray-400 shrink-0">•</span>`}<div>${it.content}</div></div>`;
                });
                gridHtml += `</div>`;
                return gridHtml;
            });

            processed = processed.replace(/\\begin\{enumerate\}([\s\S]*?)\\end\{enumerate\}/g, (match, body) => {
                const items = parseItems(body);
                let html = `<ol class="list-decimal pl-6 space-y-1 my-2">`;
                items.forEach(it => {
                    html += it.label ? `<li class="list-none -ml-4"><span class="font-bold mr-1">${it.label}</span>${it.content}</li>` : `<li>${it.content}</li>`;
                });
                html += `</ol>`;
                return html;
            });

            processed = processed.replace(/\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g, (match, body) => {
                const items = parseItems(body);
                let html = `<ul class="list-disc pl-6 space-y-1 my-2">`;
                items.forEach(it => {
                    html += it.label ? `<li class="list-none -ml-4"><span class="font-bold mr-1">${it.label}</span>${it.content}</li>` : `<li>${it.content}</li>`;
                });
                html += `</ul>`;
                return html;
            });

            return processed;
        }

        // --- [CẬP NHẬT] HÀM FIX LỖI HIỂN THỊ ARRAY ---
        // Chỉ xử lý array, tuyệt đối không đụng vào \heva để tránh lỗi MathJax
        function convertArrayToMatrix(content) {
            if (!content) return "";
            
            let processed = content;
            // 1. Thay thế \begin{array}{...} thành \begin{matrix}
            // Regex tìm: \begin{array}, khoảng trắng, {tham_số_cột_bất_kỳ}
            processed = processed.replace(/\\begin\{array\}\s*\{[^{}]*?\}/g, '\\begin{matrix}');
            
            // 2. Fallback cho trường hợp array không tham số
            processed = processed.replace(/\\begin\{array\}/g, '\\begin{matrix}');
            
            // 3. Thay thế thẻ đóng
            processed = processed.replace(/\\end\{array\}/g, '\\end{matrix}');
            
            return processed;
        }

        function formatContent(text) {
            if (text === null || text === undefined) return "";
            
            let processed = text;

            // Yêu cầu 1: Đổi \lq\lq và \rq\rq thành dấu ngoặc kép "
            processed = processed.replace(/\\lq\\lq/g, '"').replace(/\\rq\\rq/g, '"');
            processed = processed.replace(/\\lq/g, '"').replace(/\\rq/g, '"'); // Xử lý cả ngoặc đơn nếu có

            // Yêu cầu 2: Đổi \wideparen{...} thành cung tròn \overset{\frown}{...}
            processed = processed.replace(/\\wideparen\{([^}]+)\}/g, '\\overset{\\frown}{$1}');

            // Yêu cầu 3: Loại bỏ \hspace{...}, \vspace{...}, \hspace*{...}
            processed = processed.replace(/\\(h|v)space\*?\{[^}]+\}/g, '');

            // [BƯỚC 1] Fix lỗi Array -> Matrix
            processed = convertArrayToMatrix(processed);

            // [LƯU Ý]: Bỏ hàm processNestedTikz cũ đi vì giờ ta dùng placeholder ở trên rồi
            // processed = processNestedTikz(processed); -> BỎ DÒNG NÀY

            // 3. Xử lý Bảng biểu (Tabular)
            processed = processTabular(processed);

            // 4. Xử lý các danh sách liệt kê
            processed = processLatexLists(processed);

            // 5. Dọn rác text
            processed = processed.replace(/^\s*\}\s*$/gm, ''); 
            processed = processed.replace(/\}\s*$/g, '');
            processed = processed.replace(/Ảnh minh họa \(immini\)/g, ''); 
            processed = processed.replace(/Ảnh canh giữa/g, '');

            // 6. Bảo vệ HTML
            const regex = /(\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\]|\\\([\s\S]*?\\\)|(?:\$[\s\S]*?\$)|<div[^>]*data-id=.*?>[\s\S]*?<\/div>|<img.*?>|<table[\s\S]*?<\/table>|<ul[\s\S]*?<\/ul>|<ol[\s\S]*?<\/ol>|<div class="grid[\s\S]*?<\/div>)/g;
            
            const parts = processed.split(regex);
            return parts.map(part => {
                if (part.includes('data-id=') || 
                    part.includes('<img') || 
                    part.includes('<ul') ||  
                    part.includes('<ol') ||  
                    part.includes('<table') || 
                    part.includes('class="grid') || 
                    part.trim().startsWith('$') || 
                    part.trim().startsWith('\\(') || 
                    part.trim().startsWith('\\[')) {
                    return part;
                }
                else {
                    let cleanPart = part.replace(/\}/g, '');
                    return cleanPart.replace(/\\\\/g, '<br>').replace(/\n/g, '<br>');
                }
            }).join('');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadTeacherClasses();
                const urlParams = new URLSearchParams(window.location.search);
                const examId = urlParams.get('id');
                if (examId) { currentExamId = examId; loadExamData(examId); }
            } else { window.location.href = 'index.html'; }
        });

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 800; 
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function handleImageUpload(file) {
            if (!file) return;
            window.showToast("Đang tải ảnh lên Cloudflare...", "info");
            try {
                const compressedBlob = await compressImage(file);
                const formData = new FormData();
                const fileName = `images/${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
                formData.append('file', compressedBlob, fileName);

                const response = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", {
                    method: 'PUT',
                    body: formData
                });

                if (!response.ok) throw new Error("Lỗi kết nối Cloudflare");
                
                const data = await response.json();
                
                // QUAN TRỌNG: Lưu tên file (key) vào danh sách tạm
                // Để nếu thoát ra thì biết cái gì mà xóa
                sessionUploadedFiles.push(data.key); 

                insertAtCursor(`\n<div class="flex justify-center"><img src="${data.url}" class="max-w-full h-auto rounded-lg shadow-sm" style="max-height:300px;"></div>\n`);
                autoSaveMemory(); 
                window.showToast("Đã chèn ảnh thành công!", "success");
            } catch (error) { 
                console.error(error); 
                window.showToast("Lỗi tải ảnh: " + error.message, "error"); 
            }
        }

        function insertAtCursor(text) {
            const textarea = document.getElementById('editContent');
            if (!textarea) return;
            const start = textarea.selectionStart; const end = textarea.selectionEnd; const value = textarea.value;
            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length; textarea.focus();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('imgUploadInput').addEventListener('change', (e) => { if(e.target.files.length > 0) handleImageUpload(e.target.files[0]); });
            document.body.addEventListener('paste', (e) => {
                if (e.target.id === 'editContent') {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let index in items) {
                        const item = items[index];
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            e.preventDefault(); const blob = item.getAsFile(); handleImageUpload(blob); return;
                        }
                    }
                }
            });
        });

        let pendingImageUploads = []; 
        let currentBatchUploadId = null;

        function getPlaceholderHTML(id, note = "Vị trí ảnh") {
            return `
            <div class="image-placeholder my-3 p-4 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-center flex flex-col items-center justify-center select-none cursor-pointer hover:bg-gray-100 transition-all group relative outline-none" 
                data-id="${id}" 
                tabindex="0"
                onclick="event.stopPropagation(); this.focus();" 
                ondblclick="triggerBatchUpload('${id}')"
                title="Click để chọn (rồi bấm Ctrl+V), Click đúp để tải file">
                
                <div class="text-gray-400 group-focus:text-blue-600 text-3xl mb-2 transition-colors">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <div class="text-xs font-bold text-gray-500 group-focus:text-blue-700 uppercase mb-1">${note}</div>
                <div class="text-[10px] text-gray-400 group-focus:text-blue-500">
                    Click đúp để tải file<br>hoặc <b>Ctrl + V</b> để dán ảnh
                </div>
            </div>`;
        }

        function extractNextBrace(text) {
            if (!text) return null;
            const start = text.indexOf('{');
            if (start === -1) return null;
            
            let depth = 1;
            let end = -1;
            
            for (let i = start + 1; i < text.length; i++) {
                if (text[i] === '{') depth++;
                else if (text[i] === '}') depth--;
                
                if (depth === 0) {
                    end = i;
                    break;
                }
            }
            
            if (end === -1) return null;
            
            return {
                content: text.substring(start + 1, end),
                remaining: text.substring(end + 1),
                fullMatch: text.substring(start, end + 1)
            };
        }

       function processLatexImagesWithDetection(text, questionIndex) {
            if (!text) return "";
            let processed = String(text);
            
            while (true) {
                const idx = processed.indexOf('\\immini');
                if (idx === -1) break;

                const before = processed.substring(0, idx); 
                let remainder = processed.substring(idx + 7).trim();

                if (remainder.startsWith('[')) { 
                    const cb = remainder.indexOf(']'); 
                    if (cb > -1) remainder = remainder.substring(cb + 1).trim(); 
                }

                const arg1 = extractNextBrace(remainder);
                if (!arg1) break; 

                const arg2 = extractNextBrace(arg1.remaining);
                if (!arg2) break; 

                let imgPath = "";
                let placeholderType = ""; 
                let needsUpload = false;

                if (arg2.content.includes('includegraphics')) {
                     const igIdx = arg2.content.indexOf('\\includegraphics');
                     const afterIg = arg2.content.substring(igIdx);
                     const pathBlock = extractNextBrace(afterIg.substring(afterIg.indexOf('{')));
                     if (pathBlock) {
                         imgPath = pathBlock.content;
                         needsUpload = true;
                         placeholderType = "Ảnh từ immini";
                     }
                } 
                else if (arg2.content.includes('tikzpicture')) {
                    needsUpload = true;
                    placeholderType = "Vị trí hình TikZ (Bấm để chèn ảnh chụp)";
                    imgPath = "tikz_diagram_placeholder";
                }

                let ph = "";
                if (needsUpload) {
                    const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                    
                    // --- PHÂN LOẠI ẢNH ---
                    const imgType = (placeholderType.includes("TikZ")) ? 'tikz' : 'normal';
                    
                    pendingImageUploads.push({
                        id: uid, 
                        originalPath: imgPath, 
                        questionIdx: questionIndex,
                        type: imgType // Lưu loại ảnh
                    });
                    
                    ph = getPlaceholderHTML(uid, placeholderType);
                } else {
                    ph = `<div class="text-xs text-gray-400 italic border border-dashed p-2 text-center">[Khối hình không xác định]</div>`;
                }

                const contentText = arg1.content;
                const choiceRegex = /\\(choice|choiceTF|shortans)/;
                const match = contentText.match(choiceRegex);
                
                let newContent = "";
                if (match && match.index !== undefined) {
                    newContent = contentText.substring(0, match.index) + 
                                 '\n\n' + ph + '\n\n' + 
                                 contentText.substring(match.index);
                } else {
                    newContent = contentText + '\n\n' + ph;
                }

                processed = before + newContent + arg2.remaining;
            }

            const tikzRegex = /\\begin\{tikzpicture\}[\s\S]*?\\end\{tikzpicture\}/g;
            processed = processed.replace(tikzRegex, (match) => {
                 const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`; 
                 // type: 'tikz'
                 pendingImageUploads.push({id:uid, originalPath:"standalone_tikz", questionIdx:questionIndex, type: 'tikz'}); 
                 return getPlaceholderHTML(uid, "Hình TikZ (Bấm để thay ảnh)");
            });

            const centerRegex = /\\begin\{center\}\s*([\s\S]*?)\\includegraphics\s*(?:\[.*?\])?\s*\{(.*?)\}([\s\S]*?)\\end\{center\}/g;
            processed = processed.replace(centerRegex, (match, preText, imgPath, postText) => {
                 const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`; 
                 // type: 'normal'
                 pendingImageUploads.push({id:uid, originalPath:imgPath, questionIdx:questionIndex, type: 'normal'}); 
                 return getPlaceholderHTML(uid, "Ảnh canh giữa");
            });
            
            processed = processed.replace(/\\includegraphics\s*(?:\[.*?\])?\s*\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g, (m, path) => {
                const uid = `img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`; 
                // type: 'normal'
                pendingImageUploads.push({id:uid, originalPath:path, questionIdx:questionIndex, type: 'normal'}); 
                return getPlaceholderHTML(uid, "Ảnh");
            });

            return processed;
        }

        window.renderBatchImageModal = () => {
            const list = document.getElementById('batchImageList');
            const modal = document.getElementById('batchImageModal');
            list.innerHTML = '';
            
            // LỌC: Chỉ lấy ảnh thường (immini, includegraphics)
            const normalImages = pendingImageUploads.filter(item => item.type === 'normal');
            
            if (normalImages.length === 0) {
                // Nếu không có ảnh thường nào thì ẩn modal này đi
                closeBatchImageModal();
                return;
            }

            const folderDiv = document.createElement('div');
            folderDiv.className = "mb-4 p-4 bg-blue-50 border border-blue-200 rounded-xl flex items-center justify-between shadow-sm";
            folderDiv.innerHTML = `
                <div>
                    <h4 class="font-bold text-blue-800 text-sm"><i class="fa-solid fa-magic-wand-sparkles mr-1"></i> Tự động quét ảnh</h4>
                    <p class="text-xs text-blue-600 mt-1">Chọn folder chứa ảnh để hệ thống tự ghép tên file.</p>
                </div>
                <button onclick="document.getElementById('folderInput').click()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg text-xs shadow-md hover:bg-blue-700 transition-colors whitespace-nowrap">
                    <i class="fa-solid fa-folder-open mr-1"></i> Chọn thư mục
                </button>
            `;
            list.appendChild(folderDiv);

            normalImages.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-xl hover:shadow-sm transition-shadow";
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs shrink-0">${index + 1}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="text-xs font-bold text-blue-600 mb-0.5">Câu hỏi số ${item.questionIdx + 1}</div>
                        <div class="text-xs text-gray-500 truncate" title="${item.originalPath}"><i class="fa-regular fa-folder-open mr-1"></i>.../${item.originalPath.split('/').pop()}</div>
                    </div>
                    <button onclick="triggerBatchUpload('${item.id}')" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 font-bold text-xs rounded-lg hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-upload mr-1"></i> Chọn lẻ
                    </button>
                `;
                list.appendChild(div);
            });

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-100');
        };

        window.triggerBatchUpload = (id) => {
            currentBatchUploadId = id;
            document.getElementById('batchFileInput').click();
        };

        window.closeBatchImageModal = () => {
            document.getElementById('batchImageModal').classList.add('opacity-0', 'pointer-events-none');
        };

        async function uploadAndReplaceImage(file, batchId) {
            const compressedBlob = await compressImage(file);
            
            const formData = new FormData();
            // Tạo tên file (Key)
            const fileName = `images/batch_${Date.now()}_${Math.random().toString(36).substr(2,6)}.jpg`;
            
            // --- [QUAN TRỌNG] LƯU VÀO DANH SÁCH TẠM ĐỂ XÓA NẾU THOÁT ---
            sessionUploadedFiles.push(fileName); 
            // -----------------------------------------------------------

            formData.append('file', compressedBlob, fileName);

            const response = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", {
                method: 'PUT',
                body: formData
            });

            if (!response.ok) throw new Error("Lỗi kết nối Cloudflare");
            const data = await response.json();
            const url = data.url;

            // Logic thay thế ảnh cũ (nếu là ảnh Firebase thì xóa)
            let targetQ = window.questions.find(q => (q.content && q.content.includes(batchId)) || (q.solution && q.solution.includes(batchId)));
            if (targetQ) {
                const oldContent = targetQ.content.includes(batchId) ? targetQ.content : targetQ.solution;
                const regexOldImg = new RegExp(`<div[^>]*data-id=['"]${batchId}['"][^>]*>[\\s\\S]*?<img[^>]+src=['"]([^'"]+)['"][^>]*>[\\s\\S]*?<\\/div>`, 'i');
                const match = oldContent.match(regexOldImg);
                if (match && match[1] && match[1].includes('firebasestorage')) {
                    try { deleteObject(ref(storage, match[1])).catch(()=>{}); } catch(e){}
                }
            }
            
            const imgTag = `
            <div class="group relative flex justify-center my-2 cursor-pointer"
                 onclick="triggerBatchUpload('${batchId}')" 
                 data-id="${batchId}"
                 title="Bấm để thay đổi ảnh">
                <img src="${url}" class="max-w-full h-auto rounded-lg shadow-md border-2 border-transparent group-hover:border-blue-400 transition-all" style="max-height:350px;">
                <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center rounded-lg transition-opacity">
                    <span class="text-white font-bold text-sm"><i class="fa-solid fa-pen"></i> Thay ảnh</span>
                </div>
            </div>`;
            
            const targetRegex = new RegExp(`<div[^>]*data-id=['"]${batchId}['"][^>]*>[\\s\\S]*?<\\/div>`, 'gi');

            window.questions.forEach(q => {
                if (q.content && q.content.includes(batchId)) { q.content = q.content.replace(targetRegex, imgTag); }
                if (q.solution && q.solution.includes(batchId)) { q.solution = q.solution.replace(targetRegex, imgTag); }
            });

            pendingImageUploads = pendingImageUploads.filter(item => item.id !== batchId);
            
            renderBatchImageModal();
            window.renderMissingImagesPanel();
            
            if (window.currentQIndex !== -1) loadQuestionToEditor(window.currentQIndex); 
            renderPreviewList(); 
            
            return true;
        }

        document.getElementById('batchFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; 
            if (!file || !currentBatchUploadId) return;

            try {
                window.showToast("Đang tải ảnh lên...", "info"); 
                await uploadAndReplaceImage(file, currentBatchUploadId);
                window.showToast("Cập nhật ảnh thành công!", "success");
            } catch (err) { 
                console.error(err); 
                window.showToast("Lỗi: " + err.message, "error"); 
            } finally { 
                e.target.value = '';
            }
        });

        document.getElementById('folderInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            window.showToast(`Đang phân tích ${files.length} file trong thư mục...`, "info");
            
            let matchCount = 0;
            const btnClose = document.querySelector('#batchImageModal button[onclick="closeBatchImageModal()"]');
            if(btnClose) btnClose.disabled = true;

            const processList = [...pendingImageUploads];

            for (const item of processList) {
                const rawName = item.originalPath.split('/').pop().split('\\').pop();
                const nameKey = rawName.split('.')[0].toLowerCase();
                
                const matchedFile = files.find(f => f.name.toLowerCase().includes(nameKey));

                if (matchedFile) {
                    try {
                        await uploadAndReplaceImage(matchedFile, item.id);
                        matchCount++;
                    } catch (err) { console.error("Lỗi auto upload:", err); }
                }
            }

            if(btnClose) btnClose.disabled = false;
            
            if (matchCount > 0) window.showToast(`Đã tự động ghép và tải lên ${matchCount} ảnh!`, "success");
            else window.showToast("Không tìm thấy ảnh nào khớp tên.", "warning");
            
            e.target.value = '';
        });

        window.loadExamData = async (id) => { 
             try {
                const docSnap = await getDoc(doc(db, "exams", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('settingTitle').value = data.title || '';
                    document.getElementById('settingGrade').value = data.grade || '12';
                    document.getElementById('settingSubject').value = data.subject || 'Toán học';
                    document.getElementById('settingDuration').value = data.duration || 45;
                    document.getElementById('settingPurpose').value = data.purpose || 'exam';
                    document.getElementById('settingStartTime').value = data.startTime || '';
                    document.getElementById('settingEndTime').value = data.endTime || '';
                    document.getElementById('settingPassword').value = data.password || '';
                    document.getElementById('settingAttempts').value = (data.attempts !== undefined) ? data.attempts : 1;
                    document.getElementById('settingProctoring').checked = (data.proctoring === true);
                    document.getElementById('settingShuffle').checked = (data.shuffle !== false);
                    if(data.showScore) document.querySelector(`input[name="settingShowScore"][value="${data.showScore}"]`).checked = true;
                    if(data.showResult) document.querySelector(`input[name="settingShowResult"][value="${data.showResult}"]`).checked = true;
                    const filterBtn = document.getElementById('filterBtnClass');
                    if(data.accessType) {
                        document.querySelector(`input[name="settingAccess"][value="${data.accessType}"]`).checked = true;
                        window.togglePrivasySettings(data.accessType);
                        if (data.accessType === 'class') filterBtn.classList.remove('hidden'); else filterBtn.classList.add('hidden');
                    }
                    
                    // [CẬP NHẬT] Logic load nhiều lớp
                    setTimeout(async () => { 
                        // Lấy danh sách ID lớp (tương thích cả cũ và mới)
                        let selectedIds = [];
                        if (data.allowedClassIds && Array.isArray(data.allowedClassIds)) {
                            selectedIds = data.allowedClassIds;
                        } else if (data.allowedClassId) {
                            selectedIds = [data.allowedClassId]; // Hỗ trợ đề thi cũ
                        }

                        // Tích chọn vào các checkbox tương ứng
                        selectedIds.forEach(id => {
                            const cb = document.querySelector(`.class-checkbox[value="${id}"]`);
                            if(cb) cb.checked = true;
                        });

                        // Cập nhật text cho nút lọc thống kê (nếu cần)
                        if(selectedIds.length > 0) filterBtn.textContent = `${selectedIds.length} Lớp`;
                    }, 800); // Tăng delay xíu để đảm bảo list lớp đã load xong

                    window.questions = data.questions || [];
                    window.originalQuestionsData = JSON.parse(JSON.stringify(window.questions));
                    
                    sortQuestionsByType();
                    renderPreviewList();
                    if(window.questions.length > 0) loadQuestionToEditor(0);
                    if(data.status === 'published') {
                        document.getElementById('examStatus').textContent = '• Đã xuất bản';
                        document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                        document.getElementById('publishedLinkArea').classList.remove('hidden');
                        document.getElementById('settingShareLink').value = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + id;
                    }
                }
            } catch(e) { console.error(e); }
        };

        function sortQuestionsByType() {
            const order = { 'mc': 1, 'tf': 2, 'short': 3, 'essay': 4 };
            window.questions.sort((a, b) => (order[a.type] || 99) - (order[b.type] || 99));
        }

        // Hàm ép TikZJax chạy lại để vẽ hình
        // Hàm ép TikZJax chạy lại (Phiên bản cache-busting)
        
        window.renderTikz = () => {
            const scripts = document.querySelectorAll('script[type="text/tikz"]');
            if (scripts.length === 0) return;

            console.log("Đang kích hoạt TikZJax cho " + scripts.length + " hình...");

            // 1. Tìm và xóa thẻ script TikZJax cũ
            const oldScript = document.querySelector('script[src*="tikzjax.js"]');
            if (oldScript) oldScript.remove();

            // 2. Thêm lại thẻ script mới với timestamp để tránh cache
            const newScript = document.createElement('script');
            newScript.src = "https://tikzjax.com/v1/tikzjax.js?v=" + Date.now();
            
            // Log khi tải xong để kiểm tra
            newScript.onload = () => console.log("TikZJax đã tải xong!");
            newScript.onerror = () => console.error("Lỗi tải TikZJax!");
            
            document.head.appendChild(newScript);
        };
        // --- HÀM MỚI: TỰ ĐỘNG SCALE BẢNG CHO VỪA MÀN HÌNH ---
        window.autoScaleTables = () => {
            const wrappers = document.querySelectorAll('.js-scale-wrapper');
            
            wrappers.forEach(wrap => {
                const table = wrap.querySelector('table');
                if (!table) return;

                // 1. Reset để đo chính xác
                table.style.transform = 'none';
                table.style.width = 'auto';
                wrap.style.height = 'auto';

                // 2. Lấy kích thước thực tế
                const containerWidth = wrap.offsetWidth;
                const tableWidth = table.scrollWidth;

                // 3. Nếu bảng to hơn màn hình -> Scale down
                if (tableWidth > containerWidth) {
                    const scale = containerWidth / tableWidth;
                    
                    // Ép nhỏ bảng lại
                    table.style.transform = `scale(${scale})`;
                    
                    // 4. Cập nhật lại chiều cao cho wrapper (vì khi scale, bảng bé lại nhưng wrapper vẫn giữ chiều cao cũ)
                    // Công thức: Chiều cao thực tế * tỷ lệ scale
                    const newHeight = table.scrollHeight * scale;
                    wrap.style.height = `${newHeight}px`;
                    
                    // Cắt bỏ khoảng trắng thừa bên phải do scale để lại
                    wrap.style.overflow = 'hidden'; 
                }
            });
        };
        window.renderPreviewList = () => { 
            const list = document.getElementById('previewList');
            const palette = document.getElementById('quickPalette');
            document.getElementById('totalQCount').textContent = window.questions.length;
            list.innerHTML = ''; palette.innerHTML = '';
            
            if (window.questions.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Chưa có câu hỏi nào.</div>';
                document.getElementById('editorArea').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm"><p>Chọn câu hỏi bên trái để sửa</p></div>';
                document.getElementById('quickPaletteContainer').classList.add('hidden');
                window.currentQIndex = -1;
                return;
            }

            document.getElementById('quickPaletteContainer').classList.remove('hidden');
            let currentType = '';
            
            window.questions.forEach((q, idx) => {
                const pBtn = document.createElement('button');
                pBtn.className = `palette-btn ${idx === window.currentQIndex ? 'active' : ''}`;
                pBtn.textContent = idx + 1;
                pBtn.onclick = () => loadQuestionToEditor(idx);
                palette.appendChild(pBtn);

                let typeLabel = q.type === 'mc' ? 'TRẮC NGHIỆM' : (q.type === 'tf' ? 'ĐÚNG/SAI' : (q.type === 'short' ? 'TRẢ LỜI NGẮN' : 'TỰ LUẬN'));
                if (q.type !== currentType) {
                    currentType = q.type;
                    const header = document.createElement('div');
                    header.className = "group-header text-xs font-bold text-gray-500 uppercase mb-2 pl-1";
                    header.textContent = `PHẦN: ${typeLabel}`;
                    list.appendChild(header);
                }

                const div = document.createElement('div');
                div.className = `preview-item p-4 rounded-lg mb-3 text-sm relative ${idx === window.currentQIndex ? 'active' : ''}`;
                div.id = `q-preview-${idx}`;
                div.onclick = () => loadQuestionToEditor(idx);
                
                let html = `
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-blue-600">Câu ${idx+1}</span>
                        <span class="bg-orange-100 text-orange-600 text-xs px-2 py-0.5 rounded font-bold">${q.point || 0}đ</span>
                    </div>
                    <div class="mb-3 text-gray-800">${formatContent(q.content)}</div>
                `;

                if (q.type === 'mc' && q.options) {
                    html += `<div class="grid grid-cols-2 gap-2 text-xs text-gray-600">`;
                    q.options.forEach((o, i) => {
                        const isCorrect = i === q.correct;
                        html += `<div class="${isCorrect ? 'text-green-600 font-bold' : ''}">${String.fromCharCode(65+i)}. ${formatContent(o)}</div>`;
                    });
                    html += `</div>`;
                } else if (q.type === 'tf' && q.statements) {
                    html += `<div class="mt-2 space-y-1">`;
                    q.statements.forEach((s, i) => {
                        html += `<div class="flex justify-between text-xs border-b border-dashed border-gray-100 pb-1">
                            <span class="flex-1 mr-2 text-gray-700">- ${formatContent(s.text)}</span>
                            <span class="font-bold ${s.isTrue ? 'text-green-600' : 'text-red-500'} whitespace-nowrap">${s.isTrue ? 'Đúng' : 'Sai'}</span>
                        </div>`;
                    });
                    html += `</div>`;
                } else if (q.type === 'short') {
                    html += `<div class="text-xs text-green-600 mt-2"><b>Đ/A:</b> ${q.answer}</div>`;
                }

                if (q.solution) {
                    html += `<div class="mt-3 pt-2 border-t border-dashed border-gray-200 text-xs text-gray-500">
                        <b class="text-green-600"><i class="fa-solid fa-lightbulb"></i> Lời giải:</b> ${formatContent(q.solution)}
                    </div>`;
                }
                div.innerHTML = html;
                list.appendChild(div);
            });
            if(window.MathJax) MathJax.typesetPromise([list]).catch(e=>{});
            // Thay vì chỉ gọi mỗi renderTikz(), anh gọi cả hai:
            setTimeout(() => {
                window.renderTikz();
                window.autoScaleTables(); // <--- Thêm dòng này
            }, 500);
        };

        window.saveCurrentQuestionToMemory = () => { 
            if (window.currentQIndex === -1 || !window.questions[window.currentQIndex]) return;
            const q = window.questions[window.currentQIndex];
            const contentEl = document.getElementById('editContent'); if (!contentEl) return; 
            q.content = contentEl.value;
            const solEl = document.getElementById('editSolution'); if(solEl) q.solution = solEl.value;
            const pointEl = document.getElementById('editPoint'); if(pointEl) q.point = parseFloat(pointEl.value) || 0;
            if (q.type === 'mc') { const optInputs = document.querySelectorAll('.mc-option'); q.options = Array.from(optInputs).map(i => i.value); } 
            else if (q.type === 'tf') { const rows = document.querySelectorAll('#editorArea .flex.items-center.border'); q.statements = []; rows.forEach(row => { const text = row.querySelector('.tf-text').value; const isTrue = row.querySelector('.tf-check').checked; q.statements.push({text, isTrue}); }); } 
            else if (q.type === 'short') { const ansEl = document.getElementById('editShortAns'); if(ansEl) q.answer = ansEl.value; }
        };

        window.loadQuestionToEditor = (index) => { 
            if (window.currentQIndex !== -1 && window.currentQIndex !== index) saveCurrentQuestionToMemory();
            window.currentQIndex = index;
            renderPreviewList(); 
            setTimeout(() => { const activeItem = document.getElementById(`q-preview-${index}`); if(activeItem) activeItem.scrollIntoView({behavior: 'smooth', block: 'nearest'}); }, 100);
            const q = window.questions[index];
            const editor = document.getElementById('editorArea');
            let html = `<div class="mb-4"><label class="form-group-title">Nội dung</label><textarea id="editContent" class="form-input min-h-[120px]" oninput="autoSaveMemory()">${q.content || ''}</textarea></div>`;
            if (q.type === 'mc') {
                html += `<div class="grid grid-cols-1 gap-3 mb-4">`;
                const opts = q.options || ["", "", "", ""];
                opts.forEach((opt, i) => { html += `<div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full border flex items-center justify-center font-bold cursor-pointer ${q.correct === i ? 'bg-blue-600 text-white' : 'bg-gray-50'}" onclick="setCorrectMC(${i})">${String.fromCharCode(65+i)}</div><input type="text" class="form-input mc-option" value="${opt}" placeholder="Phương án ${String.fromCharCode(65+i)}" oninput="autoSaveMemory()"></div>`; });
                html += `</div>`;
            } else if (q.type === 'tf') {
                html += `<div class="space-y-2 mb-4">`;
                const stmts = q.statements || [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}];
                stmts.forEach((s, i) => { html += `<div class="flex items-center gap-2 border p-2 rounded"><span class="font-bold text-xs text-gray-400 w-4">${i+1}</span><input type="text" class="form-input tf-text" value="${s.text}" oninput="autoSaveMemory()"><label class="flex items-center gap-1"><input type="checkbox" class="w-4 h-4 tf-check" ${s.isTrue?'checked':''} onchange="autoSaveMemory()"><span class="text-xs font-bold text-green-600">Đúng</span></label></div>`; });
                html += `</div>`;
            } else if (q.type === 'short') {
                html += `<div class="mb-4"><label class="form-group-title">Đáp án mẫu</label><input type="text" id="editShortAns" class="form-input font-bold text-green-700" value="${q.answer || ''}" oninput="autoSaveMemory()"></div>`;
            }
            html += `<div class="mb-4"><label class="form-group-title">Lời giải</label><textarea id="editSolution" class="form-input min-h-[80px]" oninput="autoSaveMemory()">${q.solution || ''}</textarea></div>`;
            html += `<div class="mb-4 w-1/3"><label class="form-group-title">Điểm</label><input type="number" id="editPoint" class="form-input font-bold text-orange-600" value="${q.point || 0}" step="0.1" oninput="autoSaveMemory()"></div>`;
            editor.innerHTML = html;
            setTimeout(() => window.renderTikz(), 200);
        };

        window.addNewQuestion = (type) => { if (window.currentQIndex !== -1) saveCurrentQuestionToMemory(); const newQ = { type: type, content: "", solution: "", point: 0 }; if (type === 'mc') { newQ.options = ["", "", "", ""]; newQ.correct = -1; } if (type === 'tf') { newQ.statements = [{text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}, {text:"", isTrue:false}]; } if (type === 'short') { newQ.answer = ""; } window.questions.push(newQ); sortQuestionsByType(); renderPreviewList(); loadQuestionToEditor(window.questions.length - 1); };
        window.autoSaveMemory = () => { saveCurrentQuestionToMemory(); };
        window.setCorrectMC = (idx) => { window.questions[window.currentQIndex].correct = idx; loadQuestionToEditor(window.currentQIndex); };
        window.deleteCurrentQuestion = async () => { if (window.currentQIndex === -1) return; if(await window.customConfirm("Xóa câu hỏi này?")) { window.questions.splice(window.currentQIndex, 1); window.currentQIndex = -1; renderPreviewList(); document.getElementById('editorArea').innerHTML = ''; } };

        function cleanLatex(text) { if (!text) return ""; let cleaned = text.replace(/^%.*$/gm, '').replace(/(?<!\\)%.*/g, '').replace(/^\s*\[.*?\]/gm, ''); return cleaned.trim(); }
        
        // --- [FIX QUAN TRỌNG] HÀM XỬ LÝ UPLOAD FILE ---
        // Sửa lỗi: Cắt cụt nội dung do array gây rối loạn đếm ngoặc
        // --- HÀM MỚI: HIỂN THỊ PANEL ẢNH CÒN THIẾU ---
        window.renderMissingImagesPanel = () => {
            const panel = document.getElementById('missingImagesPanel');
            const grid = document.getElementById('missingImagesGrid');
            const countDisplay = document.getElementById('missingCountDisplay');
            
            if (!panel || !grid) return;

            // LỌC: Chỉ lấy ảnh TikZ
            const tikzImages = pendingImageUploads.filter(item => item.type === 'tikz');

            if (tikzImages.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');
            countDisplay.textContent = tikzImages.length;
            grid.innerHTML = '';

            tikzImages.forEach(item => {
                const btn = document.createElement('button');
                btn.textContent = item.questionIdx + 1; 
                btn.className = "w-full aspect-square flex items-center justify-center bg-white border border-gray-300 rounded font-bold text-gray-600 hover:bg-orange-100 hover:border-orange-500 hover:text-orange-600 transition-all text-xs shadow-sm";
                
                btn.onclick = () => {
                    loadQuestionToEditor(item.questionIdx);
                    setTimeout(() => {
                        const placeholder = document.querySelector(`.image-placeholder[data-id="${item.id}"]`);
                        if (placeholder) {
                            placeholder.scrollIntoView({behavior: "smooth", block: "center"});
                            placeholder.focus();
                            placeholder.classList.add('ring-4', 'ring-orange-400');
                            setTimeout(() => placeholder.classList.remove('ring-4', 'ring-orange-400'), 1000);
                        }
                    }, 300);
                };
                grid.appendChild(btn);
            });
        };
        window.handleTexUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            
            reader.onload = function(e) { 
                if (window.currentQIndex !== -1) saveCurrentQuestionToMemory();
                let content = e.target.result;
                content = content.replace(/(?<!\\)%.*/g, ''); 

                content = content.replace(/\\begin\{array\}\s*\{[^{}]*?\}/g, '\\begin{matrix}');
                content = content.replace(/\\begin\{array\}/g, '\\begin{matrix}');
                content = content.replace(/\\end\{array\}/g, '\\end{matrix}');

                pendingImageUploads = [];
                const blockRegex = /\\begin\{(ex|bt|vd)\}([\s\S]*?)\\end\{\1\}/g;
                let match, count = 0;
                
                while ((match = blockRegex.exec(content)) !== null) {
                    let fullBody = match[2];
                    fullBody = fullBody.replace(/^\s*\[.*?\]/, ''); 
                    
                    let qType = 'essay'; 
                    let qData = { content: '', solution: '', options: [], statements: [], answer: '', point: 0 };
                    
                    let mainContent = fullBody;
                    const loigiaiIndex = fullBody.lastIndexOf('\\loigiai');
                    
                    if (loigiaiIndex !== -1) {
                        mainContent = fullBody.substring(0, loigiaiIndex);
                        const solPart = fullBody.substring(loigiaiIndex);
                        const solBrace = extractNextBrace(solPart);
                        if (solBrace) {
                            qData.solution = processLatexImagesWithDetection(cleanTikzCode(solBrace.content), count);
                        }
                    }
                    
                    let procBody = processLatexImagesWithDetection(cleanTikzCode(mainContent), count);
                    
                    if (procBody.includes('\\choiceTF')) {
                        qType = 'tf'; 
                        const parts = procBody.split('\\choiceTF'); 
                        qData.content = parts[0].trim();
                        let remainingText = parts[1];
                        while(true) {
                            const brace = extractNextBrace(remainingText);
                            if (!brace) break;
                            qData.statements.push({text: brace.content.replace('\\True', '').trim(), isTrue: brace.content.includes('\\True')});
                            remainingText = brace.remaining;
                        }
                    } else if (procBody.includes('\\choice')) {
                        qType = 'mc'; 
                        const parts = procBody.split('\\choice'); 
                        qData.content = parts[0].trim();
                        let remainingText = parts[1];
                        let optCount = 0;
                        while(optCount < 4) {
                            const brace = extractNextBrace(remainingText);
                            if (!brace) break;
                            if (brace.content.includes('\\True')) qData.correct = optCount;
                            qData.options.push(brace.content.replace('\\True', '').trim());
                            remainingText = brace.remaining;
                            optCount++;
                        }
                    } else if (procBody.includes('\\shortans')) {
                        qType = 'short'; 
                        const parts = procBody.split('\\shortans'); 
                        qData.content = parts[0].trim();
                        const ans = extractNextBrace(procBody.substring(procBody.indexOf('\\shortans')));
                        if(ans) qData.answer = ans.content;
                    } else { 
                        qType = 'essay'; 
                        qData.content = procBody; 
                    }
                    window.questions.push({ type: qType, ...qData }); count++;
                }
                
                sortQuestionsByType(); 
                renderPreviewList(); 
                window.showToast(`Đã nhập ${count} câu hỏi!`); 
                input.value = "";
                
                if(window.MathJax) MathJax.typesetPromise();
                setTimeout(() => {
                    window.renderTikz();
                    window.autoScaleTables();
                }, 500);
                
                // --- LOGIC KÍCH HOẠT KÉP ---
                // 1. Nếu có ảnh thường -> Hiện Modal to
                if (pendingImageUploads.some(i => i.type === 'normal')) {
                    renderBatchImageModal();
                }
                
                // 2. Nếu có ảnh TikZ -> Hiện Panel nhỏ
                if (pendingImageUploads.some(i => i.type === 'tikz')) {
                    window.renderMissingImagesPanel();
                }
            };
            reader.readAsText(file);
        }

        function getAllImageUrls(dataObj) {
            const str = JSON.stringify(dataObj);
            const regex = /https:\/\/firebasestorage\.googleapis\.com\/v0\/b\/[^"'\s\\]+/g;
            return str.match(regex) || [];
        }

        window.saveExam = async function(status) { 
            if (window.currentQIndex !== -1) saveCurrentQuestionToMemory(); 
            const title = document.getElementById('settingTitle').value;
            if(!title) return window.customAlert("Vui lòng nhập tên đề thi!", "error");
            const btn = status === 'published' ? document.getElementById('btnPublish') : document.getElementById('btnSaveDraft');
            const originalText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...'; btn.disabled = true;
            const settings = {
                title: title, grade: document.getElementById('settingGrade').value, subject: document.getElementById('settingSubject').value,
                duration: parseInt(document.getElementById('settingDuration').value) || 0, purpose: document.getElementById('settingPurpose').value,
                startTime: document.getElementById('settingStartTime').value, endTime: document.getElementById('settingEndTime').value,
                password: document.getElementById('settingPassword').value, attempts: parseInt(document.getElementById('settingAttempts').value) || 0,
                proctoring: document.getElementById('settingProctoring').checked, shuffle: document.getElementById('settingShuffle').checked,
                showScore: document.querySelector('input[name="settingShowScore"]:checked').value, showResult: document.querySelector('input[name="settingShowResult"]:checked').value,
                accessType: document.querySelector('input[name="settingAccess"]:checked').value, 
                // [CẬP NHẬT] Lưu mảng các ID lớp học
                allowedClassIds: Array.from(document.querySelectorAll('.class-checkbox:checked')).map(cb => cb.value)
            };
            try {
                if (currentExamId && window.originalQuestionsData.length > 0) {
                    const oldImages = getAllImageUrls(window.originalQuestionsData);
                    const newImages = getAllImageUrls(window.questions);
                    
                    const deletedImages = oldImages.filter(url => !newImages.includes(url));
                    
                    if (deletedImages.length > 0) {
                        Promise.all(deletedImages.map(url => {
                            try { return deleteObject(ref(storage, url)).catch(e => console.log("Ignore delete err", e)); }
                            catch(e) { return Promise.resolve(); }
                        }));
                    }
                }
                sessionUploadedFiles = [];
                window.originalQuestionsData = JSON.parse(JSON.stringify(window.questions));

                const examRef = currentExamId ? doc(db, "exams", currentExamId) : doc(collection(db, "exams"));
                await setDoc(examRef, { ...settings, teacherId: currentUser.uid, questions: window.questions, questionCount: window.questions.length, status: status, updatedAt: new Date().toISOString(), ...(currentExamId ? {} : { createdAt: new Date().toISOString() }) }, { merge: true });
                currentExamId = examRef.id; document.getElementById('sidebarExamTitle').textContent = title;
                if (status === 'published') {
                    const link = window.location.origin + window.location.pathname.replace('exam-editor.html', 'exam.html') + '?id=' + currentExamId;
                    document.getElementById('shareLinkInput').value = link; document.getElementById('shareModal').classList.remove('opacity-0', 'pointer-events-none');
                    document.getElementById('shareModal').querySelector('div').classList.add('scale-100');
                    document.getElementById('examStatus').textContent = '• Đã xuất bản'; document.getElementById('examStatus').classList.replace('text-orange-500', 'text-green-600');
                    document.getElementById('publishedLinkArea').classList.remove('hidden'); document.getElementById('settingShareLink').value = link;
                } else { window.showToast("Đã lưu bản nháp thành công!", "success"); }
                if (!window.location.search.includes('id=')) window.history.pushState({path:window.location.href.split('?')[0] + '?id=' + currentExamId},'',window.location.href.split('?')[0] + '?id=' + currentExamId);
            } catch(e) { console.error(e); window.customAlert("Lỗi lưu: " + e.message, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        window.loadStats = async () => { 
            if (!currentExamId) return; const qRes = query(collection(db, "results"), where("examId", "==", currentExamId)); const snapRes = await getDocs(qRes);
            statsMap = {}; snapRes.forEach(doc => { const r = doc.data(); const key = r.studentId || r.studentName; if (!statsMap[key]) { statsMap[key] = { ...r, attempts: [r], bestScore: r.score }; } else { statsMap[key].attempts.push(r); if (r.score > statsMap[key].bestScore) { statsMap[key].bestScore = r.score; statsMap[key].score = r.score; } } });
            renderStatsDashboard();
        };

        window.renderStatsDashboard = () => { 
            const uniqueStudents = Object.values(statsMap); const totalSubs = uniqueStudents.length;
            let totalScore = 0; uniqueStudents.forEach(r => totalScore += r.bestScore); const avg = totalSubs > 0 ? (totalScore / totalSubs).toFixed(2) : 0;
            const scores = uniqueStudents.map(r => r.bestScore); const maxScore = scores.length > 0 ? Math.max(...scores) : 0; const minScore = scores.length > 0 ? Math.min(...scores) : 0;
            document.getElementById('statTotalSubmissions').textContent = totalSubs; document.getElementById('statAvgScore').textContent = avg;
            document.getElementById('statMaxScore').textContent = maxScore; document.getElementById('statMinScore').textContent = minScore;
            const spectrum = Array(11).fill(0); scores.forEach(s => spectrum[Math.floor(s)]++);
            const ctx = document.getElementById('scoreChart').getContext('2d'); if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'bar', data: { labels: ['0-1', '1-2', '2-3', '3-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10', '10'], datasets: [{ label: 'Số lượng', data: spectrum, backgroundColor: '#3B82F6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
            const qStats = window.questions.map(() => ({ correct: 0, total: 0 }));
            Object.values(statsMap).forEach(student => { student.attempts.forEach(attempt => { if(attempt.answers) { window.questions.forEach((q, idx) => { const u = attempt.answers[idx]; if (u !== undefined && u !== null) { qStats[idx].total++; let isCorrect = false; if (q.type === 'mc' && u === q.correct) isCorrect = true; else if (q.type === 'short' && q.answer && String(u).trim().toLowerCase() === String(q.answer).trim().toLowerCase()) isCorrect = true; else if (q.type === 'tf') { let matches = 0; if(Array.isArray(u)) q.statements.forEach((s, i) => { if(u[i]===s.isTrue) matches++; }); if(matches === 4) isCorrect = true; } if (isCorrect) qStats[idx].correct++; } }); } }); });
            const qListDiv = document.getElementById('questionAnalysisList'); qListDiv.innerHTML = '';
            qStats.forEach((stat, idx) => { const percent = stat.total > 0 ? Math.round((stat.correct / stat.total) * 100) : 0; const colorClass = percent > 80 ? 'bg-green-500' : (percent > 50 ? 'bg-yellow-500' : 'bg-red-500'); qListDiv.innerHTML += `<div class="flex items-center gap-2 text-xs"><span class="w-10 font-bold text-gray-500">Câu ${idx+1}</span><div class="flex-1 progress-bar-bg"><div class="progress-bar-fill ${colorClass}" style="width: ${percent}%"></div></div><span class="w-8 text-right font-bold text-gray-700">${percent}%</span></div>`; });
            renderStatsTable();
        };

        window.filterStats = (type) => {
            document.getElementById('filterBtnAll').className = type === 'all' ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm" : "px-3 py-1.5 rounded-lg text-sm font-bold bg-white text-gray-600 border hover:bg-gray-100";
            document.getElementById('filterBtnClass').className = type === 'class' ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm" : "px-3 py-1.5 rounded-lg text-sm font-bold bg-white text-gray-600 border hover:bg-gray-100";
            renderStatsTable(type);
        };

        window.renderStatsTable = (filterType = 'all') => {
            const tbody = document.getElementById('statsTableBody'); tbody.innerHTML = '';
            let dataToShow = Object.values(statsMap);
            const allowedClassId = document.getElementById('settingClassSelect').value;
            if (filterType === 'class' && allowedClassId && classStudentList.length > 0) {
                dataToShow = classStudentList.map(st => { const match = dataToShow.find(d => (d.studentName === st.name) || (st.username && d.studentName.includes(st.username))); if (match) return { ...match, status: 'Đã làm' }; return { studentName: st.name, score: '--', submittedAt: null, status: 'Chưa làm', attempts: [] }; });
            }
            const sortType = document.getElementById('sortStats').value;
            dataToShow.sort((a, b) => { const sA = parseFloat(a.score) || 0; const sB = parseFloat(b.score) || 0; if (sortType === 'score_desc') return sB - sA; if (sortType === 'score_asc') return sA - sB; if (sortType === 'time_desc') return new Date(b.submittedAt || 0) - new Date(a.submittedAt || 0); });
            dataToShow.forEach(r => { const dateStr = r.submittedAt ? new Date(r.submittedAt).toLocaleString('vi-VN') : '--'; const scoreClass = r.status === 'Chưa làm' ? 'text-gray-400' : (r.score >= 8 ? 'text-green-600' : (r.score >= 5 ? 'text-blue-600' : 'text-red-500')); const attemptCount = r.attempts ? r.attempts.length : 0; const nameHtml = attemptCount > 0 ? `<button onclick="showStudentHistory('${r.studentName}')" class="font-bold text-blue-600 hover:underline">${r.studentName}</button>` : r.studentName; tbody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-3 font-medium text-gray-900">${nameHtml} <span class="text-xs text-gray-400 ml-1">${r.status || ''}</span></td><td class="px-6 py-3 text-center font-bold ${scoreClass}">${r.score}</td><td class="px-6 py-3 text-center text-xs text-gray-500">${attemptCount}</td><td class="px-6 py-3 text-right text-xs text-gray-500">${dateStr}</td></tr>`; });
        };
        
        window.showStudentHistory = (studentName) => {
            const studentData = Object.values(statsMap).find(s => s.studentName === studentName);
            if (!studentData || !studentData.attempts) return;
            const modal = document.getElementById('historyModal'); const content = document.getElementById('histModalContent'); const title = document.getElementById('histModalTitle');
            title.textContent = `Lịch sử: ${studentName}`; content.innerHTML = `<table class="w-full text-sm text-left text-gray-600"><thead class="bg-gray-100"><tr><th class="p-2">Lần</th><th class="p-2 text-center">Điểm</th><th class="p-2 text-right">Ngày nộp</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table>`;
            const tbody = content.querySelector('tbody'); const sortedAttempts = [...studentData.attempts].sort((a,b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            sortedAttempts.forEach((att, idx) => { tbody.innerHTML += `<tr><td class="p-2">#${sortedAttempts.length - idx}</td><td class="p-2 text-center font-bold text-blue-600">${att.score}</td><td class="p-2 text-right text-xs">${new Date(att.submittedAt).toLocaleString('vi-VN')}</td></tr>`; });
            modal.classList.remove('opacity-0', 'pointer-events-none'); modal.querySelector('div').classList.add('scale-100');
        };
        window.closeHistoryModal = () => { document.getElementById('historyModal').classList.add('opacity-0', 'pointer-events-none'); };
        window.exportToExcel = () => { if (Object.keys(statsMap).length === 0) return window.showToast("Chưa có dữ liệu để xuất!", "error"); const wb = XLSX.utils.book_new(); const dataSummary = Object.values(statsMap).map((r, i) => ({ "STT": i + 1, "Họ tên": r.studentName, "Điểm cao nhất": r.bestScore, "Số lần thi": r.attempts.length, "Ngày nộp cuối": new Date(r.submittedAt).toLocaleString('vi-VN') })); const wsSummary = XLSX.utils.json_to_sheet(dataSummary); XLSX.utils.book_append_sheet(wb, wsSummary, "Tong_Hop"); XLSX.writeFile(wb, `KetQua_${document.getElementById('settingTitle').value.replace(/\s/g, '_')}.xlsx`); };

        window.switchView = (viewId) => { document.getElementById('view-settings').classList.add('hidden'); document.getElementById('view-editor').classList.add('hidden'); document.getElementById('view-editor').classList.remove('flex'); document.getElementById('view-stats').classList.add('hidden'); document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active')); if (viewId === 'settings') { document.getElementById('view-settings').classList.remove('hidden'); document.getElementById('menu-settings').classList.add('active'); } else if (viewId === 'editor') { document.getElementById('view-editor').classList.remove('hidden'); document.getElementById('view-editor').classList.add('flex'); document.getElementById('menu-editor').classList.add('active'); if(window.MathJax) MathJax.typesetPromise(); } else if (viewId === 'stats') { document.getElementById('view-stats').classList.remove('hidden'); document.getElementById('menu-stats').classList.add('active'); loadStats(); } };
        window.copyLink = () => { document.getElementById("shareLinkInput").select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); };
        window.copySettingLink = () => { document.getElementById("settingShareLink").select(); document.execCommand("copy"); window.showToast("Đã sao chép link!"); };
        window.closeShareModal = () => { document.getElementById('shareModal').classList.add('opacity-0', 'pointer-events-none'); };
        window.showToast = (message, type='success') => { const c = document.getElementById('toastContainer'); const d = document.createElement('div'); d.className = `bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 flex items-center gap-3 min-w-[300px] transform translate-x-full transition-transform duration-300`; d.innerHTML = `<div><h4 class="font-bold text-gray-800 text-sm">THÔNG BÁO</h4><p class="text-sm text-gray-600">${message}</p></div>`; c.appendChild(d); requestAnimationFrame(()=>d.classList.remove('translate-x-full')); setTimeout(()=>{d.classList.add('translate-x-full'); setTimeout(()=>d.remove(), 500);}, 3000); };
        window.togglePrivasySettings = (type) => { document.getElementById('classSelectionArea').className = type === 'class' ? 'pl-6 block mt-2' : 'hidden'; };
        
        // [CẬP NHẬT] Hàm load danh sách lớp dạng Checkbox
        async function loadTeacherClasses() { 
            const container = document.getElementById('classCheckboxList'); 
            if (!currentUser || !container) return; 
            const q = query(collection(db, "classes"), where("teacherId", "==", currentUser.uid)); 
            const snap = await getDocs(q); 
            container.innerHTML = ''; 
            
            if(snap.empty) {
                container.innerHTML = '<p class="text-xs text-red-500 p-2">Thầy cô chưa tạo lớp học nào.</p>';
                return;
            }

            snap.forEach(doc => { 
                const cls = doc.data();
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-1.5 hover:bg-white rounded cursor-pointer';
                div.innerHTML = `
                    <input type="checkbox" id="cls_${doc.id}" value="${doc.id}" class="class-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                    <label for="cls_${doc.id}" class="text-sm text-gray-700 font-bold cursor-pointer select-none flex-1">${cls.name}</label>
                `;
                container.appendChild(div);
            }); 
        };

        window.toggleSidebar = () => { const s = document.getElementById('mainSidebar'); const o = document.getElementById('sidebarOverlay'); if (s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o.classList.add('hidden'); } };
        window.openScoringModal = () => { document.getElementById('scoringModal').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('scoringModal').querySelector('div').classList.add('scale-100'); let cM=0, cTF=0, cE=0; let h=''; window.questions.forEach((q,i)=>{ if(q.type==='essay'){ cE++; h+=`<div class="flex items-center gap-2 text-sm"><span class="w-16 font-bold">Câu ${i+1}</span><input type="number" id="essay-score-${i}" class="form-input h-8 text-right w-20" value="${q.point||0}" step="0.1"></div>`; } else if(q.type==='tf') cTF++; else cM++; }); document.getElementById('countMcShort').textContent=cM; document.getElementById('countTF').textContent=cTF; document.getElementById('countEssay').textContent=cE; document.getElementById('essayScoreList').innerHTML = cE>0 ? h : '<p class="text-xs text-gray-400 italic">Không có câu tự luận.</p>'; };
        window.closeScoringModal = () => { document.getElementById('scoringModal').classList.add('opacity-0', 'pointer-events-none'); };
        window.applyScoring = () => { const tM = parseFloat(document.getElementById('scoreTotalMcShort').value)||0; const tTF = parseFloat(document.getElementById('scoreTotalTF').value)||0; let cM=0, cTF=0; window.questions.forEach(q=>{if(q.type==='mc'||q.type==='short')cM++; else if(q.type==='tf')cTF++;}); const pM=cM>0?(tM/cM):0; const pTF=cTF>0?(tTF/cTF):0; window.questions.forEach((q,i)=>{ if(q.type==='mc'||q.type==='short') q.point=parseFloat(pM.toFixed(2)); else if(q.type==='tf') q.point=parseFloat(pTF.toFixed(2)); else if(q.type==='essay'){ const inp=document.getElementById(`essay-score-${i}`); if(inp) q.point=parseFloat(inp.value)||0; } }); closeScoringModal(); renderPreviewList(); window.showToast("Đã chia điểm!"); };
        
        window.handleBackNavigation = async () => {
            const hasUnsavedChanges = JSON.stringify(window.questions) !== JSON.stringify(window.originalQuestionsData);
            const hasPendingImages = sessionUploadedFiles.length > 0;

            if (hasUnsavedChanges || hasPendingImages) {
                const confirmLeave = await window.customConfirm(
                    "Bạn chưa lưu thay đổi.\nNếu thoát bây giờ, các ảnh vừa tải lên sẽ bị XÓA BỎ VĨNH VIỄN.\nBạn có chắc chắn muốn thoát?"
                );

                if (confirmLeave) {
                    if (hasPendingImages) {
                        // Hiển thị loading chặn màn hình
                        const toast = document.createElement('div');
                        toast.className = 'fixed inset-0 bg-black/50 z-[200] flex items-center justify-center';
                        toast.innerHTML = '<div class="bg-white p-6 rounded-xl flex flex-col items-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i><p class="font-bold">Đang dọn dẹp dữ liệu rác...</p></div>';
                        document.body.appendChild(toast);
                        
                        try {
                            // Bắt buộc trình duyệt đợi xóa xong
                            await Promise.all(sessionUploadedFiles.map(key => deleteR2Image(key)));
                            // Xóa xong thì làm rỗng mảng để sự kiện pagehide không chạy trùng
                            sessionUploadedFiles = []; 
                        } catch(e) { console.log("Lỗi dọn dẹp:", e); }
                    }
                    window.location.href = 'dashboard.html?view=exambank';
                }
            } else {
                window.location.href = 'dashboard.html?view=exambank';
            }
        };
        
        // Sự kiện dự phòng: Xử lý khi bấm F5 hoặc tắt Tab
        window.addEventListener('pagehide', () => {
            if (sessionUploadedFiles.length > 0) {
                // Sử dụng sendBeacon hoặc fetch keepalive
                sessionUploadedFiles.forEach(key => deleteR2Image(key));
            }
        });      
        // Hàm xóa ảnh trên R2 (Phiên bản chuẩn)
        async function deleteR2Image(input) {
            if (!input) return;
            try {
                let keyName = input;
                
                // Nếu là URL đầy đủ, trích xuất phần Key
                if (input.startsWith('http')) {
                    try {
                        const urlObj = new URL(input);
                        // pathname sẽ là /images/file.jpg -> cắt bỏ dấu / ở đầu
                        keyName = urlObj.pathname.substring(1); 
                        keyName = decodeURIComponent(keyName);
                    } catch(e) { console.warn("Lỗi parse URL:", input); }
                }
                
                console.log("Đang xóa Key:", keyName); // F12 để kiểm tra

                // Gửi lệnh xóa với keepalive để sống sót qua sự kiện F5
                return fetch(`https://upload-helper.phamngockhanh-942001.workers.dev/?key=${encodeURIComponent(keyName)}`, {
                    method: 'DELETE',
                    keepalive: true 
                });
            } catch (e) { console.error("Lỗi xóa R2:", e); }
        }
        // Tự động scale lại bảng khi xoay màn hình hoặc đổi kích thước cửa sổ
        window.addEventListener('resize', () => {
            window.autoScaleTables();
        });
        // --- XỬ LÝ DÁN ẢNH TRỰC TIẾP (CTRL + V) ---
        document.addEventListener('paste', async (e) => {
            // 1. Kiểm tra xem người dùng đang focus vào ô placeholder nào không
            const activeEl = document.activeElement;
            
            // Nếu không phải là ô placeholder thì bỏ qua
            if (!activeEl || !activeEl.classList.contains('image-placeholder')) return;

            const id = activeEl.getAttribute('data-id');
            if (!id) return;

            // 2. Lấy dữ liệu từ clipboard
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault(); // Chặn hành vi dán mặc định
                    
                    const file = item.getAsFile();
                    
                    // Hiệu ứng đang tải ngay tại ô đó
                    const originalContent = activeEl.innerHTML;
                    activeEl.innerHTML = '<div class="animate-bounce text-blue-600"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><p class="text-xs mt-2 font-bold">Đang xử lý ảnh...</p></div>';
                    
                    try {
                        window.showToast("Đang tải ảnh từ bộ nhớ tạm...", "info");
                        await uploadAndReplaceImage(file, id);
                        window.showToast("Dán ảnh thành công!", "success");
                    } catch (err) {
                        console.error(err);
                        activeEl.innerHTML = originalContent; // Khôi phục nếu lỗi
                        window.showToast("Lỗi dán ảnh: " + err.message, "error");
                    }
                    return; // Chỉ xử lý 1 ảnh đầu tiên tìm thấy
                }
            }
        });
    </script>
    <div id="missingImagesPanel" class="hidden fixed bottom-4 right-4 z-50 bg-white border-2 border-orange-500 shadow-2xl rounded-xl w-64 overflow-hidden flex flex-col max-h-[60vh]">
        <div class="bg-orange-500 text-white p-3 flex justify-between items-center shadow-sm">
            <h4 class="font-bold text-sm"><i class="fa-solid fa-images mr-2"></i>Ảnh cần chèn (<span id="missingCountDisplay">0</span>)</h4>
            <button onclick="document.getElementById('missingImagesPanel').classList.add('hidden')" class="hover:text-gray-200"><i class="fa-solid fa-minus"></i></button>
        </div>
        <div class="p-3 bg-gray-50 overflow-y-auto flex-1">
            <div id="missingImagesGrid" class="grid grid-cols-4 gap-2"></div>
        </div>
        <div class="p-2 bg-white text-[10px] text-center text-gray-400 border-t">
            Bấm vào số để đến vị trí ảnh
        </div>
    </div>
</body>
</html>
