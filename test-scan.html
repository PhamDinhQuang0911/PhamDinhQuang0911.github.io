<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scan V2 - L√†m S√°ng ·∫¢nh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        canvas { width: 100%; border: 1px solid #ddd; border-radius: 8px; }
        input[type=range] { width: 100%; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

    <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-6">
        <h1 class="text-xl font-bold text-gray-800 mb-2 text-center">üìÑ Scan: L√†m S√°ng & R√µ Ch·ªØ</h1>
        <div id="status" class="mb-4 text-center text-sm font-bold text-orange-500">
            <i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i b·ªô x·ª≠ l√Ω ·∫£nh...
        </div>

        <label class="block w-full p-4 border-2 border-dashed border-blue-300 rounded-xl bg-blue-50 text-blue-600 font-bold text-center cursor-pointer hover:bg-blue-100 transition-all mb-4">
            <i class="fa-solid fa-camera text-xl mb-1"></i><br>
            Ch·ªçn ·∫£nh b√†i l√†m
            <input type="file" id="fileInput" accept="image/*" class="hidden" disabled>
        </label>

        <div id="editorArea" class="hidden space-y-4">
            <img id="imgSrc" class="hidden">

            <div>
                <p class="text-xs font-bold text-gray-500 mb-2 uppercase">K·∫øt qu·∫£:</p>
                <canvas id="canvasOutput"></canvas>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                <div>
                    <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                        <span>ƒê·ªô l·ªçc nhi·ªÖu (Block Size)</span>
                        <span id="valBlock">15</span>
                    </div>
                    <input type="range" id="rangeBlock" min="3" max="51" step="2" value="15" class="accent-blue-600">
                    <p class="text-[10px] text-gray-400">K√©o tƒÉng l√™n n·∫øu ch·ªØ b·ªã ƒë·ª©t n√©t.</p>
                </div>

                <div>
                    <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                        <span>ƒê·ªô s√°ng (Constant)</span>
                        <span id="valC">10</span>
                    </div>
                    <input type="range" id="rangeC" min="1" max="30" step="1" value="10" class="accent-blue-600">
                    <p class="text-[10px] text-gray-400">K√©o tƒÉng l√™n ƒë·ªÉ x√≥a n·ªÅn x√°m/b√≥ng ƒëen.</p>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="setMode('bw')" class="flex-1 py-2 bg-gray-800 text-white text-xs font-bold rounded hover:bg-black">ƒêen tr·∫Øng (R√µ nh·∫•t)</button>
                    <button onclick="setMode('gray')" class="flex-1 py-2 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300">X√°m (T·ª± nhi√™n)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cvReady = false;
        let currentMode = 'bw'; // bw (Scan) ho·∫∑c gray (Th∆∞·ªùng)

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('status').innerText = "S·∫µn s√†ng!";
            document.getElementById('status').className = "mb-4 text-center text-sm font-bold text-green-600";
            document.getElementById('fileInput').disabled = false;
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (!cvReady || !e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = document.getElementById('imgSrc');
                img.src = ev.target.result;
                img.onload = () => {
                    document.getElementById('editorArea').classList.remove('hidden');
                    processImage(); // X·ª≠ l√Ω ngay khi ·∫£nh load
                }
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        // L·∫Øng nghe thanh tr∆∞·ª£t
        document.getElementById('rangeBlock').oninput = (e) => {
            document.getElementById('valBlock').innerText = e.target.value;
            processImage();
        };
        document.getElementById('rangeC').oninput = (e) => {
            document.getElementById('valC').innerText = e.target.value;
            processImage();
        };

        function setMode(mode) {
            currentMode = mode;
            processImage();
        }

        function processImage() {
            try {
                let src = cv.imread('imgSrc');
                let dst = new cv.Mat();
                
                // 1. Resize n·∫øu ·∫£nh qu√° to (ƒë·ªÉ ch·∫°y nhanh tr√™n ƒëi·ªán tho·∫°i)
                if(src.cols > 1200) {
                    let scale = 1200 / src.cols;
                    let dsize = new cv.Size(src.cols * scale, src.rows * scale);
                    cv.resize(src, src, dsize, 0, 0, cv.INTER_AREA);
                }

                // 2. Chuy·ªÉn sang ·∫£nh x√°m (Grayscale)
                cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY, 0);

                if (currentMode === 'bw') {
                    // --- THU·∫¨T TO√ÅN SCAN ƒêEN TR·∫ÆNG (ADAPTIVE THRESHOLD) ---
                    // ƒê√¢y l√† thu·∫≠t to√°n "th·∫ßn th√°nh" gi√∫p lo·∫°i b·ªè b√≥ng ƒë·ªï
                    
                    let blockSize = parseInt(document.getElementById('rangeBlock').value);
                    let C = parseInt(document.getElementById('rangeC').value);

                    // BlockSize ph·∫£i l√† s·ªë l·∫ª
                    if (blockSize % 2 === 0) blockSize++; 

                    // √Åp d·ª•ng b·ªô l·ªçc
                    // 255: Gi√° tr·ªã m√†u tr·∫Øng t·ªëi ƒëa
                    // ADAPTIVE_THRESH_GAUSSIAN_C: Thu·∫≠t to√°n t√≠nh to√°n th√¥ng minh
                    // THRESH_BINARY: Bi·∫øn m·ªçi th·ª© th√†nh ƒêen ho·∫∑c Tr·∫Øng
                    cv.adaptiveThreshold(src, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, blockSize, C);
                
                } else {
                    // --- CH·∫æ ƒê·ªò X√ÅM T·ª∞ NHI√äN (TƒÉng ƒë·ªô t∆∞∆°ng ph·∫£n + S√°ng) ---
                    // convertScaleAbs(src, dst, alpha, beta)
                    // alpha: ƒê·ªô t∆∞∆°ng ph·∫£n (Contrast) - VD: 1.5
                    // beta: ƒê·ªô s√°ng (Brightness) - VD: 20
                    src.convertTo(dst, -1, 1.5, 30);
                }

                // 3. Hi·ªÉn th·ªã
                cv.imshow('canvasOutput', dst);

                // D·ªçn d·∫πp b·ªô nh·ªõ
                src.delete(); dst.delete();

            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>
