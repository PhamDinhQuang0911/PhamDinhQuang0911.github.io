<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng qu·∫£n l√Ω - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        
        /* Sidebar Active State */
        .nav-item.active { background-color: #FFF7ED; color: #C2410C; border-right: 3px solid #F97316; font-weight: 700; }
        .nav-item i { width: 24px; text-align: center; }

        /* File Explorer Items */
        .explorer-item { transition: all 0.2s; user-select: none; cursor: pointer; }
        .explorer-item:hover { background-color: #EFF6FF; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .explorer-item.drag-over { background-color: #DBEAFE !important; border: 2px dashed #2563EB !important; transform: scale(1.05); z-index: 10; }
        .explorer-item.dragging { opacity: 0.4; border: 2px dashed #9CA3AF; background-color: #F3F4F6; }

        /* Animations */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .notification-toast { animation: slideIn 0.5s ease forwards; }
        .notification-toast.hide { animation: fadeOut 0.5s ease forwards; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800 bg-gray-50">

    <div id="notificationContainer" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-sm flex-shrink-0">
        <div class="h-16 flex items-center gap-3 px-6 border-b border-gray-100">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold shadow-sm">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <span class="text-lg text-orange-600 font-handwriting pt-1">Th·∫ßy Choang</span>
        </div>

        <div class="p-4 border-b border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3 cursor-pointer" onclick="toggleModal('profileModal', true)">
                <img id="sidebarAvatar" src="https://via.placeholder.com/150" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                <div class="overflow-hidden">
                    <p id="sidebarName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p id="sidebarRole" class="text-xs text-gray-500 truncate">...</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="switchView('home')" id="nav-home" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 active">
                <i class="fa-solid fa-house"></i> S·∫£nh ch√≠nh
            </button>
            
            <div id="teacherMenu" class="hidden">
                <div class="px-6 mt-4 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Qu·∫£n l√Ω</div>
                <button onclick="switchView('classes')" id="nav-classes" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-chalkboard-user"></i> Danh s√°ch l·ªõp h·ªçc
                </button>
                <button onclick="switchView('exambank')" id="nav-exambank" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-folder-tree"></i> Ng√¢n h√†ng ƒë·ªÅ thi
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtn" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <div id="view-home" class="view-section flex-1 overflow-y-auto p-8">
            <div class="max-w-6xl mx-auto">
                <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-8 text-white mb-10 shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-3xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</h1>
                        <p class="opacity-90">S·∫µn s√†ng chinh ph·ª•c ƒë·ªânh cao tri th·ª©c h√¥m nay ch∆∞a?</p>
                    </div>
                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10"></div>
                    <div class="absolute bottom-0 right-20 w-32 h-32 rounded-full bg-white opacity-10"></div>
                </div>

                <div id="studentMyClasses" class="hidden mt-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-blue-500 pl-4">L·ªõp h·ªçc c·ªßa t√¥i</h2>
                    <div id="studentClassList" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <p class="text-gray-400 italic col-span-3">ƒêang t·∫£i danh s√°ch l·ªõp...</p>
                    </div>
                </div>

                <div id="studentAssignedExams" class="hidden mt-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-purple-500 pl-4">B√†i t·∫≠p ƒëang di·ªÖn ra</h2>
                    <div id="assignedExamsList" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <p class="text-gray-400 italic col-span-3">ƒêang ki·ªÉm tra b√†i t·∫≠p...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-classes" class="view-section hidden flex-1 flex flex-col h-full">
            <div class="bg-white border-b border-gray-200 p-6 flex justify-between items-center shadow-sm z-10">
                <h2 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-chalkboard-user mr-2 text-blue-500"></i>Qu·∫£n l√Ω L·ªõp h·ªçc</h2>
                <button id="createClassBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition-all flex items-center gap-2"><i class="fa-solid fa-plus"></i> T·∫°o l·ªõp m·ªõi</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div id="classList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><p class="text-gray-400 italic col-span-3 text-center py-10">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>
            </div>
        </div>

        <div id="view-teacher-class-detail" class="view-section hidden flex-1 flex flex-col h-full bg-white">
            <div class="h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-white shrink-0 z-10 shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="switchView('classes')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors text-gray-600">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <div class="flex items-center gap-2">
                            <h2 class="text-lg font-bold text-blue-800" id="teacherClassTitle">Chi ti·∫øt L·ªõp h·ªçc</h2>
                            <button onclick="window.editClassName()" class="text-gray-400 hover:text-blue-600 p-1 rounded transition-colors"><i class="fa-solid fa-pen text-xs"></i></button>
                        </div>
                        <p class="text-xs text-gray-500">Qu·∫£n l√Ω h·ªçc sinh & B√†i t·∫≠p</p>
                    </div>
                </div>
                
                <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button onclick="window.switchTab('students')" id="tabBtnStudents" class="px-4 py-1.5 text-sm font-bold rounded-md transition-all text-blue-700 bg-white shadow-sm">H·ªçc sinh</button>
                    <button onclick="window.switchTab('exams')" id="tabBtnExams" class="px-4 py-1.5 text-sm font-bold rounded-md transition-all text-gray-500 hover:text-gray-700">B√†i t·∫≠p</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-gray-50 w-full">
                <div id="tabContentStudents" class="space-y-6 w-full max-w-7xl mx-auto">
                    <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-gray-800 text-sm uppercase flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-user-plus text-xs"></i></span>
                                Th√™m h·ªçc sinh m·ªõi
                            </h4>
                            <div class="flex gap-2">
                                <button onclick="window.downloadTemplate()" class="text-xs px-3 py-1.5 bg-white border border-green-500 text-green-600 rounded-lg hover:bg-green-50 font-bold"><i class="fa-solid fa-download mr-1"></i> File m·∫´u</button>
                                <label for="excelInput" class="text-xs px-3 py-1.5 bg-green-500 text-white rounded-lg cursor-pointer hover:bg-green-600 flex items-center gap-1 font-bold shadow-green-200 shadow-sm"><i class="fa-solid fa-file-excel"></i> Nh·∫≠p Excel</label>
                                <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.handleFileUpload(this)">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="newStudentName" placeholder="H·ªç v√† t√™n h·ªçc sinh" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all">
                            <input type="text" id="newStudentUser" placeholder="T√™n ƒëƒÉng nh·∫≠p (VD: quang123)" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all">
                            <input type="text" id="newStudentPass" placeholder="M·∫≠t kh·∫©u" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all">
                        </div>
                        <button id="addStudentBtn" class="w-full py-2.5 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Th√™m v√†o danh s√°ch</button>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[calc(100vh-180px)]">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h4 class="font-bold text-gray-800 text-sm uppercase">Danh s√°ch l·ªõp</h4>
                            <span id="studentCountBadge" class="bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-1 rounded-lg">0 h·ªçc sinh</span>
                        </div>
                       <div class="overflow-x-auto flex-1 h-full overflow-y-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 font-bold">STT</th>
                                        <th class="px-6 py-3 font-bold">H·ªç t√™n</th>
                                        <th class="px-6 py-3 font-bold">T√†i kho·∫£n</th>
                                        <th class="px-6 py-3 font-bold">M·∫≠t kh·∫©u</th>
                                        <th class="px-6 py-3 text-center font-bold">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="studentListTable" class="divide-y divide-gray-100"></tbody>
                            </table>
                            <div id="emptyStudentMsg" class="flex flex-col items-center justify-center py-12 text-gray-400 hidden">
                                <i class="fa-solid fa-users-slash text-4xl mb-2 text-gray-300"></i>
                                <p>L·ªõp ch∆∞a c√≥ h·ªçc sinh n√†o.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabContentExams" class="hidden space-y-6 w-full max-w-7xl mx-auto">
                    <div id="teacherExamList" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="view-student-class-detail" class="view-section hidden flex-1 flex flex-col h-full bg-white">
            <div class="h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-white shrink-0 z-10 shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="switchView('home')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors text-gray-600">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800" id="detailClassName">T√™n l·ªõp h·ªçc</h2>
                        <p class="text-xs text-gray-500">Danh s√°ch b√†i t·∫≠p & ƒê·ªÅ thi</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500 font-bold hidden md:inline"><i class="fa-solid fa-filter mr-1"></i> S·∫Øp x·∫øp:</span>
                    <select id="sortExamsSelect" onchange="window.sortClassExams(this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                        <option value="newest">M·ªõi nh·∫•t tr∆∞·ªõc</option>
                        <option value="oldest">C≈© nh·∫•t tr∆∞·ªõc</option>
                    </select>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="classDetailContent"></div>
        </div>

        <div id="view-exambank" class="view-section hidden flex-1 flex flex-col h-full bg-white">
            <div class="h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-white shrink-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center text-gray-500 text-sm bg-gray-100 px-3 py-1.5 rounded-lg">
                        <button onclick="window.navigateFolder('root')" class="hover:text-blue-600 font-bold flex items-center gap-1" title="V·ªÅ th∆∞ m·ª•c g·ªëc"><i class="fa-solid fa-house"></i></button>
                        <span id="breadcrumbContainer" class="flex items-center"></span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.createNewFolder()" class="px-3 py-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg text-sm font-bold transition-colors"><i class="fa-solid fa-folder-plus mr-1"></i> T·∫°o th∆∞ m·ª•c</button>
                    <button onclick="window.location.href='exam-editor.html'" class="px-3 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg text-sm font-bold transition-colors"><i class="fa-solid fa-file-circle-plus mr-1"></i> So·∫°n ƒë·ªÅ m·ªõi</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="fileExplorerArea">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="explorerGrid"></div>
                <div id="emptyExplorerMsg" class="hidden flex flex-col items-center justify-center h-64 text-gray-400"><i class="fa-regular fa-folder-open text-6xl mb-4 text-gray-300"></i><p>Th∆∞ m·ª•c tr·ªëng</p></div>
            </div>
        </div>
    </main>

    <div id="genericInputModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 relative">
            <button id="gInputClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            <h3 id="gInputTitle" class="text-lg font-bold text-gray-800 mb-4">Nh·∫≠p th√¥ng tin</h3>
            <input type="text" id="gInputVal" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100">
            <div class="flex justify-end gap-3 mt-6"><button id="gInputCancel" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold">H·ªßy</button><button id="gInputConfirm" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg">OK</button></div>
        </div>
    </div>

    <div id="genericConfirmModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 text-center relative">
            <button id="gConfirmClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">X√°c nh·∫≠n</h3><p id="gConfirmMsg" class="text-gray-500 mb-6">?</p>
            <div class="flex justify-center gap-3"><button id="gConfirmCancel" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold">H·ªßy</button><button id="gConfirmOk" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg">ƒê·ªìng √Ω</button></div>
        </div>
    </div>

    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 relative">
            <button onclick="window.toggleModal('profileModal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Th√¥ng tin c√° nh√¢n</h3>
            <div class="space-y-4"><input type="text" id="editDisplayName" placeholder="T√™n hi·ªÉn th·ªã" class="w-full px-4 py-2 border rounded-lg"><input type="date" id="editBirthDate" class="w-full px-4 py-2 border rounded-lg"><select id="editRole" class="w-full px-4 py-2 border rounded-lg bg-white" disabled><option value="student">H·ªçc sinh</option><option value="teacher">Gi√°o vi√™n</option><option value="admin">Admin</option></select></div>
            <div class="flex justify-end gap-3 mt-6"><button onclick="window.toggleModal('profileModal', false)" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-600">H·ªßy</button><button id="saveProfileBtn" class="px-4 py-2 bg-orange-500 text-white rounded-lg">L∆∞u</button></div>
        </div>
    </div>

    <div id="actionModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 relative">
            <h3 id="actionModalTitle" class="text-xl font-bold text-gray-800 mb-4">H√†nh ƒë·ªông</h3><div id="dynamicContent"></div> 
            <button onclick="window.toggleModal('actionModal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="editStudentModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-xl mx-auto rounded-2xl shadow-2xl z-[60] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl"><p class="text-xl font-bold text-orange-800">S·ª≠a th√¥ng tin h·ªçc sinh</p><div onclick="window.toggleModal('editStudentModal', false)" class="cursor-pointer p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors"><i class="fa-solid fa-times"></i></div></div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4"><div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">H·ªç v√† t√™n</label><input type="text" id="editStuName" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">S·ªë b√°o danh</label><input type="text" id="editStuSBD" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Gi·ªõi t√≠nh</label><select id="editStuGender" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT H·ªçc sinh</label><input type="text" id="editStuPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT Ph·ª• huynh</label><input type="text" id="editStuParentPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">Email</label><input type="email" id="editStuEmail" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div></div><hr class="border-gray-100"><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h5 class="text-xs font-bold text-blue-800 uppercase mb-3">Th√¥ng tin ƒëƒÉng nh·∫≠p</h5><div class="space-y-3"><div><label class="block text-xs font-bold text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="editStuUsername" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-100 text-gray-500 cursor-not-allowed"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">M·∫≠t kh·∫©u</label><div class="flex gap-2"><div class="relative flex-1"><input type="password" id="editStuPassword" class="w-full px-3 py-2 rounded-lg border border-gray-300 pr-10"><div onclick="window.togglePasswordVisibility('editStuPassword')" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400"><i class="fa-regular fa-eye"></i></div></div><button onclick="window.refreshPassword()" class="px-3 py-2 bg-white border border-blue-300 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-50"><i class="fa-solid fa-rotate"></i> L√†m m·ªõi</button></div></div></div></div>
            </div>
            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl"><button onclick="window.toggleModal('editStudentModal', false)" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">H·ªßy</button><button id="saveStudentBtn" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold shadow-md">L∆∞u th√¥ng tin</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, onSnapshot, updateDoc, deleteDoc, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. BI·∫æN TO√ÄN C·ª§C
        let currentUser = null;
        let currentUserUid = null;
        let currentRole = 'student';
        
        // Bi·∫øn Gi√°o vi√™n
        let currentViewingClassId = null;
        let currentClassStudents = [];
        let editingStudentIndex = -1;
        let currentFolderId = null;
        let folderData = [];
        let examData = [];
        let currentActionItem = null;
        
        // Bi·∫øn H·ªçc sinh
        let studentResultsMap = {};
        let currentClassExamsData = [];

        // 3. H·ªÜ TH·ªêNG MODAL & TH√îNG B√ÅO (M·ªöI)
        let modalResolve = null;
        
        // H√†m ƒë√≥ng Modal
        window.closeCustomModal = () => {
            const modalEl = document.getElementById('customModal');
            const modalBox = document.getElementById('customModalBox');
            
            if (modalEl) {
                modalEl.classList.add('opacity-0', 'pointer-events-none');
                if (modalBox) {
                    modalBox.classList.remove('scale-100'); 
                    modalBox.classList.add('scale-95');
                }
            }
            if (modalResolve) { modalResolve(null); modalResolve = null; }
        };

        // H√†m Toast Th√¥ng b√°o
        window.showNotification = (message, type = 'success') => {
            // H·ªó tr·ª£ c·∫£ h√†m c≈© showNotification v√† h√†m m·ªõi showToast
            const container = document.getElementById('notificationContainer'); // Ho·∫∑c toastContainer
            if (!container) return alert(message); // Fallback n·∫øu ch∆∞a c√≥ HTML

            const div = document.createElement('div');
            const color = type === 'success' ? 'green' : 'red';
            div.className = `notification-toast pointer-events-auto bg-white border-l-4 border-${color}-500 shadow-lg rounded-lg p-4 w-80 flex items-start transform transition-all duration-300`;
            div.innerHTML = `
                <i class="fa-solid fa-${type==='success'?'check':'circle-exclamation'} text-${color}-500 mt-1 mr-3"></i>
                <div>
                    <h4 class="font-bold text-gray-800 text-sm">${type==='success'?'Th√†nh c√¥ng':'L·ªói'}</h4>
                    <p class="text-sm text-gray-600">${message}</p>
                </div>`;
            
            container.appendChild(div);
            // Animation v√†o
            requestAnimationFrame(() => div.classList.remove('translate-x-full'));
            
            // T·ª± t·∫Øt
            setTimeout(() => { 
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 500); 
            }, 3000);
        }
        // Alias cho showToast
        window.showToast = window.showNotification; 

        // H√†m Nh·∫≠p li·ªáu (Prompt)
        window.customPrompt = (message, placeholder = "", defaultValue = "") => {
            return new Promise((resolve) => {
                // Th·ª≠ t√¨m modal m·ªõi (customModal)
                const modalEl = document.getElementById('customModal');
                if (modalEl) {
                    const titleEl = document.getElementById('modalTitle');
                    const msgEl = document.getElementById('modalMessage');
                    const inputEl = document.getElementById('modalInput');
                    const btnConfirm = document.getElementById('btnConfirm');
                    const btnCancel = document.getElementById('btnCancel');

                    if (titleEl) titleEl.innerText = "Nh·∫≠p th√¥ng tin";
                    if (msgEl) msgEl.innerText = message;
                    
                    inputEl.classList.remove('hidden');
                    inputEl.value = defaultValue;
                    inputEl.placeholder = placeholder;
                    
                    btnCancel.classList.remove('hidden');
                    if(btnConfirm) btnConfirm.innerText = "L∆∞u l·∫°i";

                    modalEl.classList.remove('opacity-0', 'pointer-events-none');
                    const box = document.getElementById('customModalBox');
                    if(box) { box.classList.remove('scale-95'); box.classList.add('scale-100'); }
                    inputEl.focus();

                    const submit = () => { 
                        const val = inputEl.value; 
                        resolve(val); 
                        modalResolve = null; 
                        window.closeCustomModal(); 
                    };

                    btnConfirm.onclick = submit;
                    btnCancel.onclick = () => { resolve(null); modalResolve = null; window.closeCustomModal(); };
                    inputEl.onkeyup = (e) => { if(e.key === 'Enter') submit(); }
                    modalResolve = resolve;
                } else {
                    // Fallback n·∫øu ch∆∞a c√≥ HTML modal m·ªõi -> D√πng prompt m·∫∑c ƒë·ªãnh
                    const result = prompt(message, defaultValue);
                    resolve(result);
                }
            });
        };

        // H√†m X√°c nh·∫≠n (Confirm)
        window.customConfirm = (message) => {
            return new Promise((resolve) => {
                const modalEl = document.getElementById('customModal');
                if (modalEl) {
                    const msgEl = document.getElementById('modalMessage');
                    const inputEl = document.getElementById('modalInput');
                    const btnConfirm = document.getElementById('btnConfirm');
                    const btnCancel = document.getElementById('btnCancel');

                    if (msgEl) msgEl.innerText = message;
                    inputEl.classList.add('hidden');
                    btnCancel.classList.remove('hidden');
                    if(btnConfirm) btnConfirm.innerText = "ƒê·ªìng √Ω";

                    modalEl.classList.remove('opacity-0', 'pointer-events-none');
                    const box = document.getElementById('customModalBox');
                    if(box) { box.classList.remove('scale-95'); box.classList.add('scale-100'); }

                    btnConfirm.onclick = () => { resolve(true); modalResolve = null; window.closeCustomModal(); };
                    btnCancel.onclick = () => { resolve(false); modalResolve = null; window.closeCustomModal(); };
                    modalResolve = resolve;
                } else {
                    // Fallback
                    const result = confirm(message);
                    resolve(result);
                }
            });
        };

        // 4. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentUserUid = user.uid;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        currentRole = data.role || 'student';
                        
                        document.getElementById('sidebarName').textContent = data.displayName || user.email;
                        document.getElementById('sidebarRole').textContent = currentRole === 'teacher' ? 'Gi√°o vi√™n' : (currentRole === 'admin' ? 'Admin' : 'H·ªçc sinh');
                        document.getElementById('sidebarAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
                        
                        document.getElementById('editDisplayName').value = data.displayName || "";
                        document.getElementById('editBirthDate').value = data.birthDate || "";
                        document.getElementById('editRole').value = currentRole;

                        if (currentRole === 'teacher' || currentRole === 'admin') {
                            document.getElementById('teacherMenu').classList.remove('hidden');
                            loadClasses();
                            loadFileManager();
                            
                            // G·∫Øn s·ª± ki·ªán t·∫°o l·ªõp cho n√∫t tr√™n Header (S·ª≠a l·ªói kh√¥ng t·∫°o ƒë∆∞·ª£c l·ªõp)
                            const createBtn = document.getElementById('createClassBtn');
                            if(createBtn) {
                                createBtn.onclick = handleCreateClass;
                            }

                        } else if (currentRole === 'student') {
                            document.getElementById('studentMyClasses').classList.remove('hidden');
                            document.getElementById('studentAssignedExams').classList.remove('hidden');
                            await loadStudentResults();
                            loadStudentClasses();
                            loadAssignedExams();
                        }
                    }
                } catch (e) { console.error(e); }
            } else {
                window.location.href = "index.html";
            }
        });

        // 5. LOGIC GI√ÅO VI√äN: QU·∫¢N L√ù L·ªöP H·ªåC
        
        // H√†m t·∫°o l·ªõp m·ªõi (D√πng chung)
        async function handleCreateClass() {
            const name = await window.customPrompt("Nh·∫≠p t√™n l·ªõp h·ªçc m·ªõi:", "VD: L·ªõp 5A");
            if (name) {
                try {
                    await addDoc(collection(db, "classes"), { 
                        name: name, 
                        teacherId: currentUserUid, 
                        studentCount: 0, 
                        createdAt: new Date().toISOString() 
                    });
                    window.showNotification("T·∫°o l·ªõp th√†nh c√¥ng!", "success");
                } catch(e) { 
                    window.showNotification("L·ªói t·∫°o l·ªõp: " + e.message, "error"); 
                }
            }
        }

        function loadClasses() {
            const q = query(collection(db, "classes"), where("teacherId", "==", currentUserUid));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('classList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const cl = d.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer relative group";
                    const words = cl.name.trim().split(/\s+/);
                    let acronym = words.length >= 2 ? (words[0][0] + words[1][0]).toUpperCase() : words[0].substring(0, 2).toUpperCase();
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">${acronym}</div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg mb-1 truncate">${cl.name}</h3>
                        <p class="text-sm text-gray-500">${cl.studentCount || 0} h·ªçc sinh</p>
                    `;
                    card.onclick = () => window.openTeacherClassDetail(d.id, cl.name);
                    list.appendChild(card);
                });
                
                // Th·∫ª Add Class trong l∆∞·ªõi
                const addCard = document.createElement('button');
                addCard.className = "border-2 border-dashed border-gray-300 rounded-xl p-5 flex flex-col items-center justify-center text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors h-full min-h-[140px]";
                addCard.innerHTML = `<i class="fa-solid fa-plus text-3xl mb-2"></i><span class="font-bold">T·∫°o l·ªõp m·ªõi</span>`;
                addCard.onclick = handleCreateClass; // G·ªçi h√†m t·∫°o l·ªõp
                list.appendChild(addCard);
            });
        }

        // M·ªü chi ti·∫øt l·ªõp (Gi√°o vi√™n)
        // H√†m m·ªü chi ti·∫øt l·ªõp (ƒê√£ b·ªè ·∫©n Sidebar)
        window.openTeacherClassDetail = async (id, name) => {
            // Chuy·ªÉn view
            window.switchView('teacher-class-detail');
            
            // ƒê·∫£m b·∫£o Sidebar lu√¥n hi·ªán (ƒë·ªÅ ph√≤ng tr∆∞·ªùng h·ª£p n√≥ ƒëang b·ªã ·∫©n)
            const sidebar = document.querySelector('aside');
            if (sidebar) sidebar.classList.remove('hidden');

            currentViewingClassId = id;
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ (t√¨m ƒë√∫ng ID)
            const titleEl = document.getElementById('teacherClassTitle') || document.getElementById('classModalTitle');
            if(titleEl) titleEl.textContent = name;

            // T·∫£i danh s√°ch h·ªçc sinh
            const snap = await getDoc(doc(db, "classes", id));
            if(snap.exists()) {
                currentClassStudents = snap.data().students || [];
                renderStudentList(currentClassStudents);
            }
            window.switchTab('students');
        }

        // ƒê√≥ng chi ti·∫øt l·ªõp (Hi·ªán l·∫°i Sidebar)
        // H√†m ƒë√≥ng chi ti·∫øt l·ªõp
        window.closeClassDetail = () => {
            // Ch·ªâ c·∫ßn chuy·ªÉn view v·ªÅ danh s√°ch l·ªõp
            window.switchView('classes');
        }

        // ƒê·ªïi t√™n l·ªõp (S·ª¨A L·ªñI LOGIC ID)
        window.editClassName = async () => {
            if (!currentViewingClassId) return;
            const titleEl = document.getElementById('teacherClassTitle');
            if (!titleEl) {
                console.error("Kh√¥ng t√¨m th·∫•y ID teacherClassTitle");
                return;
            }
            const currentName = titleEl.textContent;
            
            const newName = await window.customPrompt("Nh·∫≠p t√™n m·ªõi cho l·ªõp:", "", currentName);
            
            if (newName && newName.trim() !== "" && newName !== currentName) {
                try {
                    await updateDoc(doc(db, "classes", currentViewingClassId), { name: newName });
                    titleEl.textContent = newName;
                    window.showNotification("ƒê·ªïi t√™n l·ªõp th√†nh c√¥ng!");
                } catch(e) { 
                    window.showNotification("L·ªói: " + e.message, "error"); 
                }
            }
        }

        // --- 6. LOGIC H·ªåC SINH (VI·∫æT ƒê·∫¶Y ƒê·ª¶) ---
        
        async function loadStudentResults() {
            try {
                const q = query(collection(db, "results"), where("studentId", "==", currentUserUid));
                const snap = await getDocs(q);
                studentResultsMap = {};
                snap.forEach(doc => {
                    const res = doc.data();
                    if (!studentResultsMap[res.examId]) {
                        studentResultsMap[res.examId] = [];
                    }
                    studentResultsMap[res.examId].push(res);
                });
            } catch (err) { console.error("L·ªói t·∫£i k·∫øt qu·∫£:", err); }
        }

        async function loadStudentClasses() {
            try {
                const q = query(collection(db, "classes"));
                const snapshot = await getDocs(q);
                const container = document.getElementById('studentClassList');
                container.innerHTML = '';
                let hasClass = false;

                snapshot.forEach(docSnap => {
                    const classData = docSnap.data();
                    const students = classData.students || [];
                    const isMember = students.some(s => 
                        (s.email && s.email.toLowerCase() === currentUser.email.toLowerCase()) ||
                        (s.username && currentUser.email.toLowerCase() === `${s.username}@hocsinh.com`.toLowerCase())
                    );

                    if (isMember) {
                        hasClass = true;
                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer";
                        const words = classData.name.trim().split(/\s+/);
                        let acronym = words.length >= 2 ? (words[0][0] + words[1][0]).toUpperCase() : words[0].substring(0, 2).toUpperCase();

                        card.innerHTML = `
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xl">${acronym}</div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-lg leading-tight">${classData.name}</h3>
                                    <p class="text-xs text-gray-500">${classData.students.length} th√†nh vi√™n</p>
                                </div>
                            </div>
                            <button onclick="window.openStudentClassDetail('${docSnap.id}', '${classData.name}')" class="w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors">
                                V√†o l·ªõp
                            </button>
                        `;
                        container.appendChild(card);
                    }
                });
                if (!hasClass) container.innerHTML = '<p class="text-gray-400 italic col-span-3">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o.</p>';
            } catch (err) { console.error("L·ªói t·∫£i l·ªõp h·ªçc sinh:", err); }
        }

        async function loadAssignedExams() {
            const container = document.getElementById('assignedExamsList');
            container.innerHTML = '<p class="text-gray-400 italic col-span-3">ƒêang ki·ªÉm tra b√†i t·∫≠p...</p>';

            try {
                // L·∫•y danh s√°ch l·ªõp c·ªßa HS
                const qClasses = query(collection(db, "classes"));
                const snapClasses = await getDocs(qClasses);
                const myClassIds = [];
                const myClassNames = {};

                snapClasses.forEach(doc => {
                    const cl = doc.data();
                    const students = cl.students || [];
                    const isMember = students.some(s => 
                        (s.email && s.email.toLowerCase() === currentUser.email.toLowerCase()) ||
                        (s.username && `${s.username}@hocsinh.com`.toLowerCase() === currentUser.email.toLowerCase())
                    );
                    if (isMember) {
                        myClassIds.push(doc.id);
                        myClassNames[doc.id] = cl.name;
                    }
                });

                if (myClassIds.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 italic col-span-3">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o.</p>';
                    return;
                }

                // L·∫•y ƒë·ªÅ thi cho c√°c l·ªõp ƒë√≥
                const qExams = query(collection(db, "exams"), where("accessType", "==", "class"), where("status", "==", "published"));
                const snapExams = await getDocs(qExams);
                
                container.innerHTML = '';
                let count = 0;
                const now = new Date();

                snapExams.forEach(doc => {
                    const exam = doc.data();
                    // Ki·ªÉm tra xem ƒë·ªÅ thi c√≥ thu·ªôc l·ªõp c·ªßa HS kh√¥ng
                    if (myClassIds.includes(exam.allowedClassId)) {
                        const endTime = exam.endTime ? new Date(exam.endTime) : null;
                        if (!endTime || endTime > now) {
                            count++;
                            const className = myClassNames[exam.allowedClassId] || "L·ªõp h·ªçc";
                            const results = studentResultsMap[doc.id] || [];
                            const attempts = results.length;
                            const maxScore = attempts > 0 ? Math.max(...results.map(r => r.score)) : "--";
                            const isDone = attempts > 0;

                            const statusHTML = isDone 
                                ? `<span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">ƒê√£ l√†m (${attempts} l·∫ßn) - ƒêi·ªÉm: ${maxScore}</span>`
                                : `<span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">Ch∆∞a l√†m</span>`;

                            const div = document.createElement('div');
                            div.className = "bg-white rounded-2xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-xl transition-all relative overflow-hidden group";
                            div.innerHTML = `
                                <div class="absolute top-0 right-0 bg-purple-100 text-purple-600 text-xs font-bold px-3 py-1 rounded-bl-xl">${className}</div>
                                <h3 class="font-bold text-gray-800 text-lg mb-1 mt-2">${exam.title}</h3>
                                <div class="mb-3">${statusHTML}</div>
                                <div class="text-xs text-gray-500 mb-2"><i class="fa-regular fa-clock mr-1"></i> ${exam.duration} ph√∫t ‚Ä¢ ${exam.questionCount || 0} c√¢u</div>
                                <button onclick="window.location.href='exam.html?id=${doc.id}'" class="w-full py-2 bg-purple-50 text-purple-600 font-bold rounded-lg group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                    ${isDone ? 'L√†m l·∫°i' : 'L√†m b√†i ngay'}
                                </button>
                            `;
                            container.appendChild(div);
                        }
                    }
                });

                if (count === 0) {
                    container.innerHTML = '<div class="col-span-3 text-center py-8 bg-white rounded-xl border border-dashed border-gray-300"><p class="text-gray-500 font-bold">Kh√¥ng c√≥ b√†i t·∫≠p m·ªõi!</p></div>';
                }

            } catch (err) {
                console.error("L·ªói t·∫£i b√†i t·∫≠p:", err);
                container.innerHTML = '<p class="text-red-400 italic col-span-3">L·ªói t·∫£i d·ªØ li·ªáu.</p>';
            }
        }

        window.openStudentClassDetail = async (classId, className) => {
            window.switchView('student-class-detail');
            document.getElementById('detailClassName').textContent = className;
            const content = document.getElementById('classDetailContent');
            content.innerHTML = '<p class="text-center text-gray-400 py-10">ƒêang t·∫£i danh s√°ch b√†i t·∫≠p...</p>';

            try {
                const q = query(collection(db, "exams"), where("allowedClassId", "==", classId));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    content.innerHTML = '<div class="text-center py-10"><i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-2"></i><p class="text-gray-500">Ch∆∞a c√≥ b√†i t·∫≠p n√†o trong l·ªõp n√†y.</p></div>';
                    currentClassExamsData = [];
                    return;
                }

                currentClassExamsData = [];
                snap.forEach(doc => currentClassExamsData.push({ id: doc.id, ...doc.data() }));
                window.sortClassExams('newest');

            } catch (err) {
                console.error(err);
                content.innerHTML = '<p class="text-red-500 text-center">L·ªói t·∫£i d·ªØ li·ªáu.</p>';
            }
        }

        window.sortClassExams = (order) => {
             const content = document.getElementById('classDetailContent');
             
             currentClassExamsData.sort((a, b) => {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return order === 'newest' ? dateB - dateA : dateA - dateB; 
            });

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
            currentClassExamsData.forEach(exam => {
                const results = studentResultsMap[exam.id] || [];
                const attempts = results.length;
                const maxScore = attempts > 0 ? Math.max(...results.map(r => r.score)) : "--";
                const isDone = attempts > 0;
                
                const now = new Date();
                const endTime = exam.endTime ? new Date(exam.endTime) : null;
                const isExpired = endTime && endTime < now;
                const statusColor = isExpired ? 'text-red-500 bg-red-50' : 'text-green-600 bg-green-50';
                const statusText = isExpired ? 'ƒê√£ h·∫øt h·∫°n' : 'ƒêang m·ªü';
                const deadlineStr = endTime ? `${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ${endTime.toLocaleDateString('vi-VN')}` : "Kh√¥ng gi·ªõi h·∫°n";

                html += `
                    <div class="bg-white p-5 rounded-2xl border ${isExpired ? 'border-gray-200 bg-gray-50' : 'border-blue-100 hover:border-blue-300'} shadow-sm flex flex-col justify-between transition-all hover:shadow-md">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-800 text-lg line-clamp-2" title="${exam.title}">${exam.title}</h4>
                                <span class="text-[10px] font-bold px-2 py-1 rounded shrink-0 ml-2 ${statusColor}">${statusText}</span>
                            </div>
                            <div class="flex items-center gap-4 text-xs text-gray-500 mb-3">
                                <span><i class="fa-solid fa-clock mr-1"></i> ${exam.duration} ph√∫t</span>
                                <span><i class="fa-solid fa-list mr-1"></i> ${exam.questionCount} c√¢u</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl mb-4 text-xs border border-gray-100 space-y-1">
                                <div class="flex justify-between"><span>Tr·∫°ng th√°i:</span> <span class="font-bold ${isDone?'text-green-600':'text-orange-500'}">${isDone?'ƒê√£ l√†m':'Ch∆∞a l√†m'}</span></div>
                                <div class="flex justify-between"><span>S·ªë l·∫ßn l√†m:</span> <span class="font-bold">${attempts} / ${exam.attempts || '‚àû'}</span></div>
                                <div class="flex justify-between"><span>ƒêi·ªÉm cao nh·∫•t:</span> <span class="font-bold text-blue-600 text-sm">${maxScore}</span></div>
                                <div class="flex justify-between pt-1 mt-1 border-t border-gray-200 text-red-500 font-bold"><span>H·∫°n n·ªôp:</span> <span>${deadlineStr}</span></div>
                            </div>
                        </div>
                        <button onclick="window.location.href='exam.html?id=${exam.id}'" class="w-full py-2.5 ${isExpired ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-200'} font-bold rounded-xl text-sm transition-all" ${isExpired ? 'disabled' : ''}>
                            ${isExpired ? 'ƒê√£ ƒë√≥ng' : (isDone ? 'L√†m l·∫°i b√†i' : 'B·∫Øt ƒë·∫ßu l√†m b√†i')}
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        // --- C√ÅC CH·ª®C NƒÇNG CHUNG KH√ÅC (File, UI, v.v) ---
        
        // Qu·∫£n l√Ω file (Gi·ªØ nguy√™n logic c≈©)
        function loadFileManager() {
            const qFolders = query(collection(db, "folders"), where("teacherId", "==", currentUserUid));
            onSnapshot(qFolders, (snap) => { folderData = []; snap.forEach(d => folderData.push({id: d.id, ...d.data()})); renderExplorer(); });
            const qExams = query(collection(db, "exams"), where("teacherId", "==", currentUserUid));
            onSnapshot(qExams, (snap) => { examData = []; snap.forEach(d => examData.push({id: d.id, ...d.data()})); renderExplorer(); });
        }

        function renderExplorer() {
            const grid = document.getElementById('explorerGrid'); grid.innerHTML = '';
            const currentFolders = folderData.filter(f => f.parentId === currentFolderId);
            const currentExams = examData.filter(e => (e.folderId || null) === currentFolderId);
            if (currentFolders.length === 0 && currentExams.length === 0) document.getElementById('emptyExplorerMsg').classList.remove('hidden'); else document.getElementById('emptyExplorerMsg').classList.add('hidden');
            currentFolders.forEach(f => {
                const div = document.createElement('div'); div.className = "explorer-item bg-white p-4 rounded-xl border border-gray-200 relative group"; div.draggable = true;
                div.ondragstart = (evt) => window.handleDragStart(evt, f.id, 'folder'); div.ondragover = (evt) => window.handleDragOver(evt); div.ondragleave = (evt) => window.handleDragLeave(evt); div.ondrop = (evt) => window.handleDrop(evt, f.id);
                div.onclick = (e) => { if(!e.target.closest('button')) window.navigateFolder(f.id, f.name); };
                div.innerHTML = `<div class="text-4xl text-yellow-400 mb-3 text-center pointer-events-none"><i class="fa-solid fa-folder"></i></div><p class="text-sm font-bold text-gray-700 text-center truncate px-2 pointer-events-none">${f.name}</p><div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="event.stopPropagation(); window.openContextMenu('${f.id}', 'folder', '${f.name}')" class="p-1 hover:bg-gray-100 rounded text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></button></div>`;
                grid.appendChild(div);
            });
            currentExams.forEach(exam => {
                const div = document.createElement('div'); div.className = "explorer-item bg-white p-4 rounded-xl border border-gray-200 relative group"; div.draggable = true;
                div.ondragstart = (evt) => window.handleDragStart(evt, exam.id, 'exam');
                div.onclick = (e) => { if(!e.target.closest('button')) window.location.href = `exam-editor.html?id=${exam.id}`; };
                div.innerHTML = `<div class="text-4xl text-blue-500 mb-3 text-center pointer-events-none"><i class="fa-regular fa-file-lines"></i></div><p class="text-sm font-bold text-gray-700 text-center truncate px-2 pointer-events-none" title="${exam.title}">${exam.title}</p><div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="event.stopPropagation(); window.openContextMenu('${exam.id}', 'exam', '${exam.title}')" class="p-1 hover:bg-gray-100 rounded text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></button></div>`;
                grid.appendChild(div);
            });
            renderBreadcrumb();
        }

        window.handleDragStart = (e, id, type) => { e.dataTransfer.setData("text/plain", JSON.stringify({id, type})); e.target.classList.add('dragging'); e.stopPropagation(); }
        window.handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        window.handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); }
        window.handleDrop = async (e, targetId) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('drag-over'); try { const data = JSON.parse(e.dataTransfer.getData("text/plain")); if (data.id === targetId) return; const collName = data.type === 'folder' ? 'folders' : 'exams'; const field = data.type === 'folder' ? 'parentId' : 'folderId'; await updateDoc(doc(db, collName, data.id), { [field]: targetId }); window.showNotification("ƒê√£ di chuy·ªÉn th√†nh c√¥ng!"); } catch (err) { console.error("Drop error", err); } document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging')); }
        window.navigateFolder = (id, name) => { if(id === 'root') { currentFolderId = null; breadcrumbs = []; } else { currentFolderId = id; breadcrumbs.push({id, name}); } renderExplorer(); }
        window.createNewFolder = async () => { const name = await window.customPrompt("Nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi:", "VD: To√°n ƒê·∫°i S·ªë"); if(name) { try { await addDoc(collection(db, "folders"), { name, parentId: currentFolderId, teacherId: currentUserUid, createdAt: new Date().toISOString() }); window.showNotification("ƒê√£ t·∫°o th∆∞ m·ª•c"); } catch(e) { window.showNotification("L·ªói: " + e.message, "error"); } } }
        let breadcrumbs = [];
        function renderBreadcrumb() { const container = document.getElementById('breadcrumbContainer'); if (!currentFolderId) { container.innerHTML = '<span class="mx-2 text-gray-400">/</span><span>T·∫•t c·∫£</span>'; return; } let path = []; let curr = folderData.find(f => f.id === currentFolderId); while(curr) { path.unshift(curr); curr = folderData.find(f => f.id === curr.parentId); } let html = '<span class="mx-2 text-gray-400">/</span><button onclick="window.navigateFolder(\'root\')" class="hover:text-blue-600">...</button>'; path.forEach((p, idx) => { html += `<span class="mx-2 text-gray-400">/</span>`; if (idx === path.length - 1) html += `<span class="font-bold text-gray-800">${p.name}</span>`; else html += `<button onclick="window.navigateFolder('${p.id}')" class="hover:text-blue-600">${p.name}</button>`; }); container.innerHTML = html; }
        
        window.openContextMenu = (id, type, name) => { currentActionItem = {id, type, name}; document.getElementById('actionModalTitle').textContent = `Thao t√°c: ${name}`; const content = document.getElementById('dynamicContent'); content.innerHTML = `<div class="grid grid-cols-3 gap-3 mb-4"><button onclick="window.triggerAction('rename')" class="p-3 bg-blue-50 text-blue-600 rounded-lg font-bold hover:bg-blue-100 flex flex-col items-center"><i class="fa-solid fa-pen mb-1"></i> ƒê·ªïi t√™n</button><button onclick="window.triggerAction('move')" class="p-3 bg-purple-50 text-purple-600 rounded-lg font-bold hover:bg-purple-100 flex flex-col items-center"><i class="fa-solid fa-arrow-right-to-bracket mb-1"></i> Di chuy·ªÉn</button><button onclick="window.triggerAction('delete')" class="p-3 bg-red-50 text-red-600 rounded-lg font-bold hover:bg-red-100 flex flex-col items-center"><i class="fa-solid fa-trash mb-1"></i> X√≥a</button></div><div id="subActionContent"></div>`; window.toggleModal('actionModal', true); }
        window.triggerAction = async (action) => { const container = document.getElementById('subActionContent'); container.innerHTML = ''; if (action === 'rename') container.innerHTML = `<label class="block text-sm font-bold text-gray-700 mb-2">T√™n m·ªõi</label><div class="flex gap-2"><input type="text" id="renameInput" value="${currentActionItem.name}" class="flex-1 border rounded px-3 py-2"><button onclick="window.commitRename()" class="bg-blue-600 text-white px-4 rounded font-bold">L∆∞u</button></div>`; else if (action === 'delete') { window.toggleModal('actionModal', false); if(await window.customConfirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a "${currentActionItem.name}"?`)) { try { const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams'; await deleteDoc(doc(db, collName, currentActionItem.id)); window.showNotification("ƒê√£ x√≥a!"); } catch(e) { window.showNotification(e.message, 'error'); } } } else if (action === 'move') { let html = '<p class="text-sm font-bold text-gray-700 mb-2">Ch·ªçn th∆∞ m·ª•c ƒë·∫øn:</p><div class="h-40 overflow-y-auto border rounded p-1 space-y-1">'; html += `<button onclick="window.commitMove(null)" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2"><i class="fa-solid fa-house text-gray-400"></i> Th∆∞ m·ª•c g·ªëc</button>`; folderData.forEach(f => { if (f.id !== currentActionItem.id) html += `<button onclick="window.commitMove('${f.id}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2"><i class="fa-solid fa-folder text-yellow-400"></i> ${f.name}</button>`; }); html += '</div>'; container.innerHTML = html; } }
        window.commitRename = async () => { const newName = document.getElementById('renameInput').value; if(!newName) return; const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams'; await updateDoc(doc(db, collName, currentActionItem.id), { name: newName, title: newName }); window.showNotification("ƒê√£ ƒë·ªïi t√™n"); window.toggleModal('actionModal', false); }
        window.commitMove = async (targetFolderId) => { const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams'; const field = currentActionItem.type === 'folder' ? 'parentId' : 'folderId'; await updateDoc(doc(db, collName, currentActionItem.id), { [field]: targetFolderId }); window.toggleModal('actionModal', false); window.showNotification("ƒê√£ di chuy·ªÉn"); }

        // --- GLOBAL UI HELPERS ---
        window.toggleModal = (id, show) => { const el = document.getElementById(id); const container = el.querySelector('.modal-container'); if(show) { el.classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); if(container) container.classList.remove('scale-95'); } else { el.classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); if(container) container.classList.add('scale-95'); } }
        window.switchView = (viewName) => { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${viewName}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); const activeNav = document.getElementById(`nav-${viewName}`); if(activeNav) activeNav.classList.add('active'); }
        window.togglePasswordVisibility = (inputId) => { const x = document.getElementById(inputId); x.type = x.type === "password" ? "text" : "password"; }
        window.refreshPassword = () => { const chars = "0123456789abcdefghijklmnopqrstuvwxyz"; let password = ""; for (let i = 0; i < 6; i++) password += chars.charAt(Math.floor(Math.random() * chars.length)); document.getElementById('editStuPassword').value = password; document.getElementById('editStuPassword').type = "text"; }

        // --- STUDENT MANAGEMENT ---
        function renderStudentList(list) { const table = document.getElementById('studentListTable'); table.innerHTML = ''; document.getElementById('studentCountBadge').textContent = `${list.length} h·ªçc sinh`; if (list.length === 0) document.getElementById('emptyStudentMsg').classList.remove('hidden'); else { document.getElementById('emptyStudentMsg').classList.add('hidden'); list.forEach((st, index) => { table.innerHTML += `<tr class="bg-white hover:bg-gray-50 border-b"><td class="px-6 py-3 font-medium text-gray-500">${index + 1}</td><td class="px-6 py-3 font-medium text-gray-900">${st.name}</td><td class="px-6 py-3 text-blue-600 font-medium">${st.username}</td><td class="px-6 py-3 font-mono text-gray-400">******</td><td class="px-6 py-3 text-center"><button onclick="window.openEditStudent(${index})" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors mr-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="window.deleteStudent(${index})" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); } }
        window.openEditStudent = function(index) { editingStudentIndex = index; const st = currentClassStudents[index]; document.getElementById('editStuName').value = st.name || ''; document.getElementById('editStuSBD').value = st.sbd || ''; document.getElementById('editStuGender').value = st.gender || 'Nam'; document.getElementById('editStuPhone').value = st.phoneStudent || ''; document.getElementById('editStuParentPhone').value = st.phoneParent || ''; document.getElementById('editStuEmail').value = st.email || ''; document.getElementById('editStuUsername').value = st.username || ''; document.getElementById('editStuPassword').value = st.password || ''; document.getElementById('editStuPassword').type = "password"; window.toggleModal('editStudentModal', true); }
        window.deleteStudent = async function(index) { if(!await window.customConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh n√†y kh·ªèi l·ªõp?")) return; try { currentClassStudents.splice(index, 1); await updateDoc(doc(db, "classes", currentViewingClassId), { students: currentClassStudents, studentCount: currentClassStudents.length }); renderStudentList(currentClassStudents); window.showNotification("ƒê√£ x√≥a h·ªçc sinh.", "success"); } catch(e) { window.showNotification("L·ªói x√≥a: " + e.message, "error"); } }
        document.getElementById('saveStudentBtn').addEventListener('click', async () => { if (editingStudentIndex === -1 || !currentViewingClassId) return; const updatedStudent = { ...currentClassStudents[editingStudentIndex], name: document.getElementById('editStuName').value, sbd: document.getElementById('editStuSBD').value, gender: document.getElementById('editStuGender').value, phoneStudent: document.getElementById('editStuPhone').value, phoneParent: document.getElementById('editStuParentPhone').value, email: document.getElementById('editStuEmail').value, username: document.getElementById('editStuUsername').value, password: document.getElementById('editStuPassword').value }; if(!updatedStudent.name || !updatedStudent.username || !updatedStudent.password) { window.showNotification("Thi·∫øu th√¥ng tin!", "error"); return; } try { currentClassStudents[editingStudentIndex] = updatedStudent; await updateDoc(doc(db, "classes", currentViewingClassId), { students: currentClassStudents }); window.showNotification("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success"); renderStudentList(currentClassStudents); window.toggleModal('editStudentModal', false); } catch (e) { window.showNotification("L·ªói: " + e.message, "error"); } });
        document.getElementById('addStudentBtn').addEventListener('click', async () => { if (!currentViewingClassId) return; const name = document.getElementById('newStudentName').value; const user = document.getElementById('newStudentUser').value; const pass = document.getElementById('newStudentPass').value; if (!name || !user || !pass) { window.showNotification("Nh·∫≠p ƒë·ªß th√¥ng tin!", "error"); return; } const fakeEmail = `${user}@hocsinh.com`; try { await createStudentAuth(fakeEmail, pass, name); const newStudent = { name, username: user, password: pass, email: fakeEmail, createdAt: new Date().toISOString() }; await updateDoc(doc(db, "classes", currentViewingClassId), { students: arrayUnion(newStudent) }); currentClassStudents.push(newStudent); renderStudentList(currentClassStudents); await updateDoc(doc(db, "classes", currentViewingClassId), { studentCount: currentClassStudents.length }); document.getElementById('newStudentName').value = ''; document.getElementById('newStudentUser').value = ''; document.getElementById('newStudentPass').value = ''; window.showNotification("Th√™m th√†nh c√¥ng v√† ƒë√£ t·∫°o t√†i kho·∫£n!", "success"); } catch (e) { console.error(e); if(e.code === 'auth/email-already-in-use') window.showNotification("T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!", "error"); else window.showNotification("L·ªói: " + e.message, "error"); } });
        async function createStudentAuth(email, password, displayName) { const secondaryApp = initializeApp(firebaseConfig, "Secondary"); const secondaryAuth = getAuth(secondaryApp); try { const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password); await setDoc(doc(db, "users", userCredential.user.uid), { email: email, displayName: displayName, role: 'student', birthDate: '', authType: 'email', createdAt: new Date().toISOString() }); await signOut(secondaryAuth); return userCredential.user; } catch (error) { throw error; } finally { deleteApp(secondaryApp); } }
        window.downloadTemplate = () => { const data = [["H·ªç v√† t√™n", "T√™n ƒëƒÉng nh·∫≠p", "M·∫≠t kh·∫©u", "SBD", "Gi·ªõi t√≠nh", "SƒêT HS", "SƒêT PHHS"], ["Nguy·ªÖn VƒÉn A", "nguyenvana", "123456", "001", "Nam", "098...", "091..."]]; const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "DanhSach"); XLSX.writeFile(wb, "Mau_DS_Hoc_Sinh.xlsx"); }
        window.handleFileUpload = (input) => { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async function(e) { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); let addedCount = 0; for(let i = 1; i < jsonData.length; i++) { const row = jsonData[i]; if(row[0] && row[1]) { try { const name = row[0]; const user = row[1]; const pass = String(row[2] || '123456'); const fakeEmail = `${user}@hocsinh.com`; try { await createStudentAuth(fakeEmail, pass, name); } catch(e) { console.log("User exists or error", e); } const newStudent = { name, username: user, password: pass, email: fakeEmail, sbd: row[3]||'', gender: row[4]||'Nam', phoneStudent: row[5]||'', phoneParent: row[6]||'', createdAt: new Date().toISOString() }; await updateDoc(doc(db, "classes", currentViewingClassId), { students: arrayUnion(newStudent) }); currentClassStudents.push(newStudent); addedCount++; } catch(e) { console.error(e); } } } if(addedCount > 0) { renderStudentList(currentClassStudents); await updateDoc(doc(db, "classes", currentViewingClassId), { studentCount: currentClassStudents.length }); window.showNotification(`ƒê√£ th√™m ${addedCount} h·ªçc sinh!`, "success"); } input.value = ""; }; reader.readAsArrayBuffer(file); }
        async function loadClassExams(classId) { const container = document.getElementById('tabContentExams'); container.innerHTML = '<p class="text-gray-400 italic text-center py-4">ƒêang t·∫£i danh s√°ch ƒë·ªÅ...</p>'; try { const q = query(collection(db, "exams"), where("accessType", "==", "class"), where("allowedClassId", "==", classId)); const snap = await getDocs(q); if (snap.empty) { container.innerHTML = `<div class="border rounded-2xl p-10 text-center bg-white border-dashed border-gray-300"><div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 text-2xl"><i class="fa-solid fa-file-invoice"></i></div><h3 class="text-lg font-bold text-gray-700 mb-2">Ch∆∞a c√≥ b√†i t·∫≠p n√†o</h3><p class="text-sm text-gray-500">Th·∫ßy ch∆∞a giao b√†i t·∫≠p ri√™ng cho l·ªõp n√†y.</p></div>`; return; } let html = '<div class="space-y-3">'; snap.forEach(doc => { const exam = doc.data(); const statusColor = exam.status === 'published' ? 'text-green-600 bg-green-50' : 'text-orange-500 bg-orange-50'; const statusText = exam.status === 'published' ? 'ƒêang m·ªü' : 'B·∫£n nh√°p'; html += `<div class="bg-white p-4 rounded-xl border border-gray-200 flex justify-between items-center hover:shadow-md transition-shadow"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center font-bold"><i class="fa-solid fa-file-lines"></i></div><div><h4 class="font-bold text-gray-800">${exam.title}</h4><p class="text-xs text-gray-500">${exam.questionCount || 0} c√¢u ‚Ä¢ ${exam.duration} ph√∫t</p></div></div><div class="flex items-center gap-3"><span class="px-3 py-1 rounded-full text-xs font-bold ${statusColor}">${statusText}</span><button onclick="window.location.href='exam-editor.html?id=${doc.id}'" class="text-gray-400 hover:text-blue-600 p-2"><i class="fa-solid fa-pen-to-square"></i></button></div></div>`; }); html += '</div>'; container.innerHTML = html; } catch (e) { container.innerHTML = '<p class="text-red-500 italic text-center">L·ªói t·∫£i d·ªØ li·ªáu.</p>'; } }

        window.switchTab = async (tabName) => {
            const btnStudents = document.getElementById('tabBtnStudents');
            const btnExams = document.getElementById('tabBtnExams');
            const contentStudents = document.getElementById('tabContentStudents'); 
            const contentExams = document.getElementById('tabContentExams');

            contentStudents.classList.add('hidden');
            contentExams.classList.add('hidden');
            
            const inactiveClass = "text-gray-500 hover:text-gray-700 bg-transparent shadow-none";
            const activeClass = "text-blue-700 bg-white shadow-sm";

            btnStudents.className = `px-4 py-1.5 text-sm font-bold rounded-md transition-all ${inactiveClass}`;
            btnExams.className = `px-4 py-1.5 text-sm font-bold rounded-md transition-all ${inactiveClass}`;

            if (tabName === 'students') {
                contentStudents.classList.remove('hidden');
                btnStudents.className = `px-4 py-1.5 text-sm font-bold rounded-md transition-all ${activeClass}`;
            } else {
                contentExams.classList.remove('hidden');
                btnExams.className = `px-4 py-1.5 text-sm font-bold rounded-md transition-all ${activeClass}`;
                await loadClassExams(currentViewingClassId);
            }
        }

        document.getElementById('logoutBtn').onclick = async () => { if(await window.customConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) signOut(auth).then(()=>window.location.href="index.html"); }
        document.getElementById('saveProfileBtn').onclick = async () => { const name = document.getElementById('editDisplayName').value; await updateDoc(doc(db, "users", currentUserUid), { displayName: name }); window.showNotification("ƒê√£ c·∫≠p nh·∫≠t profile"); setTimeout(()=>location.reload(), 500); }
    </script>
    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
    
    <div class="bg-white rounded-2xl shadow-2xl w-96 transform scale-95 transition-transform duration-300 relative overflow-hidden z-10" id="customModalBox">
        <div class="bg-gradient-to-r from-orange-400 to-orange-600 p-4 flex justify-between items-center">
            <h3 class="text-white font-bold text-lg" id="modalTitle">Th√¥ng b√°o</h3>
            <button onclick="closeCustomModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        
        <div class="p-6 text-center">
            <div id="modalIcon" class="text-5xl mb-4 text-orange-500">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <p id="modalMessage" class="text-gray-700 font-medium text-lg">N·ªôi dung th√¥ng b√°o...</p>
            
            <input type="text" id="modalInput" class="hidden mt-4 w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none" placeholder="Nh·∫≠p th√¥ng tin...">
        </div>

        <div class="p-4 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
            <button id="btnCancel" class="px-5 py-2.5 rounded-xl text-gray-600 font-bold hover:bg-gray-200 transition-colors hidden">H·ªßy b·ªè</button>
            <button id="btnConfirm" class="px-6 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold shadow-lg shadow-orange-200 hover:shadow-xl transform active:scale-95 transition-all">ƒê·ªìng √Ω</button>
        </div>
    </div>
</div>

<div id="toastContainer" class="fixed top-5 right-5 z-[110] flex flex-col gap-3"></div>
</body>
</html>
