<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫£nh ch√≠nh - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Th∆∞ vi·ªán x·ª≠ l√Ω Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Th∆∞ vi·ªán MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #FFF8F0; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }

        /* Notification Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .notification-toast {
            animation: slideIn 0.5s ease forwards;
        }
        .notification-toast.hide {
            animation: fadeOut 0.5s ease forwards;
        }
        
        /* Tab Active Style */
        .tab-btn.active {
            border-bottom: 3px solid #3B82F6;
            color: #1D4ED8;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gray-50 relative">

    <!-- CONTAINER TH√îNG B√ÅO (POPUP) -->
    <div id="notificationContainer" class="fixed top-24 right-5 z-[60] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='dashboard.html'">
                    <div class="w-10 h-10 bg-orange-custom rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <span class="text-2xl md:text-3xl text-orange-600 font-handwriting pt-1">To√°n th·∫ßy Choang Choang</span>
                </div>

                <!-- User Info & Logout -->
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block cursor-pointer hover:opacity-80 transition-opacity" id="userInfoText">
                        <p id="userNameDisplay" class="text-sm font-bold text-gray-700">ƒêang t·∫£i...</p>
                        <p id="userRoleDisplay" class="text-xs text-gray-500">...</p>
                    </div>
                    <div id="avatarBtn" class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border-2 border-orange-200 cursor-pointer hover:border-orange-500 transition-colors shadow-sm">
                        <img id="userAvatar" src="https://via.placeholder.com/150" alt="User" class="w-full h-full object-cover">
                    </div>
                    <button id="logoutBtn" class="bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 p-2 rounded-full transition-colors" title="ƒêƒÉng xu·∫•t">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-8 text-white mb-10 shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-3xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</h1>
                <p class="opacity-90">S·∫µn s√†ng chinh ph·ª•c ƒë·ªânh cao tri th·ª©c h√¥m nay ch∆∞a?</p>
            </div>
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10"></div>
            <div class="absolute bottom-0 right-20 w-32 h-32 rounded-full bg-white opacity-10"></div>
        </div>

        <!-- === KHU V·ª∞C GI√ÅO VI√äN === -->
        <div id="teacherSection" class="hidden mb-12">
            <div class="flex items-center gap-2 mb-6">
                <div class="h-8 w-1 bg-orange-500 rounded-full"></div>
                <h2 class="text-2xl font-bold text-gray-800">Khu v·ª±c Gi√°o vi√™n</h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Qu·∫£n l√Ω L·ªõp h·ªçc -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-users-rectangle mr-2 text-blue-500"></i>Qu·∫£n l√Ω L·ªõp h·ªçc</h3>
                        <button id="createClassBtn" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors">
                            + T·∫°o l·ªõp
                        </button>
                    </div>
                    <div id="classList" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        <p class="text-gray-400 text-sm italic text-center py-4">Ch∆∞a c√≥ l·ªõp h·ªçc n√†o.</p>
                    </div>
                </div>

                <!-- Qu·∫£n l√Ω ƒê·ªÅ thi -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-file-pen mr-2 text-green-500"></i>Ng√¢n h√†ng ƒê·ªÅ thi</h3>
                        <button id="createExamBtn" class="px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors">
                            + So·∫°n ƒë·ªÅ
                        </button>
                    </div>
                    <div id="examList" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        <p class="text-gray-400 text-sm italic text-center py-4">Ch∆∞a c√≥ ƒë·ªÅ thi n√†o.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch m√¥n thi -->
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-orange-500 pl-4">Ch·ªçn m√¥n thi (H·ªçc sinh)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- M√¥n To√°n -->
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-calculator"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">To√°n H·ªçc</h3>
                <p class="text-gray-500 text-sm mb-4">R√®n luy·ªán t∆∞ duy logic v·ªõi c√°c b√†i to√°n th√∫ v·ªã.</p>
                <button onclick="window.location.href='exam.html'" class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
            <!-- Ti·∫øng Vi·ªát -->
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-book-open"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Vi·ªát</h3>
                <p class="text-gray-500 text-sm mb-4">Kh√°m ph√° v·∫ª ƒë·∫πp ng√¥n ng·ªØ qua c√°c c√¢u ƒë·ªë.</p>
                <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-green-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
             <!-- Ti·∫øng Anh -->
             <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-language"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Anh</h3>
                <p class="text-gray-500 text-sm mb-4">N√¢ng cao kh·∫£ nƒÉng ngo·∫°i ng·ªØ m·ªói ng√†y.</p>
                <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-purple-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
        </div>
    </main>

    <!-- MODAL PROFILE -->
    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl">
                <p class="text-xl font-bold text-orange-800">Th√¥ng tin c√° nh√¢n</p>
                <div id="closeModalBtn" class="cursor-pointer z-50 p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            <div class="py-6 px-6 space-y-4">
                <div class="flex justify-center mb-4">
                    <div class="relative group">
                        <img id="modalAvatar" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-4 border-orange-200 shadow-md">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="editDisplayName" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Ng√†y sinh</label>
                        <input type="date" id="editBirthDate" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Vai tr√≤</label>
                        <select id="editRole" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 bg-white">
                            <option value="student">H·ªçc sinh</option>
                            <option value="teacher">Gi√°o vi√™n</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div id="saveStatus" class="text-center text-sm font-bold hidden p-2 rounded bg-gray-50"></div>
            </div>
            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl">
                <button id="cancelBtn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-colors">H·ªßy b·ªè</button>
                <button id="saveProfileBtn" class="px-6 py-2 bg-orange-custom text-white rounded-lg hover:bg-orange-600 font-bold shadow-md transition-all active:scale-95">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- MODAL QU·∫¢N L√ù L·ªöP H·ªåC (ƒê√É N√ÇNG C·∫§P TABS) -->
    <div id="classModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-5xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300" style="max-height: 90vh;">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-blue-50 rounded-t-2xl">
                <!-- T√™n l·ªõp h·ªçc v·ªõi n√∫t ch·ªânh s·ª≠a -->
                <div class="flex items-center gap-2">
                    <p class="text-xl font-bold text-blue-800" id="classModalTitle">Chi ti·∫øt L·ªõp h·ªçc</p>
                    <button onclick="editClassName()" class="text-blue-400 hover:text-blue-600 p-1 rounded transition-colors" title="ƒê·ªïi t√™n l·ªõp">
                        <i class="fa-solid fa-pen text-sm"></i>
                    </button>
                </div>
                <div onclick="toggleClassModal(false)" class="cursor-pointer z-50 p-2 hover:bg-blue-200 rounded-full text-blue-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex px-6 border-b border-gray-100">
                <button onclick="switchTab('students')" id="tabBtnStudents" class="tab-btn active px-4 py-3 text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">
                    <i class="fa-solid fa-users mr-1"></i> Danh s√°ch h·ªçc sinh
                </button>
                <button onclick="switchTab('exams')" id="tabBtnExams" class="tab-btn px-4 py-3 text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors">
                    <i class="fa-solid fa-file-contract mr-1"></i> B√†i t·∫≠p, ƒê·ªÅ thi
                </button>
            </div>
            
            <div class="p-6">
                <!-- TAB 1: DANH S√ÅCH H·ªåC SINH -->
                <div id="tabContentStudents" class="space-y-6">
                    <!-- Tab th√™m h·ªçc sinh nhanh -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-gray-700 text-sm uppercase"><i class="fa-solid fa-user-plus mr-1"></i> Th√™m nhanh</h4>
                            <div class="flex gap-2">
                                <button onclick="downloadTemplate()" class="text-xs px-3 py-1 bg-white border border-green-500 text-green-600 rounded hover:bg-green-50 transition-colors" title="T·∫£i file Excel m·∫´u"><i class="fa-solid fa-download"></i> File m·∫´u</button>
                                <label for="excelInput" class="text-xs px-3 py-1 bg-green-500 text-white rounded cursor-pointer hover:bg-green-600 transition-colors flex items-center gap-1"><i class="fa-solid fa-file-excel"></i> Nh·∫≠p t·ª´ Excel</label>
                                <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(this)">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input type="text" id="newStudentName" placeholder="H·ªç v√† t√™n" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                            <input type="text" id="newStudentUser" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                            <input type="text" id="newStudentPass" placeholder="M·∫≠t kh·∫©u" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                        </div>
                        <button id="addStudentBtn" class="mt-3 w-full py-2 bg-blue-500 text-white rounded-lg font-bold text-sm hover:bg-blue-600 transition-colors"><i class="fa-solid fa-plus mr-1"></i> Th√™m v√†o danh s√°ch</button>
                    </div>

                    <!-- Danh s√°ch h·ªçc sinh chi ti·∫øt -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Danh s√°ch h·ªçc sinh <span id="studentCountBadge" class="ml-2 bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded-full">0</span></h4>
                        <div class="overflow-x-auto border rounded-lg max-h-80 overflow-y-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3">STT</th>
                                        <th class="px-4 py-3">H·ªç t√™n</th>
                                        <th class="px-4 py-3">SBD</th>
                                        <th class="px-4 py-3">T√†i kho·∫£n</th>
                                        <th class="px-4 py-3">M·∫≠t kh·∫©u</th>
                                        <th class="px-4 py-3 text-center">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="studentListTable" class="divide-y divide-gray-100">
                                    <!-- JS s·∫Ω render v√†o ƒë√¢y -->
                                </tbody>
                            </table>
                            <p id="emptyStudentMsg" class="text-center py-8 text-gray-400 italic hidden">Ch∆∞a c√≥ h·ªçc sinh n√†o.</p>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: B√ÄI T·∫¨P & ƒê·ªÄ THI -->
                <div id="tabContentExams" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-gray-700 text-sm uppercase">Danh s√°ch b√†i t·∫≠p c·ªßa l·ªõp</h4>
                        <button onclick="showNotification('Ch·ª©c nƒÉng t·∫°o ƒë·ªÅ thi ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!', 'info')" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold text-sm hover:bg-blue-600 transition-colors">
                            <i class="fa-solid fa-plus mr-1"></i> T·∫°o b√†i t·∫≠p m·ªõi
                        </button>
                    </div>
                    
                    <div class="border rounded-xl p-8 text-center bg-gray-50 border-dashed border-gray-300">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 text-2xl">
                            <i class="fa-solid fa-file-invoice"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Ch∆∞a c√≥ b√†i t·∫≠p n√†o</h3>
                        <p class="text-gray-500 text-sm mb-4">H√£y t·∫°o b√†i t·∫≠p m·ªõi ƒë·ªÉ giao cho h·ªçc sinh trong l·ªõp n√†y.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL S·ª¨A TH√îNG TIN H·ªåC SINH (M·ªöI) -->
    <div id="editStudentModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-xl mx-auto rounded-2xl shadow-2xl z-[60] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl">
                <p class="text-xl font-bold text-orange-800">S·ª≠a th√¥ng tin h·ªçc sinh</p>
                <div onclick="toggleEditStudentModal(false)" class="cursor-pointer p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">H·ªç v√† t√™n</label>
                        <input type="text" id="editStuName" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">S·ªë b√°o danh (SBD)</label>
                        <input type="text" id="editStuSBD" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Gi·ªõi t√≠nh</label>
                        <select id="editStuGender" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 bg-white">
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                        </select>
                    </div>
                </div>

                <!-- Li√™n l·∫°c -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">SƒêT H·ªçc sinh</label>
                        <input type="text" id="editStuPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">SƒêT Ph·ª• huynh</label>
                        <input type="text" id="editStuParentPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Email</label>
                        <input type="email" id="editStuEmail" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- T√†i kho·∫£n & M·∫≠t kh·∫©u -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h5 class="text-xs font-bold text-blue-800 uppercase mb-3">Th√¥ng tin ƒëƒÉng nh·∫≠p</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p</label>
                            <input type="text" id="editStuUsername" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-100 focus:outline-none text-gray-500 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">M·∫≠t kh·∫©u</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="password" id="editStuPassword" class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500 pr-10">
                                    <div onclick="togglePasswordVisibility('editStuPassword')" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400 hover:text-gray-600">
                                        <i class="fa-regular fa-eye"></i>
                                    </div>
                                </div>
                                <button onclick="refreshPassword()" class="px-3 py-2 bg-white border border-blue-300 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors text-xs font-bold" title="T·∫°o m·∫≠t kh·∫©u m·ªõi">
                                    <i class="fa-solid fa-rotate"></i> L√†m m·ªõi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl">
                <button onclick="toggleEditStudentModal(false)" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-colors">H·ªßy</button>
                <button id="saveStudentBtn" class="px-6 py-2 bg-orange-custom text-white rounded-lg hover:bg-orange-600 font-bold shadow-md transition-all active:scale-95">L∆∞u th√¥ng tin</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elements & Vars
        let currentUserUid = null;
        let currentRole = 'student';
        let currentViewingClassId = null;
        let currentClassStudents = []; // L∆∞u danh s√°ch h·ªçc sinh hi·ªán t·∫°i ƒë·ªÉ s·ª≠a
        let editingStudentIndex = -1; // Index c·ªßa h·ªçc sinh ƒëang s·ª≠a

        // DOM Elements
        const teacherSection = document.getElementById('teacherSection');
        const classList = document.getElementById('classList');
        const classModal = document.getElementById('classModal');
        const editStudentModal = document.getElementById('editStudentModal');
        const studentListTable = document.getElementById('studentListTable');
        const studentCountBadge = document.getElementById('studentCountBadge');
        const classModalTitle = document.getElementById('classModalTitle');
        
        // Popup
        window.showNotification = function(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-white border-l-4 border-green-500' : (type === 'info' ? 'bg-white border-l-4 border-blue-500' : 'bg-white border-l-4 border-red-500');
            const icon = type === 'success' ? 'fa-check-circle text-green-500' : (type === 'info' ? 'fa-info-circle text-blue-500' : 'fa-exclamation-circle text-red-500');
            
            toast.className = `notification-toast pointer-events-auto w-80 max-w-full shadow-lg rounded-lg overflow-hidden flex ring-1 ring-black ring-opacity-5 ${bgColor}`;
            toast.innerHTML = `<div class="p-4 flex items-start w-full"><div class="flex-shrink-0"><i class="fa-solid ${icon} text-xl"></i></div><div class="ml-3 w-0 flex-1 pt-0.5"><p class="text-sm font-medium text-gray-900">${type==='success'?'Th√†nh c√¥ng':(type==='info'?'Th√¥ng b√°o':'Th·∫•t b·∫°i')}</p><p class="mt-1 text-sm text-gray-500">${message}</p></div><div class="ml-4 flex-shrink-0 flex"><button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500"><i class="fa-solid fa-times"></i></button></div></div>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hide'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        currentRole = data.role || 'student';
                        
                        document.getElementById('userNameDisplay').textContent = data.displayName || user.displayName || user.email;
                        document.getElementById('userRoleDisplay').textContent = currentRole === 'teacher' ? 'Gi√°o vi√™n' : (currentRole === 'admin' ? 'Admin' : 'H·ªçc sinh');
                        
                        // Fill Profile Modal
                        document.getElementById('editDisplayName').value = data.displayName || "";
                        document.getElementById('editBirthDate').value = data.birthDate || "";
                        document.getElementById('editRole').value = currentRole;

                        if (currentRole === 'teacher' || currentRole === 'admin') {
                            teacherSection.classList.remove('hidden');
                            loadTeacherData();
                        } else {
                            teacherSection.classList.add('hidden');
                        }
                    }
                    document.getElementById('userAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random&color=fff&background=F97316`;
                } catch (e) { console.error(e); }
            } else {
                window.location.href = "index.html";
            }
        });

        // TEACHER LOGIC
        function loadTeacherData() {
            const qClasses = query(collection(db, "classes"), where("teacherId", "==", currentUserUid));
            onSnapshot(qClasses, (snapshot) => {
                classList.innerHTML = '';
                if (snapshot.empty) classList.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-4">Ch∆∞a c√≥ l·ªõp h·ªçc n√†o.</p>';
                else {
                    snapshot.forEach(doc => {
                        const cl = doc.data();
                        const div = document.createElement('div');
                        div.className = "p-3 bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-lg flex justify-between items-center cursor-pointer transition-colors";
                        div.innerHTML = `<div><p class="font-bold text-gray-800">${cl.name}</p><p class="text-xs text-gray-500">${cl.studentCount || 0} h·ªçc sinh</p></div><i class="fa-solid fa-chevron-right text-gray-400"></i>`;
                        div.onclick = () => openClassModal(doc.id, cl.name, cl.students || []);
                        classList.appendChild(div);
                    });
                }
            });
        }

        document.getElementById('createClassBtn').addEventListener('click', async () => {
            const className = prompt("Nh·∫≠p t√™n l·ªõp h·ªçc m·ªõi:");
            if (className) {
                try {
                    await addDoc(collection(db, "classes"), { name: className, teacherId: currentUserUid, createdAt: new Date().toISOString(), students: [], studentCount: 0 });
                    showNotification("T·∫°o l·ªõp th√†nh c√¥ng!", "success");
                } catch (e) { showNotification("L·ªói: " + e.message, "error"); }
            }
        });

        // CLASS MODAL
        window.toggleClassModal = function(show) {
            const body = document.querySelector('body');
            const container = classModal.querySelector('.modal-container');
            if (show) {
                classModal.classList.remove('opacity-0', 'pointer-events-none');
                body.classList.add('modal-active');
                container.classList.remove('scale-95'); container.classList.add('scale-100');
            } else {
                classModal.classList.add('opacity-0', 'pointer-events-none');
                body.classList.remove('modal-active');
                container.classList.remove('scale-100'); container.classList.add('scale-95');
                currentViewingClassId = null;
            }
        }

        function openClassModal(classId, className, students) {
            currentViewingClassId = classId;
            currentClassStudents = students || [];
            document.getElementById('classModalTitle').textContent = `Qu·∫£n l√Ω: ${className}`;
            renderStudentList(currentClassStudents);
            window.switchTab('students'); // M·∫∑c ƒë·ªãnh m·ªü tab h·ªçc sinh
            window.toggleClassModal(true);
        }

        // TABS LOGIC
        window.switchTab = function(tabName) {
            const btnStudents = document.getElementById('tabBtnStudents');
            const btnExams = document.getElementById('tabBtnExams');
            const contentStudents = document.getElementById('tabContentStudents');
            const contentExams = document.getElementById('tabContentExams');

            if (tabName === 'students') {
                btnStudents.classList.add('active');
                btnExams.classList.remove('active');
                contentStudents.classList.remove('hidden');
                contentExams.classList.add('hidden');
            } else {
                btnStudents.classList.remove('active');
                btnExams.classList.add('active');
                contentStudents.classList.add('hidden');
                contentExams.classList.remove('hidden');
            }
        }

        // RENAME CLASS
        window.editClassName = async function() {
            if (!currentViewingClassId) return;
            const currentName = document.getElementById('classModalTitle').textContent.replace('Qu·∫£n l√Ω: ', '');
            const newName = prompt("Nh·∫≠p t√™n m·ªõi cho l·ªõp:", currentName);
            
            if (newName && newName !== currentName) {
                try {
                    const classRef = doc(db, "classes", currentViewingClassId);
                    await updateDoc(classRef, { name: newName });
                    document.getElementById('classModalTitle').textContent = `Qu·∫£n l√Ω: ${newName}`;
                    showNotification("ƒê·ªïi t√™n l·ªõp th√†nh c√¥ng!", "success");
                } catch(e) {
                    showNotification("L·ªói: " + e.message, "error");
                }
            }
        }

        function renderStudentList(students) {
            studentListTable.innerHTML = '';
            studentCountBadge.textContent = students ? students.length : 0;

            if (!students || students.length === 0) {
                document.getElementById('emptyStudentMsg').classList.remove('hidden');
            } else {
                document.getElementById('emptyStudentMsg').classList.add('hidden');
                students.forEach((st, index) => {
                    const row = document.createElement('tr');
                    row.className = "bg-white hover:bg-gray-50 border-b";
                    // M·∫≠t kh·∫©u hi·ªÉn th·ªã d·∫°ng ·∫©n
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 font-medium text-gray-900">${st.name}</td>
                        <td class="px-4 py-3 text-gray-500">${st.sbd || '---'}</td>
                        <td class="px-4 py-3 text-blue-600 font-medium">${st.username}</td>
                        <td class="px-4 py-3 font-mono text-gray-400">******</td> 
                        <td class="px-4 py-3 text-center">
                            <button onclick="openEditStudent(${index})" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors mr-1" title="S·ª≠a"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteStudent(${index})" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors" title="X√≥a"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    studentListTable.appendChild(row);
                });
            }
        }

        // --- EDIT STUDENT MODAL LOGIC ---
        window.toggleEditStudentModal = function(show) {
            const container = editStudentModal.querySelector('.modal-container');
            if (show) {
                editStudentModal.classList.remove('opacity-0', 'pointer-events-none');
                container.classList.remove('scale-95'); container.classList.add('scale-100');
            } else {
                editStudentModal.classList.add('opacity-0', 'pointer-events-none');
                container.classList.remove('scale-100'); container.classList.add('scale-95');
                editingStudentIndex = -1;
            }
        }

        // Helper: Toggle Password Visibility
        window.togglePasswordVisibility = function(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === "password" ? "text" : "password";
        }

        // Helper: Random Password
        window.refreshPassword = function() {
            const chars = "0123456789abcdefghijklmnopqrstuvwxyz";
            let password = "";
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('editStuPassword').value = password;
            // Chuy·ªÉn sang text ƒë·ªÉ GV nh√¨n th·∫•y ngay
            document.getElementById('editStuPassword').type = "text"; 
        }

        window.openEditStudent = function(index) {
            editingStudentIndex = index;
            const st = currentClassStudents[index];
            
            // Fill data
            document.getElementById('editStuName').value = st.name || '';
            document.getElementById('editStuSBD').value = st.sbd || '';
            document.getElementById('editStuGender').value = st.gender || 'Nam';
            document.getElementById('editStuPhone').value = st.phoneStudent || '';
            document.getElementById('editStuParentPhone').value = st.phoneParent || '';
            document.getElementById('editStuEmail').value = st.email || '';
            
            document.getElementById('editStuUsername').value = st.username || '';
            document.getElementById('editStuPassword').value = st.password || '';
            document.getElementById('editStuPassword').type = "password"; // Reset v·ªÅ ·∫©n

            window.toggleEditStudentModal(true);
        }

        // L∆ØU KHI S·ª¨A
        document.getElementById('saveStudentBtn').addEventListener('click', async () => {
            if (editingStudentIndex === -1 || !currentViewingClassId) return;

            // L·∫•y d·ªØ li·ªáu m·ªõi
            const updatedStudent = {
                ...currentClassStudents[editingStudentIndex], // Gi·ªØ l·∫°i c√°c tr∆∞·ªùng c≈© (nh∆∞ createdAt)
                name: document.getElementById('editStuName').value,
                sbd: document.getElementById('editStuSBD').value,
                gender: document.getElementById('editStuGender').value,
                phoneStudent: document.getElementById('editStuPhone').value,
                phoneParent: document.getElementById('editStuParentPhone').value,
                email: document.getElementById('editStuEmail').value,
                username: document.getElementById('editStuUsername').value, // Th∆∞·ªùng kh√¥ng cho s·ª≠a username nh∆∞ng ·ªü ƒë√¢y cho ph√©p
                password: document.getElementById('editStuPassword').value
            };

            if(!updatedStudent.name || !updatedStudent.username || !updatedStudent.password) {
                showNotification("T√™n, T√†i kho·∫£n v√† M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "error");
                return;
            }

            try {
                // C·∫≠p nh·∫≠t m·∫£ng local
                currentClassStudents[editingStudentIndex] = updatedStudent;

                // C·∫≠p nh·∫≠t Firestore (Ghi ƒë√® l·∫°i m·∫£ng students)
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, {
                    students: currentClassStudents
                });

                showNotification("C·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh th√†nh c√¥ng!", "success");
                renderStudentList(currentClassStudents);
                window.toggleEditStudentModal(false);

            } catch (e) {
                console.error(e);
                showNotification("L·ªói khi l∆∞u: " + e.message, "error");
            }
        });

        // X√ìA H·ªåC SINH
        window.deleteStudent = async function(index) {
            if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh n√†y kh·ªèi l·ªõp?")) return;
            
            try {
                // X√≥a kh·ªèi m·∫£ng local
                currentClassStudents.splice(index, 1);
                
                // Update DB
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, {
                    students: currentClassStudents,
                    studentCount: currentClassStudents.length
                });
                
                renderStudentList(currentClassStudents);
                showNotification("ƒê√£ x√≥a h·ªçc sinh.", "success");
            } catch(e) {
                showNotification("L·ªói x√≥a: " + e.message, "error");
            }
        }

        // --- C√ÅC CH·ª®C NƒÇNG C≈® (TH√äM NHANH, EXCEL) ---
        document.getElementById('addStudentBtn').addEventListener('click', async () => {
            if (!currentViewingClassId) return;
            const name = document.getElementById('newStudentName').value;
            const user = document.getElementById('newStudentUser').value;
            const pass = document.getElementById('newStudentPass').value;

            if (!name || !user || !pass) { showNotification("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error"); return; }

            const newStudent = { name, username: user, password: pass, createdAt: new Date().toISOString() };
            try {
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, { students: arrayUnion(newStudent) });
                
                // Reload data manually to sync
                const updatedDoc = await getDoc(classRef);
                currentClassStudents = updatedDoc.data().students;
                renderStudentList(currentClassStudents);
                await updateDoc(classRef, { studentCount: currentClassStudents.length });
                
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentUser').value = '';
                document.getElementById('newStudentPass').value = '';
                showNotification("Th√™m th√†nh c√¥ng!", "success");
            } catch (e) { showNotification("L·ªói: " + e.message, "error"); }
        });

        window.downloadTemplate = function() {
            const data = [["H·ªç v√† t√™n", "T√™n ƒëƒÉng nh·∫≠p", "M·∫≠t kh·∫©u", "SBD", "Gi·ªõi t√≠nh", "SƒêT HS", "SƒêT PHHS"], ["Nguy·ªÖn VƒÉn A", "nguyenvana", "123456", "001", "Nam", "098...", "091..."]];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DanhSach");
            XLSX.writeFile(wb, "Mau_DS_Hoc_Sinh.xlsx");
        }

        window.handleFileUpload = function(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                
                const studentsToAdd = [];
                for(let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if(row[0] && row[1]) {
                        studentsToAdd.push({
                            name: row[0], username: row[1], password: String(row[2] || '123456'),
                            sbd: row[3] || '', gender: row[4] || 'Nam', phoneStudent: row[5] || '', phoneParent: row[6] || '',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                if (studentsToAdd.length > 0 && currentViewingClassId) {
                    try {
                        const classRef = doc(db, "classes", currentViewingClassId);
                        // C·∫ßn l·∫•y list c≈© ra r·ªìi n·ªëi v√†o ƒë·ªÉ tr√°nh ghi ƒë√® m·∫•t data c≈© n·∫øu d√πng updateDoc th√¥ng th∆∞·ªùng v·ªõi m·∫£ng
                        // Nh∆∞ng ·ªü ƒë√¢y ta d√πng logic n·ªëi m·∫£ng:
                        const newFullList = [...currentClassStudents, ...studentsToAdd];
                        await updateDoc(classRef, { students: newFullList, studentCount: newFullList.length });
                        currentClassStudents = newFullList;
                        renderStudentList(newFullList);
                        showNotification(`ƒê√£ th√™m ${studentsToAdd.length} h·ªçc sinh!`, "success");
                    } catch(err) { showNotification("L·ªói: " + err.message, "error"); }
                }
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        // PROFILE & OTHER MODALS
        const profileModal = document.getElementById('profileModal');
        const profileContainer = profileModal.querySelector('.modal-container');
        window.toggleProfileModal = function(show) { /* Logic c≈© */ }
        document.getElementById('avatarBtn').addEventListener('click', toggleProfileModal); // C·∫ßn ƒë·ªãnh nghƒ©a l·∫°i h√†m toggleProfileModal ƒë·∫ßy ƒë·ªß ho·∫∑c copy l·∫°i t·ª´ code c≈© n·∫øu c·∫ßn ch·ªânh s·ª≠a s√¢u
        
        // ... (Gi·ªØ nguy√™n c√°c logic Profile c≈© n·∫øu kh√¥ng thay ƒë·ªïi g√¨, ·ªü ƒë√¢y m√¨nh vi·∫øt g·ªçn l·∫°i ƒë·ªÉ v·ª´a trong response)
        // L∆∞u √Ω: ƒêo·∫°n code Profile Modal Logic ·ªü version tr∆∞·ªõc v·∫´n ho·∫°t ƒë·ªông t·ªët, m√¨nh ch·ªâ ƒë·∫£m b·∫£o c√°c ID kh√¥ng b·ªã tr√πng l·∫∑p.
        
        // Re-implement Profile Toggle to be safe
        const toggleModal = (show) => {
            const body = document.querySelector('body');
            if(show) {
                profileModal.classList.remove('opacity-0', 'pointer-events-none');
                profileContainer.classList.remove('scale-95'); profileContainer.classList.add('scale-100');
            } else {
                profileModal.classList.add('opacity-0', 'pointer-events-none');
                profileContainer.classList.remove('scale-100'); profileContainer.classList.add('scale-95');
            }
        }
        document.getElementById('avatarBtn').addEventListener('click', () => toggleModal(true));
        document.getElementById('closeModalBtn').addEventListener('click', () => toggleModal(false));
        document.getElementById('cancelBtn').addEventListener('click', () => toggleModal(false));
        document.getElementById('logoutBtn').addEventListener('click', () => { if(confirm("ƒêƒÉng xu·∫•t?")) signOut(auth).then(() => window.location.href = "index.html"); });
        
        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            const newName = document.getElementById('editDisplayName').value;
            const newRole = document.getElementById('editRole').value;
            const newBirth = document.getElementById('editBirthDate').value;
            try {
                await setDoc(doc(db, "users", currentUserUid), { displayName: newName, role: newRole, birthDate: newBirth }, { merge: true });
                showNotification("C·∫≠p nh·∫≠t Profile th√†nh c√¥ng!", "success");
                setTimeout(() => location.reload(), 1000);
            } catch(e) { showNotification("L·ªói: " + e.message, "error"); }
        });

    </script>
</body>
</html>
