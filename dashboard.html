<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫£nh ch√≠nh - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #FFF8F0; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='dashboard.html'">
                    <div class="w-10 h-10 bg-orange-custom rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <span class="text-2xl md:text-3xl text-orange-600 font-handwriting pt-1">To√°n th·∫ßy Choang Choang</span>
                </div>

                <!-- User Info & Logout -->
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block cursor-pointer hover:opacity-80 transition-opacity" id="userInfoText">
                        <p id="userNameDisplay" class="text-sm font-bold text-gray-700">ƒêang t·∫£i...</p>
                        <p id="userRoleDisplay" class="text-xs text-gray-500">...</p>
                    </div>
                    <div id="avatarBtn" class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border-2 border-orange-200 cursor-pointer hover:border-orange-500 transition-colors shadow-sm">
                        <img id="userAvatar" src="https://via.placeholder.com/150" alt="User" class="w-full h-full object-cover">
                    </div>
                    <button id="logoutBtn" class="bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 p-2 rounded-full transition-colors" title="ƒêƒÉng xu·∫•t">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-8 text-white mb-10 shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-3xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</h1>
                <p class="opacity-90">S·∫µn s√†ng chinh ph·ª•c ƒë·ªânh cao tri th·ª©c h√¥m nay ch∆∞a?</p>
            </div>
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10"></div>
            <div class="absolute bottom-0 right-20 w-32 h-32 rounded-full bg-white opacity-10"></div>
        </div>

        <!-- === KHU V·ª∞C GI√ÅO VI√äN (Ch·ªâ hi·ªán khi l√† Gi√°o vi√™n) === -->
        <div id="teacherSection" class="hidden mb-12">
            <div class="flex items-center gap-2 mb-6">
                <div class="h-8 w-1 bg-orange-500 rounded-full"></div>
                <h2 class="text-2xl font-bold text-gray-800">Khu v·ª±c Gi√°o vi√™n</h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- 1. Qu·∫£n l√Ω L·ªõp h·ªçc -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-users-rectangle mr-2 text-blue-500"></i>Qu·∫£n l√Ω L·ªõp h·ªçc</h3>
                        <button id="createClassBtn" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors">
                            + T·∫°o l·ªõp
                        </button>
                    </div>
                    
                    <!-- Danh s√°ch l·ªõp -->
                    <div id="classList" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        <p class="text-gray-400 text-sm italic text-center py-4">Ch∆∞a c√≥ l·ªõp h·ªçc n√†o.</p>
                    </div>
                </div>

                <!-- 2. Qu·∫£n l√Ω ƒê·ªÅ thi -->
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700"><i class="fa-solid fa-file-pen mr-2 text-green-500"></i>Ng√¢n h√†ng ƒê·ªÅ thi</h3>
                        <button id="createExamBtn" class="px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors">
                            + So·∫°n ƒë·ªÅ
                        </button>
                    </div>

                    <!-- Danh s√°ch ƒë·ªÅ thi -->
                    <div id="examList" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        <p class="text-gray-400 text-sm italic text-center py-4">Ch∆∞a c√≥ ƒë·ªÅ thi n√†o.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch m√¥n thi (D√†nh cho H·ªçc sinh & Gi√°o vi√™n test) -->
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-orange-500 pl-4">Ch·ªçn m√¥n thi (H·ªçc sinh)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- M√¥n To√°n -->
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-calculator"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">To√°n H·ªçc</h3>
                <p class="text-gray-500 text-sm mb-4">R√®n luy·ªán t∆∞ duy logic v·ªõi c√°c b√†i to√°n th√∫ v·ªã.</p>
                <button onclick="window.location.href='exam.html'" class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
            <!-- C√°c m√¥n kh√°c... -->
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-book-open"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Vi·ªát</h3>
                <p class="text-gray-500 text-sm mb-4">Kh√°m ph√° v·∫ª ƒë·∫πp ng√¥n ng·ªØ qua c√°c c√¢u ƒë·ªë.</p>
                <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-green-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
             <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-language"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Anh</h3>
                <p class="text-gray-500 text-sm mb-4">N√¢ng cao kh·∫£ nƒÉng ngo·∫°i ng·ªØ m·ªói ng√†y.</p>
                <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-purple-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
        </div>
    </main>

    <!-- MODAL PROFILE -->
    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl">
                <p class="text-xl font-bold text-orange-800">Th√¥ng tin c√° nh√¢n</p>
                <div id="closeModalBtn" class="cursor-pointer z-50 p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            <div class="py-6 px-6 space-y-4">
                <div class="flex justify-center mb-4">
                    <div class="relative group">
                        <img id="modalAvatar" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-4 border-orange-200 shadow-md">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="editDisplayName" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Ng√†y sinh</label>
                        <input type="date" id="editBirthDate" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Vai tr√≤</label>
                        <select id="editRole" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 bg-white">
                            <option value="student">H·ªçc sinh</option>
                            <option value="teacher">Gi√°o vi√™n</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div id="saveStatus" class="text-center text-sm font-bold hidden p-2 rounded bg-gray-50"></div>
            </div>
            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl">
                <button id="cancelBtn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-colors">H·ªßy b·ªè</button>
                <button id="saveProfileBtn" class="px-6 py-2 bg-orange-custom text-white rounded-lg hover:bg-orange-600 font-bold shadow-md transition-all active:scale-95">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- MODAL QU·∫¢N L√ù L·ªöP H·ªåC (NEW) -->
    <div id="classModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300" style="max-height: 90vh;">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-blue-50 rounded-t-2xl">
                <p class="text-xl font-bold text-blue-800" id="classModalTitle">Chi ti·∫øt L·ªõp h·ªçc</p>
                <div onclick="toggleClassModal(false)" class="cursor-pointer z-50 p-2 hover:bg-blue-200 rounded-full text-blue-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            
            <div class="p-6">
                <!-- Th√™m h·ªçc sinh -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                    <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Th√™m h·ªçc sinh m·ªõi</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input type="text" id="newStudentName" placeholder="H·ªç v√† t√™n" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                        <input type="text" id="newStudentUser" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                        <input type="text" id="newStudentPass" placeholder="M·∫≠t kh·∫©u" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                    </div>
                    <button id="addStudentBtn" class="mt-3 w-full py-2 bg-blue-500 text-white rounded-lg font-bold text-sm hover:bg-blue-600 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Th√™m v√†o danh s√°ch
                    </button>
                </div>

                <!-- Danh s√°ch h·ªçc sinh -->
                <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Danh s√°ch h·ªçc sinh</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">H·ªç t√™n</th>
                                <th class="px-4 py-3">T√†i kho·∫£n</th>
                                <th class="px-4 py-3 rounded-tr-lg">M·∫≠t kh·∫©u</th>
                            </tr>
                        </thead>
                        <tbody id="studentListTable">
                            <!-- JS s·∫Ω render v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                    <p id="emptyStudentMsg" class="text-center py-4 text-gray-400 italic hidden">Ch∆∞a c√≥ h·ªçc sinh n√†o.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- C·∫§U H√åNH ---
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elements
        const teacherSection = document.getElementById('teacherSection');
        const classList = document.getElementById('classList');
        const examList = document.getElementById('examList');
        const createClassBtn = document.getElementById('createClassBtn');
        const createExamBtn = document.getElementById('createExamBtn');
        
        // Modal Class Elements
        const classModal = document.getElementById('classModal');
        const classModalTitle = document.getElementById('classModalTitle');
        const studentListTable = document.getElementById('studentListTable');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const emptyStudentMsg = document.getElementById('emptyStudentMsg');

        // Profile Elements
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logoutBtn');
        const avatarBtn = document.getElementById('avatarBtn');
        const userInfoText = document.getElementById('userInfoText');
        const profileModal = document.getElementById('profileModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const editDisplayName = document.getElementById('editDisplayName');
        const editBirthDate = document.getElementById('editBirthDate');
        const editRole = document.getElementById('editRole');
        const modalAvatar = document.getElementById('modalAvatar');
        const saveStatus = document.getElementById('saveStatus');

        let currentUserUid = null;
        let currentRole = 'student';
        let currentViewingClassId = null;

        // 1. AUTH & DATA LOADING
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    let birthDate = '';

                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        currentRole = data.role || 'student';
                        birthDate = data.birthDate || '';
                        
                        // UI Navbar
                        userNameDisplay.textContent = data.displayName || user.displayName || user.email;
                        const roleMap = { 'student': 'H·ªçc sinh', 'teacher': 'Gi√°o vi√™n', 'admin': 'Admin' };
                        userRoleDisplay.textContent = roleMap[currentRole] || currentRole;
                        
                        // Profile Modal Data
                        editDisplayName.value = data.displayName || user.displayName || "";
                        editBirthDate.value = birthDate;
                        editRole.value = currentRole;

                        // === HI·ªÇN TH·ªä GIAO DI·ªÜN GI√ÅO VI√äN ===
                        if (currentRole === 'teacher' || currentRole === 'admin') {
                            teacherSection.classList.remove('hidden');
                            loadTeacherData(); // T·∫£i danh s√°ch l·ªõp & ƒë·ªÅ
                        } else {
                            teacherSection.classList.add('hidden');
                        }
                    }

                    const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random&color=fff&background=F97316`;
                    userAvatar.src = photoURL;
                    modalAvatar.src = photoURL;
                } catch (error) {
                    console.error("L·ªói t·∫£i user:", error);
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // 2. LOGIC GI√ÅO VI√äN
        function loadTeacherData() {
            // T·∫£i danh s√°ch l·ªõp
            const qClasses = query(collection(db, "classes"), where("teacherId", "==", currentUserUid));
            onSnapshot(qClasses, (snapshot) => {
                classList.innerHTML = '';
                if (snapshot.empty) {
                    classList.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-4">Ch∆∞a c√≥ l·ªõp h·ªçc n√†o.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const cl = doc.data();
                        const div = document.createElement('div');
                        div.className = "p-3 bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-lg flex justify-between items-center cursor-pointer transition-colors";
                        div.innerHTML = `
                            <div>
                                <p class="font-bold text-gray-800">${cl.name}</p>
                                <p class="text-xs text-gray-500">${cl.studentCount || 0} h·ªçc sinh</p>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-400"></i>
                        `;
                        div.onclick = () => openClassModal(doc.id, cl.name, cl.students || []);
                        classList.appendChild(div);
                    });
                }
            });

            // T·∫£i danh s√°ch ƒë·ªÅ thi (Gi·∫£ l·∫≠p)
            // Ph·∫ßn n√†y s·∫Ω ph√°t tri·ªÉn th√™m sau
        }

        // T·∫†O L·ªöP M·ªöI
        createClassBtn.addEventListener('click', async () => {
            const className = prompt("Nh·∫≠p t√™n l·ªõp h·ªçc m·ªõi (VD: L·ªõp 5A):");
            if (className) {
                try {
                    await addDoc(collection(db, "classes"), {
                        name: className,
                        teacherId: currentUserUid,
                        createdAt: new Date().toISOString(),
                        students: [], // M·∫£ng ch·ª©a th√¥ng tin h·ªçc sinh
                        studentCount: 0
                    });
                    alert("T·∫°o l·ªõp th√†nh c√¥ng!");
                } catch (e) {
                    alert("L·ªói: " + e.message);
                }
            }
        });

        // T·∫†O ƒê·ªÄ THI (Placeholder)
        createExamBtn.addEventListener('click', () => {
            const examName = prompt("Nh·∫≠p t√™n ƒë·ªÅ thi m·ªõi:");
            if(examName) {
                // T·∫°m th·ªùi ch·ªâ th√¥ng b√°o, sau n√†y s·∫Ω chuy·ªÉn trang so·∫°n th·∫£o
                alert(`ƒê√£ t·∫°o b·∫£n nh√°p ƒë·ªÅ thi: "${examName}". \nT√≠nh nƒÉng so·∫°n th·∫£o chi ti·∫øt ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng.`);
                // Logic l∆∞u v√†o DB s·∫Ω th√™m ·ªü ƒë√¢y
            }
        });

        // QU·∫¢N L√ù CHI TI·∫æT L·ªöP (MODAL)
        window.toggleClassModal = function(show) {
            const body = document.querySelector('body');
            const modalContainer = classModal.querySelector('.modal-container');
            if (show) {
                classModal.classList.remove('opacity-0', 'pointer-events-none');
                body.classList.add('modal-active');
                modalContainer.classList.remove('scale-95');
                modalContainer.classList.add('scale-100');
            } else {
                classModal.classList.add('opacity-0', 'pointer-events-none');
                body.classList.remove('modal-active');
                modalContainer.classList.remove('scale-100');
                modalContainer.classList.add('scale-95');
                currentViewingClassId = null;
            }
        }

        function openClassModal(classId, className, students) {
            currentViewingClassId = classId;
            classModalTitle.textContent = `Qu·∫£n l√Ω: ${className}`;
            renderStudentList(students);
            window.toggleClassModal(true);
        }

        function renderStudentList(students) {
            studentListTable.innerHTML = '';
            if (!students || students.length === 0) {
                emptyStudentMsg.classList.remove('hidden');
            } else {
                emptyStudentMsg.classList.add('hidden');
                students.forEach(st => {
                    const row = document.createElement('tr');
                    row.className = "bg-white border-b hover:bg-gray-50";
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium text-gray-900">${st.name}</td>
                        <td class="px-4 py-3">${st.username}</td>
                        <td class="px-4 py-3 font-mono text-gray-600">${st.password}</td>
                    `;
                    studentListTable.appendChild(row);
                });
            }
        }

        // TH√äM H·ªåC SINH
        addStudentBtn.addEventListener('click', async () => {
            if (!currentViewingClassId) return;
            
            const name = document.getElementById('newStudentName').value;
            const user = document.getElementById('newStudentUser').value;
            const pass = document.getElementById('newStudentPass').value;

            if (!name || !user || !pass) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            const newStudent = { name, username: user, password: pass, createdAt: new Date().toISOString() };

            try {
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, {
                    students: arrayUnion(newStudent),
                    // TƒÉng bi·∫øn ƒë·∫øm h·ªçc sinh (c·∫ßn cloud function ƒë·ªÉ ch√≠nh x√°c tuy·ªát ƒë·ªëi, nh∆∞ng ·ªü ƒë√¢y d√πng client update cho nhanh)
                    // ·ªû ƒë√¢y ta kh√¥ng c·ªông tr·ª±c ti·∫øp ƒë∆∞·ª£c v√¨ Firestore c·∫ßn get tr∆∞·ªõc, ƒë·ªÉ ƒë∆°n gi·∫£n ta ch·ªâ push v√†o m·∫£ng
                });
                
                // C·∫≠p nh·∫≠t l·∫°i UI ngay l·∫≠p t·ª©c (gi·∫£ l·∫≠p v√¨ snapshot s·∫Ω t·ª± lo)
                // Reset form
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentUser').value = '';
                document.getElementById('newStudentPass').value = '';
                
                // Load l·∫°i data m·ªõi nh·∫•t ƒë·ªÉ update count (Snapshot listener b√™n ngo√†i s·∫Ω t·ª± update list l·ªõp)
                const updatedDoc = await getDoc(classRef);
                if(updatedDoc.exists()) {
                    renderStudentList(updatedDoc.data().students);
                    // C·∫≠p nh·∫≠t l·∫°i count
                    await updateDoc(classRef, { studentCount: updatedDoc.data().students.length });
                }

            } catch (e) {
                console.error(e);
                alert("L·ªói th√™m h·ªçc sinh: " + e.message);
            }
        });


        // 3. PROFILE MODAL LOGIC (Gi·ªØ nguy√™n)
        function toggleModal() {
            const body = document.querySelector('body');
            const isOpening = profileModal.classList.contains('opacity-0');
            const modalContainer = profileModal.querySelector('.modal-container');

            if (isOpening) {
                profileModal.classList.remove('opacity-0', 'pointer-events-none');
                body.classList.add('modal-active');
                modalContainer.classList.remove('scale-95');
                modalContainer.classList.add('scale-100');
            } else {
                profileModal.classList.add('opacity-0', 'pointer-events-none');
                body.classList.remove('modal-active');
                modalContainer.classList.remove('scale-100');
                modalContainer.classList.add('scale-95');
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                    saveProfileBtn.disabled = false;
                    saveProfileBtn.textContent = "L∆∞u thay ƒë·ªïi";
                }, 300);
            }
        }

        avatarBtn.addEventListener('click', toggleModal);
        userInfoText.addEventListener('click', toggleModal);
        closeModalBtn.addEventListener('click', toggleModal);
        cancelBtn.addEventListener('click', toggleModal);
        logoutBtn.addEventListener('click', () => { if(confirm("ƒêƒÉng xu·∫•t?")) signOut(auth).then(() => window.location.href = "index.html"); });

        saveProfileBtn.addEventListener('click', async () => {
            if (!currentUserUid) return;
            const newName = editDisplayName.value;
            const newRole = editRole.value;
            const newBirth = editBirthDate.value;

            if (!newName.trim()) { alert("Nh·∫≠p t√™n!"); return; }

            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = 'ƒêang l∆∞u...';
            saveStatus.classList.add('hidden');

            try {
                await setDoc(doc(db, "users", currentUserUid), {
                    displayName: newName,
                    role: newRole,
                    birthDate: newBirth
                }, { merge: true });

                if (auth.currentUser) await updateProfile(auth.currentUser, { displayName: newName }).catch(e=>console.log(e));

                saveStatus.textContent = "Th√†nh c√¥ng! ƒêang t·∫£i l·∫°i...";
                saveStatus.className = "text-center text-sm font-bold text-green-600 block p-2 rounded bg-green-50";
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                saveStatus.textContent = "L·ªói: " + error.message;
                saveStatus.className = "text-center text-sm font-bold text-red-600 block p-2 rounded bg-red-50";
                saveProfileBtn.disabled = false;
            }
        });

    </script>
</body>
</html>
