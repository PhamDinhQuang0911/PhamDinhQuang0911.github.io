<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá th·ªëng qu·∫£n l√Ω - To√°n th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        .nav-item.active { background-color: #FFF7ED; color: #C2410C; border-right: 3px solid #F97316; font-weight: 700; }
        .nav-item i { width: 24px; text-align: center; }
        .explorer-item { transition: all 0.2s; user-select: none; cursor: pointer; }
        .explorer-item:hover { background-color: #EFF6FF; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .explorer-item.drag-over { background-color: #DBEAFE !important; border: 2px dashed #2563EB !important; transform: scale(1.05); z-index: 10; }
        .explorer-item.dragging { opacity: 0.4; border: 2px dashed #9CA3AF; background-color: #F3F4F6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .notification-toast { animation: slideIn 0.5s ease forwards; }
        .notification-toast.hide { animation: fadeOut 0.5s ease forwards; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .glass { backdrop-filter: blur(2px); }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800 bg-gray-50">

    <div id="notificationContainer" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="sidebarOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass transition-opacity"></div>

    <aside id="mainSidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex flex-col z-40 shadow-xl transition-transform duration-300 -translate-x-full md:relative md:translate-x-0 flex-shrink-0">
        <div class="h-16 flex items-center justify-between px-6 border-b border-gray-100 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold shadow-sm"><i class="fa-solid fa-graduation-cap"></i></div>
                <span class="text-lg text-orange-600 font-handwriting pt-1">Th·∫ßy Choang</span>
            </div>
            <button onclick="window.toggleSidebar()" class="md:hidden text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="p-4 border-b border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.openMyProfile()">
                <img id="sidebarAvatar" src="https://placehold.co/150" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                <div class="overflow-hidden"><p id="sidebarName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p><p id="sidebarRole" class="text-xs text-gray-500 truncate">Qu·∫£n tr·ªã vi√™n</p></div>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="switchView('home'); window.toggleSidebar()" id="nav-home" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3 active"><i class="fa-solid fa-house"></i> S·∫£nh ch√≠nh</button>
            <div id="teacherMenu">
                <div class="px-6 mt-4 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Qu·∫£n l√Ω</div>
                <button onclick="switchView('classes'); window.toggleSidebar()" id="nav-classes" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3"><i class="fa-solid fa-chalkboard-user"></i> Danh s√°ch l·ªõp h·ªçc</button>
                <button onclick="switchView('exambank'); window.toggleSidebar()" id="nav-exambank" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3"><i class="fa-solid fa-folder-tree"></i> Ng√¢n h√†ng ƒë·ªÅ thi</button>
                <button onclick="window.location.href='course-manager.html'" id="nav-course-manager" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3"><i class="fa-solid fa-shapes"></i> Qu·∫£n l√Ω Kh√≥a h·ªçc</button>
                <div class="px-6 mt-4 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">C·∫•u h√¨nh H·ªá th·ªëng</div>
                <button onclick="window.openHeroModal(); window.toggleSidebar()" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3"><i class="fa-solid fa-paintbrush"></i> C√†i ƒë·∫∑t Banner & Logo</button>
                <button onclick="window.openPaymentConfigModal(); window.toggleSidebar()" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3"><i class="fa-solid fa-credit-card"></i> C·∫•u h√¨nh Thanh to√°n</button>
                <button onclick="window.cleanUpSystem(); window.toggleSidebar()" class="nav-item w-full text-left px-6 py-3 text-red-600 hover:bg-red-50 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-broom"></i> D·ªçn d·∫πp h·ªá th·ªëng
                </button>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtn" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <div class="md:hidden h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-20 shrink-0 shadow-sm">
            <div class="flex items-center gap-3"><button onclick="window.toggleSidebar()" class="text-gray-600 hover:text-orange-500 text-2xl p-1"><i class="fa-solid fa-bars"></i></button><span class="font-handwriting text-orange-600 text-lg">Th·∫ßy Choang</span></div>
            <div onclick="window.openMyProfile()" class="w-9 h-9 rounded-full bg-gray-100 overflow-hidden border border-gray-200 active:scale-95 transition-transform"><img id="mobileAvatar" src="https://placehold.co/150" class="w-full h-full object-cover"></div>
        </div>

        <div id="view-home" class="view-section flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-6 md:p-8 text-white mb-8 md:mb-10 shadow-lg relative overflow-hidden">
                    <div class="relative z-10"><h1 class="text-2xl md:text-3xl font-bold mb-2">Xin ch√†o Th·∫ßy C√¥! üëã</h1><p class="opacity-90 text-sm md:text-base">Ch√∫c th·∫ßy c√¥ m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£.</p></div>
                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10"></div><div class="absolute bottom-0 right-20 w-32 h-32 rounded-full bg-white opacity-10"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="switchView('classes')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md cursor-pointer transition-all"><div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-users"></i></div><h3 class="font-bold text-lg text-gray-800">Qu·∫£n l√Ω L·ªõp</h3><p class="text-sm text-gray-500">Xem danh s√°ch l·ªõp v√† h·ªçc sinh</p></div>
                    <div onclick="switchView('exambank')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md cursor-pointer transition-all"><div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-file-lines"></i></div><h3 class="font-bold text-lg text-gray-800">Ng√¢n h√†ng ƒë·ªÅ</h3><p class="text-sm text-gray-500">So·∫°n th·∫£o v√† qu·∫£n l√Ω ƒë·ªÅ thi</p></div>
                    <div onclick="window.location.href='course-manager.html'" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md cursor-pointer transition-all"><div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl mb-4"><i class="fa-solid fa-shapes"></i></div><h3 class="font-bold text-lg text-gray-800">Kh√≥a h·ªçc & Banner</h3><p class="text-sm text-gray-500">C√†i ƒë·∫∑t trang ch·ªß v√† kh√≥a h·ªçc</p></div>
                </div>
            </div>
        </div>

        <div id="view-classes" class="view-section hidden flex-1 flex flex-col h-full">
            <div class="bg-white border-b border-gray-200 p-4 md:p-6 flex justify-between items-center shadow-sm z-10">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-chalkboard-user mr-2 text-blue-500"></i> <span class="hidden md:inline">Qu·∫£n l√Ω</span> L·ªõp h·ªçc</h2>
                <button id="createClassBtn" class="px-3 md:px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition-all flex items-center gap-2 text-sm md:text-base"><i class="fa-solid fa-plus"></i> <span class="hidden md:inline">T·∫°o l·ªõp m·ªõi</span><span class="md:hidden">T·∫°o m·ªõi</span></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50">
                <div id="classList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"><p class="text-gray-400 italic col-span-3 text-center py-10">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>
            </div>
        </div>

        <div id="view-teacher-class-detail" class="view-section hidden flex-1 flex flex-col h-full bg-white">
            <div class="h-16 border-b border-gray-200 flex items-center justify-between px-4 md:px-6 bg-white shrink-0 z-10 shadow-sm">
                <div class="flex items-center gap-3 md:gap-4">
                    <button onclick="switchView('classes')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors text-gray-600"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="overflow-hidden">
                        <div class="flex items-center gap-2"><h2 class="text-base md:text-lg font-bold text-blue-800 truncate max-w-[150px] md:max-w-xs" id="teacherClassTitle">Chi ti·∫øt L·ªõp h·ªçc</h2><button onclick="window.editClassName()" class="text-gray-400 hover:text-blue-600 p-1 rounded transition-colors"><i class="fa-solid fa-pen text-xs"></i></button></div>
                        <p class="text-[10px] md:text-xs text-gray-500">Qu·∫£n l√Ω HS & B√†i t·∫≠p</p>
                    </div>
                </div>
                <div class="flex bg-gray-100 p-1 rounded-lg shrink-0">
                    <button onclick="window.switchTab('students')" id="tabBtnStudents" class="px-3 md:px-4 py-1.5 text-xs md:text-sm font-bold rounded-md transition-all text-blue-700 bg-white shadow-sm">H·ªçc sinh</button>
                    <button onclick="window.switchTab('exams')" id="tabBtnExams" class="px-3 md:px-4 py-1.5 text-xs md:text-sm font-bold rounded-md transition-all text-gray-500 hover:text-gray-700">B√†i t·∫≠p</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 w-full">
                <div id="tabContentStudents" class="space-y-4 md:space-y-6 w-full max-w-7xl mx-auto">
                    <div class="bg-white p-4 md:p-6 rounded-2xl border border-gray-200 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                            <h4 class="font-bold text-gray-800 text-sm uppercase flex items-center gap-2"><span class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-user-plus text-xs"></i></span> Th√™m h·ªçc sinh</h4>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="window.addExistingStudent()" class="flex-1 md:flex-none text-xs px-3 py-1.5 bg-purple-100 border border-purple-200 text-purple-700 rounded-lg hover:bg-purple-200 font-bold justify-center flex"><i class="fa-solid fa-magnifying-glass-plus mr-1"></i> T√¨m & Th√™m HS</button>
                                <button onclick="window.downloadTemplate()" class="flex-1 md:flex-none text-xs px-3 py-1.5 bg-white border border-green-500 text-green-600 rounded-lg hover:bg-green-50 font-bold justify-center flex"><i class="fa-solid fa-download mr-1"></i> File m·∫´u</button>
                                <label for="excelInput" class="flex-1 md:flex-none text-xs px-3 py-1.5 bg-green-500 text-white rounded-lg cursor-pointer hover:bg-green-600 flex items-center gap-1 font-bold shadow-green-200 shadow-sm justify-center"><i class="fa-solid fa-file-excel"></i> Nh·∫≠p Excel</label>
                                <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="window.handleFileUpload(this)">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 mb-4">
                            <input type="text" id="newStudentName" placeholder="H·ªç v√† t√™n h·ªçc sinh" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all">
                            <input type="text" id="newStudentUser" placeholder="T√™n ƒëƒÉng nh·∫≠p (VD: quang123)" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all">
                            <input type="text" id="newStudentPass" placeholder="M·∫≠t kh·∫©u" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all">
                        </div>
                        <button id="addStudentBtn" class="w-full py-2.5 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> T·∫°o t√†i kho·∫£n m·ªõi cho l·ªõp</button>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="px-4 md:px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h4 class="font-bold text-gray-800 text-sm uppercase">Danh s√°ch l·ªõp</h4>
                            <span id="studentCountBadge" class="bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-1 rounded-lg">0 h·ªçc sinh</span>
                        </div>
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-sm text-left text-gray-500 min-w-[700px]">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10">
                                    <tr><th class="px-6 py-3 font-bold">STT</th><th class="px-6 py-3 font-bold">H·ªç t√™n</th><th class="px-6 py-3 font-bold">T√†i kho·∫£n</th><th class="px-6 py-3 font-bold">M·∫≠t kh·∫©u</th><th class="px-6 py-3 text-center font-bold">H√†nh ƒë·ªông</th></tr>
                                </thead>
                                <tbody id="studentListTable" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                        <div id="emptyStudentMsg" class="flex flex-col items-center justify-center py-12 text-gray-400 hidden"><i class="fa-solid fa-users-slash text-4xl mb-2 text-gray-300"></i><p>L·ªõp ch∆∞a c√≥ h·ªçc sinh n√†o.</p></div>
                    </div>
                </div>
                <div id="tabContentExams" class="hidden space-y-6 w-full max-w-7xl mx-auto"><div id="teacherExamList" class="space-y-3"></div></div>
            </div>
        </div>

        <div id="view-exambank" class="view-section hidden flex-1 flex flex-col h-full bg-white">
            <div class="h-16 border-b border-gray-200 flex items-center justify-between px-4 md:px-6 bg-white shrink-0">
                <div class="flex items-center gap-2 md:gap-4 overflow-hidden">
                    <div class="flex items-center text-gray-500 text-xs md:text-sm bg-gray-100 px-2 md:px-3 py-1.5 rounded-lg whitespace-nowrap overflow-x-auto no-scrollbar">
                        <button onclick="window.navigateFolder('root')" class="hover:text-blue-600 font-bold flex items-center gap-1" title="V·ªÅ th∆∞ m·ª•c g·ªëc"><i class="fa-solid fa-house"></i></button>
                        <span id="breadcrumbContainer" class="flex items-center"></span>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-3 shrink-0">
                    <div class="bg-gray-100 p-1 rounded-lg flex items-center mr-2">
                        <button onclick="window.switchExplorerView('grid')" id="btnExpGrid" class="p-1.5 rounded text-blue-600 bg-white shadow-sm transition-all" title="L∆∞·ªõi"><i class="fa-solid fa-border-all"></i></button>
                        <button onclick="window.switchExplorerView('list')" id="btnExpList" class="p-1.5 rounded text-gray-400 hover:text-blue-600 transition-all" title="Danh s√°ch"><i class="fa-solid fa-list"></i></button>
                    </div>
                    <button onclick="window.location.href='dashboard-mapid.html'" class="px-3 py-2 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded-lg text-xs md:text-sm font-bold transition-colors mr-1">
                        <i class="fa-solid fa-folder-tree mr-1"></i> <span class="hidden md:inline">C·∫•u h√¨nh MapID</span>
                    </button>
                    <button onclick="window.createNewFolder()" class="px-3 py-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg text-xs md:text-sm font-bold transition-colors"><i class="fa-solid fa-folder-plus mr-1"></i> <span class="hidden md:inline">T·∫°o th∆∞ m·ª•c</span></button>
                    <button onclick="window.location.href='exam-editor.html'" class="px-3 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg text-xs md:text-sm font-bold transition-colors"><i class="fa-solid fa-file-circle-plus mr-1"></i> <span class="hidden md:inline">So·∫°n ƒë·ªÅ m·ªõi</span><span class="md:hidden">So·∫°n ƒë·ªÅ</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50" id="fileExplorerArea">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-4" id="explorerGrid"></div>
                <div id="emptyExplorerMsg" class="hidden flex flex-col items-center justify-center h-64 text-gray-400"><i class="fa-regular fa-folder-open text-6xl mb-4 text-gray-300"></i><p>Th∆∞ m·ª•c tr·ªëng</p></div>
            </div>
        </div>
    </main>

    <div id="heroModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[95] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-orange-50 rounded-t-2xl">
                <h3 class="font-bold text-orange-800 text-lg"><i class="fa-solid fa-paintbrush mr-2"></i>C√†i ƒë·∫∑t Giao di·ªán & Logo</h3>
                <button onclick="window.toggleModal('heroModal', false)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Logo Website</label>
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-white border border-gray-200 rounded-lg flex items-center justify-center overflow-hidden p-1"><img id="logoPreview" src="https://placehold.co/100" class="w-full h-full object-contain"></div>
                        <div class="flex-1"><button onclick="document.getElementById('logoInput').click()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-100 w-full mb-1"><i class="fa-solid fa-cloud-arrow-up"></i> T·∫£i Logo m·ªõi</button><input type="file" id="logoInput" class="hidden" accept="image/*" onchange="window.handleLogoUpload(this)"><p class="text-[10px] text-red-500 italic mt-1">* ·∫¢nh vu√¥ng (100x100px), n·ªÅn trong su·ªët (PNG).</p></div>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <label class="block text-xs font-bold text-blue-700 uppercase mb-2">Ch·ªçn phong c√°ch hi·ªÉn th·ªã</label>
                    <select id="hStyle" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-200 outline-none font-bold text-gray-700 cursor-pointer"><option value="style1">Style 1: C·ªï ƒëi·ªÉn (·∫¢nh ph·∫£i - Ch·ªØ tr√°i)</option><option value="style2">Style 2: Hi·ªán ƒë·∫°i (CƒÉn gi·ªØa - ·∫¢nh l·ªõn)</option><option value="style3">Style 3: Sang tr·ªçng (N·ªÅn t·ªëi - Dark Mode)</option><option value="style4">Style 4: Poster (·∫¢nh n·ªÅn full - Ch·ªØ trong khung)</option><option value="style5">Style 5: Ph√° c√°ch (Chia ƒë√¥i m√†n h√¨nh)</option></select>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Danh s√°ch ·∫£nh Banner (Tr√¨nh chi·∫øu)</label>
                    <div id="heroImageList" class="grid grid-cols-3 gap-3 mb-3 empty:hidden"></div>
                    <button onclick="document.getElementById('heroImgInput').click()" class="w-full py-4 border-2 border-dashed border-teal-300 bg-teal-50 rounded-lg text-teal-700 font-bold hover:bg-white hover:border-teal-500 transition-all flex flex-col items-center justify-center gap-1 shadow-sm"><i class="fa-solid fa-plus-circle text-2xl"></i><span class="text-xs uppercase tracking-wide">Th√™m ·∫£nh v√†o Slide</span></button>
                    <input type="file" id="heroImgInput" class="hidden" accept="image/*" onchange="window.handleHeroImageUpload(this)">
                    <div class="mt-3 text-[10px] text-gray-500 italic border-t border-gray-200 pt-2"><p class="mb-1"><i class="fa-solid fa-circle-info text-teal-600"></i> <b>C∆° ch·∫ø:</b> T·∫£i nhi·ªÅu ·∫£nh ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông (Slide). N·∫øu ch·ªâ t·∫£i 1 ·∫£nh, n√≥ s·∫Ω ƒë·ª©ng y√™n.</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">Ti√™u ƒë·ªÅ d√≤ng 1</label><input type="text" id="hTitle1" class="w-full px-3 py-2 border rounded-lg font-bold"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">Ti√™u ƒë·ªÅ d√≤ng 2 (M√†u ch·ªß ƒë·∫°o)</label><input type="text" id="hTitle2" class="w-full px-3 py-2 border rounded-lg font-black text-orange-600"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">Th·∫ª Tags (NgƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y)</label><input type="text" id="hTags" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="VD: 30 ƒê·ªÅ Thi, Luy·ªán T·ªëc ƒê·ªô"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">M√¥ t·∫£ ng·∫Øn</label><textarea id="hDesc" class="w-full px-3 py-2 border rounded-lg h-20 text-sm"></textarea></div>
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">Ch·ªØ tr√™n n√∫t</label><input type="text" id="hBtnText" class="w-full px-3 py-2 border rounded-lg font-bold"></div>
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">Link n√∫t b·∫•m</label><input type="text" id="hBtnLink" class="w-full px-3 py-2 border rounded-lg text-blue-600"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.toggleModal('heroModal', false)" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-200 rounded-lg text-sm">H·ªßy b·ªè</button>
                <button onclick="window.saveHeroSettings()" class="px-6 py-2 bg-orange-600 text-white font-bold rounded-lg shadow hover:bg-orange-700 text-sm flex items-center gap-2"><i class="fa-solid fa-save"></i> L∆∞u & √Åp d·ª•ng</button>
            </div>
        </div>
    </div>

    <div id="paymentConfigModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[95] flex items-center justify-center bg-gray-900 bg-opacity-60 px-4 transition-opacity duration-300">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-blue-50 rounded-t-2xl">
                <h3 class="font-bold text-blue-800 text-lg"><i class="fa-solid fa-university mr-2"></i>C·∫•u h√¨nh T√†i kho·∫£n Nh·∫≠n ti·ªÅn</h3>
                <button onclick="window.toggleModal('paymentConfigModal', false)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ch·ªçn Ng√¢n h√†ng (Chu·∫©n VietQR)</label>
                    <select id="confBankId" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-200 outline-none font-bold text-blue-700 bg-white cursor-pointer"><option value="970422">MB Bank (Qu√¢n ƒê·ªôi)</option><option value="970454">Timo (Ng√¢n h√†ng s·ªë)</option><option value="970436">Vietcombank</option><option value="970407">Techcombank</option><option value="970415">VietinBank</option><option value="970418">BIDV</option><option value="970416">ACB</option><option value="970432">VPBank</option><option value="970423">TPBank</option><option value="970403">Sacombank</option><option value="970441">VIB</option><option value="970437">HDBank</option><option value="970426">MSB</option><option value="970448">OCB</option><option value="970443">SHB</option></select>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªë t√†i kho·∫£n</label><input type="text" id="confAccountNo" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-200 outline-none font-bold text-xl tracking-wider" placeholder="VD: 033..."></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n ch·ªß t√†i kho·∫£n (Vi·∫øt hoa kh√¥ng d·∫•u)</label><input type="text" id="confAccountName" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-200 outline-none font-bold uppercase" placeholder="VD: PHAM DINH QUANG"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giao di·ªán m√£ QR</label><select id="confTemplate" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-200 outline-none bg-white"><option value="compact2">Hi·ªán ƒë·∫°i (Khuy√™n d√πng)</option><option value="compact">G·ªçn g√†ng</option><option value="qr_only">Ch·ªâ m√£ QR</option><option value="print">B·∫£n in (Print)</option></select></div>
            </div>
            <div class="p-5 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.toggleModal('paymentConfigModal', false)" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-200 rounded-lg text-sm">H·ªßy</button>
                <button onclick="window.savePaymentConfig()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 text-sm flex items-center gap-2"><i class="fa-solid fa-save"></i> L∆∞u c·∫•u h√¨nh</button>
            </div>
        </div>
    </div>

    <div id="editStudentModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60] px-2 md:px-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-full md:max-w-xl mx-auto rounded-2xl shadow-2xl z-[60] overflow-y-auto transform scale-95 transition-transform duration-300 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl shrink-0"><p class="text-xl font-bold text-orange-800">S·ª≠a th√¥ng tin h·ªçc sinh</p><div onclick="window.toggleModal('editStudentModal', false)" class="cursor-pointer p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors"><i class="fa-solid fa-times"></i></div></div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div class="grid grid-cols-2 gap-4"><div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">H·ªç v√† t√™n</label><input type="text" id="editStuName" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">S·ªë b√°o danh</label><input type="text" id="editStuSBD" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">Gi·ªõi t√≠nh</label><select id="editStuGender" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT H·ªçc sinh</label><input type="text" id="editStuPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT Ph·ª• huynh</label><input type="text" id="editStuParentPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div><div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">Email</label><input type="email" id="editStuEmail" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div></div><hr class="border-gray-100"><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h5 class="text-xs font-bold text-blue-800 uppercase mb-3">Th√¥ng tin ƒëƒÉng nh·∫≠p</h5><div class="space-y-3"><div><label class="block text-xs font-bold text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="editStuUsername" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-100 text-gray-500 cursor-not-allowed"></div><div><label class="block text-xs font-bold text-gray-700 mb-1">M·∫≠t kh·∫©u</label><div class="flex gap-2"><div class="relative flex-1"><input type="password" id="editStuPassword" class="w-full px-3 py-2 rounded-lg border border-gray-300 pr-10"><div onclick="window.togglePasswordVisibility('editStuPassword')" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400"><i class="fa-regular fa-eye"></i></div></div><button onclick="window.refreshPassword()" class="px-3 py-2 bg-white border border-blue-300 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-50"><i class="fa-solid fa-rotate"></i> L√†m m·ªõi</button></div></div></div></div>
            </div>
            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl shrink-0"><button onclick="window.toggleModal('editStudentModal', false)" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">H·ªßy</button><button id="saveStudentBtn" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold shadow-md">L∆∞u th√¥ng tin</button></div>
        </div>
    </div>

    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300 px-2 md:px-0">
        <div class="modal-container bg-white w-full max-w-lg rounded-2xl shadow-2xl p-0 transform scale-95 transition-transform duration-300 relative overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-orange-50 to-white flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-id-card text-orange-500"></i> Th√¥ng tin c√° nh√¢n</h3>
                <button onclick="window.toggleModal('profileModal', false)" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 border-b pb-1">Th√¥ng tin c∆° b·∫£n</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">H·ªç v√† t√™n</label><input type="text" id="proDisplayName" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-200 outline-none font-bold text-gray-700"></div>
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">Ng√†y sinh</label><input type="date" id="proBirthDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-200 outline-none"></div>
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">Gi·ªõi t√≠nh</label><select id="proGender" class="w-full px-3 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-orange-200 outline-none"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT C√° nh√¢n</label><input type="tel" id="proPhone" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-200 outline-none"></div>
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT Ph·ª• huynh</label><input type="tel" id="proParentPhone" class="w-full px-3 py-2 border border-gray-200 bg-gray-100 rounded-lg text-gray-500 cursor-not-allowed" readonly title="Li√™n h·ªá gi√°o vi√™n ƒë·ªÉ thay ƒë·ªïi"></div>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> T√†i kho·∫£n & B·∫£o m·∫≠t</h4>
                    <div class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p / Email</label><input type="text" id="proUsername" class="w-full px-3 py-2 border rounded-lg bg-white text-gray-500 font-mono text-sm" readonly></div>
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">ƒê·ªïi m·∫≠t kh·∫©u m·ªõi</label><div class="flex gap-2"><div class="relative flex-1"><input type="password" id="proNewPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (n·∫øu mu·ªën ƒë·ªïi)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-200 outline-none pr-10"><div onclick="window.togglePasswordVisibility('proNewPass')" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400 hover:text-blue-600"><i class="fa-regular fa-eye"></i></div></div><button onclick="window.refreshNewPass()" class="px-3 py-2 bg-white border border-blue-200 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-50" title="T·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n"><i class="fa-solid fa-rotate"></i></button></div><p class="text-[10px] text-gray-500 mt-1 italic">* ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u.</p></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3 shrink-0">
                <button onclick="window.toggleModal('profileModal', false)" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 font-bold hover:bg-gray-100 transition-colors">H·ªßy b·ªè</button>
                <button id="btnSaveMyProfile" class="px-6 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 shadow-md shadow-orange-200 transition-colors flex items-center gap-2"><i class="fa-solid fa-save"></i> L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="genericConfirmModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300 px-4">
        <div class="modal-container bg-white w-[90%] max-w-sm rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 text-center relative">
            <button id="gConfirmClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">X√°c nh·∫≠n</h3><p id="gConfirmMsg" class="text-gray-500 mb-6">?</p>
            <div class="flex justify-center gap-3"><button id="gConfirmCancel" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold">H·ªßy</button><button id="gConfirmOk" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg">ƒê·ªìng √Ω</button></div>
        </div>
    </div>
    <div id="genericInputModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300 px-4">
        <div class="modal-container bg-white w-[90%] max-w-sm rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 relative">
            <button id="gInputClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            <h3 id="gInputTitle" class="text-lg font-bold text-gray-800 mb-4">Nh·∫≠p th√¥ng tin</h3>
            <input type="text" id="gInputVal" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100">
            <div class="flex justify-end gap-3 mt-6"><button id="gInputCancel" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold">H·ªßy</button><button id="gInputConfirm" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg">OK</button></div>
        </div>
    </div>
    <div id="actionModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-50 px-4">
        <div class="modal-container bg-white w-[90%] max-w-sm rounded-2xl shadow-2xl p-6 relative">
            <h3 id="actionModalTitle" class="text-xl font-bold text-gray-800 mb-4">H√†nh ƒë·ªông</h3><div id="dynamicContent"></div> 
            <button onclick="window.toggleModal('actionModal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <script>
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden');
            }
        }
    </script>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, arrayUnion, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js";

        // 1. C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);

        // --- K√çCH HO·∫†T CACHE OFFLINE (TƒÇNG T·ªêC ƒê·ªò T·∫¢I L·∫†I TRANG) ---
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('L·ªói: ƒêang m·ªü qu√° nhi·ªÅu tab (Ch·ªâ 1 tab ƒë∆∞·ª£c d√πng cache).');
            } else if (err.code == 'unimplemented') {
                console.log('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ cache offline (S·∫Ω d√πng ch·∫ø ƒë·ªô Online).');
            }
        });

        // 2. BI·∫æN TO√ÄN C·ª§C
        let currentUser = null;
        let currentUserUid = null;
        let currentRole = 'admin'; 
        let currentViewingClassId = null;
        let currentClassStudents = [];
        let editingStudentIndex = -1;
        let currentFolderId = null;
        let folderData = [];
        let examData = [];
        let currentActionItem = null;
        window.currentHeroImages = [];
        window.currentLogoImg = "";
        // --- VIEW MODE STATE ---
        let currentExplorerView = 'grid'; // M·∫∑c ƒë·ªãnh l√† Grid

        window.switchExplorerView = (mode) => {
            currentExplorerView = mode;
            // C·∫≠p nh·∫≠t m√†u n√∫t b·∫•m
            const btnGrid = document.getElementById('btnExpGrid');
            const btnList = document.getElementById('btnExpList');
            if(mode === 'grid') {
                btnGrid.className = "p-1.5 rounded text-blue-600 bg-white shadow-sm transition-all";
                btnList.className = "p-1.5 rounded text-gray-400 hover:text-blue-600 transition-all";
            } else {
                btnList.className = "p-1.5 rounded text-blue-600 bg-white shadow-sm transition-all";
                btnGrid.className = "p-1.5 rounded text-gray-400 hover:text-blue-600 transition-all";
            }
            renderExplorer(); // V·∫Ω l·∫°i giao di·ªán
        };
        // 3. H·ªÜ TH·ªêNG MODAL & TH√îNG B√ÅO
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            const container = el.querySelector('.modal-container') || el.querySelector('.modal-content');
            if(show) { el.classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); if(container) container.classList.remove('scale-95'); }
            else { el.classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); if(container) container.classList.add('scale-95'); }
        }

        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`view-${viewName}`);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${viewName}`);
            if(activeNav) activeNav.classList.add('active');
        }

        window.showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            const color = type === 'success' ? 'green' : 'red';
            div.className = `notification-toast pointer-events-auto bg-white border-l-4 border-${color}-500 shadow-lg rounded-lg p-4 w-80 flex items-start transform transition-all duration-300`;
            div.innerHTML = `<i class="fa-solid fa-${type==='success'?'check':'circle-exclamation'} text-${color}-500 mt-1 mr-3"></i><div><h4 class="font-bold text-gray-800 text-sm">${type==='success'?'Th√†nh c√¥ng':'L·ªói'}</h4><p class="text-sm text-gray-600">${msg}</p></div>`;
            container.appendChild(div);
            requestAnimationFrame(() => div.classList.remove('translate-x-full'));
            setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 500); }, 3000);
        }

        window.customConfirm = (message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('genericConfirmModal');
                document.getElementById('gConfirmMsg').textContent = message;
                const okBtn = document.getElementById('gConfirmOk');
                const cancelBtn = document.getElementById('gConfirmCancel');
                window.toggleModal('genericConfirmModal', true);
                const close = () => { window.toggleModal('genericConfirmModal', false); okBtn.onclick = null; cancelBtn.onclick = null; };
                okBtn.onclick = () => { close(); resolve(true); };
                cancelBtn.onclick = () => { close(); resolve(false); };
            });
        }

        window.customPrompt = (title, placeholder = '', defaultValue = '') => {
            return new Promise((resolve) => {
                const modal = document.getElementById('genericInputModal');
                document.getElementById('gInputTitle').textContent = title;
                const input = document.getElementById('gInputVal');
                input.value = defaultValue; input.placeholder = placeholder;
                const okBtn = document.getElementById('gInputConfirm');
                const cancelBtn = document.getElementById('gInputCancel');
                window.toggleModal('genericInputModal', true);
                input.focus();
                const close = () => { window.toggleModal('genericInputModal', false); okBtn.onclick = null; cancelBtn.onclick = null; };
                okBtn.onclick = () => { close(); resolve(input.value); };
                cancelBtn.onclick = () => { close(); resolve(null); };
            });
        }

        window.togglePasswordVisibility = (inputId) => { const x = document.getElementById(inputId); x.type = x.type === "password" ? "text" : "password"; }
        window.refreshPassword = () => { const chars = "0123456789abcdefghijklmnopqrstuvwxyz"; let password = ""; for (let i = 0; i < 6; i++) password += chars.charAt(Math.floor(Math.random() * chars.length)); document.getElementById('editStuPassword').value = password; document.getElementById('editStuPassword').type = "text"; }
        window.refreshNewPass = () => { const chars = "0123456789abcdefghijklmnopqrstuvwxyz"; let password = ""; for (let i = 0; i < 6; i++) password += chars.charAt(Math.floor(Math.random() * chars.length)); document.getElementById('proNewPass').value = password; document.getElementById('proNewPass').type = "text"; }

        // 4. AUTH
        const ADMIN_EMAILS = ["phamngockhanh.942001@gmail.com", "phamngockhanh.942002@gmail.com", "admin@gmail.com", "phamdinhquang0911@gmail.com"];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!ADMIN_EMAILS.includes(user.email)) {
                    window.location.href = "student.html";
                    return;
                }
                currentUser = user;
                currentUserUid = user.uid;
                
                // 1. C·∫≠p nh·∫≠t giao di·ªán tƒ©nh NGAY L·∫¨P T·ª®C (L·∫•y t·ª´ cache tr√¨nh duy·ªát n·∫øu c√≥)
                document.getElementById('sidebarName').textContent = user.displayName || user.email;
                document.getElementById('sidebarRole').textContent = 'Qu·∫£n tr·ªã vi√™n';
                const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
                document.getElementById('sidebarAvatar').src = avatarUrl;
                if(document.getElementById('mobileAvatar')) document.getElementById('mobileAvatar').src = avatarUrl;

                // 2. K√çCH HO·∫†T T·∫¢I D·ªÆ LI·ªÜU SONG SONG
                // Nh·ªù B∆∞·ªõc 2 (Cache), d·ªØ li·ªáu c≈© s·∫Ω hi·ªán l√™n NGAY L·∫¨P T·ª®C t·ª´ ·ªï c·ª©ng
                // Sau ƒë√≥ Firebase t·ª± ƒë·ªông t·∫£i ng·∫ßm c√°i m·ªõi v·ªÅ ƒë·ªÉ c·∫≠p nh·∫≠t sau
                const task1 = loadClasses();      
                const task2 = loadFileManager();  
                
                // ƒê·ª£i load xong ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ƒë·ªìng b·ªô (nh∆∞ng nh·ªù cache n√™n s·∫Ω r·∫•t nhanh)
                await Promise.all([task1, task2]);
                
                // 3. G√°n s·ª± ki·ªán
                const createBtn = document.getElementById('createClassBtn');
                if(createBtn) createBtn.onclick = handleCreateClass;
                
                // 4. ƒêi·ªÅu h∆∞·ªõng View
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view');
                if (view && ['classes', 'exambank'].includes(view)) {
                    switchView(view);
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // 5. PROFILE LOGIC
        window.openMyProfile = async () => {
            if (!currentUser) return;
            window.toggleModal('profileModal', true);
            document.getElementById('proNewPass').value = ''; 
            try {
                const docSnap = await getDoc(doc(db, "users", currentUser.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('proDisplayName').value = data.displayName || currentUser.displayName || '';
                    document.getElementById('proBirthDate').value = data.birthDate || '';
                    document.getElementById('proGender').value = data.gender || 'Nam';
                    document.getElementById('proPhone').value = data.phone || '';
                    document.getElementById('proParentPhone').value = data.phoneParent || '';
                    let displayUser = data.email || currentUser.email;
                    if (displayUser.includes('@hocsinh.com')) displayUser = displayUser.split('@')[0];
                    document.getElementById('proUsername').value = displayUser;
                }
            } catch (e) { console.error("L·ªói profile:", e); }
        }

        document.getElementById('btnSaveMyProfile').onclick = async () => {
            const newName = document.getElementById('proDisplayName').value.trim();
            const newPass = document.getElementById('proNewPass').value;
            const btn = document.getElementById('btnSaveMyProfile');
            
            if (!newName) return window.showNotification("H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "error");

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';
            btn.disabled = true;

            try {
                const updates = {
                    displayName: newName,
                    birthDate: document.getElementById('proBirthDate').value,
                    gender: document.getElementById('proGender').value,
                    phone: document.getElementById('proPhone').value
                };

                await updateDoc(doc(db, "users", currentUser.uid), updates);
                await updateProfile(currentUser, { displayName: newName });
                
                if (newPass && newPass.length > 0) {
                    if (newPass.length < 6) throw new Error("M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n.");
                    await updatePassword(currentUser, newPass);
                    window.showNotification("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin v√† m·∫≠t kh·∫©u!", "success");
                } else {
                    window.showNotification("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!", "success");
                }

                document.getElementById('sidebarName').textContent = newName;
                window.toggleModal('profileModal', false);

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (error.code === 'auth/requires-recent-login') msg = "Vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u.";
                window.showNotification("L·ªói: " + msg, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // 6. LOGIC L·ªöP H·ªåC (ƒê·∫¶Y ƒê·ª¶)
        window.handleCreateClass = async () => {
            const name = await window.customPrompt("Nh·∫≠p t√™n l·ªõp h·ªçc m·ªõi:", "VD: L·ªõp 5A");
            if (name) {
                try {
                    await addDoc(collection(db, "classes"), { name: name, teacherId: currentUserUid, studentCount: 0, createdAt: new Date().toISOString() });
                    window.showNotification("T·∫°o l·ªõp th√†nh c√¥ng!", "success");
                    loadClasses(); 
                } catch(e) { window.showNotification("L·ªói t·∫°o l·ªõp: " + e.message, "error"); }
            }
        }

        async function loadClasses() {
            const list = document.getElementById('classList'); 
            if(!list) return;

            // HI·ªÜN SKELETON (Giao di·ªán gi·∫£ l·∫≠p)
            list.innerHTML = `
                <div class="bg-white p-5 rounded-xl border border-gray-200 h-[140px] animate-pulse"><div class="w-10 h-10 bg-gray-200 rounded-lg mb-4"></div><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>
                <div class="bg-white p-5 rounded-xl border border-gray-200 h-[140px] animate-pulse"><div class="w-10 h-10 bg-gray-200 rounded-lg mb-4"></div><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>
                <div class="bg-white p-5 rounded-xl border border-gray-200 h-[140px] animate-pulse"><div class="w-10 h-10 bg-gray-200 rounded-lg mb-4"></div><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>
            `;

            try {
                const q = query(collection(db, "classes"), where("teacherId", "==", currentUserUid), limit(100));
                const snap = await getDocs(q);
                
                list.innerHTML = ''; // X√≥a skeleton
                
                snap.forEach(d => {
                    const cl = d.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer relative group";
                    const words = cl.name.trim().split(/\s+/);
                    let acronym = words.length >= 2 ? (words[0][0] + words[1][0]).toUpperCase() : words[0].substring(0, 2).toUpperCase();
                    
                    card.innerHTML = `
                        <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity z-10 flex gap-1">
                            <button onclick="event.stopPropagation(); window.openTeacherClassDetail('${d.id}', '${cl.name}')" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteClass('${d.id}')" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">${acronym}</div>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg mb-1 truncate">${cl.name}</h3>
                        <p class="text-sm text-gray-500">${cl.studentCount || 0} h·ªçc sinh</p>
                    `;
                    card.onclick = () => window.openTeacherClassDetail(d.id, cl.name);
                    list.appendChild(card);
                });
                
                const addCard = document.createElement('button');
                addCard.className = "border-2 border-dashed border-gray-300 rounded-xl p-5 flex flex-col items-center justify-center text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors h-full min-h-[140px]";
                addCard.innerHTML = `<i class="fa-solid fa-plus text-3xl mb-2"></i><span class="font-bold">T·∫°o l·ªõp m·ªõi</span>`;
                addCard.onclick = window.handleCreateClass;
                list.appendChild(addCard);
            } catch (e) { console.error(e); }
        }
        
        window.deleteClass = async (id) => {
            if(await window.customConfirm("Th·∫ßy c√≥ ch·∫Øc mu·ªën x√≥a l·ªõp n√†y kh√¥ng? D·ªØ li·ªáu b√†i t·∫≠p c·ªßa l·ªõp v·∫´n s·∫Ω c√≤n nh∆∞ng m·∫•t li√™n k·∫øt.")) {
                try {
                    await deleteDoc(doc(db, "classes", id));
                    window.showNotification("ƒê√£ x√≥a l·ªõp h·ªçc", "success");
                    loadClasses(); 
                } catch(e) { window.showNotification("L·ªói: " + e.message, "error"); }
            }
        }

        window.openTeacherClassDetail = async (id, name) => {
            window.switchView('teacher-class-detail');
            currentViewingClassId = id;
            const titleEl = document.getElementById('teacherClassTitle');
            if(titleEl) titleEl.textContent = name;
            const snap = await getDoc(doc(db, "classes", id));
            if(snap.exists()) {
                currentClassStudents = snap.data().students || [];
                renderStudentList(currentClassStudents);
            }
            window.switchTab('students');
        }

        window.editClassName = async () => {
            if (!currentViewingClassId) return;
            const titleEl = document.getElementById('teacherClassTitle');
            if (!titleEl) return;
            const currentName = titleEl.textContent;
            const newName = await window.customPrompt("Nh·∫≠p t√™n m·ªõi cho l·ªõp:", "", currentName);
            if (newName && newName.trim() !== "" && newName !== currentName) {
                try {
                    await updateDoc(doc(db, "classes", currentViewingClassId), { name: newName });
                    titleEl.textContent = newName;
                    window.showNotification("ƒê·ªïi t√™n l·ªõp th√†nh c√¥ng!");
                } catch(e) { window.showNotification("L·ªói: " + e.message, "error"); }
            }
        }

        // --- NEW FEATURE 2: ADD EXISTING STUDENT ---
        window.addExistingStudent = async () => {
            if (!currentViewingClassId) return;
            const username = await window.customPrompt("Nh·∫≠p T√™n ƒëƒÉng nh·∫≠p c·ªßa h·ªçc sinh:", "VD: quang123");
            if (!username) return;

            const targetEmail = `${username.trim()}@hocsinh.com`;
            
            try {
                const q = query(collection(db, "users"), where("email", "==", targetEmail));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    window.showNotification("Kh√¥ng t√¨m th·∫•y h·ªçc sinh c√≥ t√™n ƒëƒÉng nh·∫≠p n√†y!", "error");
                    return;
                }

                let foundUser = null;
                querySnapshot.forEach((doc) => { foundUser = { uid: doc.id, ...doc.data() }; });

                const isExist = currentClassStudents.some(s => s.email === targetEmail);
                if (isExist) {
                    window.showNotification("H·ªçc sinh n√†y ƒë√£ c√≥ trong l·ªõp!", "error");
                    return;
                }

                const newStudentObj = {
                    name: foundUser.displayName || "Kh√¥ng t√™n",
                    username: username,
                    email: targetEmail,
                    password: foundUser.password || "ƒê√£ ·∫©n", 
                    gender: foundUser.gender || "Nam",
                    phoneStudent: foundUser.phone || "",
                    createdAt: new Date().toISOString(),
                    uid: foundUser.uid 
                };

                await updateDoc(doc(db, "classes", currentViewingClassId), {
                    students: arrayUnion(newStudentObj),
                    studentCount: currentClassStudents.length + 1
                });

                currentClassStudents.push(newStudentObj);
                renderStudentList(currentClassStudents);
                window.showNotification(`ƒê√£ th√™m h·ªçc sinh: ${foundUser.displayName}`, "success");

            } catch (e) {
                console.error(e);
                window.showNotification("L·ªói t√¨m ki·∫øm: " + e.message, "error");
            }
        };

        // --- H√ÄM CHUY·ªÇN TAB ---
        window.switchTab = async function(tabName) {
            const btnStudents = document.getElementById('tabBtnStudents');
            const btnExams = document.getElementById('tabBtnExams');
            const contentStudents = document.getElementById('tabContentStudents');
            const contentExams = document.getElementById('tabContentExams');

            if (tabName === 'students') {
                btnStudents.className = "tab-btn active px-4 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600";
                btnExams.className = "tab-btn px-4 py-3 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent";
                contentStudents.classList.remove('hidden');
                contentExams.classList.add('hidden');
            } else {
                btnExams.className = "tab-btn active px-4 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600";
                btnStudents.className = "tab-btn px-4 py-3 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent";
                contentStudents.classList.add('hidden');
                contentExams.classList.remove('hidden');
                
                await loadClassExams(currentViewingClassId);
            }
        };
        
        function renderStudentList(list) { const table = document.getElementById('studentListTable'); if(!table) return; table.innerHTML = ''; document.getElementById('studentCountBadge').textContent = `${list.length} h·ªçc sinh`; if (list.length === 0) document.getElementById('emptyStudentMsg').classList.remove('hidden'); else { document.getElementById('emptyStudentMsg').classList.add('hidden'); list.forEach((st, index) => { table.innerHTML += `<tr class="bg-white hover:bg-gray-50 border-b"><td class="px-6 py-3 font-medium text-gray-500">${index + 1}</td><td class="px-6 py-3 font-medium text-gray-900">${st.name}</td><td class="px-6 py-3 text-blue-600 font-medium">${st.username}</td><td class="px-6 py-3 font-mono text-gray-400">******</td><td class="px-6 py-3 text-center"><button onclick="window.openEditStudent(${index})" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors mr-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="window.deleteStudent(${index})" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); } }
        window.openEditStudent = function(index) { editingStudentIndex = index; const st = currentClassStudents[index]; document.getElementById('editStuName').value = st.name || ''; document.getElementById('editStuSBD').value = st.sbd || ''; document.getElementById('editStuGender').value = st.gender || 'Nam'; document.getElementById('editStuPhone').value = st.phoneStudent || ''; document.getElementById('editStuParentPhone').value = st.phoneParent || ''; document.getElementById('editStuEmail').value = st.email || ''; document.getElementById('editStuUsername').value = st.username || ''; document.getElementById('editStuPassword').value = st.password || ''; document.getElementById('editStuPassword').type = "password"; window.toggleModal('editStudentModal', true); }
        
        window.deleteStudent = async function(index) {
            if(!await window.customConfirm("C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n ƒëƒÉng nh·∫≠p c·ªßa h·ªçc sinh v√† lo·∫°i kh·ªèi l·ªõp h·ªçc. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) return;
            
            const student = currentClassStudents[index];
            const btnDelete = document.querySelectorAll('#studentListTable button')[index * 2 + 1]; // N√∫t x√≥a t∆∞∆°ng ·ª©ng
            if(btnDelete) btnDelete.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; // Hi·ªáu ·ª©ng loading

            window.showNotification("ƒêang x·ª≠ l√Ω...", "info");

            try {
                // B∆Ø·ªöC 1: X√≥a kh·ªèi danh s√°ch l·ªõp trong Firestore TR∆Ø·ªöC (∆Øu ti√™n giao di·ªán)
                const updatedStudents = currentClassStudents.filter((_, i) => i !== index);
                
                await updateDoc(doc(db, "classes", currentViewingClassId), { 
                    students: updatedStudents, 
                    studentCount: updatedStudents.length 
                });

                // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
                currentClassStudents = updatedStudents;
                renderStudentList(currentClassStudents);

                // B∆Ø·ªöC 2: G·ªçi Cloud Function x√≥a Auth (Ch·∫°y ng·∫ßm, l·ªói th√¨ b·ªè qua)
                let targetUid = student.uid;
                
                // N·∫øu kh√¥ng c√≥ UID, th·ª≠ t√¨m b·∫±ng email (d·ª± ph√≤ng)
                if (!targetUid && student.email) {
                    try {
                        const qUser = query(collection(db, "users"), where("email", "==", student.email));
                        const snapUser = await getDocs(qUser);
                        if (!snapUser.empty) targetUid = snapUser.docs[0].id;
                    } catch(e) { console.log("Kh√¥ng t√¨m th·∫•y user firestore:", e); }
                }

                if (targetUid) {
                    // G·ªçi h√†m x√≥a Auth
                    const deleteFunc = httpsCallable(functions, 'deleteStudentAccount');
                    deleteFunc({ studentUid: targetUid }).then(() => {
                        console.log("ƒê√£ x√≥a Auth th√†nh c√¥ng.");
                    }).catch((err) => {
                        console.warn("L·ªói x√≥a Auth (c√≥ th·ªÉ user ƒë√£ b·ªã x√≥a t·ª´ tr∆∞·ªõc):", err.message);
                        // Kh√¥ng c·∫ßn b√°o l·ªói ra giao di·ªán v√¨ ng∆∞·ªùi d√πng ƒë√£ b·ªã lo·∫°i kh·ªèi l·ªõp r·ªìi
                    });
                }

                window.showNotification("ƒê√£ x√≥a h·ªçc sinh kh·ªèi l·ªõp th√†nh c√¥ng!", "success");

            } catch(e) { 
                console.error(e); 
                window.showNotification("L·ªói c·∫≠p nh·∫≠t danh s√°ch: " + e.message, "error");
                // Render l·∫°i n·∫øu l·ªói ƒë·ªÉ tr·∫£ v·ªÅ tr·∫°ng th√°i c≈©
                renderStudentList(currentClassStudents);
            }
        }

        document.getElementById('saveStudentBtn').addEventListener('click', async () => {
            if (editingStudentIndex === -1 || !currentViewingClassId) return;
            const btn = document.getElementById('saveStudentBtn');
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            btn.disabled = true;
            const name = document.getElementById('editStuName').value;
            const newPassword = document.getElementById('editStuPassword').value;
            const username = document.getElementById('editStuUsername').value;
            const studentEmail = document.getElementById('editStuEmail').value;
            let studentData = currentClassStudents[editingStudentIndex];
            try {
                let targetUid = studentData.uid;
                if (!targetUid) {
                    const qUser = query(collection(db, "users"), where("email", "==", studentEmail));
                    const snapUser = await getDocs(qUser);
                    if (!snapUser.empty) { targetUid = snapUser.docs[0].id; }
                }
                if (newPassword && newPassword.trim() !== "") {
                    if (!targetUid) throw new Error("Kh√¥ng t√¨m th·∫•y UID c·ªßa h·ªçc sinh n√†y trong h·ªá th·ªëng. Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u.");
                    const resetFunc = httpsCallable(functions, 'resetStudentPassword');
                    await resetFunc({ studentUid: targetUid, newPassword: newPassword });
                    window.showNotification("ƒê√£ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
                }
                const updatedStudent = {
                    ...studentData,
                    uid: targetUid || studentData.uid,
                    name: name,
                    sbd: document.getElementById('editStuSBD').value,
                    gender: document.getElementById('editStuGender').value,
                    phoneStudent: document.getElementById('editStuPhone').value,
                    phoneParent: document.getElementById('editStuParentPhone').value,
                    email: studentEmail,
                    username: username,
                    password: newPassword || studentData.password 
                };
                currentClassStudents[editingStudentIndex] = updatedStudent;
                await updateDoc(doc(db, "classes", currentViewingClassId), { students: currentClassStudents });
                window.showNotification("L∆∞u th√¥ng tin h·ªì s∆° th√†nh c√¥ng!", "success");
                renderStudentList(currentClassStudents);
                window.toggleModal('editStudentModal', false);
            } catch (e) { console.error(e); window.showNotification("L·ªói: " + e.message, "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        document.getElementById('addStudentBtn').addEventListener('click', async () => {
            if (!currentViewingClassId) return;
            const btn = document.getElementById('addStudentBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            btn.disabled = true;
            const name = document.getElementById('newStudentName').value;
            const user = document.getElementById('newStudentUser').value;
            const pass = document.getElementById('newStudentPass').value;
            if (!name || !user || !pass) {
                window.showNotification("Nh·∫≠p ƒë·ªß th√¥ng tin!", "error");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            const fakeEmail = `${user}@hocsinh.com`;
            try {
                const newUser = await createStudentAuth(fakeEmail, pass, name);
                const newStudent = {
                    uid: newUser.uid,
                    name: name,
                    username: user,
                    password: pass,
                    email: fakeEmail,
                    createdAt: new Date().toISOString()
                };
                await updateDoc(doc(db, "classes", currentViewingClassId), { students: arrayUnion(newStudent) });
                currentClassStudents.push(newStudent);
                renderStudentList(currentClassStudents);
                await updateDoc(doc(db, "classes", currentViewingClassId), { studentCount: currentClassStudents.length });
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentUser').value = '';
                document.getElementById('newStudentPass').value = '';
                window.showNotification("Th√™m th√†nh c√¥ng v√† ƒë√£ t·∫°o t√†i kho·∫£n!", "success");
            } catch (e) {
                console.error(e);
                if(e.code === 'auth/email-already-in-use') window.showNotification("T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!", "error");
                else window.showNotification("L·ªói: " + e.message, "error");
            } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        async function createStudentAuth(email, password, displayName) {
            const secondaryApp = initializeApp(firebaseConfig, "Secondary");
            const secondaryAuth = getAuth(secondaryApp);
            try {
                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                const newUser = userCredential.user;
                await updateProfile(newUser, { displayName: displayName });
                await setDoc(doc(db, "users", newUser.uid), {
                    email: email, displayName: displayName, role: 'student', birthDate: '', authType: 'email', createdAt: new Date().toISOString(), password: password 
                });
                await signOut(secondaryAuth);
                await deleteApp(secondaryApp); 
                return newUser;
            } catch (error) { await deleteApp(secondaryApp); throw error; }
        }

        window.downloadTemplate = () => { const data = [["H·ªç v√† t√™n", "T√™n ƒëƒÉng nh·∫≠p", "M·∫≠t kh·∫©u", "SBD", "Gi·ªõi t√≠nh", "SƒêT HS", "SƒêT PHHS"], ["Nguy·ªÖn VƒÉn A", "nguyenvana", "123456", "001", "Nam", "098...", "091..."]]; const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "DanhSach"); XLSX.writeFile(wb, "Mau_DS_Hoc_Sinh.xlsx"); }
        window.handleFileUpload = (input) => { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async function(e) { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); let addedCount = 0; for(let i = 1; i < jsonData.length; i++) { const row = jsonData[i]; if(row[0] && row[1]) { try { const name = row[0]; const user = row[1]; const pass = String(row[2] || '123456'); const fakeEmail = `${user}@hocsinh.com`; try { await createStudentAuth(fakeEmail, pass, name); } catch(e) { console.log("User exists or error", e); } const newStudent = { name, username: user, password: pass, email: fakeEmail, sbd: row[3]||'', gender: row[4]||'Nam', phoneStudent: row[5]||'', phoneParent: row[6]||'', createdAt: new Date().toISOString() }; await updateDoc(doc(db, "classes", currentViewingClassId), { students: arrayUnion(newStudent) }); currentClassStudents.push(newStudent); addedCount++; } catch(e) { console.error(e); } } } if(addedCount > 0) { renderStudentList(currentClassStudents); await updateDoc(doc(db, "classes", currentViewingClassId), { studentCount: currentClassStudents.length }); window.showNotification(`ƒê√£ th√™m ${addedCount} h·ªçc sinh!`, "success"); } input.value = ""; }; reader.readAsArrayBuffer(file); }

        async function loadClassExams(classId) {
            const container = document.getElementById('tabContentExams');
            if (!container) return;
            container.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-spinner fa-spin text-2xl text-blue-500"></i><p class="text-gray-400 mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>';
            try {
                const q = query(collection(db, "exams"), where("accessType", "==", "class"), where("allowedClassId", "==", classId));
                const snap = await getDocs(q);
                if (snap.empty) {
                    container.innerHTML = `<div class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center bg-gray-50"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 text-2xl"><i class="fa-regular fa-folder-open"></i></div><h3 class="text-gray-500 font-bold">Ch∆∞a c√≥ ƒë·ªÅ thi n√†o</h3><p class="text-sm text-gray-400 mt-1">Th·∫ßy h√£y v√†o "Ng√¢n h√†ng ƒë·ªÅ thi" ƒë·ªÉ t·∫°o v√† giao ƒë·ªÅ nh√©.</p></div>`;
                    return;
                }
                let html = '<div class="grid grid-cols-1 gap-4">';
                snap.forEach(doc => {
                    const exam = doc.data();
                    const examId = doc.id;
                    const statusBadge = exam.status === 'published' ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">ƒêang m·ªü</span>' : '<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">B·∫£n nh√°p</span>';
                    html += `<div class="bg-white p-5 rounded-xl border border-gray-200 hover:border-blue-300 transition-all flex justify-between items-center group cursor-pointer" onclick="window.location.href='exam-editor.html?id=${examId}'"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-file-pen"></i></div><div><h4 class="font-bold text-gray-800 text-lg group-hover:text-blue-600 transition-colors">${exam.title}</h4><div class="text-xs text-gray-500 flex gap-3 mt-1"><span><i class="fa-regular fa-clock"></i> ${exam.duration} ph√∫t</span><span><i class="fa-solid fa-list-ol"></i> ${exam.questionCount || 0} c√¢u</span><span><i class="fa-solid fa-calendar-days"></i> H·∫°n: ${exam.endTime ? new Date(exam.endTime).toLocaleDateString('vi-VN') : 'Kh√¥ng gi·ªõi h·∫°n'}</span></div></div></div><div class="text-right">${statusBadge}<div class="text-xs text-gray-400 mt-2"><i class="fa-solid fa-gear mr-1"></i> C√†i ƒë·∫∑t</div></div></div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (e) { console.error(e); container.innerHTML = `<div class="text-center text-red-500 py-4"><p>L·ªói t·∫£i d·ªØ li·ªáu!</p><p class="text-xs">${e.message}</p></div>`; }
        }

        // C√ÅC H√ÄM N√âN ·∫¢NH V√Ä UPLOAD (CHO BANNER)
        window.compressImage = async (file, quality = 0.8, maxWidth = 1500) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                        canvas.toBlob(resolve, 'image/jpeg', quality);
                    };
                };
            });
        };

        // --- KH√îI PH·ª§C LOGIC BANNER ---
        function renderHeroImageList() {
            const container = document.getElementById('heroImageList'); if(!container) return; container.innerHTML = '';
            if (window.currentHeroImages.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            window.currentHeroImages.forEach((url, index) => {
                container.innerHTML += `<div class="relative h-24 rounded-lg overflow-hidden border border-gray-300 group shadow-sm bg-white"><img src="${url}" class="w-full h-full object-contain p-1"><button onclick="removeHeroImage(${index})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs shadow-md opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-times"></i></button><span class="absolute bottom-1 left-1 bg-black/60 text-white text-[9px] px-1.5 py-0.5 rounded font-bold">${index + 1}</span></div>`;
            });
        }
        window.removeHeroImage = (index) => { window.currentHeroImages.splice(index, 1); renderHeroImageList(); };
        window.handleHeroImageUpload = async (input) => {
            const file = input.files[0]; if (!file) return;
            window.showNotification("ƒêang t·∫£i ·∫£nh...", "info");
            try {
                const compressedBlob = await window.compressImage(file, 0.9, 1500);
                const formData = new FormData(); formData.append('file', compressedBlob, `banner_${Date.now()}.jpg`);
                const res = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", { method: 'PUT', body: formData });
                const data = await res.json();
                window.currentHeroImages.push(data.url); renderHeroImageList();
                window.showNotification("ƒê√£ th√™m ·∫£nh!", "success");
            } catch (e) { window.showNotification("L·ªói: " + e.message, "error"); }
            input.value = '';
        };
        window.handleLogoUpload = async (input) => {
             const file = input.files[0]; if(!file) return;
             try {
                const compressedBlob = await window.compressImage(file, 0.9, 500);
                const formData = new FormData(); formData.append('file', compressedBlob, `logo_${Date.now()}.png`);
                const res = await fetch("https://upload-helper.phamngockhanh-942001.workers.dev/", { method: 'PUT', body: formData });
                const data = await res.json();
                window.currentLogoImg = data.url;
                if(document.getElementById('logoPreview')) document.getElementById('logoPreview').src = data.url;
             } catch(e) { console.error(e); }
        };
        window.openHeroModal = async () => {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
                    setVal('hStyle', d.style || "style1"); setVal('hTitle1', d.title1 || ""); setVal('hTitle2', d.title2 || ""); setVal('hTags', (d.tags||[]).join(', ')); setVal('hDesc', d.desc || ""); setVal('hBtnText', d.btnText || ""); setVal('hBtnLink', d.btnLink || "");
                    window.currentHeroImages = d.images || (d.image ? [d.image] : []);
                    renderHeroImageList();
                    window.currentLogoImg = d.logo || "";
                    if(window.currentLogoImg && document.getElementById('logoPreview')) document.getElementById('logoPreview').src = window.currentLogoImg;
                }
                window.toggleModal('heroModal', true);
            } catch(e) { console.error(e); }
        };
        window.saveHeroSettings = async () => {
            if (window.currentHeroImages.length === 0) return window.showNotification("Vui l√≤ng t·∫£i √≠t nh·∫•t 1 ·∫£nh banner!", "error");
            const data = {
                style: document.getElementById('hStyle').value,
                title1: document.getElementById('hTitle1').value,
                title2: document.getElementById('hTitle2').value,
                tags: document.getElementById('hTags').value.split(',').map(t=>t.trim()).filter(t=>t!==""),
                desc: document.getElementById('hDesc').value,
                btnText: document.getElementById('hBtnText').value,
                btnLink: document.getElementById('hBtnLink').value,
                images: window.currentHeroImages, image: window.currentHeroImages[0], logo: window.currentLogoImg,
                updatedAt: new Date().toISOString()
            };
            try { await setDoc(doc(db, "site_settings", "homepage_hero"), data); window.showNotification("ƒê√£ l∆∞u giao di·ªán m·ªõi!", "success"); window.toggleModal('heroModal', false); } catch(e) { window.showNotification("L·ªói l∆∞u: " + e.message, "error"); }
        };

        // --- KH√îI PH·ª§C LOGIC THANH TO√ÅN ---
        window.openPaymentConfigModal = async () => {
            window.toggleModal('paymentConfigModal', true);
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "payment_config"));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    if(document.getElementById('confBankId')) document.getElementById('confBankId').value = d.BANK_ID || "970422";
                    if(document.getElementById('confAccountNo')) document.getElementById('confAccountNo').value = d.ACCOUNT_NO || "";
                    if(document.getElementById('confAccountName')) document.getElementById('confAccountName').value = d.ACCOUNT_NAME || "";
                    if(document.getElementById('confTemplate')) document.getElementById('confTemplate').value = d.TEMPLATE || "compact2";
                }
            } catch(e) { console.warn("Ch∆∞a t·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh thanh to√°n c≈©:", e); }
        };
        window.savePaymentConfig = async () => {
            const bankSelect = document.getElementById('confBankId');
            const data = {
                BANK_ID: bankSelect.value, BANK_NAME: bankSelect.options[bankSelect.selectedIndex].text,
                ACCOUNT_NO: document.getElementById('confAccountNo').value.trim(),
                ACCOUNT_NAME: document.getElementById('confAccountName').value.trim().toUpperCase(),
                TEMPLATE: document.getElementById('confTemplate').value, updatedAt: new Date().toISOString()
            };
            if(!data.BANK_ID || !data.ACCOUNT_NO) return window.showNotification("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error");
            try { await setDoc(doc(db, "site_settings", "payment_config"), data); window.showNotification("ƒê√£ l∆∞u c·∫•u h√¨nh!", "success"); window.toggleModal('paymentConfigModal', false); } catch(e) { window.showNotification("L·ªói l∆∞u: " + e.message, "error"); }
        };
        
        // --- LOGIC FILE EXPLORER (ƒê√É T·ªêI ∆ØU SONG SONG) ---
        async function loadFileManager() { 
            try { 
                // T·∫°o 2 truy v·∫•n c√πng l√∫c
                const qFolders = query(collection(db, "folders"), where("teacherId", "==", currentUserUid), limit(100)); 
                const qExams = query(collection(db, "exams"), where("teacherId", "==", currentUserUid), limit(100)); 
                
                // B·∫Øn request song song v√† ƒë·ª£i c·∫£ 2 tr·∫£ v·ªÅ
                const [snapFolders, snapExams] = await Promise.all([
                    getDocs(qFolders),
                    getDocs(qExams)
                ]);
                
                // X·ª≠ l√Ω d·ªØ li·ªáu Folders
                folderData = []; 
                snapFolders.forEach(d => folderData.push({id: d.id, ...d.data()})); 
                
                // X·ª≠ l√Ω d·ªØ li·ªáu Exams
                examData = []; 
                snapExams.forEach(d => examData.push({id: d.id, ...d.data()})); 
                
                renderExplorer(); 
            } catch (e) { console.error(e); } 
        }
        function renderExplorer() { 
            const container = document.getElementById('explorerGrid'); 
            container.innerHTML = ''; 
            
            // L·ªçc d·ªØ li·ªáu th∆∞ m·ª•c v√† ƒë·ªÅ thi hi·ªán t·∫°i
            const currentFolders = folderData.filter(f => f.parentId === currentFolderId); 
            const currentExams = examData.filter(e => (e.folderId || null) === currentFolderId); 
            
            // X·ª≠ l√Ω th√¥ng b√°o tr·ªëng
            if (currentFolders.length === 0 && currentExams.length === 0) {
                document.getElementById('emptyExplorerMsg').classList.remove('hidden'); 
            } else {
                document.getElementById('emptyExplorerMsg').classList.add('hidden'); 
            }

            // --- THI·∫æT L·∫¨P CLASS CHO CONTAINER D·ª∞A V√ÄO CH·∫æ ƒê·ªò VIEW ---
            if (currentExplorerView === 'list') {
                container.className = "flex flex-col space-y-2"; // Class cho d·∫°ng List
            } else {
                container.className = "grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-4"; // Class cho d·∫°ng Grid
            }

            // H√ÄM RENDER ITEM (FOLDER)
            currentFolders.forEach(f => { 
                const div = document.createElement('div'); 
                div.draggable = true; 
                div.ondragstart = (evt) => window.handleDragStart(evt, f.id, 'folder'); 
                div.ondragover = (evt) => window.handleDragOver(evt); 
                div.ondragleave = (evt) => window.handleDragLeave(evt); 
                div.ondrop = (evt) => window.handleDrop(evt, f.id); 
                div.onclick = (e) => { if(!e.target.closest('button')) window.navigateFolder(f.id, f.name); }; 
                
                if (currentExplorerView === 'list') {
                    // Giao di·ªán LIST cho Folder
                    div.className = "explorer-item bg-white px-4 py-3 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-blue-50 group";
                    div.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="text-xl text-yellow-400"><i class="fa-solid fa-folder"></i></div>
                            <p class="text-sm font-bold text-gray-700 truncate pointer-events-none">${f.name}</p>
                        </div>
                        <button onclick="event.stopPropagation(); window.openContextMenu('${f.id}', 'folder', '${f.name}')" class="text-gray-400 hover:text-gray-600 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                    `;
                } else {
                    // Giao di·ªán GRID cho Folder (C≈©)
                    div.className = "explorer-item bg-white p-4 rounded-xl border border-gray-200 relative group flex flex-col items-center justify-center aspect-square md:aspect-auto";
                    div.innerHTML = `
                        <div class="text-4xl text-yellow-400 mb-2 pointer-events-none"><i class="fa-solid fa-folder"></i></div>
                        <p class="text-sm font-bold text-gray-700 text-center truncate w-full px-1 pointer-events-none">${f.name}</p>
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); window.openContextMenu('${f.id}', 'folder', '${f.name}')" class="p-1 hover:bg-gray-100 rounded text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        </div>
                    `;
                }
                container.appendChild(div); 
            }); 

            // H√ÄM RENDER ITEM (EXAM)
            currentExams.forEach(exam => { 
                const div = document.createElement('div'); 
                div.draggable = true; 
                div.ondragstart = (evt) => window.handleDragStart(evt, exam.id, 'exam'); 
                div.onclick = (e) => { if(!e.target.closest('button')) window.location.href = `exam-editor.html?id=${exam.id}`; }; 
                
                if (currentExplorerView === 'list') {
                    // Giao di·ªán LIST cho Exam
                    div.className = "explorer-item bg-white px-4 py-3 rounded-xl border border-gray-200 flex items-center justify-between hover:bg-blue-50 group";
                    div.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="text-xl text-blue-500"><i class="fa-regular fa-file-lines"></i></div>
                            <div class="flex flex-col overflow-hidden">
                                <p class="text-sm font-bold text-gray-700 truncate pointer-events-none">${exam.title}</p>
                                <p class="text-[10px] text-gray-400 hidden md:block">Ng√†y t·∫°o: ${new Date(exam.createdAt).toLocaleDateString('vi-VN')}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded hidden md:inline-block">${exam.duration} ph√∫t</span>
                            <button onclick="event.stopPropagation(); window.openContextMenu('${exam.id}', 'exam', '${exam.title}')" class="text-gray-400 hover:text-gray-600 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        </div>
                    `;
                } else {
                    // Giao di·ªán GRID cho Exam (C≈©)
                    div.className = "explorer-item bg-white p-4 rounded-xl border border-gray-200 relative group flex flex-col items-center justify-center aspect-square md:aspect-auto";
                    div.innerHTML = `
                        <div class="text-4xl text-blue-500 mb-2 pointer-events-none"><i class="fa-regular fa-file-lines"></i></div>
                        <p class="text-sm font-bold text-gray-700 text-center truncate w-full px-1 pointer-events-none" title="${exam.title}">${exam.title}</p>
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); window.openContextMenu('${exam.id}', 'exam', '${exam.title}')" class="p-1 hover:bg-gray-100 rounded text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        </div>
                    `;
                }
                container.appendChild(div); 
            }); 
            
            renderBreadcrumb(); 
        }
        window.handleDragStart = (e, id, type) => { e.dataTransfer.setData("text/plain", JSON.stringify({id, type})); e.target.classList.add('dragging'); e.stopPropagation(); }
        window.handleDragOver = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        window.handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); }
        window.handleDrop = async (e, targetId) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('drag-over'); try { const data = JSON.parse(e.dataTransfer.getData("text/plain")); if (data.id === targetId) return; const collName = data.type === 'folder' ? 'folders' : 'exams'; const field = data.type === 'folder' ? 'parentId' : 'folderId'; await updateDoc(doc(db, collName, data.id), { [field]: targetId }); window.showNotification("ƒê√£ di chuy·ªÉn th√†nh c√¥ng!"); loadFileManager(); } catch (err) { console.error("Drop error", err); } document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging')); }
        window.navigateFolder = (id, name) => { if(id === 'root') { currentFolderId = null; breadcrumbs = []; } else { currentFolderId = id; breadcrumbs.push({id, name}); } renderExplorer(); }
        window.createNewFolder = async () => { const n = await window.customPrompt("T√™n th∆∞ m·ª•c:"); if(n) { await addDoc(collection(db, "folders"), { name: n, parentId: currentFolderId, teacherId: currentUserUid, createdAt: new Date().toISOString() }); loadFileManager(); } }
        let breadcrumbs = [];
        function renderBreadcrumb() { const container = document.getElementById('breadcrumbContainer'); if (!currentFolderId) { container.innerHTML = '<span class="mx-2 text-gray-400">/</span><span>T·∫•t c·∫£</span>'; return; } let path = []; let curr = folderData.find(f => f.id === currentFolderId); while(curr) { path.unshift(curr); curr = folderData.find(f => f.id === curr.parentId); } let html = '<span class="mx-2 text-gray-400">/</span><button onclick="window.navigateFolder(\'root\')" class="hover:text-blue-600">...</button><span class="mx-2">/</span>Current'; path.forEach((p, idx) => { html += `<span class="mx-2 text-gray-400">/</span>`; if (idx === path.length - 1) html += `<span class="font-bold text-gray-800">${p.name}</span>`; else html += `<button onclick="window.navigateFolder(\'${p.id}\')" class="hover:text-blue-600">${p.name}</button>`; }); container.innerHTML = html; }
        window.openContextMenu = (id, type, name) => { currentActionItem = {id, type, name}; document.getElementById('actionModalTitle').textContent = `Thao t√°c: ${name}`; const content = document.getElementById('dynamicContent'); content.innerHTML = `<div class="grid grid-cols-3 gap-3 mb-4"><button onclick="window.triggerAction('rename')" class="p-3 bg-blue-50 text-blue-600 rounded-lg font-bold hover:bg-blue-100 flex flex-col items-center"><i class="fa-solid fa-pen mb-1"></i> ƒê·ªïi t√™n</button><button onclick="window.triggerAction('move')" class="p-3 bg-purple-50 text-purple-600 rounded-lg font-bold hover:bg-purple-100 flex flex-col items-center"><i class="fa-solid fa-arrow-right-to-bracket mb-1"></i> Di chuy·ªÉn</button><button onclick="window.triggerAction('delete')" class="p-3 bg-red-50 text-red-600 rounded-lg font-bold hover:bg-red-100 flex flex-col items-center"><i class="fa-solid fa-trash mb-1"></i> X√≥a</button></div><div id="subActionContent"></div>`; window.toggleModal('actionModal', true); }
        async function deleteR2Image(fileKeyOrUrl) { if (!fileKeyOrUrl) return; try { let keyName = fileKeyOrUrl; if (fileKeyOrUrl.startsWith('http')) { try { const urlObj = new URL(fileKeyOrUrl); keyName = urlObj.pathname.substring(1); keyName = decodeURIComponent(keyName); } catch(e) { console.warn("Kh√¥ng parse ƒë∆∞·ª£c URL:", fileKeyOrUrl); } } return fetch(`https://upload-helper.phamngockhanh-942001.workers.dev/?key=${encodeURIComponent(keyName)}`, { method: 'DELETE', keepalive: true }); } catch (e) { console.error("L·ªói x√≥a R2:", e); } }
        window.triggerAction = async (action) => { const container = document.getElementById('subActionContent'); container.innerHTML = ''; if (action === 'rename') { container.innerHTML = `<label class="block text-sm font-bold text-gray-700 mb-2">T√™n m·ªõi</label><div class="flex gap-2"><input type="text" id="renameInput" value="${currentActionItem.name}" class="flex-1 border rounded px-3 py-2"><button onclick="window.commitRename()" class="bg-blue-600 text-white px-4 rounded font-bold">L∆∞u</button></div>`; } else if (action === 'delete') {
            window.toggleModal('actionModal', false);
            if(await window.customConfirm(`C·∫¢NH B√ÅO: X√≥a "${currentActionItem.name}" s·∫Ω x√≥a vƒ©nh vi·ªÖn v√† KH√îNG TH·ªÇ KH√îI PH·ª§C.\nN·∫øu ƒë√¢y l√† ƒë·ªÅ thi, c√°c b√†i ƒë√£ giao cho h·ªçc sinh c≈©ng s·∫Ω b·ªã x√≥a theo.\nB·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?`)) {
                window.showNotification("ƒêang ti·∫øn h√†nh x√≥a d·ªØ li·ªáu...", "info");
                try {
                    const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams';
                    
                    // 1. N·∫æU L√Ä ƒê·ªÄ THI: D·ªçn d·∫πp ·∫£nh v√† c√°c b·∫£n sao
                    if (currentActionItem.type === 'exam') {
                        // A. D·ªçn d·∫πp ·∫£nh tr√™n Cloud (R2)
                        const docSnap = await getDoc(doc(db, "exams", currentActionItem.id));
                        if (docSnap.exists()) {
                            const examData = docSnap.data();
                            const strData = JSON.stringify(examData);
                            const regex = /(https:\/\/[^"'\s\\]+\.r2\.dev\/[^"'\s\\]+|https:\/\/firebasestorage\.googleapis\.com\/v0\/b\/[^"'\s\\]+)/g;
                            const images = strData.match(regex) || [];
                            if (images.length > 0) {
                                // Ch·∫°y x√≥a ·∫£nh ng·∫ßm, kh√¥ng c·∫ßn await ƒë·ªÉ giao di·ªán m∆∞·ª£t h∆°n
                                Promise.all(images.map(url => deleteR2Image(url))).catch(err => console.log("L·ªói x√≥a ·∫£nh r√°c:", err));
                            }
                        }

                        // B. [QUAN TR·ªåNG] T√¨m v√† x√≥a c√°c B·∫¢N SAO ƒë√£ giao cho l·ªõp (Fix l·ªói hi·ªÉn th·ªã b√™n h·ªçc sinh)
                        // T√¨m c√°c ƒë·ªÅ c√≥ originalId tr√πng v·ªõi ID ƒë·ªÅ ƒëang x√≥a
                        const qCopies = query(collection(db, "exams"), where("originalId", "==", currentActionItem.id));
                        const snapCopies = await getDocs(qCopies);
                        
                        const deletePromises = [];
                        snapCopies.forEach((docCopy) => {
                            console.log("ƒêang x√≥a b·∫£n sao:", docCopy.id);
                            deletePromises.push(deleteDoc(docCopy.ref));
                        });
                        
                        // ƒê·ª£i x√≥a h·∫øt b·∫£n sao
                        if(deletePromises.length > 0) await Promise.all(deletePromises);
                    }

                    // 2. X√≥a th∆∞ m·ª•c/ƒë·ªÅ thi g·ªëc
                    await deleteDoc(doc(db, collName, currentActionItem.id));
                    
                    window.showNotification("ƒê√£ x√≥a ho√†n to√†n ƒë·ªÅ thi v√† c√°c d·ªØ li·ªáu li√™n quan!", "success");
                    loadFileManager();
                    
                } catch(e) {
                    console.error(e);
                    window.showNotification("L·ªói x√≥a: " + e.message, 'error');
                }
            }
        } else if (action === 'move') { let html = '<p class="text-sm font-bold text-gray-700 mb-2">Ch·ªçn th∆∞ m·ª•c ƒë·∫øn:</p><div class="h-40 overflow-y-auto border rounded p-1 space-y-1">'; html += `<button onclick="window.commitMove(null)" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2"><i class="fa-solid fa-house text-gray-400"></i> Th∆∞ m·ª•c g·ªëc</button>`; folderData.forEach(f => { if (f.id !== currentActionItem.id) html += `<button onclick="window.commitMove('${f.id}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2"><i class="fa-solid fa-folder text-yellow-400"></i> ${f.name}</button>`; }); html += '</div>'; container.innerHTML = html; } }
        window.commitRename = async () => { const newName = document.getElementById('renameInput').value; if(!newName) return; const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams'; await updateDoc(doc(db, collName, currentActionItem.id), { name: newName, title: newName }); window.showNotification("ƒê√£ ƒë·ªïi t√™n"); window.toggleModal('actionModal', false); loadFileManager(); }
        window.commitMove = async (targetFolderId) => { const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams'; const field = currentActionItem.type === 'folder' ? 'parentId' : 'folderId'; await updateDoc(doc(db, collName, currentActionItem.id), { [field]: targetFolderId }); window.toggleModal('actionModal', false); window.showNotification("ƒê√£ di chuy·ªÉn"); loadFileManager(); }
        // --- T√çNH NƒÇNG: D·ªåN D·∫∏P D·ªÆ LI·ªÜU R√ÅC (FIX L·ªñI ƒê·ªÄ C≈®) ---
        // --- T√çNH NƒÇNG CAO C·∫§P: D·ªåN D·∫∏P H·ªÜ TH·ªêNG TO√ÄN DI·ªÜN (DEEP CLEAN) ---
        // --- T√çNH NƒÇNG: D·ªåN D·∫∏P H·ªÜ TH·ªêNG V3 (H·ª¶Y DI·ªÜT R√ÅC C·ª®NG ƒê·∫¶U) ---
        window.cleanUpSystem = async () => {
            if(!await window.customConfirm("CH·∫æ ƒê·ªò QU√âT S√ÇU V3 (H·ª¶Y DI·ªÜT):\n\nS·∫Ω qu√©t v√† x√≥a:\n1. ƒê·ªÅ thi b·∫£n sao m·∫•t g·ªëc (cha ƒë√£ x√≥a).\n2. ƒê·ªÅ thi trong l·ªõp nh∆∞ng KH√îNG C√ì li√™n k·∫øt ng√¢n h√†ng (Tr∆∞·ªùng h·ª£p 'To√°n 3').\n3. Th∆∞ m·ª•c r√°c & ·∫¢nh r√°c.\n\nTh·∫ßy c√≥ ch·∫Øc ch·∫Øn mu·ªën d·ªçn s·∫°ch kh√¥ng?")) return;
            
            window.showNotification("ƒêang r√† so√°t to√†n b·ªô c∆° s·ªü d·ªØ li·ªáu...", "info");
            
            try {
                // 1. T·∫¢I TO√ÄN B·ªò D·ªÆ LI·ªÜU
                const [snapExams, snapFolders] = await Promise.all([
                    getDocs(collection(db, "exams")),
                    getDocs(collection(db, "folders"))
                ]);

                const allExams = [];
                const validOriginalIds = new Set();
                
                // L·∫•y danh s√°ch t·∫•t c·∫£ ƒë·ªÅ thi v√† x√°c ƒë·ªãnh ƒë√¢u l√† ƒë·ªÅ G·ªêC h·ª£p l·ªá
                snapExams.forEach(doc => {
                    const d = doc.data();
                    allExams.push({ id: doc.id, ...d, ref: doc.ref });
                    // ƒê·ªÅ g·ªëc l√† ƒë·ªÅ kh√¥ng c√≥ classId (n·∫±m trong ng√¢n h√†ng)
                    if (!d.classId) {
                        validOriginalIds.add(doc.id);
                    }
                });

                // 2. NH·∫¨N DI·ªÜN "R√ÅC" (Bao g·ªìm c·∫£ tr∆∞·ªùng h·ª£p To√°n 3)
                const trashExams = allExams.filter(e => {
                    // Ch·ªâ x√©t c√°c ƒë·ªÅ ƒëang n·∫±m trong l·ªõp h·ªçc (l√† b·∫£n sao)
                    if (e.classId) {
                        // TR∆Ø·ªúNG H·ª¢P 1: C√≥ link g·ªëc, nh∆∞ng g·ªëc kh√¥ng t·ªìn t·∫°i (Zombie)
                        if (e.originalId && !validOriginalIds.has(e.originalId)) return true;
                        
                        // TR∆Ø·ªúNG H·ª¢P 2 (QUAN TR·ªåNG): L√† ƒë·ªÅ trong l·ªõp nh∆∞ng KH√îNG C√ì link g·ªëc (M·ªì c√¥i/R√°c)
                        // ƒê√¢y ch√≠nh l√† nguy√™n nh√¢n "To√°n 3" v·∫´n c√≤n s·ªëng
                        if (!e.originalId) return true;
                    }
                    return false;
                });

                // 3. NH·∫¨N DI·ªÜN TH∆Ø M·ª§C R√ÅC
                const allFolders = [];
                const folderIds = new Set();
                snapFolders.forEach(doc => {
                    folderIds.add(doc.id);
                    allFolders.push({ id: doc.id, ...doc.data(), ref: doc.ref });
                });
                const orphanFolders = allFolders.filter(f => f.parentId && !folderIds.has(f.parentId));

                // 4. B√ÅO C√ÅO V√Ä X√ÅC NH·∫¨N
                const totalTrash = trashExams.length + orphanFolders.length;
                console.log("Danh s√°ch r√°c t√¨m th·∫•y:", trashExams.map(e => e.title)); // Log ra console ƒë·ªÉ ki·ªÉm tra

                if (totalTrash === 0) {
                    window.showNotification("H·ªá th·ªëng s·∫°ch b√≥ng! Kh√¥ng t√¨m th·∫•y r√°c.", "success");
                    return;
                }

                if(!await window.customConfirm(`T√åM TH·∫§Y R√ÅC:\n- ${trashExams.length} ƒë·ªÅ thi l·ªói (C√≥ th·ªÉ bao g·ªìm 'To√°n 3').\n- ${orphanFolders.length} th∆∞ m·ª•c r√°c.\n\nTh·∫ßy c√≥ ƒë·ªìng √Ω X√ìA NGAY L·∫¨P T·ª®C kh√¥ng?`)) return;

                // 5. TI·∫æN H√ÄNH X√ìA
                window.showNotification(`ƒêang x√≥a ${totalTrash} m·ª•c r√°c...`, "warning");
                
                // A. X√≥a ·∫£nh r√°c (n·∫øu c√≥)
                const imageDeletionPromises = [];
                const regex = /(https:\/\/[^"'\s\\]+\.r2\.dev\/[^"'\s\\]+|https:\/\/firebasestorage\.googleapis\.com\/v0\/b\/[^"'\s\\]+)/g;
                trashExams.forEach(exam => {
                    const strData = JSON.stringify(exam);
                    const images = strData.match(regex) || [];
                    images.forEach(url => imageDeletionPromises.push(deleteR2Image(url)));
                });
                Promise.all(imageDeletionPromises).catch(e => console.log("L·ªói x√≥a ·∫£nh (kh√¥ng quan tr·ªçng):", e));

                // B. X√≥a d·ªØ li·ªáu
                const deletePromises = [
                    ...trashExams.map(z => deleteDoc(z.ref)),
                    ...orphanFolders.map(f => deleteDoc(f.ref))
                ];

                await Promise.all(deletePromises);
                
                window.showNotification(`ƒê√£ ti√™u di·ªát th√†nh c√¥ng ${trashExams.length} ƒë·ªÅ thi r√°c!`, "success");
                
                // T·∫£i l·∫°i trang ƒë·ªÉ th·∫•y k·∫øt qu·∫£
                setTimeout(() => window.location.reload(), 1500);

            } catch (e) {
                console.error("L·ªói d·ªçn d·∫πp:", e);
                window.showNotification("C√≥ l·ªói x·∫£y ra: " + e.message, "error");
            }
        };
        document.getElementById('logoutBtn').onclick = async () => { if(await window.customConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) signOut(auth).then(()=>window.location.href="index.html"); }
    </script>
</body>
</html>
