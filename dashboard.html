<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫£nh ch√≠nh - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #FFF8F0; }
        .text-orange-custom { color: #FF6A00; }
        .bg-orange-custom { background-color: #FF6A00; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='dashboard.html'">
                    <div class="w-10 h-10 bg-orange-custom rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <span class="text-2xl md:text-3xl text-orange-600 font-handwriting pt-1">To√°n th·∫ßy Choang Choang</span>
                </div>

                <!-- User Info & Logout -->
                <div class="flex items-center gap-4">
                    <!-- B·∫•m v√†o t√™n c≈©ng m·ªü modal -->
                    <div class="text-right hidden sm:block cursor-pointer hover:opacity-80 transition-opacity" id="userInfoText">
                        <p id="userNameDisplay" class="text-sm font-bold text-gray-700">ƒêang t·∫£i...</p>
                        <p id="userRoleDisplay" class="text-xs text-gray-500">...</p>
                    </div>
                    <!-- Avatar Button: Click ƒë·ªÉ m·ªü Profile -->
                    <div id="avatarBtn" class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border-2 border-orange-200 cursor-pointer hover:border-orange-500 transition-colors shadow-sm">
                        <img id="userAvatar" src="https://via.placeholder.com/150" alt="User" class="w-full h-full object-cover">
                    </div>
                    <button id="logoutBtn" class="bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 p-2 rounded-full transition-colors" title="ƒêƒÉng xu·∫•t">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-8 text-white mb-10 shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-3xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</h1>
                <p class="opacity-90">S·∫µn s√†ng chinh ph·ª•c ƒë·ªânh cao tri th·ª©c h√¥m nay ch∆∞a?</p>
            </div>
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10"></div>
            <div class="absolute bottom-0 right-20 w-32 h-32 rounded-full bg-white opacity-10"></div>
        </div>

        <!-- Danh s√°ch m√¥n thi -->
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-orange-500 pl-4">Ch·ªçn m√¥n thi</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- M√¥n To√°n -->
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-calculator"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">To√°n H·ªçc</h3>
                <p class="text-gray-500 text-sm mb-4">R√®n luy·ªán t∆∞ duy logic v·ªõi c√°c b√†i to√°n th√∫ v·ªã.</p>
                <!-- ƒê√É C·∫¨P NH·∫¨T LINK SANG TRANG THI -->
                <button onclick="window.location.href='exam.html'" class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
            <!-- M√¥n Ti·∫øng Vi·ªát -->
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-book-open"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Vi·ªát</h3>
                <p class="text-gray-500 text-sm mb-4">Kh√°m ph√° v·∫ª ƒë·∫πp ng√¥n ng·ªØ qua c√°c c√¢u ƒë·ªë.</p>
                <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-green-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
             <!-- M√¥n Ti·∫øng Anh -->
             <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-language"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Anh</h3>
                <p class="text-gray-500 text-sm mb-4">N√¢ng cao kh·∫£ nƒÉng ngo·∫°i ng·ªØ m·ªói ng√†y.</p>
                <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-purple-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
            </div>
        </div>
    </main>

    <!-- MODAL PROFILE (C·ª≠a s·ªï th√¥ng tin c√° nh√¢n) -->
    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300">
            <!-- Modal Header -->
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl">
                <p class="text-xl font-bold text-orange-800">Th√¥ng tin c√° nh√¢n</p>
                <div id="closeModalBtn" class="cursor-pointer z-50 p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors">
                    <i class="fa-solid fa-times"></i>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="py-6 px-6 space-y-4">
                <!-- Avatar Upload (Gi·∫£ l·∫≠p) -->
                <div class="flex justify-center mb-4">
                    <div class="relative group">
                        <img id="modalAvatar" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-4 border-orange-200 shadow-md">
                        <div class="absolute bottom-0 right-0 bg-orange-500 text-white p-1 rounded-full w-8 h-8 flex items-center justify-center cursor-pointer hover:bg-orange-600 shadow-sm transition-colors" title="ƒê·ªïi ·∫£nh">
                            <i class="fa-solid fa-camera text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Form Inputs -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">T√™n hi·ªÉn th·ªã</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-user text-gray-400"></i>
                        </div>
                        <input type="text" id="editDisplayName" class="w-full pl-10 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Ng√†y sinh</label>
                        <input type="date" id="editBirthDate" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Vai tr√≤</label>
                        <select id="editRole" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-orange-500 transition-colors bg-white">
                            <option value="student">H·ªçc sinh</option>
                            <option value="teacher">Gi√°o vi√™n</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>

                <!-- Th√¥ng b√°o tr·∫°ng th√°i -->
                <div id="saveStatus" class="text-center text-sm font-bold hidden p-2 rounded bg-gray-50"></div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl">
                <button id="cancelBtn" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-colors">H·ªßy b·ªè</button>
                <button id="saveProfileBtn" class="px-6 py-2 bg-orange-custom text-white rounded-lg hover:bg-orange-600 font-bold shadow-md transition-all active:scale-95">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- C·∫§U H√åNH (S·ª≠ d·ª•ng c·∫•u h√¨nh t·ª´ ·∫£nh b·∫°n cung c·∫•p) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logoutBtn');
        const avatarBtn = document.getElementById('avatarBtn');
        const userInfoText = document.getElementById('userInfoText');
        
        // Modal Elements
        const profileModal = document.getElementById('profileModal');
        const modalContainer = profileModal.querySelector('.modal-container');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const editDisplayName = document.getElementById('editDisplayName');
        const editBirthDate = document.getElementById('editBirthDate');
        const editRole = document.getElementById('editRole');
        const modalAvatar = document.getElementById('modalAvatar');
        const saveStatus = document.getElementById('saveStatus');

        let currentUserUid = null;

        // 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P & T·∫¢I D·ªÆ LI·ªÜU
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                
                // L·∫•y th√¥ng tin chi ti·∫øt t·ª´ Firestore
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    let role = 'student';
                    let birthDate = '';

                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        role = data.role || 'student';
                        birthDate = data.birthDate || '';
                        
                        // C·∫≠p nh·∫≠t UI Navbar
                        userNameDisplay.textContent = data.displayName || user.displayName || user.email;
                        
                        // Hi·ªÉn th·ªã vai tr√≤ ti·∫øng Vi·ªát ƒë·∫πp
                        const roleMap = {
                            'student': 'H·ªçc sinh',
                            'teacher': 'Gi√°o vi√™n',
                            'admin': 'Qu·∫£n tr·ªã vi√™n'
                        };
                        userRoleDisplay.textContent = roleMap[role] || role;
                        
                        // ƒêi·ªÅn s·∫µn v√†o Form Modal
                        editDisplayName.value = data.displayName || user.displayName || "";
                        editBirthDate.value = birthDate;
                        editRole.value = role;
                    }

                    // Avatar
                    const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random&color=fff&background=F97316`;
                    userAvatar.src = photoURL;
                    modalAvatar.src = photoURL;
                } catch (error) {
                    console.error("L·ªói t·∫£i d·ªØ li·ªáu user:", error);
                }

            } else {
                // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, ƒë√° v·ªÅ trang ch·ªß
                window.location.href = "index.html";
            }
        });

        // 2. X·ª¨ L√ù ƒêƒÇNG XU·∫§T
        logoutBtn.addEventListener('click', () => {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?")) {
                signOut(auth).then(() => window.location.href = "index.html");
            }
        });

        // 3. X·ª¨ L√ù MODAL (M·ªü/ƒê√≥ng v·ªõi hi·ªáu ·ª©ng)
        function toggleModal() {
            const body = document.querySelector('body');
            const isOpening = profileModal.classList.contains('opacity-0');

            if (isOpening) {
                // M·ªü
                profileModal.classList.remove('opacity-0', 'pointer-events-none');
                body.classList.add('modal-active');
                modalContainer.classList.remove('scale-95');
                modalContainer.classList.add('scale-100');
            } else {
                // ƒê√≥ng
                profileModal.classList.add('opacity-0', 'pointer-events-none');
                body.classList.remove('modal-active');
                modalContainer.classList.remove('scale-100');
                modalContainer.classList.add('scale-95');
                
                // Reset th√¥ng b√°o l·ªói khi ƒë√≥ng
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                    saveProfileBtn.disabled = false;
                    saveProfileBtn.textContent = "L∆∞u thay ƒë·ªïi";
                }, 300);
            }
        }

        avatarBtn.addEventListener('click', toggleModal);
        userInfoText.addEventListener('click', toggleModal);
        closeModalBtn.addEventListener('click', toggleModal);
        cancelBtn.addEventListener('click', toggleModal);
        
        // ƒê√≥ng khi click ra ngo√†i
        profileModal.addEventListener('click', function(event) {
            if (event.target === profileModal || event.target.classList.contains('modal-overlay')) {
                toggleModal();
            }
        });

        // 4. L∆ØU TH√îNG TIN PROFILE
        saveProfileBtn.addEventListener('click', async () => {
            if (!currentUserUid) return;

            const newName = editDisplayName.value;
            const newRole = editRole.value;
            const newBirth = editBirthDate.value;

            if (!newName.trim()) {
                alert("Vui l√≤ng nh·∫≠p t√™n hi·ªÉn th·ªã!");
                return;
            }

            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = 'ƒêang l∆∞u...';
            saveStatus.classList.add('hidden');

            try {
                // C·∫≠p nh·∫≠t Firestore
                await updateDoc(doc(db, "users", currentUserUid), {
                    displayName: newName,
                    role: newRole,
                    birthDate: newBirth
                });

                // C·∫≠p nh·∫≠t Auth Profile (ƒë·ªÉ ƒë·ªìng b·ªô ·ªü nh·ªØng n∆°i kh√°c)
                if (auth.currentUser) {
                    await updateProfile(auth.currentUser, { displayName: newName }).catch(e => console.log("Auth update skip"));
                }

                saveStatus.textContent = "C·∫≠p nh·∫≠t th√†nh c√¥ng! ƒêang t·∫£i l·∫°i...";
                saveStatus.className = "text-center text-sm font-bold text-green-600 block p-2 rounded bg-green-50";
                
                // Hi·ªáu ·ª©ng th√†nh c√¥ng ng·∫Øn
                setTimeout(() => {
                    location.reload(); 
                }, 1000);

            } catch (error) {
                console.error("L·ªói:", error);
                saveStatus.textContent = "L·ªói khi l∆∞u: " + error.message;
                saveStatus.className = "text-center text-sm font-bold text-red-600 block p-2 rounded bg-red-50";
                saveProfileBtn.disabled = false;
                saveProfileBtn.textContent = "L∆∞u thay ƒë·ªïi";
            }
        });

    </script>
</body>
</html>
