<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng qu·∫£n l√Ω - To√°n th·∫ßy Choang Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Th∆∞ vi·ªán x·ª≠ l√Ω Excel & MathJax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3F4F6; }
        .font-handwriting { font-family: 'Pacifico', cursive; }
        
        /* Sidebar Active State */
        .nav-item.active { background-color: #FFF7ED; color: #C2410C; border-right: 3px solid #F97316; font-weight: 700; }
        .nav-item i { width: 24px; text-align: center; }

        /* File Explorer Items */
        .explorer-item { transition: all 0.2s; user-select: none; }
        .explorer-item:hover { background-color: #EFF6FF; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Drag & Drop Visuals - Hi·ªáu ·ª©ng r√µ h∆°n */
        .explorer-item.drag-over {
            background-color: #DBEAFE !important; /* Xanh ƒë·∫≠m */
            border: 2px dashed #2563EB !important;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .explorer-item.dragging {
            opacity: 0.4;
            border: 2px dashed #9CA3AF;
            background-color: #F3F4F6;
        }

        /* Notification & Modal Animations */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .notification-toast { animation: slideIn 0.5s ease forwards; }
        .notification-toast.hide { animation: fadeOut 0.5s ease forwards; }
        .modal { transition: opacity 0.2s ease; }
        body.modal-active { overflow: hidden; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800 bg-gray-50">

    <!-- CONTAINER TH√îNG B√ÅO -->
    <div id="notificationContainer" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- SIDEBAR (MENU TR√ÅI) -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-sm flex-shrink-0">
        <!-- Logo -->
        <div class="h-16 flex items-center gap-3 px-6 border-b border-gray-100">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold shadow-sm">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <span class="text-lg text-orange-600 font-handwriting pt-1">Th·∫ßy Choang</span>
        </div>

        <!-- User Mini Profile -->
        <div class="p-4 border-b border-gray-100 bg-gray-50">
            <div class="flex items-center gap-3 cursor-pointer" onclick="toggleModal('profileModal', true)">
                <img id="sidebarAvatar" src="https://via.placeholder.com/150" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                <div class="overflow-hidden">
                    <p id="sidebarName" class="text-sm font-bold text-gray-800 truncate">ƒêang t·∫£i...</p>
                    <p id="sidebarRole" class="text-xs text-gray-500 truncate">...</p>
                </div>
            </div>
        </div>

        <!-- Navigation Links -->
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="switchView('home')" id="nav-home" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3">
                <i class="fa-solid fa-house"></i> S·∫£nh ch√≠nh
            </button>
            
            <!-- M·ª•c Gi√°o vi√™n -->
            <div id="teacherMenu" class="hidden">
                <div class="px-6 mt-4 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Qu·∫£n l√Ω</div>
                <button onclick="switchView('classes')" id="nav-classes" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-chalkboard-user"></i> Danh s√°ch l·ªõp h·ªçc
                </button>
                <button onclick="switchView('exambank')" id="nav-exambank" class="nav-item w-full text-left px-6 py-3 text-gray-600 hover:bg-gray-50 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-folder-tree"></i> Ng√¢n h√†ng ƒë·ªÅ thi
                </button>
            </div>
        </nav>

        <!-- Footer Logout -->
        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtn" class="w-full py-2 text-gray-500 hover:text-red-600 font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT (PH·∫¢I) -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <!-- VIEW 1: S·∫¢NH CH√çNH (HOME) -->
        <div id="view-home" class="view-section flex-1 overflow-y-auto p-8">
            <div class="max-w-5xl mx-auto">
                <!-- Welcome Banner -->
                <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-3xl p-8 text-white mb-10 shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-3xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</h1>
                        <p class="opacity-90">S·∫µn s√†ng chinh ph·ª•c ƒë·ªânh cao tri th·ª©c h√¥m nay ch∆∞a?</p>
                    </div>
                    <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 rounded-full bg-white opacity-10"></div>
                    <div class="absolute bottom-0 right-20 w-32 h-32 rounded-full bg-white opacity-10"></div>
                </div>

                <!-- Danh s√°ch m√¥n thi -->
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-orange-500 pl-4">Ch·ªçn m√¥n thi</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                        <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-calculator"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">To√°n H·ªçc</h3>
                        <p class="text-gray-500 text-sm mb-4">R√®n luy·ªán t∆∞ duy logic.</p>
                        <button onclick="window.location.href='exam.html'" class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
                    </div>
                    <!-- C√°c m√¥n kh√°c... -->
                    <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                        <div class="w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-book-open"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Vi·ªát</h3>
                        <p class="text-gray-500 text-sm mb-4">V·∫ª ƒë·∫πp ng√¥n ng·ªØ Vi·ªát.</p>
                        <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-green-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all p-6 group cursor-pointer border border-transparent hover:border-orange-200">
                        <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-language"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Ti·∫øng Anh</h3>
                        <p class="text-gray-500 text-sm mb-4">N√¢ng cao kh·∫£ nƒÉng ngo·∫°i ng·ªØ.</p>
                        <button class="w-full py-2 bg-gray-50 text-gray-700 font-bold rounded-lg group-hover:bg-purple-600 group-hover:text-white transition-colors">V√†o thi ngay</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DANH S√ÅCH L·ªöP H·ªåC -->
        <div id="view-classes" class="view-section hidden flex-1 flex flex-col h-full">
            <div class="bg-white border-b border-gray-200 p-6 flex justify-between items-center shadow-sm z-10">
                <h2 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-chalkboard-user mr-2 text-blue-500"></i>Qu·∫£n l√Ω L·ªõp h·ªçc</h2>
                <button id="createClassBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition-all flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> T·∫°o l·ªõp m·ªõi
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div id="classList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Danh s√°ch l·ªõp s·∫Ω render v√†o ƒë√¢y -->
                    <p class="text-gray-400 italic col-span-3 text-center py-10">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>

        <!-- VIEW 3: NG√ÇN H√ÄNG ƒê·ªÄ THI (FILE EXPLORER) -->
        <div id="view-exambank" class="view-section hidden flex-1 flex flex-col h-full bg-white">
            <!-- Toolbar -->
            <div class="h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-white shrink-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center text-gray-500 text-sm bg-gray-100 px-3 py-1.5 rounded-lg">
                        <button onclick="navigateFolder('root')" class="hover:text-blue-600 font-bold flex items-center gap-1" title="V·ªÅ th∆∞ m·ª•c g·ªëc">
                            <i class="fa-solid fa-house"></i>
                        </button>
                        <span id="breadcrumbContainer" class="flex items-center">
                            <!-- Breadcrumb items will be here -->
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="createNewFolder()" class="px-3 py-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg text-sm font-bold transition-colors">
                        <i class="fa-solid fa-folder-plus mr-1"></i> T·∫°o th∆∞ m·ª•c
                    </button>
                    <button onclick="window.location.href='exam-editor.html'" class="px-3 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg text-sm font-bold transition-colors">
                        <i class="fa-solid fa-file-circle-plus mr-1"></i> So·∫°n ƒë·ªÅ m·ªõi
                    </button>
                </div>
            </div>

            <!-- File Explorer Area -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="fileExplorerArea">
                <!-- Grid Folders & Files -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="explorerGrid">
                    <!-- JS Render here -->
                </div>
                
                <div id="emptyExplorerMsg" class="hidden flex flex-col items-center justify-center h-64 text-gray-400">
                    <i class="fa-regular fa-folder-open text-6xl mb-4 text-gray-300"></i>
                    <p>Th∆∞ m·ª•c tr·ªëng</p>
                    <p class="text-xs mt-2">K√©o th·∫£ ƒë·ªÉ di chuy·ªÉn t·ªáp tin</p>
                </div>
            </div>
        </div>

    </main>

    <!-- === MODALS & POPUPS (ƒê√É N√ÇNG C·∫§P) === -->

    <!-- 1. Modal Nh·∫≠p li·ªáu chung (C√≥ n√∫t X) -->
    <div id="genericInputModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 relative">
            <button id="gInputClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times"></i></button>
            <h3 id="gInputTitle" class="text-lg font-bold text-gray-800 mb-4">Nh·∫≠p th√¥ng tin</h3>
            <input type="text" id="gInputVal" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="...">
            <div class="flex justify-end gap-3 mt-6">
                <button id="gInputCancel" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold transition-colors">H·ªßy</button>
                <button id="gInputConfirm" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all">OK</button>
            </div>
        </div>
    </div>

    <!-- 2. Modal X√°c nh·∫≠n chung (C√≥ n√∫t X) -->
    <div id="genericConfirmModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-50 transition-opacity duration-300">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300 text-center relative">
            <button id="gConfirmClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times"></i></button>
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">X√°c nh·∫≠n</h3>
            <p id="gConfirmMsg" class="text-gray-500 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán?</p>
            <div class="flex justify-center gap-3">
                <button id="gConfirmCancel" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold transition-colors">H·ªßy</button>
                <button id="gConfirmOk" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition-all">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <!-- Modal Profile -->
    <div id="profileModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Th√¥ng tin c√° nh√¢n</h3>
            <div class="space-y-4">
                <input type="text" id="editDisplayName" placeholder="T√™n hi·ªÉn th·ªã" class="w-full px-4 py-2 border rounded-lg">
                <input type="date" id="editBirthDate" class="w-full px-4 py-2 border rounded-lg">
                <select id="editRole" class="w-full px-4 py-2 border rounded-lg bg-white">
                    <option value="student">H·ªçc sinh</option>
                    <option value="teacher">Gi√°o vi√™n</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="toggleModal('profileModal', false)" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-600">H·ªßy</button>
                <button id="saveProfileBtn" class="px-4 py-2 bg-orange-500 text-white rounded-lg">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Modal Context Menu (Rename/Move/Delete) -->
    <div id="actionModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="modal-container bg-white w-96 rounded-2xl shadow-2xl p-6 relative">
            <h3 id="actionModalTitle" class="text-xl font-bold text-gray-800 mb-4">H√†nh ƒë·ªông</h3>
            <div id="dynamicContent"></div> 
            <button onclick="toggleModal('actionModal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <!-- Modal Class Details (C·∫•u tr√∫c nh∆∞ c≈©) -->
    <div id="classModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-5xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300" style="max-height: 90vh;">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-blue-50 rounded-t-2xl">
                <div class="flex items-center gap-2">
                    <p class="text-xl font-bold text-blue-800" id="classModalTitle">Chi ti·∫øt L·ªõp h·ªçc</p>
                    <button onclick="editClassName()" class="text-blue-400 hover:text-blue-600 p-1 rounded transition-colors" title="ƒê·ªïi t√™n l·ªõp"><i class="fa-solid fa-pen text-sm"></i></button>
                </div>
                <div onclick="toggleModal('classModal', false)" class="cursor-pointer z-50 p-2 hover:bg-blue-200 rounded-full text-blue-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            <!-- Tab Navigation -->
            <div class="flex px-6 border-b border-gray-100">
                <button onclick="switchTab('students')" id="tabBtnStudents" class="tab-btn active px-4 py-3 text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors"><i class="fa-solid fa-users mr-1"></i> Danh s√°ch h·ªçc sinh</button>
                <button onclick="switchTab('exams')" id="tabBtnExams" class="tab-btn px-4 py-3 text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors"><i class="fa-solid fa-file-contract mr-1"></i> B√†i t·∫≠p, ƒê·ªÅ thi</button>
            </div>
            <div class="p-6">
                <!-- TAB 1: DANH S√ÅCH H·ªåC SINH -->
                <div id="tabContentStudents" class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-gray-700 text-sm uppercase"><i class="fa-solid fa-user-plus mr-1"></i> Th√™m nhanh</h4>
                            <div class="flex gap-2">
                                <button onclick="downloadTemplate()" class="text-xs px-3 py-1 bg-white border border-green-500 text-green-600 rounded hover:bg-green-50 transition-colors"><i class="fa-solid fa-download"></i> File m·∫´u</button>
                                <label for="excelInput" class="text-xs px-3 py-1 bg-green-500 text-white rounded cursor-pointer hover:bg-green-600 transition-colors flex items-center gap-1"><i class="fa-solid fa-file-excel"></i> Nh·∫≠p t·ª´ Excel</label>
                                <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(this)">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input type="text" id="newStudentName" placeholder="H·ªç v√† t√™n" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                            <input type="text" id="newStudentUser" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                            <input type="text" id="newStudentPass" placeholder="M·∫≠t kh·∫©u" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                        </div>
                        <button id="addStudentBtn" class="mt-3 w-full py-2 bg-blue-500 text-white rounded-lg font-bold text-sm hover:bg-blue-600 transition-colors"><i class="fa-solid fa-plus mr-1"></i> Th√™m v√†o danh s√°ch</button>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Danh s√°ch h·ªçc sinh <span id="studentCountBadge" class="ml-2 bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded-full">0</span></h4>
                        <div class="overflow-x-auto border rounded-lg max-h-80 overflow-y-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                    <tr><th class="px-4 py-3">STT</th><th class="px-4 py-3">H·ªç t√™n</th><th class="px-4 py-3">SBD</th><th class="px-4 py-3">T√†i kho·∫£n</th><th class="px-4 py-3">M·∫≠t kh·∫©u</th><th class="px-4 py-3 text-center">H√†nh ƒë·ªông</th></tr>
                                </thead>
                                <tbody id="studentListTable" class="divide-y divide-gray-100"></tbody>
                            </table>
                            <p id="emptyStudentMsg" class="text-center py-8 text-gray-400 italic hidden">Ch∆∞a c√≥ h·ªçc sinh n√†o.</p>
                        </div>
                    </div>
                </div>
                <!-- TAB 2 -->
                <div id="tabContentExams" class="hidden space-y-6">
                    <div class="border rounded-xl p-8 text-center bg-gray-50 border-dashed border-gray-300">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 text-2xl"><i class="fa-solid fa-file-invoice"></i></div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Ch∆∞a c√≥ b√†i t·∫≠p n√†o</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal S·ª≠a H·ªçc Sinh (M·ªõi) -->
    <div id="editStudentModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-xl mx-auto rounded-2xl shadow-2xl z-[60] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-100 bg-orange-50 rounded-t-2xl">
                <p class="text-xl font-bold text-orange-800">S·ª≠a th√¥ng tin h·ªçc sinh</p>
                <div onclick="toggleModal('editStudentModal', false)" class="cursor-pointer p-2 hover:bg-orange-200 rounded-full text-orange-500 transition-colors"><i class="fa-solid fa-times"></i></div>
            </div>
            <div class="p-6 space-y-4">
                <!-- N·ªôi dung Form S·ª≠a (Nh∆∞ c≈©) -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">H·ªç v√† t√™n</label><input type="text" id="editStuName" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div>
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">S·ªë b√°o danh</label><input type="text" id="editStuSBD" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div>
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">Gi·ªõi t√≠nh</label><select id="editStuGender" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT H·ªçc sinh</label><input type="text" id="editStuPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div>
                    <div><label class="block text-xs font-bold text-gray-700 mb-1">SƒêT Ph·ª• huynh</label><input type="text" id="editStuParentPhone" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-700 mb-1">Email</label><input type="email" id="editStuEmail" class="w-full px-3 py-2 rounded-lg border border-gray-300"></div>
                </div>
                <hr class="border-gray-100">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h5 class="text-xs font-bold text-blue-800 uppercase mb-3">Th√¥ng tin ƒëƒÉng nh·∫≠p</h5>
                    <div class="space-y-3">
                        <div><label class="block text-xs font-bold text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="editStuUsername" class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-100 text-gray-500 cursor-not-allowed"></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">M·∫≠t kh·∫©u</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="password" id="editStuPassword" class="w-full px-3 py-2 rounded-lg border border-gray-300 pr-10">
                                    <div onclick="const i=document.getElementById('editStuPassword');i.type=i.type==='password'?'text':'password'" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400"><i class="fa-regular fa-eye"></i></div>
                                </div>
                                <button onclick="refreshPassword()" class="px-3 py-2 bg-white border border-blue-300 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-50"><i class="fa-solid fa-rotate"></i> L√†m m·ªõi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end pt-2 pb-6 px-6 gap-3 bg-gray-50 rounded-b-2xl">
                <button onclick="toggleModal('editStudentModal', false)" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">H·ªßy</button>
                <button id="saveStudentBtn" class="px-6 py-2 bg-orange-custom text-white rounded-lg hover:bg-orange-600 font-bold shadow-md">L∆∞u th√¥ng tin</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, onSnapshot, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL HELPER FUNCTIONS (PROMISIFIED MODALS) ---
        
        // 1. Custom Prompt (C√≥ n√∫t X)
        window.customPrompt = (title, placeholder = '', defaultValue = '') => {
            return new Promise((resolve) => {
                const modal = document.getElementById('genericInputModal');
                const titleEl = document.getElementById('gInputTitle');
                const inputEl = document.getElementById('gInputVal');
                const confirmBtn = document.getElementById('gInputConfirm');
                const cancelBtn = document.getElementById('gInputCancel');
                const closeBtn = document.getElementById('gInputClose');

                titleEl.textContent = title;
                inputEl.placeholder = placeholder;
                inputEl.value = defaultValue;

                // Show Modal
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-container').classList.remove('scale-95');
                modal.querySelector('.modal-container').classList.add('scale-100');
                inputEl.focus();

                const close = () => {
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    modal.querySelector('.modal-container').classList.add('scale-95');
                    modal.querySelector('.modal-container').classList.remove('scale-100');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    closeBtn.onclick = null;
                    inputEl.onkeydown = null;
                };

                confirmBtn.onclick = () => { close(); resolve(inputEl.value); };
                cancelBtn.onclick = () => { close(); resolve(null); };
                closeBtn.onclick = () => { close(); resolve(null); };
                inputEl.onkeydown = (e) => { if(e.key === 'Enter') confirmBtn.click(); if(e.key === 'Escape') cancelBtn.click(); };
            });
        };

        // 2. Custom Confirm (C√≥ n√∫t X)
        window.customConfirm = (message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('genericConfirmModal');
                const msgEl = document.getElementById('gConfirmMsg');
                const okBtn = document.getElementById('gConfirmOk');
                const cancelBtn = document.getElementById('gConfirmCancel');
                const closeBtn = document.getElementById('gConfirmClose');

                msgEl.textContent = message;

                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-container').classList.remove('scale-95');
                modal.querySelector('.modal-container').classList.add('scale-100');

                const close = () => {
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    modal.querySelector('.modal-container').classList.add('scale-95');
                    modal.querySelector('.modal-container').classList.remove('scale-100');
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    closeBtn.onclick = null;
                };

                okBtn.onclick = () => { close(); resolve(true); };
                cancelBtn.onclick = () => { close(); resolve(false); };
                closeBtn.onclick = () => { close(); resolve(false); };
            });
        };

        // UI Variables & Helpers
        let currentUserUid = null;
        let currentRole = 'student';
        let currentFolderId = null;
        let folderData = [];
        let examData = [];
        let currentActionItem = null;
        let currentViewingClassId = null;
        let currentClassStudents = [];
        let editingStudentIndex = -1;

        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if(show) {
                el.classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-active');
                if(el.querySelector('.modal-container')) el.querySelector('.modal-container').classList.remove('scale-95');
            } else {
                el.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
                if(el.querySelector('.modal-container')) el.querySelector('.modal-container').classList.add('scale-95');
            }
        }

        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${viewName}`);
            if(activeNav) activeNav.classList.add('active');
        }

        window.showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            const color = type === 'success' ? 'green' : 'red';
            div.className = `notification-toast pointer-events-auto bg-white border-l-4 border-${color}-500 shadow-lg rounded-lg p-4 w-80 flex items-start`;
            div.innerHTML = `<i class="fa-solid fa-${type==='success'?'check':'circle-exclamation'} text-${color}-500 mt-1 mr-3"></i><div><h4 class="font-bold text-gray-800 text-sm">${type==='success'?'Th√†nh c√¥ng':'L·ªói'}</h4><p class="text-sm text-gray-600">${msg}</p></div>`;
            container.appendChild(div);
            setTimeout(() => { div.classList.add('hide'); setTimeout(() => div.remove(), 500); }, 3000);
        }

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        currentRole = data.role || 'student';
                        document.getElementById('sidebarName').textContent = data.displayName || user.email;
                        document.getElementById('sidebarRole').textContent = currentRole === 'teacher' ? 'Gi√°o vi√™n' : (currentRole === 'admin' ? 'Admin' : 'H·ªçc sinh');
                        document.getElementById('sidebarAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
                        
                        document.getElementById('editDisplayName').value = data.displayName || "";
                        document.getElementById('editBirthDate').value = data.birthDate || "";
                        document.getElementById('editRole').value = currentRole;

                        if (currentRole === 'teacher' || currentRole === 'admin') {
                            document.getElementById('teacherMenu').classList.remove('hidden');
                            loadClasses();
                            loadFileManager();
                        }
                    }
                } catch (e) { console.error(e); }
            } else {
                window.location.href = "index.html";
            }
        });

        // 1. CLASS MANAGER
        function loadClasses() {
            const q = query(collection(db, "classes"), where("teacherId", "==", currentUserUid));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('classList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const cl = d.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer relative group";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2"><div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">${cl.name.substring(0,2).toUpperCase()}</div><div class="opacity-0 group-hover:opacity-100 transition-opacity"><button class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen"></i></button></div></div>
                        <h3 class="font-bold text-gray-800 text-lg mb-1">${cl.name}</h3><p class="text-sm text-gray-500">${cl.studentCount || 0} h·ªçc sinh</p>
                    `;
                    card.onclick = () => openClassModal(d.id, cl.name, cl.students || []);
                    list.appendChild(card);
                });
                const addCard = document.createElement('button');
                addCard.className = "border-2 border-dashed border-gray-300 rounded-xl p-5 flex flex-col items-center justify-center text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors h-full min-h-[140px]";
                addCard.innerHTML = `<i class="fa-solid fa-plus text-3xl mb-2"></i><span class="font-bold">T·∫°o l·ªõp m·ªõi</span>`;
                addCard.onclick = async () => {
                    const name = await customPrompt("Nh·∫≠p t√™n l·ªõp h·ªçc m·ªõi:", "VD: L·ªõp 5A");
                    if(name) {
                        await addDoc(collection(db, "classes"), { name, teacherId: currentUserUid, studentCount: 0, createdAt: new Date().toISOString() });
                        showNotification("T·∫°o l·ªõp th√†nh c√¥ng");
                    }
                };
                list.appendChild(addCard);
            });
        }

        // 2. FILE EXPLORER (UPDATED DRAG & DROP & CLICK FIX)
        function loadFileManager() {
            const qFolders = query(collection(db, "folders"), where("teacherId", "==", currentUserUid));
            onSnapshot(qFolders, (snap) => {
                folderData = [];
                snap.forEach(d => folderData.push({id: d.id, ...d.data()}));
                renderExplorer();
            });
            const qExams = query(collection(db, "exams"), where("teacherId", "==", currentUserUid));
            onSnapshot(qExams, (snap) => {
                examData = [];
                snap.forEach(d => examData.push({id: d.id, ...d.data()}));
                renderExplorer();
            });
        }

        function renderExplorer() {
            const grid = document.getElementById('explorerGrid');
            grid.innerHTML = '';
            const currentFolders = folderData.filter(f => f.parentId === currentFolderId);
            const currentExams = examData.filter(e => (e.folderId || null) === currentFolderId);

            if (currentFolders.length === 0 && currentExams.length === 0) document.getElementById('emptyExplorerMsg').classList.remove('hidden');
            else document.getElementById('emptyExplorerMsg').classList.add('hidden');

            currentFolders.forEach(f => {
                const div = document.createElement('div');
                div.className = "explorer-item bg-white p-4 rounded-xl border border-gray-200 cursor-pointer relative group";
                // Add Drag Events
                div.draggable = true;
                div.ondragstart = (e) => handleDragStart(e, f.id, 'folder');
                div.ondragover = (e) => handleDragOver(e);
                div.ondragleave = (e) => handleDragLeave(e);
                div.ondrop = (e) => handleDrop(e, f.id);

                div.innerHTML = `<div class="text-4xl text-yellow-400 mb-3 text-center"><i class="fa-solid fa-folder"></i></div><p class="text-sm font-bold text-gray-700 text-center truncate px-2">${f.name}</p><div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="event.stopPropagation(); openContextMenu('${f.id}', 'folder', '${f.name}')" class="p-1 hover:bg-gray-100 rounded text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></button></div>`;
                // FIX ONCLICK: Attach directly
                div.onclick = (e) => {
                    // Only navigate if not clicking the menu button
                    if(!e.target.closest('button')) navigateFolder(f.id, f.name);
                };
                grid.appendChild(div);
            });

            currentExams.forEach(e => {
                const div = document.createElement('div');
                div.className = "explorer-item bg-white p-4 rounded-xl border border-gray-200 cursor-pointer relative group";
                // Add Drag Events
                div.draggable = true;
                div.ondragstart = (e) => handleDragStart(e, e.id, 'exam');
                
                div.innerHTML = `<div class="text-4xl text-blue-500 mb-3 text-center"><i class="fa-regular fa-file-lines"></i></div><p class="text-sm font-bold text-gray-700 text-center truncate px-2" title="${e.title}">${e.title}</p><div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="event.stopPropagation(); openContextMenu('${e.id}', 'exam', '${e.title}')" class="p-1 hover:bg-gray-100 rounded text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></button></div>`;
                div.onclick = (e) => {
                    if(!e.target.closest('button')) window.location.href = `exam-editor.html?id=${e.id}`;
                };
                grid.appendChild(div);
            });
            renderBreadcrumb();
        }

        // DRAG & DROP LOGIC (UPDATED)
        window.handleDragStart = (e, id, type) => {
            e.dataTransfer.setData("text/plain", JSON.stringify({id, type}));
            e.target.classList.add('dragging');
        }

        window.handleDragOver = (e) => {
            e.preventDefault(); // Required to allow dropping
            e.currentTarget.classList.add('drag-over');
        }

        window.handleDragLeave = (e) => {
            e.currentTarget.classList.remove('drag-over');
        }

        window.handleDrop = async (e, targetId) => {
            e.preventDefault();
            e.stopPropagation(); // Stop bubbling
            e.currentTarget.classList.remove('drag-over');
            
            try {
                const data = JSON.parse(e.dataTransfer.getData("text/plain"));
                if (data.id === targetId) return; // Can't drop into self

                // Perform Move
                await commitMoveInternal(data.id, data.type, targetId);
            } catch (err) {
                console.error("Drop error", err);
            }
            
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        }

        // Refactored Commit Move logic to reuse
        async function commitMoveInternal(itemId, itemType, targetFolderId) {
            const collName = itemType === 'folder' ? 'folders' : 'exams';
            const field = itemType === 'folder' ? 'parentId' : 'folderId';
            await updateDoc(doc(db, collName, itemId), { [field]: targetFolderId });
            showNotification("ƒê√£ di chuy·ªÉn th√†nh c√¥ng!");
        }

        // NAVIGATION
        window.navigateFolder = (id, name) => {
            if(id === 'root') { currentFolderId = null; breadcrumbs = []; }
            else { currentFolderId = id; breadcrumbs.push({id, name}); }
            renderExplorer();
        }

        function renderBreadcrumb() {
            const container = document.getElementById('breadcrumbContainer');
            if (!currentFolderId) { container.innerHTML = '<span class="mx-2 text-gray-400">/</span><span>T·∫•t c·∫£</span>'; return; }
            let path = []; let curr = folderData.find(f => f.id === currentFolderId);
            while(curr) { path.unshift(curr); curr = folderData.find(f => f.id === curr.parentId); }
            let html = '<span class="mx-2 text-gray-400">/</span><button onclick="navigateFolder(\'root\')" class="hover:text-blue-600">...</button>';
            path.forEach((p, idx) => { html += `<span class="mx-2 text-gray-400">/</span>`; if (idx === path.length - 1) html += `<span class="font-bold text-gray-800">${p.name}</span>`; else html += `<button onclick="navigateFolder('${p.id}')" class="hover:text-blue-600">${p.name}</button>`; });
            container.innerHTML = html;
        }

        // ACTIONS WITH CUSTOM MODAL
        window.createNewFolder = async () => {
            const name = await customPrompt("Nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi:", "VD: To√°n ƒê·∫°i S·ªë");
            if(name) {
                try {
                    await addDoc(collection(db, "folders"), { name, parentId: currentFolderId, teacherId: currentUserUid, createdAt: new Date().toISOString() });
                    showNotification("ƒê√£ t·∫°o th∆∞ m·ª•c");
                } catch(e) { showNotification("L·ªói: " + e.message, "error"); }
            }
        }

        window.openContextMenu = (id, type, name) => {
            currentActionItem = {id, type, name};
            document.getElementById('actionModalTitle').textContent = `Thao t√°c: ${name}`;
            const content = document.getElementById('dynamicContent');
            content.innerHTML = `
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <button onclick="triggerAction('rename')" class="p-3 bg-blue-50 text-blue-600 rounded-lg font-bold hover:bg-blue-100 flex flex-col items-center"><i class="fa-solid fa-pen mb-1"></i> ƒê·ªïi t√™n</button>
                    <button onclick="triggerAction('move')" class="p-3 bg-purple-50 text-purple-600 rounded-lg font-bold hover:bg-purple-100 flex flex-col items-center"><i class="fa-solid fa-arrow-right-to-bracket mb-1"></i> Di chuy·ªÉn</button>
                    <button onclick="triggerAction('delete')" class="p-3 bg-red-50 text-red-600 rounded-lg font-bold hover:bg-red-100 flex flex-col items-center"><i class="fa-solid fa-trash mb-1"></i> X√≥a</button>
                </div>
                <div id="subActionContent"></div>
            `;
            toggleModal('actionModal', true);
        }

        window.triggerAction = async (action) => {
            const container = document.getElementById('subActionContent');
            container.innerHTML = ''; 

            if (action === 'rename') {
                container.innerHTML = `<label class="block text-sm font-bold text-gray-700 mb-2">T√™n m·ªõi</label><div class="flex gap-2"><input type="text" id="renameInput" value="${currentActionItem.name}" class="flex-1 border rounded px-3 py-2"><button onclick="commitRename()" class="bg-blue-600 text-white px-4 rounded font-bold">L∆∞u</button></div>`;
            } else if (action === 'delete') {
                toggleModal('actionModal', false);
                if(await customConfirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a "${currentActionItem.name}"?`)) {
                    try {
                        const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams';
                        await deleteDoc(doc(db, collName, currentActionItem.id));
                        showNotification("ƒê√£ x√≥a!");
                    } catch(e) { showNotification(e.message, 'error'); }
                }
            } else if (action === 'move') {
                let html = '<p class="text-sm font-bold text-gray-700 mb-2">Ch·ªçn th∆∞ m·ª•c ƒë·∫øn:</p><div class="h-40 overflow-y-auto border rounded p-1 space-y-1">';
                html += `<button onclick="commitMove(null)" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2"><i class="fa-solid fa-house text-gray-400"></i> Th∆∞ m·ª•c g·ªëc</button>`;
                folderData.forEach(f => { if (f.id !== currentActionItem.id) html += `<button onclick="commitMove('${f.id}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-2"><i class="fa-solid fa-folder text-yellow-400"></i> ${f.name}</button>`; });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        window.commitRename = async () => {
            const newName = document.getElementById('renameInput').value;
            if(!newName) return;
            const collName = currentActionItem.type === 'folder' ? 'folders' : 'exams';
            await updateDoc(doc(db, collName, currentActionItem.id), { name: newName, title: newName });
            showNotification("ƒê√£ ƒë·ªïi t√™n");
            toggleModal('actionModal', false);
        }

        window.commitMove = async (targetFolderId) => {
            await commitMoveInternal(currentActionItem.id, currentActionItem.type, targetFolderId);
            toggleModal('actionModal', false);
        }

        // CLASS MODAL LOGIC
        function openClassModal(classId, className, students) {
            currentViewingClassId = classId;
            currentClassStudents = students || [];
            document.getElementById('classModalTitle').textContent = `Qu·∫£n l√Ω: ${className}`;
            renderStudentList(currentClassStudents);
            window.switchTab('students');
            toggleModal('classModal', true);
        }

        window.editClassName = async () => {
            if (!currentViewingClassId) return;
            const currentName = document.getElementById('classModalTitle').textContent.replace('Qu·∫£n l√Ω: ', '');
            const newName = await customPrompt("Nh·∫≠p t√™n m·ªõi cho l·ªõp:", "", currentName);
            if (newName && newName !== currentName) {
                try {
                    const classRef = doc(db, "classes", currentViewingClassId);
                    await updateDoc(classRef, { name: newName });
                    document.getElementById('classModalTitle').textContent = `Qu·∫£n l√Ω: ${newName}`;
                    showNotification("ƒê·ªïi t√™n l·ªõp th√†nh c√¥ng!", "success");
                } catch(e) { showNotification("L·ªói: " + e.message, "error"); }
            }
        }

        function renderStudentList(students) {
            const table = document.getElementById('studentListTable');
            table.innerHTML = '';
            document.getElementById('studentCountBadge').textContent = students ? students.length : 0;
            if (!students || students.length === 0) document.getElementById('emptyStudentMsg').classList.remove('hidden');
            else {
                document.getElementById('emptyStudentMsg').classList.add('hidden');
                students.forEach((st, index) => {
                    const row = document.createElement('tr');
                    row.className = "bg-white hover:bg-gray-50 border-b";
                    row.innerHTML = `<td class="px-4 py-3 font-medium text-gray-500">${index + 1}</td><td class="px-4 py-3 font-medium text-gray-900">${st.name}</td><td class="px-4 py-3 text-gray-500">${st.sbd || '---'}</td><td class="px-4 py-3 text-blue-600 font-medium">${st.username}</td><td class="px-4 py-3 font-mono text-gray-400">******</td><td class="px-4 py-3 text-center"><button onclick="openEditStudent(${index})" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors mr-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deleteStudent(${index})" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors"><i class="fa-solid fa-trash"></i></button></td>`;
                    table.appendChild(row);
                });
            }
        }

        window.openEditStudent = function(index) {
            editingStudentIndex = index;
            const st = currentClassStudents[index];
            document.getElementById('editStuName').value = st.name || '';
            document.getElementById('editStuSBD').value = st.sbd || '';
            document.getElementById('editStuGender').value = st.gender || 'Nam';
            document.getElementById('editStuPhone').value = st.phoneStudent || '';
            document.getElementById('editStuParentPhone').value = st.phoneParent || '';
            document.getElementById('editStuEmail').value = st.email || '';
            document.getElementById('editStuUsername').value = st.username || '';
            document.getElementById('editStuPassword').value = st.password || '';
            document.getElementById('editStuPassword').type = "password"; 
            toggleModal('editStudentModal', true);
        }

        window.deleteStudent = async function(index) {
            if(!await customConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc sinh n√†y kh·ªèi l·ªõp?")) return;
            try {
                currentClassStudents.splice(index, 1);
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, { students: currentClassStudents, studentCount: currentClassStudents.length });
                renderStudentList(currentClassStudents);
                showNotification("ƒê√£ x√≥a h·ªçc sinh.", "success");
            } catch(e) { showNotification("L·ªói x√≥a: " + e.message, "error"); }
        }

        document.getElementById('saveStudentBtn').addEventListener('click', async () => {
            if (editingStudentIndex === -1 || !currentViewingClassId) return;
            const updatedStudent = {
                ...currentClassStudents[editingStudentIndex],
                name: document.getElementById('editStuName').value,
                sbd: document.getElementById('editStuSBD').value,
                gender: document.getElementById('editStuGender').value,
                phoneStudent: document.getElementById('editStuPhone').value,
                phoneParent: document.getElementById('editStuParentPhone').value,
                email: document.getElementById('editStuEmail').value,
                username: document.getElementById('editStuUsername').value,
                password: document.getElementById('editStuPassword').value
            };
            if(!updatedStudent.name || !updatedStudent.username || !updatedStudent.password) { showNotification("Thi·∫øu th√¥ng tin!", "error"); return; }
            try {
                currentClassStudents[editingStudentIndex] = updatedStudent;
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, { students: currentClassStudents });
                showNotification("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
                renderStudentList(currentClassStudents);
                toggleModal('editStudentModal', false);
            } catch (e) { showNotification("L·ªói: " + e.message, "error"); }
        });

        // RE-IMPLEMENT HELPER FUNCTIONS
        window.downloadTemplate = () => {
            const data = [["H·ªç v√† t√™n", "T√™n ƒëƒÉng nh·∫≠p", "M·∫≠t kh·∫©u", "SBD", "Gi·ªõi t√≠nh", "SƒêT HS", "SƒêT PHHS"], ["Nguy·ªÖn VƒÉn A", "nguyenvana", "123456", "001", "Nam", "098...", "091..."]];
            const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DanhSach"); XLSX.writeFile(wb, "Mau_DS_Hoc_Sinh.xlsx");
        }
        
        window.handleFileUpload = (input) => { 
             const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                const studentsToAdd = [];
                for(let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if(row[0] && row[1]) {
                        studentsToAdd.push({ name: row[0], username: row[1], password: String(row[2] || '123456'), sbd: row[3]||'', gender: row[4]||'Nam', phoneStudent: row[5]||'', phoneParent: row[6]||'', createdAt: new Date().toISOString() });
                    }
                }
                if (studentsToAdd.length > 0 && currentViewingClassId) {
                    try {
                        const classRef = doc(db, "classes", currentViewingClassId);
                        const newFullList = [...currentClassStudents, ...studentsToAdd];
                        await updateDoc(classRef, { students: newFullList, studentCount: newFullList.length });
                        currentClassStudents = newFullList;
                        renderStudentList(newFullList);
                        showNotification(`ƒê√£ th√™m ${studentsToAdd.length} h·ªçc sinh!`, "success");
                    } catch(err) { showNotification("L·ªói: " + err.message, "error"); }
                }
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }
        
        window.switchTab = (tabName) => {
            const btnStudents = document.getElementById('tabBtnStudents'); const btnExams = document.getElementById('tabBtnExams');
            const contentStudents = document.getElementById('tabContentStudents'); const contentExams = document.getElementById('tabContentExams');
            if (tabName === 'students') { btnStudents.classList.add('active'); btnExams.classList.remove('active'); contentStudents.classList.remove('hidden'); contentExams.classList.add('hidden'); }
            else { btnStudents.classList.remove('active'); btnExams.classList.add('active'); contentStudents.classList.add('hidden'); contentExams.classList.remove('hidden'); }
        }
        
        window.refreshPassword = () => {
            const chars = "0123456789abcdefghijklmnopqrstuvwxyz"; let password = "";
            for (let i = 0; i < 6; i++) password += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('editStuPassword').value = password; document.getElementById('editStuPassword').type = "text"; 
        }

        // Logic c≈© Add Student (manual)
        document.getElementById('addStudentBtn').addEventListener('click', async () => {
            if (!currentViewingClassId) return;
            const name = document.getElementById('newStudentName').value;
            const user = document.getElementById('newStudentUser').value;
            const pass = document.getElementById('newStudentPass').value;
            if (!name || !user || !pass) { showNotification("Nh·∫≠p ƒë·ªß th√¥ng tin!", "error"); return; }
            const newStudent = { name, username: user, password: pass, createdAt: new Date().toISOString() };
            try {
                const classRef = doc(db, "classes", currentViewingClassId);
                await updateDoc(classRef, { students: arrayUnion(newStudent) });
                // Manual Sync
                currentClassStudents.push(newStudent);
                renderStudentList(currentClassStudents);
                await updateDoc(classRef, { studentCount: currentClassStudents.length });
                document.getElementById('newStudentName').value = ''; document.getElementById('newStudentUser').value = ''; document.getElementById('newStudentPass').value = '';
                showNotification("Th√™m th√†nh c√¥ng!", "success");
            } catch (e) { showNotification("L·ªói: " + e.message, "error"); }
        });

        document.getElementById('logoutBtn').onclick = async () => { if(await customConfirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) signOut(auth).then(()=>window.location.href='index.html'); }
        document.getElementById('saveProfileBtn').onclick = async () => {
            const name = document.getElementById('editDisplayName').value;
            await updateDoc(doc(db, "users", currentUserUid), { displayName: name });
            showNotification("ƒê√£ c·∫≠p nh·∫≠t profile");
            setTimeout(()=>location.reload(), 500);
        }

    </script>
</body>
</html>
