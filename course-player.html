<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Đang học - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: '#0F766E', primary: '#0F766E', accent: '#F97316' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #111827; } /* Nền tối cho chế độ rạp chiếu phim */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .lesson-item.active { background-color: #f0fdfa; color: #0f766e; font-weight: bold; border-left: 3px solid #0f766e; }
        .lesson-item:hover:not(.active) { background-color: #f9fafb; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-gray-50 overflow-hidden">

    <div class="h-16 bg-gray-900 text-white flex justify-between items-center px-4 flex-shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-4">
            <a href="student.html" class="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-gray-800">
                <i class="fa-solid fa-arrow-left text-xl"></i>
            </a>
            <div class="h-8 w-[1px] bg-gray-700"></div>
            <div>
                <h1 id="courseTitle" class="font-bold text-sm md:text-lg line-clamp-1">Đang tải khóa học...</h1>
                <div id="lessonTitle" class="text-xs text-gray-400">Vui lòng chọn bài học</div>
            </div>
        </div>
        
        <div class="hidden md:flex items-center gap-3 bg-gray-800 px-3 py-1.5 rounded-full border border-gray-700">
            <div class="text-xs font-bold text-gray-300">Tiến độ:</div>
            <div class="w-24 bg-gray-600 rounded-full h-1.5 overflow-hidden">
                <div class="bg-green-500 h-full rounded-full" style="width: 0%"></div>
            </div>
            <div class="text-xs font-bold text-green-400">0%</div>
        </div>
        
        <button onclick="toggleSidebar()" class="md:hidden text-white p-2">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>
    </div>

    <div class="flex-1 flex overflow-hidden relative">
        
        <aside id="playerSidebar" class="w-80 bg-white border-r border-gray-200 flex-col absolute md:relative z-10 h-full hidden md:flex transition-all shadow-xl md:shadow-none">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <span class="font-extrabold text-gray-700 uppercase text-xs">Nội dung khóa học</span>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="curriculumTree" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center py-10 text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i></div>
            </div>
        </aside>

        <main class="flex-1 bg-black flex flex-col items-center justify-center relative overflow-y-auto w-full">
            
            <div id="contentContainer" class="w-full h-full flex flex-col">
                <div id="emptyState" class="flex-1 flex flex-col items-center justify-center text-gray-500">
                    <i class="fa-regular fa-circle-play text-6xl mb-4 opacity-50"></i>
                    <p class="text-lg font-bold">Chọn một bài học để bắt đầu</p>
                </div>

                <iframe id="mainFrame" class="w-full flex-1 hidden bg-white" frameborder="0" allowfullscreen></iframe>

                <div id="quizContainer" class="hidden w-full h-full flex flex-col items-center justify-center bg-gray-900 text-white p-6 text-center">
                    <div class="w-24 h-24 bg-orange-600 rounded-full flex items-center justify-center mb-6 animate-pulse">
                        <i class="fa-solid fa-clipboard-question text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Bài tập trắc nghiệm</h2>
                    <p class="text-gray-400 mb-8 max-w-md">Bạn cần hoàn thành bài kiểm tra này để nắm vững kiến thức.</p>
                    <button id="btnStartQuiz" class="px-8 py-3 bg-brand text-white font-bold rounded-xl hover:bg-teal-600 transition-all shadow-lg hover:scale-105">
                        <i class="fa-solid fa-play mr-2"></i> Bắt đầu làm bài
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            // DÁN CONFIG CỦA BẠN VÀO ĐÂY
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Lấy Course ID từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        let courseData = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Lưu URL hiện tại để redirect lại sau khi login
                sessionStorage.setItem('redirect_after_login', window.location.href);
                window.location.href = 'index.html';
            } else {
                if(courseId) loadCourseContent(courseId);
                else { alert("Không tìm thấy khóa học!"); window.location.href = 'student.html'; }
            }
        });

        // 1. TẢI DỮ LIỆU KHÓA HỌC
        async function loadCourseContent(id) {
            try {
                const docSnap = await getDoc(doc(db, "public_courses", id));
                if (docSnap.exists()) {
                    courseData = docSnap.data();
                    document.getElementById('courseTitle').innerText = courseData.title;
                    renderSidebar(courseData.curriculum || []);
                } else {
                    alert("Khóa học không tồn tại hoặc đã bị xóa.");
                    window.location.href = 'student.html';
                }
            } catch (e) {
                console.error(e);
                alert("Lỗi tải khóa học: " + e.message);
            }
        }

        // 2. RENDER CÂY BÀI HỌC (3 CẤP)
        function renderSidebar(curriculum) {
            const tree = document.getElementById('curriculumTree');
            tree.innerHTML = '';

            if (curriculum.length === 0) {
                tree.innerHTML = '<div class="text-center text-sm text-gray-400 py-4">Chưa có nội dung.</div>';
                return;
            }

            curriculum.forEach((chap, cIdx) => {
                // Cấp 1: Chương
                const chapEl = document.createElement('div');
                chapEl.className = 'mb-2';
                chapEl.innerHTML = `
                    <div class="px-3 py-2 bg-gray-100 font-bold text-gray-700 text-sm rounded cursor-pointer hover:bg-gray-200" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        ${chap.title}
                    </div>
                    <div class="pl-2 mt-1 space-y-1"></div>
                `;
                const chapBody = chapEl.querySelector('div:last-child');

                // Cấp 2: Bài học
                (chap.lessons || []).forEach((les, lIdx) => {
                    const lesEl = document.createElement('div');
                    lesEl.innerHTML = `
                        <div class="px-3 py-1.5 text-sm font-semibold text-gray-600 flex items-center gap-2 cursor-pointer hover:text-brand" onclick="this.nextElementSibling.classList.toggle('hidden')">
                            <i class="fa-solid fa-caret-down text-xs"></i> ${les.title}
                        </div>
                        <div class="pl-3 border-l border-gray-200 ml-2 space-y-1"></div>
                    `;
                    const lesBody = lesEl.querySelector('div:last-child');

                    // Cấp 3: Mục nội dung (Video, PDF, Quiz)
                    (les.items || []).forEach((item, iIdx) => {
                        const itemEl = document.createElement('div');
                        const icon = item.type === 'pdf' ? 'fa-file-pdf' : (item.type === 'quiz' ? 'fa-clipboard-question' : 'fa-circle-play');
                        
                        itemEl.className = `lesson-item px-3 py-2 rounded-lg text-sm cursor-pointer flex items-center gap-3 transition-colors text-gray-600`;
                        itemEl.innerHTML = `<i class="fa-regular ${icon}"></i> <span class="truncate">${item.title}</span>`;
                        
                        // SỰ KIỆN CLICK BÀI HỌC
                        itemEl.onclick = () => {
                            // Highlight
                            document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
                            itemEl.classList.add('active');
                            
                            // Load Content
                            playContent(item);
                            
                            // Mobile: Đóng sidebar sau khi chọn
                            if(window.innerWidth < 768) toggleSidebar();
                        };
                        
                        lesBody.appendChild(itemEl);
                    });
                    
                    chapBody.appendChild(lesEl);
                });

                tree.appendChild(chapEl);
            });
        }

        // 3. XỬ LÝ HIỂN THỊ NỘI DUNG (PLAYER)
        function playContent(item) {
            document.getElementById('lessonTitle').innerText = item.title;
            document.getElementById('emptyState').classList.add('hidden');
            const iframe = document.getElementById('mainFrame');
            const quizContainer = document.getElementById('quizContainer');

            // Reset
            iframe.classList.add('hidden');
            quizContainer.classList.add('hidden');
            iframe.src = "";

            if (item.type === 'video') {
                iframe.classList.remove('hidden');
                // Xử lý link Youtube
                const m = item.content.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                if (m && m[2].length === 11) {
                    iframe.src = `https://www.youtube.com/embed/${m[2]}?autoplay=1&rel=0`;
                } else {
                    alert("Link video không hợp lệ");
                }
            } 
            else if (item.type === 'pdf') {
                iframe.classList.remove('hidden');
                let url = item.content;
                if(url.includes('drive.google.com')) {
                    url = url.replace('/view', '/preview').replace('/edit', '/preview');
                }
                iframe.src = url;
            }
            else if (item.type === 'quiz') {
                quizContainer.classList.remove('hidden');
                // Gắn link cho nút làm bài
                document.getElementById('btnStartQuiz').onclick = () => {
                    // Chuyển hướng sang exam.html với tham số returnUrl để quay lại đây sau khi làm xong
                    // mode=course để exam.html biết là đang làm trong khóa học
                    window.location.href = `exam.html?id=${item.examId}&mode=course&courseId=${courseId}`;
                };
            }
        }

        // UI Utils
        window.toggleSidebar = () => {
            const sb = document.getElementById('playerSidebar');
            sb.classList.toggle('hidden');
            sb.classList.toggle('absolute'); // Cho mobile đè lên
        };
    </script>
</body>
</html>
