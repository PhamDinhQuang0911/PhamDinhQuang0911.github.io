<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªçc tr·ª±c tuy·∫øn - Th·∫ßy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#0F766E', 
                        dark: '#111827', 
                        darker: '#030712',
                        accent: '#F97316' 
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* SIDEBAR TRANSITION */
        #sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s ease;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        .desktop-expanded { width: 22rem; } 
        .desktop-collapsed { width: 0 !important; border: none !important; }
        .mobile-show { transform: translateX(0); }
        .mobile-hide { transform: translateX(-100%); }

        /* Custom Styles */
        .lesson-item.active { 
            background-color: #F0FDFA; 
            border-left: 4px solid #0F766E;
            color: #0F766E;
        }
        .lesson-item.active .item-title { font-weight: 800; }
        .lesson-item:hover:not(.active) { background-color: #F8FAFC; }
        
        /* B√†i h·ªçc b·ªã kh√≥a */
        .lesson-item.locked { 
            opacity: 0.5; 
            cursor: not-allowed !important; 
            pointer-events: none;
            filter: grayscale(1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Toast Animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-darker h-screen flex text-gray-800 overflow-hidden">

    <div id="toastContainer" class="fixed top-5 right-5 z-[200] space-y-3"></div>

    <div id="resumePromptModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl animate-fade-in">
            <div class="w-20 h-20 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-circle-play text-4xl"></i>
            </div>
            <h3 class="text-2xl font-extrabold text-gray-900 mb-2">H·ªçc ti·∫øp th√¥i n√†o!</h3>
            <p class="text-gray-500 mb-8 text-sm leading-relaxed">H·ªá th·ªëng nh·∫≠n th·∫•y b·∫°n v·ª´a r·ªùi kh·ªèi trang h·ªçc t·∫≠p. H√£y t·∫≠p trung ƒë·ªÉ ho√†n th√†nh b√†i gi·∫£ng nh√©!</p>
            <button onclick="window.resumeLearning()" class="w-full py-4 bg-brand text-white font-bold rounded-xl hover:bg-teal-800 transition-all shadow-lg flex items-center justify-center gap-2">
                <span>Ti·∫øp t·ª•c h·ªçc ngay</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 flex flex-col h-full border-r border-gray-200 shadow-xl transform -translate-x-full transition-all duration-300 w-80 md:relative md:translate-x-0 desktop-expanded" style="background-color: #ffffff;">
        <div class="h-20 px-5 flex items-center justify-between border-b border-gray-100 bg-white shrink-0">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="w-10 h-10 bg-brand/10 rounded-xl flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-graduation-cap text-brand text-xl"></i>
                </div>
                <div class="flex flex-col overflow-hidden">
                    <span class="font-black text-xl text-brand tracking-tight truncate">Th·∫ßy Choang</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">H·ªá th·ªëng h·ªçc t·∫≠p</span>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-red-500 transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="p-5 border-b border-gray-100 bg-gray-50/50 shrink-0">
            <div class="flex justify-between items-end mb-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Ti·∫øn ƒë·ªô kh√≥a h·ªçc</span>
                <span class="text-brand font-black text-lg" id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div id="progressBar" class="bg-brand h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-xs font-bold text-gray-500 flex justify-between">
                <span>ƒê√£ ho√†n th√†nh: <span id="completedCount" class="text-gray-800">0</span> b√†i</span>
                <span id="totalCount" class="opacity-60">... b√†i</span>
            </div>
        </div>

        <div class="p-4 border-b border-gray-100 bg-white shrink-0">
            <button onclick="window.openLeaderboard()" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-black rounded-xl shadow-lg shadow-orange-200 flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-95 transition-all group">
                <i class="fa-solid fa-trophy text-lg group-hover:animate-bounce"></i>
                B·∫£ng V√†ng Th√†nh T√≠ch
            </button>
        </div>

        <div id="curriculumList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white">
            </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 text-center shrink-0">
            <a href="student.html" class="inline-flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-brand transition-colors">
                <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i Dashboard
            </a>
        </div>
    </aside>

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm hidden md:hidden"></div>

    <main class="flex-1 flex flex-col relative w-full h-full bg-darker transition-all min-w-0">
        <header class="h-16 bg-dark border-b border-gray-800 flex items-center justify-between px-4 md:px-6 shrink-0 z-30 shadow-lg">
            <div class="flex items-center gap-4 overflow-hidden">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition-colors">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="flex flex-col min-w-0 ml-2">
                    <h1 id="courseTitle" class="text-gray-200 font-bold text-sm md:text-base truncate max-w-[200px] md:max-w-md italic">ƒêang t·∫£i t√™n kh√≥a h·ªçc...</h1>
                    <span id="lessonTitle" class="text-xs text-brand font-bold truncate">Ch·ªçn b√†i h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btnPrev" class="w-9 h-9 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all">
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
                <button id="btnNext" class="w-9 h-9 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 relative w-full h-full flex flex-col">
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-darker z-10 transition-opacity">
                <div class="w-24 h-24 bg-gray-900 rounded-3xl flex items-center justify-center mb-6 shadow-2xl border border-gray-800">
                    <i class="fa-regular fa-circle-play text-5xl opacity-20"></i>
                </div>
                <p class="font-bold tracking-wide uppercase text-xs">Vui l√≤ng ch·ªçn b√†i h·ªçc t·ª´ danh s√°ch b√™n tr√°i</p>
            </div>

            <div id="videoPlayerContainer" class="hidden w-full h-full bg-black z-20 relative animate-fade-in">
                <div id="ytPlayer" class="w-full h-full"></div>
                
                <div id="videoTimerOverlay" class="absolute top-4 right-4 bg-black/80 text-white px-4 py-2 rounded-full text-xs font-bold backdrop-blur-md border border-white/10 flex items-center gap-3 z-30 shadow-2xl transition-opacity duration-500">
                    <div class="flex items-center gap-2 border-r border-white/20 pr-3">
                        <i class="fa-solid fa-clock text-orange-500 animate-pulse"></i>
                        <span class="text-gray-300 uppercase tracking-tighter">Y√™u c·∫ßu h·ªçc t·∫≠p</span>
                    </div>
                    <span id="timeRemaining" class="text-orange-400 text-sm font-mono tracking-widest min-w-[45px]">--:--</span>
                </div>

                <div id="videoCompletedOverlay" class="hidden absolute inset-0 bg-black/90 backdrop-blur-md flex flex-col items-center justify-center z-40 text-white animate-fade-in">
                    <div class="w-24 h-24 bg-brand rounded-full flex items-center justify-center mb-6 shadow-[0_0_50px_rgba(15,118,110,0.5)] animate-bounce">
                        <i class="fa-solid fa-check text-4xl"></i>
                    </div>
                    <h3 class="text-3xl font-black mb-2 tracking-tight">Tuy·ªát v·ªùi!</h3>
                    <p class="text-gray-400 font-bold mb-8 italic">B·∫°n ƒë√£ ho√†n th√†nh y√™u c·∫ßu t·ªëi thi·ªÉu c·ªßa b√†i h·ªçc n√†y</p>
                    <div class="flex gap-4">
                        <button onclick="document.getElementById('videoCompletedOverlay').classList.add('hidden')" class="px-8 py-3 bg-white/10 hover:bg-white/20 rounded-xl text-xs font-bold uppercase border border-white/10 transition-all">Xem l·∫°i</button>
                    </div>
                </div>
            </div>

            <iframe id="pdfFrame" class="w-full h-full hidden bg-white z-20 animate-fade-in" frameborder="0"></iframe>

            <div id="quizContainer" class="hidden w-full h-full flex flex-col items-center justify-center bg-darker text-white p-6 text-center z-20 animate-fade-in">
                <div class="w-32 h-32 bg-accent/20 rounded-full flex items-center justify-center mb-8 border-4 border-accent/30">
                    <i class="fa-solid fa-clipboard-question text-6xl text-accent"></i>
                </div>
                <h2 class="text-4xl font-black mb-4 tracking-tight uppercase">B√†i t·∫≠p tr·∫Øc nghi·ªám</h2>
                <p class="text-gray-400 mb-10 max-w-md font-bold italic">Luy·ªán t·∫≠p ngay ƒë·ªÉ c·ªßng c·ªë ki·∫øn th·ª©c v·ª´a h·ªçc. K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n v√†o b·∫£ng v√†ng.</p>
                <button id="btnStartQuiz" class="px-12 py-4 bg-brand text-white font-black rounded-2xl hover:bg-teal-600 transition-all shadow-[0_10px_30px_rgba(15,118,110,0.4)] hover:-translate-y-1 active:translate-y-0">
                    B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI NGAY
                </button>
            </div>
        </div>
    </main>

    <div id="leaderboardModal" class="fixed inset-0 z-[60] bg-darker/90 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-all duration-300">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-[0_20px_60px_rgba(0,0,0,0.5)] overflow-hidden flex flex-col max-h-[85vh] animate-fade-in">
            <div class="p-6 bg-gradient-to-r from-yellow-400 to-orange-500 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-crown text-2xl text-yellow-200"></i>
                    <h3 class="text-2xl font-black tracking-tight uppercase">B·∫£ng V√†ng</h3>
                </div>
                <button onclick="window.closeLeaderboard()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <div id="leaderboardList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                </div>

            <div class="p-5 bg-gray-50 border-t border-gray-100 flex items-center justify-between shrink-0">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Th·ª© h·∫°ng c·ªßa b·∫°n</div>
                <div id="myRank" class="text-brand font-black text-xl">--</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let courseData = null;
        let flatItems = [];
        let currentItemIndex = -1;
        let completedItems = new Set();
        let leaderboardCache = null;

        // Player & Timer State
        let player = null;
        let timerInterval = null;
        let watchedSeconds = 0;
        let requiredSeconds = 0;
        let isVideoCompleted = false;
        let lastPlaybackPosition = 0;

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        // --- H√ÄM TH√îNG B√ÅO (TOAST) ---
        window.showToast = (msg, type = 'success') => {
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'fixed top-5 right-5 z-[200] space-y-3';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            const borderColor = type === 'success' ? 'border-green-500' : (type === 'error' ? 'border-red-500' : 'border-blue-500');
            toast.className = `p-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] bg-white border-l-4 ${borderColor} animate-fade-in-up`;
            toast.innerHTML = `<div class="font-bold text-sm text-gray-800">${msg}</div>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        // --- YOUTUBE IFRAME API ---
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('ytPlayer', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'controls': 1,
                    'disablekb': 0
                },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        };

        // --- AUTH & LOAD DATA ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            if (!courseId) {
                window.location.href = 'student.html';
                return;
            }
            await loadCourse(courseId);
            await loadUserProgress();
        });

        async function loadCourse(id) {
            try {
                const snap = await getDoc(doc(db, "public_courses", id));
                if (snap.exists()) {
                    courseData = snap.data();
                    document.getElementById('courseTitle').innerText = courseData.title;
                    if (courseData.logo) {
                        const logoImg = document.getElementById('brandLogo');
                        logoImg.src = courseData.logo;
                        logoImg.classList.remove('hidden');
                    }
                    renderCurriculum(courseData.curriculum || []);
                }
            } catch (e) { console.error("L·ªói t·∫£i kh√≥a h·ªçc:", e); }
        }

        function renderCurriculum(list) {
            const container = document.getElementById('curriculumList');
            container.innerHTML = '';
            flatItems = [];

            list.forEach((chap, cIdx) => {
                const chapId = `chap_${cIdx}`;
                const chapEl = document.createElement('div');
                chapEl.className = "mb-2";
                chapEl.innerHTML = `
                    <div class="px-3 py-3 bg-gray-50 rounded-lg cursor-pointer mb-1 flex justify-between items-center group transition-all" onclick="window.toggleCollapse('${chapId}', this)">
                        <span class="font-extrabold text-sm truncate text-gray-700 group-hover:text-brand transition-colors flex items-center">
                            <i class="fa-solid fa-folder-open text-brand/50 mr-2"></i> ${chap.title}
                        </span>
                        <i class="fa-solid fa-chevron-right text-[10px] text-gray-400 rotate-90 transition-transform duration-300"></i>
                    </div>
                    <div id="${chapId}" class="pl-2 space-y-1 overflow-hidden transition-all"></div>
                `;

                const body = chapEl.querySelector(`#${chapId}`);
                (chap.lessons || []).forEach(les => {
                    (les.items || []).forEach(item => {
                        flatItems.push(item);
                        const idx = flatItems.length - 1;
                        const itemEl = document.createElement('div');
                        itemEl.className = `lesson-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer text-sm border-l-4 border-transparent transition-all`;
                        itemEl.dataset.index = idx;

                        let icon = '<i class="fa-solid fa-circle-play text-red-50 w-5"></i>';
                        if (item.type === 'pdf') icon = '<i class="fa-solid fa-file-pdf text-blue-50 w-5"></i>';
                        if (item.type === 'quiz') icon = '<i class="fa-solid fa-clipboard-question text-orange-50 w-5"></i>';

                        itemEl.innerHTML = `
                            <div class="shrink-0 w-6 flex justify-center">${icon}</div>
                            <span class="truncate flex-1 font-semibold text-gray-600">${item.title}</span>
                        `;
                        itemEl.onclick = () => window.playItem(idx);
                        body.appendChild(itemEl);
                    });
                });
                container.appendChild(chapEl);
            });
            updateStats();
        }

        // --- PLAYER LOGIC ---
        window.playItem = async (index) => {
            if (index < 0 || index >= flatItems.length) return;

            // Ch·∫∑n n·∫øu b√†i tr∆∞·ªõc ch∆∞a xong (Tr·ª´ b√†i ƒë·∫ßu ti√™n)
            if (index > 0 && !completedItems.has(index - 1)) {
                const itemBefore = flatItems[index-1];
                const minMin = parseInt(itemBefore.minWatchTime) || 10;
                window.showToast(`B·∫°n c·∫ßn xem xong b√†i tr∆∞·ªõc (t·ªëi thi·ªÉu ${minMin} ph√∫t) ƒë·ªÉ m·ªü kh√≥a!`, 'error');
                return;
            }

            currentItemIndex = index;
            const item = flatItems[index];

            // UI Active
            document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.lesson-item[data-index="${index}"]`);
            if (activeEl) activeEl.classList.add('active');

            document.getElementById('lessonTitle').innerText = item.title;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('videoPlayerContainer').classList.add('hidden');
            document.getElementById('pdfFrame').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');

            if (timerInterval) clearInterval(timerInterval);

            if (item.type === 'video') {
                document.getElementById('videoPlayerContainer').classList.remove('hidden');
                requiredSeconds = (parseInt(item.minWatchTime) || 10) * 60;
                isVideoCompleted = completedItems.has(index);

                // Kh√¥i ph·ª•c v·ªã tr√≠ xem d·ªü t·ª´ Firebase
                const progressRef = doc(db, "user_progress", `${auth.currentUser.uid}_${courseId}`);
                const pSnap = await getDoc(progressRef);
                lastPlaybackPosition = 0;
                watchedSeconds = isVideoCompleted ? requiredSeconds : 0;

                if (pSnap.exists()) {
                    const data = pSnap.data();
                    const posData = data.playbackPositions?.[`item_${item.id || index}`];
                    if (posData) {
                        lastPlaybackPosition = posData.position || 0;
                        if (!isVideoCompleted) watchedSeconds = posData.watchedSeconds || 0;
                    }
                }
                updateTimerUI();

                const videoId = item.content.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^&?]*)/)?.[1];
                if (player && player.loadVideoById) {
                    player.loadVideoById({
                        videoId: videoId,
                        startSeconds: isVideoCompleted ? 0 : lastPlaybackPosition
                    });
                }
            } else if (item.type === 'pdf') {
                document.getElementById('pdfFrame').classList.remove('hidden');
                document.getElementById('pdfFrame').src = item.content.replace(/\/view.*/, '/preview');
                if (!completedItems.has(index)) {
                    setTimeout(() => markAsCompleted(index), 10000); // 10s cho t√†i li·ªáu
                }
            } else if (item.type === 'quiz') {
                document.getElementById('quizContainer').classList.remove('hidden');
                const btnStart = document.getElementById('btnStartQuiz');
                btnStart.onclick = () => {
                    if (item.examId) {
                        window.location.href = `exam.html?id=${item.examId}&mode=practice&courseId=${courseId}`;
                    } else {
                        alert("Ch∆∞a c·∫•u h√¨nh ƒë·ªÅ thi cho b√†i t·∫≠p n√†y!");
                    }
                };
            }
            updateNavButtons();
        };

        function onPlayerStateChange(event) {
            // YT.PlayerState.PLAYING = 1
            if (event.data == YT.PlayerState.PLAYING) {
                timerInterval = setInterval(async () => {
                    try {
                        const currentTime = player.getCurrentTime();
                        if (!isVideoCompleted) {
                            watchedSeconds++;
                            updateTimerUI();
                            if (watchedSeconds >= requiredSeconds) {
                                clearInterval(timerInterval);
                                isVideoCompleted = true;
                                await markAsCompleted(currentItemIndex);
                                updateStats();
                                updateNavButtons();
                            }
                        }
                        // L∆∞u v·ªã tr√≠ xem m·ªói 5 gi√¢y
                        if (watchedSeconds % 5 === 0) {
                            savePlayback(currentTime, watchedSeconds);
                        }
                    } catch (e) { console.error("L·ªói timer video:", e); }
                }, 1000);
            } 
            // YT.PlayerState.ENDED = 0
            else if (event.data == YT.PlayerState.ENDED) {
                if (timerInterval) clearInterval(timerInterval);
                if (isVideoCompleted) {
                    if (currentItemIndex < flatItems.length - 1) {
                        window.showToast("T·ª± ƒë·ªông chuy·ªÉn sang b√†i m·ªõi...", "success");
                        setTimeout(() => window.playItem(currentItemIndex + 1), 2000);
                    } else {
                        window.showToast("Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh kh√≥a h·ªçc.", "success");
                        const overlay = document.getElementById('videoCompletedOverlay');
                        if(overlay) overlay.classList.remove('hidden');
                    }
                } else {
                    const remain = Math.ceil((requiredSeconds - watchedSeconds) / 60);
                    alert(`B·∫°n c·∫ßn xem th√™m √≠t nh·∫•t ${remain} ph√∫t n·ªØa ƒë·ªÉ ho√†n th√†nh b√†i h·ªçc n√†y.`);
                }
            } else {
                if (timerInterval) clearInterval(timerInterval);
            }
        }

        async function savePlayback(pos, watched) {
            const user = auth.currentUser;
            const item = flatItems[currentItemIndex];
            if (!user || !courseId || !item) return;
            const progressRef = doc(db, "user_progress", `${user.uid}_${courseId}`);
            try {
                await setDoc(progressRef, {
                    playbackPositions: {
                        [`item_${item.id || currentItemIndex}`]: {
                            position: pos,
                            watchedSeconds: watched,
                            lastActive: new Date().toISOString()
                        }
                    }
                }, { merge: true });
            } catch (e) { console.error("L·ªói l∆∞u v·ªã tr√≠ xem:", e); }
        }

        async function markAsCompleted(index) {
            if (completedItems.has(index)) return;
            completedItems.add(index);
            updateStats();

            // Hi·ªáu ·ª©ng ƒÉn m·ª´ng
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#0F766E', '#F97316', '#FFD700']
            });

            const user = auth.currentUser;
            if (!user || !courseId) return;

            const greetings = ["Tuy·ªát qu√°!", "Th·∫ßy t·ª± h√†o v·ªÅ b·∫°n!", "N·ªó l·ª±c tuy·ªát v·ªùi!", "Ti·∫øp t·ª•c ph√°t huy nh√©!"];
            window.showToast(`${greetings[Math.floor(Math.random() * greetings.length)]} +10 Qpoint!`, "success");

            try {
                // 1. C·ªông 10 Qpoint v√†o Profile User
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                let currentPoints = 0;
                if (userSnap.exists()) currentPoints = userSnap.data().qPoints || 0;
                await updateDoc(userRef, { qPoints: currentPoints + 10 });

                // 2. L∆∞u ti·∫øn ƒë·ªô b√†i h·ªçc
                const percent = Math.round((completedItems.size / flatItems.length) * 100);
                const progressRef = doc(db, "user_progress", `${user.uid}_${courseId}`);
                await setDoc(progressRef, {
                    uid: user.uid,
                    courseId: courseId,
                    completedItems: Array.from(completedItems),
                    progress: percent,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });

                // 3. ƒê·ªìng b·ªô v√†o ƒë∆°n h√†ng (orders) ƒë·ªÉ hi·ªÉn th·ªã Dashboard
                const qOrder = query(collection(db, "orders"), where("userId", "==", user.uid), where("courseId", "==", courseId));
                const snapOrder = await getDocs(qOrder);
                if (!snapOrder.empty) {
                    await updateDoc(doc(db, "orders", snapOrder.docs[0].id), { progress: percent });
                }
            } catch (e) { console.error("L·ªói l∆∞u ho√†n th√†nh:", e); }
        }

        function updateStats() {
            const total = flatItems.length;
            const completed = completedItems.size;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

            document.getElementById('totalCount').innerText = `${total} b√†i h·ªçc`;
            document.getElementById('completedCount').innerText = completed;
            document.getElementById('progressText').innerText = `${percent}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
            
            flatItems.forEach((_, idx) => {
                const itemEl = document.querySelector(`.lesson-item[data-index="${idx}"]`);
                if (itemEl) {
                    // Logic Locked: B√†i ti·∫øp theo ch·ªâ m·ªü khi b√†i tr∆∞·ªõc ƒë√£ xong
                    const isLocked = idx > 0 && !completedItems.has(idx - 1);
                    if (isLocked) {
                        itemEl.classList.add('locked');
                    } else {
                        itemEl.classList.remove('locked');
                    }

                    if (completedItems.has(idx)) {
                        itemEl.classList.add('text-brand');
                        if (!itemEl.querySelector('.fa-circle-check')) {
                            const check = document.createElement('i');
                            check.className = 'fa-solid fa-circle-check text-brand ml-auto text-xs animate-fade-in';
                            itemEl.appendChild(check);
                        }
                    }
                }
            });
        }

        async function loadUserProgress() {
            const user = auth.currentUser;
            if (!user || !courseId) return;
            try {
                const progressRef = doc(db, "user_progress", `${user.uid}_${courseId}`);
                const snap = await getDoc(progressRef);
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.completedItems) completedItems = new Set(data.completedItems);
                    updateStats();

                    // --- CH·∫æ ƒê·ªò R·∫¢NH TAY (AUTO RESUME) ---
                    if (flatItems.length > 0) {
                        let resumeIndex = 0;
                        // T√¨m b√†i ƒë·∫ßu ti√™n ch∆∞a xong
                        for (let i = 0; i < flatItems.length; i++) {
                            if (!completedItems.has(i)) {
                                resumeIndex = i;
                                break;
                            }
                        }
                        // N·∫øu ƒë√£ xong h·∫øt th√¨ v·ªÅ b√†i cu·ªëi
                        if (completedItems.size === flatItems.length) resumeIndex = flatItems.length - 1;

                        window.showToast("ƒêang kh√¥i ph·ª•c b√†i h·ªçc d·ªü c·ªßa b·∫°n...", "info");
                        setTimeout(() => window.playItem(resumeIndex), 1200);
                    }
                } else if (flatItems.length > 0) {
                    // M·ªõi h·ªçc l·∫ßn ƒë·∫ßu
                    window.playItem(0);
                }
            } catch (e) { console.error("L·ªói t·∫£i ti·∫øn ƒë·ªô:", e); }
        }

        // --- ANTI-CHEAT (TAB VISIBILITY) ---
        window.resumeLearning = () => {
            document.getElementById('resumePromptModal').classList.add('hidden');
            if (player && player.playVideo) player.playVideo();
        };

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                if (player && player.pauseVideo) player.pauseVideo();
            } else {
                // Ch·ªâ hi·ªán modal n·∫øu b√†i ƒëang l√† Video v√† ch∆∞a ho√†n th√†nh
                const item = flatItems[currentItemIndex];
                if (item && item.type === 'video' && !isVideoCompleted && currentItemIndex !== -1) {
                    document.getElementById('resumePromptModal').classList.remove('hidden');
                }
            }
        });

        // Ch·ªëng gian l·∫≠n khi m·∫•t ti√™u ƒëi·ªÉm c·ª≠a s·ªï
        window.addEventListener("blur", () => {
            if (player && player.pauseVideo && !isVideoCompleted) player.pauseVideo();
        });

        // --- UI HELPERS ---
        function updateTimerUI() {
            const overlay = document.getElementById('videoTimerOverlay');
            if (isVideoCompleted) {
                overlay.classList.add('opacity-0', 'pointer-events-none');
                return;
            }
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            const remain = Math.max(0, requiredSeconds - watchedSeconds);
            const m = Math.floor(remain / 60);
            const s = remain % 60;
            document.getElementById('timeRemaining').innerText = `${m}:${s < 10 ? '0' + s : s}`;
        }

        function updateNavButtons() {
            document.getElementById('btnPrev').disabled = currentItemIndex <= 0;
            const btnNext = document.getElementById('btnNext');
            const isCurrentDone = completedItems.has(currentItemIndex);
            btnNext.disabled = currentItemIndex >= flatItems.length - 1 || !isCurrentDone;
            
            document.getElementById('btnPrev').onclick = () => window.playItem(currentItemIndex - 1);
            document.getElementById('btnNext').onclick = () => window.playItem(currentItemIndex + 1);
        }

        window.toggleCollapse = (id, el) => {
            const body = document.getElementById(id);
            const icon = el.querySelector('.fa-chevron-right');
            body.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        };

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (window.innerWidth < 768) {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            } else {
                sidebar.classList.toggle('desktop-collapsed');
            }
        };

        // --- LEADERBOARD LOGIC ---
        window.openLeaderboard = async () => {
            document.getElementById('leaderboardModal').classList.remove('hidden');
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<div class="flex flex-col items-center py-10"><i class="fa-solid fa-spinner fa-spin text-brand text-2xl mb-2"></i><span class="text-xs font-bold text-gray-400">ƒêang t·∫£i b·∫£ng v√†ng...</span></div>';

            try {
                // L·∫•y Top 20 h·ªçc sinh c√≥ ƒëi·ªÉm cao nh·∫•t
                const q = query(collection(db, "users"), orderBy("qPoints", "desc"), limit(20));
                const snap = await getDocs(q);
                let ranking = [];
                snap.forEach(doc => ranking.push({ id: doc.id, ...doc.data() }));
                renderLeaderboard(ranking);
            } catch (e) { console.error("L·ªói t·∫£i x·∫øp h·∫°ng:", e); }
        };

        window.closeLeaderboard = () => {
            document.getElementById('leaderboardModal').classList.add('hidden');
        };

        function renderLeaderboard(ranking) {
            const list = document.getElementById('leaderboardList');
            const myRankEl = document.getElementById('myRank');
            const myUid = auth.currentUser?.uid;
            
            if (ranking.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400 font-bold">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng</div>';
                return;
            }
            
            let html = '';
            let myRank = 'N/A';
            ranking.forEach((u, i) => {
                const rank = i + 1;
                if (u.id === myUid) myRank = `#${rank}`;
                
                let badge = `<span class="w-6 h-6 flex items-center justify-center text-[10px] font-black bg-gray-100 text-gray-400 rounded-full">${rank}</span>`;
                if (rank === 1) badge = '<div class="text-xl">ü•á</div>';
                if (rank === 2) badge = '<div class="text-xl">ü•à</div>';
                if (rank === 3) badge = '<div class="text-xl">ü•â</div>';
                
                html += `
                    <div class="flex items-center gap-4 p-3.5 rounded-2xl border ${u.id === myUid ? 'border-brand bg-teal-50 ring-2 ring-brand/10' : 'border-gray-100 bg-white'} transition-all hover:border-gray-200">
                        <div class="w-8 flex justify-center shrink-0">${badge}</div>
                        <div class="w-10 h-10 rounded-full bg-gray-200 border-2 border-white shadow-sm overflow-hidden shrink-0">
                            <img src="${u.avatar || 'https://via.placeholder.com/40'}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm text-gray-800 truncate">${u.name || 'H·ªçc sinh ·∫©n danh'}</div>
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">H·ªçc vi√™n xu·∫•t s·∫Øc</div>
                        </div>
                        <div class="text-right">
                            <div class="text-brand font-black text-base">${u.qPoints || 0}</div>
                            <div class="text-[8px] font-black text-gray-400 uppercase">QPoints</div>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            myRankEl.innerText = myRank;
        }
    </script>
</body>
</html>
