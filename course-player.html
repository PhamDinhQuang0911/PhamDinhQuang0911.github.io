<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Học trực tuyến - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#0F766E', 
                        dark: '#111827', 
                        darker: '#030712',
                        accent: '#F97316' 
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar đẹp hơn */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* ACTIVE ITEM STYLE: Đậm hơn, rõ ràng hơn */
        .lesson-item.active { 
            background-color: #F0FDFA; 
            border-left: 4px solid #0F766E;
            color: #0F766E;
        }
        .lesson-item.active .item-title { font-weight: 800; }
        .lesson-item:hover:not(.active) { background-color: #F8FAFC; }

        /* SIDEBAR TRANSITION: Xử lý lỗi vỡ giao diện khi thu gọn */
        #sidebar {
            transition: width 0.3s ease, transform 0.3s ease;
            flex-shrink: 0; /* Không bị co méo */
            overflow: hidden; /* Ẩn nội dung khi thu gọn */
            white-space: nowrap; /* Chữ không xuống dòng khi thu gọn */
        }
        
        /* Desktop States */
        .desktop-expanded { width: 20rem; } /* 320px */
        .desktop-collapsed { width: 0; border: none; } /* Thu gọn về 0 để thành Cinema Mode */

        /* Mobile States */
        .mobile-show { transform: translateX(0); }
        .mobile-hide { transform: translateX(-100%); }

        /* Icon Types */
        .icon-video { color: #EF4444; } /* Red */
        .icon-pdf { color: #3B82F6; } /* Blue */
        .icon-quiz { color: #F97316; } /* Orange */
        
        /* Hiệu ứng xoay mũi tên */
        .rotate-90-down { transform: rotate(90deg); }
    </style>
</head>
<body class="bg-darker h-screen flex text-gray-800 overflow-hidden">

    <aside id="sidebar" class="desktop-expanded fixed inset-y-0 left-0 z-50 bg-white border-r border-gray-200 flex flex-col md:relative mobile-hide">
        
        <div class="h-16 px-5 flex items-center justify-between border-b border-gray-100 bg-white shrink-0">
            <div class="flex items-center gap-3 overflow-hidden">
                <img id="brandLogo" src="" class="h-8 object-contain hidden"> 
                <span id="brandText" class="font-black text-xl text-brand tracking-tight truncate">Thầy Choang</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="p-5 border-b border-gray-100 bg-gray-50/50 shrink-0">
            <div class="flex justify-between items-end mb-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Tiến độ hoàn thành</span>
                <span class="text-brand font-black text-lg" id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div id="progressBar" class="bg-brand h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-xs font-bold text-gray-500 flex justify-between">
                <span>Đã học: <span id="completedCount" class="text-gray-800">0</span> bài</span>
                <span id="totalCount">0 bài</span>
            </div>
        </div>

        <div id="curriculumList" class="flex-1 overflow-y-auto p-2 space-y-1">
            <div class="p-4 text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-teal-500 mb-2"></i>
                <p class="text-xs text-gray-400">Đang tải nội dung...</p>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 text-center shrink-0">
            <a href="student.html" class="inline-flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-brand transition-colors">
                <i class="fa-solid fa-arrow-left"></i> Quay lại Dashboard
            </a>
        </div>
    </aside>

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm hidden md:hidden transition-opacity"></div>

    <main class="flex-1 flex flex-col relative w-full h-full bg-darker transition-all min-w-0">
        
        <header class="h-16 bg-dark border-b border-gray-800 flex items-center justify-between px-4 md:px-6 shrink-0 z-30 shadow-lg">
            <div class="flex items-center gap-4 overflow-hidden">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition-colors" title="Đóng/Mở Danh sách">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="w-[1px] h-6 bg-gray-700 hidden md:block"></div>
                <div class="flex flex-col min-w-0">
                    <h1 id="courseTitle" class="text-gray-200 font-bold text-sm md:text-base truncate max-w-[200px] md:max-w-md">...</h1>
                    <span id="lessonTitle" class="text-xs text-brand font-bold truncate">Chọn bài học</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btnPrev" class="w-9 h-9 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all" title="Bài trước">
                    <i class="fa-solid fa-chevron-left text-xs"></i>
                </button>
                <button id="btnNext" class="w-9 h-9 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all" title="Bài tiếp theo">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 relative w-full h-full flex flex-col">
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 bg-darker z-10">
                <div class="w-20 h-20 rounded-full bg-gray-800 flex items-center justify-center mb-6 animate-pulse">
                    <i class="fa-solid fa-play text-3xl text-gray-500 pl-1"></i>
                </div>
                <p class="font-bold text-gray-400 text-lg">Chọn một bài học để bắt đầu</p>
                <p class="text-sm text-gray-600 mt-2">Nội dung sẽ hiển thị tại đây</p>
            </div>

            <iframe id="mainFrame" class="w-full h-full hidden bg-black z-20" frameborder="0" allowfullscreen></iframe>

            <div id="quizContainer" class="hidden w-full h-full flex flex-col items-center justify-center bg-darker text-white p-6 text-center z-20">
                <div class="relative mb-8">
                    <div class="absolute inset-0 bg-accent/20 blur-2xl rounded-full"></div>
                    <i class="fa-solid fa-clipboard-question text-7xl text-accent relative z-10 animate-bounce"></i>
                </div>
                <h2 class="text-3xl font-black mb-3">Bài tập trắc nghiệm</h2>
                <p class="text-gray-400 mb-8 max-w-md text-sm leading-relaxed">Hãy hoàn thành bài kiểm tra này để củng cố kiến thức.<br>Điểm số sẽ được lưu vào lịch sử học tập của bạn.</p>
                <button id="btnStartQuiz" class="px-10 py-4 bg-gradient-to-r from-brand to-teal-600 text-white font-bold rounded-2xl hover:shadow-lg hover:shadow-brand/30 hover:-translate-y-1 transition-all flex items-center gap-3">
                    <i class="fa-solid fa-play"></i> BẮT ĐẦU LÀM BÀI
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let courseData = null;
        let flatItems = []; // Danh sách phẳng để Next/Prev
        let currentItemIndex = -1;
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        // Init
        onAuthStateChanged(auth, (user) => {
            if(!user) {
                sessionStorage.setItem('redirect_after_login', window.location.href);
                window.location.href = 'index.html';
            } else if(courseId) {
                loadLogo(); // Load logo từ DB
                loadCourse(courseId);
            } else {
                window.location.href = 'student.html';
            }
        });

        // 1. Load Logo (MỚI)
        async function loadLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    const logoUrl = docSnap.data().logo;
                    const imgEl = document.getElementById('brandLogo');
                    imgEl.src = logoUrl;
                    imgEl.classList.remove('hidden');
                    document.getElementById('brandText').classList.add('hidden'); // Ẩn chữ nếu có logo ảnh
                }
            } catch(e) { console.log("Không tải được logo"); }
        }

        // 2. Load Course Data
        async function loadCourse(id) {
            try {
                const snap = await getDoc(doc(db, "public_courses", id));
                if(snap.exists()){
                    courseData = snap.data();
                    document.getElementById('courseTitle').innerText = courseData.title;
                    renderCurriculum(courseData.curriculum || []);
                    updateStats();
                } else {
                    alert("Khóa học không tồn tại!"); window.location.href='student.html';
                }
            } catch(e) { console.error(e); }
        }

        // 3. Render Curriculum (GIAO DIỆN MỚI)
        function renderCurriculum(list) {
            const container = document.getElementById('curriculumList');
            container.innerHTML = '';
            flatItems = []; 

            if(!list || list.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Chưa có nội dung.</div>';
                return;
            }

            list.forEach((chap, cIdx) => {
                // CHAPTER HEADER (Có thể thu gọn)
                const chapId = `chap_${cIdx}`;
                const chapEl = document.createElement('div');
                chapEl.className = 'mb-1';
                // Mặc định mở chương đầu tiên (cIdx === 0)
                const isOpen = cIdx === 0;
                
                chapEl.innerHTML = `
                    <div class="flex items-center justify-between px-3 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors group select-none" onclick="toggleCollapse('${chapId}', this)">
                        <div class="font-bold text-gray-700 text-sm flex-1 truncate pr-2">${chap.title}</div>
                        <i class="fa-solid fa-chevron-right text-xs text-gray-400 transition-transform duration-300 ${isOpen ? 'rotate-90' : ''}"></i>
                    </div>
                    <div id="${chapId}" class="mt-1 space-y-1 ${isOpen ? '' : 'hidden'} overflow-hidden transition-all"></div>
                `;
                
                const chapBody = chapEl.querySelector(`#${chapId}`);

                // LESSONS & ITEMS
                (chap.lessons || []).forEach((les) => {
                    // Tên bài học (Nhỏ, màu xám)
                    if(les.title) {
                        const lesTitle = document.createElement('div');
                        lesTitle.className = 'px-4 py-1 mt-2 text-[10px] font-black text-gray-400 uppercase tracking-wider truncate';
                        lesTitle.innerText = les.title;
                        chapBody.appendChild(lesTitle);
                    }

                    (les.items || []).forEach((item) => {
                        flatItems.push(item);
                        const currentIndex = flatItems.length - 1;

                        // Xác định Icon và Màu sắc
                        let iconClass = 'fa-circle-play icon-video';
                        let typeLabel = 'Video';
                        if(item.type === 'pdf') { iconClass = 'fa-file-pdf icon-pdf'; typeLabel = 'Tài liệu'; }
                        if(item.type === 'quiz') { iconClass = 'fa-clipboard-question icon-quiz'; typeLabel = 'Bài tập'; }

                        const itemEl = document.createElement('div');
                        itemEl.className = `lesson-item flex items-center gap-3 px-3 py-3 rounded-lg cursor-pointer text-sm text-gray-600 transition-all border-l-4 border-transparent ml-2`;
                        itemEl.dataset.index = currentIndex;
                        itemEl.innerHTML = `
                            <div class="w-6 h-6 rounded-full bg-white border border-gray-100 flex items-center justify-center shadow-sm shrink-0">
                                <i class="fa-solid ${iconClass} text-xs"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="item-title truncate text-xs md:text-sm font-semibold">${item.title}</div>
                                <div class="text-[10px] text-gray-400 font-medium">${typeLabel}</div>
                            </div>
                        `;
                        
                        itemEl.onclick = () => playItem(currentIndex);
                        chapBody.appendChild(itemEl);
                    });
                });

                container.appendChild(chapEl);
            });
        }

        // 4. Play Content
        window.playItem = (index) => {
            if(index < 0 || index >= flatItems.length) return;
            currentItemIndex = index;
            const item = flatItems[index];

            // Highlight Active
            document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.lesson-item[data-index="${index}"]`);
            if(activeEl) {
                activeEl.classList.add('active');
                activeEl.scrollIntoView({behavior: 'smooth', block: 'center'});
            }

            // Update Header
            document.getElementById('lessonTitle').innerText = item.title;

            // Show Content Area
            document.getElementById('emptyState').classList.add('hidden');
            const frame = document.getElementById('mainFrame');
            const quiz = document.getElementById('quizContainer');
            
            frame.classList.add('hidden'); 
            quiz.classList.add('hidden');
            frame.src = "";

            if(item.type === 'video') {
                frame.classList.remove('hidden');
                let url = item.content;
                if(url && url.includes('youtu')) {
                    const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^&?]*)/);
                    if(m && m[1]) url = `https://www.youtube.com/embed/${m[1]}?autoplay=1&rel=0&modestbranding=1`;
                }
                frame.src = url;
            } 
            else if(item.type === 'pdf') {
                frame.classList.remove('hidden');
                let url = item.content;
                if(url && url.includes('drive.google.com')) {
                    url = url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview');
                }
                frame.src = url;
            } 
            else if(item.type === 'quiz') {
                quiz.classList.remove('hidden');
                document.getElementById('btnStartQuiz').onclick = () => {
                    if(item.examId) window.location.href = `exam.html?id=${item.examId}&mode=course&courseId=${courseId}`;
                    else alert("Bài tập chưa được liên kết!");
                };
            }

            updateNavButtons();
            
            // Mobile: Auto close sidebar
            if(window.innerWidth < 768) {
                const sb = document.getElementById('sidebar');
                if(!sb.classList.contains('mobile-hide')) toggleSidebar();
            }
        };

        // 5. Helpers
        function updateNavButtons() {
            document.getElementById('btnPrev').disabled = currentItemIndex <= 0;
            document.getElementById('btnNext').disabled = currentItemIndex >= flatItems.length - 1;
            
            document.getElementById('btnPrev').onclick = () => window.playItem(currentItemIndex - 1);
            document.getElementById('btnNext').onclick = () => window.playItem(currentItemIndex + 1);
        }

        function updateStats() {
            const total = flatItems.length;
            document.getElementById('totalCount').innerText = `${total} bài`;
            // Cần logic lưu tiến độ để update completedCount
        }

        // Global UI Functions
        window.toggleCollapse = (id, headerEl) => {
            const body = document.getElementById(id);
            const icon = headerEl.querySelector('.fa-chevron-right');
            body.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        };

        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (window.innerWidth >= 768) {
                // Desktop: Width Transition
                sb.classList.toggle('desktop-expanded');
                sb.classList.toggle('desktop-collapsed');
            } else {
                // Mobile: Transform Transition
                sb.classList.toggle('mobile-hide');
                sb.classList.toggle('mobile-show');
                overlay.classList.toggle('hidden');
            }
        };
    </script>
</body>
</html>
