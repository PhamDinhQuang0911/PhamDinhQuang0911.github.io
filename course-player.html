<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Học trực tuyến - Thầy Choang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#0F766E', 
                        dark: '#111827', 
                        darker: '#030712',
                        accent: '#F97316' 
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* SIDEBAR TRANSITION & WIDTH CONTROL */
        #sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s ease;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        
        /* Desktop: Class mở rộng - Độ rộng cố định */
        .desktop-expanded { width: 22rem; } 
        
        /* Desktop: Class thu gọn - Về 0 */
        .desktop-collapsed { width: 0 !important; border: none !important; }

        /* Mobile States */
        .mobile-show { transform: translateX(0); }
        .mobile-hide { transform: translateX(-100%); }

        /* Active Item */
        .lesson-item.active { 
            background-color: #F0FDFA; 
            border-left: 4px solid #0F766E;
            color: #0F766E;
        }
        .lesson-item.active .item-title { font-weight: 800; }
        .lesson-item:hover:not(.active) { background-color: #F8FAFC; }
    </style>
</head>
<body class="bg-darker h-screen flex text-gray-800 overflow-hidden">

    <aside id="sidebar" 
           class="fixed inset-y-0 left-0 z-50 flex flex-col h-full border-r border-gray-200 shadow-xl 
                  transform -translate-x-full transition-all duration-300 w-80
                  md:relative md:translate-x-0 desktop-expanded"
           style="background-color: #ffffff;">
        
        <div class="h-20 px-5 flex items-center justify-between border-b border-gray-100 bg-white shrink-0">
            <div class="flex items-center gap-3 overflow-hidden">
                <img id="brandLogo" src="https://via.placeholder.com/50" class="h-10 w-auto object-contain hidden"> 
                <span id="brandText" class="font-black text-xl text-brand tracking-tight truncate">Thầy Choang</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="p-5 border-b border-gray-100 bg-gray-50/50 shrink-0">
            <div class="flex justify-between items-end mb-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Tiến độ khóa học</span>
                <span class="text-brand font-black text-lg" id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div id="progressBar" class="bg-brand h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-xs font-bold text-gray-500 flex justify-between">
                <span>Đã học: <span id="completedCount" class="text-gray-800">0</span> bài</span>
                <span id="totalCount">...</span>
            </div>
        </div>

        <div class="p-4 border-b border-gray-100 bg-white shrink-0">
            <button onclick="window.openLeaderboard()" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-black rounded-xl shadow-lg shadow-orange-200 flex items-center justify-center gap-2 hover:scale-105 transition-transform group">
                <i class="fa-solid fa-trophy text-lg group-hover:animate-bounce"></i> Bảng Vàng Thành Tích
            </button>
        </div>

        <div id="curriculumList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white">
            <div class="p-4 space-y-4 animate-pulse">
                <div class="h-6 bg-gray-100 rounded w-3/4"></div>
                <div class="space-y-2 pl-4">
                    <div class="h-10 bg-gray-50 rounded"></div>
                    <div class="h-10 bg-gray-50 rounded"></div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 text-center shrink-0">
            <a href="student.html" class="inline-flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-brand transition-colors">
                <i class="fa-solid fa-arrow-left"></i> Quay lại Dashboard
            </a>
        </div>
    </aside>

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm hidden transition-opacity md:hidden"></div>

    <main class="flex-1 flex flex-col relative w-full h-full bg-darker transition-all min-w-0">
        
        <header class="h-16 bg-dark border-b border-gray-800 flex items-center justify-between px-4 md:px-6 shrink-0 z-30 shadow-lg">
            <div class="flex items-center gap-4 overflow-hidden">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800 transition-colors" title="Đóng/Mở Sidebar">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="w-[1px] h-6 bg-gray-700 hidden md:block"></div>
                <div class="flex flex-col min-w-0">
                    <h1 id="courseTitle" class="text-gray-200 font-bold text-sm md:text-base truncate max-w-[200px] md:max-w-md">Đang tải dữ liệu...</h1>
                    <span id="lessonTitle" class="text-xs text-brand font-bold truncate">...</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btnPrev" class="w-9 h-9 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                <button id="btnNext" class="w-9 h-9 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center hover:bg-gray-700 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all"><i class="fa-solid fa-chevron-right text-xs"></i></button>
            </div>
        </header>

        <div class="flex-1 relative w-full h-full flex flex-col">
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-darker z-10">
                <i class="fa-regular fa-circle-play text-5xl mb-4 opacity-50"></i>
                <p class="font-bold">Chọn bài học để bắt đầu</p>
            </div>

            <iframe id="mainFrame" class="w-full h-full hidden bg-black z-20" frameborder="0" allowfullscreen></iframe>

            <div id="quizContainer" class="hidden w-full h-full flex flex-col items-center justify-center bg-darker text-white p-6 text-center z-20">
                <div class="relative mb-8">
                    <div class="absolute inset-0 bg-accent/20 blur-2xl rounded-full"></div>
                    <i class="fa-solid fa-clipboard-question text-7xl text-accent relative z-10 animate-bounce"></i>
                </div>
                <h2 class="text-3xl font-black mb-3">Bài tập trắc nghiệm</h2>
                <button id="btnStartQuiz" class="px-8 py-3 bg-brand text-white font-bold rounded-xl hover:bg-teal-600 transition-all shadow-lg">Làm bài ngay</button>
            </div>
        </div>
    </main>
    <div id="leaderboardModal" class="fixed inset-0 z-[60] bg-darker/80 backdrop-blur-sm hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 flex flex-col max-h-[85vh]">
            <div class="p-5 bg-gradient-to-r from-yellow-400 to-orange-500 flex justify-between items-center shrink-0 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
                <h3 class="text-xl font-black text-white flex items-center gap-2 relative z-10"><i class="fa-solid fa-crown text-yellow-200"></i> Bảng Xếp Hạng</h3>
                <button onclick="window.closeLeaderboard()" class="w-8 h-8 bg-white/20 hover:bg-white/40 rounded-full flex items-center justify-center text-white transition-colors relative z-10"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-2 bg-orange-50 flex justify-center border-b border-orange-100 shrink-0">
                <span class="text-[10px] font-bold text-orange-600 uppercase tracking-wide"><i class="fa-solid fa-star mr-1"></i> Xếp hạng theo tổng điểm bài tập</span>
            </div>
            <div id="leaderboardList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white custom-scrollbar">
                <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                    <i class="fa-solid fa-spinner fa-spin text-3xl mb-2 text-brand"></i>
                    <p class="text-xs font-bold">Đang tổng hợp điểm số...</p>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 text-center shrink-0">
                <div class="flex items-center justify-center gap-2 text-xs font-bold text-gray-500">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    Hạng của bạn: <span id="myRank" class="text-brand text-sm">--</span>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CẤU HÌNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCqAX3x1MbJ3do7m3EaH9JA4kFuVhlAc78",
            authDomain: "lms-thitracnghiem.firebaseapp.com",
            projectId: "lms-thitracnghiem",
            storageBucket: "lms-thitracnghiem.firebasestorage.app",
            messagingSenderId: "760187217240",
            appId: "1:760187217240:web:d043cd5808c349f87a712d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LOGIC BẢNG XẾP HẠNG ---
        let leaderboardCache = null; // Cache để không phải load lại liên tục

        window.openLeaderboard = async () => {
            const modal = document.getElementById('leaderboardModal');
            const container = modal.querySelector('div');
            const listEl = document.getElementById('leaderboardList');
            
            modal.classList.remove('hidden');
            // Animation vào
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                container.classList.remove('scale-95');
            }, 10);

            if (leaderboardCache) {
                renderLeaderboard(leaderboardCache);
            } else {
                await loadLeaderboardData();
            }
        };

        window.closeLeaderboard = () => {
            const modal = document.getElementById('leaderboardModal');
            const container = modal.querySelector('div');
            
            modal.classList.add('opacity-0');
            container.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        async function loadLeaderboardData() {
            if (!courseData || !courseData.curriculum) return;

            // 1. Lấy danh sách tất cả Exam ID trong khóa học này
            const examIds = [];
            courseData.curriculum.forEach(chap => {
                if(chap.lessons) {
                    chap.lessons.forEach(les => {
                        if(les.items) {
                            les.items.forEach(item => {
                                if(item.type === 'quiz' && item.examId) {
                                    examIds.push(item.examId);
                                }
                            });
                        }
                    });
                }
            });

            if (examIds.length === 0) {
                renderLeaderboard([]);
                return;
            }

            try {
                // 2. Tải kết quả làm bài. 
                // Lưu ý: Firestore không hỗ trợ query 'in' quá 10 phần tử. 
                // Ở đây ta sẽ query tất cả results và lọc client-side (với quy mô nhỏ) 
                // hoặc query theo từng cụm nếu quy mô lớn. 
                // Giải pháp đơn giản: Lấy kết quả của user hiện tại để hiện rank mình trước, 
                // còn bảng xếp hạng chung cần Backend hỗ trợ tốt hơn. 
                // Tuy nhiên, để demo "đẹp mắt", ta sẽ giả lập query collection "results" (cần permission read all).
                
                // Cách tối ưu thực tế: Tạo 1 collection 'course_progress' lưu tổng điểm.
                // Ở đây mình sẽ query thủ công kết quả.
                
                const q = query(collection(db, "results")); // Cần Security Rules cho phép read
                const snap = await getDocs(q);
                
                const userScores = {}; // { uid: { name, avatar, totalScore } }

                snap.forEach(doc => {
                    const data = doc.data();
                    // Chỉ tính điểm các bài thi nằm trong khóa học này
                    if (examIds.includes(data.examId)) {
                        if (!userScores[data.studentId]) {
                            userScores[data.studentId] = { 
                                name: data.studentName || "Ẩn danh", 
                                avatar: `https://ui-avatars.com/api/?name=${data.studentName || 'U'}&background=random`,
                                score: 0 
                            };
                        }
                        // Cộng điểm (giả sử mỗi bài lấy điểm cao nhất nếu có nhiều lần thi - cần logic lọc)
                        // Ở đây cộng dồn đơn giản để demo
                        if (data.score) userScores[data.studentId].score += parseFloat(data.score);
                    }
                });

                // Chuyển về mảng và sắp xếp
                const ranking = Object.entries(userScores).map(([uid, info]) => ({
                    uid, ...info
                })).sort((a, b) => b.score - a.score);

                leaderboardCache = ranking;
                renderLeaderboard(ranking);

            } catch (e) {
                console.error("Lỗi tải BXH:", e);
                document.getElementById('leaderboardList').innerHTML = `<div class="text-center text-red-500 py-4 text-sm">Không thể tải dữ liệu xếp hạng.</div>`;
            }
        }

        function renderLeaderboard(ranking) {
            const listEl = document.getElementById('leaderboardList');
            const myRankEl = document.getElementById('myRank');
            const currentUserUid = auth.currentUser ? auth.currentUser.uid : null;

            if (ranking.length === 0) {
                listEl.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-400 opacity-60"><i class="fa-solid fa-trophy text-4xl mb-2"></i><p class="text-sm">Chưa có dữ liệu xếp hạng</p></div>`;
                myRankEl.innerText = "--";
                return;
            }

            let html = '';
            let myRank = "--";

            ranking.forEach((user, index) => {
                const rank = index + 1;
                const isMe = user.uid === currentUserUid;
                if (isMe) myRank = `#${rank}`;

                // Style cho Top 3
                let rankBadge = `<span class="w-6 h-6 flex items-center justify-center text-xs font-bold text-gray-500 bg-gray-100 rounded-full">${rank}</span>`;
                let rowClass = "bg-white border-gray-100";
                
                if (rank === 1) {
                    rankBadge = `<i class="fa-solid fa-crown text-yellow-500 text-xl animate-bounce"></i>`;
                    rowClass = "bg-yellow-50 border-yellow-200 shadow-sm transform scale-[1.02]";
                } else if (rank === 2) {
                    rankBadge = `<i class="fa-solid fa-medal text-gray-400 text-lg"></i>`;
                } else if (rank === 3) {
                    rankBadge = `<i class="fa-solid fa-medal text-orange-400 text-lg"></i>`;
                }

                if (isMe) rowClass += " border-brand bg-teal-50 ring-1 ring-brand";

                html += `
                <div class="flex items-center gap-3 p-3 rounded-xl border ${rowClass} transition-all hover:shadow-md">
                    <div class="w-8 flex justify-center shrink-0">${rankBadge}</div>
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-gray-800 truncate flex items-center gap-1">
                            ${user.name} ${isMe ? '<span class="text-[10px] bg-brand text-white px-1.5 rounded">Bạn</span>' : ''}
                        </div>
                        <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Học viên</div>
                    </div>
                    <div class="text-right">
                        <div class="text-brand font-black text-lg leading-none">${user.score.toFixed(1)}</div>
                        <div class="text-[9px] text-gray-400 font-bold uppercase">Điểm</div>
                    </div>
                </div>
                `;
            });

            listEl.innerHTML = html;
            myRankEl.innerText = myRank;
        }

        onAuthStateChanged(auth, (user) => {
            if(!user) {
                sessionStorage.setItem('redirect_after_login', window.location.href);
                window.location.href = 'index.html';
            } else if(courseId) {
                loadLogo();
                await loadCourse(courseId);
                loadUserProgress(); // [NEW] Tải tiến độ cũ
            } else {
                window.location.href = 'student.html';
            }
        });

        // 1. TẢI LOGO (Logo to + Tên)
        async function loadLogo() {
            try {
                const docSnap = await getDoc(doc(db, "site_settings", "homepage_hero"));
                if (docSnap.exists() && docSnap.data().logo) {
                    const imgEl = document.getElementById('brandLogo');
                    imgEl.src = docSnap.data().logo;
                    imgEl.classList.remove('hidden');
                }
            } catch(e) {}
        }

        async function loadCourse(id) {
            try {
                const snap = await getDoc(doc(db, "public_courses", id));
                if(snap.exists()){
                    courseData = snap.data();
                    document.getElementById('courseTitle').innerText = courseData.title;
                    renderCurriculum(courseData.curriculum || []);
                    updateStats();
                } else {
                    alert("Khóa học không tồn tại!"); window.location.href='student.html';
                }
            } catch(e) { console.error(e); }
        }

        // 2. RENDER CẤU TRÚC (CẬP NHẬT MŨI TÊN THU GỌN Ở BÀI HỌC)
        function renderCurriculum(list) {
            const container = document.getElementById('curriculumList');
            container.innerHTML = '';
            flatItems = []; 

            if(!list || list.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Chưa có nội dung.</div>';
                return;
            }

            list.forEach((chap, cIdx) => {
                const chapId = `chap_${cIdx}`;
                const isOpen = cIdx === 0;
                
                // --- CHAPTER HEADER ---
                const chapEl = document.createElement('div');
                chapEl.className = 'mb-1';
                chapEl.innerHTML = `
                    <div class="flex items-center justify-between px-3 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors group select-none" onclick="window.toggleCollapse('${chapId}', this)">
                        <div class="font-extrabold text-gray-800 text-sm flex-1 truncate pr-2"><i class="fa-solid fa-folder-open text-brand mr-2"></i>${chap.title}</div>
                        <i class="fa-solid fa-chevron-right text-xs text-gray-400 transition-transform duration-300 ${isOpen ? 'rotate-90' : ''}"></i>
                    </div>
                    <div id="${chapId}" class="mt-1 space-y-1 ${isOpen ? '' : 'hidden'} overflow-hidden transition-all pl-2"></div>
                `;
                const chapBody = chapEl.querySelector(`#${chapId}`);

                // --- LESSONS ---
                (chap.lessons || []).forEach((les, lIdx) => {
                    const lesId = `les_${cIdx}_${lIdx}`;
                    const lesEl = document.createElement('div');
                    const isLesOpen = true; // Mặc định mở

                    // Lesson Header (Có mũi tên thu gọn)
                    lesEl.innerHTML = `
                        <div class="flex items-center justify-between px-2 py-1.5 mt-2 cursor-pointer hover:text-brand transition-colors select-none" onclick="window.toggleCollapse('${lesId}', this)">
                            <div class="text-[11px] font-bold text-gray-500 uppercase tracking-wider truncate pr-2 flex items-center">
                                <i class="fa-solid fa-bookmark mr-1.5 text-gray-300"></i> ${les.title || 'Bài học'}
                            </div>
                            <i class="fa-solid fa-chevron-right text-[10px] text-gray-300 transition-transform duration-300 ${isLesOpen ? 'rotate-90' : ''}"></i>
                        </div>
                        <div id="${lesId}" class="space-y-0.5 ${isLesOpen ? '' : 'hidden'} overflow-hidden transition-all border-l border-gray-100 ml-2 pl-1 mb-2"></div>
                    `;
                    const lesBody = lesEl.querySelector(`#${lesId}`);

                    // --- ITEMS ---
                    (les.items || []).forEach((item) => {
                        flatItems.push(item);
                        const currentIndex = flatItems.length - 1;

                        // Màu sắc Icon (Cập nhật theo yêu cầu)
                        let iconClass = 'fa-circle-play text-red-500'; // Video Đỏ
                        let typeLabel = 'Video';
                        if(item.type === 'pdf') { iconClass = 'fa-file-pdf text-blue-500'; typeLabel = 'Tài liệu'; } // PDF Xanh
                        if(item.type === 'quiz') { iconClass = 'fa-clipboard-question text-orange-500'; typeLabel = 'Bài tập'; } // Quiz Cam

                        const itemEl = document.createElement('div');
                        itemEl.className = `lesson-item flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer text-sm text-gray-600 transition-all border-l-4 border-transparent`;
                        itemEl.dataset.index = currentIndex;
                        itemEl.innerHTML = `
                            <i class="fa-solid ${iconClass} text-sm w-5 text-center shrink-0"></i>
                            <div class="flex-1 min-w-0">
                                <div class="item-title truncate text-xs md:text-sm font-semibold">${item.title}</div>
                                <div class="text-[10px] text-gray-400 font-medium flex items-center gap-1">
                                    ${typeLabel} ${item.duration ? '• ' + item.duration + 'p' : ''}
                                </div>
                            </div>
                        `;
                        
                        itemEl.onclick = () => window.playItem(currentIndex);
                        lesBody.appendChild(itemEl);
                    });

                    chapBody.appendChild(lesEl);
                });

                container.appendChild(chapEl);
            });
        }

        window.playItem = (index) => {
            if(index < 0 || index >= flatItems.length) return;
            currentItemIndex = index;
            const item = flatItems[index];

            document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.lesson-item[data-index="${index}"]`);
            if(activeEl) {
                activeEl.classList.add('active');
                activeEl.scrollIntoView({behavior: 'smooth', block: 'center'});
            }

            document.getElementById('lessonTitle').innerText = item.title;
            document.getElementById('emptyState').classList.add('hidden');
            const frame = document.getElementById('mainFrame');
            const quiz = document.getElementById('quizContainer');
            
            frame.classList.add('hidden'); quiz.classList.add('hidden'); frame.src = "";

            if(item.type === 'video') {
                frame.classList.remove('hidden');
                let url = item.content;
                if(url && url.includes('youtu')) {
                    const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^&?]*)/);
                    if(m && m[1]) url = `https://www.youtube.com/embed/${m[1]}?autoplay=1&rel=0`;
                }
                frame.src = url;
            } else if(item.type === 'pdf') {
                frame.classList.remove('hidden');
                let url = item.content;
                if(url && url.includes('drive.google.com')) url = url.replace(/\/view.*/, '/preview');
                frame.src = url;
            } else if(item.type === 'quiz') {
                quiz.classList.remove('hidden');
                document.getElementById('btnStartQuiz').onclick = () => {
                    if(item.examId) window.location.href = `exam.html?id=${item.examId}&mode=course&courseId=${courseId}`;
                    else alert("Chưa có đề thi!");
                };
            }
            updateNavButtons();
            if(window.innerWidth < 768) toggleSidebar();
            
            // [NEW] Đánh dấu đã học
            markAsCompleted(index); 
        };

        function updateNavButtons() {
            document.getElementById('btnPrev').disabled = currentItemIndex <= 0;
            document.getElementById('btnNext').disabled = currentItemIndex >= flatItems.length - 1;
            document.getElementById('btnPrev').onclick = () => window.playItem(currentItemIndex - 1);
            document.getElementById('btnNext').onclick = () => window.playItem(currentItemIndex + 1);
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = `${flatItems.length} bài`;
        }

        // Logic đóng mở chung cho cả Chương và Bài
        window.toggleCollapse = (id, headerEl) => {
            const body = document.getElementById(id);
            const icon = headerEl.querySelector('.fa-chevron-right');
            body.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        };

        // Logic Toggle Sidebar (Đã fix lỗi xung đột)
        // [ĐÃ SỬA LỖI] Logic Đóng/Mở Sidebar cho cả PC và Mobile
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            // Kiểm tra kích thước màn hình
            if (window.innerWidth >= 768) {
                // --- LOGIC CHO MÁY TÍNH (PC) ---
                // Chỉ xử lý co giãn chiều rộng
                if (sb.classList.contains('desktop-expanded')) {
                    // Đang mở -> Thu gọn
                    sb.classList.remove('desktop-expanded');
                    sb.classList.add('desktop-collapsed');
                } else {
                    // Đang gọn -> Mở ra
                    sb.classList.remove('desktop-collapsed');
                    sb.classList.add('desktop-expanded');
                }
            } else {
                // --- LOGIC CHO ĐIỆN THOẠI (MOBILE) ---
                // Xử lý trượt ra vào bằng class Tailwind '-translate-x-full'
                
                // Kiểm tra xem class -translate-x-full có tồn tại không
                // Nếu có nghĩa là đang ẩn -> Cần hiện ra
                if (sb.classList.contains('-translate-x-full')) {
                    sb.classList.remove('-translate-x-full'); // Xóa class ẩn -> Sidebar trượt ra
                    overlay.classList.remove('hidden');        // Hiện lớp mờ đen
                } else {
                    // Nếu không có nghĩa là đang hiện -> Cần ẩn đi
                    sb.classList.add('-translate-x-full');    // Thêm class ẩn -> Sidebar trượt vào
                    overlay.classList.add('hidden');           // Ẩn lớp mờ đen
                }
            }
        };
        // --- LOGIC TIẾN ĐỘ HỌC TẬP (REAL-TIME PROGRESS) ---
        let completedItems = new Set(); // Lưu các ID bài đã học

        // 1. Hàm đánh dấu đã học (Gọi khi bấm playItem)
        async function markAsCompleted(itemIndex) {
            if (completedItems.has(itemIndex)) return; // Đã học rồi thì thôi
            
            completedItems.add(itemIndex);
            updateStats(); // Cập nhật giao diện ngay
            
            // Lưu vào Firebase (Debounce để tránh spam request)
            if (window.saveProgressTimeout) clearTimeout(window.saveProgressTimeout);
            window.saveProgressTimeout = setTimeout(() => saveProgressToDB(), 2000);
        }

        // 2. Tính toán và hiển thị
        function updateStats() {
            const total = flatItems.length;
            const completed = completedItems.size;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

            // Cập nhật DOM
            document.getElementById('totalCount').innerText = `${total} bài`;
            document.getElementById('completedCount').innerText = completed;
            document.getElementById('progressText').innerText = `${percent}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
            
            // Cập nhật style cho item trong danh sách
            flatItems.forEach((_, idx) => {
                const itemEl = document.querySelector(`.lesson-item[data-index="${idx}"]`);
                if(itemEl) {
                    if(completedItems.has(idx)) {
                        itemEl.classList.add('text-brand');
                        const icon = itemEl.querySelector('i');
                        if(icon) icon.classList.replace('text-gray-400', 'text-brand'); // Đổi màu icon
                        // Thêm dấu tích xanh nếu chưa có
                        if(!itemEl.querySelector('.fa-check')) {
                            const check = document.createElement('i');
                            check.className = 'fa-solid fa-circle-check text-brand ml-auto text-xs';
                            itemEl.appendChild(check);
                        }
                    }
                }
            });
        }

        // 3. Lưu xuống Database (Quan trọng để đồng bộ với trang Student)
        async function saveProgressToDB() {
            const user = auth.currentUser;
            if (!user || !courseId) return;

            const total = flatItems.length;
            const completed = completedItems.size;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

            try {
                // Cách 1: Lưu vào collection 'user_progress' riêng biệt (Khuyên dùng)
                const progressRef = doc(db, "user_progress", `${user.uid}_${courseId}`);
                await setDoc(progressRef, {
                    uid: user.uid,
                    courseId: courseId,
                    completedItems: Array.from(completedItems),
                    progress: percent,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });

                // Cách 2: Cập nhật ngược lại vào đơn hàng 'orders' (để trang Student hiện đúng ngay)
                // Tìm đơn hàng của khóa này
                const qOrder = query(collection(db, "orders"), 
                    where("userId", "==", user.uid), 
                    where("courseId", "==", courseId)
                );
                const snapOrder = await getDocs(qOrder);
                if (!snapOrder.empty) {
                    const orderDoc = snapOrder.docs[0];
                    await updateDoc(doc(db, "orders", orderDoc.id), {
                        progress: percent // Trường này sẽ được student.html đọc
                    });
                }
                console.log("Đã lưu tiến độ:", percent + "%");
            } catch (e) {
                console.error("Lỗi lưu tiến độ:", e);
            }
        }

        // 4. Tải tiến độ cũ khi vào trang
        async function loadUserProgress() {
            const user = auth.currentUser;
            if (!user || !courseId) return;
            
            try {
                const progressRef = doc(db, "user_progress", `${user.uid}_${courseId}`);
                const snap = await getDoc(progressRef);
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.completedItems && Array.isArray(data.completedItems)) {
                        completedItems = new Set(data.completedItems);
                        updateStats(); // Vẽ lại giao diện
                    }
                }
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>
